<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Suministro - Colaborador</title>
    <meta name="description" content="Sistema de gestión de productos para área de suministro de Gallos Mármol">
    <meta name="keywords" content="gallos mármol, productos, suministro, tickets">
    <meta name="author" content="Gallos Mármol">
    <link rel="icon" type="image/x-icon" href="../../FOTO/ICONO/Icono_01.ico">
    
    <!-- Librerías externas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Librería QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="../../JS/auth-check.js"></script>

    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --danger-color: #e74c3c;
            --danger-light: #ec7063;
            --light-color: #ecf0f1;
            --light-gray: #f8f9fa;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #fff;
            --text-muted: #6c757d;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --header-height: 60px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #d68910;
            --warning-light: #f8c471;
            --danger-color: #cb4335;
            --danger-light: #ec7063;
            --light-color: #2c2c2c;
            --light-gray: #1e1e1e;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== ESTRUCTURA PRINCIPAL ===== */
        #app {
            min-height: 100vh;
        }

        /* ===== HEADER MOBILE-FIRST ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 60%;
        }

        .logo-img {
            height: 40px;
            width: auto;
            border-radius: var(--border-radius-sm);
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle, .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover, .fullscreen-btn:hover {
            background-color: var(--light-color);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-info {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            display: inline-block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            padding-top: var(--header-height);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ===== NAVEGACIÓN POR PESTAÑAS ===== */
        .nav-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            font-size: 0.9rem;
            text-align: center;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== SECCIONES ===== */
        .generate-ticket-section {
            display: none;
        }

        .generate-ticket-section.active {
            display: block;
        }

        .section-title {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* ===== FORMULARIO DE NUEVO PRODUCTO ===== */
        .product-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Estilos para el modal mejorado */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .product-info-card {
            background: var(--light-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger-color);
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            gap: 0.75rem;
        }

        .info-item {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: start;
            gap: 0.5rem;
        }

        .info-item strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .product-code, .product-location {
            font-family: 'Monaco', 'Consolas', monospace;
            background: var(--card-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .warning-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .warning-message i {
            color: var(--danger-color);
            margin-top: 0.2rem;
        }

        .warning-message strong {
            color: var(--danger-color);
            display: block;
            margin-bottom: 0.25rem;
        }

        .warning-message p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: var(--light-color);
            color: var(--text-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .info-item {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }

        /* ===== LISTA DE PRODUCTOS ===== */
        .products-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            grid-column: 1 / -1;
        }

        .search-box .form-control {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.7;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .product-info h3 {
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .product-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .product-code {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            background-color: var(--primary-color);
            color: white;
        }

        .product-excerpt {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ===== MEJORA 1: ESTILOS PARA BÚSQUEDA Y FILTROS ===== */
        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .quick-filters {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .filters-header h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-size: 1rem;
        }

        .filters-header small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .filter-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
        }

        .filter-btn:hover {
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 3rem;
            overflow: hidden;
            line-height: 1.3;
        }

        /* Agregar al CSS existente */
        .editable-field {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 0.9rem;
            width: 100%;
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .editable-field.valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .editable-field.invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .editable-field:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Mensajes de error */
        .field-error {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        /* Indicadores de estado */
        .validation-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .valid .validation-indicator {
            color: var(--success-color);
        }

        .invalid .validation-indicator {
            color: var(--danger-color);
        }

        /* Grupo de campo con validación */
        .field-group {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .field-group .form-control {
            padding-right: 2rem;
        }

        /* ===== FILTROS MEJORADOS - MOBILE FIRST ===== */
        .location-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: end;
        }

        .location-filters .form-group {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .filter-count {
            background: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
        }

        .filter-count:empty {
            display: none;
        }

        .filter-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .filter-select:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .filter-select.available {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .filter-select.empty {
            border-color: var(--warning-color);
            background-color: rgba(243, 156, 18, 0.05);
        }

        /* Estados de los filtros */
        .filter-status {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .filter-status.available {
            color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }

        .filter-status.empty {
            color: var(--warning-color);
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .filter-status.disabled {
            color: var(--text-muted);
            background: rgba(108, 117, 125, 0.1);
            border: 1px solid rgba(108, 117, 125, 0.2);
        }

        /* Mejora visual para selects */
        .filter-select:not(:disabled) {
            background-color: var(--card-bg);
        }

        .filter-select:disabled {
            background-color: var(--light-color);
            opacity: 0.7;
        }

        /* Indicador de selección actual */
        .filter-select:valid {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Filtros activos mejorados */
        .active-filters {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .active-filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .active-filters-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .active-filters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .active-filter-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .active-filter-tag .remove-filter {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .active-filter-tag .remove-filter:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .location-filters {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .filter-group {
                gap: 0.75rem;
            }
            
            .filter-label {
                font-size: 0.85rem;
            }
            
            .filter-select {
                padding: 0.875rem;
                font-size: 1rem; /* Mejor para touch */
            }
            
            .active-filters-list {
                flex-direction: column;
                align-items: stretch;
            }
            
            .active-filter-tag {
                justify-content: space-between;
            }
            
            /* Agrupar botones en móvil */
            .filter-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .location-filters {
                gap: 0.5rem;
            }
            
            .filter-select {
                padding: 1rem;
            }
            
            .active-filters {
                padding: 0.75rem;
            }
        }

        /* Mejora para el contenedor de filtros */
        .filters-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filters-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .filters-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ===== NUEVOS ESTILOS PARA CARDS ===== */
        .products-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            height: fit-content;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .product-code-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .product-row-number {
            background: var(--light-color);
            color: var(--text-muted);
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .product-description {
            margin-bottom: 1rem;
            flex-grow: 1;
        }

        .product-description textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            resize: vertical;
            transition: var(--transition);
        }

        .product-description textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-group {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .detail-value input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .detail-value input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .ubicacion-input {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .ubicacion-breakdown {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .breakdown-item {
            display: flex;
            flex-direction: column;
        }

        .breakdown-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .breakdown-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.8rem;
        }

        .product-card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .card-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-pdf {
            background: var(--success-color);
            color: white;
        }

        .btn-pdf:hover {
            background: var(--success-light);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: var(--danger-light);
            transform: translateY(-1px);
        }

        .card-search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 2rem;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .products-cards-container {
                grid-template-columns: 1fr;
            }
            
            .product-details-grid {
                grid-template-columns: 1fr;
            }
            
            .breakdown-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== MEJORAS PARA FILTROS RÁPIDOS ===== */
        .filter-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .filter-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: inherit;
        }

        .filter-current {
            font-size: 0.7rem;
            background: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            font-weight: 600;
        }

        .filter-info {
            margin-top: 0.5rem;
        }

        .info-badge {
            background: var(--secondary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .active-filters {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--secondary-color);
        }

        .no-filters {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
        }

        .active-filters-list {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .active-filter-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .clear-all-filters {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: auto;
        }

        .clear-all-filters:hover {
            background: var(--danger-light);
        }

        /* ===== SISTEMA DE LOADING MEJORADO ===== */
        .pdf-generation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .pdf-generation-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pdf-generation-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--light-color) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .pdf-generation-header {
            margin-bottom: 2rem;
        }

        .pdf-generation-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pdf-generation-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .pdf-generation-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Barra de progreso animada */
        .pdf-progress-container {
            width: 100%;
            background: var(--light-color);
            border-radius: 100px;
            overflow: hidden;
            margin: 1.5rem 0;
            height: 8px;
            position: relative;
        }

        .pdf-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 100px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pdf-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.4), 
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .pdf-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .pdf-progress-percent {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pdf-progress-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Etapas del proceso */
        .pdf-steps {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
            position: relative;
        }

        .pdf-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .pdf-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .pdf-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-color);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .pdf-step.active .pdf-step-icon {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .pdf-step.completed .pdf-step-icon {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .pdf-step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .pdf-step.active .pdf-step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .pdf-step.completed .pdf-step-label {
            color: var(--success-color);
        }

        /* Animación de éxito */
        .pdf-success-animation {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% { 
                opacity: 0;
                transform: scale(0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.1);
            }
            100% { 
                transform: scale(1);
            }
        }

        /* Contador de productos */
        .pdf-counter {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
            animation: countPop 0.5s ease;
        }

        @keyframes countPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Mensajes de estado */
        .pdf-status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Estados de botones de filtro mejorados */
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 75, 107, 0.3);
            transform: translateY(-2px);
        }

        .filter-btn:not(.active):hover {
            border-color: var(--secondary-color);
            background: var(--light-color);
            transform: translateY(-1px);
        }

        /* ===== MEJORA 4: INDICADORES DE ATAJOS ===== */
        .search-container {
            position: relative;
        }

        .search-shortcut {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--light-color);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        /* Tooltip para atajos de teclado */
        [title*="Ctrl+"], [title*="Alt+"] {
            position: relative;
        }

        [title*="Ctrl+"]::after, [title*="Alt+"]::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        [title*="Ctrl+"]:hover::after, [title*="Alt+"]:hover::after {
            opacity: 1;
        }

        /* ===== PAGINACIÓN ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ===== BOTONES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-light);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-light);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* VERSIÓN MEJORADA PARA HEADERS COMPLEJOS */
        .preview-table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
        }

        .products-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9em;
        }

        .products-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .products-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            border-bottom: 2px solid var(--primary-light);
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Asegurar que las celdas tengan fondo sólido */
        .products-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            transition: background-color 0.2s ease;
        }

        .products-table tbody tr:hover td {
            background-color: rgba(0, 75, 107, 0.05);
        }

        /* Scrollbar styling */
        .preview-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .preview-table-container::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        .preview-table-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .preview-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s ease;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9);
                background-color: rgba(0,0,0,0); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                background-color: rgba(0,0,0,0.5); 
            }
        } 
        
        .modal.fade-out {
            animation: modalFadeOut 0.3s ease forwards;
        }

        .modal.fade-out .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }        

        @keyframes modalFadeOut {
            from { 
                opacity: 1; 
                background-color: rgba(0,0,0,0.5); 
            }
            to { 
                opacity: 0; 
                background-color: rgba(0,0,0,0); 
            }
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes modalSlideOut {
            from { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            to { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
        }

        
        .modal-header {
            padding: 1.5rem 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Mejoras para botones del modal */
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            opacity: 1;
            background-color: var(--light-color);
            transform: scale(1.1);
        }

        /* Estilos para el scroll del modal */
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-muted);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .toast-info {
            background-color: var(--secondary-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-text {
            font-size: 1.1rem;
        }

        .section-loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .section-loading.active {
            display: block;
        }

        /* ===== ESTADOS VACÍOS ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* ===== PERFIL ===== */
        .profile-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0 auto 1.5rem;
        }

        /* ===== ACCESIBILIDAD ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Estilos para el sistema de búsqueda */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--light-color);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-text strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .suggestion-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
        }

        .suggestion-meta code {
            font-size: 0.7rem;
            background: var(--light-color);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .history-chip {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-chip:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .scanned-product {
            border-left: 4px solid var(--success-color) !important;
        }

        .unscanned-product {
            border-left: 4px solid var(--warning-color) !important;
        }

        .active-filter {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-container {
                position: static;
            }
            
            .search-suggestions {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 50vh;
            }
        }

        /* ===== GENERAR TICKET ===== */
        .ticket-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .ticket-preview {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .ticket-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .ticket-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ticket-item {
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--secondary-color);
        }

        .ticket-qr {
            text-align: center;
            margin: 1.5rem 0;
        }

        .ticket-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* MODAL SENCILLO Y ADAPTABLE */
        .simple-pdf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .simple-pdf-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .simple-modal {
            position: relative;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        .simple-pdf-modal.closing .simple-modal {
            animation: modalSlideOut 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
        }

        /* HEADER SENCILLO */
        .simple-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: var(--card-bg);
        }

        .header-title {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }

        .header-title h3 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-title p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-btn {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* BODY SENCILLO */
        .simple-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .format-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card-bg);
            position: relative;
        }

        .format-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .format-option.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .format-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .format-option:nth-child(2) .format-icon {
            background: var(--secondary-color);
        }

        .format-option:nth-child(3) .format-icon {
            background: var(--success-color);
        }

        .format-content {
            flex: 1;
        }

        .format-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .format-content p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .format-meta {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .format-meta.inventory {
            background: var(--success-color);
        }

        .format-check {
            flex-shrink: 0;
        }

        .check-circle {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: all 0.2s ease;
        }

        .check-circle.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .check-circle i {
            font-size: 0.8rem;
            color: transparent;
            transition: color 0.2s ease;
        }

        .check-circle.active i {
            color: white;
        }

        /* RESUMEN SENCILLO */
        .summary-section {
            background: var(--light-color);
            border-radius: 10px;
            padding: 1.25rem;
            border-left: 4px solid var(--primary-color);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .summary-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .summary-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1rem;
        }

        .format-selected {
            color: var(--success-color) !important;
        }

        /* FOOTER SENCILLO */
        .simple-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            background: var(--card-bg);
        }

        .simple-footer .btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-cancel {
            background: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color) !important;
        }

        .btn-cancel:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .btn-generate {
            background: var(--primary-color);
            color: white;
            position: relative;
        }

        .btn-generate:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* SCROLLBAR PARA MODO OSCURO/CLARO */
        .simple-body::-webkit-scrollbar {
            width: 6px;
        }

        .simple-body::-webkit-scrollbar-track {
            background: var(--light-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .simple-modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .simple-header {
                padding: 1.25rem;
            }
            
            .simple-body {
                padding: 1.25rem;
            }
            
            .format-option {
                padding: 1rem;
            }
            
            .simple-footer {
                padding: 1rem 1.25rem;
                flex-direction: column;
            }
            
            .simple-footer .btn {
                width: 100%;
            }
            
            .header-title {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .header-title i {
                margin-top: 0;
            }
        }

        /* MODO OSCURO AUTOMÁTICO */
        .dark-mode .simple-modal {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option.active {
            background: rgba(52, 152, 219, 0.1);
        }

        .dark-mode .summary-section {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .btn-cancel {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .close-btn {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        /* ===== FILTROS DE UBICACIÓN ===== */
        .location-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Responsive para tabla */
        @media (max-width: 768px) {
            .products-table {
                font-size: 0.8em;
            }
            
            .products-table th, .products-table td {
                padding: 8px;
            }
            
            .ticket-details {
                grid-template-columns: 1fr;
            }
            
            .location-filters {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ESTILOS ADICIONALES PARA NUEVAS FUNCIONALIDADES ===== */
        
        /* Botón flotante */
        .floating-action-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
            z-index: 1000;
        }

        .floating-action-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: var(--primary-light);
        }

        .floating-action-button.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Productos inválidos */
        .invalid-product {
            border-left: 4px solid var(--danger-color) !important;
            background: rgba(231, 76, 60, 0.05);
        }

        .validation-errors {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--danger-color);
        }

        /* Estados de carga mejorados */
        .skeleton-loading {
            background: linear-gradient(90deg, var(--light-color) 25%, var(--border-color) 50%, var(--light-color) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--border-radius-sm);
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles mejorados */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Mejoras para impresión */
        @media print {
            .app-header,
            .nav-container,
            .filters-container,
            .product-card-actions,
            .floating-action-button {
                display: none !important;
            }
            
            .main-content {
                padding-top: 0;
            }
            
            .product-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>

</head>
<body>
    <!-- Aplicación principal -->
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <img src="../../FOTO/LOGO/Logo_01.webp" alt="Gallos Mármol" class="logo-img">
                </div>
                <div class="header-actions">
                    <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa" aria-label="Pantalla completa">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" title="Cambiar tema" aria-label="Cambiar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar" aria-haspopup="true" aria-expanded="false">C</div>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="user-info">
                                <div class="user-name" id="userName">Colaborador</div>
                                <span class="user-role" id="userRole">Colaborador</span>
                            </div>
                            <a href="#" class="dropdown-item logout" id="logoutBtn" role="menuitem">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="main-content">
            <div class="container">
                <!-- Navegación por pestañas -->
                <div class="nav-container">
                    <div class="nav-tabs" id="navTabs" role="tablist">
                        <button class="nav-tab active" data-tab="generateTicket" role="tab" aria-selected="true" aria-controls="generateTicketSection"><i class="fas fa-ticket-alt"></i> Generar Tickets</button>
                    </div>
                </div>

                <section class="generate-ticket-section active" id="generateTicketSection" role="tabpanel" aria-labelledby="generate-ticket-tab">
                    <div class="section-title">
                        <h2>Generar Tickets desde Excel</h2>
                        <small>Carga un archivo Excel para generar tickets individuales o masivos</small>
                    </div>

                    <!-- Paso 1: Cargar Archivo -->
                    <div class="upload-step" id="ticketUploadStep">
                        <div class="upload-area" id="ticketUploadArea" 
                            style="border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 3rem; text-align: center; margin-bottom: 2rem; cursor: pointer; transition: var(--transition);">
                            <i class="fas fa-file-excel" style="font-size: 3rem; color: var(--success-color); margin-bottom: 1rem;"></i>
                            <h3>Arrastra tu archivo Excel aquí</h3>
                            <p>Formato: CÓDIGO, DESCRIPCIÓN, UBICACIÓN, UNIDAD_MEDIDA</p>
                            <small style="color: var(--text-muted);">O haz clic para seleccionar archivo</small>
                            <input type="file" id="ticketFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        
                        <div class="template-download" style="text-align: center; margin-bottom: 2rem;">
                            <a href="#" class="btn btn-secondary" id="downloadTicketTemplateBtn">
                                <i class="fas fa-file-excel"></i> Descargar Plantilla
                            </a>
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
                                Plantilla Excel con formato predefinido
                            </small>
                        </div>
                    </div>

                    <!-- Paso 2: Previsualización y Edición -->
                    <div class="preview-step" id="ticketPreviewStep" style="display: none;">
                        <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h3>Previsualización de Productos</h3>
                                <p style="margin: 0; color: var(--text-muted);" id="productsCount">0 productos cargados</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="backToUploadTicketBtn">
                                    <i class="fas fa-arrow-left"></i> Cambiar Archivo
                                </button>
                                <button class="btn btn-success" id="generateAllPdfBtn">
                                    <i class="fas fa-file-pdf"></i> Generar PDF de Todos
                                </button>
                            </div>
                        </div>

                        <!-- Filtros de Ubicación -->
                        <div class="filters-container">
                            <div class="filters-header">
                                <h4 class="filters-title">Filtros de Ubicación</h4>
                                <div class="filters-actions">
                                    <button class="btn btn-secondary btn-small" id="clearFiltersBtn">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                </div>
                            </div>

                            <div class="location-filters">
                                <!-- Bloque (independiente) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Bloque</span>
                                        <span class="filter-count" id="bloqueCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterBloque">
                                        <option value="">Todos los bloques</option>
                                    </select>
                                    <div class="filter-status disabled"  id="bloqueStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un bloque
                                    </div>
                                </div>

                                <!-- Lado (depende de Bloque) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Lado</span>
                                        <span class="filter-count" id="ladoCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterLado" disabled>
                                        <option value="">Selecciona bloque primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="ladoStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un bloque
                                    </div>
                                </div>

                                <!-- N° Bloque (depende de Lado) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>N° Bloque</span>
                                        <span class="filter-count" id="numeroBloqueCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterNumeroBloque" disabled>
                                        <option value="">Selecciona lado primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="numeroBloqueStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un lado
                                    </div>
                                </div>

                                <!-- Nivel (depende de N° Bloque) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Nivel</span>
                                        <span class="filter-count" id="nivelCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterNivel" disabled>
                                        <option value="">Selecciona número primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="nivelStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un número
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Búsqueda -->
                        <div class="search-box" style="margin-bottom: 1.5rem;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="ticketSearchInput" placeholder="Buscar por código, descripción...">
                        </div>

                        <!-- Contenedor de Cards de Productos -->
                        <div class="products-cards-container" id="ticketProductsCardsContainer">
                            <!-- Los productos cargados del Excel se mostrarán aquí como cards -->
                        </div>

                        <!-- Paginación -->
                        <div class="pagination" id="ticketPaginationContainer">
                            <button class="pagination-btn" id="ticketPrevPageBtn" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="pagination-info" id="ticketPaginationInfo">Página 1 de 1</span>
                            <button class="pagination-btn" id="ticketNextPageBtn" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Botón flotante para volver al inicio -->
    <button class="floating-action-button" id="scrollToTopBtn" aria-label="Volver al inicio">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast notifications -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Operación completada con éxito</span>
        <button class="toast-close" aria-label="Cerrar notificación">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Overlay de Generación de PDF -->
    <div class="pdf-generation-overlay" id="pdfGenerationOverlay">
        <div class="pdf-generation-card">
            <div class="pdf-generation-header">
                <div class="pdf-generation-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h2 class="pdf-generation-title" id="pdfGenerationTitle">Generando PDF</h2>
                <p class="pdf-generation-subtitle" id="pdfGenerationSubtitle">Preparando documentos...</p>
            </div>

            <!-- Contador de productos -->
            <div class="pdf-counter" id="pdfCounter">
                <span id="pdfCurrentCount">0</span> de <span id="pdfTotalCount">0</span> productos
            </div>

            <!-- Barra de progreso -->
            <div class="pdf-progress-text">
                <span>Progreso</span>
                <span class="pdf-progress-percent" id="pdfProgressPercent">0%</span>
            </div>
            <div class="pdf-progress-container">
                <div class="pdf-progress-bar" id="pdfProgressBar"></div>
            </div>
            <div class="pdf-progress-stats" id="pdfProgressStats">
                Iniciando proceso...
            </div>

            <!-- Etapas del proceso -->
            <div class="pdf-steps">
                <div class="pdf-step completed" id="step1">
                    <div class="pdf-step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="pdf-step-label">Preparando</span>
                </div>
                <div class="pdf-step" id="step2">
                    <div class="pdf-step-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span class="pdf-step-label">Generando</span>
                </div>
                <div class="pdf-step" id="step3">
                    <div class="pdf-step-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <span class="pdf-step-label">Códigos QR</span>
                </div>
                <div class="pdf-step" id="step4">
                    <div class="pdf-step-icon">
                        <i class="fas fa-save"></i>
                    </div>
                    <span class="pdf-step-label">Guardando</span>
                </div>
            </div>

            <!-- Mensajes de estado -->
            <div class="pdf-status-message" id="pdfStatusMessage">
                <i class="fas fa-info-circle"></i>
                <span id="pdfStatusText">Inicializando generación de PDF...</span>
            </div>

            <!-- Botón de cancelar (opcional) -->
            <button class="btn btn-secondary btn-small" id="cancelPdfGeneration" style="margin-top: 1rem;">
                <i class="fas fa-times"></i> Cancelar Generación
            </button>
        </div>
    </div>

    <!-- Modal para seleccionar formato PDF -->
    <div class="simple-pdf-modal" id="pdfFormatModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="simple-modal">
            <div class="simple-header">
                <div class="header-title">
                    <i class="fas fa-file-pdf"></i>
                    <div>
                        <h3>Generar PDF</h3>
                        <p>Selecciona el formato para los tickets</p>
                    </div>
                </div>
                <button class="close-btn" id="closePdfModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="simple-body">
                <div class="format-options">
                    <div class="format-option active" data-format="individual">
                        <div class="format-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="format-content">
                            <h4>Tickets Individuales</h4>
                            <p>Genera un PDF separado para cada producto con su código QR individual</p>
                            <span class="format-meta">Recomendado para impresión</span>
                        </div>
                        <div class="format-check">
                            <div class="check-circle active">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="format-option" data-format="multiple">
                        <div class="format-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="format-content">
                            <h4>PDF Múltiple</h4>
                            <p>Genera un solo PDF con todos los productos organizados en páginas separadas</p>
                            <span class="format-meta inventory">Para inventario</span>
                        </div>
                        <div class="format-check">
                            <div class="check-circle">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="summary-section">
                    <div class="summary-item">
                        <span class="summary-label">Productos a generar:</span>
                        <span class="summary-value" id="pdfProductCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Formato seleccionado:</span>
                        <span class="summary-value format-selected" id="pdfFormatSelected">Tickets Individuales</span>
                    </div>
                </div>
            </div>
            <div class="simple-footer">
                <button class="btn btn-cancel" id="cancelPdfBtn">Cancelar</button>
                <button class="btn btn-generate" id="confirmPdfBtn">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                    <span class="badge" id="pdfBadgeCount">0</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN DE SUPABASE =====
        const SUPABASE_URL = 'https://fzdwqkoporxnzvhpmlls.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6ZHdxa29wb3J4bnp2aHBtbGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDkxMDYsImV4cCI6MjA3NzM4NTEwNn0.nOS3oByMmopchYhH0Kv1I0lxi02VkqfsC-eGFTZ_ePg';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== ESTADO DE LA APLICACIÓN =====
        const TicketExcelState = {
            currentStep: 'upload',
            products: [],
            filteredProducts: [],
            fileData: null,
            pagination: {
                currentPage: 1,
                itemsPerPage: 9,
                totalPages: 1,
                totalItems: 0
            },
            filters: {
                search: '',
                bloque: '',
                lado: '',
                numeroBloque: '',
                nivel: '',
                availableOptions: {
                    lados: [],
                    numerosBloque: [],
                    niveles: []
                }
            }
        };

        const AppState = {
            isLoading: false,
            userData: null,
            supabaseLoaded: true,
            currentUser: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            currentTab: 'generateTicket',
            pagination: {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1,
                totalItems: 0
            }
        };

        // ===== SISTEMA DE VALIDACIÓN MEJORADO =====
        const FieldValidators = {
            descripcion: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La descripción es requerida'
                        };
                    }
                    
                    if (value.length < 3) {
                        return {
                            isValid: false,
                            error: 'La descripción debe tener al menos 3 caracteres'
                        };
                    }
                    
                    if (value.length > 200) {
                        return {
                            isValid: false,
                            error: 'La descripción no puede exceder 200 caracteres'
                        };
                    }
                    
                    const invalidChars = /[<>{}[\]]/;
                    if (invalidChars.test(value)) {
                        return {
                            isValid: false,
                            error: 'La descripción contiene caracteres no permitidos'
                        };
                    }
                    
                    return {
                        isValid: true,
                        error: null
                    };
                },
                
                format: (value) => {
                    return value.toString().trim()
                        .toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase())
                        .replace(/\s+/g, ' ');
                }
            },
            
            ubicacion: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La ubicación es requerida'
                        };
                    }
                    
                    if (value.length !== 7) {
                        return {
                            isValid: false,
                            error: 'La ubicación debe tener exactamente 7 caracteres'
                        };
                    }
                    
                    const ubicacionRegex = /^[A-Z][0-9A-Z][A-Z][0-9]{2}[0-9]{2}$/;
                    if (!ubicacionRegex.test(value)) {
                        return {
                            isValid: false,
                            error: 'Formato inválido. Use: A1D0101 (Ej: B2E0302)'
                        };
                    }
                    
                    const bloque = value.substring(0, 2);
                    const lado = value.substring(2, 3);
                    const numeroBloque = value.substring(3, 5);
                    const nivel = value.substring(5, 7);
                    
                    if (!/^[A-Z][0-9A-Z]$/.test(bloque)) {
                        return {
                            isValid: false,
                            error: 'Bloque inválido (Ej: A1, B2)'
                        };
                    }
                    
                    if (!/^[A-Z]$/.test(lado)) {
                        return {
                            isValid: false,
                            error: 'Lado inválido (debe ser una letra A-Z)'
                        };
                    }
                    
                    if (!/^\d{2}$/.test(numeroBloque)) {
                        return {
                            isValid: false,
                            error: 'Número de bloque inválido (debe ser 2 dígitos)'
                        };
                    }
                    
                    if (!/^\d{2}$/.test(nivel)) {
                        return {
                            isValid: false,
                            error: 'Nivel inválido (debe ser 2 dígitos)'
                        };
                    }
                    
                    return {
                        isValid: true,
                        error: null,
                        parsed: {
                            bloque,
                            lado,
                            numeroBloque,
                            nivel
                        }
                    };
                },
                
                format: (value) => {
                    return value.toString().trim().toUpperCase().replace(/\s+/g, '');
                }
            },
            
            unidadMedida: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La unidad de medida es requerida'
                        };
                    }
                    
                    if (value.length > 10) {
                        return {
                            isValid: false,
                            error: 'La unidad no puede exceder 10 caracteres'
                        };
                    }
                                        
                    return {
                        isValid: true,
                        error: null,
                    };
                },
                
                format: (value) => {
                    return value.toString().trim().toUpperCase();
                }
            }
        };

        // ===== INICIALIZACIÓN DE LA APLICACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando aplicación Gallos Mármol...');
            
            // Verificar dependencias
            if (typeof supabase === 'undefined') {
                console.error('❌ Supabase no está cargado');
                showToast('Error: No se pudo conectar con el servidor', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                console.error('❌ SheetJS no está cargado');
                showToast('Error: No se pudo cargar el sistema de archivos', 'error');
                return;
            }
            
            // Verificar sesión usando auth-check.js
            if (typeof AuthChecker !== 'undefined') {
                AuthChecker.verificarSesion();
            } else {
                console.error('❌ AuthChecker no está disponible');
                showToast('Error: No se pudo verificar la sesión', 'error');
            }
            
            // Inicializar la aplicación
            initializeApp();
            
            console.log('✅ Aplicación inicializada correctamente');
        });

        // ===== INICIALIZAR APLICACIÓN =====
        async function initializeApp() {
            try {
                console.log('🔄 Inicializando aplicación...');
                
                // Limpiar sesiones redundantes
                cleanupRedundantSessions();
                
                // Verificar autenticación usando sesiones existentes
                const userData = await checkCustomAuth();
                
                if (userData && userData.authenticated) {
                    console.log('✅ Sesión encontrada:', userData.email);
                    AppState.currentUser = userData;
                    await loadApplication();
                } else {
                    console.log('🚫 No hay sesión activa - Redirigiendo al portal');
                    showToast('No hay sesión activa. Redirigiendo al portal...', 'warning');
                    
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('❌ Error inicializando aplicación:', error);
                showToast('Error al cargar la aplicación', 'error');
            }
        }

        async function checkCustomAuth() {
            try {
                console.log('🔍 Verificando autenticación PIN...');
                
                const sesionPinGM = localStorage.getItem('sesion_pin_gm');
                const gmUserSession = localStorage.getItem('gm_user_session');
                
                console.log('📋 Sesiones encontradas:', {
                    sesionPinGM: sesionPinGM ? 'PRESENTE' : 'AUSENTE',
                    gmUserSession: gmUserSession ? 'PRESENTE' : 'AUSENTE'
                });
                
                // Priorizar sesion_pin_gm como fuente principal
                if (sesionPinGM) {
                    const sessionData = JSON.parse(sesionPinGM);
                    
                    if (isValidPINSession(sessionData)) {
                        const userInfo = extractUserInfo(sessionData);
                        console.log('✅ Usuario autorizado desde sesion_pin_gm:', userInfo);
                        return userInfo;
                    }
                }
                
                // Fallback a gm_user_session si es necesario
                if (gmUserSession) {
                    const sessionData = JSON.parse(gmUserSession);
                    
                    if (isValidPINSession(sessionData)) {
                        const userInfo = extractUserInfo(sessionData);
                        console.log('✅ Usuario autorizado desde gm_user_session:', userInfo);
                        return userInfo;
                    }
                }
                
                console.log('❌ No se encontró sesión PIN válida');
                return null;
                
            } catch (error) {
                console.error('Error verificando autenticación PIN:', error);
                return null;
            }
        }

        // ===== FUNCIÓN DE LIMPIEZA (opcional) =====
        function cleanupRedundantSessions() {
            // Eliminar userSession si existe
            if (localStorage.getItem('userSession')) {
                localStorage.removeItem('userSession');
                console.log('🧹 userSession redundante eliminado');
            }
            
            // También puedes limpiar gm_user_session si no es necesaria
            // (depende de tu arquitectura)
            const sesionPinGM = localStorage.getItem('sesion_pin_gm');
            if (sesionPinGM && localStorage.getItem('gm_user_session')) {
                // gm_user_session parece ser un duplicado de sesion_pin_gm
                // Considera eliminarla si no tiene un propósito específico
                // localStorage.removeItem('gm_user_session');
            }
        }

        // Función para validar la sesión PIN
        function isValidPINSession(sessionData) {
            try {
                // Verificar estructura básica
                if (!sessionData || !sessionData.usuario || !sessionData.sistemas) {
                    console.log('❌ Estructura de sesión inválida');
                    return false;
                }
                
                // Verificar timestamp de actividad (opcional - si quieres expiración)
                const ultimaActividad = sessionData.ultimaActividad;
                const ahora = Date.now();
                const tiempoExpiracion = 24 * 60 * 60 * 1000; // 24 horas
                
                if (ultimaActividad && (ahora - ultimaActividad > tiempoExpiracion)) {
                    console.log('❌ Sesión expirada');
                    return false;
                }
                
                // Verificar acceso al sistema de suministro
                const sistemaSuministro = sessionData.sistemas.find(s => s.key === 'sistemaSuministro');
                
                if (!sistemaSuministro) {
                    console.log('❌ No tiene acceso al sistema de suministro');
                    return false;
                }
                
                if (!sistemaSuministro.activo) {
                    console.log('❌ Sistema de suministro no activo para este usuario');
                    return false;
                }
                
                console.log('✅ Sesión PIN válida y con acceso a suministro');
                return true;
                
            } catch (error) {
                console.error('Error validando sesión PIN:', error);
                return false;
            }
        }

        // Función para extraer información del usuario
        function extractUserInfo(sessionData) {
            const usuario = sessionData.usuario;
            const sistemaSuministro = sessionData.sistemas.find(s => s.key === 'sistemaSuministro');
            
            return {
                authenticated: true,
                email: usuario.email,
                nombre: usuario.nombre,
                id: usuario.id,
                role: sistemaSuministro?.rol || 'colaborador',
                sistemaActivo: sistemaSuministro?.activo || false,
                datosUsuario: sistemaSuministro?.datosUsuario || null,
                timestamp: sessionData.timestamp,
                tipo: sessionData.tipo,
                // Incluir todos los datos necesarios para evitar crear userSession
                apellido: sistemaSuministro?.datosUsuario?.apellido || '',
                sistemasAcceso: sistemaSuministro?.datosUsuario?.sistemas_acceso || {}
            };
        }

        // Actualizar la interfaz de usuario con la información del usuario
        function updateUserInterface() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement && AppState.currentUser) {
                userNameElement.textContent = AppState.currentUser.nombre || AppState.currentUser.email;
            }
            
            if (userRoleElement) {
                // Capitalizar el rol: "colaborador" -> "Colaborador"
                const role = AppState.currentUser.role;
                userRoleElement.textContent = role.charAt(0).toUpperCase() + role.slice(1);
            }
            
            if (userAvatarElement) {
                let avatarText = 'U';
                if (AppState.currentUser?.nombre) {
                    avatarText = AppState.currentUser.nombre.charAt(0).toUpperCase();
                } else if (AppState.currentUser?.email) {
                    avatarText = AppState.currentUser.email.charAt(0).toUpperCase();
                }
                userAvatarElement.textContent = avatarText;
            }
        }

        // Función para cerrar sesión (si la necesitas en suministro)
        function logout() {
            // Limpiar las sesiones específicas de tu sistema
            localStorage.removeItem('sesion_pin_gm');
            localStorage.removeItem('gm_user_session');
            
            console.log('✅ Sesión PIN cerrada');
            showToast('Sesión cerrada correctamente', 'success');
            
            // Redirigir al portal
            setTimeout(() => {
                window.location.href = window.location.origin + 'index.html';
            }, 1500);
        }

        // ===== CARGA DE LA APLICACIÓN =====
        async function loadApplication() {
            try {
                // Aplicar tema
                if (AppState.darkMode) {
                    document.body.classList.add('dark-mode');
                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Mostrar información del usuario
                updateUserInterface();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Mostrar aplicación
                document.getElementById('app').style.display = 'block';
                
                // Ir directamente a Generar Tickets
                switchTab('generateTicket');
                
                showToast('Sistema cargado correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error cargando aplicación:', error);
                showToast('Error al cargar la aplicación: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            // ===== EVENT LISTENERS GLOBALES =====
            
            // 1. Toggle de tema oscuro/claro
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // 2. Botón de pantalla completa
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }
            
            // 3. Menú de usuario
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', toggleUserDropdown);
            }
            
            // ===== NAVEGACIÓN POR PESTAÑAS =====
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    const validTabs = ['generateTicket'];
                    if (!validTabs.includes(tabId)) {
                        console.warn('Pestaña no válida:', tabId);
                        showToast(`La pestaña "${tabId}" no está disponible`, 'warning');
                        return;
                    }
                    
                    switchTab(tabId);
                });
            });
            
            // ===== BOTÓN FLOTANTE SCROLL TO TOP =====
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (scrollToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                scrollToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // ===== TOAST NOTIFICATIONS =====
            const toastClose = document.querySelector('.toast-close');
            if (toastClose) {
                toastClose.addEventListener('click', () => {
                    document.getElementById('toast').classList.remove('show');
                });
            }
            
            // ===== EVENT LISTENERS ESPECÍFICOS =====
            setupTicketExcelEventListeners();
            
            // ===== EVENT LISTENERS GLOBALES DE SISTEMA =====
            
            // Cerrar menús al hacer click fuera
            document.addEventListener('click', (e) => {
                const userDropdown = document.getElementById('userDropdown');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userDropdown && userDropdown.classList.contains('active') && 
                    !userDropdown.contains(e.target) && 
                    !userAvatar.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            
            setupKeyboardShortcuts();
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🚪 Usuario solicitó cerrar sesión');
                    
                    // ✅ Usar AuthChecker para cerrar sesión GLOBALMENTE
                    AuthChecker.cerrarSesionGlobal();
                    
                    // Ocultar dropdown
                    document.getElementById('userDropdown').classList.remove('active');
                });
            }

            console.log('✅ Event listeners configurados correctamente');
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Solo activar si estamos en la sección de tickets
                if (!document.getElementById('generateTicketSection').classList.contains('active')) {
                    return;
                }
                
                // Ctrl+F o Cmd+F - Enfocar búsqueda
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('ticketSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                // Ctrl+S o Cmd+S - Exportar a Excel
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (TicketExcelState.filteredProducts.length > 0) {
                        exportToExcel();
                    } else {
                        showToast('No hay productos para exportar', 'warning');
                    }
                }
                
                // Escape - Limpiar búsqueda y filtros
                if (e.key === 'Escape') {
                    e.preventDefault();
                    clearAllFilters();
                }
            });
        }

        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            showToast(`Modo ${AppState.darkMode ? 'oscuro' : 'claro'} activado`, 'success');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error al activar pantalla completa:', err);
                    showToast('No se pudo activar el modo pantalla completa', 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const isActive = dropdown.classList.toggle('active');
            document.getElementById('userAvatar').setAttribute('aria-expanded', isActive);
        }

        function switchTab(tabId) {
            // Validar que sea una pestaña existente
            const validTabs = ['generateTicket'];
            
            if (!validTabs.includes(tabId)) {
                console.warn('Pestaña no válida:', tabId);
                showToast(`Pestaña "${tabId}" no está disponible`, 'error');
                return;
            }
            
            AppState.currentTab = tabId;
            
            // Ocultar todas las secciones
            document.querySelectorAll('.generate-ticket-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Mostrar sección activa
            const activeSection = document.getElementById(tabId + 'Section');
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
                
                // Acciones específicas por pestaña
                if (tabId === 'generateTicket') {
                    initializeTicketExcelSection();
                }
            }
            
            // Actualizar pestañas activas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.getAttribute('data-tab') === tabId;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
            });
            
            console.log(`✅ Cambiando a pestaña: ${tabId}`);
        }

        function initializeTicketExcelSection() {
            console.log('🔄 Inicializando sección de tickets...');
            
            // Inicializar estado de filtros si no existe
            if (!TicketExcelState.filters) {
                TicketExcelState.filters = {
                    search: '',
                    quickFilter: 'all'
                };
            }
            
            // Resetear estado si es necesario
            if (TicketExcelState.currentStep === 'preview' && TicketExcelState.products.length === 0) {
                backToTicketUpload();
            }
        }

        // ===== FUNCIONES PARA TICKETS DESDE EXCEL =====
        function setupTicketExcelEventListeners() {
            console.log('🔧 Configurando event listeners para tickets Excel...');
            
            // 1. Upload Area para Tickets
            const ticketUploadArea = document.getElementById('ticketUploadArea');
            const ticketFileInput = document.getElementById('ticketFileInput');
            
            if (ticketUploadArea && ticketFileInput) {
                ticketUploadArea.addEventListener('click', () => {
                    ticketFileInput.click();
                });
                
                // Mejora: Drag & Drop para archivos
                ticketUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--success-color)';
                    ticketUploadArea.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
                });
                
                ticketUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                });
                
                ticketUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        processTicketFile(e.dataTransfer.files[0]);
                    }
                });
                
                ticketFileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        processTicketFile(e.target.files[0]);
                    }
                });
            }
            
            // 2. Botón de volver a upload
            const backToUploadTicketBtn = document.getElementById('backToUploadTicketBtn');
            if (backToUploadTicketBtn) {
                backToUploadTicketBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            backToTicketUpload();
                        });
                    } else {
                        backToTicketUpload();
                    }
                });
            }
            
            // 3. Botón de generar PDF masivo CON VALIDACIÓN
            const generateAllPdfBtn = document.getElementById('generateAllPdfBtn');
            if (generateAllPdfBtn) {
                generateAllPdfBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🖨️ Click en Generar PDF de Todos - Validando...');
                    
                    if (TicketExcelState.filteredProducts.length === 0) {
                        showToast('No hay productos para generar PDF', 'warning');
                        return;
                    }
                    
                    // ✅ PRIMERO: Validar todos los campos antes de continuar
                    const validationResult = validateAllFieldsBeforePdf();
                    
                    if (!validationResult.allValid) {
                        showValidationErrorsModal(validationResult.invalidProducts);
                        return;
                    }
                    
                    // ✅ SEGUNDO: Validar que haya productos válidos para PDF
                    const validProducts = TicketExcelState.filteredProducts.filter(product => 
                        validateProductForPdf(product).isValid
                    );
                    
                    if (validProducts.length === 0) {
                        showToast('No hay productos válidos para generar PDF', 'warning');
                        return;
                    }
                    
                    console.log(`📊 Mostrando modal para ${validProducts.length} productos válidos`);
                    showPdfFormatModalForAll('excel');
                });
            }
            
            // 4. Paginación - MEJORADA PARA EVITAR MÚLTIPLES EVENTOS
            const ticketPrevPageBtn = document.getElementById('ticketPrevPageBtn');
            const ticketNextPageBtn = document.getElementById('ticketNextPageBtn');

            if (ticketPrevPageBtn) {
                // ✅ REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketPrevPageBtn.replaceWith(ticketPrevPageBtn.cloneNode(true));
                const newPrevBtn = document.getElementById('ticketPrevPageBtn');
                
                newPrevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // ✅ EVITA MÚLTIPLES EJECUCIONES
                    
                    console.log('⬅️ Botón Anterior clickeado - Página actual:', TicketExcelState.pagination.currentPage);
                    
                    if (TicketExcelState.pagination.currentPage > 1) {
                        TicketExcelState.pagination.currentPage--;
                        console.log('📄 Navegando a página:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }

            if (ticketNextPageBtn) {
                // ✅ REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketNextPageBtn.replaceWith(ticketNextPageBtn.cloneNode(true));
                const newNextBtn = document.getElementById('ticketNextPageBtn');
                
                newNextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // ✅ EVITA MÚLTIPLES EJECUCIONES
                    
                    console.log('➡️ Botón Siguiente clickeado - Página actual:', TicketExcelState.pagination.currentPage);
                    
                    const totalPages = TicketExcelState.pagination.totalPages;
                    
                    if (TicketExcelState.pagination.currentPage < totalPages) {
                        TicketExcelState.pagination.currentPage++;
                        console.log('📄 Navegando a página:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }
            
            // 5. Filtros y búsqueda - CON VALIDACIÓN MEJORADA
            const ticketSearchInput = document.getElementById('ticketSearchInput');
            if (ticketSearchInput) {
                // Agregar placeholder mejorado
                ticketSearchInput.placeholder = 'Buscar por código, descripción, ubicación... (Ctrl+F)';
                
                ticketSearchInput.addEventListener('input', debounce(function(e) {
                    console.log('🔍 Búsqueda:', e.target.value);
                    applyTicketFilters();
                }, 300));
                
                // Limpiar búsqueda con Escape
                ticketSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.target.value = '';
                        applyTicketFilters();
                        showToast('Búsqueda limpiada', 'info');
                    }
                });
            }
            
            // Filtros de ubicación
            const ticketFilterBloque = document.getElementById('ticketFilterBloque');
            const ticketFilterLado = document.getElementById('ticketFilterLado');
            const ticketFilterNumeroBloque = document.getElementById('ticketFilterNumeroBloque');
            const ticketFilterNivel = document.getElementById('ticketFilterNivel');
            
            [ticketFilterBloque, ticketFilterLado, ticketFilterNumeroBloque, ticketFilterNivel].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', function(e) {
                        console.log(`🎯 Filtro ${filter.id} cambiado:`, e.target.value);
                        applyTicketFilters();
                    });
                }
            });
            
            // 6. Descargar plantilla
            const downloadTicketTemplateBtn = document.getElementById('downloadTicketTemplateBtn');
            if (downloadTicketTemplateBtn) {
                downloadTicketTemplateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    downloadTicketTemplate();
                });
            }

            // 7. Botón limpiar filtros - MEJORADO
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar antes de limpiar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            clearAllFilters();
                        });
                    } else {
                        clearAllFilters();
                    }
                });
            }
            
            // 8. Configurar botón de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        await supabase.auth.signOut();
                        showToast('Sesión cerrada correctamente', 'success');
                        // Redirigir al portal de sistemas
                        setTimeout(() => {
                            window.location.href = '/index.html';
                        }, 1000);
                    } catch (error) {
                        console.error('Error cerrando sesión:', error);
                        showToast('Error al cerrar sesión', 'error');
                    }
                    
                    document.getElementById('userDropdown').classList.remove('active');
                });
            }
            
            // 9. Inicializar validación en tiempo real
            setupRealTimeValidation();
            
            console.log('✅ Event listeners para tickets Excel configurados correctamente');
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function showLoadingOverlay(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            const toastConfig = {
                success: { icon: 'check-circle', color: 'toast' },
                error: { icon: 'exclamation-circle', color: 'toast-error' },
                warning: { icon: 'exclamation-triangle', color: 'toast-warning' },
                info: { icon: 'info-circle', color: 'toast-info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            toastIcon.className = `fas fa-${config.icon} toast-icon`;
            toast.classList.add(config.color);
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== FUNCIONES ESPECÍFICAS PARA TICKETS EXCEL =====
        
        // Función para procesar archivo Excel
        function processTicketFile(file) {
            if (!file) return;
            
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showToast('Formato de archivo no válido. Use Excel (.xlsx, .xls) o CSV', 'error');
                return;
            }
            
            showLoadingOverlay(true, 'Procesando archivo Excel...');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obtener la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length <= 1) {
                        showToast('El archivo está vacío o no contiene datos válidos', 'warning');
                        showLoadingOverlay(false);
                        return;
                    }
                    
                    // Procesar los datos
                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error('Error procesando archivo Excel:', error);
                    showToast('Error al procesar el archivo Excel: ' + error.message, 'error');
                    showLoadingOverlay(false);
                }
            };
            
            reader.onerror = function() {
                showToast('Error al leer el archivo', 'error');
                showLoadingOverlay(false);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Procesar datos de Excel
        function processExcelData(data) {
            try {
                // Obtener encabezados (primera fila)
                const headers = data[0].map(h => h ? h.toString().trim().toUpperCase() : '');
                
                // Validar encabezados requeridos
                const requiredHeaders = ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                
                if (missingHeaders.length > 0) {
                    showToast(`Faltan columnas requeridas: ${missingHeaders.join(', ')}`, 'error');
                    showLoadingOverlay(false);
                    return;
                }
                
                // Procesar filas de datos
                const products = [];
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.length === 0) continue;
                    
                    const product = {
                        id: i,
                        codigo: row[headers.indexOf('CÓDIGO')]?.toString().trim() || '',
                        descripcion: row[headers.indexOf('DESCRIPCIÓN')]?.toString().trim() || '',
                        ubicacion: row[headers.indexOf('UBICACIÓN')]?.toString().trim().toUpperCase() || '',
                        unidadMedida: row[headers.indexOf('UNIDAD_MEDIDA')]?.toString().trim().toUpperCase() || '',
                        isValid: true,
                        validationErrors: []
                    };
                    
                    // Validar producto
                    const validation = validateProduct(product);
                    product.isValid = validation.isValid;
                    product.validationErrors = validation.errors;
                    
                    // Parsear ubicación si es válida
                    if (validation.isValid) {
                        const ubicacionValidation = FieldValidators.ubicacion.validate(product.ubicacion);
                        if (ubicacionValidation.isValid && ubicacionValidation.parsed) {
                            product.parsedUbicacion = ubicacionValidation.parsed;
                        }
                    }
                    
                    products.push(product);
                }
                
                if (products.length === 0) {
                    showToast('No se encontraron productos válidos en el archivo', 'warning');
                    showLoadingOverlay(false);
                    return;
                }
                
                // Actualizar estado
                TicketExcelState.products = products;
                TicketExcelState.filteredProducts = [...products];
                TicketExcelState.fileData = data;
                TicketExcelState.currentStep = 'preview';
                
                // Actualizar interfaz
                showTicketPreviewStep();
                updateLocationFilters();
                renderTicketProductsTable();
                
                showToast(`${products.length} productos cargados correctamente`, 'success');
                showLoadingOverlay(false);
                
            } catch (error) {
                console.error('Error procesando datos Excel:', error);
                showToast('Error al procesar los datos del archivo', 'error');
                showLoadingOverlay(false);
            }
        }

        // Validar producto
        function validateProduct(product) {
            const errors = [];
            
            // Validar código
            if (!product.codigo || product.codigo.trim() === '') {
                errors.push('Código es requerido');
            }
            
            // Validar descripción
            const descValidation = FieldValidators.descripcion.validate(product.descripcion);
            if (!descValidation.isValid) {
                errors.push(descValidation.error);
            }
            
            // Validar ubicación
            const ubicacionValidation = FieldValidators.ubicacion.validate(product.ubicacion);
            if (!ubicacionValidation.isValid) {
                errors.push(ubicacionValidation.error);
            }
            
            // Validar unidad de medida
            const unidadValidation = FieldValidators.unidadMedida.validate(product.unidadMedida);
            if (!unidadValidation.isValid) {
                errors.push(unidadValidation.error);
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Mostrar paso de previsualización
        function showTicketPreviewStep() {
            document.getElementById('ticketUploadStep').style.display = 'none';
            document.getElementById('ticketPreviewStep').style.display = 'block';
            
            // Actualizar contador
            document.getElementById('productsCount').textContent = 
                `${TicketExcelState.products.length} productos cargados`;
        }

        // Volver a upload
        function backToTicketUpload() {
            TicketExcelState.currentStep = 'upload';
            TicketExcelState.products = [];
            TicketExcelState.filteredProducts = [];
            TicketExcelState.fileData = null;
            
            document.getElementById('ticketPreviewStep').style.display = 'none';
            document.getElementById('ticketUploadStep').style.display = 'block';
            
            // Limpiar inputs
            document.getElementById('ticketFileInput').value = '';
            document.getElementById('ticketSearchInput').value = '';
            
            showToast('Archivo descartado', 'info');
        }

        // Renderizar tabla de productos
        function renderTicketProductsTable() {
            const container = document.getElementById('ticketProductsCardsContainer');
            if (!container) return;
            
            // Calcular paginación
            const startIndex = (TicketExcelState.pagination.currentPage - 1) * TicketExcelState.pagination.itemsPerPage;
            const endIndex = startIndex + TicketExcelState.pagination.itemsPerPage;
            const currentProducts = TicketExcelState.filteredProducts.slice(startIndex, endIndex);
            
            TicketExcelState.pagination.totalItems = TicketExcelState.filteredProducts.length;
            TicketExcelState.pagination.totalPages = Math.ceil(
                TicketExcelState.filteredProducts.length / TicketExcelState.pagination.itemsPerPage
            );
            
            // Generar HTML de las cards
            let html = '';
            
            if (currentProducts.length === 0) {
                html = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron productos</h3>
                        <p>Intenta ajustar los filtros o la búsqueda</p>
                    </div>
                `;
            } else {
                currentProducts.forEach((product, index) => {
                    const globalIndex = startIndex + index + 1;
                    const ubicacionParts = product.parsedUbicacion || 
                        parseUbicacion(product.ubicacion);
                    
                    html += `
                        <div class="product-card ${!product.isValid ? 'invalid-product' : ''}" data-product-id="${product.id}">
                            <div class="product-card-header">
                                <div class="product-code-badge">${product.codigo}</div>
                                <div class="product-row-number">#${globalIndex}</div>
                            </div>
                            
                            <div class="product-description">
                                <textarea class="editable-field ${!product.isValid ? 'invalid' : ''}" 
                                    data-field="descripcion" 
                                    data-product-id="${product.id}"
                                    placeholder="Descripción del producto">${product.descripcion}</textarea>
                            </div>
                            
                            <div class="product-details-grid">
                                <div class="detail-group">
                                    <span class="detail-label">Ubicación</span>
                                    <div class="detail-value">
                                        <input type="text" class="editable-field ubicacion-input ${!product.isValid ? 'invalid' : ''}"
                                            data-field="ubicacion"
                                            data-product-id="${product.id}"
                                            value="${product.ubicacion}"
                                            placeholder="A1D0101">
                                    </div>
                                </div>
                                
                                <div class="detail-group">
                                    <span class="detail-label">Unidad</span>
                                    <div class="detail-value">
                                        <input type="text" class="editable-field"
                                            data-field="unidadMedida"
                                            data-product-id="${product.id}"
                                            value="${product.unidadMedida}"
                                            placeholder="UNIDAD">
                                    </div>
                                </div>
                            </div>
                            
                            ${ubicacionParts ? `
                            <div class="ubicacion-breakdown">
                                <div class="breakdown-grid">
                                    <div class="breakdown-item">
                                        <span class="breakdown-label">Bloque</span>
                                        <span class="breakdown-value">${ubicacionParts.bloque}</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="breakdown-label">Lado</span>
                                        <span class="breakdown-value">${ubicacionParts.lado}</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="breakdown-label">N° Bloque</span>
                                        <span class="breakdown-value">${ubicacionParts.numeroBloque}</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="breakdown-label">Nivel</span>
                                        <span class="breakdown-value">${ubicacionParts.nivel}</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${product.validationErrors && product.validationErrors.length > 0 ? `
                            <div class="validation-errors">
                                <small style="color: var(--danger-color);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    ${product.validationErrors.join(', ')}
                                </small>
                            </div>
                            ` : ''}
                            
                            <div class="product-card-actions">
                                <button class="card-action-btn btn-pdf" onclick="generateSinglePdf(${product.id})">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="card-action-btn btn-delete" onclick="deleteProduct(${product.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Actualizar paginación
            updatePaginationUI();
            
            // Configurar event listeners para campos editables
            setupEditableFields();
        }

        // Parsear ubicación
        function parseUbicacion(ubicacion) {
            try {
                if (ubicacion.length !== 7) return null;
                
                return {
                    bloque: ubicacion.substring(0, 2),
                    lado: ubicacion.substring(2, 3),
                    numeroBloque: ubicacion.substring(3, 5),
                    nivel: ubicacion.substring(5, 7)
                };
            } catch (error) {
                return null;
            }
        }

        // Actualizar UI de paginación
        function updatePaginationUI() {
            const prevBtn = document.getElementById('ticketPrevPageBtn');
            const nextBtn = document.getElementById('ticketNextPageBtn');
            const info = document.getElementById('ticketPaginationInfo');
            
            if (!prevBtn || !nextBtn || !info) return;
            
            const { currentPage, totalPages, totalItems } = TicketExcelState.pagination;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            info.textContent = `Página ${currentPage} de ${totalPages} (${totalItems} productos)`;
        }

        // Configurar campos editables
        function setupEditableFields() {
            document.querySelectorAll('.editable-field').forEach(field => {
                field.addEventListener('blur', function(e) {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    const fieldName = this.getAttribute('data-field');
                    const newValue = this.value.trim();
                    
                    updateProductField(productId, fieldName, newValue);
                });
                
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        // Actualizar campo de producto
        function updateProductField(productId, fieldName, newValue) {
            const product = TicketExcelState.products.find(p => p.id === productId);
            if (!product) return;
            
            const oldValue = product[fieldName];
            
            if (oldValue === newValue) return;
            
            // Validar el nuevo valor
            let validation;
            if (FieldValidators[fieldName]) {
                validation = FieldValidators[fieldName].validate(newValue);
                
                if (!validation.isValid) {
                    showToast(`Error en ${fieldName}: ${validation.error}`, 'error');
                    
                    // Revertir valor si es inválido
                    const field = document.querySelector(`[data-product-id="${productId}"][data-field="${fieldName}"]`);
                    if (field) {
                        field.value = oldValue;
                    }
                    return;
                }
                
                // Aplicar formato si es válido
                newValue = FieldValidators[fieldName].format(newValue);
            }
            
            // Actualizar producto
            product[fieldName] = newValue;
            
            // Si es ubicación, reparsear
            if (fieldName === 'ubicacion') {
                const ubicacionValidation = FieldValidators.ubicacion.validate(newValue);
                if (ubicacionValidation.isValid && ubicacionValidation.parsed) {
                    product.parsedUbicacion = ubicacionValidation.parsed;
                } else {
                    product.parsedUbicacion = null;
                }
            }
            
            // Revalidar producto completo
            const productValidation = validateProduct(product);
            product.isValid = productValidation.isValid;
            product.validationErrors = productValidation.errors;
            
            // Actualizar filtros si es necesario
            if (fieldName === 'ubicacion') {
                updateLocationFilters();
            }
            
            // Re-renderizar la tabla para mostrar cambios de validación
            renderTicketProductsTable();
            
            showToast(`Campo ${fieldName} actualizado`, 'success');
        }

        // Aplicar filtros
        function applyTicketFilters() {
            const searchTerm = document.getElementById('ticketSearchInput').value.toLowerCase();
            const bloqueFilter = document.getElementById('ticketFilterBloque').value;
            const ladoFilter = document.getElementById('ticketFilterLado').value;
            const numeroBloqueFilter = document.getElementById('ticketFilterNumeroBloque').value;
            const nivelFilter = document.getElementById('ticketFilterNivel').value;
            
            TicketExcelState.filters.search = searchTerm;
            TicketExcelState.filters.bloque = bloqueFilter;
            TicketExcelState.filters.lado = ladoFilter;
            TicketExcelState.filters.numeroBloque = numeroBloqueFilter;
            TicketExcelState.filters.nivel = nivelFilter;
            
            // Filtrar productos
            let filtered = TicketExcelState.products.filter(product => {
                // Filtro de búsqueda
                if (searchTerm && 
                    !product.codigo.toLowerCase().includes(searchTerm) &&
                    !product.descripcion.toLowerCase().includes(searchTerm) &&
                    !product.ubicacion.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtros de ubicación
                if (bloqueFilter && (!product.parsedUbicacion || product.parsedUbicacion.bloque !== bloqueFilter)) {
                    return false;
                }
                
                if (ladoFilter && (!product.parsedUbicacion || product.parsedUbicacion.lado !== ladoFilter)) {
                    return false;
                }
                
                if (numeroBloqueFilter && (!product.parsedUbicacion || product.parsedUbicacion.numeroBloque !== numeroBloqueFilter)) {
                    return false;
                }
                
                if (nivelFilter && (!product.parsedUbicacion || product.parsedUbicacion.nivel !== nivelFilter)) {
                    return false;
                }
                
                return true;
            });
            
            TicketExcelState.filteredProducts = filtered;
            TicketExcelState.pagination.currentPage = 1; // Resetear a primera página
            
            renderTicketProductsTable();
        }

        // Actualizar filtros de ubicación
        function updateLocationFilters() {
            const bloques = new Set();
            const lados = new Set();
            const numerosBloque = new Set();
            const niveles = new Set();
            
            // Recopilar opciones disponibles
            TicketExcelState.products.forEach(product => {
                if (product.parsedUbicacion) {
                    bloques.add(product.parsedUbicacion.bloque);
                    lados.add(product.parsedUbicacion.lado);
                    numerosBloque.add(product.parsedUbicacion.numeroBloque);
                    niveles.add(product.parsedUbicacion.nivel);
                }
            });
            
            // Actualizar filtro de bloques
            const bloqueSelect = document.getElementById('ticketFilterBloque');
            if (bloqueSelect) {
                const currentValue = bloqueSelect.value;
                bloqueSelect.innerHTML = '<option value="">Todos los bloques</option>';
                
                Array.from(bloques).sort().forEach(bloque => {
                    const option = document.createElement('option');
                    option.value = bloque;
                    option.textContent = bloque;
                    bloqueSelect.appendChild(option);
                });
                
                // Restaurar valor si existe
                if (currentValue && bloques.has(currentValue)) {
                    bloqueSelect.value = currentValue;
                }
                
                // Actualizar contador
                document.getElementById('bloqueCount').textContent = bloques.size;
            }
            
            // Actualizar estado de filtros dependientes
            updateDependentFilters();
        }

        // Actualizar filtros dependientes
        function updateDependentFilters() {
            const bloqueFilter = document.getElementById('ticketFilterBloque').value;
            const ladoSelect = document.getElementById('ticketFilterLado');
            const numeroBloqueSelect = document.getElementById('ticketFilterNumeroBloque');
            const nivelSelect = document.getElementById('ticketFilterNivel');
            
            // Resetear filtros dependientes si el padre cambió
            if (!bloqueFilter) {
                [ladoSelect, numeroBloqueSelect, nivelSelect].forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Selecciona primero el filtro anterior</option>';
                        select.disabled = true;
                    }
                });
                return;
            }
            
            // Actualizar lados disponibles para el bloque seleccionado
            const lados = new Set();
            TicketExcelState.products.forEach(product => {
                if (product.parsedUbicacion && 
                    product.parsedUbicacion.bloque === bloqueFilter) {
                    lados.add(product.parsedUbicacion.lado);
                }
            });
            
            if (ladoSelect) {
                const currentValue = ladoSelect.value;
                ladoSelect.innerHTML = '<option value="">Todos los lados</option>';
                
                Array.from(lados).sort().forEach(lado => {
                    const option = document.createElement('option');
                    option.value = lado;
                    option.textContent = lado;
                    ladoSelect.appendChild(option);
                });
                
                ladoSelect.disabled = false;
                
                if (currentValue && lados.has(currentValue)) {
                    ladoSelect.value = currentValue;
                }
                
                document.getElementById('ladoCount').textContent = lados.size;
            }
            
            // Continuar con la cadena de dependencias...
            updateNumeroBloqueFilter();
        }

        function updateNumeroBloqueFilter() {
            const bloqueFilter = document.getElementById('ticketFilterBloque').value;
            const ladoFilter = document.getElementById('ticketFilterLado').value;
            const numeroBloqueSelect = document.getElementById('ticketFilterNumeroBloque');
            
            if (!bloqueFilter || !ladoFilter) {
                if (numeroBloqueSelect) {
                    numeroBloqueSelect.innerHTML = '<option value="">Selecciona lado primero</option>';
                    numeroBloqueSelect.disabled = true;
                }
                return;
            }
            
            const numeros = new Set();
            TicketExcelState.products.forEach(product => {
                if (product.parsedUbicacion && 
                    product.parsedUbicacion.bloque === bloqueFilter &&
                    product.parsedUbicacion.lado === ladoFilter) {
                    numeros.add(product.parsedUbicacion.numeroBloque);
                }
            });
            
            if (numeroBloqueSelect) {
                const currentValue = numeroBloqueSelect.value;
                numeroBloqueSelect.innerHTML = '<option value="">Todos los números</option>';
                
                Array.from(numeros).sort().forEach(numero => {
                    const option = document.createElement('option');
                    option.value = numero;
                    option.textContent = numero;
                    numeroBloqueSelect.appendChild(option);
                });
                
                numeroBloqueSelect.disabled = false;
                
                if (currentValue && numeros.has(currentValue)) {
                    numeroBloqueSelect.value = currentValue;
                }
                
                document.getElementById('numeroBloqueCount').textContent = numeros.size;
            }
            
            updateNivelFilter();
        }

        function updateNivelFilter() {
            const bloqueFilter = document.getElementById('ticketFilterBloque').value;
            const ladoFilter = document.getElementById('ticketFilterLado').value;
            const numeroFilter = document.getElementById('ticketFilterNumeroBloque').value;
            const nivelSelect = document.getElementById('ticketFilterNivel');
            
            if (!bloqueFilter || !ladoFilter || !numeroFilter) {
                if (nivelSelect) {
                    nivelSelect.innerHTML = '<option value="">Selecciona número primero</option>';
                    nivelSelect.disabled = true;
                }
                return;
            }
            
            const niveles = new Set();
            TicketExcelState.products.forEach(product => {
                if (product.parsedUbicacion && 
                    product.parsedUbicacion.bloque === bloqueFilter &&
                    product.parsedUbicacion.lado === ladoFilter &&
                    product.parsedUbicacion.numeroBloque === numeroFilter) {
                    niveles.add(product.parsedUbicacion.nivel);
                }
            });
            
            if (nivelSelect) {
                const currentValue = nivelSelect.value;
                nivelSelect.innerHTML = '<option value="">Todos los niveles</option>';
                
                Array.from(niveles).sort().forEach(nivel => {
                    const option = document.createElement('option');
                    option.value = nivel;
                    option.textContent = nivel;
                    nivelSelect.appendChild(option);
                });
                
                nivelSelect.disabled = false;
                
                if (currentValue && niveles.has(currentValue)) {
                    nivelSelect.value = currentValue;
                }
                
                document.getElementById('nivelCount').textContent = niveles.size;
            }
        }

        // Limpiar todos los filtros
        function clearAllFilters() {
            document.getElementById('ticketSearchInput').value = '';
            document.getElementById('ticketFilterBloque').value = '';
            document.getElementById('ticketFilterLado').value = '';
            document.getElementById('ticketFilterNumeroBloque').value = '';
            document.getElementById('ticketFilterNivel').value = '';
            
            applyTicketFilters();
            showToast('Filtros limpiados', 'info');
        }

        // Descargar plantilla Excel
        function downloadTicketTemplate() {
            try {
                // Crear datos de ejemplo
                const sampleData = [
                    ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA'],
                    ['PROD001', 'Mármol Blanco Carrara', 'A1D0101', 'M2'],
                    ['PROD002', 'Granito Negro Absoluto', 'B2E0302', 'M2'],
                    ['PROD003', 'Cuarzo Blanco Premium', 'C3F0503', 'M2']
                ];
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                
                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Plantilla Productos');
                
                // Descargar archivo
                XLSX.writeFile(wb, 'plantilla_tickets_gallos_marmol.xlsx');
                
                showToast('Plantilla descargada correctamente', 'success');
            } catch (error) {
                console.error('Error descargando plantilla:', error);
                showToast('Error al descargar la plantilla', 'error');
            }
        }

        // ===== FUNCIONES DE VALIDACIÓN MEJORADAS =====
        
        function setupRealTimeValidation() {
            // Esta función se puede expandir para validación en tiempo real
            console.log('✅ Sistema de validación en tiempo real configurado');
        }

        function hasUnsavedChanges() {
            // Implementar lógica para detectar cambios sin guardar
            return false; // Por ahora retorna false
        }

        function showUnsavedChangesModal(callback) {
            // Implementar modal de cambios sin guardar
            if (confirm('Tienes cambios sin guardar. ¿Estás seguro de que quieres continuar?')) {
                callback();
            }
        }

        function validateAllFieldsBeforePdf() {
            const invalidProducts = [];
            
            TicketExcelState.filteredProducts.forEach(product => {
                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    invalidProducts.push({
                        product: product,
                        errors: validation.errors
                    });
                }
            });
            
            return {
                allValid: invalidProducts.length === 0,
                invalidProducts: invalidProducts
            };
        }

        function validateProductForPdf(product) {
            const errors = [];
            
            if (!product.codigo || product.codigo.trim() === '') {
                errors.push('Código requerido');
            }
            
            if (!product.descripcion || product.descripcion.trim() === '') {
                errors.push('Descripción requerida');
            }
            
            if (!product.ubicacion || product.ubicacion.trim() === '') {
                errors.push('Ubicación requerida');
            }
            
            if (!product.unidadMedida || product.unidadMedida.trim() === '') {
                errors.push('Unidad de medida requerida');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        function showValidationErrorsModal(invalidProducts) {
            let errorMessage = 'Los siguientes productos tienen errores:\n\n';
            
            invalidProducts.forEach((item, index) => {
                errorMessage += `${index + 1}. ${item.product.codigo || 'Sin código'}: ${item.errors.join(', ')}\n`;
            });
            
            errorMessage += '\nPor favor, corrige los errores antes de generar el PDF.';
            
            alert(errorMessage);
        }

        // ===== FUNCIONES DE GENERACIÓN DE PDF =====
        
        function showPdfFormatModalForAll(source) {
            const modal = document.getElementById('pdfFormatModal');
            const productCount = document.getElementById('pdfProductCount');
            const pdfBadgeCount = document.getElementById('pdfBadgeCount');
            const validProducts = TicketExcelState.filteredProducts.filter(product => 
                validateProductForPdf(product).isValid
            );
            
            productCount.textContent = validProducts.length;
            pdfBadgeCount.textContent = validProducts.length;
            
            modal.style.display = 'block';
            
            // Configurar event listeners del modal
            setupPdfModalEvents(validProducts);
        }

        function setupPdfModalEvents(validProducts) {
            const modal = document.getElementById('pdfFormatModal');
            const closeBtn = document.getElementById('closePdfModalBtn');
            const cancelBtn = document.getElementById('cancelPdfBtn');
            const confirmBtn = document.getElementById('confirmPdfBtn');
            const formatOptions = document.querySelectorAll('.format-option');
            const formatSelected = document.getElementById('pdfFormatSelected');
            
            // Cerrar modal
            function closeModal() {
                modal.classList.add('closing');
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('closing');
                }, 300);
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Seleccionar formato
            formatOptions.forEach(option => {
                option.addEventListener('click', function() {
                    formatOptions.forEach(opt => {
                        opt.classList.remove('active');
                        opt.querySelector('.check-circle').classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    this.querySelector('.check-circle').classList.add('active');
                    
                    const format = this.getAttribute('data-format');
                    const formatText = format === 'individual' ? 'Tickets Individuales' : 'PDF Múltiple';
                    formatSelected.textContent = formatText;
                });
            });
            
            // Confirmar generación
            confirmBtn.addEventListener('click', function() {
                const selectedFormat = document.querySelector('.format-option.active').getAttribute('data-format');
                closeModal();
                
                if (selectedFormat === 'individual') {
                    generateIndividualPdfs(validProducts);
                } else {
                    generateMultiplePdf(validProducts);
                }
            });
            
            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function generateIndividualPdfs(products) {
            showPdfGenerationOverlay(products.length, 'individual');
            
            // Simular generación de PDFs individuales
            let processed = 0;
            const total = products.length;
            
            const interval = setInterval(() => {
                processed++;
                updatePdfProgress(processed, total, `Generando PDF ${processed} de ${total}`);
                
                if (processed >= total) {
                    clearInterval(interval);
                    setTimeout(() => {
                        completePdfGeneration();
                    }, 1000);
                }
            }, 500);
        }

        function generateMultiplePdf(products) {
            showPdfGenerationOverlay(products.length, 'multiple');
            
            // Simular generación de PDF múltiple
            let progress = 0;
            const totalSteps = 4;
            
            const interval = setInterval(() => {
                progress++;
                updatePdfProgress(progress, totalSteps, `Paso ${progress} de ${totalSteps}`);
                
                // Actualizar etapas
                document.querySelectorAll('.pdf-step').forEach((step, index) => {
                    if (index < progress) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (index === progress) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
                
                if (progress >= totalSteps) {
                    clearInterval(interval);
                    setTimeout(() => {
                        completePdfGeneration();
                    }, 1000);
                }
            }, 1000);
        }

        function showPdfGenerationOverlay(totalProducts, format) {
            const overlay = document.getElementById('pdfGenerationOverlay');
            const title = document.getElementById('pdfGenerationTitle');
            const subtitle = document.getElementById('pdfGenerationSubtitle');
            const totalCount = document.getElementById('pdfTotalCount');
            
            title.textContent = format === 'individual' ? 'Generando PDFs Individuales' : 'Generando PDF Múltiple';
            subtitle.textContent = format === 'individual' ? 
                'Preparando tickets individuales...' : 'Compilando documento único...';
            totalCount.textContent = totalProducts;
            
            overlay.classList.add('active');
            
            // Resetear progreso
            updatePdfProgress(0, totalProducts, 'Iniciando proceso...');
        }

        function updatePdfProgress(current, total, status) {
            const currentCount = document.getElementById('pdfCurrentCount');
            const progressBar = document.getElementById('pdfProgressBar');
            const progressPercent = document.getElementById('pdfProgressPercent');
            const progressStats = document.getElementById('pdfProgressStats');
            const statusText = document.getElementById('pdfStatusText');
            
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            
            currentCount.textContent = current;
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressStats.textContent = `${current} de ${total} completados`;
            statusText.textContent = status;
        }

        function completePdfGeneration() {
            const overlay = document.getElementById('pdfGenerationOverlay');
            const title = document.getElementById('pdfGenerationTitle');
            const subtitle = document.getElementById('pdfGenerationSubtitle');
            
            title.textContent = '¡PDFs Generados!';
            subtitle.textContent = 'Los documentos están listos para descargar';
            
            // Mostrar animación de éxito
            document.querySelector('.pdf-generation-icon').innerHTML = '<i class="fas fa-check-circle pdf-success-animation"></i>';
            
            // Ocultar después de un tiempo
            setTimeout(() => {
                overlay.classList.remove('active');
                showToast('PDFs generados correctamente', 'success');
            }, 2000);
        }

        // Función para generar PDF individual
        function generateSinglePdf(productId) {
            const product = TicketExcelState.products.find(p => p.id === productId);
            if (!product) {
                showToast('Producto no encontrado', 'error');
                return;
            }
            
            const validation = validateProductForPdf(product);
            if (!validation.isValid) {
                showToast(`Error: ${validation.errors.join(', ')}`, 'error');
                return;
            }
            
            showPdfFormatModalForAll('single');
        }

        // Función para eliminar producto
        function deleteProduct(productId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                return;
            }
            
            TicketExcelState.products = TicketExcelState.products.filter(p => p.id !== productId);
            TicketExcelState.filteredProducts = TicketExcelState.filteredProducts.filter(p => p.id !== productId);
            
            renderTicketProductsTable();
            updateLocationFilters();
            
            showToast('Producto eliminado', 'success');
        }

        // Función para exportar a Excel
        function exportToExcel() {
            try {
                // Preparar datos
                const data = [
                    ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA', 'ESTADO']
                ];
                
                TicketExcelState.filteredProducts.forEach(product => {
                    data.push([
                        product.codigo,
                        product.descripcion,
                        product.ubicacion,
                        product.unidadMedida,
                        product.isValid ? 'VÁLIDO' : 'INVÁLIDO'
                    ]);
                });
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Productos Filtrados');
                
                // Descargar archivo
                XLSX.writeFile(wb, `productos_gallos_marmol_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showToast('Datos exportados a Excel correctamente', 'success');
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                showToast('Error al exportar los datos', 'error');
            }
        }

        // ===== MANEJO DE ERRORES =====
        window.addEventListener('error', function(e) {
            console.error('❌ Error no capturado:', e.error);
            showToast('Error inesperado en la aplicación', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Promesa rechazada no capturada:', e.reason);
            showToast('Error en operación asíncrona', 'error');
            e.preventDefault();
        });
    </script>
</body>
</html>
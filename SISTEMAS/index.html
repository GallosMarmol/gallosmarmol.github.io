<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Sistemas - Gallos M√°rmol</title>
    <meta name="description" content="Portal de sistemas para Gallos M√°rmol">
    <meta name="keywords" content="gallos m√°rmol, sistema, tickets, suministro, activo, despacho">
    <meta name="author" content="Gallos M√°rmol">
    <link rel="icon" type="image/x-icon" href="FOTO/ICONO/Icono_01.ico">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- En el <head> de cada sistema -->
    <script src="JS/auth-check.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --danger-color: #e74c3c;
            --danger-light: #ec7063;
            --light-color: #ecf0f1;
            --light-gray: #f8f9fa;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #fff;
            --text-muted: #6c757d;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --header-height: 70px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #d68910;
            --warning-light: #f8c471;
            --danger-color: #cb4335;
            --danger-light: #ec7063;
            --light-color: #2c2c2c;
            --light-gray: #1e1e1e;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            scroll-behavior: smooth;
            scroll-padding-top: var(--header-height);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== HEADER MOBILE-FIRST ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 60%;
        }

        .logo-img {
            height: 45px;
            width: auto;
            border-radius: var(--border-radius-sm);
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle, .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover, .fullscreen-btn:hover {
            background-color: var(--light-color);
            transform: scale(1.05);
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* ===== PORTAL DE SISTEMAS ===== */
        .portal-container {
            width: 100%;
            animation: fadeIn 0.8s ease-in-out;
            margin-top: 70px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .portal-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .portal-logo {
            margin-bottom: 1.5rem;
        }

        .portal-logo-img {
            height: 120px;
            width: 120px;
            margin: 0 auto 15px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }

        .portal-logo-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .portal-header h1 {
            color: var(--text-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: var(--primary-color);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .portal-header p {
            color: var(--text-muted);
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .system-card {
            background-color: var(--card-bg);
            padding: 2rem 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .system-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .system-card.selected {
            border: 2px solid var(--success-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
        }

        .system-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .system-card.disabled:hover {
            transform: none;
        }

        .system-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            transition: var(--transition);
            background: var(--primary-color);
        }

        .system-card.selected .system-icon {
            transform: scale(1.1);
        }

        .system-card h3 {
            color: var(--text-color);
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .system-card p {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.95rem;
            flex-grow: 1;
        }

        .system-roles {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .role-tag {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .login-section {
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            max-width: 600px;
            margin: 0 auto;
            transition: var(--transition);
        }

        .selected-system-info {
            background: rgba(52, 152, 219, 0.1);
            padding: 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--secondary-color);
            text-align: left;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .selected-system-info h4 {
            color: var(--text-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .selected-system-info p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .toast-info {
            background-color: var(--secondary-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-text {
            font-size: 1.1rem;
        }

        /* ===== BOTONES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .login-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .login-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            background: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        /* ===== ERROR MESSAGES ===== */
        .error-message {
            background-color: var(--danger-color);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        .error-message.warning {
            background-color: var(--warning-color);
        }

        .error-message.info {
            background-color: var(--secondary-color);
        }

        .error-message.show {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ===== USER INFO ===== */
        .user-info {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
            text-align: left;
            animation: slideIn 0.3s ease-out;
        }

        .user-info h4 {
            color: var(--text-color);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            border: 3px solid var(--primary-color);
        }

        .user-welcome {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .user-email {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .logout-btn {
            background: var(--primary-color);
            border: 1px solid var(--primary-color);
            color: #FFFFFF;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        /* ===== REDIRECT INFO ===== */
        .redirect-info {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }

        .redirect-countdown {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 1rem 0;
        }

        .countdown-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .countdown-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            position: relative;
        }

        .countdown-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        .redirect-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .action-btn.secondary {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* ===== ESTILOS PARA EL NUEVO SISTEMA DE REDIRECCI√ìN ===== */
        .redirect-content {
            text-align: center;
        }

        .redirect-details {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            text-align: left;
        }

        .redirect-details p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .countdown-text {
            font-size: 1rem;
            margin: 1rem 0;
        }

        .redirect-error {
            text-align: center;
            padding: 1rem;
        }

        .error-icon {
            font-size: 3rem;
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .error-detail {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: 1rem 0;
        }

        .error-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* Animaci√≥n para la cuenta regresiva */
        .countdown-circle {
            transition: transform 0.3s ease;
        }

        /* ===== ESTILOS PARA PANTALLAS DE ERROR MEJORADAS ===== */
        .error-screen {
            text-align: center;
            padding: 2rem;
        }

        .error-icon {
            font-size: 4rem;
            color: var(--danger-color);
            margin-bottom: 1.5rem;
        }

        .error-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .error-footer {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
        }

        .no-access-message {
            text-align: center;
            margin: 2rem 0;
        }

        .access-details {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            text-align: left;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .retry-status {
            text-align: center;
            padding: 3rem 2rem;
        }

        .retry-status .loading-spinner {
            margin: 0 auto 1.5rem;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .error-buttons,
            .action-buttons {
                flex-direction: column;
            }
            
            .error-buttons .btn,
            .action-buttons .btn {
                width: 100%;
            }
        }

        /* ===== ESTILOS MEJORADOS PARA SISTEMAS DESHABILITADOS ===== */
        .system-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .system-card.disabled::after {
            content: 'üîí Inicia sesi√≥n';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: var(--transition);
        }

        .system-card.disabled:hover::after {
            opacity: 1;
        }

        .system-card.disabled .system-icon {
            background: var(--light-color) !important;
        }

        .system-card.disabled .system-icon i {
            color: var(--text-muted) !important;
        }

        .system-card.disabled h3 {
            color: var(--text-muted);
        }

        .system-card.disabled p {
            color: var(--text-muted);
            font-style: italic;
        }

        /* ===== ESTILOS PARA PANTALLAS DE ERROR MEJORADAS ===== */
        .error-screen {
            text-align: center;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .error-message-content {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            border-left: 4px solid currentColor;
        }

        .error-message-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 0;
            color: var(--text-color);
        }

        .error-action {
            background: rgba(52, 152, 219, 0.1);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            border-left: 4px solid #3498db;
        }

        .error-action p {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .error-details {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            text-align: left;
        }

        .error-details summary {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            list-style: none;
        }

        .error-details summary::-webkit-details-marker {
            display: none;
        }

        .error-details summary::after {
            content: '‚ñ∂';
            float: right;
            transition: transform 0.3s ease;
        }

        .error-details[open] summary::after {
            transform: rotate(90deg);
        }

        .error-details-content {
            padding: 0 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .error-details-content p {
            margin: 0.5rem 0;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .error-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .error-footer {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .btn-tertiary {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-color);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-tertiary:hover {
            background: var(--light-gray);
            border-color: var(--text-color);
        }

        /* ===== ESTILOS PARA INTERFAZ SIMPLIFICADA ===== */
        .user-info-simplified {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .session-info {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(52, 152, 219, 0.1);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
        }

        .session-info p {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .session-info small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .logout-btn-simplified {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            width: 100%;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .logout-btn-simplified:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* Mejoras para las tarjetas de sistema */
        .system-card {
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .system-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .system-card:hover::before {
            left: 100%;
        }

        .system-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .system-card.selected {
            border: 2px solid var(--success-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
            transform: scale(0.98);
        }

        /* Ocultar elementos de redirecci√≥n que no se usan */
        .redirect-info {
            display: none !important;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pin-error {
            animation: shake 0.5s ease-in-out;
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }

        .intento-critico {
            background: rgba(231, 76, 60, 0.05) !important;
            border-left: 4px solid var(--danger-color) !important;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .error-screen {
                padding: 1.5rem 1rem;
            }
            
            .error-buttons {
                flex-direction: column;
            }
            
            .error-buttons .btn {
                width: 100%;
            }
        }

        /* Modo oscuro mejoras */
        .dark-mode .error-message-content {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark-mode .error-action {
            background: rgba(52, 152, 219, 0.15);
        }

        .dark-mode .error-details {
            background: rgba(255, 255, 255, 0.05);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (min-width: 576px) {
            html {
                font-size: 15px;
            }
            
            .container {
                padding: 1.5rem;
            }
            
            .toast {
                left: auto;
                right: 1rem;
                margin: 0;
            }
        }

        @media (min-width: 768px) {
            html {
                font-size: 16px;
            }
            
            .systems-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .portal-header h1 {
                font-size: 3rem;
            }
        }

        @media (min-width: 992px) {
            .systems-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .portal-header h1 {
                font-size: 1.8rem;
            }
            
            .system-card h3 {
                font-size: 1.3rem;
            }
            
            .redirect-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .login-section {
                padding: 2rem 1.5rem;
            }
            
            .header-content {
                padding: 0 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <img src="../FOTO/LOGO/Logo_01.webp" alt="Gallos M√°rmol" class="logo-img">
            </div>
            <div class="header-actions">
                <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa" aria-label="Pantalla completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="theme-toggle" id="themeToggle" title="Cambiar tema" aria-label="Cambiar tema">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Overlay de carga -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div class="container">
            <!-- Portal Principal -->
            <div class="portal-container">
                <div class="portal-header">
                    <h1>Gallos M√°rmol te da la bienvenida</h1>
                    <p>Selecciona el sistema al que deseas acceder e inicia sesi√≥n con tu cuenta de Google</p>
                </div>

                <div class="systems-grid">
                    <div class="system-card system-suministro" data-system="sistemaSuministro">
                        <div class="system-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h3>Sistema de Suministro</h3>
                    </div>

                    <div class="system-card system-ticket" data-system="sistemaTicket">
                        <div class="system-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <h3>Sistema de Tickets</h3>
                    </div>

                    <div class="system-card system-activo" data-system="sistemaActivo">
                        <div class="system-icon">
                            <i class="fas fa-laptop"></i>
                        </div>
                        <h3>Sistema de Activos</h3>
                    </div>

                    <div class="system-card system-despacho" data-system="sistemaDespacho">
                        <div class="system-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <h3>Sistema de Despacho</h3>
                    </div>
                </div>

                <div class="login-section">
                    <div class="selected-system-info" id="selectedSystemInfo" style="display: none;">
                        <h4><i class="fas fa-check-circle"></i> Sistema seleccionado</h4>
                        <p id="selectedSystemText">Has seleccionado el <strong id="systemName"></strong></p>
                    </div>

                    <div class="error-message" id="errorMessage">
                        <i class="fas fa-exclamation-triangle error-icon"></i>
                        <div class="error-content">
                            <span id="errorText"></span>
                            <div id="errorDetails" class="error-details"></div>
                            <div id="errorSuggestion" class="error-suggestion"></div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del usuario cuando ya est√° logueado -->
                    <div class="user-info" id="userInfo" style="display: none;">
                        <div class="user-header">
                            <div class="user-avatar-large" id="userAvatarLarge">C</div>
                            <div>
                                <div class="user-welcome" id="userWelcome">¬°Bienvenido de nuevo!</div>
                                <div class="user-email" id="userEmail"></div>
                            </div>
                        </div>
                        <h4><i class="fas fa-user-check"></i> Sesi√≥n activa</h4>
                        <div id="userDetails"></div>
                        
                        <button class="logout-btn" id="logoutBtnMain">
                            <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
                        </button>
                    </div>

                    <button class="login-btn" id="loginBtn" disabled>
                        <span id="loginText">Selecciona un sistema primero</span>
                    </button>

                    <div class="footer">
                        <p><i class="fas fa-lock"></i> Solo usuarios autorizados pueden acceder a los sistemas</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast notifications -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Operaci√≥n completada con √©xito</span>
        <button class="toast-close" aria-label="Cerrar notificaci√≥n">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // ===== CONFIGURACI√ìN SUPABASE =====
        const SUPABASE_CONFIG = {
            url: 'https://fzdwqkoporxnzvhpmlls.supabase.co', // Reemplazar con tu URL de Supabase
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6ZHdxa29wb3J4bnp2aHBtbGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDkxMDYsImV4cCI6MjA3NzM4NTEwNn0.nOS3oByMmopchYhH0Kv1I0lxi02VkqfsC-eGFTZ_ePg' // Reemplazar con tu clave an√≥nima
        };

        // ===== INICIALIZACI√ìN SUPABASE =====
        let supabase;
        // ‚úÖ VARIABLE GLOBAL PARA CONTROLAR MODALES ABIERTOS
        window.modalesAbiertos = new Set();

        function initializeSupabase() {
            try {
                console.log('üîç Verificando disponibilidad de Supabase...');
                
                // Verificar de m√∫ltiples formas
                const isSupabaseAvailable = 
                    typeof createClient !== 'undefined' || 
                    (window.supabase && window.supabase.createClient);
                
                if (isSupabaseAvailable) {
                    console.log('‚úÖ Supabase disponible globalmente');
                    return initializeSupabaseClient();
                } else {
                    console.log('üîÑ Supabase no disponible, cargando din√°micamente...');
                    return loadSupabaseDynamically();
                }
                
            } catch (error) {
                console.error('‚ùå Error en initializeSupabase:', error);
                showToast('Error de conexi√≥n con la base de datos', 'error');
                return false;
            }
        }
      
        // üî• CARGAR SUPABASE DIN√ÅMICAMENTE SI FALLA
        function loadSupabaseDynamically() {
            return new Promise((resolve) => {
                console.log('üîÑ Cargando Supabase din√°micamente...');
                
                // Verificar si ya est√° cargado (por si acaso)
                if (window.supabase || window.createClient) {
                    console.log('‚úÖ Supabase ya est√° disponible globalmente');
                    initializeSupabaseClient();
                    resolve(true);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                
                script.onload = () => {
                    console.log('‚úÖ Script de Supabase cargado, esperando inicializaci√≥n...');
                    
                    // üî• ESPERAR M√ÅS TIEMPO Y VERIFICAR DIFERENTES FORMAS
                    const checkSupabase = setInterval(() => {
                        if (typeof createClient !== 'undefined' || window.supabase) {
                            clearInterval(checkSupabase);
                            console.log('‚úÖ Supabase disponible despu√©s de carga din√°mica');
                            initializeSupabaseClient();
                            resolve(true);
                        }
                    }, 100);
                    
                    // Timeout despu√©s de 5 segundos
                    setTimeout(() => {
                        clearInterval(checkSupabase);
                        console.error('‚ùå Timeout: Supabase no se inicializ√≥ despu√©s de carga din√°mica');
                        resolve(false);
                    }, 5000);
                };
                
                script.onerror = () => {
                    console.error('‚ùå Error cargando script de Supabase');
                    resolve(false);
                };
                
                document.head.appendChild(script);
            });
        }

        // üî• AGREGAR ESTA FUNCI√ìN AUXILIAR:
        function initializeSupabaseClient() {
            try {
                console.log('üîß Inicializando cliente Supabase...');
                
                // URL actual de tu aplicaci√≥n (ajusta seg√∫n tu entorno)
                const SITE_URL = window.location.origin;
                
                console.log('üåê URL del sitio:', SITE_URL);
                
                // Configuraci√≥n corregida de Supabase
                let client;
                
                if (typeof createClient !== 'undefined') {
                    client = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true,
                            flowType: 'pkce',
                            storage: localStorage,
                            storageKey: 'sb-auth-token',
                            debug: false
                        }
                    });
                } else if (window.supabase && window.supabase.createClient) {
                    client = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    });
                } else {
                    throw new Error('createClient no disponible');
                }
                
                // Asignar a variable global y exportar
                supabase = client;
                window.supabaseClient = client; // Guardar globalmente
                
                console.log('‚úÖ Cliente Supabase inicializado correctamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error inicializando cliente Supabase:', error);
                return false;
            }
        }

        async function actualizarSistemasAcceso(usuarioId, nuevosSistemas) {
            try {
                const tiempoPeru = getPeruTime();
                
                const { error } = await supabase
                    .from('usuario')
                    .update({
                        sistemas_acceso: nuevosSistemas,
                        fecha_actualizacion: tiempoPeru.isoString
                    })
                    .eq('id', usuarioId);

                if (error) throw error;

                console.log('‚úÖ Sistemas de acceso actualizados con fecha Per√∫:', tiempoPeru.readable);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error actualizando sistemas de acceso:', error);
                throw error;
            }
        }

        async function actualizarEstadoUsuario(usuarioId, activo) {
            try {
                const tiempoPeru = getPeruTime();
                
                const { error } = await supabase
                    .from('usuario')
                    .update({
                        activo: activo,
                        fecha_actualizacion: tiempoPeru.isoString
                    })
                    .eq('id', usuarioId);

                if (error) throw error;

                console.log(`‚úÖ Estado de usuario ${activo ? 'activado' : 'desactivado'} con fecha Per√∫:`, tiempoPeru.readable);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error actualizando estado de usuario:', error);
                throw error;
            }
        }

        // ===== SISTEMAS DE OPTIMIZACI√ìN =====
        
// ===== SISTEMA DE ACCESO R√ÅPIDO CON PIN =====
        
        class SistemaAutenticacionPIN {
                    constructor() {
                this.MAXIMO_INTENTOS = 3;
                this.TIEMPO_BLOQUEO = 15 * 60 * 1000; // 15 minutos
                this.DURACION_SESION = 8 * 60 * 60 * 1000; // 8 horas
            }

                    async inicializarLoginPIN() {
                try {
                    console.log('üîê Inicializando sistema PIN...');
                    
                    // ‚úÖ LIMPIAR MODALES EXISTENTES ANTES DE ABRIR NUEVO
                    limpiarTodosLosModales();

                    const credenciales = await this.mostrarModalLoginPIN();
                    
                    if (!credenciales) {
                        return false;
                    }

                    const { email, pin } = credenciales;
                    
                    // ‚úÖ AGREGAR DEBUG (opcional - eliminar despu√©s)
                    await debugPINVerification(email, pin);

                    const validacion = this.validarCredenciales(email, pin);
                    if (!validacion.valido) {
                        showToast(validacion.mensaje, 'error');
                        return false;
                    }

                    const resultado = await this.verificarPINYObtenerSistemas(email, pin);

                    // ‚úÖ NUEVO: Manejo mejorado de errores sin excepciones
                    if (resultado.error) {
                        // Manejar error de PIN incorrecto sin lanzar excepci√≥n
                        this.mostrarErrorPIN(resultado.mensaje, resultado.intentosRestantes);
                        return false;
                    }

                    // ‚úÖ MANEJO MEJORADO: resultado ahora puede ser un objeto con m√°s informaci√≥n
                    if (resultado.exitoso && resultado.sistemasUsuario && resultado.sistemasUsuario.length > 0) {
                        await this.crearSesionPIN(email, resultado.sistemasUsuario);
                        
                        this.mostrarSistemasAccesibles(resultado.sistemasUsuario, {
                            email: email,
                            user_metadata: {
                                full_name: `${resultado.sistemasUsuario[0].datosUsuario.nombre} ${resultado.sistemasUsuario[0].datosUsuario.apellido || ''}`
                            }
                        });
                        
                        showToast(`¬°Bienvenido ${resultado.sistemasUsuario[0].datosUsuario.nombre}!`, 'success');
                        return true;
                    } else if (resultado.sinPIN) {
                        // ‚úÖ CASO: Usuario sin PIN - ofrecer configuraci√≥n
                        await this.manejarUsuarioSinPIN(email, resultado.datosUsuario);
                        return false;
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.error('‚ùå Error en login PIN:', error);
                    this.manejarErrorPIN(error);
                    // ‚úÖ ASEGURAR QUE LOS MODALES SE CIERREN CON ERROR
                    this.cerrarModalLoginPIN();

                    return false;
                }
            }

                    // ‚úÖ NUEVA FUNCI√ìN: Mostrar error de PIN de forma amigable
                    mostrarErrorPIN(mensaje, intentosRestantes) {
                        console.log('üîê Error de PIN controlado:', mensaje);
                        
                        // Mostrar mensaje amigable al usuario
                        showToast(mensaje, 'error');
                        
                        // Opcional: Puedes agregar efectos visuales adicionales
                        if (intentosRestantes <= 1) {
                            // Efecto especial para √∫ltimo intento
                            this.animarUltimoIntento();
                        }
                    }

                    // ‚úÖ FUNCI√ìN OPCIONAL: Animaci√≥n para √∫ltimo intento
                    animarUltimoIntento() {
                        const modal = document.querySelector('.modal-login-pin');
                        if (modal) {
                            modal.style.animation = 'shake 0.5s ease-in-out';
                            setTimeout(() => {
                                modal.style.animation = '';
                            }, 500);
                        }
                    }

                    validarCredenciales(email, pin) {
                        try {
                            const emailValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                            const pinValido = /^\d{4,6}$/.test(pin);
                            
                            if (!emailValido) {
                                // ‚úÖ MEJORADO: Retornar objeto en lugar de lanzar error
                                return {
                                    valido: false,
                                    error: 'EMAIL_INVALIDO',
                                    mensaje: 'Por favor ingresa un email v√°lido'
                                };
                            }
                            
                            if (!pinValido) {
                                // ‚úÖ MEJORADO: Retornar objeto en lugar de lanzar error
                                return {
                                    valido: false,
                                    error: 'PIN_INVALIDO',
                                    mensaje: 'El PIN debe tener 4-6 d√≠gitos num√©ricos'
                                };
                            }
                            
                            return { valido: true };
                            
                        } catch (error) {
                            // ‚úÖ MEJORADO: Manejar sin lanzar error
                            return {
                                valido: false,
                                error: 'ERROR_VALIDACION',
                                mensaje: 'Error validando credenciales'
                            };
                        }
                    }

                    async manejarIntentoFallidoPIN(datosUsuario) {
                        const nuevosIntentos = (datosUsuario.intentos_pin || 0) + 1;
                        let actualizaciones = { intentos_pin: nuevosIntentos };

                        // Bloquear despu√©s de MAXIMO_INTENTOS
                        if (nuevosIntentos >= this.MAXIMO_INTENTOS) {
                            actualizaciones.bloqueado_hasta = new Date(Date.now() + this.TIEMPO_BLOQUEO);
                            
                            // Registrar evento de bloqueo
                            await this.registrarEventoBloqueo(datosUsuario.id);
                        }

                        const { error } = await supabase
                            .from('usuario')
                            .update(actualizaciones)
                            .eq('id', datosUsuario.id);

                        if (error) {
                            console.error('Error actualizando intentos PIN:', error);
                        }
                    }
                    
                    async verificarPINYObtenerSistemas(email, pin) {
                        const claveCache = `intento_pin_${email}`;
                        const ahora = Date.now();
                        
                        // Verificar intentos recientes en cach√©
                        const intentoReciente = AppCache.get(claveCache);
                        if (intentoReciente && intentoReciente.intentos >= this.MAXIMO_INTENTOS) {
                            const tiempoRestante = intentoReciente.bloqueadoHasta - ahora;
                            if (tiempoRestante > 0) {
                                const minutos = Math.ceil(tiempoRestante / 60000);
                                throw new Error(`Demasiados intentos fallidos. Espera ${minutos} minuto${minutos > 1 ? 's' : ''}.`);
                            }
                        }

                        try {
                            console.log('üîç Verificando PIN para:', email);
                            
                            // Consultar usuario en Supabase
                            const { data: datosUsuario, error } = await supabase
                                .from('usuario')
                                .select(`
                                    id, nombre, apellido, correo, activo, 
                                    codigo_pin, intentos_pin, bloqueado_hasta,
                                    sistemas_acceso, fecha_ultimo_acceso
                                `)
                                .eq('correo', email)
                                .single();

                            if (error) {
                                if (error.code === 'PGRST116') {
                                    throw new Error('Email no registrado en el sistema');
                                }
                                throw error;
                            }

                            // Verificar si el usuario est√° activo
                            if (!datosUsuario.activo) {
                                throw new Error('Cuenta desactivada');
                            }

                            // Verificar bloqueo por intentos
                            if (datosUsuario.bloqueado_hasta && new Date(datosUsuario.bloqueado_hasta) > new Date()) {
                                const tiempoBloqueo = new Date(datosUsuario.bloqueado_hasta);
                                const minutosRestantes = Math.ceil((tiempoBloqueo - new Date()) / 60000);
                                throw new Error(`Cuenta temporalmente bloqueada. Intenta en ${minutosRestantes} minuto${minutosRestantes > 1 ? 's' : ''}.`);
                            }

                            // ‚úÖ MEJORADO: Manejar usuario sin PIN de forma elegante
                            if (!datosUsuario.codigo_pin) {
                                console.log('üîê Usuario sin PIN configurado:', email);
                                
                                // Devolver objeto especial indicando que no tiene PIN
                                return {
                                    exitoso: false,
                                    sinPIN: true,
                                    datosUsuario: datosUsuario,
                                    sistemasUsuario: await this.obtenerSistemasUsuario(datosUsuario)
                                };
                            }

                            // ‚úÖ CORREGIDO: Encriptar PIN ingresado antes de comparar
                            console.log('üîê Encriptando PIN ingresado para comparaci√≥n...');
                            const pinHasheadoIngresado = await GestionPIN.hashearPINSeguro(pin, datosUsuario.id);
                            
                            console.log('üîç Comparando hashes:');
                            console.log('   - Hash ingresado:', pinHasheadoIngresado.substring(0, 16) + '...');
                            console.log('   - Hash almacenado:', datosUsuario.codigo_pin.substring(0, 16) + '...');
                            console.log('   - Coinciden:', pinHasheadoIngresado === datosUsuario.codigo_pin);

                            if (datosUsuario.codigo_pin !== pinHasheadoIngresado) {
                                await this.manejarIntentoFallidoPIN(datosUsuario);
                                
                                const nuevosIntentos = (datosUsuario.intentos_pin || 0) + 1;
                                const intentosRestantes = this.MAXIMO_INTENTOS - nuevosIntentos;
                                
                                // ‚úÖ NUEVO: Retornar objeto en lugar de lanzar error
                                return {
                                    exitoso: false,
                                    error: 'PIN_INCORRECTO',
                                    intentosRestantes: intentosRestantes,
                                    mensaje: intentosRestantes > 0 
                                        ? `PIN incorrecto. Te quedan ${intentosRestantes} intento${intentosRestantes > 1 ? 's' : ''}.` 
                                        : 'PIN incorrecto. Cuenta bloqueada por seguridad.'
                                };
                            }

                            // PIN correcto - resetear intentos y actualizar √∫ltimo uso
                            await this.reiniciarIntentosPIN(datosUsuario.id);

                            // Obtener sistemas accesibles
                            const sistemasAccesibles = await this.obtenerSistemasUsuario(datosUsuario);

                            if (sistemasAccesibles.length === 0) {
                                throw new Error('No tienes acceso a ning√∫n sistema');
                            }

                            // Actualizar √∫ltimo acceso
                            await this.actualizarUltimoAcceso(datosUsuario.id);

                            return {
                                exitoso: true,
                                sinPIN: false,
                                datosUsuario: datosUsuario,
                                sistemasUsuario: sistemasAccesibles
                            };

                        } catch (error) {
                            // Incrementar intentos en cach√© solo para errores de PIN
                            if (error.message.includes('PIN incorrecto')) {
                                this.incrementarIntentosCache(email);
                            }
                            throw error;
                        }
                    }

                    async obtenerSistemasUsuario(datosUsuario) {
                        const sistemasAcceso = datosUsuario.sistemas_acceso || {};
                        const sistemasAccesibles = [];

                        Object.keys(sistemasAcceso).forEach(claveSistema => {
                            const configSistema = sistemasAcceso[claveSistema];
                            
                            if (configSistema?.activo && configSistema?.rol && SystemPages[claveSistema]) {
                                if (SystemPages[claveSistema][configSistema.rol]) {
                                    sistemasAccesibles.push({
                                        key: claveSistema,
                                        name: SystemNames[claveSistema] || claveSistema,
                                        rol: configSistema.rol,
                                        datosUsuario: datosUsuario,
                                        fechaAsignacion: configSistema.fechaAsignacion,
                                        activo: configSistema.activo
                                    });
                                }
                            }
                        });

                        return sistemasAccesibles;
                    }

                    async manejarUsuarioSinPIN(email, datosUsuario) {
                        console.log('üîê Manejando usuario sin PIN:', email);
                        
                        // Mostrar modal especial para usuarios sin PIN
                        const configurarPIN = await this.mostrarModalUsuarioSinPIN(email, datosUsuario);
                        
                        if (configurarPIN) {
                            // Redirigir a login por email para autenticaci√≥n primero
                            showToast('üîê Primero inicia sesi√≥n con tu email para configurar el PIN', 'info');
                            
                            // Esperar un momento y luego iniciar login por email
                            setTimeout(async () => {
                                await this.iniciarLoginYConfigurarPIN(email, datosUsuario.id);
                            }, 2000);
                        } else {
                            // Ofrecer otros m√©todos de login
                            showToast('üí° Puedes usar "Acceso por Email" para entrar al sistema', 'info');
                            
                            setTimeout(() => {
                                triggerEmailLogin();
                            }, 3000);
                        }
                    }

                    async mostrarModalUsuarioSinPIN(email, datosUsuario) {
                        return new Promise((resolve) => {
                            const modalHTML = `
                                <div class="modal-sin-pin" style="
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0,0,0,0.8);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    z-index: 10000;
                                ">
                                    <div style="
                                        background: var(--card-bg);
                                        padding: 2.5rem 2rem;
                                        border-radius: 16px;
                                        max-width: 500px;
                                        width: 90%;
                                        color: var(--text-color);
                                        border: 1px solid var(--border-color);
                                        box-shadow: var(--shadow-lg);
                                        text-align: center;
                                    ">
                                        <!-- Icono -->
                                        <div style="
                                            width: 80px;
                                            height: 80px;
                                            background: linear-gradient(135deg, var(--warning-color), var(--primary-color));
                                            border-radius: 50%;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            margin: 0 auto 1.5rem;
                                            color: white;
                                            font-size: 2rem;
                                        ">
                                            <i class="fas fa-key-skeleton"></i>
                                        </div>
                                        
                                        <!-- T√≠tulo -->
                                        <h3 style="color: var(--text-color); margin-bottom: 1rem; font-weight: 600;">
                                            PIN No Configurado
                                        </h3>
                                        
                                        <!-- Mensaje -->
                                        <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
                                            Hola <strong>${datosUsuario.nombre}</strong>,<br>
                                            No tienes un PIN configurado para acceso r√°pido.
                                        </p>
                                        
                                        <!-- Opciones -->
                                        <div style="background: rgba(52, 152, 219, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: left;">
                                            <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.1rem;">
                                                <i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>
                                                Elige tu opci√≥n:
                                            </h4>
                                            
                                            <div style="display: grid; gap: 1rem;">
                                                <!-- Opci√≥n 1: Configurar PIN -->
                                                <div style="display: flex; align-items: start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                                    <div style="
                                                        width: 40px;
                                                        height: 40px;
                                                        background: var(--success-color);
                                                        border-radius: 50%;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        color: white;
                                                        font-size: 1rem;
                                                        flex-shrink: 0;
                                                    ">
                                                        <i class="fas fa-bolt"></i>
                                                    </div>
                                                    <div>
                                                        <h5 style="margin: 0 0 0.5rem 0; color: var(--text-color); font-weight: 600;">
                                                            Configurar PIN R√°pido
                                                        </h5>
                                                        <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                                            Accesos futuros en 5 segundos
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                <!-- Opci√≥n 2: Usar Email -->
                                                <div style="display: flex; align-items: start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                                    <div style="
                                                        width: 40px;
                                                        height: 40px;
                                                        background: var(--secondary-color);
                                                        border-radius: 50%;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        color: white;
                                                        font-size: 1rem;
                                                        flex-shrink: 0;
                                                    ">
                                                        <i class="fas fa-envelope"></i>
                                                    </div>
                                                    <div>
                                                        <h5 style="margin: 0 0 0.5rem 0; color: var(--text-color); font-weight: 600;">
                                                            Acceso por Email
                                                        </h5>
                                                        <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                                            Link seguro (1-2 minutos)
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Botones -->
                                        <div style="display: flex; gap: 1rem; justify-content: center;">
                                            <button id="btnUsarEmail" style="
                                                padding: 1rem 2rem;
                                                border: 2px solid var(--border-color);
                                                background: transparent;
                                                color: var(--text-color);
                                                border-radius: 10px;
                                                cursor: pointer;
                                                font-weight: 500;
                                                transition: all 0.3s ease;
                                                flex: 1;
                                            " onmouseover="this.style.backgroundColor='var(--light-color)';" 
                                            onmouseout="this.style.backgroundColor='transparent';">
                                                <i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>
                                                Usar Email
                                            </button>
                                            
                                            <button id="btnConfigurarPIN" style="
                                                padding: 1rem 2rem;
                                                background: var(--success-color);
                                                color: white;
                                                border: none;
                                                border-radius: 10px;
                                                cursor: pointer;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                                flex: 1;
                                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';" 
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                                <i class="fas fa-key" style="margin-right: 0.5rem;"></i>
                                                Configurar PIN
                                            </button>
                                        </div>
                                        
                                        <!-- Informaci√≥n adicional -->
                                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                                            <p style="margin: 0; color: var(--text-muted); font-size: 0.8rem;">
                                                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                                                El PIN te permitir√° acceder instant√°neamente en el futuro
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            const contenedorModal = document.createElement('div');
                            contenedorModal.innerHTML = modalHTML;
                            document.body.appendChild(contenedorModal);
                            
                            const btnUsarEmail = document.getElementById('btnUsarEmail');
                            const btnConfigurarPIN = document.getElementById('btnConfigurarPIN');
                            
                            // Configurar PIN
                            btnConfigurarPIN.addEventListener('click', () => {
                                document.body.removeChild(contenedorModal);
                                resolve(true);
                            });
                            
                            // Usar Email
                            btnUsarEmail.addEventListener('click', () => {
                                document.body.removeChild(contenedorModal);
                                resolve(false);
                            });
                            
                            // Clic fuera para cerrar (default: usar email)
                            contenedorModal.addEventListener('click', (e) => {
                                if (e.target === contenedorModal) {
                                    document.body.removeChild(contenedorModal);
                                    resolve(false);
                                }
                            });
                        });
                    }

                    async iniciarLoginYConfigurarPIN(email, usuarioId) {
                        try {
                            showLoadingOverlay(true, 'Preparando configuraci√≥n de PIN...');
                            
                            // Primero autenticar al usuario
                            const { data, error } = await supabase.auth.signInWithOtp({
                                email: email,
                                options: {
                                    emailRedirectTo: window.location.origin,
                                    shouldCreateUser: false
                                }
                            });
                            
                            if (error) throw error;
                            
                            showToast('üìß Revisa tu email para autenticarte y configurar el PIN', 'success');
                            
                            // Esperar a que el usuario se autentique
                            this.esperarAutenticacionYConfigurarPIN(email, usuarioId);
                            
                        } catch (error) {
                            console.error('Error iniciando login para configurar PIN:', error);
                            showToast('Error: ' + error.message, 'error');
                        } finally {
                            showLoadingOverlay(false);
                        }
                    }

                    async esperarAutenticacionYConfigurarPIN(email, usuarioId) {
                        // Verificar peri√≥dicamente si el usuario se autentic√≥
                        const intervalo = setInterval(async () => {
                            try {
                                const { data: { session } } = await supabase.auth.getSession();
                                
                                if (session && session.user.email === email) {
                                    clearInterval(intervalo);
                                    
                                    // Usuario autenticado - configurar PIN
                                    await GestionPIN.mostrarModalConfiguracionPIN(usuarioId, email);
                                    
                                    // Cerrar sesi√≥n despu√©s de configurar PIN (opcional)
                                    setTimeout(() => {
                                        supabase.auth.signOut();
                                    }, 5000);
                                }
                            } catch (error) {
                                console.error('Error verificando autenticaci√≥n:', error);
                                clearInterval(intervalo);
                            }
                        }, 2000); // Verificar cada 2 segundos
                        
                        // Timeout despu√©s de 5 minutos
                        setTimeout(() => {
                            clearInterval(intervalo);
                            showToast('‚è∞ Tiempo de espera agotado', 'warning');
                        }, 5 * 60 * 1000);
                    }

                    async registrarEventoBloqueo(usuarioId) {
                        try {
                            // Primero verificar si la tabla existe
                            const { error } = await supabase
                                .from('auditoria_seguridad')
                                .insert({
                                    usuario_id: usuarioId,
                                    tipo_evento: 'bloqueo_pin',
                                    descripcion: 'Cuenta bloqueada por m√∫ltiples intentos fallidos de PIN',
                                    fecha_evento: new Date().toISOString(),
                                    ip_address: 'N/A'
                                });

                            if (error) {
                                console.warn('No se pudo registrar evento de bloqueo:', error);
                            }
                        } catch (error) {
                            console.warn('Error en registro de auditor√≠a:', error);
                        }
                    }

                    async reiniciarIntentosPIN(usuarioId) {
                        const { error } = await supabase
                            .from('usuario')
                            .update({
                                intentos_pin: 0,
                                bloqueado_hasta: null,
                                ultimo_pin_usado: new Date().toISOString(),
                                fecha_ultimo_acceso: new Date().toISOString()
                            })
                            .eq('id', usuarioId);

                        if (error) {
                            console.error('Error reseteando intentos PIN:', error);
                        }
                    }

                    incrementarIntentosCache(email) {
                        const claveCache = `intento_pin_${email}`;
                        const ahora = Date.now();
                        const actual = AppCache.get(claveCache) || { intentos: 0, bloqueadoHasta: 0 };
                        
                        actual.intentos += 1;
                        
                        if (actual.intentos >= this.MAXIMO_INTENTOS) {
                            actual.bloqueadoHasta = ahora + this.TIEMPO_BLOQUEO;
                        }
                        
                        AppCache.set(claveCache, actual, this.TIEMPO_BLOQUEO);
                    }

                    async actualizarUltimoAcceso(usuarioId, userEmail, cantidadSistemas = 0) {
                        try {
                            const tiempoPeru = getPeruTime();
                            
                            console.log('üïê Actualizando √∫ltimo acceso con fecha Per√∫:', tiempoPeru.readable);

                            // ‚úÖ CONSULTA CON FECHA PER√ö
                            const { error } = await supabase
                                .from('usuario')
                                .update({
                                    fecha_ultimo_acceso: tiempoPeru.isoString,
                                    fecha_actualizacion: tiempoPeru.isoString // ‚úÖ FECHA PER√ö
                                })
                                .eq('id', usuarioId);

                            if (error) {
                                console.warn('‚ö†Ô∏è No se pudo actualizar √∫ltimo acceso:', error);
                                
                                // Intentar solo con fecha_ultimo_acceso si fecha_actualizacion no existe
                                const { error: errorSimple } = await supabase
                                    .from('usuario')
                                    .update({
                                        fecha_ultimo_acceso: tiempoPeru.isoString
                                    })
                                    .eq('id', usuarioId);
                                    
                                if (errorSimple) {
                                    console.warn('‚ö†Ô∏è Error incluso con consulta simple:', errorSimple);
                                } else {
                                    console.log('üìù √öltimo acceso actualizado (solo fecha_ultimo_acceso)');
                                }
                            } else {
                                console.log('‚úÖ √öltimo acceso actualizado con fecha Per√∫ para:', userEmail);
                            }
                        } catch (updateError) {
                            console.warn('‚ö†Ô∏è Error actualizando √∫ltimo acceso:', updateError);
                        }
                    }

                    async crearSesionPIN(email, sistemasUsuario) {
                        const datosSesion = {
                            usuario: {
                                email: email,
                                nombre: sistemasUsuario[0].datosUsuario.nombre,
                                id: sistemasUsuario[0].datosUsuario.id
                            },
                            sistemas: sistemasUsuario,
                            timestamp: new Date().toISOString(),
                            ultimaActividad: Date.now(),
                            tipo: 'pin'
                        };
                        
                        localStorage.setItem('sesion_pin_gm', JSON.stringify(datosSesion));
                        AppSession.saveSession(datosSesion);
                        
                        console.log('‚úÖ Sesi√≥n PIN creada para:', email);
                    }

                    manejarErrorPIN(error) {
                        // ‚úÖ MEJORADO: No mostrar errores t√©cnicos en consola para errores de PIN
                        if (error.message && error.message.includes('PIN incorrecto')) {
                            console.log('üîê Error de PIN controlado - no mostrar en consola');
                            return; // No mostrar en consola errores de PIN controlados
                        }
                        
                        console.error('‚ùå Error en autenticaci√≥n PIN:', error);
                        
                        const mensajesError = {
                            'Email no registrado': '‚ùå Email no registrado en el sistema.',
                            'Cuenta desactivada': '‚ùå Tu cuenta ha sido desactivada. Contacta al administrador.',
                            'Demasiados intentos': 'üîí Demasiados intentos fallidos. Intenta m√°s tarde.',
                            'Cuenta bloqueada': 'üîí Cuenta temporalmente bloqueada por seguridad.',
                            'No tienes un PIN configurado': 'üîê No tienes PIN configurado. Usa "Acceso por Email" para configurarlo.'
                        };
                        
                        // ‚úÖ CORREGIDO: Usar showToast en lugar de mostrarToast
                        const mensaje = mensajesError[error.message] || `‚ùå Error: ${error.message}`;
                        showToast(mensaje, 'error');
                    }

                    // Modal de login con PIN
                    mostrarModalLoginPIN() {
                        return new Promise((resolve) => {
                            // ‚úÖ VERIFICAR SI YA HAY UN MODAL ABIERTO
                            if (window.modalesAbiertos.has('modalLoginPIN')) {
                                console.log('‚ö†Ô∏è Modal de PIN ya est√° abierto, cerrando anterior...');
                                this.cerrarModalLoginPIN();
                            }

                            // ‚úÖ GENERAR IDs √öNICOS
                            const modalId = 'modalLoginPIN_' + Date.now();
                            const emailInputId = 'inputEmailPIN_' + Date.now();
                            const pinInputId = 'inputCodigoPIN_' + Date.now();
                            const cancelBtnId = 'btnCancelarPIN_' + Date.now();
                            const accederBtnId = 'btnAccederPIN_' + Date.now();

                            console.log(`üîß Creando modal con IDs √∫nicos: ${modalId}`);

                            const modalHTML = `
                                <div class="modal-login-pin" id="${modalId}" style="
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0,0,0,0.8);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    z-index: 10000;
                                    font-family: 'Inter', sans-serif;
                                ">
                                    <div style="
                                        background: var(--card-bg);
                                        padding: 2rem;
                                        border-radius: 16px;
                                        max-width: 420px;
                                        width: 90%;
                                        color: var(--text-color);
                                        border: 1px solid var(--border-color);
                                        box-shadow: var(--shadow-lg);
                                        animation: fadeIn 0.3s ease-out;
                                    ">
                                        <!-- Header -->
                                        <div style="text-align: center; margin-bottom: 2rem;">
                                            <div style="
                                                width: 80px;
                                                height: 80px;
                                                background: var(--primary-color);
                                                border-radius: 50%;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                margin: 0 auto 1rem;
                                                color: white;
                                                font-size: 2rem;
                                            ">
                                                <i class="fas fa-key"></i>
                                            </div>
                                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600;">
                                                Acceso R√°pido con PIN
                                            </h3>
                                            <p style="color: var(--text-muted); font-size: 0.95rem;">
                                                Ingresa tus credenciales de acceso
                                            </p>
                                        </div>
                                        
                                        <!-- Formulario -->
                                        <div style="margin-bottom: 1.5rem;">
                                            <!-- Campo Email -->
                                            <div style="margin-bottom: 1.5rem;">
                                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                                    <i class="fas fa-envelope" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                                                    Correo Electr√≥nico
                                                </label>
                                                <input 
                                                    type="email" 
                                                    id="${emailInputId}" 
                                                    placeholder="tu.email@empresa.com" 
                                                    style="
                                                        width: 100%;
                                                        padding: 1rem;
                                                        border: 2px solid var(--border-color);
                                                        border-radius: 10px;
                                                        background: var(--bg-color);
                                                        color: var(--text-color);
                                                        font-size: 1rem;
                                                        transition: all 0.3s ease;
                                                        outline: none;
                                                    "
                                                    onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px rgba(203, 62, 44, 0.1)';"
                                                    onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                                                >
                                            </div>
                                            
                                            <!-- Campo PIN -->
                                            <div style="margin-bottom: 2rem;">
                                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.75rem;">
                                                    <label style="font-weight: 500; color: var(--text-color);">
                                                        <i class="fas fa-lock" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                                                        C√≥digo PIN
                                                    </label>
                                                    <span style="font-size: 0.8rem; color: var(--text-muted);">
                                                        4-6 d√≠gitos
                                                    </span>
                                                </div>
                                                <input 
                                                    type="password" 
                                                    id="${pinInputId}" 
                                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                                    maxlength="6"
                                                    inputmode="numeric"
                                                    pattern="[0-9]*"
                                                    style="
                                                        width: 100%;
                                                        padding: 1rem;
                                                        border: 2px solid var(--border-color);
                                                        border-radius: 10px;
                                                        background: var(--bg-color);
                                                        color: var(--text-color);
                                                        font-size: 1.5rem;
                                                        text-align: center;
                                                        letter-spacing: 0.5rem;
                                                        font-weight: 600;
                                                        transition: all 0.3s ease;
                                                        outline: none;
                                                    "
                                                    onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px rgba(203, 62, 44, 0.1)';"
                                                    onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                                                >
                                                    <div id="errorContainer" style="
                                                    display: none;
                                                    background: rgba(231, 76, 60, 0.1);
                                                    color: var(--danger-color);
                                                    padding: 1rem;
                                                    border-radius: 8px;
                                                    margin-bottom: 1rem;
                                                    border-left: 4px solid var(--danger-color);
                                                    text-align: left;
                                                    font-size: 0.9rem;
                                                ">
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    <span id="errorText"></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Informaci√≥n de Seguridad -->
                                        <div style="
                                            background: rgba(52, 152, 219, 0.1); 
                                            padding: 1rem; 
                                            border-radius: 10px; 
                                            margin-bottom: 2rem;
                                            border-left: 4px solid var(--secondary-color);
                                        ">
                                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center;">
                                                <i class="fas fa-shield-alt" style="margin-right: 0.5rem; color: var(--secondary-color);"></i>
                                                <strong>Acceso seguro:</strong> M√°ximo 3 intentos, bloqueo temporal por seguridad
                                            </p>
                                        </div>
                                        
                                        <!-- Botones de Acci√≥n -->
                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button id="${cancelBtnId}" style="
                                                padding: 1rem 1.5rem;
                                                border: 2px solid var(--border-color);
                                                background: transparent;
                                                color: var(--text-color);
                                                border-radius: 10px;
                                                cursor: pointer;
                                                font-weight: 500;
                                                transition: all 0.3s ease;
                                                flex: 1;
                                            " onmouseover="this.style.backgroundColor='var(--light-color)'; this.style.borderColor='var(--text-muted)';" 
                                            onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='var(--border-color)';">
                                                <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                                Cancelar
                                            </button>
                                            
                                            <button id="${accederBtnId}" style="
                                                padding: 1rem 1.5rem;
                                                background: var(--primary-color);
                                                color: white;
                                                border: none;
                                                border-radius: 10px;
                                                cursor: pointer;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                                flex: 2;
                                                opacity: 0.6;
                                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';" 
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                                            disabled>
                                                <i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>
                                                Acceder al Sistema
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            const contenedorModal = document.createElement('div');
                            contenedorModal.innerHTML = modalHTML;
                            document.body.appendChild(contenedorModal);
                            
                            // ‚úÖ REGISTRAR MODAL ABIERTO
                            window.modalesAbiertos.add('modalLoginPIN');
                            
                            const inputEmail = document.getElementById(emailInputId);
                            const inputPIN = document.getElementById(pinInputId);
                            const btnCancelar = document.getElementById(cancelBtnId);
                            const btnAcceder = document.getElementById(accederBtnId);
                            
                            // Auto-focus en email
                            setTimeout(() => {
                                if (inputEmail) inputEmail.focus();
                            }, 100);
                            
                            // Validaci√≥n en tiempo real
                            const validarFormulario = () => {
                                const email = inputEmail.value.trim();
                                const pin = inputPIN.value.trim();
                                const emailValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                                const pinValido = /^\d{4,6}$/.test(pin);
                                
                                if (emailValido && pinValido) {
                                    btnAcceder.disabled = false;
                                    btnAcceder.style.opacity = '1';
                                    btnAcceder.style.cursor = 'pointer';
                                } else {
                                    btnAcceder.disabled = true;
                                    btnAcceder.style.opacity = '0.6';
                                    btnAcceder.style.cursor = 'not-allowed';
                                }
                            };
                            
                            inputEmail.addEventListener('input', validarFormulario);
                            inputPIN.addEventListener('input', validarFormulario);
                            
                            // Navegaci√≥n con teclado
                            inputEmail.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    inputPIN.focus();
                                }
                            });
                            
                            inputPIN.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter' && !btnAcceder.disabled) {
                                    btnAcceder.click();
                                }
                            });
                            
                            // Solo n√∫meros en el campo PIN
                            inputPIN.addEventListener('input', function(e) {
                                this.value = this.value.replace(/[^0-9]/g, '');
                            });
                            
                            // Acci√≥n de login
                            btnAcceder.addEventListener('click', async () => {
                                const email = inputEmail.value.trim();
                                const pin = inputPIN.value.trim();
                                
                                if (email && pin) {
                                    btnAcceder.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i> Verificando...';
                                    btnAcceder.disabled = true;
                                    
                                    // Peque√±a animaci√≥n de carga
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                    
                                    this.cerrarModalLoginPIN();
                                    resolve({ email, pin });
                                }
                            });
                            
                            // Cancelar
                            btnCancelar.addEventListener('click', () => {
                                this.cerrarModalLoginPIN();
                                resolve(null);
                            });
                            
                            // Clic fuera para cerrar
                            contenedorModal.addEventListener('click', (e) => {
                                if (e.target === contenedorModal) {
                                    this.cerrarModalLoginPIN();
                                    resolve(null);
                                }
                            });

                            // ‚úÖ GUARDAR REFERENCIA PARA PODER CERRARLO
                            window.modalLoginActual = contenedorModal;
                        });
                    }

                    // ‚úÖ FUNCI√ìN PARA CERRAR MODAL DE PIN
                    cerrarModalLoginPIN() {
                        console.log('üîí Cerrando modal de PIN...');
                        
                        // Cerrar por clase
                        const modalesAbiertos = document.querySelectorAll('.modal-login-pin');
                        modalesAbiertos.forEach(modal => {
                            if (modal.parentNode) {
                                modal.parentNode.remove();
                            }
                        });
                        
                        // Cerrar por ID espec√≠fico
                        const modalesPorId = document.querySelectorAll('[id^="modalLoginPIN_"]');
                        modalesPorId.forEach(modal => {
                            if (modal.parentNode) {
                                modal.parentNode.remove();
                            }
                        });
                        
                        // Limpiar referencia global
                        if (window.modalLoginActual) {
                            if (window.modalLoginActual.parentNode) {
                                window.modalLoginActual.parentNode.remove();
                            }
                            window.modalLoginActual = null;
                        }
                        
                        // Remover del registro
                        window.modalesAbiertos.delete('modalLoginPIN');
                        
                        console.log('‚úÖ Modal de PIN cerrado');
                    }

                    // Verificar sesi√≥n PIN existente al cargar la aplicaci√≥n
                    async verificarSesionPIN() {
                        try {
                            const datosSesion = localStorage.getItem('sesion_pin_gm');
                            
                            if (datosSesion) {
                                const sesion = JSON.parse(datosSesion);
                                const ahora = Date.now();
                                
                                // Verificar si la sesi√≥n expir√≥ (8 horas)
                                if (ahora - sesion.ultimaActividad > this.DURACION_SESION) {
                                    localStorage.removeItem('sesion_pin_gm');
                                    return false;
                                }
                                
                                // Actualizar √∫ltima actividad
                                sesion.ultimaActividad = ahora;
                                localStorage.setItem('sesion_pin_gm', JSON.stringify(sesion));
                                
                                console.log('‚úÖ Sesi√≥n PIN recuperada:', sesion.usuario.email);
                                
                                // Mostrar sistemas directamente
                                this.mostrarSistemasAccesibles(sesion.sistemas, {
                                    email: sesion.usuario.email,
                                    user_metadata: { full_name: sesion.usuario.nombre }
                                });
                                
                                return true;
                            }
                        } catch (error) {
                            console.error('‚ùå Error recuperando sesi√≥n PIN:', error);
                            localStorage.removeItem('sesion_pin_gm');
                        }
                        
                        return false;
                    }

                    mostrarSistemasAccesibles(sistemas, usuario) {
                        // Reutilizar la funci√≥n existente o implementar espec√≠fica para PIN
                        if (typeof displayAccessibleSystems === 'function') {
                            displayAccessibleSystems(sistemas, usuario);
                        } else {
                            console.log('üìä Mostrando sistemas para:', usuario.email);
                            // Implementaci√≥n alternativa aqu√≠...
                        }
                    }

        }

        class SistemaAdaptadorEstructura {
            constructor() {
                this.columnasConocidas = null;
                this.inicializado = false;
            }
            
            async inicializar() {
            try {
                console.log('üèóÔ∏è Inicializando adaptador de estructura...');
                
                // Verificar que Supabase est√© disponible
                if (!supabase) {
                    console.error('‚ùå Supabase no est√° inicializado');
                    throw new Error('Supabase no disponible');
                }
                
                this.columnasConocidas = await this.detectarEstructura();
                this.inicializado = true;
                console.log('‚úÖ Adaptador de estructura inicializado:', this.columnasConocidas);
                
            } catch (error) {
                console.error('‚ùå Error inicializando adaptador de estructura:', error);
                this.inicializado = false;
                throw error;
            }
        }

            async detectarEstructura() {
                try {
                    console.log('üîç Detectando estructura de la base de datos...');
                    
                    // Verificar nuevamente que supabase est√© disponible
                    if (!supabase) {
                        throw new Error('Supabase no est√° inicializado');
                    }
                    
                    const { data, error } = await supabase
                        .from('usuario')
                        .select('*')
                        .limit(1)
                        .single();
                        
                    if (error) {
                        console.error('‚ùå Error en consulta de estructura:', error);
                        
                        // Si es error de tabla no encontrada, usar estructura por defecto
                        if (error.code === '42P01') {
                            console.warn('‚ö†Ô∏è Tabla usuario no encontrada, usando estructura por defecto');
                            return this.getEstructuraPorDefecto();
                        }
                        
                        throw error;
                    }
                    
                    const estructura = {
                        columnas: Object.keys(data),
                        tieneRol: 'rol' in data,
                        tieneSistemasAcceso: 'sistemas_acceso' in data,
                        tienePermisosGlobales: 'permisos_globales' in data,
                        tieneCodigoPIN: 'codigo_pin' in data,
                        tieneFechaCreacionPIN: 'fecha_creacion_pin' in data,
                        tieneBloqueadoHasta: 'bloqueado_hasta' in data
                    };
                    
                    console.log('üìã Estructura detectada:', estructura);
                    return estructura;
                    
                } catch (error) {
                    console.error('‚ùå Error detectando estructura:', error);
                    
                    // En caso de error, retornar estructura por defecto
                    return this.getEstructuraPorDefecto();
                }
            }
        
            async obtenerUsuarioPorEmail(email) {
                if (!this.columnasConocidas) {
                    await this.inicializar();
                }
                
                // Construir consulta din√°mica basada en columnas disponibles
                let consulta = supabase
                    .from('usuario')
                    .select('*')
                    .eq('correo', email)
                    .eq('activo', true)
                    .single();
                    
                const { data, error } = await consulta;
                
                if (error) throw error;
                return data;
            }
            
            determinarRol(usuario, sistemaKey) {
                // 1. Intentar desde sistemas_acceso
                if (usuario.sistemas_acceso?.[sistemaKey]?.rol) {
                    return usuario.sistemas_acceso[sistemaKey].rol;
                }
                
                // 2. Intentar desde columna rol si existe
                if (this.columnasConocidas.tieneRol && usuario.rol) {
                    return usuario.rol;
                }
                
                // 3. Rol por defecto
                return 'colaborador';
            }
        }

        class SistemaGestionPIN {

            constructor() {
                this.longitudPIN = 6;
                this.MAXIMO_INTENTOS = 3;
                this.TIEMPO_BLOQUEO = 15 * 60 * 1000;
                
                // ‚úÖ VERIFICAR QUE EL SALT SEA CONSISTENTE
                this.SALT_GLOBAL = this.inicializarSaltSeguro();
                console.log('üîê Sistema de PIN seguro inicializado');
                console.log('   - SALT_GLOBAL:', this.SALT_GLOBAL); // ‚Üê Agregar este log
            }
            
            inicializarSaltSeguro() {
                // ‚úÖ USAR SIEMPRE EL MISMO SALT (no cambiar entre sesiones)
                const SALT_FIJO = 'gallos_marmol_pin_salt_2024_seguro'; // ‚Üê Cambia esto por tu SALT real
                
                // O si usas variable de entorno, aseg√∫rate que sea la misma
                if (typeof process !== 'undefined' && process.env && process.env.PIN_HASH_SALT) {
                    return process.env.PIN_HASH_SALT;
                }
                
                // O desde configuraci√≥n global
                if (window.APP_CONFIG && window.APP_CONFIG.PIN_HASH_SALT) {
                    return window.APP_CONFIG.PIN_HASH_SALT;
                }
                
                // Si no hay configuraci√≥n, usar el fijo
                console.warn('‚ö†Ô∏è Usando SALT fijo para desarrollo');
                return SALT_FIJO;
            }

            generarSaltAleatorio(longitud = 32) {
                const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
                let salt = '';
                
                // Usar crypto.getRandomValues para mayor seguridad
                if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
                    const randomValues = new Uint32Array(longitud);
                    crypto.getRandomValues(randomValues);
                    
                    for (let i = 0; i < longitud; i++) {
                        salt += caracteres[randomValues[i] % caracteres.length];
                    }
                } else {
                    // Fallback para navegadores antiguos
                    for (let i = 0; i < longitud; i++) {
                        salt += caracteres[Math.floor(Math.random() * caracteres.length)];
                    }
                }
                
                return salt;
            }

            // ===== M√âTODOS PRINCIPALES SEGUROS =====
            // Agregar estos m√©todos a la clase GestionPIN
            async mostrarModalCambioPIN(usuarioId, email, nombreUsuario) {
                return new Promise((resolve) => {
                    console.log('üîê Mostrando modal para cambiar PIN...');
                    
                    const modalHTML = `
                        <div class="modal-cambio-pin" style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            font-family: 'Inter', sans-serif;
                        ">
                            <div style="
                                background: var(--card-bg);
                                padding: 2.5rem 2rem;
                                border-radius: 16px;
                                max-width: 500px;
                                width: 90%;
                                color: var(--text-color);
                                border: 1px solid var(--border-color);
                                box-shadow: var(--shadow-lg);
                            ">
                                <!-- Header -->
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <div style="
                                        width: 80px;
                                        height: 80px;
                                        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin: 0 auto 1rem;
                                        color: white;
                                        font-size: 2rem;
                                    ">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600;">
                                        Cambiar PIN de Seguridad
                                    </h3>
                                    <p style="color: var(--text-muted); font-size: 0.95rem;">
                                        Hola <strong>${nombreUsuario}</strong>, actualiza tu c√≥digo de acceso
                                    </p>
                                </div>
                                
                                <!-- Formulario -->
                                <form id="formCambioPIN">
                                    <div style="margin-bottom: 2rem;">
                                        <!-- PIN Actual -->
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                                <i class="fas fa-lock" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                                                PIN Actual
                                            </label>
                                            <input 
                                                type="password" 
                                                id="pinActual" 
                                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                                maxlength="6"
                                                inputmode="numeric"
                                                pattern="[0-9]*"
                                                required
                                                style="
                                                    width: 100%;
                                                    padding: 1rem;
                                                    border: 2px solid var(--border-color);
                                                    border-radius: 10px;
                                                    background: var(--bg-color);
                                                    color: var(--text-color);
                                                    font-size: 1.5rem;
                                                    text-align: center;
                                                    letter-spacing: 0.5rem;
                                                    font-weight: 600;
                                                    transition: all 0.3s ease;
                                                    outline: none;
                                                "
                                                onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px rgba(203, 62, 44, 0.1)';"
                                                onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                                            >
                                        </div>
                                        
                                        <!-- Nuevo PIN -->
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                                <i class="fas fa-key" style="margin-right: 0.5rem; color: var(--success-color);"></i>
                                                Nuevo PIN (6 d√≠gitos)
                                            </label>
                                            <input 
                                                type="password" 
                                                id="nuevoPIN" 
                                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                                maxlength="6"
                                                inputmode="numeric"
                                                pattern="[0-9]*"
                                                required
                                                style="
                                                    width: 100%;
                                                    padding: 1rem;
                                                    border: 2px solid var(--border-color);
                                                    border-radius: 10px;
                                                    background: var(--bg-color);
                                                    color: var(--text-color);
                                                    font-size: 1.5rem;
                                                    text-align: center;
                                                    letter-spacing: 0.5rem;
                                                    font-weight: 600;
                                                    transition: all 0.3s ease;
                                                    outline: none;
                                                "
                                                onfocus="this.style.borderColor='var(--success-color)'; this.style.boxShadow='0 0 0 3px rgba(39, 174, 96, 0.1)';"
                                                onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                                            >
                                        </div>
                                        
                                        <!-- Confirmar PIN -->
                                        <div style="margin-bottom: 2rem;">
                                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                                <i class="fas fa-redo" style="margin-right: 0.5rem; color: var(--success-color);"></i>
                                                Confirmar Nuevo PIN
                                            </label>
                                            <input 
                                                type="password" 
                                                id="confirmarPIN" 
                                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                                maxlength="6"
                                                inputmode="numeric"
                                                pattern="[0-9]*"
                                                required
                                                style="
                                                    width: 100%;
                                                    padding: 1rem;
                                                    border: 2px solid var(--border-color);
                                                    border-radius: 10px;
                                                    background: var(--bg-color);
                                                    color: var(--text-color);
                                                    font-size: 1.5rem;
                                                    text-align: center;
                                                    letter-spacing: 0.5rem;
                                                    font-weight: 600;
                                                    transition: all 0.3s ease;
                                                    outline: none;
                                                "
                                                onfocus="this.style.borderColor='var(--success-color)'; this.style.boxShadow='0 0 0 3px rgba(39, 174, 96, 0.1)';"
                                                onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                                            >
                                        </div>
                                    </div>
                                    
                                    <!-- Indicador de validaci√≥n -->
                                    <div id="indicadorValidacion" style="
                                        padding: 1rem;
                                        border-radius: 10px;
                                        margin-bottom: 1.5rem;
                                        text-align: center;
                                        font-size: 0.9rem;
                                        font-weight: 500;
                                        display: none;
                                        background: rgba(52, 152, 219, 0.1);
                                        border-left: 4px solid var(--secondary-color);
                                    ">
                                        <i class="fas fa-shield-alt" style="margin-right: 0.5rem; color: var(--secondary-color);"></i>
                                        <span id="textoValidacion">PIN seguro y coincidente</span>
                                    </div>
                                    
                                    <!-- Informaci√≥n de seguridad -->
                                    <div style="background: rgba(40, 167, 69, 0.1); padding: 1.25rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #28a745;">
                                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                                            <i class="fas fa-info-circle" style="margin-right: 0.75rem; color: #28a745;"></i>
                                            <strong>Seguridad:</strong> Tu nuevo PIN se encriptar√° con SHA-256 para m√°xima protecci√≥n
                                        </p>
                                    </div>
                                    
                                    <!-- Botones -->
                                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                        <button type="button" id="btnCancelarCambio" style="
                                            padding: 1rem 1.5rem;
                                            border: 2px solid var(--border-color);
                                            background: transparent;
                                            color: var(--text-color);
                                            border-radius: 10px;
                                            cursor: pointer;
                                            font-weight: 500;
                                            transition: all 0.3s ease;
                                            flex: 1;
                                        " onmouseover="this.style.backgroundColor='var(--light-color)'; this.style.borderColor='var(--text-muted)';" 
                                        onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='var(--border-color)';">
                                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                            Cancelar
                                        </button>
                                        
                                        <button type="submit" id="btnConfirmarCambio" style="
                                            padding: 1rem 1.5rem;
                                            background: var(--success-color);
                                            color: white;
                                            border: none;
                                            border-radius: 10px;
                                            cursor: pointer;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                            flex: 2;
                                            opacity: 0.6;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';" 
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                                        disabled>
                                            <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                                            Actualizar PIN
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    const contenedorModal = document.createElement('div');
                    contenedorModal.innerHTML = modalHTML;
                    document.body.appendChild(contenedorModal);
                    
                    const pinActualInput = document.getElementById('pinActual');
                    const nuevoPINInput = document.getElementById('nuevoPIN');
                    const confirmarPINInput = document.getElementById('confirmarPIN');
                    const btnCancelar = document.getElementById('btnCancelarCambio');
                    const btnConfirmar = document.getElementById('btnConfirmarCambio');
                    const indicadorValidacion = document.getElementById('indicadorValidacion');
                    const textoValidacion = document.getElementById('textoValidacion');
                    const form = document.getElementById('formCambioPIN');
                    
                    const self = this;
                    
                    const validarFormulario = async () => {
                        const pinActual = pinActualInput.value.replace(/[^0-9]/g, '');
                        const nuevoPIN = nuevoPINInput.value.replace(/[^0-9]/g, '');
                        const confirmarPIN = confirmarPINInput.value.replace(/[^0-9]/g, '');
                        
                        const pinActualValido = /^\d{6}$/.test(pinActual);
                        const nuevoPINValido = /^\d{6}$/.test(nuevoPIN);
                        const pinsCoinciden = nuevoPIN === confirmarPIN;
                        const noEsDebil = !self.esPINDebil(nuevoPIN);
                        const esDiferente = nuevoPIN !== pinActual;
                        
                        // Verificar PIN actual solo si est√° completo
                        let pinActualCorrecto = false;
                        if (pinActualValido) {
                            try {
                                pinActualCorrecto = await self.verificarPIN(usuarioId, pinActual);
                            } catch (error) {
                                pinActualCorrecto = false;
                            }
                        }
                        
                        if (pinActualValido && pinActualCorrecto && nuevoPINValido && pinsCoinciden && noEsDebil && esDiferente) {
                            indicadorValidacion.style.display = 'block';
                            textoValidacion.innerHTML = '<i class="fas fa-check-circle"></i> PIN v√°lido y seguro';
                            textoValidacion.style.color = 'var(--success-color)';
                            btnConfirmar.disabled = false;
                            btnConfirmar.style.opacity = '1';
                        } else {
                            indicadorValidacion.style.display = 'block';
                            
                            if (!pinActualValido) {
                                textoValidacion.innerHTML = '<i class="fas fa-exclamation-triangle"></i> PIN actual debe tener 6 d√≠gitos';
                                textoValidacion.style.color = 'var(--warning-color)';
                            } else if (!pinActualCorrecto) {
                                textoValidacion.innerHTML = '<i class="fas fa-times-circle"></i> PIN actual incorrecto';
                                textoValidacion.style.color = 'var(--danger-color)';
                            } else if (!nuevoPINValido) {
                                textoValidacion.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Nuevo PIN debe tener 6 d√≠gitos';
                                textoValidacion.style.color = 'var(--warning-color)';
                            } else if (!pinsCoinciden) {
                                textoValidacion.innerHTML = '<i class="fas fa-times-circle"></i> Los PINs no coinciden';
                                textoValidacion.style.color = 'var(--danger-color)';
                            } else if (!noEsDebil) {
                                textoValidacion.innerHTML = '<i class="fas fa-shield-alt"></i> Elige un PIN m√°s seguro';
                                textoValidacion.style.color = 'var(--warning-color)';
                            } else if (!esDiferente) {
                                textoValidacion.innerHTML = '<i class="fas fa-info-circle"></i> El nuevo PIN debe ser diferente al actual';
                                textoValidacion.style.color = 'var(--warning-color)';
                            }
                            
                            btnConfirmar.disabled = true;
                            btnConfirmar.style.opacity = '0.6';
                        }
                    };
                    
                    // Event listeners para validaci√≥n en tiempo real
                    pinActualInput.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        validarFormulario();
                    });
                    
                    nuevoPINInput.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        validarFormulario();
                    });
                    
                    confirmarPINInput.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                        validarFormulario();
                    });
                    
                    // Env√≠o del formulario
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const pinActual = pinActualInput.value;
                        const nuevoPIN = nuevoPINInput.value;
                        
                        try {
                            btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i> Actualizando...';
                            btnConfirmar.disabled = true;
                            
                            // Verificar nuevamente el PIN actual
                            const pinCorrecto = await self.verificarPIN(usuarioId, pinActual);
                            if (!pinCorrecto) {
                                throw new Error('PIN actual incorrecto');
                            }
                            
                            // Configurar nuevo PIN
                            await self.configurarPIN(usuarioId, nuevoPIN);
                            
                            // Registrar evento de auditor√≠a
                            await self.registrarEventoPIN(usuarioId, 'cambio_pin', 'PIN cambiado exitosamente');
                            
                            document.body.removeChild(contenedorModal);
                            showToast('‚úÖ PIN actualizado correctamente', 'success');
                            resolve(true);
                            
                        } catch (error) {
                            console.error('‚ùå Error cambiando PIN:', error);
                            showToast(`‚ùå Error: ${error.message}`, 'error');
                            
                            btnConfirmar.innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i> Actualizar PIN';
                            btnConfirmar.disabled = false;
                        }
                    });
                    
                    // Cancelar
                    btnCancelar.addEventListener('click', () => {
                        document.body.removeChild(contenedorModal);
                        resolve(false);
                    });
                    
                    // Clic fuera para cerrar
                    contenedorModal.addEventListener('click', (e) => {
                        if (e.target === contenedorModal) {
                            document.body.removeChild(contenedorModal);
                            resolve(false);
                        }
                    });
                    
                    // Auto-focus
                    setTimeout(() => pinActualInput.focus(), 100);
                });
            }

            // Agregar este m√©todo a la clase GestionPIN para verificaci√≥n simple
            async verificarPIN(usuarioId, pinIngresado) {
                try {
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('codigo_pin')
                        .eq('id', usuarioId)
                        .single();

                    if (error) throw error;

                    // Encriptar PIN ingresado para comparar
                    const pinHasheadoIngresado = await this.hashearPINSeguro(pinIngresado, usuarioId);
                    
                    return usuario.codigo_pin === pinHasheadoIngresado;
                    
                } catch (error) {
                    console.error('Error verificando PIN:', error);
                    return false;
                }
            }

            // Agregar este m√©todo a la clase GestionPIN
            async mostrarModalConfiguracionObligatoria(usuarioId, email, nombreUsuario) {
                return new Promise((resolve) => {
                    console.log('üîê Configuraci√≥n obligatoria de PIN para:', email);
                    
                    const modalHTML = `
                        <div class="modal-pin-obligatorio" style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.9);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            font-family: 'Inter', sans-serif;
                        ">
                            <div style="
                                background: var(--card-bg);
                                padding: 3rem 2.5rem;
                                border-radius: 20px;
                                max-width: 600px;
                                width: 90%;
                                color: var(--text-color);
                                border: 2px solid var(--primary-color);
                                box-shadow: var(--shadow-lg);
                                text-align: center;
                            ">
                                <!-- Icono de seguridad -->
                                <div style="
                                    width: 100px;
                                    height: 100px;
                                    background: linear-gradient(135deg, var(--primary-color), var(--success-color));
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin: 0 auto 2rem;
                                    color: white;
                                    font-size: 2.5rem;
                                    border: 4px solid white;
                                    box-shadow: var(--shadow-lg);
                                ">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                
                                <!-- T√≠tulo -->
                                <h2 style="color: var(--text-color); margin-bottom: 1rem; font-weight: 700; font-size: 2rem;">
                                    Configuraci√≥n Requerida
                                </h2>
                                
                                <!-- Mensaje personalizado -->
                                <div style="background: rgba(52, 152, 219, 0.1); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border-left: 4px solid var(--primary-color);">
                                    <p style="margin: 0; font-size: 1.1rem; line-height: 1.6; color: var(--text-color);">
                                        Hola <strong style="color: var(--primary-color);">${nombreUsuario}</strong>,<br>
                                        Para acceder a los sistemas de <strong>Gallos M√°rmol</strong>, debes configurar un PIN de seguridad.
                                    </p>
                                </div>
                                
                                <!-- Beneficios -->
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2.5rem;">
                                    <div style="text-align: center; padding: 1.5rem; background: rgba(40, 167, 69, 0.1); border-radius: 10px;">
                                        <i class="fas fa-bolt" style="font-size: 2rem; color: var(--success-color); margin-bottom: 0.5rem;"></i>
                                        <h4 style="margin: 0.5rem 0; color: var(--text-color);">Acceso R√°pido</h4>
                                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">5-10 segundos</p>
                                    </div>
                                    <div style="text-align: center; padding: 1.5rem; background: rgba(52, 152, 219, 0.1); border-radius: 10px;">
                                        <i class="fas fa-lock" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 0.5rem;"></i>
                                        <h4 style="margin: 0.5rem 0; color: var(--text-color);">M√°xima Seguridad</h4>
                                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">Encriptaci√≥n SHA-256</p>
                                    </div>
                                </div>
                                
                                <!-- Instrucciones -->
                                <div style="background: rgba(255, 193, 7, 0.1); padding: 1.5rem; border-radius: 10px; margin-bottom: 2.5rem; border-left: 4px solid var(--warning-color);">
                                    <h4 style="color: var(--warning-color); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                        <i class="fas fa-exclamation-circle"></i> Importante
                                    </h4>
                                    <ul style="text-align: left; color: var(--text-color); margin: 0; padding-left: 1.5rem;">
                                        <li>El PIN debe tener exactamente <strong>6 d√≠gitos</strong></li>
                                        <li>No uses secuencias simples (123456, 000000, etc.)</li>
                                        <li>Guarda tu PIN en un lugar seguro</li>
                                        <li>Podr√°s cambiarlo despu√©s desde tu perfil</li>
                                    </ul>
                                </div>
                                
                                <!-- Bot√≥n de acci√≥n -->
                                <button id="btnConfigurarAhora" style="
                                    padding: 1.5rem 3rem;
                                    background: linear-gradient(135deg, var(--primary-color), var(--success-color));
                                    color: white;
                                    border: none;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    font-weight: 700;
                                    font-size: 1.2rem;
                                    transition: all 0.3s ease;
                                    width: 100%;
                                    box-shadow: var(--shadow-lg);
                                " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-xl)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-lg)';">
                                    <i class="fas fa-key" style="margin-right: 1rem;"></i>
                                    Configurar Mi PIN Ahora
                                </button>
                                
                                <!-- Nota -->
                                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                                        Esta configuraci√≥n es obligatoria para el acceso al sistema
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const contenedorModal = document.createElement('div');
                    contenedorModal.innerHTML = modalHTML;
                    document.body.appendChild(contenedorModal);
                    
                    const btnConfigurar = document.getElementById('btnConfigurarAhora');
                    
                    btnConfigurar.addEventListener('click', async () => {
                        document.body.removeChild(contenedorModal);
                        
                        // Mostrar modal de configuraci√≥n de PIN
                        const configurado = await this.mostrarModalConfiguracionPIN(usuarioId, email);
                        
                        if (configurado) {
                            showToast('‚úÖ PIN configurado correctamente. ¬°Bienvenido!', 'success');
                            resolve(true);
                        } else {
                            // Si cancela la configuraci√≥n, mostrar nuevamente el modal obligatorio
                            showToast('‚ö†Ô∏è Debes configurar el PIN para continuar', 'warning');
                            const reintento = await this.mostrarModalConfiguracionObligatoria(usuarioId, email, nombreUsuario);
                            resolve(reintento);
                        }
                    });
                    
                    // No permitir cerrar el modal haciendo clic fuera
                    contenedorModal.addEventListener('click', (e) => {
                        if (e.target === contenedorModal) {
                            showToast('‚ö†Ô∏è Debes configurar el PIN para continuar', 'warning');
                        }
                    });
                });
            }

            async configurarPIRespaldo(usuarioId, pin) {
            try {
                console.log('üîê Configurando PIN seguro para usuario:', usuarioId);
                
                // Validaciones...
                const pinHasheado = await this.hashearPINSeguro(pin, usuarioId);

                // ‚úÖ OBTENER FECHA SIMPLIFICADA
                const tiempoPeru = getPeruTime();
                
                console.log('üáµüá™ FECHA UNIFICADA:');
                console.log('   - ISO String:', tiempoPeru.isoString);
                console.log('   - Legible:', tiempoPeru.readable);

                // ‚úÖ USAR isoString PARA TODOS LOS CAMPOS
                const fechaUnificada = tiempoPeru.isoString;
                
                const updateData = {
                    codigo_pin: pinHasheado,
                    fecha_creacion_pin: fechaUnificada,    // ‚úÖ MISMA FECHA
                    ultimo_pin_usado: fechaUnificada,      // ‚úÖ MISMA FECHA
                    intentos_pin: 0,
                    bloqueado_hasta: null,
                    fecha_actualizacion: fechaUnificada    // ‚úÖ MISMA FECHA
                };

                console.log('üì§ ENVIANDO A SUPABASE:');
                console.log('   - fecha_creacion_pin:', updateData.fecha_creacion_pin);
                console.log('   - ultimo_pin_usado:', updateData.ultimo_pin_usado);
                console.log('   - fecha_actualizacion:', updateData.fecha_actualizacion);

                const { data, error } = await supabase
                    .from('usuario')
                    .update(updateData)
                    .eq('id', usuarioId)
                    .select();

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    throw error;
                }

                console.log('‚úÖ PIN configurado con fecha unificada');
                
                // Verificaci√≥n
                await this.verificarFechaActualizacion(usuarioId);
                
                return true;

            } catch (error) {
                console.error('‚ùå Error configurando PIN:', error);
                throw error;
            }
        }

            async configurarPINdd(usuarioId, pin) {
                try {
                    console.log('üîê Configurando PIN - TODAS LAS FECHAS EN HORA PER√ö...');
                    
                    const pinHasheado = await this.hashearPINSeguro(pin, usuarioId);

                    // ‚úÖ OBTENER FECHA PER√ö CON -05:00
                    const tiempoPeru = getPeruTime();
                    
                    console.log('üéØ FECHA PER√ö PARA TODOS LOS CAMPOS:');
                    console.log('   - ISO con -05:00:', tiempoPeru.isoString);
                    console.log('   - Hora Per√∫:', tiempoPeru.hora);
                    console.log('   - ¬øTermina con -05:00?:', tiempoPeru.isoString.endsWith('-05:00'));

                    // ‚úÖ USAR LA MISMA FECHA PER√ö PARA TODOS
                    const fechaPeruUnificada = tiempoPeru.isoString;
                    
                    const updateData = {
                        codigo_pin: pinHasheado,
                        fecha_creacion_pin: fechaPeruUnificada,     // ‚úÖ HORA PER√ö
                        ultimo_pin_usado: fechaPeruUnificada,       // ‚úÖ HORA PER√ö
                        intentos_pin: 0,
                        bloqueado_hasta: null,
                        fecha_actualizacion: fechaPeruUnificada     // ‚úÖ HORA PER√ö
                    };

                    console.log('üì§ ENVIANDO A SUPABASE:');
                    console.log('   - Todos los campos con:', fechaPeruUnificada);

                    const { data, error } = await supabase
                        .from('usuario')
                        .update(updateData)
                        .eq('id', usuarioId)
                        .select();

                    if (error) throw error;

                    console.log('‚úÖ PIN configurado - TODAS las fechas en hora Per√∫');
                    
                    // Verificaci√≥n
                    await this.verificarFechasPeru(usuarioId);
                    
                    return true;

                } catch (error) {
                    console.error('‚ùå Error configurando PIN:', error);
                    throw error;
                }
            }

            async configurarPIN(usuarioId, pin) {
                try {
                    console.log('üîê Configurando PIN (m√©todo simple que funciona)...');
                    
                    const pinHasheado = await this.hashearPINSeguro(pin, usuarioId);

                    // ‚úÖ FECHA SIMPLE - PostgreSQL la convertir√° autom√°ticamente
                    const fechaSimple = new Date().toISOString();
                    
                    console.log('üìÖ Usando fecha simple:', fechaSimple);

                    const { data, error } = await supabase
                        .from('usuario')
                        .update({
                            codigo_pin: pinHasheado,
                            fecha_creacion_pin: fechaSimple,
                            ultimo_pin_usado: fechaSimple,
                            intentos_pin: 0,
                            bloqueado_hasta: null,
                            fecha_actualizacion: fechaSimple
                        })
                        .eq('id', usuarioId)
                        .select();

                    if (error) throw error;

                    console.log('‚úÖ PIN configurado con m√©todo simple');
                    
                    // Verificaci√≥n simple
                    await this.verificacionSimple(usuarioId);
                    
                    return true;

                } catch (error) {
                    console.error('‚ùå Error:', error);
                    throw error;
                }
            }

            async verificarFechasPeru(usuarioId) {
                try {
                    console.log('üîç VERIFICANDO FECHAS EN HORA PER√ö...');
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('fecha_actualizacion, fecha_creacion_pin, ultimo_pin_usado')
                        .eq('id', usuarioId)
                        .single();

                    if (error) {
                        console.error('‚ùå Error verificando:', error);
                        return;
                    }

                    console.log('üìä FECHAS EN BASE DE DATOS:');
                    
                    // Funci√≥n para mostrar en hora Per√∫
                    const mostrarHoraPeru = (fechaISO) => {
                        if (!fechaISO) return 'NULO';
                        const fecha = new Date(fechaISO);
                        return fecha.toLocaleString('es-PE', { 
                            timeZone: 'America/Lima',
                            hour12: false,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    };

                    console.log('   - fecha_creacion_pin:', mostrarHoraPeru(usuario.fecha_creacion_pin));
                    console.log('   - fecha_actualizacion:', mostrarHoraPeru(usuario.fecha_actualizacion));
                    console.log('   - ultimo_pin_usado:', mostrarHoraPeru(usuario.ultimo_pin_usado));

                    // Verificar si tienen la MISMA hora Per√∫
                    const horaCreacion = mostrarHoraPeru(usuario.fecha_creacion_pin);
                    const horaActualizacion = mostrarHoraPeru(usuario.fecha_actualizacion);
                    const horaPinUsado = mostrarHoraPeru(usuario.ultimo_pin_usado);
                    
                    const sonIguales = horaCreacion === horaActualizacion && 
                                    horaActualizacion === horaPinUsado;
                    
                    console.log('‚úÖ ¬øTodas tienen la MISMA hora Per√∫?:', sonIguales);
                    
                    if (!sonIguales) {
                        console.error('‚ùå ERROR: Las horas Per√∫ no coinciden');
                        console.log('   - Diferencia detectada en PostgreSQL');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en verificaci√≥n:', error);
                }
            }
        
            async verificacionSimple(usuarioId) {
                try {
                    console.log('üîç VERIFICACI√ìN SIMPLE...');
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('fecha_actualizacion, fecha_creacion_pin, ultimo_pin_usado')
                        .eq('id', usuarioId)
                        .single();

                    if (error) {
                        console.error('‚ùå Error verificando:', error);
                        return;
                    }

                    console.log('üìä FECHAS EN BD (valores crudos):');
                    console.log('   - fecha_creacion_pin:', usuario.fecha_creacion_pin);
                    console.log('   - fecha_actualizacion:', usuario.fecha_actualizacion);
                    console.log('   - ultimo_pin_usado:', usuario.ultimo_pin_usado);

                    // Verificar si son iguales
                    const iguales = usuario.fecha_creacion_pin === usuario.fecha_actualizacion && 
                                usuario.fecha_actualizacion === usuario.ultimo_pin_usado;
                    
                    console.log('‚úÖ ¬øValores iguales?:', iguales);
                    
                    if (iguales) {
                        console.log('üéâ ¬°√âXITO! Todas las fechas son iguales');
                    } else {
                        console.log('‚ö†Ô∏è Las fechas no son iguales, pero el PIN se configur√≥');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en verificaci√≥n:', error);
                }
            }

            async verificarFechaActualizacion(usuarioId) {
                try {
                    console.log('üîç VERIFICACI√ìN MEJORADA...');
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('fecha_actualizacion, fecha_creacion_pin, ultimo_pin_usado')
                        .eq('id', usuarioId)
                        .single();

                    if (error) {
                        console.error('‚ùå Error verificando:', error);
                        return;
                    }

                    console.log('üìä FECHAS GUARDADAS EN BD:');
                    
                    // Convertir a hora legible Per√∫
                    const formatHora = (fechaISO) => {
                        if (!fechaISO) return 'NULO';
                        const fecha = new Date(fechaISO);
                        return fecha.toLocaleString('es-PE', { 
                            timeZone: 'America/Lima',
                            hour12: false 
                        });
                    };

                    console.log('   - fecha_creacion_pin:', formatHora(usuario.fecha_creacion_pin));
                    console.log('   - fecha_actualizacion:', formatHora(usuario.fecha_actualizacion));
                    console.log('   - ultimo_pin_usado:', formatHora(usuario.ultimo_pin_usado));
                    
                    // Verificar si son iguales
                    const iguales = usuario.fecha_creacion_pin === usuario.fecha_actualizacion && 
                                usuario.fecha_actualizacion === usuario.ultimo_pin_usado;
                    
                    console.log('‚úÖ ¬øTodas las fechas son iguales?:', iguales);
                    
                } catch (error) {
                    console.error('‚ùå Error en verificaci√≥n:', error);
                }
            }

            // ===== ALGORITMO DE HASH SEGURO =====

            async hashearPINSeguro(pin, usuarioId) {
                try {
                    // ‚úÖ SALT √öNICO POR USUARIO + SALT GLOBAL
                    const saltUsuario = await this.obtenerSaltUsuario(usuarioId);
                    const datosParaHash = pin + this.SALT_GLOBAL + saltUsuario + usuarioId;
                    
                    // ‚úÖ HASH SHA-256
                    const encoder = new TextEncoder();
                    const data = encoder.encode(datosParaHash);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    console.log(`üîê Hash generado: ${hashHex.substring(0, 16)}... (${hashHex.length} chars)`);
                    return hashHex;
                    
                } catch (error) {
                    console.error('‚ùå Error en hash seguro, usando fallback:', error);
                    return await this.hashearPINSimple(pin, usuarioId);
                }
            }

            async hashearPINSimple(pin, usuarioId) {
                // Fallback para compatibilidad
                let hash = 0;
                const str = pin + this.SALT_GLOBAL + usuarioId;
                
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                return Math.abs(hash).toString(16).padStart(16, '0');
            }

            async limpiarPINsDePrueba() {
                try {
                    console.log('üßπ Buscando PINs de prueba para limpiar...');
                    
                    const { data: usuarios, error } = await supabase
                        .from('usuario')
                        .select('id, codigo_pin, correo')
                        .not('codigo_pin', 'is', null);

                    if (error) {
                        console.error('‚ùå Error buscando usuarios con PIN:', error);
                        return;
                    }

                    if (usuarios && usuarios.length > 0) {
                        let limpiados = 0;
                        const tiempoPeru = getPeruTime(); // ‚úÖ OBTENER FECHA PER√ö
                        
                        for (const usuario of usuarios) {
                            // Verificar si es un hash de prueba (solo 'a' repetidas)
                            if (usuario.codigo_pin && /^a+$/.test(usuario.codigo_pin)) {
                                console.log(`üîç Usuario ${usuario.correo} tiene PIN de prueba, limpiando...`);
                                
                                const { error: errorUpdate } = await supabase
                                    .from('usuario')
                                    .update({ 
                                        codigo_pin: null,
                                        fecha_actualizacion: tiempoPeru.isoString // ‚úÖ ACTUALIZAR FECHA
                                    })
                                    .eq('id', usuario.id);

                                if (errorUpdate) {
                                    console.error(`‚ùå Error limpiando PIN para usuario ${usuario.id}:`, errorUpdate);
                                } else {
                                    console.log(`‚úÖ PIN de prueba limpiado para usuario ${usuario.correo}`);
                                    limpiados++;
                                }
                            }
                        }
                        
                        console.log(`üéâ Limpieza completada: ${limpiados} PINs de prueba limpiados`);
                    } else {
                        console.log('‚úÖ No se encontraron usuarios con PIN configurado');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en limpieza de PINs:', error);
                }
            }

            async obtenerSaltUsuario(usuarioId) {
                try {
                    // ‚úÖ SOLO intentar obtener salt para usuarios REALES (no de prueba)
                    if (usuarioId === 'usuario_prueba_temp' || usuarioId.includes('prueba')) {
                        console.log('üîß Usando salt temporal para usuario de prueba');
                        return this.generarSaltDeterministico(usuarioId);
                    }
                    
                    // Verificar si ya existe salt para este usuario
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('salt_pin')
                        .eq('id', usuarioId)
                        .single();

                    if (error) {
                        console.warn('‚ö†Ô∏è No se pudo obtener salt de usuario, usando temporal:', error.message);
                        return this.generarSaltDeterministico(usuarioId);
                    }
                    
                    if (usuario && usuario.salt_pin) {
                        return usuario.salt_pin;
                    }
                    
                    // Crear nuevo salt √∫nico para el usuario
                    const nuevoSalt = this.generarSaltAleatorio(16);
                    const tiempoPeru = getPeruTime(); // ‚úÖ OBTENER FECHA PER√ö
                    
                    // Intentar guardar en la base de datos SOLO si es usuario real
                    const { error: errorUpdate } = await supabase
                        .from('usuario')
                        .update({ 
                            salt_pin: nuevoSalt,
                            fecha_actualizacion: tiempoPeru.isoString // ‚úÖ ACTUALIZAR FECHA
                        })
                        .eq('id', usuarioId);

                    if (errorUpdate) {
                        console.warn('‚ö†Ô∏è No se pudo guardar salt de usuario, usando temporal');
                        return this.generarSaltDeterministico(usuarioId);
                    }
                    
                    console.log('‚úÖ Salt de usuario guardado correctamente con fecha Per√∫');
                    return nuevoSalt;
                    
                } catch (error) {
                    console.error('‚ùå Error obteniendo salt de usuario:', error);
                    return this.generarSaltDeterministico(usuarioId);
                }
            }

            generarSaltDeterministico(usuarioId) {
                // Fallback: salt basado en usuarioId
                let hash = 0;
                const str = usuarioId + this.SALT_GLOBAL;
                
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                return 'salt_' + Math.abs(hash).toString(36);
            }

            // ===== M√âTODOS DE VALIDACI√ìN Y SEGURIDAD =====

            validarFormatoPIN(pin) {
                return typeof pin === 'string' && /^\d{6}$/.test(pin);
            }

            esPINDebil(pin) {
                const patronesDebiles = [
                    '000000', '111111', '222222', '333333', '444444',
                    '555555', '666666', '777777', '888888', '999999',
                    '123456', '654321', '121212', '112233', '111222',
                    '999999', '000001', '100000', '111123', '123123'
                ];

                if (patronesDebiles.includes(pin)) return true;
                if (new Set(pin.split('')).size === 1) return true;
                if (pin === pin.split('').reverse().join('')) return true;

                const esSecuencia = (str, ascending = true) => {
                    for (let i = 1; i < str.length; i++) {
                        const current = parseInt(str[i]);
                        const previous = parseInt(str[i - 1]);
                        if (ascending ? current !== previous + 1 : current !== previous - 1) {
                            return false;
                        }
                    }
                    return true;
                };

                return esSecuencia(pin, true) || esSecuencia(pin, false);
            }

            // ===== GESTI√ìN DE INTENTOS Y BLOQUEOS =====

            async actualizarIntentosFallidos(usuarioId, nuevosIntentos) {
                try {
                    // ‚úÖ OBTENER FECHA ACTUAL CON HORA DE PER√ö
                    const tiempoPeru = getPeruTime();
                    
                    let actualizaciones = { 
                        intentos_pin: nuevosIntentos,
                        fecha_actualizacion: tiempoPeru.isoString // ‚úÖ FECHA PER√ö
                    };

                    if (nuevosIntentos >= this.MAXIMO_INTENTOS) {
                        // Calcular bloqueo hasta (15 minutos desde ahora en hora Per√∫)
                        const bloqueoHasta = new Date(tiempoPeru.timestamp.getTime() + this.TIEMPO_BLOQUEO);
                        actualizaciones.bloqueado_hasta = bloqueoHasta.toISOString();
                        
                        console.log('üîí Usuario bloqueado hasta:', bloqueoHasta.toISOString());
                    }

                    const { error } = await supabase
                        .from('usuario')
                        .update(actualizaciones)
                        .eq('id', usuarioId);

                    if (error) throw error;

                    console.log('üìù Intentos fallidos actualizados con fecha Per√∫:', tiempoPeru.readable);

                } catch (error) {
                    console.error('‚ùå Error en actualizarIntentosFallidos:', error);
                    throw error;
                }
            }

            async reiniciarIntentosPIN(usuarioId) {
                try {
                    // ‚úÖ OBTENER FECHA ACTUAL CON HORA DE PER√ö
                    const tiempoPeru = getPeruTime();
                    
                    const { error } = await supabase
                        .from('usuario')
                        .update({
                            intentos_pin: 0,
                            bloqueado_hasta: null,
                            ultimo_pin_usado: tiempoPeru.isoString,
                            fecha_actualizacion: tiempoPeru.isoString // ‚úÖ FECHA PER√ö
                        })
                        .eq('id', usuarioId);

                    if (error) {
                        console.error('Error reseteando intentos PIN:', error);
                        throw error;
                    }

                    console.log('‚úÖ Intentos PIN reiniciados con fecha Per√∫:', tiempoPeru.readable);
                    
                } catch (error) {
                    console.error('‚ùå Error en reiniciarIntentosPIN:', error);
                    throw error;
                }
            }

            // ===== VERIFICACI√ìN DE COMPATIBILIDAD =====
            async verificarCompatibilidadColumna() {
                try {
                    console.log('üõ°Ô∏è Usando m√©todo alternativo seguro...');
                    
                    // Primero verificar si existe alg√∫n usuario
                    const { data: usuarios, error: errorConsulta } = await supabase
                        .from('usuario')
                        .select('id, codigo_pin')
                        .limit(1);

                    if (errorConsulta || !usuarios || usuarios.length === 0) {
                        console.warn('‚ö†Ô∏è No hay usuarios para verificar compatibilidad');
                        return true;
                    }

                    const usuarioId = usuarios[0].id;
                    const pinOriginal = usuarios[0].codigo_pin;
                    const tiempoPeru = getPeruTime(); // ‚úÖ OBTENER FECHA PER√ö
                    
                    // Crear un hash de prueba real
                    const pinPrueba = '123456';
                    const hashPrueba = await this.hashearPINSeguro(pinPrueba, 'usuario_prueba');
                    
                    console.log(`üìè Longitud del hash de prueba: ${hashPrueba.length} caracteres`);
                    
                    if (hashPrueba.length === 64) {
                        console.log('‚úÖ Hash SHA-256 genera 64 caracteres - sistema compatible');
                        
                        // ‚úÖ RESTAURAR EL PIN ORIGINAL CON FECHA ACTUALIZADA
                        if (pinOriginal !== null) {
                            const { error: errorRestore } = await supabase
                                .from('usuario')
                                .update({ 
                                    codigo_pin: pinOriginal,
                                    fecha_actualizacion: tiempoPeru.isoString // ‚úÖ ACTUALIZAR FECHA
                                })
                                .eq('id', usuarioId);
                                
                            if (errorRestore) {
                                console.error('‚ùå Error restaurando PIN original:', errorRestore);
                            }
                        }
                        
                        return true;
                    } else {
                        console.warn(`‚ö†Ô∏è Hash genera ${hashPrueba.length} caracteres (esperado: 64)`);
                        return true;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en m√©todo alternativo:', error);
                    return true;
                }
            }

            // ===== AUDITOR√çA Y REGISTRO =====

            async registrarEventoPIN(usuarioId, tipoEvento, descripcion) {
                try {
                    const tiempoPeru = getPeruTime();
                    
                    const evento = {
                        usuario_id: usuarioId,
                        tipo_evento: tipoEvento,
                        descripcion: descripcion,
                        fecha_evento: tiempoPeru.isoString,
                        ip_address: await this.obtenerIP(),
                        user_agent: navigator.userAgent,
                        metadata: {
                            timestamp: new Date().getTime(),
                            userAgent: navigator.userAgent,
                            url: window.location.href
                        }
                    };

                    console.log('üìù Intentando registrar evento de auditor√≠a:', tipoEvento);

                    const { error } = await supabase
                        .from('auditoria_seguridad')
                        .insert(evento);

                    if (error) {
                        console.warn('‚ö†Ô∏è No se pudo registrar en auditoria_seguridad:', error);
                        
                        // ‚úÖ INTENTAR CON TABLA ALTERNATIVA
                        await this.registrarEventoFallback(usuarioId, tipoEvento, descripcion, error);
                        return;
                    }

                    console.log('‚úÖ Evento de auditor√≠a registrado correctamente');

                } catch (error) {
                    console.warn('‚ùå Error en registro de auditor√≠a:', error);
                    this.guardarEventoLocal({
                        usuario_id: usuarioId,
                        tipo_evento: tipoEvento,
                        descripcion: descripcion,
                        fecha_evento: new Date().toISOString(),
                        error: error.message
                    });
                }
            }

            async registrarEventoFallback(usuarioId, tipoEvento, descripcion, errorOriginal) {
                try {
                    console.log('üîÑ Intentando m√©todo alternativo de auditor√≠a...');
                    
                    const tiempoPeru = getPeruTime();
                    
                    // ‚úÖ OPCI√ìN 1: Intentar con tabla "logs" o "eventos"
                    const tablasAlternativas = ['logs', 'eventos', 'registro_auditoria', 'security_logs'];
                    
                    for (const tabla of tablasAlternativas) {
                        try {
                            const eventoSimplificado = {
                                usuario_id: usuarioId,
                                accion: tipoEvento,
                                descripcion: `${tipoEvento}: ${descripcion}`,
                                fecha: tiempoPeru.isoString,
                                detalles: JSON.stringify({
                                    userAgent: navigator.userAgent,
                                    errorOriginal: errorOriginal?.message
                                })
                            };

                            const { error } = await supabase
                                .from(tabla)
                                .insert(eventoSimplificado);

                            if (!error) {
                                console.log(`‚úÖ Evento registrado en tabla alternativa: ${tabla}`);
                                return;
                            }
                        } catch (e) {
                            console.log(`‚ùå Tabla ${tabla} no disponible:`, e.message);
                        }
                    }
                    
                    // ‚úÖ OPCI√ìN 2: Registrar en la tabla usuario como metadata
                    await this.registrarEnUsuario(usuarioId, tipoEvento, descripcion, tiempoPeru);
                    
                } catch (error) {
                    console.warn('‚ùå Todos los m√©todos de auditor√≠a fallaron:', error);
                    this.guardarEventoLocal({
                        usuario_id: usuarioId,
                        tipo_evento: tipoEvento,
                        descripcion: descripcion,
                        fecha_evento: new Date().toISOString()
                    });
                }
            }

            async registrarEnUsuario(usuarioId, tipoEvento, descripcion, tiempoPeru) {
                try {
                    // Obtener los eventos actuales del usuario
                    const { data: usuario, error } = await supabase
                        .from('usuario')
                        .select('eventos_auditoria, metadata')
                        .eq('id', usuarioId)
                        .single();

                    if (error) throw error;

                    const nuevoEvento = {
                        tipo: tipoEvento,
                        descripcion: descripcion,
                        fecha: tiempoPeru.isoString,
                        timestamp: Date.now()
                    };

                    let eventosActualizados = [];
                    let metadataActualizada = usuario.metadata || {};

                    if (usuario.eventos_auditoria && Array.isArray(usuario.eventos_auditoria)) {
                        eventosActualizados = [...usuario.eventos_auditoria, nuevoEvento];
                    } else {
                        eventosActualizados = [nuevoEvento];
                    }

                    if (!metadataActualizada.auditoria) {
                        metadataActualizada.auditoria = [];
                    }
                    metadataActualizada.auditoria.push(nuevoEvento);

                    // Limitar a los √∫ltimos 50 eventos
                    if (eventosActualizados.length > 50) {
                        eventosActualizados = eventosActualizados.slice(-50);
                    }
                    if (metadataActualizada.auditoria.length > 50) {
                        metadataActualizada.auditoria = metadataActualizada.auditoria.slice(-50);
                    }

                    // ‚úÖ ACTUALIZAR CON FECHA PER√ö
                    const { error: updateError } = await supabase
                        .from('usuario')
                        .update({
                            eventos_auditoria: eventosActualizados,
                            metadata: metadataActualizada,
                            fecha_actualizacion: tiempoPeru.isoString // ‚úÖ FECHA PER√ö
                        })
                        .eq('id', usuarioId);

                    if (updateError) throw updateError;

                    console.log('‚úÖ Evento registrado en metadata del usuario con fecha Per√∫');

                } catch (error) {
                    console.warn('‚ùå No se pudo registrar en usuario:', error);
                    throw error;
                }
            }

            async obtenerIP() {
                try {
                    // Intentar obtener IP de un servicio externo
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip || 'N/A';
                } catch (error) {
                    console.log('‚ö†Ô∏è No se pudo obtener IP:', error);
                    return 'N/A';
                }
            }

            guardarEventoLocal(evento) {
                try {
                    const clave = 'auditoria_pin_fallback';
                    const eventos = JSON.parse(localStorage.getItem(clave) || '[]');
                    
                    const eventoMejorado = {
                        ...evento,
                        id: Date.now() + Math.random(),
                        navegador: navigator.userAgent,
                        url: window.location.href,
                        timestamp_local: new Date().toISOString()
                    };
                    
                    eventos.unshift(eventoMejorado);
                    
                    // Mantener solo los √∫ltimos 100 eventos
                    if (eventos.length > 100) {
                        eventos.splice(100);
                    }
                    
                    localStorage.setItem(clave, JSON.stringify(eventos));
                    console.log('üì± Evento guardado localmente:', eventoMejorado.tipo_evento);
                    
                } catch (error) {
                    console.warn('‚ùå No se pudo guardar evento local:', error);
                }
            }

            async sincronizarEventosPendientes() {
                try {
                    const clave = 'auditoria_pin_fallback';
                    const eventosPendientes = JSON.parse(localStorage.getItem(clave) || '[]');
                    
                    if (eventosPendientes.length === 0) return;
                    
                    console.log(`üîÑ Sincronizando ${eventosPendientes.length} eventos pendientes...`);
                    
                    const eventosExitosos = [];
                    
                    for (const evento of eventosPendientes) {
                        try {
                            await this.registrarEventoPIN(
                                evento.usuario_id, 
                                evento.tipo_evento, 
                                evento.descripcion
                            );
                            eventosExitosos.push(evento.id);
                        } catch (error) {
                            console.log('‚ùå No se pudo sincronizar evento:', evento.id);
                        }
                    }
                    
                    // Remover eventos sincronizados exitosamente
                    if (eventosExitosos.length > 0) {
                        const nuevosEventos = eventosPendientes.filter(
                            evento => !eventosExitosos.includes(evento.id)
                        );
                        localStorage.setItem(clave, JSON.stringify(nuevosEventos));
                        console.log(`‚úÖ ${eventosExitosos.length} eventos sincronizados`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error sincronizando eventos:', error);
                }
            }

            // ===== M√âTODO PRINCIPAL: MOSTRAR MODAL SEGURO =====

            async mostrarModalConfiguracionPIN(usuarioId, usuarioEmail) {
                // Verificar compatibilidad antes de mostrar el modal
                const compatible = await this.verificarCompatibilidadColumna();
                
                if (!compatible) {
                    showToast('‚ùå Error: La base de datos necesita actualizaci√≥n para soportar PINs seguros', 'error');
                    return false;
                }

                return new Promise((resolve) => {
                    console.log('üîê Mostrando modal de PIN seguro para:', usuarioEmail);
                    
                    const modalHTML = `
                        <div class="modal-configurar-pin" style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.8);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            font-family: 'Inter', sans-serif;
                        ">
                            <div style="
                                background: var(--card-bg);
                                padding: 2.5rem 2rem;
                                border-radius: 16px;
                                max-width: 500px;
                                width: 90%;
                                color: var(--text-color);
                                border: 1px solid var(--border-color);
                                box-shadow: var(--shadow-lg);
                            ">
                                <!-- Header con seguridad -->
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <div style="
                                        width: 80px;
                                        height: 80px;
                                        background: linear-gradient(135deg, #28a745, #20c997);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin: 0 auto 1rem;
                                        color: white;
                                        font-size: 2rem;
                                    ">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600;">
                                        Configurar PIN Seguro
                                    </h3>
                                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 0.5rem;">
                                        Crea un PIN de 6 d√≠gitos para accesos r√°pidos y seguros
                                    </p>
                                    <div style="background: rgba(40, 167, 69, 0.1); padding: 0.5rem 1rem; border-radius: 20px; display: inline-block;">
                                        <span style="color: #28a745; font-size: 0.8rem; font-weight: 600;">
                                            <i class="fas fa-lock"></i> Encriptaci√≥n SHA-256
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Formulario -->
                                <div style="margin-bottom: 2rem;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                            <i class="fas fa-lock" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                                            Nuevo PIN (6 d√≠gitos)
                                        </label>
                                        <input 
                                            type="password" 
                                            id="nuevoPINInput" 
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                            maxlength="6"
                                            inputmode="numeric"
                                            pattern="[0-9]*"
                                            style="
                                                width: 100%;
                                                padding: 1rem;
                                                border: 2px solid var(--border-color);
                                                border-radius: 10px;
                                                background: var(--bg-color);
                                                color: var(--text-color);
                                                font-size: 1.5rem;
                                                text-align: center;
                                                letter-spacing: 0.5rem;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                            "
                                        >
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-color);">
                                            <i class="fas fa-redo" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                                            Confirmar PIN
                                        </label>
                                        <input 
                                            type="password" 
                                            id="confirmarPINInput" 
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                            maxlength="6"
                                            inputmode="numeric"
                                            pattern="[0-9]*"
                                            style="
                                                width: 100%;
                                                padding: 1rem;
                                                border: 2px solid var(--border-color);
                                                border-radius: 10px;
                                                background: var(--bg-color);
                                                color: var(--text-color);
                                                font-size: 1.5rem;
                                                text-align: center;
                                                letter-spacing: 0.5rem;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                            "
                                        >
                                    </div>
                                    
                                    <!-- Indicador de seguridad -->
                                    <div id="indicadorSeguridad" style="
                                        padding: 1rem;
                                        border-radius: 10px;
                                        margin-bottom: 1rem;
                                        text-align: center;
                                        font-size: 0.9rem;
                                        font-weight: 500;
                                        display: none;
                                        background: rgba(52, 152, 219, 0.1);
                                        border-left: 4px solid var(--secondary-color);
                                    ">
                                        <i class="fas fa-shield-alt" style="margin-right: 0.5rem; color: var(--secondary-color);"></i>
                                        <span id="textoSeguridad">PIN seguro con encriptaci√≥n activa</span>
                                    </div>
                                </div>
                                
                                <!-- Informaci√≥n de seguridad -->
                                <div style="background: rgba(40, 167, 69, 0.1); padding: 1.25rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #28a745;">
                                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                                        <i class="fas fa-info-circle" style="margin-right: 0.75rem; color: #28a745;"></i>
                                        <strong>Seguridad m√°xima:</strong> Tu PIN se convierte en un hash irreversible de 64 caracteres usando SHA-256
                                    </p>
                                </div>
                                
                                <!-- Botones -->
                                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button id="btnCancelarConfigPIN" style="
                                        padding: 1rem 1.5rem;
                                        border: 2px solid var(--border-color);
                                        background: transparent;
                                        color: var(--text-color);
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        flex: 1;
                                    ">
                                        <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                        Cancelar
                                    </button>
                                    
                                    <button id="btnGuardarPIN" style="
                                        padding: 1rem 1.5rem;
                                        background: #28a745;
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        transition: all 0.3s ease;
                                        flex: 2;
                                        opacity: 0.6;
                                    " disabled>
                                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                                        Guardar PIN Seguro
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const contenedorModal = document.createElement('div');
                    contenedorModal.innerHTML = modalHTML;
                    document.body.appendChild(contenedorModal);
                    
                    const nuevoPINInput = document.getElementById('nuevoPINInput');
                    const confirmarPINInput = document.getElementById('confirmarPINInput');
                    const btnCancelar = document.getElementById('btnCancelarConfigPIN');
                    const btnGuardar = document.getElementById('btnGuardarPIN');
                    const indicadorSeguridad = document.getElementById('indicadorSeguridad');
                    const textoSeguridad = document.getElementById('textoSeguridad');
                    
                    const self = this;
                    
                    const validarPINs = () => {
                        const nuevoPIN = nuevoPINInput.value.replace(/[^0-9]/g, '');
                        const confirmarPIN = confirmarPINInput.value.replace(/[^0-9]/g, '');
                        const pinValido = /^\d{6}$/.test(nuevoPIN);
                        const pinsCoinciden = nuevoPIN === confirmarPIN;
                        const noEsDebil = !self.esPINDebil(nuevoPIN);
                        
                        if (pinValido && pinsCoinciden && noEsDebil) {
                            indicadorSeguridad.style.display = 'block';
                            textoSeguridad.innerHTML = '<i class="fas fa-shield-alt"></i> PIN seguro con encriptaci√≥n SHA-256';
                            btnGuardar.disabled = false;
                            btnGuardar.style.opacity = '1';
                        } else {
                            indicadorSeguridad.style.display = 'none';
                            btnGuardar.disabled = true;
                            btnGuardar.style.opacity = '0.6';
                        }
                    };
                    
                    nuevoPINInput.addEventListener('input', validarPINs);
                    confirmarPINInput.addEventListener('input', validarPINs);
                    nuevoPINInput.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); });
                    confirmarPINInput.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); });
                    
                    btnGuardar.addEventListener('click', async () => {
                        const nuevoPIN = nuevoPINInput.value;
                        try {
                            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Encriptando...';
                            btnGuardar.disabled = true;
                            
                            await self.configurarPIN(usuarioId, nuevoPIN);
                            
                            document.body.removeChild(contenedorModal);
                            showToast('‚úÖ PIN seguro configurado correctamente', 'success');
                            resolve(true);
                        } catch (error) {
                            console.error('‚ùå Error guardando PIN seguro:', error);
                            showToast(`‚ùå Error: ${error.message}`, 'error');
                            btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar PIN Seguro';
                            btnGuardar.disabled = false;
                        }
                    });
                    
                    btnCancelar.addEventListener('click', () => {
                        document.body.removeChild(contenedorModal);
                        resolve(false);
                    });
                    
                    contenedorModal.addEventListener('click', (e) => {
                        if (e.target === contenedorModal) {
                            document.body.removeChild(contenedorModal);
                            resolve(false);
                        }
                    });
                    
                    setTimeout(() => nuevoPINInput.focus(), 100);
                });
            }

            // ===== M√âTODOS ADICIONALES DE UTILIDAD =====

            async verificarEstadoPIN(usuarioId) {
                try {
                    const { data, error } = await supabase
                        .from('usuario')
                        .select('codigo_pin, fecha_creacion_pin, intentos_pin, bloqueado_hasta, ultimo_pin_usado')
                        .eq('id', usuarioId)
                        .single();

                    if (error) throw error;

                    // Convertir fechas a hora Per√∫ para mostrar
                    const crearFechaPeru = (fechaISO) => {
                        if (!fechaISO) return null;
                        return new Date(fechaISO).toLocaleString('es-PE', {
                            timeZone: 'America/Lima',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };

                    return {
                        tienePIN: !!data.codigo_pin,
                        longitudHash: data.codigo_pin ? data.codigo_pin.length : 0,
                        fechaCreacion: crearFechaPeru(data.fecha_creacion_pin),
                        fechaCreacionISO: data.fecha_creacion_pin,
                        ultimoUso: crearFechaPeru(data.ultimo_pin_usado),
                        ultimoUsoISO: data.ultimo_pin_usado,
                        intentosFallidos: data.intentos_pin || 0,
                        bloqueado: data.bloqueado_hasta && new Date(data.bloqueado_hasta) > new Date(),
                        tiempoDesbloqueo: data.bloqueado_hasta ? crearFechaPeru(data.bloqueado_hasta) : null,
                        tiempoDesbloqueoISO: data.bloqueado_hasta
                    };

                } catch (error) {
                    console.error('Error verificando estado PIN:', error);
                    throw error;
                }
            }

            async desbloquearCuenta(usuarioId) {
                try {
                    const tiempoPeru = getPeruTime(); // ‚úÖ OBTENER FECHA PER√ö
                    
                    const { error } = await supabase
                        .from('usuario')
                        .update({
                            intentos_pin: 0,
                            bloqueado_hasta: null,
                            fecha_actualizacion: tiempoPeru.isoString // ‚úÖ ACTUALIZAR FECHA
                        })
                        .eq('id', usuarioId);

                    if (error) throw error;

                    await this.registrarEventoPIN(usuarioId, 'desbloqueo_cuenta', 'Cuenta desbloqueada manualmente');
                    console.log('‚úÖ Cuenta desbloqueada con fecha Per√∫:', tiempoPeru.readable);
                    return true;

                } catch (error) {
                    console.error('Error desbloqueando cuenta:', error);
                    throw error;
                }
            }
            
            // ‚úÖ FUNCI√ìN GEN√âRICA PARA ACTUALIZAR CUALQUIER CAMPO CON FECHA PER√ö
            async actualizarUsuarioConFechaPeru(usuarioId, actualizaciones) {
                try {
                    const tiempoPeru = getPeruTime();
                    
                    const actualizacionesCompletas = {
                        ...actualizaciones,
                        fecha_actualizacion: tiempoPeru.isoString // ‚úÖ SIEMPRE AGREGAR FECHA PER√ö
                    };

                    console.log('üìù Actualizando usuario con fecha Per√∫:', {
                        usuarioId,
                        actualizaciones: Object.keys(actualizaciones),
                        fecha: tiempoPeru.readable
                    });

                    const { error } = await supabase
                        .from('usuario')
                        .update(actualizacionesCompletas)
                        .eq('id', usuarioId);

                    if (error) throw error;

                    console.log('‚úÖ Usuario actualizado con fecha Per√∫:', tiempoPeru.readable);
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå Error actualizando usuario:', error);
                    throw error;
                }
            }

        }

        // Agregar esta funci√≥n despu√©s de la clase GestionPIN
        function showUserProfile(user, sistemas) {
            const userName = user.user_metadata?.full_name || user.email.split('@')[0] || 'Usuario';
            const avatarText = userName.charAt(0).toUpperCase();
            const avatarColor = getAvatarColor(avatarText);
            
            return `
                <div class="user-profile-section" style="
                    background: var(--card-bg);
                    border-radius: var(--border-radius-lg);
                    padding: 2rem;
                    border: 1px solid var(--border-color);
                    box-shadow: var(--shadow-md);
                    margin-bottom: 1.5rem;
                ">
                    <!-- Header del Perfil -->
                    <div class="profile-header" style="
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin-bottom: 2rem;
                        padding-bottom: 1.5rem;
                        border-bottom: 1px solid var(--border-color);
                    ">
                        <div class="user-avatar-large" style="
                            width: 80px;
                            height: 80px;
                            border-radius: 50%;
                            background: ${avatarColor};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 2rem;
                            font-weight: bold;
                            border: 3px solid var(--primary-color);
                        ">
                            ${avatarText}
                        </div>
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600;">
                                ${userName}
                            </h3>
                            <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem;">
                                ${user.email}
                            </p>
                            <div style="margin-top: 0.5rem;">
                                <span class="status-badge" style="
                                    background: var(--success-color);
                                    color: white;
                                    padding: 0.25rem 0.75rem;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    font-weight: 500;
                                ">
                                    <i class="fas fa-check-circle"></i> Sesi√≥n activa
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acciones del Perfil -->
                    <div class="profile-actions" style="display: grid; gap: 1rem;">
                        <button class="profile-btn" id="btnCambiarPIN" style="
                            background: var(--card-bg);
                            border: 2px solid var(--border-color);
                            border-radius: var(--border-radius);
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: left;
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        " onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)';" 
                        onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)';">
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: var(--primary-color);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.2rem;
                            ">
                                <i class="fas fa-key"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                                    Cambiar PIN
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Actualizar c√≥digo de acceso seguro
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                        </button>
                        
                        <button class="profile-btn" id="btnInfoSistemas" style="
                            background: var(--card-bg);
                            border: 2px solid var(--border-color);
                            border-radius: var(--border-radius);
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: left;
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        " onmouseover="this.style.borderColor='var(--secondary-color)'; this.style.transform='translateY(-2px)';" 
                        onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)';">
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: var(--primary-color);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.2rem;
                            ">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                                    Sistemas Accesibles
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    ${sistemas.length} sistema(s) disponible(s)
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                        </button>
                        
                        <button class="profile-btn" id="btnCerrarSesion" style="
                            background: var(--card-bg);
                            border: 2px solid var(--danger-color);
                            border-radius: var(--border-radius);
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: var(--transition);
                            text-align: left;
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            margin-top: 1rem;
                        " onmouseover="this.style.background='var(--danger-color)'; this.style.color='white'; this.style.transform='translateY(-2px)';" 
                        onmouseout="this.style.background='var(--card-bg)'; this.style.color='var(--text-color)'; this.style.transform='translateY(0)';">
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: var(--danger-color);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.2rem;
                            ">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    Cerrar Sesi√≥n
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            `;
        }

        // Inicializar sistema PIN
        const AdaptadorEstructura = new SistemaAdaptadorEstructura();
        const AutenticacionPIN = new SistemaAutenticacionPIN();
        const GestionPIN = new SistemaGestionPIN();

        // SISTEMA DE CACH√â AVANZADO
        class CacheManager {
            constructor() {
                this.cache = new Map();
                this.defaultTTL = 10 * 60 * 1000; // 10 minutos
            }

            set(key, data, ttl = this.defaultTTL) {
                this.cache.set(key, {
                    data,
                    expiry: Date.now() + ttl,
                    timestamp: new Date().toISOString(),
                    accessCount: 0
                });
            }

            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;

                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    console.log('üóëÔ∏è [CACHE] Expired:', key);
                    return null;
                }

                item.accessCount++;
                console.log('üì¶ [CACHE] Hit:', key);
                return item.data;
            }

            delete(key) {
                this.cache.delete(key);
            }

            clearByPattern(pattern) {
                for (const key of this.cache.keys()) {
                    if (key.includes(pattern)) {
                        this.cache.delete(key);
                    }
                }
            }

            clearExpired() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now > item.expiry) {
                        this.cache.delete(key);
                        console.log('üóëÔ∏è [CACHE] Auto-cleared expired:', key);
                    }
                }
            }
        }

        const AppCache = new CacheManager();

        // SISTEMA DE SESIONES OFFLINE
        class SessionManager {
            constructor() {
                this.SESSION_KEY = 'gm_user_session';
                this.SESSION_DURATION = 30 * 60 * 1000; // 30 minutos
            }

            getValidSession() {
                try {
                    const sessionData = localStorage.getItem(this.SESSION_KEY);
                    if (!sessionData) return null;

                    const session = JSON.parse(sessionData);
                    const now = Date.now();
                    
                    if (now - session.lastActivity > this.SESSION_DURATION) {
                        this.clearSession();
                        return null;
                    }

                    session.lastActivity = now;
                    this.saveSession(session);
                    
                    return session;
                    
                } catch (error) {
                    this.clearSession();
                    return null;
                }
            }

            saveSession(sessionData) {
                const enhancedSession = {
                    ...sessionData,
                    lastActivity: Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(enhancedSession));
            }

            clearSession() {
                localStorage.removeItem(this.SESSION_KEY);
                AppCache.clearByPattern('userSystems_');
            }

            async saveEssentialSessionData(user, systemData) {
                try {
                    const tiempoPeru = getPeruTime();
                    
                    console.log('üïê Actualizando sesi√≥n con fecha Per√∫:', tiempoPeru.readable);

                    // ‚úÖ ACTUALIZAR CON FECHA PER√ö
                    const { error } = await supabase
                        .from('usuario')
                        .update({
                            fecha_ultimo_acceso: tiempoPeru.isoString,
                            fecha_actualizacion: tiempoPeru.isoString // ‚úÖ FECHA PER√ö
                        })
                        .eq('correo', user.email);

                    if (error) throw error;
                    
                    console.log('üìù [SESION] Datos esenciales guardados en Supabase con fecha Per√∫');
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è [SESION] No se pudo guardar en Supabase, continuando offline');
                }
            }
      
        }

        const AppSession = new SessionManager();

        // ===== CONFIGURACI√ìN Y ESTADO DE LA APLICACI√ìN =====
        const AppState = {
            isLoading: false,
            userData: null,
            sessionTimer: null,
            activityDebounce: null,
            supabaseLoaded: false,
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // ===== SISTEMA CENTRALIZADO DE MANEJO DE ERRORES =====
        class ErrorHandler {
            static handle(error, context = 'Sistema', userFriendlyMessage = null) {
                console.error(`‚ùå [${context}] Error:`, error);
                
                const errorInfo = this.classifyError(error, context);
                
                // üî• NUEVO: Manejo espec√≠fico para errores de autenticaci√≥n
                if (context.includes('auth') || context.includes('login')) {
                    this.handleAuthErrorSpecifically(error, errorInfo);
                } else {
                    this.showUserError(errorInfo.userMessage || userFriendlyMessage, errorInfo.type);
                }
                
                this.logError(error, context, errorInfo);
                this.attemptRecovery(error, context);
                
                return errorInfo;
            }
            
            static classifyError(error, context) {
                if (error.message?.includes('Network') || error.message?.includes('fetch')) {
                    return {
                        type: 'network',
                        userMessage: 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.',
                        canRetry: true
                    };
                }
                
                if (error.message?.includes('Auth') || error.message?.includes('authentication')) {
                    return this.handleAuthError(error, context);
                }
                
                if (error.message?.includes('user') || error.message?.includes('User')) {
                    return this.handleUserError(error, context);
                }
                
                return {
                    type: 'unknown',
                    userMessage: 'Ocurri√≥ un error inesperado. Por favor, intenta nuevamente.',
                    canRetry: true
                };
            }
            
            static handleAuthError(error, context) {
                const authErrors = {
                    'Invalid login credentials': {
                        type: 'auth',
                        userMessage: 'Credenciales inv√°lidas. Verifica tu correo electr√≥nico.',
                        canRetry: true
                    },
                    'Email not confirmed': {
                        type: 'auth',
                        userMessage: 'Correo electr√≥nico no confirmado.',
                        canRetry: false
                    },
                    'User already registered': {
                        type: 'auth',
                        userMessage: 'Usuario ya registrado.',
                        canRetry: true
                    }
                };
                
                for (const [key, value] of Object.entries(authErrors)) {
                    if (error.message.includes(key)) {
                        return value;
                    }
                }
                
                return {
                    type: 'auth',
                    userMessage: `Error de autenticaci√≥n: ${error.message}`,
                    canRetry: true
                };
            }
            
            static handleAuthErrorSpecifically(error, errorInfo) {
                // Errores espec√≠ficos de Supabase Auth
                if (error.message?.includes('Invalid token')) {
                    showToast('üîê Sesi√≥n inv√°lida. Por favor, inicia sesi√≥n nuevamente.', 'error');
                } else if (error.message?.includes('Auth session missing')) {
                    showToast('üîê Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
                } else if (error.message?.includes('Email link is invalid or has expired')) {
                    showToast('üîê El link ha expirado. Solicita uno nuevo.', 'error');
                } else {
                    this.showUserError(errorInfo.userMessage, errorInfo.type);
                }
            }

            static handleUserError(error, context) {
                return {
                    type: 'user',
                    userMessage: 'Error al acceder a los datos del usuario. Intenta nuevamente.',
                    canRetry: true
                };
            }
            
            static showUserError(message, type = 'error') {
                showToast(message, type);
            }
            
            static logError(error, context, errorInfo) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    context: context,
                    error: error.message || error,
                    type: errorInfo.type,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                console.group(`üö® Error en ${context}`);
                console.table(logEntry);
                console.groupEnd();
            }
            
            static attemptRecovery(error, context) {
                switch (error.type) {
                    case 'network':
                        setTimeout(() => {
                            if (context === 'Supabase Init') {
                                initializeSupabase();
                            }
                        }, 5000);
                        break;
                }
            }
        }

        // ===== SISTEMA SIMPLIFICADO DE REDIRECCI√ìN =====
        class RedirectSystem {
            static init() {
                this.selectedSystem = null;
            }
            
            static selectSystem(systemData, event) {
                try {
                    console.log('üéØ [SYSTEM] Seleccionando sistema:', systemData);
                    
                    if (!this.validateSystemData(systemData)) {
                        throw new Error('Datos del sistema inv√°lidos');
                    }
                    
                    let selectedCard = this.findSystemCard(systemData.key, event);
                    
                    this.clearPreviousSelection();
                    
                    if (selectedCard && selectedCard.classList) {
                        this.updateUISelection(selectedCard);
                    }
                    
                    this.selectedSystem = systemData;
                    this.showSystemInfo(systemData);
                    
                    // ‚úÖ REDIRECCI√ìN INMEDIATA - Sin countdown
                    this.executeRedirect(systemData);
                    
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå [SYSTEM] Error seleccionando sistema:', error);
                    ErrorHandler.handle(error, 'System Selection', 'Error al seleccionar el sistema');
                    return false;
                }
            }

            static validateSystemData(system) {
                const requiredFields = ['key', 'name', 'rol'];
                const missingFields = requiredFields.filter(field => !system[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`Campos requeridos faltantes: ${missingFields.join(', ')}`);
                }
                
                if (!SystemPages[system.key]) {
                    throw new Error(`Sistema no configurado: ${system.key}`);
                }
                
                if (!SystemPages[system.key][system.rol]) {
                    throw new Error(`Rol '${system.rol}' no configurado para sistema '${system.key}'`);
                }
                
                return true;
            }

            static findSystemCard(systemKey, event) {
                console.log('üîç [FIND] Buscando tarjeta para:', systemKey);
                
                if (event && event.currentTarget) {
                    console.log('üìç [FIND] Desde event.currentTarget');
                    return event.currentTarget;
                }
                
                if (event && event.target) {
                    const fromTarget = event.target.closest('.system-card');
                    if (fromTarget) {
                        console.log('üìç [FIND] Desde event.target.closest');
                        return fromTarget;
                    }
                }
                
                const fromAttribute = document.querySelector(`[data-system="${systemKey}"]`);
                if (fromAttribute) {
                    console.log('üìç [FIND] Desde data-system attribute');
                    return fromAttribute;
                }
                
                const allCards = document.querySelectorAll('.system-card');
                for (const card of allCards) {
                    if (card.textContent.includes(systemKey.replace('sistema', ''))) {
                        console.log('üìç [FIND] Desde contenido de texto');
                        return card;
                    }
                }
                
                console.log('‚ùå [FIND] No se encontr√≥ tarjeta con ninguna estrategia');
                return null;
            }

            static clearPreviousSelection() {
                try {
                    console.log('üßπ [UI] Limpiando selecci√≥n anterior');
                    
                    document.querySelectorAll('.system-card').forEach(card => {
                        if (card.classList) {
                            card.classList.remove('selected');
                            card.style.transform = '';
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå [UI] Error limpiando selecci√≥n:', error);
                }
            }
            
            static updateUISelection(selectedCard) {
                try {
                    console.log('üéØ [UI] Actualizando selecci√≥n de tarjeta:', selectedCard);
                    
                    if (!selectedCard || !selectedCard.classList) {
                        console.error('‚ùå [UI] Tarjeta no v√°lida:', selectedCard);
                        throw new Error('Elemento de tarjeta no v√°lido');
                    }
                    
                    document.querySelectorAll('.system-card').forEach(card => {
                        if (card.classList && card !== selectedCard) {
                            card.classList.remove('selected');
                            card.style.transform = '';
                        }
                    });
                    
                    selectedCard.classList.add('selected');
                    selectedCard.style.transform = 'scale(0.95)';
                    
                    console.log('‚úÖ [UI] Tarjeta seleccionada visualmente');
                    
                    setTimeout(() => {
                        if (selectedCard.style) {
                            selectedCard.style.transform = 'scale(1)';
                        }
                    }, 150);
                    
                } catch (error) {
                    console.error('‚ùå [UI] Error actualizando selecci√≥n:', error);
                    throw error;
                }
            }
            
            static showSystemInfo(system) {
                const selectedSystemInfo = document.getElementById('selectedSystemInfo');
                const systemName = document.getElementById('systemName');
                const selectedSystemText = document.getElementById('selectedSystemText');
                
                if (!selectedSystemInfo || !systemName) return;
                
                systemName.textContent = system.name;
                selectedSystemText.innerHTML = 
                    `Has seleccionado el <strong>${system.name}</strong> con rol <strong>${system.rol}</strong>`;
                
                selectedSystemInfo.style.display = 'block';
                
                // Mostrar toast solo por 1.5 segundos (m√°s breve)
                showToast(`Redirigiendo a ${system.name}...`, 'success');
                
                // Ocultar despu√©s de 1.5 segundos
                setTimeout(() => {
                    selectedSystemInfo.style.display = 'none';
                }, 1500);
            }
            
            static executeRedirect(system) {
                try {
                    console.log('üöÄ Ejecutando redirecci√≥n a sistema...');
                    
                    // ‚úÖ MEJORAR DATOS DE SESI√ìN
                    const sessionData = {
                        userRole: system.rol,
                        userSystem: system.key,
                        userName: system.userData?.nombre || 'Usuario',
                        userEmail: system.userData?.correo,
                        lastLogin: new Date().toISOString(),
                        redirectTimestamp: Date.now(),
                        expiresAt: Date.now() + (8 * 60 * 60 * 1000), // 8 horas
                        sistemaDestino: system.name,
                        timestamp: new Date().toLocaleString('es-PE')
                    };
                    
                    localStorage.setItem('userSession', JSON.stringify(sessionData));
                    
                    console.log('üìç Redirigiendo a:', SystemPages[system.key][system.rol]);
                    
                    // Peque√±o delay para asegurar que se guarde la sesi√≥n
                    setTimeout(() => {
                        window.location.href = SystemPages[system.key][system.rol];
                    }, 100);
                    
                } catch (error) {
                    console.error('‚ùå Error en redirecci√≥n:', error);
                    showToast('Error al redirigir al sistema', 'error');
                }
            }
            
            static saveSessionData(system) {
                try {
                    const sessionData = {
                        userRole: system.rol,
                        userSystem: system.key,
                        userName: system.userData?.nombre || 'Usuario',
                        lastLogin: new Date().toISOString(),
                        lastActivity: new Date().getTime(),
                        redirectTimestamp: Date.now()
                    };
                    
                    localStorage.setItem('userSession', JSON.stringify(sessionData));
                    localStorage.setItem('userRole', system.rol);
                    localStorage.setItem('userSystem', system.key);
                    
                } catch (storageError) {
                    console.warn('No se pudieron guardar datos de sesi√≥n:', storageError);
                }
            }
        }

        function agregarConfiguracionHead() {
            // Estas meta tags ayudan con la autenticaci√≥n
            const metaTags = [
                { name: 'referrer', content: 'strict-origin-when-cross-origin' },
                { name: 'robots', content: 'noindex, nofollow' }
            ];
            
            metaTags.forEach(tag => {
                if (!document.querySelector(`meta[name="${tag.name}"]`)) {
                    const meta = document.createElement('meta');
                    meta.name = tag.name;
                    meta.content = tag.content;
                    document.head.appendChild(meta);
                }
            });
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // üî• NUEVO: MANEJADOR PARA CAMBIOS DE ESTADO DE AUTENTICACI√ìN
        supabase?.auth?.onAuthStateChange((event, session) => {
            console.log('üîÑ Cambio de estado de autenticaci√≥n:', event);
            
            switch (event) {
                case 'SIGNED_IN':
                    console.log('‚úÖ Usuario firm√≥ sesi√≥n:', session?.user?.email);
                    if (session?.user) {
                        procesarUsuarioAutenticado(session.user);
                    }
                    break;
                    
                case 'SIGNED_OUT':
                    console.log('üö™ Usuario cerr√≥ sesi√≥n');
                    showLoginScreen();
                    break;
                    
                case 'TOKEN_REFRESHED':
                    console.log('üîÑ Token refrescado');
                    break;
                    
                case 'USER_UPDATED':
                    console.log('üë§ Usuario actualizado');
                    break;
                    
                default:
                    console.log('üîç Evento de auth no manejado:', event);
            }
        });

        // Inicializar sistema de redirecci√≥n
        RedirectSystem.init();

        // ===== FUNCI√ìN PARA OBTENER HORA DE PER√ö =====
        function getPeruTime() {
            try {
                const ahora = new Date();
                
                // ‚úÖ CONVERSI√ìN DIRECTA A HORA PER√ö
                const fechaPeru = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Lima"}));
                
                // ‚úÖ FORMATO ISO con offset expl√≠cito de Per√∫ (-05:00)
                const year = fechaPeru.getFullYear();
                const month = String(fechaPeru.getMonth() + 1).padStart(2, '0');
                const day = String(fechaPeru.getDate()).padStart(2, '0');
                const hours = String(fechaPeru.getHours()).padStart(2, '0');
                const minutes = String(fechaPeru.getMinutes()).padStart(2, '0');
                const seconds = String(fechaPeru.getSeconds()).padStart(2, '0');
                const milliseconds = String(fechaPeru.getMilliseconds()).padStart(3, '0');
                
                // ‚úÖ FORMATO ISO con -05:00 expl√≠cito
                const isoStringPeru = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.${milliseconds}-05:00`;
                
                console.log('üáµüá™ FECHA PER√ö GENERADA:');
                console.log('   - Hora Per√∫:', `${hours}:${minutes}:${seconds}`);
                console.log('   - ISO con -05:00:', isoStringPeru);
                
                return {
                    timestamp: fechaPeru,
                    isoString: isoStringPeru, // ‚úÖ CON -05:00
                    readable: `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`,
                    hora: `${hours}:${minutes}:${seconds}`
                };
                
            } catch (error) {
                console.error('‚ùå Error en getPeruTime:', error);
                
                // Fallback con offset manual
                const ahora = new Date();
                const offsetPeru = -5 * 60 * 60 * 1000; // UTC-5
                const fechaPeru = new Date(ahora.getTime() + offsetPeru);
                
                return {
                    timestamp: fechaPeru,
                    isoString: fechaPeru.toISOString().replace('Z', '-05:00'),
                    readable: fechaPeru.toLocaleString('es-PE'),
                    hora: fechaPeru.toLocaleTimeString('es-PE')
                };
            }
        }
        
        // ===== FUNCIONES DE UTILIDAD =====
        function showLoadingOverlay(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            const toastConfig = {
                success: { icon: 'check-circle', color: 'toast' },
                error: { icon: 'exclamation-circle', color: 'toast-error' },
                warning: { icon: 'exclamation-triangle', color: 'toast-warning' },
                info: { icon: 'info-circle', color: 'toast-info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            toastIcon.className = `fas fa-${config.icon} toast-icon`;
            toast.classList.add(config.color);
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ===== INICIALIZACI√ìN DE LA APLICACI√ìN =====
        async function initializeApp() {
            try {               
                console.log('üöÄ [APP] Inicializando portal principal de Gallos M√°rmol...');
                // ‚úÖ LIMPIAR MODALES AL INICIAR (por si quedaron de sesi√≥n anterior)
                limpiarTodosLosModales();
                
                // ‚úÖ IDENTIFICAR QUE ES EL PORTAL PRINCIPAL (NO aplicar redirecci√≥n)
                console.log('üìç Portal principal detectado - sin verificaci√≥n de sesi√≥n autom√°tica');
                
                // ‚úÖ CONFIGURACI√ìN INICIAL
                setupGlobalEventListeners();
                resetUIState();
                
                // ‚úÖ MOSTRAR LOGIN INMEDIATAMENTE (estado inicial)
                showLoginScreen();
                
                // ‚úÖ INICIALIZAR SUPABASE EN SEGUNDO PLANO
                console.log('üîß Inicializando Supabase...');
                const supabaseInicializado = await initializeSupabase();
                
                if (!supabaseInicializado) {
                    console.error('‚ùå No se pudo inicializar Supabase');
                    showToast('Error de conexi√≥n con la base de datos', 'error');
                    // Mantener pantalla de login visible
                    return;
                }
                
                console.log('‚úÖ Supabase inicializado correctamente');
                
                // ‚úÖ LIMPIAR PINs DE PRUEBA AL INICIAR (en segundo plano)
                setTimeout(async () => {
                    try {
                        await GestionPIN.limpiarPINsDePrueba();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è No se pudieron limpiar PINs de prueba:', error);
                    }
                }, 2000);
                
                // ‚úÖ VERIFICAR SESIONES EXISTENTES EN SEGUNDO PLANO
                setTimeout(async () => {
                    try {
                        console.log('üîç Verificando sesiones existentes...');
                        
                        // 1. PRIMERO VERIFICAR SESI√ìN PIN (M√ÅS R√ÅPIDA)
                        const tieneSesionPIN = await AutenticacionPIN.verificarSesionPIN();
                        if (tieneSesionPIN) {
                            console.log('‚úÖ Sesi√≥n PIN activa encontrada y recuperada');
                            return;
                        }
                        
                        // 2. VERIFICAR SI HAY INDICIOS DE SESIONES PERO NO SE PUDIERON RECUPERAR
                        const sesionesEnLocalStorage = [
                            localStorage.getItem('sb-auth-token'),
                            localStorage.getItem('sesion_pin_gm'),
                            localStorage.getItem('gm_user_session')
                        ].filter(Boolean);
                        
                        if (sesionesEnLocalStorage.length > 0) {
                            console.log('üîç Se encontraron sesiones en localStorage, verificando Supabase...');
                        } else {
                            console.log('üîç No hay sesiones activas en localStorage');
                            // Mantener pantalla de login visible
                            return;
                        }
                        
                        // 3. FINALMENTE VERIFICAR SESI√ìN SUPABASE
                        await checkExistingSession();
                        
                    } catch (error) {
                        console.error('‚ùå Error verificando sesiones:', error);
                        // ‚úÖ EN CASO DE ERROR, MANTENER LOGIN VISIBLE
                        showLoginScreen();
                        
                        // Mostrar error espec√≠fico si es de red
                        if (error.message.includes('Network') || error.message.includes('fetch')) {
                            showToast('‚ö†Ô∏è Error de conexi√≥n. Verifica tu internet.', 'warning');
                        }
                    }
                }, 1000);
                
                // ‚úÖ INICIALIZAR SISTEMA DE PIN EN SEGUNDO PLANO
                setTimeout(async () => {
                    try {
                        await AdaptadorEstructura.inicializar();
                        console.log('‚úÖ Adaptador de estructura inicializado');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error inicializando adaptador:', error);
                    }
                }, 500);
                
                // ‚úÖ CONFIGURAR LIMPIEZA AUTOM√ÅTICA DE CACH√â
                setInterval(() => {
                    AppCache.clearExpired();
                }, 5 * 60 * 1000); // Cada 5 minutos
                
                console.log('‚úÖ Portal principal inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå [APP] Error cr√≠tico en inicializaci√≥n:', error);
                
                // ‚úÖ GARANTIZAR QUE SIEMPRE SE MUESTRE EL LOGIN INCLUSO CON ERRORES
                showLoginScreen();
                
                // Mostrar error al usuario
                showToast('Error inicializando la aplicaci√≥n', 'error');
                
                // Log adicional para debugging
                ErrorHandler.handle(error, 'App Initialization', 'Error cr√≠tico en la aplicaci√≥n');
            } finally {
                // ‚úÖ ASEGURAR QUE EL LOADING SE OCULTE
                showLoadingOverlay(false);
            }
        }

        // ‚úÖ FUNCI√ìN MEJORADA: VERIFICAR SESI√ìN EXISTENTE
        async function checkExistingSession() {
            try {
                console.log('üîç Verificando sesi√≥n existente en Supabase...');
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Error obteniendo sesi√≥n Supabase:', error);
                    
                    // üî• NUEVO: Intentar recuperar de localStorage como fallback
                    const fallbackSession = await intentarRecuperarSesionFallback();
                    if (fallbackSession) {
                        console.log('‚úÖ Sesi√≥n recuperada por fallback de localStorage');
                        await procesarUsuarioAutenticado(fallbackSession.user);
                        return;
                    }
                    
                    throw error;
                }
                
                if (session) {
                    console.log('üë§ [AUTH] Sesi√≥n Supabase existente encontrada:', session.user.email);
                    await procesarUsuarioAutenticado(session.user);
                } else {
                    console.log('üö™ [AUTH] No hay sesi√≥n Supabase activa');
                    // ‚úÖ MANTENER LOGIN VISIBLE (no cambiar a login screen porque ya est√° visible)
                }
            } catch (error) {
                console.error('‚ùå [AUTH] Error verificando sesi√≥n:', error);
                // ‚úÖ NO forzar showLoginScreen() porque ya est√° visible
            }
        }

        // ‚úÖ FUNCI√ìN AUXILIAR: RECUPERAR SESI√ìN FALLBACK
        async function intentarRecuperarSesionFallback() {
            try {
                // Intentar recuperar sesi√≥n de localStorage
                const storageKey = 'sb-auth-token';
                const sessionData = localStorage.getItem(storageKey);
                
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (session && session.user) {
                        console.log('üîÑ Sesi√≥n recuperada de localStorage fallback');
                        return session;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo recuperar sesi√≥n de fallback:', error);
            }
            return null;
        }

        // ‚úÖ CONFIGURACI√ìN DE EVENT LISTENERS GLOBALES
        function setupGlobalEventListeners() {
            console.log('üîß Configurando event listeners globales...');
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
                console.log('‚úÖ Theme toggle configurado');
            }
            
            // Fullscreen button
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                console.log('‚úÖ Fullscreen button configurado');
            }
            
            // Login button (principal)
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
 
                console.log('‚úÖ Login button configurado');
            }
            
            // ‚úÖ MEJORADO: Delegaci√≥n de eventos para elementos din√°micos
            document.addEventListener('click', (e) => {
                // Sistema cards (solo los habilitados)
                const systemCard = e.target.closest('.system-card:not(.disabled)');
                if (systemCard) {
                    handleSystemCardClick(e);
                }
                
                // Botones de logout din√°micos
                const logoutBtn = e.target.closest('.logout-btn');
                if (logoutBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleLogout();
                }
                
                // Toast close
                if (e.target.closest('.toast-close')) {
                    hideToast();
                }
            });
            
            // ‚úÖ NUEVO: Detectar actividad del usuario para mantener sesiones
            document.addEventListener('mousemove', debounce(() => {
                if (AppSession.getValidSession()) {
                    AppSession.saveSession(AppSession.getValidSession());
                }
            }, 30000)); // Cada 30 segundos de inactividad
            
            console.log('‚úÖ Todos los event listeners configurados');
        }

        // ‚úÖ FUNCI√ìN AUXILIAR: DEBOUNCE
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ‚úÖ CONFIGURACI√ìN INICIAL DE TEMA
        function setupInitialTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            const isDarkMode = savedTheme === 'true';
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                const icon = document.getElementById('themeToggle')?.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-sun';
                }
            }
        }

        // ‚úÖ EJECUTAR CONFIGURACI√ìN INICIAL AL CARGAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM cargado - Iniciando aplicaci√≥n...');
            
            // Configurar tema antes de inicializar
            setupInitialTheme();
            
            // Agregar meta tags para seguridad
            agregarConfiguracionHead();
            
            // Inicializar aplicaci√≥n
            initializeApp();
        });

        // ‚úÖ CONFIGURACI√ìN HEAD PARA SEGURIDAD
        function agregarConfiguracionHead() {
            const metaTags = [
                { name: 'referrer', content: 'strict-origin-when-cross-origin' },
                { name: 'robots', content: 'noindex, nofollow' },
                { name: 'viewport', content: 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes' }
            ];
            
            metaTags.forEach(tag => {
                if (!document.querySelector(`meta[name="${tag.name}"]`)) {
                    const meta = document.createElement('meta');
                    meta.name = tag.name;
                    meta.content = tag.content;
                    document.head.appendChild(meta);
                }
            });
            
            console.log('‚úÖ Configuraci√≥n de head completada');
        }

        // üîß FUNCI√ìN DE DEBUG PARA VERIFICAR PIN
        async function debugPINVerification(email, pinIngresado) {
            try {
                console.log('üîß [DEBUG] Verificando configuraci√≥n de PIN...');
                
                // Obtener usuario
                const { data: usuario, error } = await supabase
                    .from('usuario')
                    .select('id, codigo_pin, nombre, correo')
                    .eq('correo', email)
                    .single();
                    
                if (error) {
                    console.error('‚ùå [DEBUG] Error obteniendo usuario:', error);
                    return;
                }
                
                console.log('üìä [DEBUG] Informaci√≥n del usuario:');
                console.log('   - ID:', usuario.id);
                console.log('   - Email:', usuario.correo);
                console.log('   - Nombre:', usuario.nombre);
                console.log('   - Longitud PIN almacenado:', usuario.codigo_pin?.length || 'NULL');
                console.log('   - PIN almacenado (primeros 16 chars):', usuario.codigo_pin?.substring(0, 16) + '...' || 'NULL');
                
                // Encriptar PIN ingresado
                const pinHasheado = await GestionPIN.hashearPINSeguro(pinIngresado, usuario.id);
                console.log('   - PIN ingresado encriptado:', pinHasheado.substring(0, 16) + '...');
                console.log('   - Longitud hash generado:', pinHasheado.length);
                
                // Verificar coincidencia
                console.log('   - ¬øCoinciden?:', usuario.codigo_pin === pinHasheado);
                
                // Verificar algoritmo de hash
                console.log('üîê [DEBUG] Verificando algoritmo de hash:');
                console.log('   - SALT_GLOBAL existe:', !!GestionPIN.SALT_GLOBAL);
                console.log('   - Longitud SALT:', GestionPIN.SALT_GLOBAL?.length);
                
            } catch (error) {
                console.error('‚ùå [DEBUG] Error en verificaci√≥n:', error);
            }
        }

        // MANEJADOR DE CLIC EN TARJETAS DE SISTEMA
        function handleSystemCardClick(event) {
            try {
                const card = event.target.closest('.system-card');
                if (!card) return;
                
                const systemKey = card.dataset.system;
                console.log('üéØ Sistema seleccionado:', systemKey);
                
                const systemData = getSystemData(systemKey);
                
                if (systemData) {
                    // ‚úÖ REDIRECCI√ìN INMEDIATA
                    RedirectSystem.selectSystem(systemData, event);
                }
                
            } catch (error) {
                console.error('‚ùå Error en click de tarjeta:', error);
                ErrorHandler.handle(error, 'System Card Click', 'Error al seleccionar sistema');
            }
        }

        // OBTENER DATOS DEL SISTEMA
        function getSystemData(systemKey) {
            try {
                console.log('üîç [SYSTEM] Buscando datos para:', systemKey);
                
                if (typeof systemKey === 'object' && systemKey.key) {
                    console.log('‚úÖ [SYSTEM] Ya es un objeto de sistema v√°lido');
                    return systemKey;
                }
                
                if (window.currentUserSystems) {
                    const systemFromCache = window.currentUserSystems.find(sys => sys.key === systemKey);
                    if (systemFromCache) {
                        console.log('‚úÖ [SYSTEM] Encontrado en cach√© de usuario:', systemFromCache);
                        return systemFromCache;
                    }
                }
                
                const systemData = {
                    key: systemKey,
                    name: SystemNames[systemKey] || systemKey,
                    rol: 'colaborador'
                };
                
                console.log('üÜï [SYSTEM] Sistema creado:', systemData);
                return systemData;
                
            } catch (error) {
                console.error('‚ùå [SYSTEM] Error obteniendo datos del sistema:', error);
                return {
                    key: systemKey,
                    name: systemKey,
                    rol: 'colaborador'
                };
            }
        }

        // üî• NUEVO: PROCESAR USUARIO AUTENTICADO (FUNCI√ìN CENTRALIZADA)
        async function procesarUsuarioAutenticado(user) {
            try {
                showLoadingOverlay(true, 'Verificando tus permisos...');
                
                console.log('üë§ Procesando usuario autenticado:', user.email);
                
                // Obtener datos del usuario
                const userData = await obtenerDatosUsuarioPorEmail(user.email);
                
                if (!userData) {
                    throw new Error('Usuario no encontrado en la base de datos');
                }

                // Obtener sistemas accesibles
                const sistemasAcceso = userData.sistemas_acceso || {};
                const accessibleSystems = [];
                
                Object.keys(sistemasAcceso).forEach(sistemaKey => {
                    const configSistema = sistemasAcceso[sistemaKey];
                    
                    if (configSistema?.activo && configSistema?.rol && SystemPages[sistemaKey]) {
                        if (SystemPages[sistemaKey][configSistema.rol]) {
                            accessibleSystems.push({
                                key: sistemaKey,
                                name: SystemNames[sistemaKey] || sistemaKey,
                                rol: configSistema.rol,
                                userData: userData,
                                fechaAsignacion: configSistema.fechaAsignacion,
                                activo: configSistema.activo
                            });
                        }
                    }
                });

                if (accessibleSystems.length === 0) {
                    throw new Error('No tienes acceso a ning√∫n sistema');
                }

                // ‚úÖ VERIFICAR Y CONFIGURAR PIN (NUEVO)
                const estadoPIN = await GestionPIN.verificarEstadoPIN(userData.id);
                
                if (!estadoPIN.tienePIN) {
                    // Usuario sin PIN - configuraci√≥n obligatoria
                    showLoadingOverlay(false);
                    
                    const configurado = await GestionPIN.mostrarModalConfiguracionObligatoria(
                        userData.id, 
                        user.email, 
                        userData.nombre
                    );
                    
                    if (!configurado) {
                        // Si cancela la configuraci√≥n, cerrar sesi√≥n
                        await handleLogout();
                        return;
                    }
                    
                    // Recargar estado despu√©s de configuraci√≥n
                    showLoadingOverlay(true, 'Finalizando configuraci√≥n...');
                }

                // Mostrar sistemas al usuario
                displayAccessibleSystems(accessibleSystems, user);
                
            } catch (error) {
                console.error('‚ùå Error procesando usuario autenticado:', error);
                
                if (error.message.includes('no encontrado')) {
                    showErrorScreen(user, {
                        code: 'USER_NOT_REGISTERED',
                        message: 'Usuario no registrado en el sistema'
                    });
                } else if (error.message.includes('No tienes acceso')) {
                    showNoAccessScreen(user);
                } else {
                    showToast('Error: ' + error.message, 'error');
                    showLoginScreen();
                }
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function obtenerDatosUsuarioPorEmail(email) {
            try {
                const { data, error } = await supabase
                    .from('usuario')
                    .select('*')
                    .eq('correo', email)
                    .eq('activo', true)
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('‚ùå Error obteniendo datos usuario:', error);
                throw error;
            }
        }

        // üî• NUEVO: MODAL OPCIONAL PARA CONFIGURAR PIN
        function mostrarModalConfiguracionPINOpcional(usuarioId, usuarioEmail, usuarioNombre) {
            return new Promise((resolve) => {
                const modalHTML = `
                    <div class="modal-pin-opcional" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: var(--card-bg);
                            padding: 2rem;
                            border-radius: 16px;
                            max-width: 500px;
                            width: 90%;
                            color: var(--text-color);
                            border: 1px solid var(--border-color);
                            box-shadow: var(--shadow-lg);
                            text-align: center;
                        ">
                            <!-- Icono -->
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(135deg, var(--success-color), var(--primary-color));
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 1.5rem;
                                color: white;
                                font-size: 2rem;
                            ">
                                <i class="fas fa-bolt"></i>
                            </div>
                            
                            <!-- T√≠tulo -->
                            <h3 style="color: var(--text-color); margin-bottom: 1rem; font-weight: 600;">
                                ¬øConfigurar Acceso R√°pido, ${usuarioNombre}?
                            </h3>
                            
                            <!-- Mensaje -->
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
                                Puedes configurar un PIN de 6 d√≠gitos para acceder instant√°neamente en el futuro, sin esperar emails.
                            </p>
                            
                            <!-- Estado de compatibilidad -->
                            <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--success-color);">
                                    <i class="fas fa-check-circle"></i> Sistema compatible con PIN seguro
                                </p>
                            </div>
                            
                            <!-- Beneficios -->
                            <div style="background: rgba(52, 152, 219, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: left;">
                                <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.1rem;">
                                    <i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>
                                    Beneficios:
                                </h4>
                                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-muted);">
                                    <li>Acceso en 5 segundos</li>
                                    <li>Sin esperar emails</li>
                                    <li>Encriptaci√≥n SHA-256</li>
                                    <li>F√°cil de recordar</li>
                                </ul>
                            </div>
                            
                            <!-- Botones -->
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button id="btnAhoraNo" style="
                                    padding: 1rem 2rem;
                                    border: 2px solid var(--border-color);
                                    background: transparent;
                                    color: var(--text-color);
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.backgroundColor='var(--light-color)';" 
                                onmouseout="this.style.backgroundColor='transparent';">
                                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                    Ahora No
                                </button>
                                
                                <button id="btnConfigurarAhora" style="
                                    padding: 1rem 2rem;
                                    background: var(--success-color);
                                    color: white;
                                    border: none;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    flex: 1;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <i class="fas fa-key" style="margin-right: 0.5rem;"></i>
                                    Configurar PIN
                                </button>
                            </div>
                            
                            <!-- Pie -->
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.8rem;">
                                    <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                                    Puedes configurar el PIN m√°s tarde desde tu perfil
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                const contenedorModal = document.createElement('div');
                contenedorModal.innerHTML = modalHTML;
                document.body.appendChild(contenedorModal);
                
                const btnAhoraNo = document.getElementById('btnAhoraNo');
                const btnConfigurarAhora = document.getElementById('btnConfigurarAhora');
                
                // Configurar ahora
                btnConfigurarAhora.addEventListener('click', () => {
                    document.body.removeChild(contenedorModal);
                    resolve(true);
                });
                
                // Ahora no
                btnAhoraNo.addEventListener('click', () => {
                    document.body.removeChild(contenedorModal);
                    resolve(false);
                });
                
                // Clic fuera para cerrar (equivale a "Ahora no")
                contenedorModal.addEventListener('click', (e) => {
                    if (e.target === contenedorModal) {
                        document.body.removeChild(contenedorModal);
                        resolve(false);
                    }
                });
            });
        }

        // üî• AUTENTICACI√ìN DIRECTA - SIN ENV√çO DE EMAIL
        async function triggerDirectLogin() {
            try {
                showLoadingOverlay(true, 'Cargando...');
                
                // üî• MODAL MEJORADO PARA LOGIN DIRECTO
                const credentials = await showDirectLoginModal();
                
                if (!credentials) {
                    showToast('Se requiere email para continuar', 'info');
                    return;
                }
                
                const { email } = credentials;
                
                console.log('üîê Verificando acceso directo para:', email);
                
                // üî• VERIFICAR DIRECTAMENTE EN LA BASE DE DATOS
                const userSystems = await getUserAccessibleSystems(email, null);
                
                if (userSystems && userSystems.length > 0) {
                    // üî• CREAR SESI√ìN DIRECTA SIN AUTENTICACI√ìN SUPABASE
                    await createDirectSession(email, userSystems);
                    
                    showToast(`¬°Bienvenido ${userSystems[0].userData.nombre}!`, 'success');
                    
                    // üî• MOSTRAR SISTEMAS DIRECTAMENTE
                    displayAccessibleSystems(userSystems, {
                        email: email,
                        user_metadata: {
                            full_name: `${userSystems[0].userData.nombre} ${userSystems[0].userData.apellido || ''}`
                        }
                    });
                    
                } else {
                    throw new Error('No tienes acceso a ning√∫n sistema');
                }
                
            } catch (error) {
                console.error('‚ùå Error en login directo:', error);
                
                if (error.message.includes('no registrado') || error.code === 'USER_NOT_REGISTERED') {
                    showToast('‚ùå Email no registrado en el sistema', 'error');
                } else if (error.message.includes('desactivada') || error.code === 'USER_DEACTIVATED') {
                    showToast('‚ùå Cuenta desactivada', 'error');
                } else if (error.message.includes('No tienes acceso')) {
                    showToast('‚ùå No tienes acceso a ning√∫n sistema', 'error');
                } else {
                    showToast('‚ùå Error: ' + error.message, 'error');
                }
            } finally {
                showLoadingOverlay(false);
            }
        }

        // üî• MODAL PARA LOGIN DIRECTO
        function showDirectLoginModal() {
            return new Promise((resolve) => {
                const modalHTML = `
                    <div class="direct-login-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: var(--card-bg);
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 400px;
                            width: 90%;
                            color: var(--text-color);
                            border: 1px solid var(--border-color);
                            box-shadow: var(--shadow-lg);
                        ">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <div style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-right-to-bracket"></i>
                                </div>
                                <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">
                                    Acceso Directo
                                </h3>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">
                                    Ingresa tu email corporativo
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                                    <i class="fas fa-at"></i> Correo Electr√≥nico
                                </label>
                                <input 
                                    type="email" 
                                    id="directEmailInput" 
                                    placeholder="tu.email@gallosmarmol.com" 
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 1px solid var(--border-color);
                                        border-radius: 8px;
                                        background: var(--bg-color);
                                        color: var(--text-color);
                                        font-size: 1rem;
                                    "
                                >
                            </div>
                            
                            <div style="background: rgba(52, 152, 219, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                    <i class="fas fa-bolt"></i>
                                    <strong>Acceso instant√°neo:</strong> Sin esperar emails
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button id="cancelDirectBtn" style="
                                    padding: 0.75rem 1.5rem;
                                    border: 1px solid var(--border-color);
                                    background: transparent;
                                    color: var(--text-color);
                                    border-radius: 6px;
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                
                                <button id="loginDirectBtn" style="
                                    padding: 0.75rem 1.5rem;
                                    background: var(--primary-color);
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">
                                    <i class="fas fa-sign-in-alt"></i> Acceder
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                
                const emailInput = document.getElementById('directEmailInput');
                const cancelBtn = document.getElementById('cancelDirectBtn');
                const loginBtn = document.getElementById('loginDirectBtn');
                
                // Auto-focus
                setTimeout(() => emailInput.focus(), 100);
                
                // Enter para acceder
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
                
                // Validaci√≥n en tiempo real
                emailInput.addEventListener('input', function() {
                    const email = this.value.trim();
                    const isValid = validateEmail(email);
                    
                    if (email && isValid) {
                        loginBtn.disabled = false;
                        loginBtn.style.opacity = '1';
                    } else {
                        loginBtn.disabled = true;
                        loginBtn.style.opacity = '0.6';
                    }
                });
                
                // Login directo
                loginBtn.addEventListener('click', async () => {
                    const email = emailInput.value.trim();
                    if (email && validateEmail(email)) {
                        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
                        loginBtn.disabled = true;
                        
                        document.body.removeChild(modalContainer);
                        resolve({ email });
                    } else {
                        showToast('Por favor ingresa un email v√°lido', 'warning');
                        emailInput.focus();
                    }
                });
                
                // Cancelar
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                    resolve(null);
                });
                
                // Clic fuera para cerrar
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        document.body.removeChild(modalContainer);
                        resolve(null);
                    }
                });
            });
        }

        // üî• CREAR SESI√ìN DIRECTA
        async function createDirectSession(email, userSystems) {
            const sessionData = {
                user: {
                    email: email,
                    name: userSystems[0].userData.nombre,
                    id: userSystems[0].userData.id
                },
                systems: userSystems,
                timestamp: new Date().toISOString(),
                lastActivity: Date.now(),
                type: 'direct' // Para identificar que es sesi√≥n directa
            };
            
            // Guardar en localStorage
            localStorage.setItem('gm_direct_session', JSON.stringify(sessionData));
            
            // Guardar en cach√©
            AppSession.saveSession(sessionData);
            
            console.log('‚úÖ Sesi√≥n directa creada para:', email);
        }

        // üî• VERIFICAR SESI√ìN DIRECTA AL INICIAR
        async function checkDirectSession() {
            try {
                const sessionData = localStorage.getItem('gm_direct_session');
                
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    const now = Date.now();
                    
                    // Verificar si la sesi√≥n expir√≥ (8 horas)
                    if (now - session.lastActivity > 8 * 60 * 60 * 1000) {
                        localStorage.removeItem('gm_direct_session');
                        return false;
                    }
                    
                    // Actualizar √∫ltima actividad
                    session.lastActivity = now;
                    localStorage.setItem('gm_direct_session', JSON.stringify(session));
                    
                    console.log('‚úÖ Sesi√≥n directa recuperada:', session.user.email);
                    
                    // Mostrar sistemas directamente
                    displayAccessibleSystems(session.systems, {
                        email: session.user.email,
                        user_metadata: { full_name: session.user.name }
                    });
                    
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Error recuperando sesi√≥n directa:', error);
                localStorage.removeItem('gm_direct_session');
            }
            
            return false;
        }

        // üî• VALIDAR EMAIL
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        async function getUserInfoForEmail(email) {
            try {
                // ‚úÖ CORREGIDO: USAR 'sistemas_acceso' (CON 's')
                const { data, error } = await supabase
                    .from('usuario')
                    .select('id, nombre, apellido, activo, sistemas_acceso') // üî• CORREGIDO
                    .eq('correo', email)
                    .single();
                    
                if (error) return { exists: false };

                if (!data.activo) {
                    throw new Error('Usuario desactivado');
                }

                // ‚úÖ CORREGIDO: USAR 'sistemas_acceso' (CON 's')
                const sistemasAcceso = data.sistemas_acceso || {}; // üî• CORREGIDO
                const accessibleSystems = Object.keys(sistemasAcceso)
                    .filter(key => sistemasAcceso[key]?.activo)
                    .map(key => ({
                        nombre: SystemNames[key] || key,
                        rol: sistemasAcceso[key].rol
                    }));
                
                return {
                    exists: true,
                    name: `${data.nombre} ${data.apellido || ''}`.trim(),
                    systems: accessibleSystems,
                    fullData: data
                };
                
            } catch (error) {
                return { exists: false };
            }
        }

        // üî• FUNCI√ìN COMPLETA Y ADAPTADA PARA AUTENTICACI√ìN POR EMAIL
        async function getUserAccessibleSystems(userEmail, user) {
            const requestKey = `request_${userEmail}`;
            
            if (window.pendingRequests && window.pendingRequests[requestKey]) {
                console.log('‚ö° [SUPABASE] Consulta ya en progreso para:', userEmail);
                throw new Error('REQUEST_IN_PROGRESS');
            }
            
            if (!window.pendingRequests) window.pendingRequests = {};
            window.pendingRequests[requestKey] = true;
            
            try {
                const cacheKey = `userSystems_${userEmail}`;
                const cachedData = AppCache.get(cacheKey);
                
                if (cachedData) {
                    console.log('üöÄ [OPTIMIZED] Usando datos en cach√© para:', userEmail);
                    return cachedData;
                }

                console.log('üì° [SUPABASE] Consultando sistemas para:', userEmail);
                
                // ‚úÖ CORREGIDO: Eliminar 'rol' de la consulta ya que no existe
                const { data: userData, error } = await supabase
                    .from('usuario')
                    .select(`
                        id,
                        nombre,
                        apellido, 
                        correo,
                        activo,
                        sistemas_acceso,  
                        fecha_ultimo_acceso,
                        fecha_creacion
                    `) // üî• QUITAMOS 'rol' de aqu√≠
                    .eq('correo', userEmail)
                    .eq('activo', true)
                    .single();

                if (error) {
                    console.error('‚ùå [SUPABASE] Error en consulta:', error);
                    
                    if (error.code === 'PGRST116') {
                        const notFoundError = new Error('Email no registrado en el sistema');
                        notFoundError.code = 'USER_NOT_REGISTERED';
                        throw notFoundError;
                    }
                    
                    throw error;
                }

                console.log('‚úÖ [USER] Usuario encontrado en base de datos:', userData.nombre);
                console.log('üîç [DEBUG] Estructura sistemas_acceso:', userData.sistemas_acceso);

                if (!userData.activo) {
                    console.warn('‚ö†Ô∏è [USER] Usuario desactivado:', userEmail);
                    const deactivatedError = new Error('Cuenta desactivada');
                    deactivatedError.code = 'USER_DEACTIVATED';
                    throw deactivatedError;
                }

                const sistemasAcceso = userData.sistemas_acceso || {};
                console.log('üîç [SYSTEMS] Sistemas en JSON:', sistemasAcceso);
                
                const accessibleSystems = [];
                
                Object.keys(sistemasAcceso).forEach(systemKey => {
                    const systemConfig = sistemasAcceso[systemKey];
                    
                    console.log(`üîç [SYSTEM-PROCESS] Procesando ${systemKey}:`, {
                        activo: systemConfig?.activo,
                        rol: systemConfig?.rol,
                        existeEnSystemPages: !!SystemPages[systemKey]
                    });
                    
                    // ‚úÖ VERIFICACI√ìN CON NUEVA ESTRUCTURA
                    if (systemConfig?.activo && systemConfig?.rol && SystemPages[systemKey]) {
                        
                        if (SystemPages[systemKey][systemConfig.rol]) {
                            accessibleSystems.push({
                                key: systemKey,
                                name: SystemNames[systemKey] || systemKey,
                                rol: systemConfig.rol, // üéØ ROL VIENE DEL JSON sistemas_acceso
                                userData: userData,
                                fechaAsignacion: systemConfig.fechaAsignacion,
                                activo: systemConfig.activo
                            });
                            console.log(`üéØ [SYSTEM-PROCESS] ${systemKey} AGREGADO - Rol: ${systemConfig.rol}`);
                        } else {
                            console.warn(`‚ö†Ô∏è [SYSTEM-PROCESS] Rol '${systemConfig.rol}' no disponible para ${systemKey}`);
                        }
                    } else {
                        if (!systemConfig?.activo) {
                            console.log(`‚ùå [SYSTEM-PROCESS] ${systemKey} no est√° activo`);
                        } else if (!systemConfig?.rol) {
                            console.log(`‚ùå [SYSTEM-PROCESS] ${systemKey} no tiene rol configurado`);
                        } else if (!SystemPages[systemKey]) {
                            console.log(`‚ùå [SYSTEM-PROCESS] ${systemKey} no existe en SystemPages`);
                        }
                    }
                });

                console.log(`üìä [SYSTEMS-RESULT] Sistemas accesibles finales:`, accessibleSystems.length);

                if (accessibleSystems.length === 0) {
                    console.warn('‚ö†Ô∏è [USER] Usuario sin acceso a sistemas:', userEmail);
                    const noAccessError = new Error('No tienes acceso a ning√∫n sistema');
                    noAccessError.code = 'NO_SYSTEM_ACCESS';
                    throw noAccessError;
                }

                console.log(`üéØ [USER] ${accessibleSystems.length} sistemas encontrados para ${userEmail}`);
                
                // ‚úÖ ACTUALIZAR FECHA DE √öLTIMO ACCESO
                await actualizarUltimoAcceso(userData.id, userEmail, accessibleSystems.length);
                
                // ‚úÖ GUARDAR EN CACH√â
                AppCache.set(cacheKey, accessibleSystems, 10 * 60 * 1000);
                
                return accessibleSystems;

            } catch (error) {
                console.error('‚ùå [ERROR] Error en getUserAccessibleSystems:', error.message);
                
                if (error.code !== 'REQUEST_IN_PROGRESS') {
                    AppCache.delete(`userSystems_${userEmail}`);
                }
                throw error;
            } finally {
                if (window.pendingRequests) {
                    delete window.pendingRequests[requestKey];
                }
            }
        }

        async function verificarEstructuraTablaUsuario() {
            try {
                console.log('üîç Verificando estructura de la tabla usuario...');
                
                // Hacer una consulta simple para ver las columnas disponibles
                const { data, error } = await supabase
                    .from('usuario')
                    .select('*')
                    .limit(1)
                    .single();

                if (error) {
                    console.error('‚ùå Error verificando estructura:', error);
                    return null;
                }

                console.log('üìã Columnas disponibles en tabla usuario:');
                console.table(Object.keys(data));
                
                return Object.keys(data);
                
            } catch (error) {
                console.error('‚ùå Error en verificaci√≥n de estructura:', error);
                return null;
            }
        }

        // üî• FUNCI√ìN AUXILIAR MEJORADA: ACTUALIZAR √öLTIMO ACCESO
        async function actualizarUltimoAcceso(userId, userEmail, cantidadSistemas) {
            try {
                const peruTime = getPeruTime();
                
                // ‚úÖ CONSULTA SEGURA - solo campos que existen
                const { error } = await supabase
                    .from('usuario')
                    .update({
                        fecha_ultimo_acceso: peruTime.isoString,
                        fecha_actualizacion: peruTime.isoString
                    })
                    .eq('id', userId);
                    
                if (error) {
                    console.warn('‚ö†Ô∏è [UPDATE] No se pudo actualizar √∫ltimo acceso:', error);
                    
                    // Intentar solo con fecha_ultimo_acceso si fecha_actualizacion no existe
                    const { error: errorSimple } = await supabase
                        .from('usuario')
                        .update({
                            fecha_ultimo_acceso: peruTime.isoString
                        })
                        .eq('id', userId);
                        
                    if (errorSimple) {
                        console.warn('‚ö†Ô∏è [UPDATE] Error incluso con consulta simple:', errorSimple);
                    } else {
                        console.log('üìù [UPDATE] √öltimo acceso actualizado (solo fecha_ultimo_acceso)');
                    }
                } else {
                    console.log('üìù [UPDATE] √öltimo acceso actualizado para:', userEmail);
                }
            } catch (updateError) {
                console.warn('‚ö†Ô∏è [UPDATE] Error actualizando √∫ltimo acceso:', updateError);
            }
        }

        // üî• FUNCI√ìN AUXILIAR: OBTENER HORA DE PER√ö
        function getPeruTime() {
            const now = new Date();
            const peruOffset = -5 * 60; // UTC-5 en minutos
            const peruTime = new Date(now.getTime() + peruOffset * 60 * 1000);
            
            return {
                timestamp: peruTime,
                isoString: peruTime.toISOString(),
                readable: peruTime.toLocaleString('es-PE', {
                    timeZone: 'America/Lima',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })
            };
        }

        // üî• CONFIGURACI√ìN DE SYSTEMPAGES (Actualizar seg√∫n tus sistemas)
        const SystemPages = {
            sistemaSuministro: {
                colaborador: '/SUMINISTRO/COLABORADOR/index.html',
                supervisor: '/SUMINISTRO/SUPERVISOR/index.html',
                administrador: '/SUMINISTRO/ADMINISTRADOR/index.html'
            },
            sistemaTicket: {
                colaborador: '/TICKET/COLABORADOR/index.html',
                soporte: '/TICKET/SOPORTE/index.html',
                gerente: '/TICKET/GERENCIA/index.html',
                administrador: '/TICKET/ADMINISTRADOR/index.html'
            },
            sistemaActivo: {
                colaborador: '/ACTIVO/COLABORADOR/index.html',
                administrador: '/ACTIVO/ADMINISTRADOR/index.html'
            },
            sistemaDespacho: {
                colaborador: 'https://gallosmarmol.github.io/SISTEMAS/DESPACHO/COLABORADOR/',
                supervisor: '/DESPACHO/SUPERVISOR/index.html',
                administrador: '/DESPACHO/ADMINISTRADOR/index.html'
            },
            sistemaInventario: {
                colaborador: '/INVENTARIO/COLABORADOR/index.html',
                supervisor: '/INVENTARIO/SUPERVISOR/index.html',
                administrador: '/INVENTARIO/ADMINISTRADOR/index.html'
            }
        };

        // üî• CONFIGURACI√ìN DE SYSTEMNAMES
        const SystemNames = {
            sistemaSuministro: 'Sistema de Suministro',
            sistemaTicket: 'Sistema de Tickets',
            sistemaActivo: 'Sistema de Activos',
            sistemaDespacho: 'Sistema de Despacho',
            sistemaInventario: 'Sistema de Inventario'
        };

        // üî• FUNCI√ìN AUXILIAR: DETERMINAR ROL DESDE PERMISOS
        function determinarRolDesdePermisos(permisos, rolBase) {
            console.log('üé≠ [ROLE] Determinando rol:', { permisos, rolBase });
            
            // ‚úÖ SI EL USUARIO TIENE ROL DE ADMINISTRADOR O GERENCIA, USAR ESE ROL
            if (rolBase === 'administrador' || rolBase === 'gerencia') {
                console.log('üëë [ROLE] Usando rol base privilegiado:', rolBase);
                return rolBase;
            }
            
            // ‚úÖ MAPEAR PERMISOS A ROLES DEL SISTEMA
            if (permisos && Array.isArray(permisos)) {
                if (permisos.includes('administracion')) {
                    console.log('üõ†Ô∏è [ROLE] Rol: administrador (por permisos)');
                    return 'administrador';
                } else if (permisos.includes('escritura') && permisos.includes('aprobacion')) {
                    console.log('üë®‚Äçüíº [ROLE] Rol: supervisor (por permisos avanzados)');
                    return 'supervisor';
                } else if (permisos.includes('escritura')) {
                    console.log('üìù [ROLE] Rol: supervisor (por escritura)');
                    return 'supervisor';
                } else if (permisos.includes('lectura')) {
                    console.log('üëÄ [ROLE] Rol: colaborador (por lectura)');
                    return 'colaborador';
                }
            }
            
            // ‚úÖ ROL POR DEFECTO
            console.log('üîß [ROLE] Rol por defecto: colaborador');
            return 'colaborador';
        }

        function determinarRolUsuario(datosUsuario, sistemaKey) {
            try {
                console.log('üé≠ Determinando rol para:', {
                    usuario: datosUsuario.correo,
                    sistema: sistemaKey,
                    sistemas_acceso: datosUsuario.sistemas_acceso
                });
                
                // ‚úÖ OPCI√ìN 1: Rol desde sistemas_acceso JSON
                const sistemasAcceso = datosUsuario.sistemas_acceso || {};
                const configSistema = sistemasAcceso[sistemaKey];
                
                if (configSistema?.rol) {
                    console.log(`‚úÖ Rol desde sistemas_acceso: ${configSistema.rol}`);
                    return configSistema.rol;
                }
                
                // ‚úÖ OPCI√ìN 2: Rol por defecto basado en permisos globales
                // (Si tienes una columna global de permisos)
                if (datosUsuario.permisos_globales) {
                    const rolGlobal = determinarRolDesdePermisosGlobales(datosUsuario.permisos_globales);
                    console.log(`üåç Rol desde permisos globales: ${rolGlobal}`);
                    return rolGlobal;
                }
                
                // ‚úÖ OPCI√ìN 3: Rol por defecto
                console.log('üîß Usando rol por defecto: colaborador');
                return 'colaborador';
                
            } catch (error) {
                console.error('‚ùå Error determinando rol:', error);
                return 'colaborador'; // Rol por defecto seguro
            }
        }

        function determinarRolDesdePermisosGlobales(permisos) {
            if (!permisos || typeof permisos !== 'object') {
                return 'colaborador';
            }
            
            // L√≥gica para determinar rol basado en permisos globales
            if (permisos.es_administrador) {
                return 'administrador';
            } else if (permisos.es_supervisor) {
                return 'supervisor';
            } else if (permisos.es_gerente) {
                return 'gerente';
            } else {
                return 'colaborador';
            }
        }

        // MANEJAR USUARIO AUTENTICADO
        async function handleAuthenticatedUser(user) {
            if (window.isHandlingAuth) {
                console.log('‚ö° [AUTH] Ya procesando autenticaci√≥n, omitiendo...');
                return;
            }
            
            try {
                window.isHandlingAuth = true;
                console.log('üîê [AUTH] Procesando usuario:', user.email);
                
                showLoadingOverlay(true, 'Cargando tus sistemas...');
                
                const userCacheKey = `current_user_${user.email}`;
                const cachedUser = AppCache.get(userCacheKey);
                
                if (cachedUser && cachedUser.timestamp > Date.now() - 30000) {
                    console.log('‚ö° [AUTH] Usuario en cach√©, mostrando sistemas...');
                    displayAccessibleSystems(cachedUser.systems, user);
                    return;
                }

                console.log('üì° [AUTH] Obteniendo sistemas para:', user.email);
                const userSystems = await getUserAccessibleSystems(user.email, user);
                
                AppCache.set(userCacheKey, {
                    systems: userSystems,
                    timestamp: Date.now()
                }, 30000);
                
                const newSession = {
                    user: {
                        email: user.email,
                        name: user.user_metadata?.full_name || user.email,
                        uid: user.id
                    },
                    systems: userSystems,
                    timestamp: new Date().toISOString()
                };
                
                AppSession.saveSession(newSession);
                
                setTimeout(() => {
                    AppSession.saveEssentialSessionData(user, userSystems[0])
                        .catch(err => console.warn('‚ö†Ô∏è [SESSION] No se pudo guardar en Supabase:', err));
                }, 1000);
                
                console.log('üéØ [AUTH] Mostrando sistemas para usuario...');
                displayAccessibleSystems(userSystems, user);
                
            } catch (error) {
                console.error('‚ùå [AUTH] Error procesando usuario:', error);
                
                if (error.code === 'USER_NOT_REGISTERED') {
                    showErrorScreen(user, {
                        code: 'USER_NOT_REGISTERED',
                        message: 'Usuario no registrado en el sistema'
                    });
                } else if (error.code === 'USER_DEACTIVATED') {
                    showErrorScreen(user, {
                        code: 'USER_DEACTIVATED', 
                        message: 'Cuenta desactivada'
                    });
                } else if (error.code === 'NO_SYSTEM_ACCESS') {
                    showNoAccessScreen(user);
                } else {
                    ErrorHandler.handle(error, 'User Systems Access', 'Error al verificar tus permisos');
                }
            } finally {
                window.isHandlingAuth = false;
                showLoadingOverlay(false);
            }
        }

        // Reemplazar la funci√≥n displayAccessibleSystems
        function displayAccessibleSystems(systems, user) {
            try {
                console.log('üé® [UI] Mostrando sistemas para usuario...');
                
                const userName = getUserDisplayName(user, systems);
                
                window.currentUserSystems = systems;
                
                const headerTitle = document.querySelector('.portal-header h1');
                const headerSubtitle = document.querySelector('.portal-header p');
                
                if (headerTitle) {
                    headerTitle.textContent = `¬°Hola, ${userName}!`;
                }
                
                if (headerSubtitle) {
                    headerSubtitle.innerHTML = `
                        <span class="system-count">Tienes acceso a <strong>${systems.length}</strong> sistema(s)</span>
                        <br>
                        <small class="instruction-subtitle">Haz clic en cualquier sistema para comenzar</small>
                    `;
                }
                
                // ‚úÖ MOSTRAR PERFIL Y SISTEMAS
                updateMainInterfaceForLoggedInUser(user, systems, userName);
                
                const systemsGrid = document.querySelector('.systems-grid');
                if (systemsGrid) {
                    systemsGrid.innerHTML = '';
                    
                    systems.forEach((system, index) => {
                        const systemCard = createSystemCard(system);
                        if (systemCard && systemCard.dataset) {
                            systemsGrid.appendChild(systemCard);
                        }
                    });
                    
                    systemsGrid.style.display = 'grid';
                }
                
            } catch (error) {
                console.error('‚ùå [UI] Error mostrando sistemas:', error);
                showToast('Error al cargar los sistemas', 'error');
            }
        }

        // Nueva funci√≥n para actualizar la interfaz principal
        function updateMainInterfaceForLoggedInUser(user, systems, userName) {
            const loginSection = document.querySelector('.login-section');
            
            if (!loginSection) return;
            
            loginSection.innerHTML = showUserProfile(user, systems);
            
            // Configurar event listeners para los botones del perfil
            setTimeout(() => {
                const btnCambiarPIN = document.getElementById('btnCambiarPIN');
                const btnInfoSistemas = document.getElementById('btnInfoSistemas');
                const btnCerrarSesion = document.getElementById('btnCerrarSesion');
                
                if (btnCambiarPIN) {
                    btnCambiarPIN.addEventListener('click', async () => {
                        const userData = await obtenerDatosUsuarioPorEmail(user.email);
                        if (userData) {
                            await GestionPIN.mostrarModalCambioPIN(
                                userData.id, 
                                user.email, 
                                userName
                            );
                        }
                    });
                }
                
                if (btnInfoSistemas) {
                    btnInfoSistemas.addEventListener('click', () => {
                        mostrarModalSistemasAccesibles(systems, userName);
                    });
                }
                
                if (btnCerrarSesion) {
                    btnCerrarSesion.addEventListener('click', async () => {
                        await handleLogout();
                    });
                }
            }, 100);
        }

        // ‚úÖ NUEVA FUNCI√ìN: Actualizar secci√≥n de login para usuarios autenticados
        function updateLoginSectionForLoggedInUser(user, systems, userName) {
            const loginSection = document.querySelector('.login-section');
            
            if (!loginSection) return;
            
            loginSection.innerHTML = `
                <div class="user-info-simplified">
                    <div class="user-header">
                        <div class="user-avatar-large" style="background: ${getAvatarColor(userName.charAt(0))}">
                            ${userName.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="user-welcome">${userName}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    </div>
                    
                    <div class="session-info">
                        <p><i class="fas fa-check-circle" style="color: var(--success-color);"></i> Sesi√≥n activa</p>
                        <small>${systems.length} sistema(s) disponible(s)</small>
                    </div>
                    
                    <button class="logout-btn-simplified" id="logoutBtnMain">
                        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
                    </button>
                </div>
                
                <div class="footer">
                    <p><i class="fas fa-lock"></i> Solo usuarios autorizados</p>
                </div>
            `;
            
            // Configurar el bot√≥n de logout
            setupLogoutButton();
        }

        // Agregar esta funci√≥n nueva
        function mostrarModalSistemasAccesibles(sistemas, nombreUsuario) {
            const modalHTML = `
                <div class="modal-sistemas" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: var(--card-bg);
                        padding: 2.5rem 2rem;
                        border-radius: 16px;
                        max-width: 600px;
                        width: 90%;
                        color: var(--text-color);
                        border: 1px solid var(--border-color);
                        box-shadow: var(--shadow-lg);
                    ">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(135deg, var(--secondary-color), var(--success-color));
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 1rem;
                                color: white;
                                font-size: 2rem;
                            ">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <h3 style="color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600;">
                                Sistemas Accesibles
                            </h3>
                            <p style="color: var(--text-muted); font-size: 0.95rem;">
                                ${nombreUsuario}, estos son tus sistemas autorizados
                            </p>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${sistemas.map(sistema => `
                                <div style="
                                    background: var(--bg-color);
                                    padding: 1.5rem;
                                    border-radius: 12px;
                                    margin-bottom: 1rem;
                                    border-left: 4px solid var(--primary-color);
                                    display: flex;
                                    align-items: center;
                                    gap: 1rem;
                                ">
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        background: var(--primary-color);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 1.2rem;
                                    ">
                                        <i class="${getSystemIcon(sistema.key)}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 0.25rem 0; color: var(--text-color); font-weight: 600;">
                                            ${sistema.name}
                                        </h4>
                                        <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                            Rol: <strong>${sistema.rol}</strong>
                                            ${sistema.fechaAsignacion ? `‚Ä¢ Asignado: ${new Date(sistema.fechaAsignacion).toLocaleDateString('es-PE')}` : ''}
                                        </p>
                                    </div>
                                    <div style="
                                        background: rgba(39, 174, 96, 0.1);
                                        color: var(--success-color);
                                        padding: 0.5rem 1rem;
                                        border-radius: 20px;
                                        font-size: 0.8rem;
                                        font-weight: 600;
                                    ">
                                        <i class="fas fa-check-circle"></i> Activo
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn-primary" id="btnCerrarSistemas" style="
                                padding: 1rem 2rem;
                                background: var(--primary-color);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                cursor: pointer;
                                font-weight: 600;
                            ">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const contenedorModal = document.createElement('div');
            contenedorModal.innerHTML = modalHTML;
            document.body.appendChild(contenedorModal);
            
            const btnCerrar = document.getElementById('btnCerrarSistemas');
            btnCerrar.addEventListener('click', () => {
                document.body.removeChild(contenedorModal);
            });
            
            contenedorModal.addEventListener('click', (e) => {
                if (e.target === contenedorModal) {
                    document.body.removeChild(contenedorModal);
                }
            });
        }

        // OBTENER NOMBRE PARA MOSTRAR
        function getUserDisplayName(user, systems) {           
            if (systems.length > 0 && systems[0].userData) {                
                if (systems[0].userData.nombre) {
                    return `${systems[0].userData.nombre} ${systems[0].userData.apellido || ''}`.trim();
                }
            }
            
            if (user.user_metadata?.full_name) {
                return user.user_metadata.full_name;
            }
            
            if (user.email) {
                const nameFromEmail = user.email.split('@')[0];
                const formattedName = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
                return formattedName;
            }

            return 'Usuario';
        }

        // CREAR TARJETA DE SISTEMA
        function createSystemCard(system) {
            try {
                console.log('üÉè [CARD] Creando tarjeta para:', system.name, system.key);
                
                const card = document.createElement('div');
                card.className = `system-card system-${system.key.split('sistema')[1]?.toLowerCase() || 'default'}`;
                
                card.setAttribute('data-system', system.key);
                card.dataset.system = system.key;
                
                card.innerHTML = `
                    <div class="system-icon">
                        <i class="${getSystemIcon(system.key)}"></i>
                    </div>
                    <h3>${system.name}</h3>
                    <div class="system-roles">
                        <span class="role-tag">
                            <i class="fas fa-user-tag"></i> ${system.rol}
                        </span>
                    </div>
                    <div class="access-indicator">
                        <i class="fas fa-check-circle"></i> Acceso permitido
                    </div>
                `;
                
                card.addEventListener('click', (event) => {
                    console.log('üñ±Ô∏è [CARD] Click directo en tarjeta:', system.name);
                    event.stopPropagation();
                    RedirectSystem.selectSystem(system, event);
                });
                
                console.log('‚úÖ [CARD] Tarjeta creada exitosamente:', {
                    name: system.name,
                    key: system.key,
                    element: card
                });
                
                return card;
                
            } catch (error) {
                console.error('‚ùå [CARD] Error cr√≠tico creando tarjeta:', error);
                
                const fallbackCard = document.createElement('div');
                fallbackCard.textContent = `Sistema: ${system.name}`;
                fallbackCard.className = 'system-card';
                fallbackCard.style.padding = '20px';
                fallbackCard.style.border = '2px solid red';
                
                fallbackCard.addEventListener('click', () => {
                    RedirectSystem.selectSystem(system, { target: fallbackCard });
                });
                
                return fallbackCard;
            }
        }

        // OBTENER ICONO DEL SISTEMA
        function getSystemIcon(systemKey) {
            const icons = {
                sistemaSuministro: 'fas fa-boxes',
                sistemaTicket: 'fas fa-ticket-alt',
                sistemaActivo: 'fas fa-laptop',
                sistemaDespacho: 'fas fa-shipping-fast'
            };
            return icons[systemKey] || 'fas fa-cube';
        }

        // MOSTRAR INFORMACI√ìN DEL USUARIO
        function displayUserInfo(user, systemCount = 0, displayName = '') {
            try {
                const userInfo = document.getElementById('userInfo');
                if (!userInfo) {
                    throw new Error('Elemento userInfo no encontrado en el DOM');
                }

                const userName = displayName || user.user_metadata?.full_name || user.email.split('@')[0] || 'Usuario';
                const avatarText = userName.charAt(0).toUpperCase();
                const avatarColor = getAvatarColor(avatarText);

                userInfo.innerHTML = `
                    <div class="user-header">
                        <div class="user-avatar-large" style="background: ${avatarColor}">
                            ${avatarText}
                        </div>
                        <div>
                            <div class="user-welcome" id="userWelcome">${userName}</div>
                            <div class="user-email" id="userEmail">${user.email}</div>
                        </div>
                    </div>
                    <h4><i class="fas fa-user-check"></i> Sesi√≥n activa</h4>
                    <div id="userDetails" style="display: none;"></div>
                    <button class="logout-btn" id="logoutBtnMain">
                        <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
                    </button>
                `;

                userInfo.style.display = 'block';
                setupLogoutButton();

            } catch (error) {
                console.error('Error en displayUserInfo:', error);
                ErrorHandler.handle(error, 'User Info Display', 'Error al mostrar informaci√≥n del usuario');
            }
        }

        // CONFIGURAR BOT√ìN DE LOGOUT
        function setupLogoutButton() {
            const logoutBtn = document.getElementById('logoutBtnMain');
            
            if (!logoutBtn) {
                console.warn('‚ö†Ô∏è [LOGOUT] Bot√≥n de logout no encontrado');
                return;
            }
            
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    await handleLogout();
                } catch (error) {
                    console.error('Error cerrando sesi√≥n:', error);
                    showToast('Error al cerrar sesi√≥n', 'error');
                }
            });
        }

        // MANEJAR LOGOUT
        async function handleLogout() {
            try {
                showLoadingOverlay(true, 'Cerrando sesi√≥n...');
                
                console.log('üö™ Iniciando cierre de sesi√≥n completo...');

                // ‚úÖ LIMPIAR MODALES AL CERRAR SESI√ìN
                limpiarTodosLosModales();
                
                // ‚úÖ 1. LIMPIAR TODAS LAS SESIONES LOCALES
                const sessionsToClear = [
                    'gm_direct_session',           // Sesi√≥n directa (por si acaso)
                    'sesion_pin_gm',               // Sesi√≥n PIN
                    'sb-auth-token',               // Token Supabase
                    'gm_user_session',             // Sesi√≥n AppSession
                    'current_user_systems_cache'   // Cach√© de sistemas
                ];
                
                sessionsToClear.forEach(session => {
                    localStorage.removeItem(session);
                    console.log(`üóëÔ∏è Limpiado: ${session}`);
                });
                
                // ‚úÖ 2. LIMPIAR CACH√â EN MEMORIA
                AppSession.clearSession();
                AppCache.clearByPattern('userSystems_');
                AppCache.clearByPattern('current_user_');
                
                // ‚úÖ 3. LIMPIAR VARIABLES GLOBALES
                window.currentUserSystems = null;
                window.isHandlingAuth = false;
                window.pendingRequests = {};
                
                // ‚úÖ 4. CERRAR SESI√ìN SUPABASE
                if (supabase) {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) {
                            console.warn('‚ö†Ô∏è Error cerrando sesi√≥n Supabase:', error);
                        } else {
                            console.log('‚úÖ Sesi√≥n Supabase cerrada');
                        }
                    } catch (supabaseError) {
                        console.warn('‚ö†Ô∏è Supabase no disponible para logout:', supabaseError);
                    }
                }
                
                // ‚úÖ 5. LIMPIAR INTERVALOS Y TIMERS
                if (AppState.sessionTimer) {
                    clearInterval(AppState.sessionTimer);
                    AppState.sessionTimer = null;
                }
                
                if (AppState.activityDebounce) {
                    clearTimeout(AppState.activityDebounce);
                    AppState.activityDebounce = null;
                }
                
                console.log('‚úÖ Todas las sesiones limpiadas');
                showToast('Sesi√≥n cerrada correctamente', 'success');
                
                // ‚úÖ 6. REDIRIGIR A LOGIN (NO SOLO RECARGAR)
                setTimeout(() => {
                    // En lugar de recargar, forzar estado de login
                    resetUIState();
                    showLoginScreen();
                    
                    // Opcional: limpiar URL si hay par√°metros de sesi√≥n
                    if (window.location.hash || window.location.search) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    
                    showLoadingOverlay(false);
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error en logout:', error);
                showToast('Error al cerrar sesi√≥n', 'error');
                
                // Forzar limpieza incluso con error
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            }
        }

        // OBTENER COLOR DE AVATAR
        function getAvatarColor(letter) {
            const colors = ['#CB3E2C'];
            const index = letter.charCodeAt(0) % colors.length;
            return colors[index];
        }

        // MOSTRAR PANTALLA DE LOGIN
        // En showLoginScreen(), asegurarse de que solo muestre el bot√≥n de PIN
        function showLoginScreen() {
            try {
                console.log('üë§ Mostrando pantalla de login...');
                
                resetUIState();
                
                const loginSection = document.querySelector('.login-section');
                
                if (!loginSection) {
                    console.error('‚ùå No se encontr√≥ la secci√≥n de login');
                    return;
                }
                
                loginSection.innerHTML = `
                    <div class="login-options">
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <div style="
                                width: 120px;
                                height: 120px;
                                background: var(--primary-color);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 2rem;
                                color: white;
                                font-size: 3rem;
                                box-shadow: var(--shadow-lg);
                            ">
                                <i class="fas fa-key"></i>
                            </div>
                        </div>
                        
                        <!-- Solo el bot√≥n de PIN -->
                        <button id="btnAccesoPIN" class="login-main-btn" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 1.5rem 2rem;
                            border-radius: 16px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: center;
                            width: 100%;
                            font-size: 1.3rem;
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 1rem;
                            box-shadow: var(--shadow-lg);
                            margin-bottom: 2rem;
                        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-xl)';" 
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-lg)';">
                            Acceder con tu correo y PIN
                        </button>
                        
                    </div>
                    
                    <div class="footer" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <p style="color: var(--text-muted); font-size: 0.9rem; text-align: center;">
                            <i class="fas fa-lock" style="margin-right: 0.5rem;"></i> 
                            Solo personal autorizado de Gallos M√°rmol puede acceder a los sistemas
                        </p>
                    </div>
                `;
                
                // Configurar solo el bot√≥n de PIN
                setTimeout(() => {
                    const btnAccesoPIN = document.getElementById('btnAccesoPIN');
                    if (btnAccesoPIN) {
                        btnAccesoPIN.addEventListener('click', async () => {
                            await AutenticacionPIN.inicializarLoginPIN();
                        });
                    }
                }, 100);
                
                // Deshabilitar tarjetas de sistema hasta login
                document.querySelectorAll('.system-card').forEach(card => {
                    card.classList.add('disabled');
                });
                
                console.log('‚úÖ Pantalla de login mostrada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en showLoginScreen:', error);
                // Fallback b√°sico
                const loginSection = document.querySelector('.login-section');
                if (loginSection) {
                    loginSection.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h3>Error al cargar las opciones de login</h3>
                            <button onclick="location.reload()" class="btn btn-primary">
                                Recargar P√°gina
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // MOSTRAR PANTALLA SIN ACCESO
        function showNoAccessScreen(user) {
            document.querySelector('.systems-grid').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'none';
            
            const loginSection = document.querySelector('.login-section');
            
            loginSection.innerHTML = `
                <div class="user-info">
                    <div class="user-header">
                        <div class="user-avatar-large" style="background: ${getAvatarColor(user.user_metadata?.full_name?.charAt(0) || 'U')}">
                            ${user.user_metadata?.full_name?.charAt(0) || 'U'}
                        </div>
                        <div>
                            <div class="user-welcome">Hola, ${user.user_metadata?.full_name || 'Usuario'}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    </div>
                    
                    <div class="no-access-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Sin acceso a sistemas</h3>
                        <p>Tu cuenta est√° autenticada pero no tienes permisos para acceder a ning√∫n sistema.</p>
                        <p class="support-text">Contacta al administrador para solicitar acceso.</p>
                        
                        <div class="access-details">
                            <small>
                                <i class="fas fa-info-circle"></i> 
                                Usuario: ${user.email}<br>
                                Estado: Autenticado pero sin permisos
                            </small>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="tryDifferentAccountBtn">
                            <i class="fas fa-user-plus"></i> Usar otra cuenta
                        </button>
                        <button class="logout-btn" id="logoutBtnNoAccess">
                            <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('tryDifferentAccountBtn').addEventListener('click', async () => {
                await handleTryDifferentAccount();
            });
            
            document.getElementById('logoutBtnNoAccess').addEventListener('click', () => {
                handleLogout();
            });
        }

        // MANEJAR CAMBIO DE CUENTA
        async function handleTryDifferentAccount() {
            try {
                showLoadingOverlay(true, 'Preparando para cambiar de cuenta...');
                
                await supabase.auth.signOut();
                AppSession.clearSession();
                AppCache.clearByPattern('userSystems_');
                
                document.querySelector('.login-section').innerHTML = `
                    <div class="retry-status">
                        <p>Preparando para nueva autenticaci√≥n...</p>
                    </div>
                `;
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                showLoginScreen();
                
                setTimeout(() => {
                    document.getElementById('loginBtn').click();
                }, 500);
                
            } catch (error) {
                console.error('Error cambiando cuenta:', error);
                showToast('Error al cambiar de cuenta', 'error');
                showLoginScreen();
            } finally {
                showLoadingOverlay(false);
            }
        }

        // MOSTRAR PANTALLA DE ERROR
        function showErrorScreen(user, error) {
            const loginSection = document.querySelector('.login-section');
            
            if (!loginSection) {
                console.error('‚ùå [ERROR] No se encontr√≥ el elemento login-section');
                return;
            }

            const errorConfig = {
                'USER_NOT_REGISTERED': {
                    title: 'Usuario No Registrado',
                    message: 'Tu cuenta de Google no est√° registrada en nuestros sistemas.',
                    action: 'Contacta al administrador para solicitar acceso.',
                    icon: 'fas fa-user-plus',
                    allowRetry: false,
                    type: 'app'
                },
                'USER_DEACTIVATED': {
                    title: 'Cuenta Desactivada', 
                    message: 'Tu cuenta ha sido desactivada en nuestros sistemas.',
                    action: 'Contacta al administrador para reactivar tu cuenta.',
                    icon: 'fas fa-user-slash',
                    allowRetry: false,
                    type: 'app'
                },
                'NO_SYSTEM_ACCESS': {
                    title: 'Sin Acceso a Sistemas',
                    message: 'No tienes permisos para acceder a ning√∫n sistema.',
                    action: 'Solicita los permisos necesarios al administrador.',
                    icon: 'fas fa-lock',
                    allowRetry: false,
                    type: 'app'
                }
            };

            const config = errorConfig[error.code] || {
                title: 'Error del Sistema',
                message: error.message || 'Ocurri√≥ un error inesperado en el sistema.',
                action: 'Por favor, intenta nuevamente o contacta al administrador.',
                icon: 'fas fa-exclamation-triangle',
                allowRetry: true,
                type: 'unknown'
            };

            const getErrorColor = (type) => {
                const colors = {
                    auth: '#e74c3c',
                    network: '#f39c12',
                    database: '#8e44ad',
                    permission: '#c0392b',
                    app: '#d35400',
                    unknown: '#2c3e50'
                };
                return colors[type] || colors.unknown;
            };

            const errorColor = getErrorColor(config.type);

            loginSection.innerHTML = `
                <div class="error-screen">
                    <div class="error-icon" style="color: ${errorColor}">
                        <i class="${config.icon}"></i>
                    </div>
                    
                    <h3 style="color: ${errorColor}">${config.title}</h3>
                    
                    <div class="error-message-content">
                        <p>${config.message}</p>
                    </div>
                    
                    <div class="error-action">
                        <p><i class="fas fa-lightbulb"></i> ${config.action}</p>
                    </div>

                    ${(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? `
                        <details class="error-details">
                            <summary><i class="fas fa-bug"></i> Detalles t√©cnicos (solo desarrollo)</summary>
                            <div class="error-details-content">
                                <p><strong>C√≥digo:</strong> ${error.code || 'N/A'}</p>
                                <p><strong>Mensaje:</strong> ${error.message || 'N/A'}</p>
                                <p><strong>Tipo:</strong> ${config.type}</p>
                                <p><strong>Timestamp:</strong> ${new Date().toLocaleString('es-PE')}</p>
                                ${user && user.email ? `<p><strong>Usuario:</strong> ${user.email}</p>` : ''}
                            </div>
                        </details>
                    ` : ''}

                    <div class="error-buttons">
                        ${config.allowRetry ? `
                            <button class="btn btn-primary" id="retryAuthBtn" style="background: ${errorColor}">
                                <i class="fas fa-redo"></i> Reintentar Autenticaci√≥n
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-secondary" id="logoutErrorBtn">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            `;

            if (config.allowRetry) {
                const retryBtn = document.getElementById('retryAuthBtn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîÑ [ERROR] Reintentando autenticaci√≥n...');
                        await handleRetryAuthentication();
                    });
                }
            }

            const logoutBtn = document.getElementById('logoutErrorBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üö™ [ERROR] Cerrando sesi√≥n desde pantalla de error...');
                    handleLogout();
                });
            }
        }

        // REINTENTAR AUTENTICACI√ìN
        async function handleRetryAuthentication() {
            try {
                showLoadingOverlay(true, 'Reintentando autenticaci√≥n...');
                
                const loginSection = document.querySelector('.login-section');
                loginSection.innerHTML = `
                    <div class="retry-status">
                        <div class="loading-spinner"></div>
                        <p>Reintentando conexi√≥n...</p>
                    </div>
                `;
                
                await supabase.auth.signOut();
                
                AppSession.clearSession();
                AppCache.clearByPattern('userSystems_');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await triggerGoogleLogin();
                
            } catch (error) {
                console.error('Error en reintento:', error);
                const user = (await supabase.auth.getUser()).data.user;
                showErrorScreen(user || {}, error);
            } finally {
                showLoadingOverlay(false);
            }
        }

        // LIMPIAR ESTADO DE LA UI
        function resetUIState() {
            console.log('üîÑ Reseteando estado de UI...');
            
            // ‚úÖ LIMPIAR INTERFAZ
            const systemsGrid = document.querySelector('.systems-grid');
            if (systemsGrid) {
                systemsGrid.style.display = 'none';
                systemsGrid.innerHTML = '';
            }
            
            const selectedSystemInfo = document.getElementById('selectedSystemInfo');
            if (selectedSystemInfo) {
                selectedSystemInfo.style.display = 'none';
            }
            
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.style.display = 'none';
                userInfo.innerHTML = '';
            }
            
            const loginSection = document.querySelector('.login-section');
            if (loginSection) {
                loginSection.innerHTML = ''; // Limpiar completamente
            }
            
            // ‚úÖ RESTAURAR HEADER ORIGINAL
            const portalHeader = document.querySelector('.portal-header');
            if (portalHeader) {
                const h1 = portalHeader.querySelector('h1');
                const p = portalHeader.querySelector('p');
                
                if (h1) h1.textContent = 'Gallos M√°rmol te da la bienvenida';
                if (p) p.textContent = 'Selecciona el sistema al que deseas acceder e inicia sesi√≥n con tu cuenta de Google';
            }
            
            // ‚úÖ HABILITAR TARJETAS DE SISTEMA (pero deshabilitadas hasta login)
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('selected');
                card.classList.add('disabled');
            });
            
            // ‚úÖ LIMPIAR ALMACENAMIENTO TEMPORAL
            sessionStorage.removeItem('lastSystemSelected');
            sessionStorage.removeItem('userDisplayState');
            
            console.log('‚úÖ UI reseteada completamente');
        }
        
        // TOGGLE TEMA
        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        // TOGGLE PANTALLA COMPLETA
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showToast('No se pudo activar el modo pantalla completa', 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // OCULTAR TOAST
        function hideToast() {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.classList.remove('show');
            }
        }

        // Configurar tema inicial
        if (AppState.darkMode) {
            document.body.classList.add('dark-mode');
            const icon = document.getElementById('themeToggle')?.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-sun';
            }
        }

        // Invalidar cach√© peri√≥dicamente
        setInterval(() => {
            AppCache.clearExpired();
        }, 5 * 60 * 1000);

        // ‚úÖ FUNCI√ìN GLOBAL PARA LIMPIAR TODOS LOS MODALES
        function limpiarTodosLosModales() {
            console.log('üßπ Limpiando todos los modales...');
            
            // Lista de clases de modales a limpiar
            const clasesModales = [
                '.modal-login-pin',
                '.modal-configurar-pin',
                '.modal-sin-pin',
                '.email-modal',
                '.direct-login-modal'
            ];
            
            clasesModales.forEach(selector => {
                const modales = document.querySelectorAll(selector);
                modales.forEach(modal => {
                    if (modal.parentNode) {
                        modal.parentNode.remove();
                    }
                });
                console.log(`   - Limpiados modales: ${selector}`);
            });
            
            // Limpiar por patrones de ID
            const patronesIds = [
                'modalLoginPIN_',
                'inputEmailPIN_', 
                'inputCodigoPIN_',
                'btnCancelarPIN_',
                'btnAccederPIN_'
            ];
            
            patronesIds.forEach(patron => {
                const elementos = document.querySelectorAll(`[id^="${patron}"]`);
                elementos.forEach(elemento => {
                    if (elemento.parentNode) {
                        elemento.parentNode.remove();
                    }
                });
            });
            
            // Limpiar registros globales
            window.modalesAbiertos.clear();
            window.modalLoginActual = null;
            
            console.log('‚úÖ Todos los modales limpiados');
        }        

    </script>
</body>

</html>

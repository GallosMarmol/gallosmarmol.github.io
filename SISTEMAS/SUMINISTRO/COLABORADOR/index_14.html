<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Suministro - Colaborador</title>
    <meta name="description" content="Sistema de gestión de productos para área de suministro de Gallos Mármol">
    <meta name="keywords" content="gallos mármol, productos, suministro, tickets">
    <meta name="author" content="Gallos Mármol">
    <link rel="icon" type="image/x-icon" href="../../FOTO/ICONO/Icono_01.ico">
    
    <!-- Librerías externas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Librería QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --danger-color: #e74c3c;
            --danger-light: #ec7063;
            --light-color: #ecf0f1;
            --light-gray: #f8f9fa;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #fff;
            --text-muted: #6c757d;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --header-height: 60px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #d68910;
            --warning-light: #f8c471;
            --danger-color: #cb4335;
            --danger-light: #ec7063;
            --light-color: #2c2c2c;
            --light-gray: #1e1e1e;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== ESTRUCTURA PRINCIPAL ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 1rem;
        }

        .login-card {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2rem 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #app {
            display: none;
            min-height: 100vh;
        }

        /* ===== HEADER MOBILE-FIRST ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 60%;
        }

        .logo-img {
            height: 40px;
            width: auto;
            border-radius: var(--border-radius-sm);
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle, .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover, .fullscreen-btn:hover {
            background-color: var(--light-color);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-info {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            background: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            display: inline-block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            padding-top: var(--header-height);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ===== NAVEGACIÓN POR PESTAÑAS ===== */
        .nav-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            font-size: 0.9rem;
            text-align: center;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== SECCIONES ===== */
        .generate-ticket-section {
            display: none;
        }

        .generate-ticket-section.active {
            display: block;
        }

        .section-title {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* ===== FORMULARIO DE NUEVO PRODUCTO ===== */
        .product-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Estilos para el modal mejorado */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .product-info-card {
            background: var(--light-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger-color);
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            gap: 0.75rem;
        }

        .info-item {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: start;
            gap: 0.5rem;
        }

        .info-item strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .product-code, .product-location {
            font-family: 'Monaco', 'Consolas', monospace;
            background: var(--card-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .warning-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .warning-message i {
            color: var(--danger-color);
            margin-top: 0.2rem;
        }

        .warning-message strong {
            color: var(--danger-color);
            display: block;
            margin-bottom: 0.25rem;
        }

        .warning-message p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: var(--light-color);
            color: var(--text-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .info-item {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }

        /* ===== LISTA DE PRODUCTOS ===== */
        .products-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            grid-column: 1 / -1;
        }

        .search-box .form-control {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.7;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .product-info h3 {
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .product-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .product-code {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            background-color: var(--primary-color);
            color: white;
        }

        .product-excerpt {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ===== MEJORA 1: ESTILOS PARA BÚSQUEDA Y FILTROS ===== */
        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .quick-filters {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .filters-header h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-size: 1rem;
        }

        .filters-header small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .filter-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
        }

        .filter-btn:hover {
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 3rem;
            overflow: hidden;
            line-height: 1.3;
        }

        /* Agregar al CSS existente */
        .editable-field {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 0.9rem;
            width: 100%;
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .editable-field.valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .editable-field.invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .editable-field:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Mensajes de error */
        .field-error {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        /* Indicadores de estado */
        .validation-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .valid .validation-indicator {
            color: var(--success-color);
        }

        .invalid .validation-indicator {
            color: var(--danger-color);
        }

        /* Grupo de campo con validación */
        .field-group {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .field-group .form-control {
            padding-right: 2rem;
        }

        /* ===== FILTROS MEJORADOS - MOBILE FIRST ===== */
        .location-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: end;
        }

        .location-filters .form-group {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .filter-count {
            background: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
        }

        .filter-count:empty {
            display: none;
        }

        .filter-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .filter-select:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .filter-select.available {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .filter-select.empty {
            border-color: var(--warning-color);
            background-color: rgba(243, 156, 18, 0.05);
        }

        /* Estados de los filtros */
        .filter-status {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .filter-status.available {
            color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }

        .filter-status.empty {
            color: var(--warning-color);
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .filter-status.disabled {
            color: var(--text-muted);
            background: rgba(108, 117, 125, 0.1);
            border: 1px solid rgba(108, 117, 125, 0.2);
        }

        /* Mejora visual para selects */
        .filter-select:not(:disabled) {
            background-color: var(--card-bg);
        }

        .filter-select:disabled {
            background-color: var(--light-color);
            opacity: 0.7;
        }

        /* Indicador de selección actual */
        .filter-select:valid {
            border-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Filtros activos mejorados */
        .active-filters {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .active-filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .active-filters-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .active-filters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .active-filter-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .active-filter-tag .remove-filter {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .active-filter-tag .remove-filter:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .location-filters {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .filter-group {
                gap: 0.75rem;
            }
            
            .filter-label {
                font-size: 0.85rem;
            }
            
            .filter-select {
                padding: 0.875rem;
                font-size: 1rem; /* Mejor para touch */
            }
            
            .active-filters-list {
                flex-direction: column;
                align-items: stretch;
            }
            
            .active-filter-tag {
                justify-content: space-between;
            }
            
            /* Agrupar botones en móvil */
            .filter-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .location-filters {
                gap: 0.5rem;
            }
            
            .filter-select {
                padding: 1rem;
            }
            
            .active-filters {
                padding: 0.75rem;
            }
        }

        /* Mejora para el contenedor de filtros */
        .filters-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filters-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .filters-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }



        /* ===== NUEVOS ESTILOS PARA CARDS ===== */
        .products-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            height: fit-content;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .product-code-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .product-row-number {
            background: var(--light-color);
            color: var(--text-muted);
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .product-description {
            margin-bottom: 1rem;
            flex-grow: 1;
        }

        .product-description textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            resize: vertical;
            transition: var(--transition);
        }

        .product-description textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-group {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .detail-value input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .detail-value input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .ubicacion-input {
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .ubicacion-breakdown {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            text-align: center;
        }

        .breakdown-item {
            display: flex;
            flex-direction: column;
        }

        .breakdown-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .breakdown-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.8rem;
        }

        .product-card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .card-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-pdf {
            background: var(--success-color);
            color: white;
        }

        .btn-pdf:hover {
            background: var(--success-light);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: var(--danger-light);
            transform: translateY(-1px);
        }

        .card-search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 2rem;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .products-cards-container {
                grid-template-columns: 1fr;
            }
            
            .product-details-grid {
                grid-template-columns: 1fr;
            }
            
            .breakdown-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== MEJORAS PARA FILTROS RÁPIDOS ===== */
        .filter-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .filter-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: inherit;
        }

        .filter-current {
            font-size: 0.7rem;
            background: var(--primary-color);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            font-weight: 600;
        }

        .filter-info {
            margin-top: 0.5rem;
        }

        .info-badge {
            background: var(--secondary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .active-filters {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--secondary-color);
        }

        .no-filters {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
        }

        .active-filters-list {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .active-filter-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .clear-all-filters {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: auto;
        }

        .clear-all-filters:hover {
            background: var(--danger-light);
        }

        /* ===== SISTEMA DE LOADING MEJORADO ===== */
        .pdf-generation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .pdf-generation-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pdf-generation-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--light-color) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .pdf-generation-header {
            margin-bottom: 2rem;
        }

        .pdf-generation-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pdf-generation-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .pdf-generation-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Barra de progreso animada */
        .pdf-progress-container {
            width: 100%;
            background: var(--light-color);
            border-radius: 100px;
            overflow: hidden;
            margin: 1.5rem 0;
            height: 8px;
            position: relative;
        }

        .pdf-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 100px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pdf-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.4), 
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .pdf-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .pdf-progress-percent {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pdf-progress-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Etapas del proceso */
        .pdf-steps {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
            position: relative;
        }

        .pdf-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .pdf-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .pdf-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-color);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .pdf-step.active .pdf-step-icon {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .pdf-step.completed .pdf-step-icon {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .pdf-step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .pdf-step.active .pdf-step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .pdf-step.completed .pdf-step-label {
            color: var(--success-color);
        }

        /* Animación de éxito */
        .pdf-success-animation {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% { 
                opacity: 0;
                transform: scale(0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.1);
            }
            100% { 
                transform: scale(1);
            }
        }

        /* Contador de productos */
        .pdf-counter {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
            animation: countPop 0.5s ease;
        }

        @keyframes countPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Mensajes de estado */
        .pdf-status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Estados de botones de filtro mejorados */
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 75, 107, 0.3);
            transform: translateY(-2px);
        }

        .filter-btn:not(.active):hover {
            border-color: var(--secondary-color);
            background: var(--light-color);
            transform: translateY(-1px);
        }

        /* ===== MEJORA 4: INDICADORES DE ATAJOS ===== */
        .search-container {
            position: relative;
        }

        .search-shortcut {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--light-color);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        /* Tooltip para atajos de teclado */
        [title*="Ctrl+"], [title*="Alt+"] {
            position: relative;
        }

        [title*="Ctrl+"]::after, [title*="Alt+"]::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        [title*="Ctrl+"]:hover::after, [title*="Alt+"]:hover::after {
            opacity: 1;
        }

        /* ===== PAGINACIÓN ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ===== BOTONES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-light);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-light);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* VERSIÓN MEJORADA PARA HEADERS COMPLEJOS */
        .preview-table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
        }

        .products-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9em;
        }

        .products-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .products-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            border-bottom: 2px solid var(--primary-light);
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Asegurar que las celdas tengan fondo sólido */
        .products-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            transition: background-color 0.2s ease;
        }

        .products-table tbody tr:hover td {
            background-color: rgba(0, 75, 107, 0.05);
        }

        /* Scrollbar styling */
        .preview-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .preview-table-container::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        .preview-table-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .preview-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s ease;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9);
                background-color: rgba(0,0,0,0); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                background-color: rgba(0,0,0,0.5); 
            }
        } 
        
        .modal.fade-out {
            animation: modalFadeOut 0.3s ease forwards;
        }

        .modal.fade-out .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }        

        @keyframes modalFadeOut {
            from { 
                opacity: 1; 
                background-color: rgba(0,0,0,0.5); 
            }
            to { 
                opacity: 0; 
                background-color: rgba(0,0,0,0); 
            }
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes modalSlideOut {
            from { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            to { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
        }

        
        .modal-header {
            padding: 1.5rem 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Mejoras para botones del modal */
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            opacity: 1;
            background-color: var(--light-color);
            transform: scale(1.1);
        }

        /* Estilos para el scroll del modal */
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-muted);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .toast-info {
            background-color: var(--secondary-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-text {
            font-size: 1.1rem;
        }

        .section-loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .section-loading.active {
            display: block;
        }

        /* ===== ESTADOS VACÍOS ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* ===== PERFIL ===== */
        .profile-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0 auto 1.5rem;
        }

        /* ===== ACCESIBILIDAD ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Estilos para el sistema de búsqueda */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--light-color);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-text strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .suggestion-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
        }

        .suggestion-meta code {
            font-size: 0.7rem;
            background: var(--light-color);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .history-chip {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-chip:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .scanned-product {
            border-left: 4px solid var(--success-color) !important;
        }

        .unscanned-product {
            border-left: 4px solid var(--warning-color) !important;
        }

        .active-filter {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-container {
                position: static;
            }
            
            .search-suggestions {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 50vh;
            }
        }

        /* ===== GENERAR TICKET ===== */
        .ticket-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .ticket-preview {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .ticket-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .ticket-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ticket-item {
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--secondary-color);
        }

        .ticket-qr {
            text-align: center;
            margin: 1.5rem 0;
        }

        .ticket-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-muted);
        }


        /* Estilos específicos para el modal masivo */
        .format-option-all {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid var(--border-color);
            cursor: pointer;
        }

        .format-option-all:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .format-option-all.selected {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05) !important;
            box-shadow: var(--shadow-sm);
        }

        .format-check-all {
            transition: all 0.3s ease;
            min-width: 20px;
            min-height: 20px;
        }

        .format-option-all.selected .format-check-all {
            background: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .format-option-all.selected .format-check-all i {
            display: block !important;
        }

        /* Mejoras para botones del modal */
        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .modal-footer .btn {
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Responsive para modal */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem) !important;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .format-option {
                padding: 1rem !important;
            }
            
            .format-option > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.75rem !important;
            }
        }

        /* MODAL SENCILLO Y ADAPTABLE */
        .simple-pdf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .simple-pdf-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .simple-modal {
            position: relative;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        .simple-pdf-modal.closing .simple-modal {
            animation: modalSlideOut 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
        }

        /* HEADER SENCILLO */
        .simple-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: var(--card-bg);
        }

        .header-title {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }

        .header-title h3 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-title p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-btn {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* BODY SENCILLO */
        .simple-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .format-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card-bg);
            position: relative;
        }

        .format-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .format-option.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .format-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .format-option:nth-child(2) .format-icon {
            background: var(--secondary-color);
        }

        .format-option:nth-child(3) .format-icon {
            background: var(--success-color);
        }

        .format-content {
            flex: 1;
        }

        .format-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .format-content p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .format-meta {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .format-meta.inventory {
            background: var(--success-color);
        }

        .format-check {
            flex-shrink: 0;
        }

        .check-circle {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: all 0.2s ease;
        }

        .check-circle.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .check-circle i {
            font-size: 0.8rem;
            color: transparent;
            transition: color 0.2s ease;
        }

        .check-circle.active i {
            color: white;
        }

        /* RESUMEN SENCILLO */
        .summary-section {
            background: var(--light-color);
            border-radius: 10px;
            padding: 1.25rem;
            border-left: 4px solid var(--primary-color);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .summary-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .summary-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1rem;
        }

        .format-selected {
            color: var(--success-color) !important;
        }

        /* FOOTER SENCILLO */
        .simple-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            background: var(--card-bg);
        }

        .simple-footer .btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-cancel {
            background: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color) !important;
        }

        .btn-cancel:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .btn-generate {
            background: var(--primary-color);
            color: white;
            position: relative;
        }

        .btn-generate:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* SCROLLBAR PARA MODO OSCURO/CLARO */
        .simple-body::-webkit-scrollbar {
            width: 6px;
        }

        .simple-body::-webkit-scrollbar-track {
            background: var(--light-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .simple-modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .simple-header {
                padding: 1.25rem;
            }
            
            .simple-body {
                padding: 1.25rem;
            }
            
            .format-option {
                padding: 1rem;
            }
            
            .simple-footer {
                padding: 1rem 1.25rem;
                flex-direction: column;
            }
            
            .simple-footer .btn {
                width: 100%;
            }
            
            .header-title {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .header-title i {
                margin-top: 0;
            }
        }

        /* MODO OSCURO AUTOMÁTICO */
        .dark-mode .simple-modal {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option.active {
            background: rgba(52, 152, 219, 0.1);
        }

        .dark-mode .summary-section {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .btn-cancel {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .close-btn {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        /* ===== FILTROS DE UBICACIÓN ===== */
        .location-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Responsive para tabla */
        @media (max-width: 768px) {
            .products-table {
                font-size: 0.8em;
            }
            
            .products-table th, .products-table td {
                padding: 8px;
            }
            
            .ticket-details {
                grid-template-columns: 1fr;
            }
            
            .location-filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h2>Gallos Mármol</h2>
                <p>Sistema de Suministros</p>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    <i class="fas fa-shield-alt"></i> Acceso restringido a empleados
                </div>
            </div>
            
            <div class="loading-spinner" id="loginLoading" style="display: none; margin: 1rem auto;"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Correo electrónico</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contraseña</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Iniciar sesión
                </button>
            </form>
            
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(52, 152, 219, 0.1); border-radius: var(--border-radius-sm);">
                <small style="color: var(--text-muted); display: block; text-align: center;">
                    <i class="fas fa-info-circle"></i> Solo para colaboradores autorizados.
                </small>
            </div>
            
            <p id="loginError" style="color: var(--danger-color); margin-top: 1rem; display: none; text-align: center;"></p>
        </div>
    </div>

    <!-- Aplicación principal -->
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <img src="../../FOTO/LOGO/Logo_01.webp" alt="Gallos Mármol" class="logo-img">
                </div>
                <div class="header-actions">
                    <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa" aria-label="Pantalla completa">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" title="Cambiar tema" aria-label="Cambiar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar" aria-haspopup="true" aria-expanded="false">C</div>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="user-info">
                                <div class="user-name" id="userName">Colaborador</div>
                                <span class="user-role" id="userRole">Colaborador</span>
                            </div>
                            <a href="#" class="dropdown-item logout" id="logoutBtn" role="menuitem">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="main-content">
            <div class="container">
                <!-- Navegación por pestañas -->
                <div class="nav-container">
                    <div class="nav-tabs" id="navTabs" role="tablist">
                        <button class="nav-tab active" data-tab="generateTicket" role="tab" aria-selected="true" aria-controls="generateTicketSection"><i class="fas fa-ticket-alt"></i> Generar Tickets</button>
                    </div>
                </div>

                <section class="generate-ticket-section active" id="generateTicketSection" role="tabpanel" aria-labelledby="generate-ticket-tab">
                    <div class="section-title">
                        <h2>Generar Tickets desde Excel</h2>
                        <small>Carga un archivo Excel para generar tickets individuales o masivos</small>
                    </div>

                    <!-- Paso 1: Cargar Archivo -->
                    <div class="upload-step" id="ticketUploadStep">
                        <div class="upload-area" id="ticketUploadArea" 
                            style="border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 3rem; text-align: center; margin-bottom: 2rem; cursor: pointer; transition: var(--transition);">
                            <i class="fas fa-file-excel" style="font-size: 3rem; color: var(--success-color); margin-bottom: 1rem;"></i>
                            <h3>Arrastra tu archivo Excel aquí</h3>
                            <p>Formato: CÓDIGO, DESCRIPCIÓN, UBICACIÓN, UNIDAD_MEDIDA</p>
                            <small style="color: var(--text-muted);">O haz clic para seleccionar archivo</small>
                            <input type="file" id="ticketFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        </div>
                        
                        <div class="template-download" style="text-align: center; margin-bottom: 2rem;">
                            <a href="#" class="btn btn-secondary" id="downloadTicketTemplateBtn">
                                <i class="fas fa-file-excel"></i> Descargar Plantilla
                            </a>
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
                                Plantilla Excel con formato predefinido
                            </small>
                        </div>
                    </div>

                    <!-- Paso 2: Previsualización y Edición -->
                    <div class="preview-step" id="ticketPreviewStep" style="display: none;">
                        <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h3>Previsualización de Productos</h3>
                                <p style="margin: 0; color: var(--text-muted);" id="productsCount">0 productos cargados</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="backToUploadTicketBtn">
                                    <i class="fas fa-arrow-left"></i> Cambiar Archivo
                                </button>
                                <button class="btn btn-success" id="generateAllPdfBtn">
                                    <i class="fas fa-file-pdf"></i> Generar PDF de Todos
                                </button>
                            </div>
                        </div>

                        <!-- Filtros de Ubicación -->
                        <div class="filters-container">
                            <div class="filters-header">
                                <h4 class="filters-title">Filtros de Ubicación</h4>
                                <div class="filters-actions">
                                    <button class="btn btn-secondary btn-small" id="clearFiltersBtn">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                </div>
                            </div>

                            <div class="location-filters">
                                <!-- Bloque (independiente) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Bloque</span>
                                        <span class="filter-count" id="bloqueCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterBloque">
                                        <option value="">Todos los bloques</option>
                                    </select>
                                    <div class="filter-status disabled"  id="bloqueStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un bloque
                                    </div>
                                </div>

                                <!-- Lado (depende de Bloque) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Lado</span>
                                        <span class="filter-count" id="ladoCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterLado" disabled>
                                        <option value="">Selecciona bloque primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="ladoStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un bloque
                                    </div>
                                </div>

                                <!-- N° Bloque (depende de Lado) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>N° Bloque</span>
                                        <span class="filter-count" id="numeroBloqueCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterNumeroBloque" disabled>
                                        <option value="">Selecciona lado primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="numeroBloqueStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un lado
                                    </div>
                                </div>

                                <!-- Nivel (depende de N° Bloque) -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Nivel</span>
                                        <span class="filter-count" id="nivelCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterNivel" disabled>
                                        <option value="">Selecciona número primero</option>
                                    </select>
                                    <div class="filter-status disabled" id="nivelStatus">
                                        <i class="fas fa-info-circle"></i> Selecciona un número
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Búsqueda -->
                        <div class="search-box" style="margin-bottom: 1.5rem;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="ticketSearchInput" placeholder="Buscar por código, descripción...">
                        </div>

                        <!-- Contenedor de Cards de Productos -->
                        <div class="products-cards-container" id="ticketProductsCardsContainer">
                            <!-- Los productos cargados del Excel se mostrarán aquí como cards -->
                        </div>

                        <!-- Paginación -->
                        <div class="pagination" id="ticketPaginationContainer">
                            <button class="pagination-btn" id="ticketPrevPageBtn" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="pagination-info" id="ticketPaginationInfo">Página 1 de 1</span>
                            <button class="pagination-btn" id="ticketNextPageBtn" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Botón flotante para volver al inicio -->
    <button class="floating-action-button" id="scrollToTopBtn" aria-label="Volver al inicio">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast notifications -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Operación completada con éxito</span>
        <button class="toast-close" aria-label="Cerrar notificación">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Overlay de Generación de PDF -->
    <div class="pdf-generation-overlay" id="pdfGenerationOverlay">
        <div class="pdf-generation-card">
            <div class="pdf-generation-header">
                <div class="pdf-generation-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h2 class="pdf-generation-title" id="pdfGenerationTitle">Generando PDF</h2>
                <p class="pdf-generation-subtitle" id="pdfGenerationSubtitle">Preparando documentos...</p>
            </div>

            <!-- Contador de productos -->
            <div class="pdf-counter" id="pdfCounter">
                <span id="pdfCurrentCount">0</span> de <span id="pdfTotalCount">0</span> productos
            </div>

            <!-- Barra de progreso -->
            <div class="pdf-progress-text">
                <span>Progreso</span>
                <span class="pdf-progress-percent" id="pdfProgressPercent">0%</span>
            </div>
            <div class="pdf-progress-container">
                <div class="pdf-progress-bar" id="pdfProgressBar"></div>
            </div>
            <div class="pdf-progress-stats" id="pdfProgressStats">
                Iniciando proceso...
            </div>

            <!-- Etapas del proceso -->
            <div class="pdf-steps">
                <div class="pdf-step completed" id="step1">
                    <div class="pdf-step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="pdf-step-label">Preparando</span>
                </div>
                <div class="pdf-step" id="step2">
                    <div class="pdf-step-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span class="pdf-step-label">Generando</span>
                </div>
                <div class="pdf-step" id="step3">
                    <div class="pdf-step-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <span class="pdf-step-label">Códigos QR</span>
                </div>
                <div class="pdf-step" id="step4">
                    <div class="pdf-step-icon">
                        <i class="fas fa-save"></i>
                    </div>
                    <span class="pdf-step-label">Guardando</span>
                </div>
            </div>

            <!-- Mensajes de estado -->
            <div class="pdf-status-message" id="pdfStatusMessage">
                <i class="fas fa-info-circle"></i>
                <span id="pdfStatusText">Inicializando generación de PDF...</span>
            </div>

            <!-- Botón de cancelar (opcional) -->
            <button class="btn btn-secondary btn-small" id="cancelPdfGeneration" style="margin-top: 1rem;">
                <i class="fas fa-times"></i> Cancelar Generación
            </button>
        </div>
    </div>    

    <script>
        // ===== CONFIGURACIÓN DE SUPABASE =====
        const SUPABASE_URL = 'https://fzdwqkoporxnzvhpmlls.supabase.co'; // Reemplaza con tu URL de Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6ZHdxa29wb3J4bnp2aHBtbGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDkxMDYsImV4cCI6MjA3NzM4NTEwNn0.nOS3oByMmopchYhH0Kv1I0lxi02VkqfsC-eGFTZ_ePg'; // Reemplaza con tu clave anónima de Supabase
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== ESTADO DE LA APLICACIÓN =====
        const TicketExcelState = {
            currentStep: 'upload',
            products: [], // Productos cargados del Excel
            filteredProducts: [], // Productos filtrados
            fileData: null,
            pagination: {
                currentPage: 1,
                itemsPerPage: 9,
                totalPages: 1,
                totalItems: 0
            },
            filters: {
                search: '',
                bloque: '',
                lado: '',
                numeroBloque: '',
                nivel: '',
                // Nuevo estado para opciones disponibles
                availableOptions: {
                    lados: [],
                    numerosBloque: [],
                    niveles: []
                }
            }
        };

        const AppState = {
            isLoading: false,
            userData: null,
            supabaseLoaded: true,
            currentUser: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            currentTab: 'generateTicket',
            pagination: {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1,
                totalItems: 0
            }
        };

        // ===== SISTEMA DE VALIDACIÓN MEJORADO =====
        const FieldValidators = {
            // Validación para descripción
            descripcion: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La descripción es requerida'
                        };
                    }
                    
                    if (value.length < 3) {
                        return {
                            isValid: false,
                            error: 'La descripción debe tener al menos 3 caracteres'
                        };
                    }
                    
                    if (value.length > 200) {
                        return {
                            isValid: false,
                            error: 'La descripción no puede exceder 200 caracteres'
                        };
                    }
                    
                    // Validar caracteres permitidos
                    const invalidChars = /[<>{}[\]]/;
                    if (invalidChars.test(value)) {
                        return {
                            isValid: false,
                            error: 'La descripción contiene caracteres no permitidos'
                        };
                    }
                    
                    return {
                        isValid: true,
                        error: null
                    };
                },
                
                format: (value) => {
                    // Capitalizar primera letra de cada palabra
                    return value.toString().trim()
                        .toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase())
                        .replace(/\s+/g, ' ');
                }
            },
            
            // Validación para ubicación
            ubicacion: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La ubicación es requerida'
                        };
                    }
                    
                    // Validar longitud exacta de 7 caracteres
                    if (value.length !== 7) {
                        return {
                            isValid: false,
                            error: 'La ubicación debe tener exactamente 7 caracteres'
                        };
                    }
                    
                    // Validar formato: A1D0101
                    const ubicacionRegex = /^[A-Z][0-9A-Z][A-Z][0-9]{2}[0-9]{2}$/;
                    if (!ubicacionRegex.test(value)) {
                        return {
                            isValid: false,
                            error: 'Formato inválido. Use: A1D0101 (Ej: B2E0302)'
                        };
                    }
                    
                    // Validar componentes individuales
                    const bloque = value.substring(0, 2);
                    const lado = value.substring(2, 3);
                    const numeroBloque = value.substring(3, 5);
                    const nivel = value.substring(5, 7);
                    
                    if (!/^[A-Z][0-9A-Z]$/.test(bloque)) {
                        return {
                            isValid: false,
                            error: 'Bloque inválido (Ej: A1, B2)'
                        };
                    }
                    
                    if (!/^[A-Z]$/.test(lado)) {
                        return {
                            isValid: false,
                            error: 'Lado inválido (debe ser una letra A-Z)'
                        };
                    }
                    
                    if (!/^\d{2}$/.test(numeroBloque)) {
                        return {
                            isValid: false,
                            error: 'Número de bloque inválido (debe ser 2 dígitos)'
                        };
                    }
                    
                    if (!/^\d{2}$/.test(nivel)) {
                        return {
                            isValid: false,
                            error: 'Nivel inválido (debe ser 2 dígitos)'
                        };
                    }
                    
                    return {
                        isValid: true,
                        error: null,
                        parsed: {
                            bloque,
                            lado,
                            numeroBloque,
                            nivel
                        }
                    };
                },
                
                format: (value) => {
                    return value.toString().trim().toUpperCase().replace(/\s+/g, '');
                }
            },
            
            // Validación para unidad de medida
            unidadMedida: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La unidad de medida es requerida'
                        };
                    }
                    
                    if (value.length > 10) {
                        return {
                            isValid: false,
                            error: 'La unidad no puede exceder 10 caracteres'
                        };
                    }
                                        
                    return {
                        isValid: true,
                        error: null,
                    };
                },
                
                format: (value) => {
                    return value.toString().trim().toUpperCase();
                }
            }
        };

        // ===== FUNCIONES DE VALIDACIÓN EN TIEMPO REAL =====
        function setupRealTimeValidation() {
            console.log('🔧 Configurando validación en tiempo real...');
            
            // Validación para campo descripción
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('editable-field')) {
                    const field = e.target;
                    const fieldName = field.getAttribute('data-field');
                    validateFieldInRealTime(field, fieldName);
                }
            });
            
            // Validación específica para ubicación con formato automático
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('ubicacion-input')) {
                    formatUbicacionInput(e.target);
                    validateFieldInRealTime(e.target, 'ubicacion');
                }
            });
            
            // Validación al perder el foco (para guardar)
            document.addEventListener('blur', function(e) {
                if (e.target.classList.contains('editable-field')) {
                    const field = e.target;
                    const fieldName = field.getAttribute('data-field');
                    const validation = validateField(fieldName, field.value);
                    
                    if (validation.isValid) {
                        saveFieldValue(field);
                    }
                }
            }, true);
        }

        console.log('✅ Módulo de event listeners con validación cargado');

        function validateFieldInRealTime(field, fieldName) {
            const value = field.value;
            const validation = FieldValidators[fieldName].validate(value);
            
            // Remover estados anteriores
            field.classList.remove('valid', 'invalid');
            
            // Ocultar mensajes de error anteriores
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }
            
            // Aplicar formato si es válido
            if (validation.isValid && FieldValidators[fieldName].format) {
                const formattedValue = FieldValidators[fieldName].format(value);
                if (formattedValue !== value) {
                    field.value = formattedValue;
                }
            }
            
            // Aplicar estado visual
            if (value === '') {
                // Estado neutral cuando está vacío
                return;
            }
            
            if (validation.isValid) {
                field.classList.add('valid');
                
                // Mostrar advertencia si existe
                if (validation.warning) {
                    showFieldWarning(field, validation.warning);
                }
            } else {
                field.classList.add('invalid');
                showFieldError(field, validation.error);
            }
        }

        function validateField(fieldName, value) {
            if (!FieldValidators[fieldName]) {
                return { isValid: true, error: null };
            }
            
            return FieldValidators[fieldName].validate(value);
        }

        function validateAllFieldsBeforePdf() {
            console.log('🔍 Validando todos los campos antes de generar PDF...');
            
            let allValid = true;
            const invalidProducts = [];
            
            TicketExcelState.products.forEach(product => {
                const errors = [];
                // ✅ ELIMINAR: const warnings = [];
                
                // Validar descripción
                const descValidation = FieldValidators.descripcion.validate(product.descripcion);
                if (!descValidation.isValid) {
                    errors.push(`Descripción: ${descValidation.error}`);
                }
                
                // Validar ubicación
                const ubiValidation = FieldValidators.ubicacion.validate(product.ubicacion);
                if (!ubiValidation.isValid) {
                    errors.push(`Ubicación: ${ubiValidation.error}`);
                }
                
                // Validar unidad de medida - SOLO ERRORES, SIN WARNINGS
                const unidadValidation = FieldValidators.unidadMedida.validate(product.unidadMedida);
                if (!unidadValidation.isValid) {
                    errors.push(`Unidad: ${unidadValidation.error}`);
                }
                // ✅ ELIMINADO: else if (unidadValidation.warning) para warnings
                
                // Validación general para PDF
                const pdfValidation = validateProductForPdf(product);
                if (!pdfValidation.isValid) {
                    errors.push(`PDF: ${pdfValidation.error}`);
                }
                
                if (errors.length > 0) { // ✅ ELIMINAR: || warnings.length > 0
                    allValid = false;
                    invalidProducts.push({
                        codigo: product.codigo,
                        descripcion: product.descripcion,
                        errors: errors,
                        // ✅ ELIMINAR: warnings: warnings,
                        rowNumber: product.rowNumber
                    });
                }
            });
            
            return {
                allValid: allValid,
                invalidProducts: invalidProducts,
                totalProducts: TicketExcelState.products.length,
                validProducts: TicketExcelState.products.length - invalidProducts.length
            };
        }

        function validateAllProducts() {
            const validationResult = validateAllFieldsBeforePdf();
            
            if (validationResult.allValid) {
                showToast(`✅ Todos los ${validationResult.totalProducts} productos son válidos`, 'success');
            } else {
                showValidationErrorsModal(validationResult.invalidProducts, false);
            }
        }

        function showValidationErrorsModal(invalidProducts, isForPdf = true) {
            console.log('🚨 Mostrando modal de errores de validación:', invalidProducts);
            
            // ✅ CERRAR MODALES EXISTENTES PRIMERO
            const existingModal = document.getElementById('validationErrorsModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHtml = `
                <div class="modal" id="validationErrorsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3 style="margin: 0; color: var(--danger-color);">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ${isForPdf ? 'Errores de Validación - PDF' : 'Productos con Errores'}
                            </h3>
                            <button class="close-modal" id="closeValidationModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="warning-message">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>Se encontraron ${invalidProducts.length} productos con errores</strong>
                                    <p>${isForPdf ? 'Corrige los siguientes errores antes de generar el PDF:' : 'Revisa los siguientes productos:'}</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; max-height: 400px; overflow-y: auto;">
                                <div class="products-list">
                                    ${invalidProducts.map(product => `
                                        <div class="product-card" style="border-left: 4px solid var(--danger-color);">
                                            <div class="product-header">
                                                <div class="product-info">
                                                    <h4 style="margin: 0; color: var(--danger-color);">
                                                        ${product.codigo} 
                                                        <small style="color: var(--text-muted);">(Fila ${product.rowNumber})</small>
                                                    </h4>
                                                    <p style="margin: 0.25rem 0; color: var(--text-color); font-size: 0.9rem;">
                                                        ${product.descripcion}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            ${product.errors.length > 0 ? `
                                                <div style="margin: 1rem 0;">
                                                    <strong style="color: var(--danger-color); font-size: 0.9rem;">
                                                        <i class="fas fa-times-circle"></i> Errores:
                                                    </strong>
                                                    <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--danger-color); font-size: 0.85rem;">
                                                        ${product.errors.map(error => `<li>${error}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light-color); border-radius: var(--border-radius);">
                                <strong>Sugerencias:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                    <li>Revisa los campos marcados en <span style="color: var(--danger-color);">rojo</span> en la lista</li>
                                    <li>La ubicación debe tener formato: <code>A1D0101</code> (7 caracteres exactos)</li>
                                    <li>La descripción debe tener entre 3 y 200 caracteres</li>
                                    <li>La unidad de medida puede ser cualquier texto (máx. 10 caracteres)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelValidationBtn">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                            ${isForPdf ? `
                                <button class="btn btn-primary" id="goToFirstErrorBtn">
                                    <i class="fas fa-arrow-right"></i> Ir al Primer Error
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // ✅ INSERTAR MODAL EN EL DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ✅ CONFIGURAR EVENT LISTENERS CON DELEGACIÓN CORRECTA
            setupValidationModalEvents(invalidProducts, isForPdf);
        }

        function setupValidationModalEvents(invalidProducts, isForPdf) {
            const modal = document.getElementById('validationErrorsModal');
            
            if (!modal) {
                console.error('❌ Modal no encontrado para configurar eventos');
                return;
            }
            
            // ✅ 1. Cerrar con el botón X
            const closeButton = document.getElementById('closeValidationModal');
            if (closeButton) {
                closeButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('❌ Cerrando modal con botón X');
                    closeValidationModal();
                });
            }
            
            // ✅ 2. Cerrar con botón Cancelar
            const cancelButton = document.getElementById('cancelValidationBtn');
            if (cancelButton) {
                cancelButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('❌ Cerrando modal con botón Cancelar');
                    closeValidationModal();
                });
            }
            
            // ✅ 3. Cerrar haciendo click fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    console.log('❌ Cerrando modal con click fuera');
                    closeValidationModal();
                }
            });
            
            // ✅ 4. Botón "Ir al Primer Error" (solo para PDF)
            if (isForPdf) {
                const goToErrorButton = document.getElementById('goToFirstErrorBtn');
                if (goToErrorButton) {
                    goToErrorButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🎯 Navegando al primer error');
                        closeValidationModal();
                        
                        // Navegar al primer producto con error
                        if (invalidProducts.length > 0) {
                            const firstErrorProduct = invalidProducts[0];
                            navigateToProduct(firstErrorProduct.codigo);
                        }
                    });
                }
            }
            
            // ✅ 5. Cerrar con tecla Escape
            const handleEscapeKey = function(e) {
                if (e.key === 'Escape') {
                    console.log('❌ Cerrando modal con Escape');
                    closeValidationModal();
                    document.removeEventListener('keydown', handleEscapeKey);
                }
            };
            
            document.addEventListener('keydown', handleEscapeKey);
            
            // ✅ FUNCIÓN PARA CERRAR EL MODAL
            function closeValidationModal() {
                if (modal && modal.parentNode) {
                    modal.style.opacity = '0';
                    setTimeout(() => {
                        modal.remove();
                        document.removeEventListener('keydown', handleEscapeKey);
                    }, 300);
                }
            }
        }

        function navigateToProduct(codigo) {
            console.log(`🎯 Navegando al producto: ${codigo}`);
            
            // Encontrar el producto por código
            const productIndex = TicketExcelState.products.findIndex(p => p.codigo === codigo);
            if (productIndex === -1) {
                console.error('❌ Producto no encontrado:', codigo);
                showToast('Producto no encontrado', 'error');
                return;
            }
            
            // Calcular en qué página está el producto
            const itemsPerPage = TicketExcelState.pagination.itemsPerPage;
            const targetPage = Math.floor(productIndex / itemsPerPage) + 1;
            
            console.log(`📄 Navegando a página ${targetPage} para producto ${codigo}`);
            
            // Navegar a la página
            TicketExcelState.pagination.currentPage = targetPage;
            renderTicketProductsTable();
            
            // Resaltar el producto después de renderizar
            setTimeout(() => {
                const product = TicketExcelState.products[productIndex];
                const productCard = document.querySelector(`[data-id="${product.id}"]`);
                
                if (productCard) {
                    // Scroll suave al producto
                    productCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                    
                    // Efecto de resaltado
                    productCard.style.transition = 'all 0.5s ease';
                    productCard.style.boxShadow = '0 0 0 3px var(--warning-color)';
                    productCard.style.transform = 'scale(1.02)';
                    
                    setTimeout(() => {
                        productCard.style.boxShadow = '';
                        productCard.style.transform = '';
                    }, 3000);
                    
                    console.log('✅ Producto resaltado correctamente');
                } else {
                    console.warn('⚠️ No se pudo encontrar la card del producto en el DOM');
                }
            }, 800); // Dar tiempo suficiente para que se renderice
        }

        function closeAnyModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('fade-out');
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.add('fade-out');
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            });
        }

        // ===== FUNCIONES PARA FILTROS DEPENDIENTES =====
        function updateAvailableFilterOptions() {
            console.log('🔄 Actualizando opciones disponibles para filtros...');
            
            const { bloque, lado, numeroBloque } = TicketExcelState.filters;
            const products = TicketExcelState.products;
            
            // Resetear opciones disponibles
            TicketExcelState.filters.availableOptions = {
                lados: [],
                numerosBloque: [],
                niveles: []
            };
            
            // ✅ CORRECCIÓN: Filtrar productos de manera incremental
            let filteredForLados = products;
            let filteredForNumeros = products;
            let filteredForNiveles = products;
            
            // Para Lados: filtrar solo por Bloque
            if (bloque) {
                filteredForLados = filteredForLados.filter(p => p.bloque === bloque);
            }
            
            // Para Números: filtrar por Bloque + Lado
            if (bloque) {
                filteredForNumeros = filteredForNumeros.filter(p => p.bloque === bloque);
            }
            if (lado) {
                filteredForNumeros = filteredForNumeros.filter(p => p.lado === lado);
            }
            
            // Para Niveles: filtrar por Bloque + Lado + Número
            if (bloque) {
                filteredForNiveles = filteredForNiveles.filter(p => p.bloque === bloque);
            }
            if (lado) {
                filteredForNiveles = filteredForNiveles.filter(p => p.lado === lado);
            }
            if (numeroBloque) {
                filteredForNiveles = filteredForNiveles.filter(p => p.numeroBloque === numeroBloque);
            }
            
            // ✅ CORRECCIÓN: Obtener opciones únicas de cada conjunto filtrado
            const ladosSet = new Set();
            const numerosBloqueSet = new Set();
            const nivelesSet = new Set();
            
            filteredForLados.forEach(product => {
                if (product.lado) ladosSet.add(product.lado);
            });
            
            filteredForNumeros.forEach(product => {
                if (product.numeroBloque) numerosBloqueSet.add(product.numeroBloque);
            });
            
            filteredForNiveles.forEach(product => {
                if (product.nivel) nivelesSet.add(product.nivel);
            });
            
            // Actualizar estado
            TicketExcelState.filters.availableOptions.lados = Array.from(ladosSet).sort();
            TicketExcelState.filters.availableOptions.numerosBloque = Array.from(numerosBloqueSet).sort((a, b) => a - b);
            TicketExcelState.filters.availableOptions.niveles = Array.from(nivelesSet).sort((a, b) => a - b);
            
            console.log('📊 Opciones disponibles:', {
                lados: TicketExcelState.filters.availableOptions.lados,
                numeros: TicketExcelState.filters.availableOptions.numerosBloque,
                niveles: TicketExcelState.filters.availableOptions.niveles
            });
        }

        // ===== FUNCIÓN PARA FORMATEAR VALORES EN SELECTS =====
        function formatFilterValue(value, filterType) {
            if (!value) return '';
            
            // ✅ SOLUCIÓN: Retornar solo el valor, sin etiquetas
            switch(filterType) {
                case 'bloque':
                    return value; // Ej: "A1" (sin "Bloque ")
                case 'lado':
                    return value; // Ej: "D" (sin "Lado ")
                case 'numeroBloque':
                    return value; // Ej: "01" (sin "N° ")
                case 'nivel':
                    return value; // Ej: "01" (sin "Nivel ")
                default:
                    return value;
            }
        }

        // ===== FUNCIÓN MEJORADA PARA ACTUALIZAR SELECTS =====
        function updateFilterSelects() {
            console.log('🎛️ Actualizando selects de filtros...');
            
            const { bloque, lado, numeroBloque, nivel, availableOptions } = TicketExcelState.filters;
            
            // 1. Select de Lados (depende de Bloque)
            const ladoSelect = document.getElementById('ticketFilterLado');
            if (ladoSelect) {
                const options = availableOptions.lados;
                
                // ✅ USAR formatFilterValue para los valores
                const formattedOptions = options.map(opt => ({
                    value: opt,
                    text: formatFilterValue(opt, 'lado')
                }));
                
                updateSelectOptions(ladoSelect, formattedOptions, {
                    placeholder: bloque ? 'Todos los lados' : 'Selecciona bloque primero',
                    allowEmpty: true,
                    formatFunction: (opt) => opt.text // Usar el texto formateado
                });
                
                ladoSelect.disabled = !bloque || options.length === 0;
                
                // Actualizar estado visual
                updateFilterStatus('lado', options.length, bloque);
            }
            
            // 2. Select de Números de Bloque (depende de Lado)
            const numeroBloqueSelect = document.getElementById('ticketFilterNumeroBloque');
            if (numeroBloqueSelect) {
                const options = availableOptions.numerosBloque;
                
                const formattedOptions = options.map(opt => ({
                    value: opt,
                    text: formatFilterValue(opt, 'numeroBloque')
                }));
                
                updateSelectOptions(numeroBloqueSelect, formattedOptions, {
                    placeholder: lado ? 'Todos los números' : 'Selecciona lado primero',
                    allowEmpty: true,
                    formatFunction: (opt) => opt.text
                });
                
                numeroBloqueSelect.disabled = !lado || options.length === 0;
                
                updateFilterStatus('numeroBloque', options.length, lado);
            }
            
            // 3. Select de Niveles (depende de Número de Bloque)
            const nivelSelect = document.getElementById('ticketFilterNivel');
            if (nivelSelect) {
                const options = availableOptions.niveles;
                
                const formattedOptions = options.map(opt => ({
                    value: opt,
                    text: formatFilterValue(opt, 'nivel')
                }));
                
                updateSelectOptions(nivelSelect, formattedOptions, {
                    placeholder: numeroBloque ? 'Todos los niveles' : 'Selecciona número primero',
                    allowEmpty: true,
                    formatFunction: (opt) => opt.text
                });
                
                nivelSelect.disabled = !numeroBloque || options.length === 0;
                
                updateFilterStatus('nivel', options.length, numeroBloque);
            }
            
            // Actualizar contadores
            updateFilterLabels();
        }

        // ===== FUNCIÓN PARA ACTUALIZAR ESTADOS VISUALES =====
        function updateFilterStatus(filterType, optionsCount, parentSelected) {
            const statusElement = document.getElementById(`${filterType}Status`);
            if (!statusElement) return;
            
            // Remover clases anteriores
            statusElement.className = 'filter-status';
            
            if (!parentSelected) {
                statusElement.className += ' disabled';
                statusElement.innerHTML = `<i class="fas fa-info-circle"></i> Selecciona ${getParentFilterName(filterType)} primero`;
            } else if (optionsCount === 0) {
                statusElement.className += ' empty';
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> No hay opciones disponibles`;
            } else {
                statusElement.className += ' available';
                statusElement.innerHTML = `<i class="fas fa-check-circle"></i> ${optionsCount} opción(es) disponible(s)`;
            }
        }

        function getParentFilterName(filterType) {
            switch(filterType) {
                case 'lado': return 'un bloque';
                case 'numeroBloque': return 'un lado';
                case 'nivel': return 'un número';
                default: return 'filtro padre';
            }
        }

        function updateFilterLabels() {
            const { availableOptions } = TicketExcelState.filters;
            
            // Actualizar contadores numéricos
            const ladoCount = document.getElementById('ladoCount');
            const numeroCount = document.getElementById('numeroBloqueCount');
            const nivelCount = document.getElementById('nivelCount');
            
            if (ladoCount) {
                ladoCount.textContent = availableOptions.lados.length > 0 ? availableOptions.lados.length : '';
            }
            if (numeroCount) {
                numeroCount.textContent = availableOptions.numerosBloque.length > 0 ? availableOptions.numerosBloque.length : '';
            }
            if (nivelCount) {
                nivelCount.textContent = availableOptions.niveles.length > 0 ? availableOptions.niveles.length : '';
            }
        }

        // ✅ CONFIGURAR EVENTO GLOBAL DE ESCAPE
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals();
            }
        });

        function hasUnsavedChanges() {
            // Esta función verificaría si hay cambios pendientes de guardar
            // Por ahora retornamos false, pero se puede implementar tracking de cambios
            return false;
        }

        function showUnsavedChangesModal(callback) {
            const modalHtml = `
                <div class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 style="margin: 0; color: var(--warning-color);">
                                <i class="fas fa-exclamation-triangle"></i> Cambios Sin Guardar
                            </h3>
                        </div>
                        <div class="modal-body">
                            <p>¿Estás seguro de que deseas continuar? Tienes cambios sin guardar que se perderán.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelUnsavedBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-danger" id="confirmUnsavedBtn">
                                <i class="fas fa-trash"></i> Continuar Sin Guardar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            const modal = modalContainer.querySelector('.modal');
            
            document.getElementById('cancelUnsavedBtn').addEventListener('click', () => modal.remove());
            document.getElementById('confirmUnsavedBtn').addEventListener('click', () => {
                modal.remove();
                callback();
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function exportToExcelWithValidation() {
            try {
                const products = TicketExcelState.filteredProducts;
                
                if (!products || products.length === 0) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }
                
                // Preparar datos con información de validación
                const excelData = [
                    ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA', 'BLOQUE', 'LADO', 'N° BLOQUE', 'NIVEL', 'ESTADO_VALIDACIÓN', 'ERRORES']
                ];
                
                products.forEach(product => {
                    const descValidation = FieldValidators.descripcion.validate(product.descripcion);
                    const ubiValidation = FieldValidators.ubicacion.validate(product.ubicacion);
                    const unidadValidation = FieldValidators.unidadMedida.validate(product.unidadMedida);
                    
                    const isValid = descValidation.isValid && ubiValidation.isValid && unidadValidation.isValid;
                    const errors = [];
                    
                    if (!descValidation.isValid) errors.push(descValidation.error);
                    if (!ubiValidation.isValid) errors.push(ubiValidation.error);
                    if (!unidadValidation.isValid) errors.push(unidadValidation.error);
                    
                    excelData.push([
                        product.codigo,
                        product.descripcion,
                        product.ubicacion,
                        product.unidadMedida,
                        product.bloque,
                        product.lado,
                        product.numeroBloque,
                        product.nivel,
                        isValid ? 'VÁLIDO' : 'INVÁLIDO',
                        errors.join('; ')
                    ]);
                });
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                XLSX.utils.book_append_sheet(wb, ws, "Productos_Validados");
                
                // Descargar
                const fileName = `productos_validados_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast(`Exportados ${products.length} productos con validación`, 'success');
                
            } catch (error) {
                console.error('❌ Error exportando a Excel:', error);
                showToast('Error al exportar a Excel: ' + error.message, 'error');
            }
        }

        function saveAllChanges() {
            let savedCount = 0;
            let errorCount = 0;
            
            // Simular guardado de todos los cambios
            TicketExcelState.products.forEach(product => {
                // En una implementación real, aquí se guardarían los cambios
                savedCount++;
            });
            
            showToast(`✅ ${savedCount} cambios guardados correctamente`, 'success');
        }

        function showFieldError(field, message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error show';
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            
            // Insertar después del campo
            field.parentNode.appendChild(errorElement);
        }

        function showFieldWarning(field, message) {
            const warningElement = document.createElement('div');
            warningElement.className = 'field-error show';
            warningElement.style.color = 'var(--warning-color)';
            warningElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            
            field.parentNode.appendChild(warningElement);
        }

        function formatUbicacionInput(input) {
            let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // Limitar a 7 caracteres
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            
            // Aplicar formato mientras se escribe
            if (value.length >= 3) {
                value = value.substring(0, 3) + value.substring(3);
            }
            
            input.value = value;
        }

        function saveFieldValue(field) {
            const productId = field.getAttribute('data-id');
            const fieldName = field.getAttribute('data-field');
            const newValue = field.value.trim();
            
            // Validar antes de guardar
            const validation = validateField(fieldName, newValue);
            
            if (!validation.isValid) {
                showToast(`Error: ${validation.error}`, 'error');
                field.focus();
                return false;
            }
            
            // Actualizar en el estado
            updateProductField(productId, fieldName, newValue);
            showToast('Cambio guardado correctamente', 'success');
            return true;
        }

        // ===== MODIFICAR LA FUNCIÓN updateProductField =====
        function updateProductField(productId, fieldName, newValue) {
            const productIndex = TicketExcelState.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return false;
            
            // Validar antes de actualizar
            const validation = validateField(fieldName, newValue);
            if (!validation.isValid) {
                console.warn('Intento de actualización con datos inválidos:', validation.error);
                return false;
            }
            
            // Actualizar el campo
            TicketExcelState.products[productIndex][fieldName] = newValue;
            
            // Si es ubicación, actualizar campos parseados
            if (fieldName === 'ubicacion') {
                const parsed = parseUbicacion(newValue);
                TicketExcelState.products[productIndex].bloque = parsed.bloque;
                TicketExcelState.products[productIndex].lado = parsed.lado;
                TicketExcelState.products[productIndex].numeroBloque = parsed.numeroBloque;
                TicketExcelState.products[productIndex].nivel = parsed.nivel;
                
                // Actualizar filtros
                updateTicketLocationFilters();
            }
            
            // Re-filtrar y re-renderizar
            applyTicketFilters();
            return true;
        }

        // ===== SISTEMA DE PROGRESO PARA PDF =====
        class PdfProgressManager {
            constructor() {
                this.overlay = document.getElementById('pdfGenerationOverlay');
                this.progressBar = document.getElementById('pdfProgressBar');
                this.progressPercent = document.getElementById('pdfProgressPercent');
                this.progressStats = document.getElementById('pdfProgressStats');
                this.statusMessage = document.getElementById('pdfStatusMessage');
                this.statusText = document.getElementById('pdfStatusText');
                this.pdfCounter = document.getElementById('pdfCounter');
                this.pdfCurrentCount = document.getElementById('pdfCurrentCount');
                this.pdfTotalCount = document.getElementById('pdfTotalCount');
                this.title = document.getElementById('pdfGenerationTitle');
                this.subtitle = document.getElementById('pdfGenerationSubtitle');
                
                this.steps = {
                    preparing: document.getElementById('step1'),
                    generating: document.getElementById('step2'),
                    qrCodes: document.getElementById('step3'),
                    saving: document.getElementById('step4')
                };
                
                this.currentStep = 0;
                this.totalProducts = 0;
                this.processedProducts = 0;
                this.isCancelled = false;
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                const cancelBtn = document.getElementById('cancelPdfGeneration');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.cancelGeneration();
                    });
                }
                
                // Permitir cancelar con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
                        this.cancelGeneration();
                    }
                });
            }
            
            show(totalProducts, formatType) {
                this.totalProducts = totalProducts;
                this.processedProducts = 0;
                this.isCancelled = false;
                this.currentStep = 0;
                
                // Actualizar UI inicial
                this.pdfTotalCount.textContent = totalProducts;
                this.pdfCurrentCount.textContent = '0';
                this.updateProgress(0);
                
                // Configurar título según formato
                const formatNames = {
                    'ticket-small-horizontal': 'Tickets Pequeños',
                    'ticket-medium-horizontal': 'Tickets Medianos',
                    'compact-summary': 'Resumen Compacto'
                };
                
                this.title.textContent = `Generando ${formatNames[formatType] || 'PDF'}`;
                this.subtitle.textContent = `${totalProducts} productos encontrados`;
                
                // Mostrar overlay
                this.overlay.classList.add('active');
                
                // Iniciar con paso 1 completado
                this.updateStep(1, 'completed');
                this.updateStatus('Preparando datos y configurando documento...');
            }
            
            updateProgress(percent, current = null, total = null) {
                if (this.isCancelled) return;
                
                // Suavizar la animación de la barra
                this.progressBar.style.width = `${percent}%`;
                this.progressPercent.textContent = `${Math.round(percent)}%`;
                
                if (current !== null && total !== null) {
                    this.processedProducts = current;
                    this.pdfCurrentCount.textContent = current;
                    this.progressStats.textContent = 
                        `Procesando producto ${current} de ${total} - ${Math.round((current / total) * 100)}% completado`;
                }
            }
            
            updateStep(stepNumber, status = 'active') {
                if (this.isCancelled) return;
                
                // Resetear todos los steps
                Object.values(this.steps).forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                // Marcar steps anteriores como completados
                for (let i = 1; i < stepNumber; i++) {
                    if (this.steps[this.getStepKey(i)]) {
                        this.steps[this.getStepKey(i)].classList.add('completed');
                    }
                }
                
                // Marcar step actual
                if (this.steps[this.getStepKey(stepNumber)]) {
                    this.steps[this.getStepKey(stepNumber)].classList.add(status);
                }
                
                this.currentStep = stepNumber;
            }
            
            getStepKey(stepNumber) {
                const stepMap = {
                    1: 'preparing',
                    2: 'generating', 
                    3: 'qrCodes',
                    4: 'saving'
                };
                return stepMap[stepNumber];
            }
            
            updateStatus(message, type = 'info') {
                if (this.isCancelled) return;
                
                this.statusText.textContent = message;
                
                // Cambiar color según tipo
                const colors = {
                    info: 'var(--primary-color)',
                    success: 'var(--success-color)',
                    warning: 'var(--warning-color)',
                    error: 'var(--danger-color)'
                };
                
                this.statusMessage.style.borderLeftColor = colors[type] || colors.info;
                
                // Animación de entrada
                this.statusMessage.style.animation = 'none';
                setTimeout(() => {
                    this.statusMessage.style.animation = 'slideInRight 0.5s ease';
                }, 10);
            }
            
            showSuccess() {
                if (this.isCancelled) return;
                
                this.updateProgress(100);
                this.updateStep(4, 'completed');
                this.updateStatus('✅ PDF generado exitosamente. Descargando...', 'success');
                
                // Cambiar icono a éxito
                const icon = this.overlay.querySelector('.pdf-generation-icon');
                icon.innerHTML = '<i class="fas fa-check-circle pdf-success-animation"></i>';
                icon.style.color = 'var(--success-color)';
                
                this.title.textContent = '¡PDF Generado!';
                this.subtitle.textContent = 'El documento se está descargando...';
            }
            
            showError(error) {
                this.updateStatus(`❌ Error: ${error.message || error}`, 'error');
                
                const icon = this.overlay.querySelector('.pdf-generation-icon');
                icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                icon.style.color = 'var(--danger-color)';
                icon.style.animation = 'none';
                
                this.title.textContent = 'Error al Generar PDF';
                this.subtitle.textContent = 'Ha ocurrido un problema';
                
                // Cambiar botón cancelar por "Cerrar"
                const cancelBtn = document.getElementById('cancelPdfGeneration');
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cerrar';
                cancelBtn.className = 'btn btn-danger btn-small';
            }
            
            cancelGeneration() {
                this.isCancelled = true;
                this.updateStatus('Generación cancelada por el usuario', 'warning');
                
                setTimeout(() => {
                    this.hide();
                }, 2000);
            }
            
            hide() {
                this.overlay.classList.remove('active');
                
                // Resetear para próxima vez
                setTimeout(() => {
                    const icon = this.overlay.querySelector('.pdf-generation-icon');
                    icon.innerHTML = '<i class="fas fa-file-pdf"></i>';
                    icon.style.color = 'var(--primary-color)';
                    icon.style.animation = 'pulse 2s infinite';
                    
                    this.title.textContent = 'Generando PDF';
                    this.progressBar.style.width = '0%';
                    
                    // Resetear botón
                    const cancelBtn = document.getElementById('cancelPdfGeneration');
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar Generación';
                    cancelBtn.className = 'btn btn-secondary btn-small';
                }, 300);
            }
        }

        // Inicializar el manager
        const pdfProgress = new PdfProgressManager();

        // ===== FUNCIONES DE UTILIDAD =====
        function showLoadingOverlay(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            const toastConfig = {
                success: { icon: 'check-circle', color: 'toast' },
                error: { icon: 'exclamation-circle', color: 'toast-error' },
                warning: { icon: 'exclamation-triangle', color: 'toast-warning' },
                info: { icon: 'info-circle', color: 'toast-info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            toastIcon.className = `fas fa-${config.icon} toast-icon`;
            toast.classList.add(config.color);
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== INICIALIZACIÓN DE AUTENTICACIÓN =====
        async function initializeAuth() {
            // Verificar si ya hay una sesión activa
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                // Usuario ya está autenticado
                AppState.currentUser = session.user;
                await loadApplication();
            } else {
                // No hay sesión activa, mostrar pantalla de login
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
            
            // Configurar listener para cambios de autenticación
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    AppState.currentUser = session.user;
                    await loadApplication();
                } else if (event === 'SIGNED_OUT') {
                    AppState.currentUser = null;
                    AppState.userData = null;
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('app').style.display = 'none';
                }
            });
            
            // Configurar formulario de login
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    showLoadingOverlay(true, 'Iniciando sesión...');
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    showToast('Sesión iniciada correctamente', 'success');
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    showToast('Error al iniciar sesión: ' + error.message, 'error');
                } finally {
                    showLoadingOverlay(false);
                }
            });
            
            // Configurar botón de logout
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    await supabase.auth.signOut();
                    showToast('Sesión cerrada correctamente', 'success');
                } catch (error) {
                    console.error('Error cerrando sesión:', error);
                    showToast('Error al cerrar sesión', 'error');
                }
                
                document.getElementById('userDropdown').classList.remove('active');
            });
        }

        // ===== CARGA DE LA APLICACIÓN =====
        async function loadApplication() {
            try {
                // Aplicar tema
                if (AppState.darkMode) {
                    document.body.classList.add('dark-mode');
                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Mostrar información del usuario
                updateUserInterface();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Mostrar aplicación
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Ir directamente a Generar Tickets
                switchTab('generateTicket');
                
                showToast('Sistema cargado correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error cargando aplicación:', error);
                showToast('Error al cargar la aplicación: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            // ===== EVENT LISTENERS GLOBALES =====
            
            // 1. Toggle de tema oscuro/claro
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // 2. Botón de pantalla completa
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }
            
            // 3. Menú de usuario
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', toggleUserDropdown);
            }
            
            // ===== NAVEGACIÓN POR PESTAÑAS =====
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    const validTabs = ['generateTicket'];
                    if (!validTabs.includes(tabId)) {
                        console.warn('Pestaña no válida:', tabId);
                        showToast(`La pestaña "${tabId}" no está disponible`, 'warning');
                        return;
                    }
                    
                    switchTab(tabId);
                });
            });
            
            // ===== BOTÓN FLOTANTE SCROLL TO TOP =====
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (scrollToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                scrollToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // ===== TOAST NOTIFICATIONS =====
            const toastClose = document.querySelector('.toast-close');
            if (toastClose) {
                toastClose.addEventListener('click', () => {
                    document.getElementById('toast').classList.remove('show');
                });
            }
            
            // ===== EVENT LISTENERS ESPECÍFICOS =====
            setupTicketExcelEventListeners();
            
            // ===== EVENT LISTENERS GLOBALES DE SISTEMA =====
            
            // Cerrar menús al hacer click fuera
            document.addEventListener('click', (e) => {
                const userDropdown = document.getElementById('userDropdown');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userDropdown && userDropdown.classList.contains('active') && 
                    !userDropdown.contains(e.target) && 
                    !userAvatar.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            
            setupKeyboardShortcuts();
            
            console.log('✅ Event listeners configurados correctamente');
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Solo activar si estamos en la sección de tickets
                if (!document.getElementById('generateTicketSection').classList.contains('active')) {
                    return;
                }
                
                // Ctrl+F o Cmd+F - Enfocar búsqueda
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('ticketSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                // Ctrl+S o Cmd+S - Exportar a Excel
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (TicketExcelState.filteredProducts.length > 0) {
                        exportToExcel();
                    } else {
                        showToast('No hay productos para exportar', 'warning');
                    }
                }
                
                // Escape - Limpiar búsqueda y filtros
                if (e.key === 'Escape') {
                    e.preventDefault();
                    clearAllFilters();
                }
            });
        }

        // ===== FUNCIÓN ACTUALIZADA CON TU ESTRUCTURA =====
        async function updateUserInterface() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement && AppState.currentUser) {
                try {
                    // ✅ OBTENER SOLO EL NOMBRE DEL USUARIO
                    const nombreUsuario = await getUserName(AppState.currentUser.id);
                    
                    if (nombreUsuario) {
                        // ✅ MOSTRAR NOMBRE DEL USUARIO
                        userNameElement.textContent = nombreUsuario;
                        
                        // ✅ ACTUALIZAR AVATAR CON INICIALES DEL NOMBRE
                        const avatarText = getInitialsFromName(nombreUsuario);
                        if (userAvatarElement) {
                            userAvatarElement.textContent = avatarText;
                            userAvatarElement.title = `${nombreUsuario} - Colaborador`;
                        }
                        
                        console.log('✅ Interfaz actualizada - Nombre:', nombreUsuario);
                        
                    } else {
                        // ✅ FALLBACK: Usar nombre del email
                        useEmailAsName();
                    }
                    
                } catch (error) {
                    console.error('❌ Error obteniendo nombre:', error);
                    useEmailAsName();
                }
            } else {
                useEmailAsName();
            }
            
            // ✅ ROL ESTÁTICO - SIEMPRE "Colaborador"
            if (userRoleElement) {
                userRoleElement.textContent = 'Colaborador';
                userRoleElement.style.backgroundColor = 'var(--secondary-color)'; // Color consistente
            }
        }

        // ===== FUNCIÓN DE FALLBACK MEJORADA =====
        function useEmailAsName() {
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement && AppState.currentUser) {
                const email = AppState.currentUser.email || '';
                
                // ✅ EXTRAER NOMBRE AMIGABLE DEL EMAIL
                const nombreFromEmail = email.split('@')[0] || 'Usuario';
                const nombreFormateado = formatNameFromEmail(nombreFromEmail);
                    
                userNameElement.textContent = nombreFormateado;
                
                // ✅ ACTUALIZAR AVATAR
                if (userAvatarElement) {
                    const avatarText = getInitialsFromName(nombreFormateado);
                    userAvatarElement.textContent = avatarText;
                }
            }
        }

        // ===== FUNCIÓN PARA FORMATEAR NOMBRE DESDE EMAIL =====
        function formatNameFromEmail(emailPart) {
            if (!emailPart) return 'Usuario';
            
            // ✅ CONVERTIR "juan.perez" → "Juan Perez"
            return emailPart
                .split('.')
                .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' ')
                .replace(/[0-9]/g, ''); // Remover números si los hay
        }

        // ===== FUNCIÓN PARA OBTENER INICIALES =====
        function getInitialsFromName(fullName) {
            if (!fullName) return 'U';
            
            const names = fullName.trim().split(' ').filter(name => name.length > 0);
            
            if (names.length === 0) return 'U';
            if (names.length === 1) return names[0].charAt(0).toUpperCase();
            
            // ✅ DOS INICIALES: Primera y última palabra
            return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
        }

        // ===== FUNCIÓN CORREGIDA - SIN INTENTAR ACCEDER A auth.users =====
        async function getUserName(userId) {
            try {
                console.log('👤 Buscando nombre del usuario ID:', userId);
                
                if (!userId) {
                    console.warn('⚠️ No hay ID de usuario proporcionado');
                    return null;
                }
                
                // ✅ SOLO INTENTAR CON LA TABLA 'usuario'
                const { data, error } = await supabase
                    .from('usuario')
                    .select('nombre, correo')
                    .eq('id', userId)
                    .maybeSingle(); // ✅ USAR maybeSingle() PARA EVITAR ERRORES
                
                if (error) {
                    console.error('❌ Error en consulta a tabla usuario:', error);
                    return null;
                }
                
                // ✅ SI ENCONTRÓ DATOS, EXTRAER EL NOMBRE
                if (data) {
                    console.log('✅ Datos encontrados en tabla usuario:', data);
                    const nombre = data.nombre || data.name || data.full_name;
                    if (nombre) {
                        return nombre;
                    }
                }
                
                console.log('ℹ️  No se encontraron datos en tabla usuario - Usando fallback de email');
                return null;
                
            } catch (error) {
                console.error('❌ Error obteniendo nombre:', error);
                return null;
            }
        }

        // ===== FUNCIÓN PARA EXTRAER EL NOMBRE =====
        function extractUserName(userData) {
            if (!userData) return null;
            
            // ✅ EXTRAER NOMBRE DE CUALQUIER CAMPO POSIBLE
            return userData.nombre || userData.name || userData.full_name || null;
        }

        // ===== FUNCIÓN DE FALLBACK MEJORADA =====
        function useEmailFallback() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement && AppState.currentUser) {
                // ✅ EXTRAER NOMBRE DEL EMAIL COMO FALLBACK
                const email = AppState.currentUser.email || '';
                const nombreFromEmail = email.split('@')[0] || 'Usuario';
                
                // Capitalizar: "juan.perez" → "Juan Perez"
                const nombreFormateado = nombreFromEmail
                    .split('.')
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                    .join(' ');
                    
                userNameElement.textContent = nombreFormateado;
            }
            
            if (userRoleElement) {
                userRoleElement.textContent = 'Colaborador';
            }
            
            if (userAvatarElement && AppState.currentUser) {
                const avatarText = getInitialsFromName(userNameElement?.textContent || '');
                userAvatarElement.textContent = avatarText;
            }
        }

        // ===== FUNCIÓN PARA NORMALIZAR TUS DATOS =====
        function normalizeUserData(userData) {
            if (!userData) return null;
            
            // ✅ EXTRAER ROL DE sistemaSuministro dentro de sistemas_acceso
            let rol = 'Colaborador'; // Valor por defecto
            let sistemaActivo = false;
            
            if (userData.sistemas_acceso && userData.sistemas_acceso.sistemaSuministro) {
                const sistemaSuministro = userData.sistemas_acceso.sistemaSuministro;
                rol = sistemaSuministro.rol || 'colaborador';
                sistemaActivo = sistemaSuministro.activo || false;
                
                // Capitalizar: "colaborador" → "Colaborador"
                rol = rol.charAt(0).toUpperCase() + rol.slice(1);
            }
            
            return {
                nombre: userData.nombre || userData.name || userData.full_name || '',
                email: userData.email || '',
                rol: rol,
                sistemaActivo: sistemaActivo,
                sistemas_acceso: userData.sistemas_acceso || {}
            };
        }

        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            showToast(`Modo ${AppState.darkMode ? 'oscuro' : 'claro'} activado`, 'success');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error al activar pantalla completa:', err);
                    showToast('No se pudo activar el modo pantalla completa', 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const isActive = dropdown.classList.toggle('active');
            document.getElementById('userAvatar').setAttribute('aria-expanded', isActive);
        }

        function switchTab(tabId) {
            // Validar que sea una pestaña existente
            const validTabs = ['generateTicket'];
            
            if (!validTabs.includes(tabId)) {
                console.warn('Pestaña no válida:', tabId);
                showToast(`Pestaña "${tabId}" no está disponible`, 'error');
                return;
            }
            
            AppState.currentTab = tabId;
            
            // Ocultar todas las secciones
            document.querySelectorAll('.generate-ticket-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Mostrar sección activa
            const activeSection = document.getElementById(tabId + 'Section');
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
                
                // Acciones específicas por pestaña
                if (tabId === 'generateTicket') {
                    initializeTicketExcelSection();
                }
            }
            
            // Actualizar pestañas activas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.getAttribute('data-tab') === tabId;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
            });
            
            console.log(`✅ Cambiando a pestaña: ${tabId}`);
        }

        function initializeTicketExcelSection() {
            console.log('🔄 Inicializando sección de tickets...');
            
            // Inicializar estado de filtros si no existe
            if (!TicketExcelState.filters) {
                TicketExcelState.filters = {
                    search: '',
                    quickFilter: 'all'
                };
            }
            
            // Resetear estado si es necesario
            if (TicketExcelState.currentStep === 'preview' && TicketExcelState.products.length === 0) {
                backToTicketUpload();
            }
        }

        // ===== FUNCIONES PARA TICKETS DESDE EXCEL =====
        function setupTicketExcelEventListeners() {
            console.log('🔧 Configurando event listeners para tickets Excel...');
            
            // 1. Upload Area para Tickets
            const ticketUploadArea = document.getElementById('ticketUploadArea');
            const ticketFileInput = document.getElementById('ticketFileInput');
            
            if (ticketUploadArea && ticketFileInput) {
                ticketUploadArea.addEventListener('click', () => {
                    ticketFileInput.click();
                });
                
                // Mejora: Drag & Drop para archivos
                ticketUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--success-color)';
                    ticketUploadArea.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
                });
                
                ticketUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                });
                
                ticketUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        processTicketFile(e.dataTransfer.files[0]);
                    }
                });
                
                ticketFileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        processTicketFile(e.target.files[0]);
                    }
                });
            }
            
            // 2. Botón de volver a upload
            const backToUploadTicketBtn = document.getElementById('backToUploadTicketBtn');
            if (backToUploadTicketBtn) {
                backToUploadTicketBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            backToTicketUpload();
                        });
                    } else {
                        backToTicketUpload();
                    }
                });
            }
            
            // 3. Botón de generar PDF masivo CON VALIDACIÓN
            const generateAllPdfBtn = document.getElementById('generateAllPdfBtn');
            if (generateAllPdfBtn) {
                generateAllPdfBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🖨️ Click en Generar PDF de Todos - Validando...');
                    
                    if (TicketExcelState.filteredProducts.length === 0) {
                        showToast('No hay productos para generar PDF', 'warning');
                        return;
                    }
                    
                    // ✅ PRIMERO: Validar todos los campos antes de continuar
                    const validationResult = validateAllFieldsBeforePdf();
                    
                    if (!validationResult.allValid) {
                        showValidationErrorsModal(validationResult.invalidProducts);
                        return;
                    }
                    
                    // ✅ SEGUNDO: Validar que haya productos válidos para PDF
                    const validProducts = TicketExcelState.filteredProducts.filter(product => 
                        validateProductForPdf(product).isValid
                    );
                    
                    if (validProducts.length === 0) {
                        showToast('No hay productos válidos para generar PDF', 'warning');
                        return;
                    }
                    
                    console.log(`📊 Mostrando modal para ${validProducts.length} productos válidos`);
                    showPdfFormatModalForAll('excel');
                });
            }
            
            // 4. Paginación - MEJORADA PARA EVITAR MÚLTIPLES EVENTOS
            const ticketPrevPageBtn = document.getElementById('ticketPrevPageBtn');
            const ticketNextPageBtn = document.getElementById('ticketNextPageBtn');

            if (ticketPrevPageBtn) {
                // ✅ REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketPrevPageBtn.replaceWith(ticketPrevPageBtn.cloneNode(true));
                const newPrevBtn = document.getElementById('ticketPrevPageBtn');
                
                newPrevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // ✅ EVITA MÚLTIPLES EJECUCIONES
                    
                    console.log('⬅️ Botón Anterior clickeado - Página actual:', TicketExcelState.pagination.currentPage);
                    
                    if (TicketExcelState.pagination.currentPage > 1) {
                        TicketExcelState.pagination.currentPage--;
                        console.log('📄 Navegando a página:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }

            if (ticketNextPageBtn) {
                // ✅ REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketNextPageBtn.replaceWith(ticketNextPageBtn.cloneNode(true));
                const newNextBtn = document.getElementById('ticketNextPageBtn');
                
                newNextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // ✅ EVITA MÚLTIPLES EJECUCIONES
                    
                    console.log('➡️ Botón Siguiente clickeado - Página actual:', TicketExcelState.pagination.currentPage);
                    
                    const totalPages = TicketExcelState.pagination.totalPages;
                    
                    if (TicketExcelState.pagination.currentPage < totalPages) {
                        TicketExcelState.pagination.currentPage++;
                        console.log('📄 Navegando a página:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }
            
            // 5. Filtros y búsqueda - CON VALIDACIÓN MEJORADA
            const ticketSearchInput = document.getElementById('ticketSearchInput');
            if (ticketSearchInput) {
                // Agregar placeholder mejorado
                ticketSearchInput.placeholder = 'Buscar por código, descripción, ubicación... (Ctrl+F)';
                
                ticketSearchInput.addEventListener('input', debounce(function(e) {
                    console.log('🔍 Búsqueda:', e.target.value);
                    applyTicketFilters();
                }, 300));
                
                // Limpiar búsqueda con Escape
                ticketSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.target.value = '';
                        applyTicketFilters();
                        showToast('Búsqueda limpiada', 'info');
                    }
                });
            }
            
            // Filtros de ubicación
            const ticketFilterBloque = document.getElementById('ticketFilterBloque');
            const ticketFilterLado = document.getElementById('ticketFilterLado');
            const ticketFilterNumeroBloque = document.getElementById('ticketFilterNumeroBloque');
            const ticketFilterNivel = document.getElementById('ticketFilterNivel');
            
            [ticketFilterBloque, ticketFilterLado, ticketFilterNumeroBloque, ticketFilterNivel].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', function(e) {
                        console.log(`🎯 Filtro ${filter.id} cambiado:`, e.target.value);
                        applyTicketFilters();
                    });
                }
            });
            
            // 6. Descargar plantilla
            const downloadTicketTemplateBtn = document.getElementById('downloadTicketTemplateBtn');
            if (downloadTicketTemplateBtn) {
                downloadTicketTemplateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    downloadTicketTemplate();
                });
            }

            // 7. Botón limpiar filtros - MEJORADO
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar antes de limpiar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            clearAllFilters();
                        });
                    } else {
                        clearAllFilters();
                    }
                });
            }
            
            // 8. NUEVO: Botón de validación masiva
            const validateAllBtn = document.getElementById('validateAllBtn');
            if (!validateAllBtn) {
                // Crear botón si no existe
                const validateButton = document.createElement('button');
                validateButton.className = 'btn btn-warning';
                validateButton.id = 'validateAllBtn';
                validateButton.innerHTML = '<i class="fas fa-check-double"></i> Validar Todos';
                validateButton.title = 'Validar todos los productos antes de generar PDF';
                
                // Insertar junto a los otros botones
                const previewHeader = document.querySelector('.preview-header');
                if (previewHeader) {
                    const buttonContainer = previewHeader.querySelector('div:last-child');
                    if (buttonContainer) {
                        buttonContainer.insertBefore(validateButton, buttonContainer.firstChild);
                    }
                }
                
                validateButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    validateAllProducts();
                });
            } else {
                validateAllBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    validateAllProducts();
                });
            }
            
            // 9. NUEVO: Exportar a Excel con validación
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (!exportExcelBtn) {
                const exportButton = document.createElement('button');
                exportButton.className = 'btn btn-success';
                exportButton.id = 'exportExcelBtn';
                exportButton.innerHTML = '<i class="fas fa-file-excel"></i> Exportar Excel';
                exportButton.title = 'Exportar productos a Excel con estado de validación';
                
                const previewHeader = document.querySelector('.preview-header');
                if (previewHeader) {
                    const buttonContainer = previewHeader.querySelector('div:last-child');
                    if (buttonContainer) {
                        buttonContainer.insertBefore(exportButton, buttonContainer.firstChild);
                    }
                }
                
                exportButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    exportToExcelWithValidation();
                });
            } else {
                exportExcelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    exportToExcelWithValidation();
                });
            }
            
            // 10. NUEVO: Guardar cambios manualmente
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (!saveChangesBtn) {
                const saveButton = document.createElement('button');
                saveButton.className = 'btn btn-primary';
                saveButton.id = 'saveChangesBtn';
                saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
                saveButton.title = 'Guardar todos los cambios pendientes';
                
                const previewHeader = document.querySelector('.preview-header');
                if (previewHeader) {
                    const buttonContainer = previewHeader.querySelector('div:last-child');
                    if (buttonContainer) {
                        buttonContainer.insertBefore(saveButton, buttonContainer.firstChild);
                    }
                }
                
                saveButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    saveAllChanges();
                });
            } else {
                saveChangesBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    saveAllChanges();
                });
            }
            
            // 11. Inicializar validación en tiempo real
            setupRealTimeValidation();
            
            // 12. Configurar atajos de teclado globales
            setupKeyboardShortcuts();
            
            console.log('✅ Event listeners para tickets Excel configurados correctamente');
        }

        function processTicketFile(file) {
            if (!file) return;

            const validTypes = [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'text/csv'
            ];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showToast('Formato de archivo no válido. Use Excel (.xlsx, .xls) o CSV.', 'error');
                return;
            }

            showLoadingOverlay(true, 'Leyendo archivo Excel...');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showToast('El archivo está vacío o no tiene datos', 'warning');
                        return;
                    }
                    
                    const processedData = processExcelData(jsonData);
                    
                    if (processedData.length === 0) {
                        showToast('No se encontraron datos válidos en el archivo', 'warning');
                        return;
                    }
                    
                    TicketExcelState.products = processedData;
                    TicketExcelState.filteredProducts = [...processedData];
                    TicketExcelState.fileData = processedData;

                    // ✅ USAR LA NUEVA INICIALIZACIÓN
                    initializeLocationFilters();                    
                    
                    showTicketPreviewStep();
                    renderTicketProductsTable();
                    
                    updateAvailableFilterOptions();
                    updateFilterSelects();
                    updateTicketLocationFilters();
                    
                    showToast(`${processedData.length} productos cargados correctamente`, 'success');
                    
                } catch (error) {
                    console.error('❌ Error procesando Excel:', error);
                    showToast('Error al leer el archivo Excel: ' + error.message, 'error');
                } finally {
                    showLoadingOverlay(false);
                }
            };
            
            reader.onerror = function() {
                showLoadingOverlay(false);
                showToast('Error al leer el archivo', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(jsonData) {
            const products = [];
            const headers = jsonData[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            
            // Mapear columnas
            const codeIndex = headers.findIndex(h => h.includes('código') || h.includes('codigo'));
            const descIndex = headers.findIndex(h => h.includes('descripción') || h.includes('descripcion'));
            const ubicacionIndex = headers.findIndex(h => h.includes('ubicación') || h.includes('ubicacion'));
            const unidadIndex = headers.findIndex(h => h.includes('unidad') || h.includes('medida'));
            
            // Validar columnas requeridas
            if (codeIndex === -1 || descIndex === -1 || ubicacionIndex === -1 || unidadIndex === -1) {
                showToast('El archivo no tiene las columnas requeridas: CÓDIGO, DESCRIPCIÓN, UBICACIÓN, UNIDAD_MEDIDA', 'error');
                return [];
            }
            
            // Procesar filas
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;
                
                const product = {
                    id: `excel_${i}_${Date.now()}`,
                    codigo: (row[codeIndex] || '').toString().trim().toUpperCase(),
                    descripcion: (row[descIndex] || '').toString().trim(),
                    ubicacion: (row[ubicacionIndex] || '').toString().trim().toUpperCase(),
                    unidadMedida: (row[unidadIndex] || '').toString().trim().toUpperCase(),
                    fechaCreacion: new Date(),
                    activo: true,
                    origen: 'excel',
                    rowNumber: i + 1 // Guardar número de fila en Excel
                };
                
                // Solo agregar si tiene código
                if (product.codigo && product.codigo !== '') {
                    const ubicacionParsed = parseUbicacion(product.ubicacion);
                    product.bloque = ubicacionParsed.bloque || '';
                    product.lado = ubicacionParsed.lado || '';
                    product.numeroBloque = ubicacionParsed.numeroBloque || '';
                    product.nivel = ubicacionParsed.nivel || '';
                    
                    products.push(product);
                }
            }
            
            return products;
        }

        function parseUbicacion(ubicacion) {
            const result = {
                bloque: '',
                lado: '',
                numeroBloque: '',
                nivel: ''
            };
            
            if (!ubicacion || typeof ubicacion !== 'string') {
                return result;
            }
            
            // Limpiar y normalizar la ubicación
            const ubicacionLimpia = ubicacion.toString().trim().toUpperCase();
            
            // Validar longitud mínima
            if (ubicacionLimpia.length >= 7) {
                result.bloque = ubicacionLimpia.substring(0, 2) || '';
                result.lado = ubicacionLimpia.substring(2, 3) || '';
                result.numeroBloque = ubicacionLimpia.substring(3, 5) || '';
                result.nivel = ubicacionLimpia.substring(5, 7) || '';
            }
            
            return result;
        }

        function renderTicketProductsTable() {
            const cardsContainer = document.getElementById('ticketProductsCardsContainer');
            if (!cardsContainer) {
                console.error('No se encontró el contenedor de cards');
                return;
            }
            
            cardsContainer.innerHTML = '';
            
            // ✅ CORRECCIÓN: Calcular variables primero
            const totalItems = TicketExcelState.filteredProducts?.length || 0;
            const itemsPerPage = TicketExcelState.pagination.itemsPerPage || 8;
            
            // ✅ CORRECCIÓN: Calcular totalPages ANTES de usarlo
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // ✅ CORRECCIÓN: Actualizar el estado de paginación
            TicketExcelState.pagination.totalPages = totalPages;
            TicketExcelState.pagination.totalItems = totalItems;
            
            // ✅ CORRECCIÓN: Asegurar que currentPage esté dentro de límites válidos
            if (TicketExcelState.pagination.currentPage > totalPages && totalPages > 0) {
                TicketExcelState.pagination.currentPage = totalPages;
            }
            if (TicketExcelState.pagination.currentPage < 1 && totalPages > 0) {
                TicketExcelState.pagination.currentPage = 1;
            }
            
            // Calcular índices para paginación
            const startIndex = (TicketExcelState.pagination.currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const productsToShow = TicketExcelState.filteredProducts.slice(startIndex, endIndex);
            
            // ✅ DEBUG: Mostrar información de paginación en consola
            console.log('📊 Paginación:', {
                currentPage: TicketExcelState.pagination.currentPage,
                totalPages: totalPages,
                itemsPerPage: itemsPerPage,
                totalItems: totalItems,
                startIndex: startIndex,
                endIndex: endIndex,
                productsToShow: productsToShow.length
            });
            
            // Actualizar información de paginación en la UI
            document.getElementById('ticketPaginationInfo').textContent = 
                `Página ${TicketExcelState.pagination.currentPage} de ${totalPages} (${totalItems} productos)`;
            
            // Actualizar estado de botones
            document.getElementById('ticketPrevPageBtn').disabled = TicketExcelState.pagination.currentPage === 1;
            document.getElementById('ticketNextPageBtn').disabled = TicketExcelState.pagination.currentPage === totalPages || totalPages === 0;
            
            // Actualizar contador
            document.getElementById('productsCount').textContent = `${totalItems} productos cargados`;
            
            // Mostrar estado vacío si no hay productos
            if (productsToShow.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <div class="empty-state">
                            <i class="fas fa-search" style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                            <h3>No hay productos para mostrar</h3>
                            <p>Intenta con otros filtros o ajusta la búsqueda</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Renderizar productos como cards con validación
            productsToShow.forEach((product, index) => {
                const globalIndex = startIndex + index + 1;
                const validation = validateProductForPdf(product);
                const isValid = validation.isValid;
                
                // Validar campos individuales para estado visual
                const descValidation = FieldValidators.descripcion.validate(product.descripcion);
                const ubiValidation = FieldValidators.ubicacion.validate(product.ubicacion);
                const unidadValidation = FieldValidators.unidadMedida.validate(product.unidadMedida);
                
                // Texto con highlight para búsqueda
                const searchTerm = TicketExcelState.filters.search;
                const codigoDisplay = searchTerm ? highlightSearchText(product.codigo, searchTerm) : product.codigo;
                const descripcionDisplay = searchTerm ? highlightSearchText(product.descripcion, searchTerm) : product.descripcion;
                
                const card = document.createElement('div');
                card.className = `product-card ${isValid ? 'valid' : 'invalid'}`;
                card.innerHTML = `
                    <!-- Badge de validación general -->
                    <div class="validation-badge ${isValid ? 'valid' : 'invalid'}" 
                        title="${isValid ? 'Producto válido para PDF' : 'Producto con errores - Revisar campos'}">
                        <i class="fas ${isValid ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    </div>
                    
                    <div class="product-card-header">
                        <div class="product-code-badge">${product.codigo}</div>
                        <div class="product-row-number">#${globalIndex}</div>
                    </div>
                    
                    ${searchTerm ? `<div class="card-search-preview">${codigoDisplay}</div>` : ''}
                    
                    <!-- DESCRIPCIÓN CON VALIDACIÓN -->
                    <div class="product-description">
                        <div class="field-group">
                            <textarea 
                                class="editable-field ${descValidation.isValid && product.descripcion ? 'valid' : !product.descripcion ? '' : 'invalid'}" 
                                data-field="descripcion" 
                                data-id="${product.id}"
                                placeholder="Descripción del producto (mín. 3 caracteres, máx. 200)..."
                                maxlength="200"
                                rows="3"
                            >${product.descripcion}</textarea>
                            <div class="validation-indicator">
                                ${descValidation.isValid && product.descripcion ? '<i class="fas fa-check"></i>' : 
                                !product.descripcion ? '' : '<i class="fas fa-exclamation-circle"></i>'}
                            </div>
                        </div>
                        ${searchTerm ? `<div class="card-search-preview">${descripcionDisplay}</div>` : ''}
                        <div class="character-count" style="font-size: 0.7rem; color: var(--text-muted); text-align: right; margin-top: 0.25rem;">
                            ${product.descripcion ? product.descripcion.length : 0}/200 caracteres
                        </div>
                    </div>
                    
                    <div class="product-details-grid">
                        <!-- UBICACIÓN CON VALIDACIÓN -->
                        <div class="detail-group">
                            <span class="detail-label">
                                Ubicación 
                                ${!ubiValidation.isValid && product.ubicacion ? 
                                '<i class="fas fa-exclamation-triangle" style="color: var(--danger-color); margin-left: 0.25rem;"></i>' : ''}
                            </span>
                            <div class="detail-value">
                                <div class="field-group">
                                    <input type="text" 
                                        class="editable-field ubicacion-input ${ubiValidation.isValid && product.ubicacion ? 'valid' : !product.ubicacion ? '' : 'invalid'}" 
                                        value="${product.ubicacion}" 
                                        data-field="ubicacion" 
                                        data-id="${product.id}"
                                        maxlength="7"
                                        placeholder="A1D0101"
                                        pattern="[A-Z][0-9A-Z][A-Z][0-9]{4}"
                                        title="Formato: Letra-Número-Letra-4Números (Ej: A1D0101)">
                                    <div class="validation-indicator">
                                        ${ubiValidation.isValid && product.ubicacion ? '<i class="fas fa-check"></i>' : 
                                        !product.ubicacion ? '' : '<i class="fas fa-exclamation-circle"></i>'}
                                    </div>
                                </div>
                                ${!ubiValidation.isValid && product.ubicacion ? 
                                `<div class="field-error show" style="margin-top: 0.25rem;">
                                    <i class="fas fa-exclamation-circle"></i> ${ubiValidation.error}
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <!-- UNIDAD DE MEDIDA CON VALIDACIÓN -->
                        <div class="detail-group">
                            <span class="detail-label">
                                Unidad de Medida
                            </span>
                            <div class="detail-value">
                                <div class="field-group">
                                    <input type="text" 
                                        class="editable-field ${unidadValidation.isValid && product.unidadMedida ? 'valid' : !product.unidadMedida ? '' : 'invalid'}" 
                                        value="${product.unidadMedida}" 
                                        data-field="unidadMedida" 
                                        data-id="${product.id}"
                                        placeholder="Unidad de medida..."
                                        maxlength="10"
                                        title="Ingresa la unidad de medida (máximo 10 caracteres)">
                                    <div class="validation-indicator">
                                        ${unidadValidation.isValid && product.unidadMedida ? '<i class="fas fa-check"></i>' : 
                                        !product.unidadMedida ? '' : '<i class="fas fa-exclamation-circle"></i>'}
                                    </div>
                                </div>
                                ${!unidadValidation.isValid && product.unidadMedida ? 
                                `<div class="field-error show" style="margin-top: 0.25rem;">
                                    <i class="fas fa-exclamation-circle"></i> ${unidadValidation.error}
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- DESGLOSE DE UBICACIÓN -->
                    <div class="ubicacion-breakdown">
                        <div class="breakdown-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted);">Desglose de Ubicación</span>
                            ${ubiValidation.isValid ? 
                            '<span style="font-size: 0.7rem; color: var(--success-color);"><i class="fas fa-check"></i> Formato válido</span>' : 
                            '<span style="font-size: 0.7rem; color: var(--danger-color);"><i class="fas fa-times"></i> Formato inválido</span>'}
                        </div>
                        <div class="breakdown-grid">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Bloque</span>
                                <span class="breakdown-value ${product.bloque ? '' : 'invalid'}">${product.bloque || '?'}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Lado</span>
                                <span class="breakdown-value ${product.lado ? '' : 'invalid'}">${product.lado || '?'}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">N° Bloque</span>
                                <span class="breakdown-value ${product.numeroBloque ? '' : 'invalid'}">${product.numeroBloque || '?'}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Nivel</span>
                                <span class="breakdown-value ${product.nivel ? '' : 'invalid'}">${product.nivel || '?'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ESTADO DE VALIDACIÓN -->
                    <div class="validation-summary" style="margin: 1rem 0; padding: 0.75rem; border-radius: var(--border-radius-sm); 
                        background: ${isValid ? 'rgba(39, 174, 96, 0.1)' : 'rgba(231, 76, 60, 0.1)'}; 
                        border-left: 4px solid ${isValid ? 'var(--success-color)' : 'var(--danger-color)'};">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${isValid ? 'fa-check-circle' : 'fa-exclamation-circle'}" 
                            style="color: ${isValid ? 'var(--success-color)' : 'var(--danger-color)'};"></i>
                            <div>
                                <strong style="font-size: 0.8rem; color: ${isValid ? 'var(--success-color)' : 'var(--danger-color)'};">
                                    ${isValid ? 'Listo para PDF' : 'Corregir errores para PDF'}
                                </strong>
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.1rem;">
                                    ${isValid ? 
                                    'Todos los campos son válidos' : 
                                    'Revisa los campos marcados en rojo'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ACCIONES -->
                    <div class="product-card-actions">
                        <button class="card-action-btn btn-pdf generate-single-pdf ${!isValid ? 'disabled' : ''}" 
                                data-id="${product.id}"
                                title="${isValid ? 'Generar PDF individual' : 'Corrige los errores primero'}"
                                ${!isValid ? 'disabled' : ''}>
                            <i class="fas fa-file-pdf"></i> PDF
                            ${!isValid ? '<i class="fas fa-lock" style="margin-left: 0.25rem;"></i>' : ''}
                        </button>
                        <button class="card-action-btn btn-delete remove-product" 
                                data-id="${product.id}"
                                title="Eliminar producto">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
            
            // Agregar event listeners después del renderizado
            attachEditableFieldsListeners();
            attachActionButtonsListeners();
            setupRealTimeValidation();
            setupCharacterCounters();
            
            console.log(`✅ Renderizados ${productsToShow.length} productos con validación`);
        }

        // ===== FUNCIONES AUXILIARES PARA LA VALIDACIÓN =====

        function setupCharacterCounters() {
            // Contador de caracteres para descripción
            document.querySelectorAll('.product-description textarea').forEach(textarea => {
                const counter = textarea.parentNode.querySelector('.character-count');
                if (counter) {
                    textarea.addEventListener('input', function() {
                        counter.textContent = `${this.value.length}/200 caracteres`;
                        
                        // Cambiar color según la longitud
                        if (this.value.length > 180) {
                            counter.style.color = 'var(--warning-color)';
                        } else if (this.value.length > 190) {
                            counter.style.color = 'var(--danger-color)';
                        } else {
                            counter.style.color = 'var(--text-muted)';
                        }
                    });
                    
                    // Disparar evento inicial
                    textarea.dispatchEvent(new Event('input'));
                }
            });
        }

        function attachEditableFieldsListeners() {
            document.querySelectorAll('.editable-field').forEach(field => {
                // Remover event listeners existentes para evitar duplicados
                field.replaceWith(field.cloneNode(true));
            });
            
            // Re-asignar event listeners a los nuevos elementos
            document.querySelectorAll('.editable-field').forEach(field => {
                field.addEventListener('change', function() {
                    const productId = this.getAttribute('data-id');
                    const fieldName = this.getAttribute('data-field');
                    const newValue = this.value.trim();
                    
                    updateProductField(productId, fieldName, newValue);
                });
                
                // Para campo ubicación, actualizar parsing en tiempo real
                if (field.classList.contains('ubicacion-input')) {
                    field.addEventListener('input', function() {
                        formatUbicacionInput(this);
                        validateFieldInRealTime(this, 'ubicacion');
                        
                        // Actualizar desglose de ubicación si es válido
                        if (this.value.length === 7) {
                            const productId = this.getAttribute('data-id');
                            updateUbicacionFields(productId, this.value);
                            
                            // Re-renderizar solo este card después de un delay
                            setTimeout(() => {
                                applyTicketFilters(); // Esto re-renderizará manteniendo los filtros
                            }, 500);
                        }
                    });
                }
                
                // Validación en tiempo real para todos los campos
                field.addEventListener('input', function() {
                    const fieldName = this.getAttribute('data-field');
                    validateFieldInRealTime(this, fieldName);
                });
                
                // Guardar al perder el foco
                field.addEventListener('blur', function() {
                    const fieldName = this.getAttribute('data-field');
                    const validation = validateField(fieldName, this.value);
                    
                    if (validation.isValid) {
                        saveFieldValue(this);
                    } else {
                        // Mantener el foco en campos inválidos
                        if (this.value.trim() !== '') {
                            this.focus();
                        }
                    }
                });
            });
        }

        function attachActionButtonsListeners() {
            // Listeners para PDF individual
            document.querySelectorAll('.generate-single-pdf:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = this.getAttribute('data-id');
                    console.log('📄 Generando PDF para producto:', productId);
                    
                    const product = TicketExcelState.products.find(p => p.id === productId);
                    
                    if (!product) {
                        console.error('❌ Producto no encontrado:', productId);
                        showToast('Producto no encontrado', 'error');
                        return;
                    }
                    
                    const validation = validateProductForPdf(product);
                    if (!validation.isValid) {
                        showToast(`Error: ${validation.error}`, 'error');
                        return;
                    }

                    showPdfFormatModalForExcel(product);
                });
            });

            // Listeners para eliminar productos
            document.querySelectorAll('.remove-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = this.getAttribute('data-id');
                    console.log('🗑️ Click en eliminar producto:', productId);
                    
                    const product = TicketExcelState.products.find(p => p.id === productId);
                    
                    if (!product) {
                        console.error('❌ Producto no encontrado:', productId);
                        showToast('Producto no encontrado', 'error');
                        return;
                    }
                    
                    console.log('📋 Mostrando modal para:', product.codigo);
                    showDeleteConfirmationModal(productId, product);
                });
            });
        }
       
        function updateProductField(productId, fieldName, newValue) {
            const productIndex = TicketExcelState.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            TicketExcelState.products[productIndex][fieldName] = newValue;
            
            // Si es ubicación, actualizar campos parseados
            if (fieldName === 'ubicacion') {
                updateUbicacionFields(productId, newValue);
            }
            
            // Re-filtrar y re-renderizar
            applyTicketFilters();
            showToast('Cambio guardado', 'success');
        }

        function updateUbicacionFields(productId, ubicacion) {
            const productIndex = TicketExcelState.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            const parsed = parseUbicacion(ubicacion);
            TicketExcelState.products[productIndex].bloque = parsed.bloque;
            TicketExcelState.products[productIndex].lado = parsed.lado;
            TicketExcelState.products[productIndex].numeroBloque = parsed.numeroBloque;
            TicketExcelState.products[productIndex].nivel = parsed.nivel;
            
            // Actualizar filtros
            updateTicketLocationFilters();
        }

        function updateTicketLocationFilters() {
            const bloques = new Set();
            const lados = new Set();
            const numerosBloque = new Set();
            const niveles = new Set();
            
            TicketExcelState.products.forEach(product => {
                if (product.bloque) bloques.add(product.bloque);
                if (product.lado) lados.add(product.lado);
                if (product.numeroBloque) numerosBloque.add(product.numeroBloque);
                if (product.nivel) niveles.add(product.nivel);
            });
            
            updateSelectOptions(document.getElementById('ticketFilterBloque'), Array.from(bloques).sort());
            updateSelectOptions(document.getElementById('ticketFilterLado'), Array.from(lados).sort());
            updateSelectOptions(document.getElementById('ticketFilterNumeroBloque'), Array.from(numerosBloque).sort());
            updateSelectOptions(document.getElementById('ticketFilterNivel'), Array.from(niveles).sort());
        }

        // Función auxiliar para ordenar opciones de manera inteligente
        function sortOptionsIntelligently(options) {
            if (!options || options.length === 0) return [];
            
            // Separar números y texto
            const numbers = [];
            const texts = [];
            
            options.forEach(option => {
                if (option === null || option === undefined) return;
                
                const strOption = option.toString().trim();
                if (strOption === '') return;
                
                // Verificar si es numérico
                if (/^\d+$/.test(strOption)) {
                    numbers.push(parseInt(strOption));
                } else {
                    texts.push(strOption);
                }
            });
            
            // Ordenar números
            numbers.sort((a, b) => a - b);
            
            // Ordenar texto
            texts.sort((a, b) => {
                // Orden natural para strings
                return a.localeCompare(b, undefined, { 
                    numeric: true, 
                    sensitivity: 'base' 
                });
            });
            
            // Combinar resultados
            return [...numbers.map(n => n.toString()), ...texts];
        }

        // Función para formatear el texto de las opciones según el tipo de filtro
        function formatOptionText(option, selectId) {
            if (!option && option !== 0) return 'N/A';
            
            const strOption = option.toString();
            
            // Aplicar formatos específicos según el tipo de filtro
            switch(selectId) {
                case 'ticketFilterBloque':
                    return `Bloque ${strOption}`;
                    
                case 'ticketFilterLado':
                    return `Lado ${strOption}`;
                    
                case 'ticketFilterNumeroBloque':
                    return `N° ${strOption.padStart(2, '0')}`;
                    
                case 'ticketFilterNivel':
                    return `Nivel ${strOption.padStart(2, '0')}`;
                    
                default:
                    return strOption;
            }
        }

        // Función sobrecargada para manejar diferentes tipos de datos
        function updateSelectOptions(selectElement, options, config = {}) {
            const {
                placeholder = 'Todos',
                sortFunction = null,
                formatFunction = null,
                allowEmpty = true
            } = config;

            if (!selectElement) {
                console.error('❌ Elemento select no válido');
                return;
            }

            // Guardar estado actual
            const currentValue = selectElement.value;
            const wasDisabled = selectElement.disabled;

            console.log(`🔄 Actualizando ${selectElement.id} con ${options?.length || 0} opciones`);

            // Limpiar select
            selectElement.innerHTML = '';

            // Agregar placeholder
            if (allowEmpty) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = placeholder;
                selectElement.appendChild(placeholderOption);
            }

            // Manejar casos sin opciones
            if (!options || options.length === 0) {
                if (!allowEmpty) {
                    const emptyOption = document.createElement('option');
                    emptyOption.value = "";
                    emptyOption.textContent = "Sin opciones";
                    emptyOption.disabled = true;
                    selectElement.appendChild(emptyOption);
                }
                return;
            }

            // Ordenar opciones si es necesario
            let sortedOptions = options;
            if (sortFunction) {
                sortedOptions = sortedOptions.sort(sortFunction);
            }

            // ✅ CORRECCIÓN: Manejar tanto arrays simples como objetos {value, text}
            sortedOptions.forEach(option => {
                const optionElement = document.createElement('option');
                
                // Determinar value y text
                let value, text;
                if (typeof option === 'object' && option !== null) {
                    value = option.value;
                    text = option.text || option.value;
                } else {
                    value = option;
                    text = option;
                }
                
                optionElement.value = value;
                
                // Formatear texto si hay función de formato
                if (formatFunction) {
                    optionElement.textContent = formatFunction(option);
                } else {
                    optionElement.textContent = text;
                }
                
                // Restaurar selección
                if (value === currentValue) {
                    optionElement.selected = true;
                }
                
                selectElement.appendChild(optionElement);
            });

            // Restaurar estado disabled
            selectElement.disabled = wasDisabled;

            console.log(`✅ ${selectElement.id} actualizado. ${sortedOptions.length} opciones disponibles`);
        }

        // ===== FUNCIÓN PARA INICIALIZAR FILTROS AL CARGAR DATOS =====
        function initializeLocationFilters() {
            console.log('🚀 Inicializando filtros de ubicación...');
            
            const bloques = new Set();
            const lados = new Set();
            const numerosBloque = new Set();
            const niveles = new Set();
            
            TicketExcelState.products.forEach(product => {
                if (product.bloque) bloques.add(product.bloque);
                if (product.lado) lados.add(product.lado);
                if (product.numeroBloque) numerosBloque.add(product.numeroBloque);
                if (product.nivel) niveles.add(product.nivel);
            });
            
            // ✅ ACTUALIZAR SELECT DE BLOQUE CON FORMATO SIMPLIFICADO
            const bloqueSelect = document.getElementById('ticketFilterBloque');
            if (bloqueSelect) {
                const bloqueOptions = Array.from(bloques).sort().map(bloque => ({
                    value: bloque,
                    text: formatFilterValue(bloque, 'bloque')
                }));
                
                updateSelectOptions(bloqueSelect, bloqueOptions, {
                    placeholder: 'Todos los bloques',
                    allowEmpty: true,
                    formatFunction: (opt) => opt.text
                });
            }
            
            // Inicializar opciones disponibles
            updateAvailableFilterOptions();
            updateFilterSelects();
            
            console.log('✅ Filtros inicializados correctamente');
        }

        // Función especializada para actualizar múltiples selects a la vez
        function updateMultipleSelects(selectsConfig) {
            selectsConfig.forEach(config => {
                const { selectElement, options, ...restConfig } = config;
                updateSelectOptions(selectElement, options, restConfig);
            });
        }

        function applyTicketFilters() {
            const searchTerm = document.getElementById('ticketSearchInput').value.toLowerCase().trim();
            const bloqueFilter = document.getElementById('ticketFilterBloque').value;
            const ladoFilter = document.getElementById('ticketFilterLado').value;
            const numeroBloqueFilter = document.getElementById('ticketFilterNumeroBloque').value;
            const nivelFilter = document.getElementById('ticketFilterNivel').value;

            // Actualizar estado de filtros
            TicketExcelState.filters = {
                ...TicketExcelState.filters,
                search: searchTerm,
                bloque: bloqueFilter,
                lado: ladoFilter,
                numeroBloque: numeroBloqueFilter,
                nivel: nivelFilter
            };

            // Actualizar opciones disponibles basado en los filtros actuales
            updateAvailableFilterOptions();
            
            // Actualizar los selects del DOM
            updateFilterSelects();

            // Aplicar filtros a los productos
            TicketExcelState.filteredProducts = TicketExcelState.products.filter(product => {
                // Filtro de búsqueda
                const matchesSearch = !searchTerm || 
                    product.codigo.toLowerCase().includes(searchTerm) ||
                    product.descripcion.toLowerCase().includes(searchTerm) ||
                    product.ubicacion.toLowerCase().includes(searchTerm);

                // Filtros de ubicación
                const matchesBloque = !bloqueFilter || product.bloque === bloqueFilter;
                const matchesLado = !ladoFilter || product.lado === ladoFilter;
                const matchesNumeroBloque = !numeroBloqueFilter || product.numeroBloque === numeroBloqueFilter;
                const matchesNivel = !nivelFilter || product.nivel === nivelFilter;

                return matchesSearch && matchesBloque && matchesLado && matchesNumeroBloque && matchesNivel;
            });

            // Resetear a página 1 al filtrar
            TicketExcelState.pagination.currentPage = 1;
            
            // Renderizar cards actualizadas
            renderTicketProductsTable();
            
            // Mostrar información de filtros activos
            updateActiveFiltersDisplay();
        }

        function updateActiveFiltersDisplay() {
            const activeFilters = [];
            const filters = TicketExcelState.filters;

            if (filters.search) {
                activeFilters.push(`Búsqueda: "${filters.search}"`);
            }
            if (filters.bloque) {
                activeFilters.push(`Bloque: ${filters.bloque}`);
            }
            if (filters.lado) {
                activeFilters.push(`Lado: ${filters.lado}`);
            }
            if (filters.numeroBloque) {
                activeFilters.push(`N° Bloque: ${filters.numeroBloque}`);
            }
            if (filters.nivel) {
                activeFilters.push(`Nivel: ${filters.nivel}`);
            }

            // Puedes mostrar esto en algún lugar de la UI si lo deseas
            console.log('Filtros activos:', activeFilters);
        }

        function clearAllFilters() {
            console.log('🧹 Limpiando todos los filtros...');
            
            // Limpiar inputs de filtros
            document.getElementById('ticketSearchInput').value = '';
            document.getElementById('ticketFilterBloque').value = '';
            document.getElementById('ticketFilterLado').value = '';
            document.getElementById('ticketFilterNumeroBloque').value = '';
            document.getElementById('ticketFilterNivel').value = '';
            
            // Resetear estado de filtros
            TicketExcelState.filters = {
                search: '',
                bloque: '',
                lado: '',
                numeroBloque: '',
                nivel: '',
                availableOptions: {
                    lados: [],
                    numerosBloque: [],
                    niveles: []
                }
            };
            
            // Resetear productos filtrados
            TicketExcelState.filteredProducts = [...TicketExcelState.products];
            
            // Resetear paginación
            TicketExcelState.pagination.currentPage = 1;
            
            // Actualizar opciones disponibles
            updateAvailableFilterOptions();
            updateFilterSelects();
            
            // Re-renderizar
            renderTicketProductsTable();
            
            showToast('Filtros limpiados correctamente', 'success');
        }

        function highlightSearchText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.toString().replace(regex, '<mark class="search-highlight">$1</mark>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function showTicketPreviewStep() {
            TicketExcelState.currentStep = 'preview';
            document.getElementById('ticketUploadStep').style.display = 'none';
            document.getElementById('ticketPreviewStep').style.display = 'block';
        }

        function backToTicketUpload() {
            TicketExcelState.currentStep = 'upload';
            document.getElementById('ticketUploadStep').style.display = 'block';
            document.getElementById('ticketPreviewStep').style.display = 'none';
            
            // Limpiar estado
            TicketExcelState.products = [];
            TicketExcelState.filteredProducts = [];
            TicketExcelState.fileData = null;
            TicketExcelState.pagination.currentPage = 1;
            
            // Limpiar cards
            document.getElementById('ticketProductsCardsContainer').innerHTML = '';
            
            // Resetear filtros
            clearAllFilters();
        }

        function downloadTicketTemplate() {
            // Crear datos de ejemplo para la plantilla
            const templateData = [
                ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA'],
                ['PROD001', 'Tornillo hexagonal 5mm', 'A1D0101', 'PZA'],
                ['PROD002', 'Tuerca 5mm galvanizada', 'A1D0102', 'PZA'],
                ['PROD003', 'Arandela plana 5mm', 'B2E0201', 'PZA'],
                ['PROD004', 'Perno largo 10cm', 'C3F0302', 'PZA']
            ];

            // Crear workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Estilizar un poco la plantilla
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = XLSX.utils.encode_cell({r: 0, c: C});
                if (!ws[cell_address]) continue;
                ws[cell_address].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFCCCCCC" } } };
            }

            XLSX.utils.book_append_sheet(wb, ws, "Plantilla");

            // Descargar
            XLSX.writeFile(wb, 'plantilla_tickets_gallos_marmol.xlsx');
            showToast('Plantilla descargada correctamente', 'success');
        }

        function showDeleteConfirmationModal(productId, product) {
            console.log('🗑️ Mostrando modal de confirmación para:', product.codigo);
            
            // Crear modal de confirmación
            const modalHtml = `
                <div class="delete-confirmation-modal" id="deleteConfirmationModal" style="display: block;">
                    <div class="modal-overlay">
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3 style="margin: 0; color: var(--danger-color);">
                                    <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                                </h3>
                                <button class="close-modal" id="closeDeleteModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="warning-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <div>
                                        <strong>¿Estás seguro de que deseas eliminar este producto?</strong>
                                        <p>Esta acción no se puede deshacer. El producto será removido de la lista actual.</p>
                                    </div>
                                </div>
                                
                                <div class="product-info-card">
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <strong>Código:</strong>
                                            <code class="product-code">${product.codigo}</code>
                                        </div>
                                        <div class="info-item">
                                            <strong>Descripción:</strong>
                                            <span>${product.descripcion}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>Ubicación:</strong>
                                            <code class="product-location">${product.ubicacion}</code>
                                        </div>
                                        <div class="info-item">
                                            <strong>Unidad:</strong>
                                            <span>${product.unidadMedida}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelDeleteBtn">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button class="btn btn-danger" id="confirmDeleteBtn">
                                    <i class="fas fa-trash"></i> Eliminar Producto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar modal en el DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            const modal = modalContainer.querySelector('.delete-confirmation-modal');
            
            // Animación de entrada
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // Event listeners para el modal
            document.getElementById('closeDeleteModal').addEventListener('click', closeModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                removeProductFromList(productId);
                closeModal();
            });
            
            // Cerrar modal al hacer click fuera
            modal.querySelector('.modal-overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Cerrar con ESC
            function handleEscape(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            }
            document.addEventListener('keydown', handleEscape);
            
            function closeModal() {
                modal.style.opacity = '0';
                setTimeout(() => {
                    document.removeEventListener('keydown', handleEscape);
                    modalContainer.remove();
                }, 300);
            }
        }

        function removeProductFromList(productId) {
            console.log('🗑️ Eliminando producto:', productId);
            
            const initialLength = TicketExcelState.products.length;
            
            // Eliminar de ambos arrays
            TicketExcelState.products = TicketExcelState.products.filter(p => p.id !== productId);
            TicketExcelState.filteredProducts = TicketExcelState.filteredProducts.filter(p => p.id !== productId);
            
            const finalLength = TicketExcelState.products.length;
            
            if (finalLength < initialLength) {
                showToast('Producto eliminado correctamente', 'success');
                
                // Si no quedan productos, volver al paso de upload
                if (TicketExcelState.products.length === 0) {
                    backToTicketUpload();
                } else {
                    // Re-renderizar la tabla
                    renderTicketProductsTable();
                    updateTicketLocationFilters();
                }
            } else {
                showToast('No se pudo eliminar el producto', 'error');
            }
        }

        function showPdfFormatModalForAll(source) {
            console.log('🚀 Abriendo modal PDF masivo - Diseño adaptable');
            
            // ✅ Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalAll').forEach(modal => modal.remove());

            // ✅ CREAR MODAL CON DISEÑO SENCILLO Y ADAPTABLE
            const modalHtml = `
                <div id="pdfFormatModalAll" class="simple-pdf-modal">
                    <div class="modal-overlay" onclick="window.closeSimpleModal()"></div>
                    <div class="modal-container simple-modal">
                        <!-- Header -->
                        <div class="modal-header simple-header">
                            <div class="header-title">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <h3>Generar PDF</h3>
                                    <p>${TicketExcelState.filteredProducts.length} productos seleccionados</p>
                                </div>
                            </div>
                            <button class="close-btn" onclick="window.closeSimpleModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body simple-body">
                            <div class="format-options">
                                <div class="format-option active" data-format="ticket-small-horizontal" onclick="window.selectSimpleFormat('ticket-small-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-tag"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Pequeño</h4>
                                        <p>7.5×5cm • Ideal para la mayoría de productos</p>
                                        <div class="format-meta">Recomendado</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="ticket-medium-horizontal" onclick="window.selectSimpleFormat('ticket-medium-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-expand-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Mediano</h4>
                                        <p>10×5cm • Más espacio para descripciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="compact-summary" onclick="window.selectSimpleFormat('compact-summary', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-list-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Resumen Compacto</h4>
                                        <p>Formato A4 • Múltiples productos por página</p>
                                        <div class="format-meta inventory">Inventario</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="summary-section">
                                <div class="summary-item">
                                    <span class="summary-label">Total de productos:</span>
                                    <span class="summary-value">${TicketExcelState.filteredProducts.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value format-selected" id="simpleFormatDisplay">Ticket Pequeño</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer simple-footer">
                            <button class="btn btn-cancel" onclick="window.closeSimpleModal()">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn btn-generate" onclick="window.generateSimplePdf('${source}')">
                                <i class="fas fa-file-pdf"></i>
                                Generar PDF
                                <span class="badge">${TicketExcelState.filteredProducts.length}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ✅ INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ✅ INICIALIZAR FUNCIONES GLOBALES
            window.simpleSelectedFormat = 'ticket-small-horizontal';

            window.closeSimpleModal = function() {
                const modal = document.getElementById('pdfFormatModalAll');
                if (modal) {
                    modal.classList.add('closing');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            window.selectSimpleFormat = function(format, element) {
                window.simpleSelectedFormat = format;
                
                // Remover activo de todos
                document.querySelectorAll('.format-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelector('.check-circle').classList.remove('active');
                });
                
                // Activar seleccionado
                element.classList.add('active');
                element.querySelector('.check-circle').classList.add('active');
                
                // Actualizar texto
                const formatNames = {
                    'ticket-small-horizontal': 'Ticket Pequeño',
                    'ticket-medium-horizontal': 'Ticket Mediano', 
                    'compact-summary': 'Resumen Compacto'
                };
                
                document.getElementById('simpleFormatDisplay').textContent = formatNames[format];
            };

            window.generateSimplePdf = function(source) {
                if (!window.simpleSelectedFormat) {
                    showToast('Selecciona un formato primero', 'warning');
                    return;
                }
                window.closeSimpleModal();
                setTimeout(() => generatePdfForAllProducts(window.simpleSelectedFormat, source), 100);
            };

            console.log('✅ Modal simple inicializado');
        }

        // ✅ AGREGAR ANIMACIÓN CSS CRÍTICA
        const criticalCSS = `
            @keyframes modalAppear {
                from {
                    opacity: 0;
                    transform: scale(0.9) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
            
            .pdf-modal-visible {
                visibility: visible !important;
                display: flex !important;
                opacity: 1 !important;
            }
        `;

        // Insertar CSS crítico si no existe
        if (!document.getElementById('critical-modal-css')) {
            const style = document.createElement('style');
            style.id = 'critical-modal-css';
            style.textContent = criticalCSS;
            document.head.appendChild(style);
        }

         function showPdfFormatModalForExcel(product) {
            console.log('📄 Abriendo modal PDF individual - Estilo unificado');
            
            // ✅ Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalIndividual').forEach(modal => modal.remove());

            // ✅ CREAR MODAL INDIVIDUAL CON MISMO ESTILO
            const modalHtml = `
                <div id="pdfFormatModalIndividual" class="simple-pdf-modal">
                    <div class="modal-overlay" onclick="window.closeSimpleModalIndividual()"></div>
                    <div class="modal-container simple-modal">
                        <!-- Header -->
                        <div class="modal-header simple-header">
                            <div class="header-title">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <h3>Generar PDF Individual</h3>
                                    <p>Producto: ${product.codigo}</p>
                                </div>
                            </div>
                            <button class="close-btn" onclick="window.closeSimpleModalIndividual()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body simple-body">
                            <!-- Información del Producto -->
                            <div class="product-info-card">
                                <div class="product-header">
                                    <h4>${product.codigo}</h4>
                                    <span class="product-badge">Individual</span>
                                </div>
                                <div class="product-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Descripción:</span>
                                        <span class="detail-value">${product.descripcion}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Ubicación:</span>
                                        <span class="detail-value location">${product.ubicacion}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Unidad:</span>
                                        <span class="detail-value unit">${product.unidadMedida}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de Formato -->
                            <div class="format-options">
                                <div class="format-option active" data-format="ticket-small-horizontal" onclick="window.selectSimpleFormatIndividual('ticket-small-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-tag"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Pequeño</h4>
                                        <p>7.5×5cm • Ideal para la mayoría de productos</p>
                                        <div class="format-meta">Recomendado</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="ticket-medium-horizontal" onclick="window.selectSimpleFormatIndividual('ticket-medium-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-expand-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Mediano</h4>
                                        <p>10×5cm • Más espacio para descripciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="summary-section">
                                <div class="summary-item">
                                    <span class="summary-label">Producto:</span>
                                    <span class="summary-value">${product.codigo}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value format-selected" id="simpleFormatDisplayIndividual">Ticket Pequeño</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer simple-footer">
                            <button class="btn btn-cancel" onclick="window.closeSimpleModalIndividual()">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn btn-generate" onclick="window.generateSimplePdfIndividual('${product.id}')">
                                <i class="fas fa-file-pdf"></i>
                                Generar PDF Individual
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ✅ INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ✅ GUARDAR PRODUCTO PARA USO POSTERIOR
            window.currentProductIndividual = product;

            // ✅ INICIALIZAR FUNCIONES GLOBALES
            window.simpleSelectedFormatIndividual = 'ticket-small-horizontal';

            window.closeSimpleModalIndividual = function() {
                const modal = document.getElementById('pdfFormatModalIndividual');
                if (modal) {
                    modal.classList.add('closing');
                    setTimeout(() => {
                        modal.remove();
                        delete window.currentProductIndividual;
                        delete window.simpleSelectedFormatIndividual;
                        delete window.closeSimpleModalIndividual;
                        delete window.selectSimpleFormatIndividual;
                        delete window.generateSimplePdfIndividual;
                    }, 300);
                }
            };

            window.selectSimpleFormatIndividual = function(format, element) {
                window.simpleSelectedFormatIndividual = format;
                
                // Remover activo de todos
                document.querySelectorAll('#pdfFormatModalIndividual .format-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelector('.check-circle').classList.remove('active');
                });
                
                // Activar seleccionado
                element.classList.add('active');
                element.querySelector('.check-circle').classList.add('active');
                
                // Actualizar texto
                const formatNames = {
                    'ticket-small-horizontal': 'Ticket Pequeño',
                    'ticket-medium-horizontal': 'Ticket Mediano'
                };
                
                const displayElement = document.getElementById('simpleFormatDisplayIndividual');
                if (displayElement) {
                    displayElement.textContent = formatNames[format] || format;
                }
            };

            window.generateSimplePdfIndividual = function(productId) {
                const format = window.simpleSelectedFormatIndividual;
                const product = window.currentProductIndividual;
                
                console.log('🚀 Generando PDF individual:', {
                    product: product?.codigo,
                    format: format
                });
                
                if (!format || !product) {
                    showToast('Error al generar el PDF', 'error');
                    return;
                }

                window.closeSimpleModalIndividual();
                
                // Pequeño delay antes de generar
                setTimeout(() => {
                    generateSinglePdf(product, format);
                }, 100);
            };

            console.log('✅ Modal individual unificado inicializado');
        }

        function simulatePdfGeneration(products, format) {
            let currentProgress = 0;
            const totalProducts = products.length;
            const progressIncrement = 100 / totalProducts;
            
            // Paso 1: Preparación completada
            pdfProgress.updateStep(2, 'active');
            pdfProgress.updateStatus('Iniciando generación de tickets...');
            
            // Simular procesamiento de cada producto
            const processNextProduct = (index) => {
                if (index >= totalProducts || pdfProgress.isCancelled) {
                    if (!pdfProgress.isCancelled) {
                        pdfProgress.updateStep(4, 'active');
                        pdfProgress.showSuccess();
                        
                        setTimeout(() => {
                            pdfProgress.hide();
                            showToast(`PDF generado para ${totalProducts} productos`, 'success');
                        }, 1500);
                    }
                    return;
                }
                
                const product = products[index];
                currentProgress += progressIncrement;
                
                // Actualizar progreso
                pdfProgress.updateProgress(
                    Math.min(currentProgress, 100),
                    index + 1,
                    totalProducts
                );
                
                // Actualizar mensaje de estado
                pdfProgress.updateStatus(`Generando ticket para: ${product.codigo} - ${product.descripcion.substring(0, 30)}...`);
                
                // Simular tiempo de procesamiento
                setTimeout(() => {
                    // Avanzar al siguiente producto
                    processNextProduct(index + 1);
                    
                    // Actualizar paso de códigos QR al 50%
                    if (index === Math.floor(totalProducts / 2)) {
                        pdfProgress.updateStep(3, 'active');
                        pdfProgress.updateStatus('Generando códigos QR...');
                    }
                }, 100);
            };
            
            // Iniciar procesamiento
            processNextProduct(0);
        }

        function exportToExcel() {
            try {
                const products = TicketExcelState.filteredProducts;
                
                if (!products || products.length === 0) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }
                
                // Preparar datos
                const excelData = [
                    ['CÓDIGO', 'DESCRIPCIÓN', 'UBICACIÓN', 'UNIDAD_MEDIDA', 'BLOQUE', 'LADO', 'N° BLOQUE', 'NIVEL']
                ];
                
                products.forEach(product => {
                    excelData.push([
                        product.codigo,
                        product.descripcion,
                        product.ubicacion,
                        product.unidadMedida,
                        product.bloque,
                        product.lado,
                        product.numeroBloque,
                        product.nivel
                    ]);
                });
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                XLSX.utils.book_append_sheet(wb, ws, "Productos");
                
                // Descargar
                const fileName = `productos_gallos_marmol_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast(`Exportados ${products.length} productos a Excel`, 'success');
                
            } catch (error) {
                console.error('❌ Error exportando a Excel:', error);
                showToast('Error al exportar a Excel: ' + error.message, 'error');
            }
        }

        // 1. Función para obtener la librería QR Code
        function getQRCodeLibrary() {
            if (typeof qrcode !== 'undefined') {
                return qrcode;
            }
            
            // Intentar cargar desde diferentes fuentes
            if (window.QRCode) {
                return window.QRCode;
            }
            
            console.warn('Librería QR Code no disponible');
            return null;
        }        

        // 2. Función mejorada para generar códigos QR
        async function generateQRCodeDataURL(text) {
            return new Promise(async (resolve) => {
                try {
                    const qrcode = getQRCodeLibrary();
                    
                    if (!qrcode) {
                        console.warn('QRCode library not available');
                        resolve(null);
                        return;
                    }
                
                    const typeNumber = 4; // 0-40, 0=auto
                    const errorCorrectionLevel = 'L'; // L, M, Q, H
                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                    
                    qr.addData(text);
                    qr.make();
                    
                    // Crear canvas para el QR
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const moduleCount = qr.getModuleCount();
                    const scale = 3; // Escala para mejor calidad
                    const size = moduleCount * scale;
                    
                    canvas.width = size;
                    canvas.height = size;
                    
                    // Dibujar fondo blanco
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);
                    
                    // Dibujar módulos del QR
                    ctx.fillStyle = '#000000';
                    
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(col * scale, row * scale, scale, scale);
                            }
                        }
                    }
                    
                    // Convertir a Data URL
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                    
                } catch (error) {
                    console.error('Error generando QR:', error);
                    resolve(null);
                }
            });
        }

        // 3. Función para generar PDF individual - Ticket Pequeño Horizontal
        async function generateSmallHorizontalTicket(product) {                       
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar producto
                if (!product) {
                    showToast('Producto no válido para generar ticket', 'error');
                    return;
                }

                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    showToast(`Error: ${validation.error}`, 'error');
                    return;
                }

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(1, 'ticket-small-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus(`Creando ticket pequeño para: ${product.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                const userName = AppState.currentUser?.email || 'Usuario';

                // ✅ ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(20);
                pdfProgress.updateStatus('Configurando formato del ticket...');

                // ===== DIMENSIONES =====
                const pageWidth = 7.5;
                const pageHeight = 5;
                const margin = 0.4;
                let currentY = 0.5;

                // ===== FONDO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(40);
                pdfProgress.updateStatus('Agregando información del producto...');

                // ===== CÓDIGO DEL PRODUCTO (PRINCIPAL) =====
                currentY += 0.1;
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.1;

                // Línea separadora
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.05);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 0.4;

                // ===== DESCRIPCIÓN =====
                pdf.setFontSize(7);
                pdf.setTextColor(40, 40, 40);
                pdf.setFont('helvetica', 'normal');
                
                const descripcion = product.descripcion || 'Sin descripción';
                const maxWidth = pageWidth - (margin * 2);
                const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                
                // Fondo para descripción
                pdf.setFillColor(255, 255, 255);
                const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                
                pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.6;

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(60);
                pdfProgress.updateStatus('Agregando detalles del producto...');

                // ===== UNIDAD Y UBICACIÓN =====
                const details = [
                    { 
                        label: 'UNIDAD DE MEDIDA', 
                        value: product.unidadMedida || 'N/A',
                        background: [255, 255, 255]
                    },
                    { 
                        label: 'UBICACIÓN', 
                        value: product.ubicacion || 'N/A',
                        background: [255, 255, 255]
                    }
                ];

                details.forEach((detail, index) => {
                    if (currentY < pageHeight - 1.8) {
                        const boxWidth = (pageWidth - (margin * 2) - 0.2) / 2;
                        const boxX = margin + (index * (boxWidth + 0.2));
                        
                        pdf.setFillColor(detail.background[0], detail.background[1], detail.background[2]);
                        pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                        
                        // Etiqueta
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                        
                        // Valor
                        pdf.setFontSize(8);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                    }
                });

                currentY += 0.7;

                // ✅ ACTUALIZAR PROGRESO PARA QR
                pdfProgress.updateProgress(80);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando código QR...');

                // ===== CÓDIGO QR =====
                const qrDataURL = await generateQRCodeDataURL(product.codigo);
                
                if (qrDataURL) {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    // Fondo para QR
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.15, 0.15, 'F');
                    
                    // Agregar QR
                    pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    
                    pdfProgress.updateStatus('✅ Código QR generado correctamente');
                } else {
                    // Placeholder si QR no está disponible
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setFillColor(245, 245, 245);
                    pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.15, 0.15, 'FD');
                    
                    pdf.setFontSize(5);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.1, { align: 'center' });
                    pdf.text('NO DISP.', pageWidth / 2, currentY + qrSize / 2 + 0.1, { align: 'center' });
                    
                    pdfProgress.updateStatus('⚠️ Código QR no disponible', 'warning');
                }

                // ✅ ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Agregando información de generación...');

                // ===== PIE DE PÁGINA =====
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.02);
                pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                pdf.setFontSize(4);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                pdf.text(`Por: ${userName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                // ✅ MOSTRAR ÉXITO Y GUARDAR
                pdfProgress.updateProgress(100);
                pdfProgress.updateStatus('Preparando descarga del ticket...');
                
                // Pequeño delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR =====
                const fileName = `ticket_${product.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // ✅ MOSTRAR ÉXITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar después de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    
                    if (qrDataURL) {
                        showToast(`Ticket pequeño con QR generado para ${product.codigo}`, 'success');
                    } else {
                        showToast(`Ticket pequeño generado para ${product.codigo} (sin QR)`, 'info');
                    }
                }, 2000);

            } catch (error) {
                console.error('Error generando ticket pequeño:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar después de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el ticket pequeño', 'error');
                }, 3000);
            }
        }

        // 4. Función para generar PDF individual - Ticket Mediano Horizontal
        async function generateMediumHorizontalTicket(product) {                      
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar producto
                if (!product) {
                    showToast('Producto no válido para generar ticket', 'error');
                    return;
                }

                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    showToast(`Error: ${validation.error}`, 'error');
                    return;
                }

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(1, 'ticket-medium-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus(`Creando ticket mediano para: ${product.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [10, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                const userName = AppState.currentUser?.email || 'Usuario';

                // ✅ ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(20);
                pdfProgress.updateStatus('Configurando formato del ticket mediano...');

                // ===== DIMENSIONES =====
                const pageWidth = 10;
                const pageHeight = 5;
                const margin = 0.5;
                let currentY = 0.5;

                // ===== FONDO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(40);
                pdfProgress.updateStatus('Agregando información del producto...');

                // ===== CÓDIGO DEL PRODUCTO (PRINCIPAL) =====
                currentY += 0.1;
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.1;

                // Línea separadora
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.05);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 0.4;

                // ===== DESCRIPCIÓN =====
                pdf.setFontSize(7);
                pdf.setTextColor(40, 40, 40);
                pdf.setFont('helvetica', 'normal');
                
                const descripcion = product.descripcion || 'Sin descripción';
                const maxWidth = pageWidth - (margin * 2);
                const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                
                // Fondo para descripción
                pdf.setFillColor(255, 255, 255);
                const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                
                pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.6;

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(60);
                pdfProgress.updateStatus('Agregando detalles del producto...');

                // ===== UNIDAD Y UBICACIÓN =====
                const details = [
                    { 
                        label: 'UNIDAD DE MEDIDA', 
                        value: product.unidadMedida || 'N/A',
                        background: [255, 255, 255]
                    },
                    { 
                        label: 'UBICACIÓN', 
                        value: product.ubicacion || 'N/A',
                        background: [255, 255, 255]
                    }
                ];

                details.forEach((detail, index) => {
                    if (currentY < pageHeight - 1.8) {
                        const boxWidth = (pageWidth - (margin * 2) - 0.2) / 2;
                        const boxX = margin + (index * (boxWidth + 0.2));
                        
                        pdf.setFillColor(detail.background[0], detail.background[1], detail.background[2]);
                        pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                        
                        // Etiqueta
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                        
                        // Valor
                        pdf.setFontSize(8);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                    }
                });

                currentY += 0.7;

                // ✅ ACTUALIZAR PROGRESO PARA QR
                pdfProgress.updateProgress(80);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando código QR...');

                // ===== CÓDIGO QR =====
                const qrDataURL = await generateQRCodeDataURL(product.codigo);
                
                if (qrDataURL) {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(qrX - 0.15, currentY - 0.15, qrSize + 0.3, qrSize + 0.3, 0.2, 0.2, 'F');
                    
                    pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    
                    pdfProgress.updateStatus('✅ Código QR generado correctamente');
                } else {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setFillColor(245, 245, 245);
                    pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.2, 0.2, 'FD');
                    
                    pdf.setFontSize(6);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('CÓDIGO', pageWidth / 2, currentY + qrSize / 2 - 0.15, { align: 'center' });
                    pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.02, { align: 'center' });
                    pdf.text('NO DISPONIBLE', pageWidth / 2, currentY + qrSize / 2 + 0.15, { align: 'center' });
                    
                    pdfProgress.updateStatus('⚠️ Código QR no disponible', 'warning');
                }

                // ✅ ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Agregando información de generación...');

                // ===== PIE DE PÁGINA =====
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.02);
                pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                pdf.setFontSize(4);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                pdf.text(`Por: ${userName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                // ✅ MOSTRAR ÉXITO Y GUARDAR
                pdfProgress.updateProgress(100);
                pdfProgress.updateStatus('Preparando descarga del ticket...');
                
                // Pequeño delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR =====
                const fileName = `ticket_${product.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // ✅ MOSTRAR ÉXITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar después de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    
                    if (qrDataURL) {
                        showToast('Ticket mediano con código QR generado', 'success');
                    } else {
                        showToast('Ticket mediano generado (sin QR)', 'info');
                    }
                }, 2000);

            } catch (error) {
                console.error('Error generando ticket mediano:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar después de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el ticket mediano', 'error');
                }, 3000);
            }
        }

        // 5. Función para generar TODOS los tickets pequeños
        async function generateAllSmallHorizontalTicketsFromExcel() {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }

            try {
                const validProducts = TicketExcelState.filteredProducts.filter(product => 
                    validateProductForPdf(product).isValid
                );

                if (validProducts.length === 0) {
                    showToast('No hay productos válidos para generar tickets', 'warning');
                    return;
                }

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(validProducts.length, 'ticket-small-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento PDF...');

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                const userName = AppState.currentUser?.email || 'Usuario';

                for (let index = 0; index < validProducts.length; index++) {
                    // ✅ VERIFICAR SI SE CANCELÓ
                    if (pdfProgress.isCancelled) {
                        console.log('Generación cancelada por el usuario');
                        return;
                    }

                    const product = validProducts[index];
                    
                    if (index > 0) {
                        pdf.addPage([7.5, 5], 'landscape');
                    }

                    // ✅ ACTUALIZAR PROGRESO
                    const progress = ((index + 1) / validProducts.length) * 100;
                    pdfProgress.updateProgress(progress, index + 1, validProducts.length);
                    pdfProgress.updateStatus(`Generando ticket para: ${product.codigo}`);

                    // ===== DIMENSIONES =====
                    const pageWidth = 7.5;
                    const pageHeight = 5;
                    const margin = 0.4;
                    let currentY = 0.5;

                    // ===== FONDO =====
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                    // ===== CÓDIGO DEL PRODUCTO (PRINCIPAL) =====
                    currentY += 0.1;
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.1;

                    // Línea separadora
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.05);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 0.4;

                    // ===== DESCRIPCIÓN =====
                    pdf.setFontSize(7);
                    pdf.setTextColor(40, 40, 40);
                    pdf.setFont('helvetica', 'normal');
                    
                    const descripcion = product.descripcion || 'Sin descripción';
                    const maxWidth = pageWidth - (margin * 2);
                    const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                    
                    // Fondo para descripción
                    pdf.setFillColor(255, 255, 255);
                    const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                    pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                    
                    pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.6;

                    // ===== UNIDAD Y UBICACIÓN =====
                    const details = [
                        { 
                            label: 'UNIDAD DE MEDIDA', 
                            value: product.unidadMedida || 'N/A',
                            background: [255, 255, 255]
                        },
                        { 
                            label: 'UBICACIÓN', 
                            value: product.ubicacion || 'N/A',
                            background: [255, 255, 255]
                        }
                    ];

                    details.forEach((detail, detailIndex) => {
                        if (currentY < pageHeight - 1.2) {
                            const boxWidth = (pageWidth - (margin * 2) - 0.2) / 2;
                            const boxX = margin + (detailIndex * (boxWidth + 0.2));
                            
                            pdf.setFillColor(detail.background[0], detail.background[1], detail.background[2]);
                            pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                            
                            // Etiqueta
                            pdf.setFontSize(7);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(80, 80, 80);
                            pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                            
                            // Valor
                            pdf.setFontSize(8);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                        }
                    });

                    currentY += 0.7;

                    // ===== CÓDIGO QR =====
                    pdfProgress.updateStep(3, 'active');
                    pdfProgress.updateStatus(`Generando código QR para: ${product.codigo}`);
                    
                    const qrDataURL = await generateQRCodeDataURL(product.codigo);
                    
                    if (qrDataURL) {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.1, 0.1, 'F');
                        
                        pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    }

                    // ===== PIE DE PÁGINA =====
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.02);
                    pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                    pdf.setFontSize(4);
                    pdf.setTextColor(120, 120, 120);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                    pdf.text(`Por: ${userName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                    // Pequeña pausa para que se vea el progreso
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // ✅ MOSTRAR ÉXITO
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Guardando archivo PDF...');

                // ===== GUARDAR PDF =====
                const fileName = `tickets_pequenos_${now.getTime()}.pdf`;
                
                // Pequeño delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));
                
                pdf.save(fileName);
                
                // ✅ MOSTRAR ÉXITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar después de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`PDF con ${validProducts.length} tickets pequeños generado`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error generando tickets pequeños:', error);
                pdfProgress.showError(error);
                
                // Ocultar después de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar tickets pequeños: ' + error.message, 'error');
                }, 3000);
            }
        }

        // 6. Función para generar TODOS los tickets medianos
        async function generateAllMediumHorizontalTicketsFromExcel() {                        
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }

            try {
                const validProducts = TicketExcelState.filteredProducts.filter(product => 
                    validateProductForPdf(product).isValid
                );

                if (validProducts.length === 0) {
                    showToast('No hay productos válidos para generar tickets', 'warning');
                    return;
                }

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(validProducts.length, 'ticket-medium-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento PDF para tickets medianos...');

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [10, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                const userName = AppState.currentUser?.email || 'Usuario';

                for (let index = 0; index < validProducts.length; index++) {
                    // ✅ VERIFICAR SI SE CANCELÓ
                    if (pdfProgress.isCancelled) {
                        console.log('Generación de tickets medianos cancelada por el usuario');
                        return;
                    }

                    const product = validProducts[index];
                    
                    if (index > 0) {
                        pdf.addPage([10, 5], 'landscape');
                        pdfProgress.updateStatus(`Agregando página ${index + 1} para: ${product.codigo}`);
                    }

                    // ✅ ACTUALIZAR PROGRESO
                    const progress = ((index + 1) / validProducts.length) * 100;
                    pdfProgress.updateProgress(progress, index + 1, validProducts.length);
                    pdfProgress.updateStatus(`Generando ticket mediano para: ${product.codigo}`);

                    // ===== DIMENSIONES =====
                    const pageWidth = 10;
                    const pageHeight = 5;
                    const margin = 0.5;
                    let currentY = 0.5;

                    // ===== FONDO =====
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                    // ===== CÓDIGO DEL PRODUCTO (PRINCIPAL) =====
                    currentY += 0.1;
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.1;

                    // Línea separadora
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.05);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 0.4;

                    // ===== DESCRIPCIÓN =====
                    pdf.setFontSize(7);
                    pdf.setTextColor(40, 40, 40);
                    pdf.setFont('helvetica', 'normal');
                    
                    const descripcion = product.descripcion || 'Sin descripción';
                    const maxWidth = pageWidth - (margin * 2);
                    const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                    
                    // Fondo para descripción
                    pdf.setFillColor(255, 255, 255);
                    const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                    pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                    
                    pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.6;
                    
                    // ===== UNIDAD Y UBICACIÓN =====
                    const details = [
                        { 
                            label: 'UNIDAD DE MEDIDA', 
                            value: product.unidadMedida || 'N/A',
                            background: [255, 255, 255]
                        },
                        { 
                            label: 'UBICACIÓN', 
                            value: product.ubicacion || 'N/A',
                            background: [255, 255, 255]
                        }
                    ];

                    details.forEach((detail, detailIndex) => {
                        if (currentY < pageHeight - 1.8) {
                            const boxWidth = (pageWidth - (margin * 2) - 0.2) / 2;
                            const boxX = margin + (detailIndex * (boxWidth + 0.2));
                            
                            pdf.setFillColor(detail.background[0], detail.background[1], detail.background[2]);
                            pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                            
                            // Etiqueta
                            pdf.setFontSize(7);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(80, 80, 80);
                            pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                            
                            // Valor
                            pdf.setFontSize(8);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                        }
                    });

                    currentY += 0.7;

                    // ===== CÓDIGO QR =====
                    pdfProgress.updateStep(3, 'active');
                    pdfProgress.updateStatus(`Generando código QR para: ${product.codigo}`);
                    
                    const qrDataURL = await generateQRCodeDataURL(product.codigo);
                    
                    if (qrDataURL) {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(qrX - 0.15, currentY - 0.15, qrSize + 0.3, qrSize + 0.3, 0.2, 0.2, 'F');
                        
                        pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                        
                        pdfProgress.updateStatus(`✅ QR generado para: ${product.codigo}`);
                    } else {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setDrawColor(200, 200, 200);
                        pdf.setFillColor(245, 245, 245);
                        pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.2, 0.2, 'FD');
                        
                        pdf.setFontSize(6);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text('CÓDIGO', pageWidth / 2, currentY + qrSize / 2 - 0.15, { align: 'center' });
                        pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.02, { align: 'center' });
                        pdf.text('NO DISPONIBLE', pageWidth / 2, currentY + qrSize / 2 + 0.15, { align: 'center' });
                        
                        pdfProgress.updateStatus(`⚠️ QR no disponible para: ${product.codigo}`, 'warning');
                    }

                    // ===== PIE DE PÁGINA =====
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.02);
                    pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                    pdf.setFontSize(4);
                    pdf.setTextColor(120, 120, 120);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                    pdf.text(`Por: ${userName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                    // Pequeña pausa para que se vea el progreso
                    if (index % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // ✅ MOSTRAR ÉXITO Y GUARDAR
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Finalizando documento y preparando descarga...');
                
                // Pequeño delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR PDF =====
                const fileName = `tickets_medianos_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // ✅ MOSTRAR ÉXITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar después de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`PDF con ${validProducts.length} tickets medianos generado`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error generando tickets medianos:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar después de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar tickets medianos: ' + error.message, 'error');
                }, 3000);
            }
        }

        // 7. Función para generar resumen compacto
        async function generateCompactSummaryPdfFromExcel() {                        
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }

            try {
                // Validar que hay productos
                if (!TicketExcelState.filteredProducts || TicketExcelState.filteredProducts.length === 0) {
                    showToast('No hay productos para generar el resumen', 'warning');
                    return;
                }

                const totalProducts = TicketExcelState.filteredProducts.length;

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(totalProducts, 'compact-summary');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento de resumen compacto...');

                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString();
                const userName = AppState.currentUser?.email || 'Usuario';

                let currentY = 20;
                const margin = 15;
                const pageWidth = 210;
                const contentWidth = pageWidth - (margin * 2);

                // ✅ ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(10);
                pdfProgress.updateStatus('Configurando encabezados y formato...');

                // Encabezado
                pdf.setFontSize(16);
                pdf.setTextColor(0, 75, 107);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GALLOS MÁRMOL', margin, currentY);
                
                currentY += 8;
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Generado: ${generationDate} ${generationTime} • Por: ${userName}`, margin, currentY);
                pdf.text(`Productos: ${totalProducts}`, margin, currentY + 5);
                
                currentY += 15;

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(30);
                pdfProgress.updateStatus('Preparando tabla de productos...');

                // Tabla de productos
                const rowHeight = 8;
                const headers = ['Código', 'Descripción', 'Ubicación', 'Unidad'];
                const columnWidths = [25, 100, 25, 25];
                
                // Encabezados de tabla
                pdf.setFillColor(0, 75, 107);
                pdf.setTextColor(255, 255, 255);
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                
                let xPosition = margin;
                headers.forEach((header, index) => {
                    pdf.rect(xPosition, currentY, columnWidths[index], rowHeight, 'F');
                    pdf.text(header, xPosition + 2, currentY + 5);
                    xPosition += columnWidths[index];
                });
                
                currentY += rowHeight;

                // ✅ ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(50);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando contenido de la tabla...');

                // Filas de productos
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                
                TicketExcelState.filteredProducts.forEach((product, index) => {
                    // ✅ ACTUALIZAR PROGRESO DURANTE LA GENERACIÓN
                    if (index % 10 === 0) {
                        const progress = 50 + (index / totalProducts) * 40;
                        pdfProgress.updateProgress(progress, index + 1, totalProducts);
                        pdfProgress.updateStatus(`Procesando producto ${index + 1} de ${totalProducts}...`);
                    }

                    // Verificar si necesita nueva página
                    if (currentY > 270) {
                        pdf.addPage();
                        currentY = 20;
                        
                        // Volver a dibujar encabezados en nueva página
                        pdf.setFillColor(0, 75, 107);
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFont('helvetica', 'bold');
                        
                        let xPos = margin;
                        headers.forEach((header, idx) => {
                            pdf.rect(xPos, currentY, columnWidths[idx], rowHeight, 'F');
                            pdf.text(header, xPos + 2, currentY + 5);
                            xPos += columnWidths[idx];
                        });
                        
                        currentY += rowHeight;
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFont('helvetica', 'normal');
                    }
                    
                    // Fila con fondo alternado
                    if (index % 2 === 0) {
                        pdf.setFillColor(245, 245, 245);
                        pdf.rect(margin, currentY, contentWidth, rowHeight, 'F');
                    }
                    
                    // Contenido de la fila
                    let xPos = margin;
                    
                    // Código
                    pdf.text(product.codigo || 'N/A', xPos + 2, currentY + 5);
                    xPos += columnWidths[0];
                    
                    // Descripción (con wrap)
                    const descripcion = product.descripcion || 'Sin descripción';
                    const descLines = pdf.splitTextToSize(descripcion, columnWidths[1] - 4);
                    pdf.text(descLines, xPos + 2, currentY + 5);
                    xPos += columnWidths[1];
                    
                    // Ubicación
                    pdf.text(product.ubicacion || 'N/A', xPos + 2, currentY + 5);
                    xPos += columnWidths[2];
                    
                    // Unidad
                    pdf.text(product.unidadMedida || 'N/A', xPos + 2, currentY + 5);
                    
                    currentY += rowHeight;
                });

                // ✅ ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Preparando archivo para descarga...');

                currentY += 10;

                const fileName = `inventario_excel_${now.getTime()}.pdf`;
                
                // Pequeño delay para que se vea el progreso final
                setTimeout(() => {
                    pdf.save(fileName);
                    
                    // ✅ MOSTRAR ÉXITO
                    pdfProgress.showSuccess();
                    
                    setTimeout(() => {
                        pdfProgress.hide();
                        showToast(`Resumen con ${totalProducts} productos generado`, 'success');
                    }, 2000);
                }, 500);

            } catch (error) {
                console.error('Error generando resumen compacto:', error);
                
                pdfProgress.showError(error);
                
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el inventario: ' + error.message, 'error');
                }, 3000);
            }
        }

        // 8. Función principal para manejar la generación de PDFs masivos
        function generatePdfForAllProducts(format, source) {
            switch (format) {
                case 'ticket-small-horizontal':
                    generateAllSmallHorizontalTicketsFromExcel();
                    break;
                case 'ticket-medium-horizontal':
                    generateAllMediumHorizontalTicketsFromExcel();
                    break;
                case 'compact-summary':
                    generateCompactSummaryPdfFromExcel();
                    break;
                default:
                    showToast('Formato de PDF no válido', 'error');
            }
        }

        // 9. Función para manejar PDFs individuales
        function generateSinglePdf(product, format) {
            switch (format) {
                case 'ticket-small-horizontal':
                    generateSmallHorizontalTicket(product);
                    break;
                case 'ticket-medium-horizontal':
                    generateMediumHorizontalTicket(product);
                    break;
                default:
                    showToast('Formato de PDF no válido', 'error');
            }
        }

        // 10. Función de validación de productos para PDF
        function validateProductForPdf(product) {
            if (!product) {
                return { isValid: false, error: 'Producto no válido' };
            }
            
            if (!product.codigo || product.codigo.trim() === '') {
                return { isValid: false, error: 'El código del producto es requerido' };
            }
            
            if (!product.descripcion || product.descripcion.trim() === '') {
                return { isValid: false, error: 'La descripción del producto es requerida' };
            }
            
            if (!product.ubicacion || product.ubicacion.trim() === '') {
                return { isValid: false, error: 'La ubicación del producto es requerida' };
            }
            
            if (product.ubicacion.length !== 7) {
                return { isValid: false, error: 'La ubicación debe tener 7 caracteres' };
            }
            
            // Validar formato de ubicación (A1D0101)
            const ubicacionRegex = /^[A-Z][0-9A-Z][A-Z][0-9]{2}[0-9]{2}$/;
            if (!ubicacionRegex.test(product.ubicacion)) {
                return { isValid: false, error: 'Formato de ubicación inválido. Use: A1D0101' };
            }
            
            if (!product.unidadMedida || product.unidadMedida.trim() === '') {
                return { isValid: false, error: 'La unidad de medida es requerida' };
            }
            
            return { isValid: true };
        }

        // ===== INICIALIZACIÓN DE LA APLICACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando aplicación Gallos Mármol...');
            
            // Verificar dependencias
            if (typeof supabase === 'undefined') {
                console.error('❌ Supabase no está cargado');
                showToast('Error: No se pudo conectar con el servidor', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                console.error('❌ SheetJS no está cargado');
                showToast('Error: No se pudo cargar el sistema de archivos', 'error');
                return;
            }
            
            // Inicializar autenticación
            initializeAuth();
            
            console.log('✅ Aplicación inicializada correctamente');
        });

        // Manejar errores no capturados
        window.addEventListener('error', function(e) {
            console.error('❌ Error no capturado:', e.error);
            showToast('Error inesperado en la aplicación', 'error');
        });

        // Manejar promesas rechazadas no capturadas
        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Promesa rechazada no capturada:', e.reason);
            showToast('Error en operación asíncrona', 'error');
            e.preventDefault();
        });
    </script>
</body>
</html>

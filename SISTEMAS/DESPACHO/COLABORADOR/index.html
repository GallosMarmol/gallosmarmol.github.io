<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Despacho - Colaborador</title>
    <meta name="description" content="Sistema de gesti칩n de productos para 치rea de despacho de Gallos M치rmol">
    <meta name="keywords" content="gallos m치rmol, productos, despacho, tickets">
    <meta name="author" content="Gallos M치rmol">
    <link rel="icon" type="image/x-icon" href="../../FOTO/ICONO/Icono_01.ico">
    
    <!-- Librer칤as externas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Librer칤a QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="../../JS/auth-check.js"></script>

    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --danger-color: #e74c3c;
            --danger-light: #ec7063;
            --light-color: #ecf0f1;
            --light-gray: #f8f9fa;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #fff;
            --text-muted: #6c757d;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --header-height: 70px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --primary-light: #006494;
            --secondary-color: #0078d4;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #d68910;
            --warning-light: #f8c471;
            --danger-color: #cb4335;
            --danger-light: #ec7063;
            --light-color: #2c2c2c;
            --light-gray: #1e1e1e;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== ESTRUCTURA PRINCIPAL ===== */
        #app {
            min-height: 100vh;
        }

        /* ===== HEADER MOBILE-FIRST ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 60%;
        }

        .logo-img {
            height: 45px;
            width: auto;
            border-radius: var(--border-radius-sm);
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle, .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover, .fullscreen-btn:hover {
            background-color: var(--light-color);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-info {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            display: inline-block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            padding-top: var(--header-height);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ===== NAVEGACI칍N POR PESTA칌AS ===== */
        .nav-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            font-size: 0.9rem;
            text-align: center;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== SECCIONES ===== */
        .generate-ticket-section {
            display: none;
        }

        .generate-ticket-section.active {
            display: block;
        }

        .section-title {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Estilos para el selector de modo */
        .mode-option.active .mode-card {
            border-color: var(--primary-color) !important;
            background: rgba(52, 152, 219, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .mode-card:hover {
            border-color: var(--secondary-color) !important;
            transform: translateY(-2px);
            transition: var(--transition);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mode-options {
                grid-template-columns: 1fr !important;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }

        /* Estilos para filtros deshabilitados */
        .filter-select:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .form-group:has(.filter-select:disabled) {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .form-group:has(.filter-select:disabled) .filter-label {
            color: var(--text-muted);
        }

        /* Estilos para sugerencias de b칰squeda */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.25rem;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .suggestion-item:hover {
            background: var(--light-color);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Mejorar el contenedor de b칰squeda */
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        /* Tooltip para filtros deshabilitados */
        .form-group[title]:hover::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }


        /* ===== FORMULARIO DE NUEVO PRODUCTO ===== */
        .product-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Estilos para el modal mejorado */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay {
            backdrop-filter: blur(5px);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* ===== ESTILOS ESPEC칈FICOS PARA EL MODAL DE C츼MARA ===== */
        #cameraModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #cameraModal.active {
            display: flex;
        }

        #cameraModal .modal-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cameraModal .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        /* Asegurar que el modal-overlay ocupe toda la pantalla */
        #cameraModal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        /* Responsive para m칩viles */
        @media (max-width: 768px) {
            #cameraModal {
                padding: 0.5rem;
            }
            
            #cameraModal .modal-content {
                max-height: 95vh;
            }
            
            #cameraVideo {
                max-height: 50vh !important;
            }
        }

        /* Estilos para el bot칩n de c치mara en b칰squeda */
        .camera-search-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            border: none;
            border-radius: var(--border-radius-sm);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: white;
            z-index: 10;
        }

        .camera-search-button:hover {
            background: var(--primary-light);
            transform: translateY(-50%) scale(1.1);
        }

        .camera-search-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-box .form-control {
            padding-right: 3rem !important;
        }
        
        /* ===== ESTILOS PARA LOS ESTADOS DE C츼MARA ===== */
        #cameraLoading {
            text-align: center;
            padding: 3rem 2rem;
        }

        #cameraError {
            text-align: center;
            padding: 2rem;
            background: rgba(231, 76, 60, 0.05);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger-color);
        }

        .loading-spinner {
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estado del bot칩n de c치mara cuando no est치 disponible */
        .camera-search-button.disabled {
            background: var(--text-muted) !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .camera-search-button.disabled:hover {
            transform: translateY(-50%) !important;
        }


        /* ===== ESTILOS CORREGIDOS PARA MODAL DE ELIMINACI칍N ===== */

        #deleteConfirmationModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
        }

        #deleteConfirmationModal.active {
            display: block;
        }

        #deleteConfirmationModal .modal-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        #deleteConfirmationModal .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        /* Header del modal */
        #deleteConfirmationModal .modal-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #deleteConfirmationModal .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        #deleteConfirmationModal .modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Animaciones */
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* Estilos espec칤ficos para el contenido de eliminaci칩n */
        .warning-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(231, 76, 60, 0.2);
            margin-bottom: 1rem;
        }

        .warning-message i {
            color: var(--danger-color);
            font-size: 1.2rem;
            margin-top: 0.1rem;
        }

        .product-info-card {
            background: var(--light-color);
            padding: 1.25rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger-color);
            margin: 1rem 0;
        }

        .product-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .product-info-code {
            background: var(--danger-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .product-info-details {
            display: grid;
            gap: 0.75rem;
        }

        .product-info-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: start;
            gap: 0.5rem;
        }

        .product-info-label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .product-info-value {
            color: var(--text-color);
            font-size: 0.9rem;
            word-break: break-word;
        }

        .alert-message {
            background: rgba(231, 76, 60, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger-color);
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-message i {
            color: var(--danger-color);
        }

        .alert-message span {
            color: var(--danger-color);
            font-size: 0.9rem;
        }

        /* Bot칩n de cerrar */
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #deleteConfirmationModal .modal-container {
                padding: 1rem;
            }
            
            #deleteConfirmationModal .modal-content {
                max-width: 100%;
            }
            
            #deleteConfirmationModal .modal-header,
            #deleteConfirmationModal .modal-body,
            #deleteConfirmationModal .modal-footer {
                padding: 1rem;
            }
            
            .product-info-row {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
            
            .product-info-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            #deleteConfirmationModal .modal-footer {
                flex-direction: column;
            }
            
            #deleteConfirmationModal .modal-footer .btn {
                width: 100%;
            }
        }

        /* Animaci칩n para el modal de eliminaci칩n */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .modal.shaking {
            animation: shake 0.5s ease-in-out;
        }

        /* Estilos para el bot칩n de eliminar en estado hover */
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .info-grid {
            display: grid;
            gap: 0.75rem;
        }

        .info-item {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: start;
            gap: 0.5rem;
        }

        .info-item strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .product-code, .product-location {
            font-family: 'Monaco', 'Consolas', monospace;
            background: var(--card-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .warning-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .warning-message i {
            color: var(--danger-color);
            margin-top: 0.2rem;
        }

        .warning-message strong {
            color: var(--danger-color);
            display: block;
            margin-bottom: 0.25rem;
        }

        .warning-message p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: var(--light-color);
            color: var(--text-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .info-item {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }

        /* ===== LISTA DE PRODUCTOS ===== */
        .products-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            grid-column: 1 / -1;
        }

        .search-box .form-control {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.7;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .product-info h3 {
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .product-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .product-code {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            background-color: var(--primary-color);
            color: white;
        }

        .product-excerpt {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ===== MEJORA 1: ESTILOS PARA B칔SQUEDA Y FILTROS ===== */
        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .quick-filters {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .filters-header h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-size: 1rem;
        }

        .filters-header small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .filter-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
        }

        .filter-btn:hover {
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 3rem;
            overflow: hidden;
            line-height: 1.3;
        }

        /* ===== ESTILOS GARANTIZADOS PARA INPUT FILE ===== */
        #ticketFileInput {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            opacity: 0.001 !important; /* M칤nima opacidad pero no 0 */
            cursor: pointer !important;
            z-index: 10 !important;
            display: block !important;
            visibility: visible !important;
        }

        /* Contenedor con posici칩n relativa */
        .upload-area {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            cursor: default !important;
            pointer-events: none !important;
        }

        .upload-area:hover {
            border-color: var(--border-color); /* 游녣 Mantener mismo color en hover */
            background: var(--card-bg); /* 游녣 Mantener mismo fondo */
            /* 游녣 Eliminar transform y shadow para indicar que no es clickeable */
        }

        #selectFileBtn,
        #processFileBtn {
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        #selectFileBtn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;

        }

        #selectFileBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            cursor: pointer;
        }

        #fileInfo {
            background: var(--light-color);
            padding: 1.25rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info-invalid {
            border-left-color: var(--danger-color) !important;
            background: rgba(231, 76, 60, 0.05) !important;
        }

        /* Agregar al CSS existente */
        .editable-field {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 0.9rem;
            width: 100%;
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .editable-field.valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .editable-field.invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .editable-field:disabled {
            background-color: var(--light-color);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Mensajes de error */
        .field-error {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        /* Indicadores de estado */
        .validation-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .valid .validation-indicator {
            color: var(--success-color);
        }

        .invalid .validation-indicator {
            color: var(--danger-color);
        }

        /* Grupo de campo con validaci칩n */
        .field-group {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .field-group .form-control {
            padding-right: 2rem;
        }

        /* ===== NUEVOS ESTILOS PARA CARDS ===== */
        .products-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--danger-color) !important;
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            height: fit-content;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .product-code-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .product-row-number {
            background: var(--light-color);
            color: var(--text-muted);
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .product-description {
            margin-bottom: 1rem;
            flex-grow: 1;
        }

        .product-description textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            resize: vertical;
            transition: var(--transition);
        }

        .product-description textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-group {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-color);
        }

        .detail-value input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .detail-value input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .product-card-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .card-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-pdf {
            background: var(--success-color);
            color: white;
        }

        .btn-pdf:hover {
            background: var(--success-light);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: var(--danger-light);
            transform: translateY(-1px);
        }

        .card-search-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--light-color);
            border-radius: 0.25rem;
            border-left: 3px solid var(--secondary-color);
            max-height: 2rem;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .products-cards-container {
                grid-template-columns: 1fr;
            }
            
            .product-details-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ===== SISTEMA DE LOADING MEJORADO ===== */
        .pdf-generation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .pdf-generation-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pdf-generation-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--light-color) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .pdf-generation-header {
            margin-bottom: 2rem;
        }

        .pdf-generation-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pdf-generation-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .pdf-generation-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Barra de progreso animada */
        .pdf-progress-container {
            width: 100%;
            background: var(--light-color);
            border-radius: 100px;
            overflow: hidden;
            margin: 1.5rem 0;
            height: 8px;
            position: relative;
        }

        .pdf-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 100px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pdf-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.4), 
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .pdf-progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .pdf-progress-percent {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pdf-progress-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Etapas del proceso */
        .pdf-steps {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
            position: relative;
        }

        .pdf-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .pdf-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .pdf-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-color);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .pdf-step.active .pdf-step-icon {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .pdf-step.completed .pdf-step-icon {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .pdf-step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .pdf-step.active .pdf-step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .pdf-step.completed .pdf-step-label {
            color: var(--success-color);
        }

        /* Animaci칩n de 칠xito */
        .pdf-success-animation {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% { 
                opacity: 0;
                transform: scale(0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.1);
            }
            100% { 
                transform: scale(1);
            }
        }

        /* Contador de productos */
        .pdf-counter {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
            animation: countPop 0.5s ease;
        }

        @keyframes countPop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        #ticketFileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Mensajes de estado */
        .pdf-status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== PAGINACI칍N ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            margin-bottom: 100px;            
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ===== BOTONES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-light);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-light);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* VERSI칍N MEJORADA PARA HEADERS COMPLEJOS */
        .preview-table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
        }

        .products-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9em;
        }

        .products-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .products-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            border-bottom: 2px solid var(--primary-light);
            position: sticky;
            top: 0;
            z-index: 101;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Asegurar que las celdas tengan fondo s칩lido */
        .products-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            transition: background-color 0.2s ease;
        }

        .products-table tbody tr:hover td {
            background-color: rgba(0, 75, 107, 0.05);
        }

        /* Scrollbar styling */
        .preview-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .preview-table-container::-webkit-scrollbar-track {
            background: var(--light-color);
        }

        .preview-table-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .preview-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s ease;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9);
                background-color: rgba(0,0,0,0); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                background-color: rgba(0,0,0,0.5); 
            }
        } 
        
        .modal.fade-out {
            animation: modalFadeOut 0.3s ease forwards;
        }

        .modal.fade-out .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }        

        @keyframes modalFadeOut {
            from { 
                opacity: 1; 
                background-color: rgba(0,0,0,0.5); 
            }
            to { 
                opacity: 0; 
                background-color: rgba(0,0,0,0); 
            }
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes modalSlideOut {
            from { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            to { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
        }

        
        .modal-header {
            padding: 1.5rem 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Mejoras para botones del modal */
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            opacity: 1;
            background-color: var(--light-color);
            transform: scale(1.1);
        }

        /* Estilos para el scroll del modal */
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-muted);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .toast-info {
            background-color: var(--secondary-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-text {
            font-size: 1.1rem;
        }

        .section-loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .section-loading.active {
            display: block;
        }

        /* ===== ESTADOS VAC칈OS ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* ===== PERFIL ===== */
        .profile-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0 auto 1.5rem;
        }

        /* ===== ACCESIBILIDAD ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }
       
        /* Estilos para el sistema de b칰squeda */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--light-color);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-text strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .suggestion-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
        }

        .suggestion-meta code {
            font-size: 0.7rem;
            background: var(--light-color);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .search-highlight {
            background-color: #FFEB3B;
            padding: 0.1rem 0.2rem;
            border-radius: 0.2rem;
            font-weight: 600;
            color: #000;
        }

        .history-chip {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-chip:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .scanned-product {
            border-left: 4px solid var(--success-color) !important;
        }

        .unscanned-product {
            border-left: 4px solid var(--warning-color) !important;
        }

        .active-filter {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-container {
                position: static;
            }
            
            .search-suggestions {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 50vh;
            }
        }

        /* ===== GENERAR TICKET ===== */
        .ticket-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .ticket-preview {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .ticket-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .ticket-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ticket-item {
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--secondary-color);
        }

        .ticket-qr {
            text-align: center;
            margin: 1.5rem 0;
        }

        .ticket-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* MODAL SENCILLO Y ADAPTABLE */
        .simple-pdf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .simple-pdf-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .simple-modal {
            position: relative;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        .simple-pdf-modal.closing .simple-modal {
            animation: modalSlideOut 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
        }

        /* HEADER SENCILLO */
        .simple-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: var(--card-bg);
        }

        .header-title {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }

        .header-title h3 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-title p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .close-btn {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* BODY SENCILLO */
        .simple-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .format-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card-bg);
            position: relative;
        }

        .format-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .format-option.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .format-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .format-option:nth-child(2) .format-icon {
            background: var(--secondary-color);
        }

        .format-option:nth-child(3) .format-icon {
            background: var(--success-color);
        }

        .format-content {
            flex: 1;
        }

        .format-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
        }

        .format-content p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .format-meta {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .format-meta.inventory {
            background: var(--success-color);
        }

        .format-check {
            flex-shrink: 0;
        }

        .check-circle {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: all 0.2s ease;
        }

        .check-circle.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .check-circle i {
            font-size: 0.8rem;
            color: transparent;
            transition: color 0.2s ease;
        }

        .check-circle.active i {
            color: white;
        }

        /* RESUMEN SENCILLO */
        .summary-section {
            background: var(--light-color);
            border-radius: 10px;
            padding: 1.25rem;
            border-left: 4px solid var(--primary-color);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .summary-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .summary-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1rem;
        }

        .format-selected {
            color: var(--success-color) !important;
        }

        /* FOOTER SENCILLO */
        .simple-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            background: var(--card-bg);
        }

        .simple-footer .btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-cancel {
            background: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color) !important;
        }

        .btn-cancel:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .btn-generate {
            background: var(--primary-color);
            color: white;
            position: relative;
        }

        .btn-generate:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* SCROLLBAR PARA MODO OSCURO/CLARO */
        .simple-body::-webkit-scrollbar {
            width: 6px;
        }

        .simple-body::-webkit-scrollbar-track {
            background: var(--light-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .simple-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .simple-modal {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .simple-header {
                padding: 1.25rem;
            }
            
            .simple-body {
                padding: 1.25rem;
            }
            
            .format-option {
                padding: 1rem;
            }
            
            .simple-footer {
                padding: 1rem 1.25rem;
                flex-direction: column;
            }
            
            .simple-footer .btn {
                width: 100%;
            }
            
            .header-title {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .header-title i {
                margin-top: 0;
            }
        }

        /* MODO OSCURO AUTOM츼TICO */
        .dark-mode .simple-modal {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .dark-mode .format-option.active {
            background: rgba(52, 152, 219, 0.1);
        }

        .dark-mode .summary-section {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .btn-cancel {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        .dark-mode .close-btn {
            background: var(--light-color);
            border-color: var(--border-color);
        }

        /* ===== FILTROS DE DESPACHO ===== */
        .despacho-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Responsive para tabla */
        @media (max-width: 768px) {
            .products-table {
                font-size: 0.8em;
            }
            
            .products-table th, .products-table td {
                padding: 8px;
            }
            
            .ticket-details {
                grid-template-columns: 1fr;
            }
            
            .despacho-filters {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ESTILOS ADICIONALES PARA NUEVAS FUNCIONALIDADES ===== */
        
        /* Bot칩n flotante */
        .floating-action-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
            z-index: 1000;
        }

        .floating-action-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: var(--primary-light);
        }

        .floating-action-button.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Productos inv치lidos */
        .invalid-product {
            border-left: 4px solid var(--danger-color) !important;
            background: rgba(231, 76, 60, 0.05);
        }

        .validation-errors {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--danger-color);
        }

        /* Estados de carga mejorados */
        .skeleton-loading {
            background: linear-gradient(90deg, var(--light-color) 25%, var(--border-color) 50%, var(--light-color) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--border-radius-sm);
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles mejorados */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Mejoras para impresi칩n */
        @media print {
            .app-header,
            .nav-container,
            .filters-container,
            .product-card-actions,
            .floating-action-button {
                display: none !important;
            }
            
            .main-content {
                padding-top: 0;
            }
            
            .product-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
        }

        /* Campos adicionales para despacho */
        .product-details-grid-extended {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-group-extended {
            display: flex;
            flex-direction: column;
        }

        .detail-label-extended {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value-extended {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .detail-value-extended input {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .detail-value-extended input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
    </style>

</head>
<body>
    <!-- Aplicaci칩n principal -->
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <img src="../../FOTO/LOGO/Logo_01.webp" alt="Gallos M치rmol" class="logo-img">
                </div>
                <div class="header-actions">
                    <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa" aria-label="Pantalla completa">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" title="Cambiar tema" aria-label="Cambiar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar" aria-haspopup="true" aria-expanded="false">C</div>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="user-info">
                                <div class="user-name" id="userName">Colaborador</div>
                                <span class="user-role" id="userRole">Colaborador</span>
                            </div>
                            <a href="#" class="dropdown-item logout" id="logoutBtn" role="menuitem">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="main-content">
            <div class="container">
                <!-- Navegaci칩n por pesta침as -->
                <div class="nav-container">
                    <div class="nav-tabs" id="navTabs" role="tablist">
                        <button class="nav-tab active" data-tab="generateTicket" role="tab" aria-selected="true" aria-controls="generateTicketSection"><i class="fas fa-ticket-alt"></i> Generar Tickets</button>
                    </div>
                </div>

                <section class="generate-ticket-section active" id="generateTicketSection" role="tabpanel" aria-labelledby="generate-ticket-tab">
                    <div class="section-title">
                        <h2>Generar Tickets desde Excel</h2>
                        <small>Carga un archivo Excel para generar tickets</small>
                    </div>

                    <!-- Paso 1: Cargar Archivo -->
                    <div class="upload-step" id="ticketUploadStep">
                        <div class="upload-mode-selector" style="margin-bottom: 2rem;">
                            <div class="mode-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="mode-option active" data-mode="fixed">
                                    <div class="mode-card" style="border: 2px solid var(--primary-color); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; cursor: pointer; transition: var(--transition);">
                                        <i class="fas fa-database" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                        <h4>Plantilla Predefinida</h4>
                                        <p style="color: var(--text-muted); margin: 0.5rem 0;">Usa nuestro archivo Excel con datos de ejemplo</p>
                                        <small style="color: var(--success-color); font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> Opci칩n por defecto
                                        </small>
                                    </div>
                                </div>
                                <div class="mode-option" data-mode="custom">
                                    <div class="mode-card" style="border: 2px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; cursor: pointer; transition: var(--transition);">
                                        <i class="fas fa-file-upload" style="font-size: 2.5rem; color: var(--secondary-color); margin-bottom: 1rem;"></i>
                                        <h4>Subir Archivo Personalizado</h4>
                                        <p style="color: var(--text-muted); margin: 0.5rem 0;">Sube tu propio archivo Excel o arr치stralo aqu칤</p>
                                        <small style="color: var(--text-muted);">Formatos: .xlsx, .xls, .csv</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contenedor para carga fija -->
                        <div class="fixed-file-container" id="fixedFileContainer" style="display: block;">
                            <div style="text-align: center; padding: 2rem; background: var(--light-color); border-radius: var(--border-radius);">
                                <i class="fas fa-database" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                <h3>Plantilla Predefinida Cargada</h3>
                                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                                    Se cargar치n los productos desde el archivo predefinido del sistema
                                </p>
                                <button class="btn btn-primary" id="loadFixedFileBtn">
                                    <i class="fas fa-rocket"></i> Cargar Plantilla Predefinida
                                </button>
                                <div style="margin-top: 1rem;">
                                    <small style="color: var(--text-muted);">
                                        <i class="fas fa-info-circle"></i>
                                        Ruta: <code>../../ARCHIVO/EXCEL/Plantilla_01.xlsx</code>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Contenedor para carga personalizada -->
                        <div class="custom-file-container" id="customFileContainer" style="display: none;">
                            <!-- 츼REA DE CARGA (con pointer-events) -->
                            <div class="upload-area" id="ticketUploadArea" 
                                style="border: 2px solid var(--border-color); border-radius: var(--border-radius); padding: 3rem; text-align: center; margin-bottom: 1.5rem; transition: var(--transition); background: var(--light-color);">
                                <i class="fas fa-file-excel" style="font-size: 3rem; color: var(--success-color); margin-bottom: 1rem;"></i>
                                <h3>Selecciona tu archivo Excel</h3>
                                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                                    Formatos soportados: .xlsx, .xls, .csv
                                </p>
                                
                                <!-- BOT칍N PRINCIPAL PARA SUBIR ARCHIVOS -->
                                <button class="btn btn-primary btn-lg" id="selectFileBtn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-folder-open"></i> Seleccionar Archivo Excel
                                </button>
                                
                                <input type="file" id="ticketFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            </div>
                            
                            <!-- Informaci칩n del archivo seleccionado -->
                            <div id="fileInfo" style="display: none; background: var(--light-color); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <i class="fas fa-file-excel" style="color: var(--success-color); font-size: 1.5rem;"></i>
                                        <div>
                                            <strong id="fileName">archivo.xlsx</strong>
                                            <div style="font-size: 0.8rem; color: var(--text-muted);" id="fileSize">0 KB</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success" id="processFileBtn">
                                        <i class="fas fa-upload"></i> Procesar Archivo
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- CONTENEDOR SEPARADO PARA DESCARGA DE PLANTILLA -->
                        <div class="template-download-container" style="text-align: center; margin-bottom: 2rem; margin-top: 2rem;">
                            <a href="#" class="btn btn-secondary" id="downloadTicketTemplateBtn">
                                <i class="fas fa-file-excel"></i> Descargar Plantilla Vac칤a
                            </a>
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
                                Plantilla Excel con formato predefinido para despacho
                            </small>
                        </div>


                    </div>

                    <!-- Paso 2: Previsualizaci칩n y Edici칩n -->
                    <div class="preview-step" id="ticketPreviewStep" style="display: none;">
                        <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h3>Previsualizaci칩n de Productos</h3>
                                <p style="margin: 0; color: var(--text-muted);" id="productsCount">0 productos cargados</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" id="backToUploadTicketBtn">
                                    <i class="fas fa-arrow-left"></i> Cambiar Archivo
                                </button>
                                <button class="btn btn-success" id="generateAllPdfBtn">
                                    <i class="fas fa-file-pdf"></i> Generar PDF masivos
                                </button>
                            </div>
                        </div>

                        <!-- Filtros de Despacho -->
                        <div class="filters-container">
                            <div class="filters-header">
                                <h4 class="filters-title">Filtros de Despacho</h4>
                                <div class="filters-actions">
                                    <button class="btn btn-secondary btn-small" id="clearFiltersBtn">
                                        <i class="fas fa-broom"></i> Limpiar
                                    </button>
                                </div>
                            </div>

                            <div class="despacho-filters">
                                <!-- Familia -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Familia</span>
                                        <span class="filter-count" id="familiaCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterFamilia">
                                        <option value="">Todas las familias</option>
                                    </select>
                                </div>

                                <!-- Acabado -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Acabado</span>
                                        <span class="filter-count" id="acabadoCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterAcabado" disabled>
                                        <option value="">Todos los acabados</option>
                                    </select>
                                </div>

                                <!-- Material -->
                                <div class="form-group">
                                    <div class="filter-label">
                                        <span>Material</span>
                                        <span class="filter-count" id="materialCount"></span>
                                    </div>
                                    <select class="form-control filter-select" id="ticketFilterMaterial" disabled>
                                        <option value="">Todos los materiales</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- B칰squeda -->
                        <div class="search-box" style="margin-bottom: 1.5rem;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="ticketSearchInput" placeholder="Buscar por c칩digo, descripci칩n, modelo...">
                        </div>
                        <!-- Contenedor de Cards de Productos -->
                        <div class="products-cards-container" id="ticketProductsCardsContainer">
                            <!-- Los productos cargados del Excel se mostrar치n aqu칤 como cards -->
                        </div>

                        <!-- Paginaci칩n -->
                        <div class="pagination" id="ticketPaginationContainer">
                            <button class="pagination-btn" id="ticketPrevPageBtn" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="pagination-info" id="ticketPaginationInfo">P치gina 1 de 1</span>
                            <button class="pagination-btn" id="ticketNextPageBtn" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Bot칩n flotante para volver al inicio -->
    <button class="floating-action-button" id="scrollToTopBtn" aria-label="Volver al inicio">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast notifications -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Operaci칩n completada con 칠xito</span>
        <button class="toast-close" aria-label="Cerrar notificaci칩n">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <!-- Overlay de Generaci칩n de PDF -->
    <div class="pdf-generation-overlay" id="pdfGenerationOverlay">
        <div class="pdf-generation-card">
            <div class="pdf-generation-header">
                <div class="pdf-generation-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h2 class="pdf-generation-title" id="pdfGenerationTitle">Generando PDF</h2>
                <p class="pdf-generation-subtitle" id="pdfGenerationSubtitle">Preparando documentos...</p>
            </div>

            <!-- Contador de productos -->
            <div class="pdf-counter" id="pdfCounter">
                <span id="pdfCurrentCount">0</span> de <span id="pdfTotalCount">0</span> productos
            </div>

            <!-- Barra de progreso -->
            <div class="pdf-progress-text">
                <span>Progreso</span>
                <span class="pdf-progress-percent" id="pdfProgressPercent">0%</span>
            </div>
            <div class="pdf-progress-container">
                <div class="pdf-progress-bar" id="pdfProgressBar"></div>
            </div>
            <div class="pdf-progress-stats" id="pdfProgressStats">
                Iniciando proceso...
            </div>

            <!-- Etapas del proceso -->
            <div class="pdf-steps">
                <div class="pdf-step completed" id="step1">
                    <div class="pdf-step-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="pdf-step-label">Preparando</span>
                </div>
                <div class="pdf-step" id="step2">
                    <div class="pdf-step-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span class="pdf-step-label">Generando</span>
                </div>
                <div class="pdf-step" id="step3">
                    <div class="pdf-step-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <span class="pdf-step-label">C칩digos QR</span>
                </div>
                <div class="pdf-step" id="step4">
                    <div class="pdf-step-icon">
                        <i class="fas fa-save"></i>
                    </div>
                    <span class="pdf-step-label">Guardando</span>
                </div>
            </div>

            <!-- Mensajes de estado -->
            <div class="pdf-status-message" id="pdfStatusMessage">
                <i class="fas fa-info-circle"></i>
                <span id="pdfStatusText">Inicializando generaci칩n de PDF...</span>
            </div>

            <!-- Bot칩n de cancelar (opcional) -->
            <button class="btn btn-secondary btn-small" id="cancelPdfGeneration" style="margin-top: 1rem;">
                <i class="fas fa-times"></i> Cancelar Generaci칩n
            </button>
        </div>
    </div>

    <!-- Modal para seleccionar formato PDF -->
    <div class="simple-pdf-modal" id="pdfFormatModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="simple-modal">
            <div class="simple-header">
                <div class="header-title">
                    <i class="fas fa-file-pdf"></i>
                    <div>
                        <h3>Generar PDF</h3>
                        <p>Selecciona el formato para los tickets de despacho</p>
                    </div>
                </div>
                <button class="close-btn" id="closePdfModalBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="simple-body">
                <div class="format-options">
                    <div class="format-option active" data-format="individual">
                        <div class="format-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="format-content">
                            <h4>Tickets Individuales</h4>
                            <p>Genera un PDF separado para cada producto con su c칩digo QR individual</p>
                            <span class="format-meta">Recomendado para despacho</span>
                        </div>
                        <div class="format-check">
                            <div class="check-circle active">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="format-option" data-format="multiple">
                        <div class="format-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="format-content">
                            <h4>PDF M칰ltiple</h4>
                            <p>Genera un solo PDF con todos los productos organizados en p치ginas separadas</p>
                            <span class="format-meta inventory">Para inventario</span>
                        </div>
                        <div class="format-check">
                            <div class="check-circle">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="summary-section">
                    <div class="summary-item">
                        <span class="summary-label">Productos a generar:</span>
                        <span class="summary-value" id="pdfProductCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Formato seleccionado:</span>
                        <span class="summary-value format-selected" id="pdfFormatSelected">Tickets Individuales</span>
                    </div>
                </div>
            </div>
            <div class="simple-footer">
                <button class="btn btn-cancel" id="cancelPdfBtn">Cancelar</button>
                <button class="btn btn-generate" id="confirmPdfBtn">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                    <span class="badge" id="pdfBadgeCount">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci칩n para Eliminar Producto -->
    <div class="modal" id="deleteConfirmationModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 style="margin: 0; color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci칩n
                    </h3>
                    <button class="close-modal" id="closeDeleteModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="warning-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>
                            <strong>쮼st치s seguro de que deseas eliminar este producto?</strong>
                            <p>Esta acci칩n no se puede deshacer. El producto ser치 removido permanentemente de la lista.</p>
                        </div>
                    </div>
                    
                    <div class="product-info-card" id="deleteProductInfo">
                        <!-- La informaci칩n del producto se cargar치 aqu칤 din치micamente -->
                    </div>
                    
                    <div class="alert-message">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            <strong>Advertencia:</strong> Esta acci칩n afectar치 los filtros y la paginaci칩n actual.
                        </span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelDeleteBtn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash"></i> Eliminar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ===== CONFIGURACI칍N DE SUPABASE =====
        const SUPABASE_URL = 'https://fzdwqkoporxnzvhpmlls.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6ZHdxa29wb3J4bnp2aHBtbGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDkxMDYsImV4cCI6MjA3NzM4NTEwNn0.nOS3oByMmopchYhH0Kv1I0lxi02VkqfsC-eGFTZ_ePg';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== SISTEMA DE PROGRESO PARA PDF =====
        const pdfProgress = {
            isCancelled: false,
            
            show: function(totalProducts, format) {
                this.isCancelled = false;
                const overlay = document.getElementById('pdfGenerationOverlay');
                const title = document.getElementById('pdfGenerationTitle');
                const subtitle = document.getElementById('pdfGenerationSubtitle');
                const totalCount = document.getElementById('pdfTotalCount');
                
                const formatNames = {
                    'ticket-small-horizontal': 'Tickets Peque침os',
                    'ticket-medium-horizontal': 'Tickets Medianos',
                    'compact-summary': 'Resumen Compacto'
                };
                
                title.textContent = `Generando ${formatNames[format] || format}`;
                subtitle.textContent = `Preparando ${totalProducts} productos...`;
                totalCount.textContent = totalProducts;
                
                // Resetear etapas
                document.querySelectorAll('.pdf-step').forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index === 0) step.classList.add('completed');
                });
                
                overlay.classList.add('active');
            },
            
            hide: function() {
                document.getElementById('pdfGenerationOverlay').classList.remove('active');
                this.isCancelled = false;
            },
            
            updateProgress: function(percent, current, total) {
                const progressBar = document.getElementById('pdfProgressBar');
                const progressPercent = document.getElementById('pdfProgressPercent');
                const progressStats = document.getElementById('pdfProgressStats');
                const currentCount = document.getElementById('pdfCurrentCount');
                
                progressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${Math.round(percent)}%`;
                
                if (current !== undefined && total !== undefined) {
                    currentCount.textContent = current;
                    progressStats.textContent = `${current} de ${total} productos procesados`;
                }
            },
            
            updateStep: function(stepNumber, status) {
                const step = document.getElementById(`step${stepNumber}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    step.classList.add(status);
                }
            },
            
            updateStatus: function(message, type = 'info') {
                const statusText = document.getElementById('pdfStatusText');
                const statusMessage = document.getElementById('pdfStatusMessage');
                
                statusText.textContent = message;
                
                // Resetear clases
                statusMessage.className = 'pdf-status-message';
                if (type === 'warning') {
                    statusMessage.style.borderLeftColor = 'var(--warning-color)';
                } else if (type === 'error') {
                    statusMessage.style.borderLeftColor = 'var(--danger-color)';
                } else {
                    statusMessage.style.borderLeftColor = 'var(--primary-color)';
                }
            },
            
            showSuccess: function() {
                document.querySelector('.pdf-generation-icon').innerHTML = '<i class="fas fa-check-circle pdf-success-animation"></i>';
                this.updateStatus('九 Generaci칩n completada exitosamente', 'success');
            },
            
            showError: function(error) {
                document.querySelector('.pdf-generation-icon').innerHTML = '<i class="fas fa-exclamation-triangle" style="color: var(--danger-color); font-size: 3.5rem;"></i>';
                this.updateStatus(`仇 Error: ${error.message || error}`, 'error');
            }
        };

        // ===== SISTEMA DE ESCANEO POR C츼MARA =====
        class CameraScanner {
            constructor() {
                this.stream = null;
                this.videoElement = null;
                this.canvasElement = null;
                this.context = null;
                this.isScanning = false;
                this.searchInput = null;
                this.cameraButton = null;
                this.currentFacingMode = 'environment';
                this.isCameraAvailable = false;
            }

            // Inicializar el esc치ner
            async initialize() {
                this.searchInput = document.getElementById('ticketSearchInput');
                this.createCameraModal();
                this.addCameraButtonToSearch();
                this.setupEventListeners();
                
                // Verificar disponibilidad de c치mara al inicializar
                await this.checkCameraAvailability();
                
                console.log('九 Esc치ner de c치mara inicializado - Disponible:', this.isCameraAvailable);
                return this.isCameraAvailable;
            }

            // VERIFICAR DISPONIBILIDAD DE C츼MARA
            async checkCameraAvailability() {
                try {
                    // Verificar si la API de mediaDevices est치 disponible
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.warn('仇 API de c치mara no soportada en este navegador');
                        this.isCameraAvailable = false;
                        this.updateCameraButtonState();
                        return false;
                    }

                    // Verificar permisos (solo en navegadores que soportan permissions API)
                    if (navigator.permissions && navigator.permissions.query) {
                        try {
                            const permission = await navigator.permissions.query({ name: 'camera' });
                            if (permission.state === 'denied') {
                                console.warn('仇 Permisos de c치mara denegados permanentemente');
                                this.isCameraAvailable = false;
                                this.updateCameraButtonState();
                                return false;
                            }
                        } catch (error) {
                            console.log('좶잺 API de permisos no disponible, continuando...');
                        }
                    }

                    // Verificar acceso a la c치mara con una prueba r치pida
                    const constraints = {
                        video: { 
                            facingMode: this.currentFacingMode,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        },
                        audio: false
                    };

                    // Intento r치pido de acceso a c치mara (timeout de 3 segundos)
                    const stream = await Promise.race([
                        navigator.mediaDevices.getUserMedia(constraints),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout de acceso a c치mara')), 3000)
                        )
                    ]);

                    // Si llegamos aqu칤, la c치mara est치 disponible
                    if (stream) {
                        // Detener el stream de prueba inmediatamente
                        stream.getTracks().forEach(track => track.stop());
                        this.isCameraAvailable = true;
                        console.log('九 C치mara disponible y accesible');
                    }

                } catch (error) {
                    console.error('仇 C치mara no disponible:', error);
                    this.isCameraAvailable = false;
                }

                this.updateCameraButtonState();
                return this.isCameraAvailable;
            }

            // ACTUALIZAR ESTADO DEL BOT칍N DE C츼MARA
            updateCameraButtonState() {
                if (!this.cameraButton) return;

                if (this.isCameraAvailable) {
                    // C치mara disponible - bot칩n normal
                    this.cameraButton.style.background = 'var(--primary-color)';
                    this.cameraButton.style.cursor = 'pointer';
                    this.cameraButton.title = 'Escanear c칩digo con c치mara';
                    this.cameraButton.innerHTML = '<i class="fas fa-camera"></i>';
                    this.cameraButton.classList.remove('disabled');
                } else {
                    // C치mara no disponible - bot칩n deshabilitado
                    this.cameraButton.style.background = 'var(--text-muted)';
                    this.cameraButton.style.cursor = 'not-allowed';
                    this.cameraButton.title = 'C치mara no disponible';
                    this.cameraButton.innerHTML = '<i class="fas fa-camera-slash"></i>';
                    this.cameraButton.classList.add('disabled');
                }
            }

            // CREAR MODAL DE C츼MARA
            createCameraModal() {
                const modalHTML = `
                    <div class="modal" id="cameraModal" style="display: none;">
                        <div class="modal-content" style="max-width: 95vw; max-height: 95vh;">
                            <div class="modal-header">
                                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-camera"></i> Escanear C칩digo
                                </h3>
                                <button class="close-modal" id="closeCameraModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body" style="text-align: center; padding: 1.5rem;">
                                <!-- Contenedor de estado de carga -->
                                <div id="cameraLoading" style="display: none; padding: 2rem;">
                                    <div class="loading-spinner" style="width: 50px; height: 50px; margin: 0 auto 1rem;"></div>
                                    <p style="color: var(--text-muted);">Accediendo a la c치mara...</p>
                                </div>

                                <!-- Contenedor de c치mara (oculto inicialmente) -->
                                <div id="cameraContainer" style="display: none; position: relative; margin-bottom: 1.5rem;">
                                    <video id="cameraVideo" 
                                        style="width: 100%; max-width: 600px; max-height: 60vh; border-radius: 12px; background: #000;" 
                                        autoplay playsinline muted></video>
                                    <div class="camera-overlay"></div>
                                </div>

                                <!-- Contenedor de error (oculto inicialmente) -->
                                <div id="cameraError" style="display: none; padding: 2rem;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
                                    <h4 style="color: var(--danger-color); margin-bottom: 1rem;">No se puede acceder a la c치mara</h4>
                                    <p id="cameraErrorMessage" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
                                    <button class="btn btn-primary" id="retryCameraBtn">
                                        <i class="fas fa-redo"></i> Reintentar
                                    </button>
                                </div>
                                
                                <canvas id="cameraCanvas" style="display: none;"></canvas>
                                
                                <div id="cameraInstructions" class="camera-instructions" style="display: none;">
                                    <i class="fas fa-info-circle"></i> 
                                    Enfoca el c칩digo QR o c칩digo de barras dentro del recuadro verde
                                </div>
                                
                                <div id="cameraControls" style="margin-top: 1.5rem; display: none; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                                    <button class="btn btn-primary" id="captureBtn">
                                        <i class="fas fa-camera"></i> Capturar y Escanear
                                    </button>
                                    <button class="btn btn-secondary" id="switchCameraBtn">
                                        <i class="fas fa-sync-alt"></i> Cambiar C치mara
                                    </button>
                                    <button class="btn btn-warning" id="cancelCameraBtn">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </div>
                                
                                <div id="cameraStatus" style="margin-top: 1.5rem; padding: 1rem; 
                                                            border-radius: var(--border-radius); 
                                                            font-size: 0.9rem; text-align: center; display: none;">
                                    <i class="fas fa-info-circle"></i> Preparando c치mara...
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                if (!document.getElementById('cameraModal')) {
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    console.log('九 Modal de c치mara creado correctamente');
                } else {
                    console.log('좶잺 Modal de c치mara ya existe');
                }
                
                this.videoElement = document.getElementById('cameraVideo');
                this.canvasElement = document.getElementById('cameraCanvas');
                
                if (this.canvasElement) {
                    this.context = this.canvasElement.getContext('2d');
                } else {
                    console.error('仇 No se pudo encontrar el elemento canvas');
                }
            }

            // AGREGAR BOT칍N DE C츼MARA AL CAMPO DE B칔SQUEDA
            addCameraButtonToSearch() {
                const searchBox = document.querySelector('.search-box');
                if (searchBox && !searchBox.querySelector('.camera-search-button')) {
                    // Crear bot칩n de c치mara
                    this.cameraButton = document.createElement('button');
                    this.cameraButton.type = 'button';
                    this.cameraButton.className = 'camera-search-button';
                    this.cameraButton.innerHTML = '<i class="fas fa-camera"></i>';
                    this.cameraButton.title = 'Escanear c칩digo con c치mara';
                    this.cameraButton.setAttribute('aria-label', 'Abrir c치mara para escanear c칩digo');
                    
                    // Agregar al contenedor de b칰squeda
                    searchBox.appendChild(this.cameraButton);
                    
                    console.log('九 Bot칩n de c치mara agregado al campo de b칰squeda');
                }
            }

            // CONFIGURAR EVENT LISTENERS
            setupEventListeners() {
                // Bot칩n de c치mara en el campo de b칰squeda
                if (this.cameraButton) {
                    this.cameraButton.addEventListener('click', async () => {
                        if (!this.isCameraAvailable) {
                            this.showCameraUnavailableMessage();
                            return;
                        }
                        await this.startCameraWithVerification();
                    });
                }

                // Event listeners del modal
                const closeBtn = document.getElementById('closeCameraModal');
                const cancelBtn = document.getElementById('cancelCameraBtn');
                const captureBtn = document.getElementById('captureBtn');
                const switchBtn = document.getElementById('switchCameraBtn');
                const retryBtn = document.getElementById('retryCameraBtn');

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.stopCamera();
                    });
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.stopCamera();
                    });
                }

                if (captureBtn) {
                    captureBtn.addEventListener('click', () => {
                        this.captureAndScan();
                    });
                }

                if (switchBtn) {
                    switchBtn.addEventListener('click', () => {
                        this.switchCamera();
                    });
                }

                if (retryBtn) {
                    retryBtn.addEventListener('click', async () => {
                        await this.retryCameraAccess();
                    });
                }

                // Cerrar modal al hacer click fuera
                const modal = document.getElementById('cameraModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === 'cameraModal') {
                            this.stopCamera();
                        }
                    });
                }

                // Cerrar con tecla Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isScanning) {
                        this.stopCamera();
                    }
                });
            }

            // INICIAR C츼MARA CON VERIFICACI칍N
            async startCameraWithVerification() {
                console.log('游꿘 Iniciando verificaci칩n de c치mara...');
                
                // Mostrar modal inmediatamente con estado de carga
                this.showCameraModal();
                this.showLoadingState();
                
                try {
                    // Verificar disponibilidad nuevamente (por si cambi칩)
                    const isAvailable = await this.checkCameraAvailability();
                    
                    if (!isAvailable) {
                        this.showErrorState('La c치mara no est치 disponible en este momento.');
                        return;
                    }

                    // Intentar acceder a la c치mara
                    await this.accessCamera();
                    
                } catch (error) {
                    console.error('仇 Error en verificaci칩n de c치mara:', error);
                    this.showErrorState(this.getUserFriendlyErrorMessage(error));
                }
            }

            // ACCEDER A LA C츼MARA
            async accessCamera() {
                this.showLoadingState();
                
                const constraints = {
                    video: { 
                        facingMode: this.currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.videoElement.srcObject = this.stream;
                    this.isScanning = true;

                    // Esperar a que el video est칠 listo
                    await new Promise((resolve, reject) => {
                        this.videoElement.onloadedmetadata = () => resolve();
                        this.videoElement.onerror = () => reject(new Error('Error al cargar video'));
                        setTimeout(() => reject(new Error('Timeout de carga de video')), 5000);
                    });

                    // Mostrar interfaz de c치mara exitosa
                    this.showCameraSuccessState();
                    
                } catch (error) {
                    throw error;
                }
            }

            // REINTENTAR ACCESO A C츼MARA
            async retryCameraAccess() {
                console.log('游댃 Reintentando acceso a c치mara...');
                await this.startCameraWithVerification();
            }

            // MOSTRAR ESTADO DE CARGA
            showLoadingState() {
                this.hideAllStates();
                const loadingElement = document.getElementById('cameraLoading');
                const statusElement = document.getElementById('cameraStatus');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (statusElement) statusElement.style.display = 'block';
                
                this.updateCameraStatus('Conectando con la c치mara...', 'info');
            }

            // MOSTRAR ESTADO DE ERROR
            showErrorState(errorMessage) {
                this.hideAllStates();
                const errorElement = document.getElementById('cameraError');
                const errorMessageElement = document.getElementById('cameraErrorMessage');
                
                if (errorElement) errorElement.style.display = 'block';
                if (errorMessageElement) errorMessageElement.textContent = errorMessage;
                
                this.stopCamera(); // Limpiar recursos
            }

            // MOSTRAR ESTADO EXITOSO
            showCameraSuccessState() {
                this.hideAllStates();
                
                const container = document.getElementById('cameraContainer');
                const controls = document.getElementById('cameraControls');
                const instructions = document.getElementById('cameraInstructions');
                const status = document.getElementById('cameraStatus');
                
                if (container) container.style.display = 'block';
                if (controls) controls.style.display = 'flex';
                if (instructions) instructions.style.display = 'block';
                if (status) status.style.display = 'block';
                
                this.updateCameraStatus('C치mara lista - Enfoca el c칩digo en el recuadro verde', 'success');
            }

            // OCULTAR TODOS LOS ESTADOS
            hideAllStates() {
                const elements = [
                    'cameraLoading',
                    'cameraContainer', 
                    'cameraError',
                    'cameraControls',
                    'cameraInstructions'
                ];
                
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                });
            }

            // MOSTRAR MENSAJE DE C츼MARA NO DISPONIBLE
            showCameraUnavailableMessage() {
                const errorMessage = this.getCameraUnavailableMessage();
                showToast(`${errorMessage}`, 'error');
            }

            // OBTENER MENSAJE AMIGABLE DE ERROR
            getUserFriendlyErrorMessage(error) {
                switch (error.name) {
                    case 'NotAllowedError':
                        return 'Permiso de c치mara denegado. Por favor, permite el acceso a la c치mara en la configuraci칩n de tu navegador.';
                    case 'NotFoundError':
                        return 'No se encontr칩 ninguna c치mara en tu dispositivo.';
                    case 'NotSupportedError':
                        return 'Tu navegador no soporta acceso a la c치mara. Usa Chrome, Firefox o Safari.';
                    case 'NotReadableError':
                        return 'La c치mara est치 siendo usada por otra aplicaci칩n. Ci칠rrala e intenta de nuevo.';
                    case 'OverconstrainedError':
                        return 'No se puede acceder a la c치mara con las configuraciones solicitadas.';
                    case 'TimeoutError':
                        return 'El acceso a la c치mara tard칩 demasiado tiempo. Intenta de nuevo.';
                    default:
                        return `No se pudo acceder a la c치mara: ${error.message || 'Error desconocido'}`;
                }
            }

            // OBTENER MENSAJE DE C츼MARA NO DISPONIBLE
            getCameraUnavailableMessage() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    return 'Tu navegador no soporta acceso a la c치mara.';
                }
                return 'La c치mara no est치 disponible. Verifica los permisos o conecta una c치mara.';
            }

            // CAPTURAR Y ESCANEAR IMAGEN
            captureAndScan() {
                if (!this.videoElement || !this.isScanning) {
                    this.updateCameraStatus('La c치mara no est치 lista', 'error');
                    return;
                }

                this.updateCameraStatus('Procesando imagen...', 'info');

                // Configurar canvas con las dimensiones del video
                const video = this.videoElement;
                this.canvasElement.width = video.videoWidth;
                this.canvasElement.height = video.videoHeight;

                // Dibujar frame actual en canvas
                this.context.drawImage(video, 0, 0, this.canvasElement.width, this.canvasElement.height);

                // Intentar leer c칩digos
                this.scanForBarcodes();
            }

            // ESCANEAR C칍DIGOS DE BARRAS Y QR
            async scanForBarcodes() {
                try {
                    // Opci칩n 1: Usar la API de Barcode Detection (navegadores modernos)
                    if ('BarcodeDetector' in window) {
                        await this.scanWithBarcodeDetector();
                    } 
                    // Opci칩n 2: Usar librer칤a JavaScript (fallback)
                    else {
                        await this.scanWithJsLibrary();
                    }

                } catch (error) {
                    console.error('Error en el escaneo:', error);
                    this.updateCameraStatus('Error en el escaneo. Intenta de nuevo.', 'error');
                }
            }

            // USAR API NATIVA DE BARCODE DETECTION
            async scanWithBarcodeDetector() {
                try {
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['qr_code', 'code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
                    });

                    const barcodes = await barcodeDetector.detect(this.canvasElement);
                    
                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];
                        console.log('九 C칩digo detectado:', barcode.rawValue);
                        this.handleScannedCode(barcode.rawValue);
                    } else {
                        this.updateCameraStatus('No se detect칩 ning칰n c칩digo. Intenta con mejor iluminaci칩n.', 'warning');
                    }
                } catch (error) {
                    console.error('Error con BarcodeDetector:', error);
                    this.scanWithJsLibrary(); // Fallback a librer칤a JS
                }
            }

            // USAR LIBRER칈A JAVASCRIPT COMO FALLBACK
            async scanWithJsLibrary() {
                this.updateCameraStatus('Usando m칠todo alternativo de escaneo...', 'info');
                
                // En una implementaci칩n real, aqu칤 cargar칤as QuaggaJS o JsQR
                // Por ahora simulamos un peque침o delay
                setTimeout(() => {
                    this.updateCameraStatus('Para escaneo avanzado, instala una librer칤a de escaneo.', 'info');
                }, 1000);
            }

            // MANEJAR C칍DIGO ESCANEADO
            handleScannedCode(code) {
                console.log('游꿢 C칩digo escaneado:', code);
                
                // Limpiar y formatear el c칩digo
                const cleanedCode = code.trim().toUpperCase();
                
                // Actualizar campo de b칰squeda
                if (this.searchInput) {
                    this.searchInput.value = cleanedCode;
                    this.searchInput.focus();
                    
                    // Aplicar filtros autom치ticamente
                    setTimeout(() => {
                        if (typeof applyTicketFilters === 'function') {
                            applyTicketFilters();
                        }
                    }, 100);
                }

                // Mostrar confirmaci칩n
                this.updateCameraStatus(`九 C칩digo detectado: ${cleanedCode}`, 'success');
                
                // Cerrar c치mara despu칠s de 칠xito
                setTimeout(() => {
                    this.stopCamera();
                    showToast(`C칩digo escaneado: ${cleanedCode}`, 'success');
                }, 1500);
            }

            // CAMBIAR ENTRE C츼MARAS
            async switchCamera() {
                console.log('游댃 Cambiando c치mara...');
                this.currentFacingMode = this.currentFacingMode === 'environment' ? 'user' : 'environment';
                this.stopCamera();
                
                // Peque침o delay antes de reiniciar
                setTimeout(() => {
                    this.startCameraWithVerification();
                }, 500);
            }

            // DETENER C츼MARA
            stopCamera() {
                console.log('游띔 Deteniendo c치mara...');
                if (this.stream) {
                    this.stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.stream = null;
                }
                this.isScanning = false;
                this.hideCameraModal();
                this.hideAllStates();
            }

            // MOSTRAR MODAL DE C츼MARA
            showCameraModal() {
                const modal = document.getElementById('cameraModal');
                if (!modal) {
                    console.error('仇 No se encuentra el modal de c치mara');
                    return;
                }
                
                console.log('游댃 Mostrando modal de c치mara...');
                modal.style.display = 'flex';
                
                // Forzar reflow
                modal.offsetHeight;
                
                setTimeout(() => {
                    modal.classList.add('active');
                    console.log('九 Modal de c치mara activado');
                }, 10);
            }

            // OCULTAR MODAL DE C츼MARA
            hideCameraModal() {
                const modal = document.getElementById('cameraModal');
                if (!modal) return;
                
                console.log('游댃 Ocultando modal de c치mara...');
                modal.classList.remove('active');
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    this.updateCameraStatus('Preparando c치mara...', 'info');
                    console.log('九 Modal de c치mara ocultado');
                }, 300);
            }

            // ACTUALIZAR ESTADO DE LA C츼MARA
            updateCameraStatus(message, type = 'info') {
                const statusElement = document.getElementById('cameraStatus');
                if (statusElement) {
                    const icon = this.getStatusIcon(type);
                    const color = this.getStatusColor(type);
                    
                    statusElement.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
                    statusElement.style.background = color;
                    statusElement.style.borderLeft = `4px solid ${this.getStatusBorderColor(type)}`;
                }
            }

            getStatusIcon(type) {
                const icons = {
                    info: 'info-circle',
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    error: 'exclamation-circle'
                };
                return icons[type] || 'info-circle';
            }

            getStatusColor(type) {
                const colors = {
                    info: 'rgba(52, 152, 219, 0.1)',
                    success: 'rgba(39, 174, 96, 0.1)',
                    warning: 'rgba(243, 156, 18, 0.1)',
                    error: 'rgba(231, 76, 60, 0.1)'
                };
                return colors[type] || 'var(--light-color)';
            }

            getStatusBorderColor(type) {
                const colors = {
                    info: '#3498db',
                    success: '#27ae60',
                    warning: '#f39c12',
                    error: '#e74c3c'
                };
                return colors[type] || '#3498db';
            }
        }

        // ===== INICIALIZACI칍N DEL ESC츼NER =====
        let cameraScanner;

        async function initializeCameraScanner() {
            // Verificar compatibilidad b치sica
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('仇 API de c치mara no soportada');
                showToast('La funci칩n de c치mara no est치 disponible en tu navegador', 'warning');
                return null;
            }

            try {
                cameraScanner = new CameraScanner();
                await cameraScanner.initialize();
                
                if (cameraScanner.isCameraAvailable) {
                    console.log('游꿢 Esc치ner de c치mara listo para usar');
                } else {
                    console.warn('丘멆잺 Esc치ner de c치mara inicializado pero no disponible');
                }
                
                return cameraScanner;
            } catch (error) {
                console.error('仇 Error inicializando esc치ner de c치mara:', error);
                showToast('Error al configurar la c치mara', 'error');
                return null;
            }
        }

        // ===== FUNCI칍N PARA GENERAR C칍DIGOS QR =====
        async function generateQRCodeDataURL(text) {
            return new Promise((resolve) => {
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(text);
                    qr.make();
                    
                    const size = 200;
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    
                    // Fondo blanco
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);
                    
                    // Celdas del QR
                    const cellSize = size / qr.getModuleCount();
                    ctx.fillStyle = '#000000';
                    
                    for (let row = 0; row < qr.getModuleCount(); row++) {
                        for (let col = 0; col < qr.getModuleCount(); col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(
                                    col * cellSize,
                                    row * cellSize,
                                    cellSize,
                                    cellSize
                                );
                            }
                        }
                    }
                    
                    resolve(canvas.toDataURL('image/png'));
                } catch (error) {
                    console.error('Error generando QR:', error);
                    resolve(null);
                }
            });
        }

        // ===== FUNCIONES DE VALIDACI칍N MEJORADAS =====
        function validateProductForPdf(product) {
            const errors = [];
            
            if (!product.codigo || product.codigo.trim() === '') {
                errors.push('C칩digo requerido');
            }
            
            if (!product.descripcion || product.descripcion.trim() === '') {
                errors.push('Descripci칩n requerida');
            }
            
            if (!product.unidadMedida || product.unidadMedida.trim() === '') {
                errors.push('Unidad de medida requerida');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        function validateAllFieldsBeforePdf() {
            const invalidProducts = [];
            
            TicketExcelState.filteredProducts.forEach((product, index) => {
                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    invalidProducts.push({
                        ...product,
                        rowNumber: index + 1,
                        errors: validation.errors
                    });
                }
            });
            
            return {
                allValid: invalidProducts.length === 0,
                invalidProducts: invalidProducts
            };
        }

        // ===== ESTADO DE LA APLICACI칍N =====
        const TicketExcelState = {
            currentStep: 'upload',
            products: [],
            filteredProducts: [],
            fileData: null,
            pagination: {
                currentPage: 1,
                itemsPerPage: 9,
                totalPages: 1,
                totalItems: 0
            },
            filters: {
                search: '',
                familia: '',
                acabado: '',
                material: '',
                availableOptions: {
                    familias: [],
                    acabados: [],
                    materiales: [],
                    calidades: []
                }
            }
        };

        // ===== FUNCI칍N PARA HABILITAR/DESHABILITAR FILTROS =====

        function updateFiltersAvailability() {
            const familiaSelect = document.getElementById('ticketFilterFamilia');
            const acabadoSelect = document.getElementById('ticketFilterAcabado');
            const materialSelect = document.getElementById('ticketFilterMaterial');
            
            const familiaSeleccionada = familiaSelect ? familiaSelect.value : '';
            
            // Habilitar/deshabilitar filtros seg칰n selecci칩n
            if (acabadoSelect) {
                if (familiaSeleccionada) {
                    acabadoSelect.disabled = false;
                    acabadoSelect.style.opacity = '1';
                    acabadoSelect.style.cursor = 'pointer';
                } else {
                    acabadoSelect.disabled = true;
                    acabadoSelect.style.opacity = '0.6';
                    acabadoSelect.style.cursor = 'not-allowed';
                    acabadoSelect.value = ''; // Limpiar valor
                }
            }
            
            if (materialSelect) {
                const acabadoSeleccionado = acabadoSelect ? acabadoSelect.value : '';
                if (familiaSeleccionada && acabadoSeleccionado) {
                    materialSelect.disabled = false;
                    materialSelect.style.opacity = '1';
                    materialSelect.style.cursor = 'pointer';
                } else {
                    materialSelect.disabled = true;
                    materialSelect.style.opacity = '0.6';
                    materialSelect.style.cursor = 'not-allowed';
                    materialSelect.value = ''; // Limpiar valor
                }
            }
            
            // Actualizar estilos visuales
            updateFiltersVisualState();
        }

        // Funci칩n para actualizar el estado visual de los filtros
        function updateFiltersVisualState() {
            const filters = [
                { element: document.getElementById('ticketFilterFamilia'), label: 'Familia' },
                { element: document.getElementById('ticketFilterAcabado'), label: 'Acabado' },
                { element: document.getElementById('ticketFilterMaterial'), label: 'Material' }
            ];
            
            filters.forEach(filter => {
                if (filter.element) {
                    const formGroup = filter.element.closest('.form-group');
                    if (formGroup) {
                        if (filter.element.disabled) {
                            formGroup.style.opacity = '0.6';
                            formGroup.title = `Selecciona ${getDependencyForFilter(filter.label)} primero`;
                        } else {
                            formGroup.style.opacity = '1';
                            formGroup.title = '';
                        }
                    }
                }
            });
        }

        // Funci칩n auxiliar para obtener la dependencia de cada filtro
        function getDependencyForFilter(filterName) {
            const dependencies = {
                'Familia': 'ninguno (siempre disponible)',
                'Acabado': 'una Familia',
                'Material': 'una Familia y un Acabado'
            };
            return dependencies[filterName] || '';
        }

        // ===== FUNCIONES PARA FILTROS DEPENDIENTES =====

        function getAvailableAcabadosForFamilia(familiaSeleccionada) {
            if (!familiaSeleccionada) {
                // Si no hay familia seleccionada, mostrar todos los acabados 칰nicos
                const allAcabados = new Set();
                TicketExcelState.products.forEach(product => {
                    if (product.acabado) allAcabados.add(product.acabado);
                });
                return Array.from(allAcabados).sort();
            }
            
            // Filtrar acabados que pertenecen a la familia seleccionada
            const acabados = new Set();
            TicketExcelState.products.forEach(product => {
                if (product.familia === familiaSeleccionada && product.acabado) {
                    acabados.add(product.acabado);
                }
            });
            return Array.from(acabados).sort();
        }

        function getAvailableMaterialesForAcabado(familiaSeleccionada, acabadoSeleccionado) {
            if (!acabadoSeleccionado) {
                // Si no hay acabado seleccionado, mostrar todos los materiales 칰nicos para la familia
                const materiales = new Set();
                TicketExcelState.products.forEach(product => {
                    if ((!familiaSeleccionada || product.familia === familiaSeleccionada) && product.material) {
                        materiales.add(product.material);
                    }
                });
                return Array.from(materiales).sort();
            }
            
            // Filtrar materiales que pertenecen a la familia y acabado seleccionados
            const materiales = new Set();
            TicketExcelState.products.forEach(product => {
                if (product.familia === familiaSeleccionada && 
                    product.acabado === acabadoSeleccionado && 
                    product.material) {
                    materiales.add(product.material);
                }
            });
            return Array.from(materiales).sort();
        }

        function updateDependentFilters() {
            const familiaSelect = document.getElementById('ticketFilterFamilia');
            const acabadoSelect = document.getElementById('ticketFilterAcabado');
            const materialSelect = document.getElementById('ticketFilterMaterial');
            
            const familiaSeleccionada = familiaSelect ? familiaSelect.value : '';
            const acabadoSeleccionado = acabadoSelect ? acabadoSelect.value : '';
            
            // 1. Actualizar acabados basado en familia seleccionada
            if (acabadoSelect) {
                const acabadosDisponibles = getAvailableAcabadosForFamilia(familiaSeleccionada);
                const valorActual = acabadoSelect.value;
                
                acabadoSelect.innerHTML = '<option value="">Todos los acabados</option>';
                acabadosDisponibles.forEach(acabado => {
                    const option = document.createElement('option');
                    option.value = acabado;
                    option.textContent = acabado;
                    acabadoSelect.appendChild(option);
                });
                
                // Restaurar valor si todav칤a est치 disponible
                if (valorActual && acabadosDisponibles.includes(valorActual)) {
                    acabadoSelect.value = valorActual;
                } else {
                    acabadoSelect.value = '';
                }
                
                // Actualizar contador
                document.getElementById('acabadoCount').textContent = acabadosDisponibles.length;
            }
            
            // 2. Actualizar materiales basado en familia y acabado seleccionados
            if (materialSelect) {
                const materialesDisponibles = getAvailableMaterialesForAcabado(familiaSeleccionada, acabadoSeleccionado);
                const valorActual = materialSelect.value;
                
                materialSelect.innerHTML = '<option value="">Todos los materiales</option>';
                materialesDisponibles.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    materialSelect.appendChild(option);
                });
                
                // Restaurar valor si todav칤a est치 disponible
                if (valorActual && materialesDisponibles.includes(valorActual)) {
                    materialSelect.value = valorActual;
                } else {
                    materialSelect.value = '';
                }
                
                // Actualizar contador
                document.getElementById('materialCount').textContent = materialesDisponibles.length;
            }
            
            // 3. NUEVO: Actualizar disponibilidad de filtros
            updateFiltersAvailability();
        }

        const AppState = {
            isLoading: false,
            userData: null,
            supabaseLoaded: true,
            currentUser: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            currentTab: 'generateTicket',
            pagination: {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1,
                totalItems: 0
            }
        };

        // ===== SISTEMA DE VALIDACI칍N MEJORADO =====
        const FieldValidators = {
            descripcion: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La descripci칩n es requerida'
                        };
                    }
                    
                    if (value.length < 3) {
                        return {
                            isValid: false,
                            error: 'La descripci칩n debe tener al menos 3 caracteres'
                        };
                    }
                    
                    if (value.length > 200) {
                        return {
                            isValid: false,
                            error: 'La descripci칩n no puede exceder 200 caracteres'
                        };
                    }
                    
                    const invalidChars = /[<>{}[\]]/;
                    if (invalidChars.test(value)) {
                        return {
                            isValid: false,
                            error: 'La descripci칩n contiene caracteres no permitidos'
                        };
                    }
                    
                    return {
                        isValid: true,
                        error: null
                    };
                },
                
                format: (value) => {
                    return value.toString().trim()
                        .toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase())
                        .replace(/\s+/g, ' ');
                }
            },
            
            unidadMedida: {
                validate: (value) => {
                    value = value.toString().trim().toUpperCase();
                    
                    if (!value || value === '') {
                        return {
                            isValid: false,
                            error: 'La unidad de medida es requerida'
                        };
                    }
                    
                    if (value.length > 10) {
                        return {
                            isValid: false,
                            error: 'La unidad no puede exceder 10 caracteres'
                        };
                    }
                                        
                    return {
                        isValid: true,
                        error: null,
                    };
                },
                
                format: (value) => {
                    return value.toString().trim().toUpperCase();
                }
            }
        };

        // ===== INICIALIZACI칍N DE LA APLICACI칍N =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('游 Inicializando aplicaci칩n Gallos M치rmol - Despacho...');
            
            // Verificar dependencias
            if (typeof supabase === 'undefined') {
                console.error('仇 Supabase no est치 cargado');
                showToast('Error: No se pudo conectar con el servidor', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                console.error('仇 SheetJS no est치 cargado');
                showToast('Error: No se pudo cargar el sistema de archivos', 'error');
                return;
            }
            
            // Verificar sesi칩n usando auth-check.js
            if (typeof AuthChecker !== 'undefined') {
                AuthChecker.verificarSesionOptimizada();
            } else {
                console.error('仇 AuthChecker no est치 disponible');
                showToast('Error: No se pudo verificar la sesi칩n', 'error');
            }
            
            // Inicializar la aplicaci칩n
            initializeApp();
            
            console.log('九 Aplicaci칩n de Despacho inicializada correctamente');
        });

        // ===== INICIALIZAR APLICACI칍N =====
        async function initializeApp() {
            try {
                console.log('游댃 Inicializando aplicaci칩n de Despacho...');
                
                // Limpiar sesiones redundantes
                cleanupRedundantSessions();
                
                setupEventListeners();
                
                // Inicializar sistema de carga dual
                initializeDualUploadSystem();       

                // Inicializar esc치ner de c치mara
                initializeCameraScanner();

                // Verificar autenticaci칩n usando sesiones existentes
                const userData = await checkCustomAuth();
                
                if (userData && userData.authenticated) {
                    console.log('九 Sesi칩n encontrada:', userData.email);
                    AppState.currentUser = userData;
                    await loadApplication();
                } else {
                    console.log('游뛂 No hay sesi칩n activa - Redirigiendo al portal');
                    showToast('No hay sesi칩n activa. Redirigiendo al portal...', 'warning');
                    
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('仇 Error inicializando aplicaci칩n:', error);
                showToast('Error al cargar la aplicaci칩n', 'error');
            }
        }

        // Agregar al estado de la aplicaci칩n
        TicketExcelState.uploadMode = 'fixed'; // 'fixed' o 'custom'

        // Funci칩n para inicializar el sistema de carga dual
        function initializeDualUploadSystem() {
            console.log('游댃 Inicializando sistema de carga dual...');
            
            // Configurar event listeners para los modos
            setupUploadModeListeners();
            
            // Configurar carga del archivo fijo
            setupFixedFileLoading();
            
            // Cargar archivo fijo por defecto
            loadFixedFile();
        }

        // ===== FUNCIONES PARA MODAL DE ELIMINACI칍N =====

        let productToDelete = null;

        function showDeleteConfirmationModal(productId) {
            const product = TicketExcelState.products.find(p => p.id === productId);
            if (!product) {
                showToast('Producto no encontrado', 'error');
                return;
            }
            
            productToDelete = productId;
            
            // Actualizar la informaci칩n del producto en el modal
            updateDeleteModalContent(product);
            
            // Mostrar el modal
            const modal = document.getElementById('deleteConfirmationModal');
            modal.style.display = 'flex';
            
            // Animaci칩n de entrada
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function updateDeleteModalContent(product) {
            const productInfoContainer = document.getElementById('deleteProductInfo');
            
            const modalContent = `
                <div class="product-info-header">
                    <h4 style="margin: 0; color: var(--text-color);">Informaci칩n del Producto</h4>
                    <span class="product-info-code">${product.codigo || 'Sin c칩digo'}</span>
                </div>
                <div class="product-info-details">
                    <div class="product-info-row">
                        <span class="product-info-label">Descripci칩n:</span>
                        <span class="product-info-value">${product.descripcion || 'Sin descripci칩n'}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Familia:</span>
                        <span class="product-info-value">${product.familia || 'No especificada'}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Material:</span>
                        <span class="product-info-value">${product.material || 'No especificado'}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Dimensi칩n:</span>
                        <span class="product-info-value">${product.dimension || 'No especificada'}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="product-info-label">Unidad:</span>
                        <span class="product-info-value">${product.unidadMedida || 'No especificada'}</span>
                    </div>
                    ${product.validationErrors && product.validationErrors.length > 0 ? `
                    <div class="product-info-row">
                        <span class="product-info-label" style="color: var(--danger-color);">Errores:</span>
                        <span class="product-info-value" style="color: var(--danger-color);">
                            ${product.validationErrors.join(', ')}
                        </span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            productInfoContainer.innerHTML = modalContent;
        }

        function hideDeleteConfirmationModal() {
            const modal = document.getElementById('deleteConfirmationModal');
            modal.classList.remove('active');
            
            setTimeout(() => {
                modal.style.display = 'none';
                productToDelete = null;
            }, 300);
        }

        function confirmDeleteProduct() {
            if (!productToDelete) {
                showToast('Error: No hay producto seleccionado para eliminar', 'error');
                return;
            }
            
            removeProductFromList(productToDelete);
            hideDeleteConfirmationModal();
            
            // Efecto visual de confirmaci칩n
            showToast('Producto eliminado correctamente', 'success');
        }

        // Agregar efecto de confirmaci칩n visual
        function addDeleteConfirmationEffect(productId) {
            const productCard = document.querySelector(`[data-product-id="${productId}"]`);
            if (productCard) {
                productCard.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(() => {
                    productCard.remove();
                }, 500);
            }
        }

        // Configurar eventos del modal de eliminaci칩n
        function setupDeleteModalEvents() {
            const modal = document.getElementById('deleteConfirmationModal');
            const closeBtn = document.getElementById('closeDeleteModal');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            // Cerrar modal con bot칩n X
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDeleteConfirmationModal);
            }
            
            // Cancelar eliminaci칩n
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideDeleteConfirmationModal);
            }
            
            // Confirmar eliminaci칩n
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmDeleteProduct);
            }
            
            // Cerrar modal al hacer click fuera
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideDeleteConfirmationModal();
                    }
                });
            }
            
            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    hideDeleteConfirmationModal();
                }
            });
            
            // Efecto de "shake" al intentar eliminar sin confirmar
            confirmBtn.addEventListener('mouseenter', function() {
                if (!productToDelete) return;
                
                this.style.transform = 'scale(1.02)';
                this.style.transition = 'all 0.2s ease';
            });
            
            confirmBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        }

        // Funci칩n para eliminar producto (ya existente, pero mejorada)
        function removeProductFromList(productId) {
            console.log('游딈勇 Eliminando producto:', productId);
            
            const initialLength = TicketExcelState.products.length;
            
            // Eliminar de ambos arrays
            TicketExcelState.products = TicketExcelState.products.filter(p => p.id !== productId);
            TicketExcelState.filteredProducts = TicketExcelState.filteredProducts.filter(p => p.id !== productId);
            
            const finalLength = TicketExcelState.products.length;
            
            if (finalLength < initialLength) {
                console.log('九 Producto eliminado correctamente');
                
                // Si no quedan productos, volver al paso de upload
                if (TicketExcelState.products.length === 0) {
                    backToTicketUpload();
                } else {
                    // Re-renderizar la tabla y actualizar filtros
                    renderTicketProductsTable();
                    updateDespachoFilters();
                    
                    // Actualizar contadores
                    updateProductsCount();
                }
            } else {
                console.error('仇 No se pudo eliminar el producto');
                showToast('Error al eliminar el producto', 'error');
            }
        }

        // Funci칩n para actualizar el contador de productos
        function updateProductsCount() {
            const productsCountElement = document.getElementById('productsCount');
            if (productsCountElement) {
                const totalProducts = TicketExcelState.products.length;
                const filteredCount = TicketExcelState.filteredProducts.length;
                
                if (filteredCount < totalProducts) {
                    productsCountElement.textContent = `${filteredCount} de ${totalProducts} productos (filtrados)`;
                } else {
                    productsCountElement.textContent = `${totalProducts} productos cargados`;
                }
            }
        }

        // Configurar selectores de modo
        function setupUploadModeListeners() {
            const modeOptions = document.querySelectorAll('.mode-option');
            
            modeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    switchUploadMode(mode);
                });
            });
        }

        // Cambiar entre modos de carga
        function switchUploadMode(mode) {
            console.log('游댃 Cambiando modo de carga a:', mode);
            
            // Actualizar estado
            TicketExcelState.uploadMode = mode;
            
            // Actualizar interfaz
            const modeOptions = document.querySelectorAll('.mode-option');
            const fixedContainer = document.getElementById('fixedFileContainer');
            const customContainer = document.getElementById('customFileContainer');
            
            // Actualizar tarjetas de modo
            modeOptions.forEach(opt => {
                const isActive = opt.getAttribute('data-mode') === mode;
                opt.classList.toggle('active', isActive);
                
                const card = opt.querySelector('.mode-card');
                if (isActive) {
                    card.style.borderColor = 'var(--primary-color)';
                    card.style.background = 'rgba(52, 152, 219, 0.05)';
                } else {
                    card.style.borderColor = 'var(--border-color)';
                    card.style.background = '';
                }
            });
            
            // Mostrar/ocultar contenedores
            if (mode === 'fixed') {
                fixedContainer.style.display = 'block';
                customContainer.style.display = 'none';
                showToast('Modo: Plantilla Predefinida', 'info');
            } else {
                fixedContainer.style.display = 'none';
                customContainer.style.display = 'block';
                showToast('Modo: Archivo Personalizado', 'info');
                
                // Inicializar sistema de carga solo cuando se cambia al modo personalizado
                setTimeout(() => {
                    setupCustomFileLoading();
                }, 100);
            }
        }

        // Configurar carga de archivo fijo
        function setupFixedFileLoading() {
            const loadFixedFileBtn = document.getElementById('loadFixedFileBtn');
            
            if (loadFixedFileBtn) {
                loadFixedFileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadFixedFile();
                });
            }
        }

        // Funci칩n para cargar el archivo fijo
        async function loadFixedFile() {
            try {
                console.log('游늬 Cargando archivo fijo...');
                showLoadingOverlay(true, 'Cargando plantilla predefinida...');
                
                const filePath = '../../ARCHIVO/EXCEL/Plantilla_01.xlsx';
                
                // Intentar cargar el archivo usando Fetch API
                const response = await fetch(filePath);
                
                if (!response.ok) {
                    throw new Error(`No se pudo cargar el archivo: ${response.status} ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                // Procesar el archivo como si fuera subido
                processExcelFileFromArrayBuffer(arrayBuffer, 'Plantilla_01.xlsx');
                
                showToast('Plantilla predefinida cargada correctamente', 'success');
                
            } catch (error) {
                console.error('仇 Error cargando archivo fijo:', error);
                
                // Fallback: Usar datos de ejemplo program치ticos
                showToast('Usando datos de ejemplo (archivo no encontrado)', 'warning');
                loadFallbackSampleData();
            } finally {
                showLoadingOverlay(false);
            }
        }

        // Funci칩n para procesar ArrayBuffer como archivo Excel
        function processExcelFileFromArrayBuffer(arrayBuffer, fileName) {
            try {
                console.log('游늵 Procesando archivo desde ArrayBuffer:', fileName);
                
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Obtener la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertir a JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length <= 1) {
                    showToast('El archivo est치 vac칤o o no contiene datos v치lidos', 'warning');
                    return;
                }
                
                // Procesar los datos
                processExcelData(jsonData);
                
            } catch (error) {
                console.error('Error procesando archivo desde ArrayBuffer:', error);
                showToast('Error al procesar el archivo: ' + error.message, 'error');
            }
        }

        // Datos de ejemplo como fallback
        function loadFallbackSampleData() {
            console.log('游댃 Cargando datos de ejemplo de respaldo...');
            
            const sampleData = [
                ['C칍DIGO', 'DESCRIPCI칍N', 'FAMILIA', 'ACABADO', 'BORDE', 'CALIDAD', 'MATERIAL', 'DIMENSI칍N', 'UNIDAD_MEDIDA'],
                ['DESP001', 'M치rmol Blanco Carrara 60x60', 'M치rmol', 'Pulido', 'Recto', 'Premium', 'M치rmol Carrara', '60x60', 'M2'],
                ['DESP002', 'Granito Negro Absoluto 30x30', 'Granito', 'Pulido', 'Biselado', 'Est치ndar', 'Granito Negro', '30x30', 'M2'],
                ['DESP003', 'Porcelanato Blanco 45x45', 'Porcelanato', 'Mate', 'Recto', 'Premium', 'Porcelana', '45x45', 'M2'],
                ['DESP004', 'Travertino Romano 40x40', 'Travertino', 'Pulido', 'Recto', 'Premium', 'Travertino', '40x40', 'M2'],
                ['DESP005', 'Cuarzo Blanco 30x60', 'Cuarzo', 'Pulido', 'Recto', 'Premium', 'Cuarzo', '30x60', 'M2'],
                ['DESP006', 'M치rmol Crema Marfil 50x50', 'M치rmol', 'Pulido', 'Biselado', 'Premium', 'M치rmol Crema', '50x50', 'M2'],
                ['DESP007', 'Granito Gris Perla 60x60', 'Granito', 'Pulido', 'Recto', 'Est치ndar', 'Granito Gris', '60x60', 'M2']
            ];
            
            // Procesar los datos de ejemplo
            processExcelData(sampleData);
        }

        // ===== SISTEMA DE CARGA CON BOT칍N - MEJORADO =====
        let fileUploadInitialized = false;
        let fileSelectionInProgress = false;

        function setupCustomFileLoading() {
            if (fileUploadInitialized) {
                return;
            }

            console.log('游댃 Configurando sistema de carga...');
            
            // OBTENER REFERENCIAS
            const fileInput = document.getElementById('ticketFileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const processFileBtn = document.getElementById('processFileBtn');

            // 九 CONFIGURACI칍N SIMPLE DEL BOT칍N DE SELECCI칍N
            selectFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('游늬 Abriendo selector de archivos...');
                fileInput.click();
            });

            // EVENTO CHANGE DEL ARCHIVO
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const file = e.target.files[0];
                    console.log('九 Archivo seleccionado:', file.name);
                    showFileInfo(file);
                }
            });

            // BOT칍N PROCESAR
            processFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!fileInput.files || fileInput.files.length === 0) {
                    showToast('Primero selecciona un archivo', 'warning');
                    return;
                }
                processTicketFile(fileInput.files[0]);
            });

            fileUploadInitialized = true;
            console.log('九 Sistema configurado correctamente');
        }

        // FUNCI칍N MEJORADA PARA MOSTRAR INFORMACI칍N DEL ARCHIVO
        function showFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const processFileBtn = document.getElementById('processFileBtn');
            
            if (!fileInfo || !fileName || !fileSize || !processFileBtn) {
                console.error('仇 Elementos de informaci칩n de archivo no encontrados');
                return;
            }

            // Validar extensi칩n
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            const isValid = validExtensions.includes(fileExtension);

            // Actualizar informaci칩n
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);

            // Actualizar bot칩n y estilos
            if (isValid) {
                processFileBtn.disabled = false;
                processFileBtn.className = 'btn btn-success';
                processFileBtn.innerHTML = '<i class="fas fa-upload"></i> Procesar Archivo';
                fileInfo.style.borderLeftColor = 'var(--success-color)';
                fileInfo.style.background = 'rgba(39, 174, 96, 0.05)';
            } else {
                processFileBtn.disabled = true;
                processFileBtn.className = 'btn btn-danger';
                processFileBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Formato no v치lido';
                fileInfo.style.borderLeftColor = 'var(--danger-color)';
                fileInfo.style.background = 'rgba(231, 76, 60, 0.05)';
            }

            // Mostrar contenedor con animaci칩n
            fileInfo.style.display = 'block';
            
            // Feedback visual
            if (isValid) {
                showToast(`Archivo v치lido: ${file.name}`, 'success');
            } else {
                showToast(`Formato no soportado: ${fileExtension}`, 'error');
            }
        }

        // OCULTAR INFORMACI칍N DEL ARCHIVO
        function hideFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            if (fileInfo) {
                fileInfo.style.display = 'none';
            }
        }

        // FORMATEAR TAMA칌O DE ARCHIVO
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ACTUALIZAR LA FUNCI칍N DE CAMBIO DE MODO
        function switchUploadMode(mode) {
            console.log('游댃 Cambiando modo de carga a:', mode);
            
            TicketExcelState.uploadMode = mode;
            
            const modeOptions = document.querySelectorAll('.mode-option');
            const fixedContainer = document.getElementById('fixedFileContainer');
            const customContainer = document.getElementById('customFileContainer');
            
            // Actualizar tarjetas de modo
            modeOptions.forEach(opt => {
                const isActive = opt.getAttribute('data-mode') === mode;
                opt.classList.toggle('active', isActive);
                
                const card = opt.querySelector('.mode-card');
                if (isActive) {
                    card.style.borderColor = 'var(--primary-color)';
                    card.style.background = 'rgba(52, 152, 219, 0.05)';
                } else {
                    card.style.borderColor = 'var(--border-color)';
                    card.style.background = '';
                }
            });
            
            // Mostrar/ocultar contenedores
            if (mode === 'fixed') {
                fixedContainer.style.display = 'block';
                customContainer.style.display = 'none';
                showToast('Modo: Plantilla Predefinida', 'info');
            } else {
                fixedContainer.style.display = 'none';
                customContainer.style.display = 'block';
                showToast('Modo: Archivo Personalizado', 'info');
                
                // Inicializar sistema de carga con bot칩n
                setTimeout(() => {
                    setupCustomFileLoading();
                }, 100);
            }
        }

        // FUNCI칍N MEJORADA PARA PROCESAR ARCHIVOS
        function processTicketFile(file) {
            if (!file) {
                console.error('仇 No se proporcion칩 archivo');
                return;
            }

            console.log('游댃 Procesando archivo:', file.name);
            
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showToast('Formato de archivo no v치lido. Use Excel (.xlsx, .xls) o CSV', 'error');
                return;
            }

            // Mostrar feedback inmediato
            showLoadingOverlay(true, `Procesando ${file.name}...`);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('游늵 Leyendo contenido del archivo...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obtener la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length <= 1) {
                        showToast('El archivo est치 vac칤o o no contiene datos v치lidos', 'warning');
                        showLoadingOverlay(false);
                        return;
                    }
                    
                    console.log('九 Archivo procesado correctamente, filas:', jsonData.length);
                    
                    // Procesar los datos
                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error('仇 Error procesando archivo Excel:', error);
                    showToast('Error al procesar el archivo Excel: ' + error.message, 'error');
                    showLoadingOverlay(false);
                }
            };
            
            reader.onerror = function() {
                console.error('仇 Error leyendo archivo');
                showToast('Error al leer el archivo', 'error');
                showLoadingOverlay(false);
            };
            
            reader.onabort = function() {
                console.warn('丘멆잺 Lectura de archivo abortada');
                showToast('Lectura de archivo cancelada', 'warning');
                showLoadingOverlay(false);
            };
            
            reader.readAsArrayBuffer(file);
        }

        async function checkCustomAuth() {
            try {
                console.log('游댌 Verificando autenticaci칩n PIN...');
                
                const sesionPinGM = localStorage.getItem('sesion_pin_gm');
                const gmUserSession = localStorage.getItem('gm_user_session');
                
                console.log('游늶 Sesiones encontradas:', {
                    sesionPinGM: sesionPinGM ? 'PRESENTE' : 'AUSENTE',
                    gmUserSession: gmUserSession ? 'PRESENTE' : 'AUSENTE'
                });
                
                // Priorizar sesion_pin_gm como fuente principal
                if (sesionPinGM) {
                    const sessionData = JSON.parse(sesionPinGM);
                    
                    if (isValidPINSession(sessionData)) {
                        const userInfo = extractUserInfo(sessionData);
                        console.log('九 Usuario autorizado desde sesion_pin_gm:', userInfo);
                        return userInfo;
                    }
                }
                
                // Fallback a gm_user_session si es necesario
                if (gmUserSession) {
                    const sessionData = JSON.parse(gmUserSession);
                    
                    if (isValidPINSession(sessionData)) {
                        const userInfo = extractUserInfo(sessionData);
                        console.log('九 Usuario autorizado desde gm_user_session:', userInfo);
                        return userInfo;
                    }
                }
                
                console.log('仇 No se encontr칩 sesi칩n PIN v치lida');
                return null;
                
            } catch (error) {
                console.error('Error verificando autenticaci칩n PIN:', error);
                return null;
            }
        }

        // ===== FUNCI칍N DE LIMPIEZA (opcional) =====
        function cleanupRedundantSessions() {
            // Eliminar userSession si existe
            if (localStorage.getItem('userSession')) {
                localStorage.removeItem('userSession');
                console.log('游빛 userSession redundante eliminado');
            }
            
            // Tambi칠n puedes limpiar gm_user_session si no es necesaria
            // (depende de tu arquitectura)
            const sesionPinGM = localStorage.getItem('sesion_pin_gm');
            if (sesionPinGM && localStorage.getItem('gm_user_session')) {
                // gm_user_session parece ser un duplicado de sesion_pin_gm
                // Considera eliminarla si no tiene un prop칩sito espec칤fico
                // localStorage.removeItem('gm_user_session');
            }
        }

        // Funci칩n para validar la sesi칩n PIN
        function isValidPINSession(sessionData) {
            try {
                // Verificar estructura b치sica
                if (!sessionData || !sessionData.usuario || !sessionData.sistemas) {
                    console.log('仇 Estructura de sesi칩n inv치lida');
                    return false;
                }
                
                // Verificar timestamp de actividad (opcional - si quieres expiraci칩n)
                const ultimaActividad = sessionData.ultimaActividad;
                const ahora = Date.now();
                const tiempoExpiracion = 24 * 60 * 60 * 1000; // 24 horas
                
                if (ultimaActividad && (ahora - ultimaActividad > tiempoExpiracion)) {
                    console.log('仇 Sesi칩n expirada');
                    return false;
                }
                
                // Verificar acceso al sistema de suministro
                const sistemaDespacho = sessionData.sistemas.find(s => s.key === 'sistemaDespacho');
                
                if (!sistemaDespacho) {
                    console.log('仇 No tiene acceso al sistema de despacho');
                    return false;
                }
                
                if (!sistemaDespacho.activo) {
                    console.log('仇 Sistema de despacho no activo para este usuario');
                    return false;
                }
                
                console.log('九 Sesi칩n PIN v치lida y con acceso a despacho');
                return true;
                
            } catch (error) {
                console.error('Error validando sesi칩n PIN:', error);
                return false;
            }
        }

        // Funci칩n para extraer informaci칩n del usuario
        function extractUserInfo(sessionData) {
            const usuario = sessionData.usuario;
            const sistemaDespacho = sessionData.sistemas.find(s => s.key === 'sistemaDespacho');
            
            return {
                authenticated: true,
                email: usuario.email,
                nombre: usuario.nombre,
                id: usuario.id,
                role: sistemaDespacho?.rol || 'colaborador',
                sistemaActivo: sistemaDespacho?.activo || false,
                datosUsuario: sistemaDespacho?.datosUsuario || null,
                timestamp: sessionData.timestamp,
                tipo: sessionData.tipo,
                // Incluir todos los datos necesarios para evitar crear userSession
                apellido: sistemaDespacho?.datosUsuario?.apellido || '',
                sistemasAcceso: sistemaDespacho?.datosUsuario?.sistemas_acceso || {}
            };
        }

        // Actualizar la interfaz de usuario con la informaci칩n del usuario
        function updateUserInterface() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement && AppState.currentUser) {
                userNameElement.textContent = AppState.currentUser.nombre || AppState.currentUser.email;
            }
            
            if (userRoleElement) {
                // Capitalizar el rol: "colaborador" -> "Colaborador"
                const role = AppState.currentUser.role;
                userRoleElement.textContent = role.charAt(0).toUpperCase() + role.slice(1);
            }
            
            if (userAvatarElement) {
                let avatarText = 'U';
                if (AppState.currentUser?.nombre) {
                    avatarText = AppState.currentUser.nombre.charAt(0).toUpperCase();
                } else if (AppState.currentUser?.email) {
                    avatarText = AppState.currentUser.email.charAt(0).toUpperCase();
                }
                userAvatarElement.textContent = avatarText;
            }
        }

        // Funci칩n para cerrar sesi칩n (si la necesitas en despacho)
        function logout() {
            // Limpiar las sesiones espec칤ficas de tu sistema
            localStorage.removeItem('sesion_pin_gm');
            localStorage.removeItem('gm_user_session');
            
            console.log('九 Sesi칩n PIN cerrada');
            showToast('Sesi칩n cerrada correctamente', 'success');
            
            // Redirigir al portal
            setTimeout(() => {
                window.location.href = window.location.origin + 'index.html';
            }, 1500);
        }

        // ===== CARGA DE LA APLICACI칍N =====
        async function loadApplication() {
            try {
                // Aplicar tema
                if (AppState.darkMode) {
                    document.body.classList.add('dark-mode');
                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Mostrar informaci칩n del usuario
                updateUserInterface();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Mostrar aplicaci칩n
                document.getElementById('app').style.display = 'block';
                
                // Ir directamente a Generar Tickets
                switchTab('generateTicket');
                
                showToast('Sistema de Despacho cargado correctamente', 'success');
                
            } catch (error) {
                console.error('仇 Error cargando aplicaci칩n:', error);
                showToast('Error al cargar la aplicaci칩n: ' + error.message, 'error');
            }
        }

        function setupEventListeners() {
            // ===== EVENT LISTENERS GLOBALES =====
            
            // 1. Toggle de tema oscuro/claro
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // 2. Bot칩n de pantalla completa
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }
            
            // 3. Men칰 de usuario
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', toggleUserDropdown);
            }
            
            // ===== NAVEGACI칍N POR PESTA칌AS =====
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    const validTabs = ['generateTicket'];
                    if (!validTabs.includes(tabId)) {
                        console.warn('Pesta침a no v치lida:', tabId);
                        showToast(`La pesta침a "${tabId}" no est치 disponible`, 'warning');
                        return;
                    }
                    
                    switchTab(tabId);
                });
            });
            
            // ===== BOT칍N FLOTANTE SCROLL TO TOP =====
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (scrollToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                
                scrollToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // ===== TOAST NOTIFICATIONS =====
            const toastClose = document.querySelector('.toast-close');
            if (toastClose) {
                toastClose.addEventListener('click', () => {
                    document.getElementById('toast').classList.remove('show');
                });
            }
            
            setTimeout(() => {
                const cameraBtn = document.querySelector('.camera-search-button');
                if (cameraBtn) {
                    console.log('九 Bot칩n de c치mara detectado en el DOM');
                } else {
                    console.warn('仇 Bot칩n de c치mara no encontrado');
                }
            }, 1000);

            // ===== EVENT LISTENERS ESPEC칈FICOS =====
            setupTicketExcelEventListeners();

            // Sistema de carga dual
            initializeDualUploadSystem();       

            // ===== EVENT LISTENERS GLOBALES DE SISTEMA =====
            
            // Cerrar men칰s al hacer click fuera
            document.addEventListener('click', (e) => {
                const userDropdown = document.getElementById('userDropdown');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userDropdown && userDropdown.classList.contains('active') && 
                    !userDropdown.contains(e.target) && 
                    !userAvatar.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
            
            setupKeyboardShortcuts();
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('游뛁 Usuario solicit칩 cerrar sesi칩n');
                    
                    // 九 Usar AuthChecker para cerrar sesi칩n GLOBALMENTE
                    AuthChecker.cerrarSesionGlobal();
                    
                    // Ocultar dropdown
                    document.getElementById('userDropdown').classList.remove('active');
                });
            }

            console.log('九 Event listeners configurados correctamente');
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Solo activar si estamos en la secci칩n de tickets
                if (!document.getElementById('generateTicketSection').classList.contains('active')) {
                    return;
                }
                
                // Ctrl+F o Cmd+F - Enfocar b칰squeda
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('ticketSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                // Ctrl+S o Cmd+S - Exportar a Excel
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (TicketExcelState.filteredProducts.length > 0) {
                        exportToExcel();
                    } else {
                        showToast('No hay productos para exportar', 'warning');
                    }
                }
                
                // Escape - Limpiar b칰squeda y filtros
                if (e.key === 'Escape') {
                    e.preventDefault();
                    clearAllFilters();
                }
            });
        }

        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            showToast(`Modo ${AppState.darkMode ? 'oscuro' : 'claro'} activado`, 'success');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error al activar pantalla completa:', err);
                    showToast('No se pudo activar el modo pantalla completa', 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const isActive = dropdown.classList.toggle('active');
            document.getElementById('userAvatar').setAttribute('aria-expanded', isActive);
        }

        function switchTab(tabId) {
            // Validar que sea una pesta침a existente
            const validTabs = ['generateTicket'];
            
            if (!validTabs.includes(tabId)) {
                console.warn('Pesta침a no v치lida:', tabId);
                showToast(`Pesta침a "${tabId}" no est치 disponible`, 'error');
                return;
            }
            
            AppState.currentTab = tabId;
            
            // Ocultar todas las secciones
            document.querySelectorAll('.generate-ticket-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Mostrar secci칩n activa
            const activeSection = document.getElementById(tabId + 'Section');
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
                
                // Acciones espec칤ficas por pesta침a
                if (tabId === 'generateTicket') {
                    initializeTicketExcelSection();
                }
            }
            
            // Actualizar pesta침as activas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.getAttribute('data-tab') === tabId;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
            });
            
            console.log(`九 Cambiando a pesta침a: ${tabId}`);
        }

        function initializeTicketExcelSection() {
            console.log('游댃 Inicializando secci칩n de tickets de despacho...');
            
            // Inicializar estado de filtros si no existe
            if (!TicketExcelState.filters) {
                TicketExcelState.filters = {
                    search: '',
                    quickFilter: 'all'
                };
            }
            
            // Resetear estado si es necesario
            if (TicketExcelState.currentStep === 'preview' && TicketExcelState.products.length === 0) {
                backToTicketUpload();
            }
        }

        // ===== FUNCIONES PARA TICKETS DESDE EXCEL =====
        function setupTicketExcelEventListeners() {
            console.log('游댢 Configurando event listeners para tickets Excel de despacho...');
            
            // 1. Upload Area para Tickets
            const ticketUploadArea = document.getElementById('ticketUploadArea');
            const ticketFileInput = document.getElementById('ticketFileInput');
            
            if (ticketUploadArea && ticketFileInput) {
                ticketUploadArea.addEventListener('click', () => {
                    ticketFileInput.click();
                });
                
                // Mejora: Drag & Drop para archivos
                ticketUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--success-color)';
                    ticketUploadArea.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
                });
                
                ticketUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                });
                
                ticketUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    ticketUploadArea.style.borderColor = 'var(--border-color)';
                    ticketUploadArea.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        processTicketFile(e.dataTransfer.files[0]);
                    }
                });
                
                ticketFileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        processTicketFile(e.target.files[0]);
                    }
                });
            }
            
            // 2. Bot칩n de volver a upload
            const backToUploadTicketBtn = document.getElementById('backToUploadTicketBtn');
            if (backToUploadTicketBtn) {
                backToUploadTicketBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            backToTicketUpload();
                        });
                    } else {
                        backToTicketUpload();
                    }
                });
            }
            
            // 3. Bot칩n de generar PDF masivo CON VALIDACI칍N
            const generateAllPdfBtn = document.getElementById('generateAllPdfBtn');
            if (generateAllPdfBtn) {
                generateAllPdfBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('游둳勇 Click en Generar PDF de Todos - Validando...');
                    
                    if (TicketExcelState.filteredProducts.length === 0) {
                        showToast('No hay productos para generar PDF', 'warning');
                        return;
                    }
                    
                    // 九 PRIMERO: Validar todos los campos antes de continuar
                    const validationResult = validateAllFieldsBeforePdf();
                    
                    if (!validationResult.allValid) {
                        showValidationErrorsModal(validationResult.invalidProducts);
                        return;
                    }
                    
                    // 九 SEGUNDO: Validar que haya productos v치lidos para PDF
                    const validProducts = TicketExcelState.filteredProducts.filter(product => 
                        validateProductForPdf(product).isValid
                    );
                    
                    if (validProducts.length === 0) {
                        showToast('No hay productos v치lidos para generar PDF', 'warning');
                        return;
                    }
                    
                    console.log(`游늵 Mostrando modal para ${validProducts.length} productos v치lidos`);
                    showPdfFormatModalForAll('excel');
                });
            }
            
            // 4. Paginaci칩n - MEJORADA PARA EVITAR M칔LTIPLES EVENTOS
            const ticketPrevPageBtn = document.getElementById('ticketPrevPageBtn');
            const ticketNextPageBtn = document.getElementById('ticketNextPageBtn');

            if (ticketPrevPageBtn) {
                // 九 REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketPrevPageBtn.replaceWith(ticketPrevPageBtn.cloneNode(true));
                const newPrevBtn = document.getElementById('ticketPrevPageBtn');
                
                newPrevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // 九 EVITA M칔LTIPLES EJECUCIONES
                    
                    console.log('拘勇 Bot칩n Anterior clickeado - P치gina actual:', TicketExcelState.pagination.currentPage);
                    
                    if (TicketExcelState.pagination.currentPage > 1) {
                        TicketExcelState.pagination.currentPage--;
                        console.log('游늯 Navegando a p치gina:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }

            if (ticketNextPageBtn) {
                // 九 REMOVER EVENT LISTENER EXISTENTE PRIMERO
                ticketNextPageBtn.replaceWith(ticketNextPageBtn.cloneNode(true));
                const newNextBtn = document.getElementById('ticketNextPageBtn');
                
                newNextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); // 九 EVITA M칔LTIPLES EJECUCIONES
                    
                    console.log('俱뫮잺 Bot칩n Siguiente clickeado - P치gina actual:', TicketExcelState.pagination.currentPage);
                    
                    const totalPages = TicketExcelState.pagination.totalPages;
                    
                    if (TicketExcelState.pagination.currentPage < totalPages) {
                        TicketExcelState.pagination.currentPage++;
                        console.log('游늯 Navegando a p치gina:', TicketExcelState.pagination.currentPage);
                        renderTicketProductsTable();
                    }
                });
            }
            
            // 5. Filtros y b칰squeda - CON SISTEMA DEPENDIENTE MEJORADO
            const ticketSearchInput = document.getElementById('ticketSearchInput');
            if (ticketSearchInput) {
                // Agregar placeholder mejorado CON TODOS LOS CAMPOS
                ticketSearchInput.placeholder = 'Buscar por c칩digo, descripci칩n, familia, acabado, material, borde, calidad, dimensi칩n, unidad de medida... (Ctrl+F)';
                
                ticketSearchInput.addEventListener('input', debounce(function(e) {
                    console.log('游댌 B칰squeda:', e.target.value);
                    applyTicketFilters();
                }, 300));
                
                // Limpiar b칰squeda con Escape
                ticketSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.target.value = '';
                        applyTicketFilters();
                        showToast('B칰squeda limpiada', 'info');
                    }
                });
            }
            
            // FILTROS DEPENDIENTES - CONFIGURACI칍N MEJORADA
            const ticketFilterFamilia = document.getElementById('ticketFilterFamilia');
            const ticketFilterAcabado = document.getElementById('ticketFilterAcabado');
            const ticketFilterMaterial = document.getElementById('ticketFilterMaterial');
            
            // Familia: Actualiza acabados, materiales y habilita/deshabilita
            if (ticketFilterFamilia) {
                ticketFilterFamilia.addEventListener('change', function(e) {
                    console.log(`游꿢 Filtro Familia cambiado:`, e.target.value);
                    updateDependentFilters(); // Actualizar filtros dependientes y disponibilidad
                    applyTicketFilters();
                });
            }

            // Acabado: Actualiza materiales y habilita/deshabilita material
            if (ticketFilterAcabado) {
                ticketFilterAcabado.addEventListener('change', function(e) {
                    console.log(`游꿢 Filtro Acabado cambiado:`, e.target.value);
                    updateDependentFilters(); // Actualizar filtros dependientes y disponibilidad
                    applyTicketFilters();
                });
            }

            // Material: Solo aplica filtros
            if (ticketFilterMaterial) {
                ticketFilterMaterial.addEventListener('change', function(e) {
                    console.log(`游꿢 Filtro Material cambiado:`, e.target.value);
                    applyTicketFilters();
                });
            }
            
            // 6. Descargar plantilla
            const downloadTicketTemplateBtn = document.getElementById('downloadTicketTemplateBtn');
            if (downloadTicketTemplateBtn) {
                // 九 REMOVER EVENT LISTENER EXISTENTE PRIMERO
                downloadTicketTemplateBtn.replaceWith(downloadTicketTemplateBtn.cloneNode(true));
                const newDownloadBtn = document.getElementById('downloadTicketTemplateBtn');
                
                newDownloadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation(); 
                    
                    console.log('游닌 Bot칩n de descarga clickeado - Iniciando descarga 칰nica...');
                    downloadTicketTemplate();
                });
            }

            // 7. Bot칩n limpiar filtros - MEJORADO CON SISTEMA DEPENDIENTE
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Verificar si hay cambios sin guardar antes de limpiar
                    if (hasUnsavedChanges()) {
                        showUnsavedChangesModal(() => {
                            clearAllFilters();
                        });
                    } else {
                        clearAllFilters();
                    }
                });
            }
            
            // 8. Configurar bot칩n de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        await supabase.auth.signOut();
                        showToast('Sesi칩n cerrada correctamente', 'success');
                        // Redirigir al portal de sistemas
                        setTimeout(() => {
                            window.location.href = '/index.html';
                        }, 1000);
                    } catch (error) {
                        console.error('Error cerrando sesi칩n:', error);
                        showToast('Error al cerrar sesi칩n', 'error');
                    }
                    
                    document.getElementById('userDropdown').classList.remove('active');
                });
            }
            
            // 9. Inicializar validaci칩n en tiempo real
            setupRealTimeValidation();

            // 10. Inicializar sistema de sugerencias de b칰squeda
            setupSearchSuggestions();

            // 11. Inicializar modal de eliminaci칩n
            setupDeleteModalEvents();            
            
            console.log('九 Event listeners para tickets Excel de despacho configurados correctamente');
        }

        // ===== FUNCI칍N DE B칔SQUEDA AVANZADA =====

        function advancedProductSearch(product, searchTerm) {
            if (!searchTerm) return true;
            
            const searchableFields = [
                'codigo',
                'descripcion', 
                'familia',
                'acabado',
                'material',
                'borde',
                'calidad',
                'dimension',
                'unidadMedida'
            ];
            
            // B칰squeda en todos los campos
            for (const field of searchableFields) {
                const fieldValue = product[field]?.toString().toLowerCase() || '';
                if (fieldValue.includes(searchTerm.toLowerCase())) {
                    return true;
                }
            }
            
            return false;
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function showLoadingOverlay(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            const toastConfig = {
                success: { icon: 'check-circle', color: 'toast' },
                error: { icon: 'exclamation-circle', color: 'toast-error' },
                warning: { icon: 'exclamation-triangle', color: 'toast-warning' },
                info: { icon: 'info-circle', color: 'toast-info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            toastIcon.className = `fas fa-${config.icon} toast-icon`;
            toast.classList.add(config.color);
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== FUNCIONES ESPEC칈FICAS PARA TICKETS EXCEL =====
        
        // Procesar datos de Excel
        function processExcelData(data) {
            try {
                // Obtener encabezados (primera fila)
                const headers = data[0].map(h => h ? h.toString().trim().toUpperCase() : '');
                
                // Validar encabezados requeridos SIN MODELO
                const requiredHeaders = ['C칍DIGO', 'DESCRIPCI칍N', 'FAMILIA', 'ACABADO', 'BORDE', 'CALIDAD', 'MATERIAL', 'DIMENSI칍N', 'UNIDAD_MEDIDA'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                
                if (missingHeaders.length > 0) {
                    showToast(`Faltan columnas requeridas: ${missingHeaders.join(', ')}`, 'error');
                    showLoadingOverlay(false);
                    return;
                }
                
                // Procesar filas de datos
                const products = [];
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.length === 0) continue;
                    
                    const product = {
                        id: i,
                        codigo: row[headers.indexOf('C칍DIGO')]?.toString().trim() || '',
                        descripcion: row[headers.indexOf('DESCRIPCI칍N')]?.toString().trim() || '',
                        familia: row[headers.indexOf('FAMILIA')]?.toString().trim() || '',
                        acabado: row[headers.indexOf('ACABADO')]?.toString().trim() || '',
                        borde: row[headers.indexOf('BORDE')]?.toString().trim() || '',
                        calidad: row[headers.indexOf('CALIDAD')]?.toString().trim() || '',
                        material: row[headers.indexOf('MATERIAL')]?.toString().trim() || '',
                        // CAMPO MODELO ELIMINADO
                        dimension: row[headers.indexOf('DIMENSI칍N')]?.toString().trim() || '',
                        unidadMedida: row[headers.indexOf('UNIDAD_MEDIDA')]?.toString().trim().toUpperCase() || '',
                        isValid: true,
                        validationErrors: []
                    };
                    
                    // Validar producto
                    const validation = validateProduct(product);
                    product.isValid = validation.isValid;
                    product.validationErrors = validation.errors;
                    
                    // Solo agregar productos que tengan c칩digo y descripci칩n
                    if (product.codigo || product.descripcion) {
                        products.push(product);
                    }
                }
                
                if (products.length === 0) {
                    showToast('No se encontraron productos v치lidos en el archivo', 'warning');
                    showLoadingOverlay(false);
                    return;
                }
                
                // Estad칤sticas del procesamiento
                const validProducts = products.filter(p => p.isValid).length;
                const invalidProducts = products.filter(p => !p.isValid).length;
                
                console.log(`游늵 Procesamiento completado:`, {
                    total: products.length,
                    v치lidos: validProducts,
                    inv치lidos: invalidProducts,
                    columnasProcesadas: headers
                });
                
                // Actualizar estado
                TicketExcelState.products = products;
                TicketExcelState.filteredProducts = [...products];
                TicketExcelState.fileData = data;
                TicketExcelState.currentStep = 'preview';
                
                // Actualizar interfaz
                showTicketPreviewStep();
                updateDespachoFilters();
                renderTicketProductsTable();
                
                // Mostrar resumen al usuario
                let message = `${products.length} productos cargados correctamente`;
                if (invalidProducts > 0) {
                    message += ` (${invalidProducts} con advertencias)`;
                }
                
                showToast(message, invalidProducts > 0 ? 'warning' : 'success');
                showLoadingOverlay(false);
                
            } catch (error) {
                console.error('Error procesando datos Excel:', error);
                showToast('Error al procesar los datos del archivo: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // Validar producto
        function validateProduct(product) {
            const errors = [];
            
            // Validar c칩digo
            if (!product.codigo || product.codigo.trim() === '') {
                errors.push('C칩digo es requerido');
            }
            
            // Validar descripci칩n
            const descValidation = FieldValidators.descripcion.validate(product.descripcion);
            if (!descValidation.isValid) {
                errors.push(descValidation.error);
            }
            
            // Validar unidad de medida
            const unidadValidation = FieldValidators.unidadMedida.validate(product.unidadMedida);
            if (!unidadValidation.isValid) {
                errors.push(unidadValidation.error);
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Mostrar paso de previsualizaci칩n
        function showTicketPreviewStep() {
            document.getElementById('ticketUploadStep').style.display = 'none';
            document.getElementById('ticketPreviewStep').style.display = 'block';
            
            // Actualizar contador
            document.getElementById('productsCount').textContent = 
                `${TicketExcelState.products.length} productos cargados`;
        }

        // Volver a upload
        function backToTicketUpload() {
            TicketExcelState.currentStep = 'upload';
            TicketExcelState.products = [];
            TicketExcelState.filteredProducts = [];
            TicketExcelState.fileData = null;
            
            document.getElementById('ticketPreviewStep').style.display = 'none';
            document.getElementById('ticketUploadStep').style.display = 'block';
            
            // Limpiar inputs
            document.getElementById('ticketFileInput').value = '';
            document.getElementById('ticketSearchInput').value = '';
            
            showToast('Archivo descartado', 'info');
        }

        // Renderizar tabla de productos
        function renderTicketProductsTable() {
            const container = document.getElementById('ticketProductsCardsContainer');
            if (!container) return;
            
            // Calcular paginaci칩n
            const startIndex = (TicketExcelState.pagination.currentPage - 1) * TicketExcelState.pagination.itemsPerPage;
            const endIndex = startIndex + TicketExcelState.pagination.itemsPerPage;
            const currentProducts = TicketExcelState.filteredProducts.slice(startIndex, endIndex);
            
            TicketExcelState.pagination.totalItems = TicketExcelState.filteredProducts.length;
            TicketExcelState.pagination.totalPages = Math.ceil(
                TicketExcelState.filteredProducts.length / TicketExcelState.pagination.itemsPerPage
            );
            
            // Generar HTML de las cards
            let html = '';
            
            if (currentProducts.length === 0) {
                html = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No se encontraron productos</h3>
                        <p>Intenta ajustar los filtros o la b칰squeda</p>
                    </div>
                `;
            } else {
                currentProducts.forEach((product, index) => {
                    const globalIndex = startIndex + index + 1;
                    
                    html += `
                        <div class="product-card ${!product.isValid ? 'invalid-product' : ''}" data-product-id="${product.id}">
                            <div class="product-card-header">
                                <div class="product-code-badge">${product.codigo}</div>
                                <div class="product-row-number">#${globalIndex}</div>
                            </div>
                            
                            <div class="product-description">
                                <textarea class="editable-field ${!product.isValid ? 'invalid' : ''}" 
                                    data-field="descripcion" 
                                    data-product-id="${product.id}"
                                    placeholder="Descripci칩n del producto">${product.descripcion}</textarea>
                            </div>
                            
                            <div class="product-details-grid">                               
                                <div class="detail-group">
                                    <span class="detail-label">Familia</span>
                                    <div class="detail-value">
                                        <input type="text" class="editable-field"
                                            data-field="familia"
                                            data-product-id="${product.id}"
                                            value="${product.familia}"
                                            placeholder="Familia">
                                    </div>
                                </div>
                                <div class="detail-group-extended">
                                    <span class="detail-label-extended">Borde</span>
                                    <div class="detail-value-extended">
                                        <input type="text" class="editable-field"
                                            data-field="borde"
                                            data-product-id="${product.id}"
                                            value="${product.borde}"
                                            placeholder="Borde">
                                    </div>
                                </div>
                            </div>

                            <div class="product-details-grid-extended">
                                <div class="detail-group-extended">
                                    <span class="detail-label-extended">Acabado</span>
                                    <div class="detail-value-extended">
                                        <input type="text" class="editable-field"
                                            data-field="acabado"
                                            data-product-id="${product.id}"
                                            value="${product.acabado}"
                                            placeholder="Acabado">
                                    </div>
                                </div>
                                <div class="detail-group-extended">
                                    <span class="detail-label-extended">Calidad</span>
                                    <div class="detail-value-extended">
                                        <input type="text" class="editable-field"
                                            data-field="calidad"
                                            data-product-id="${product.id}"
                                            value="${product.calidad}"
                                            placeholder="Calidad">
                                    </div>
                                </div>                                 
                                                               
                                <div class="detail-group-extended">
                                    <span class="detail-label-extended">Material</span>
                                    <div class="detail-value-extended">
                                        <input type="text" class="editable-field"
                                            data-field="material"
                                            data-product-id="${product.id}"
                                            value="${product.material}"
                                            placeholder="Material">
                                    </div>
                                </div>
                                <div class="detail-group">
                                    <span class="detail-label">Unidad</span>
                                    <div class="detail-value">
                                        <input type="text" class="editable-field"
                                            data-field="unidadMedida"
                                            data-product-id="${product.id}"
                                            value="${product.unidadMedida}"
                                            placeholder="UNIDAD">
                                    </div>
                                </div>
                                
                                
                                <div class="detail-group-extended">
                                    <span class="detail-label-extended">Dimensi칩n</span>
                                    <div class="detail-value-extended">
                                        <input type="text" class="editable-field"
                                            data-field="dimension"
                                            data-product-id="${product.id}"
                                            value="${product.dimension}"
                                            placeholder="Dimensi칩n">
                                    </div>
                                </div>
                            </div>
                            
                            ${product.validationErrors && product.validationErrors.length > 0 ? `
                            <div class="validation-errors">
                                <small style="color: var(--danger-color);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    ${product.validationErrors.join(', ')}
                                </small>
                            </div>
                            ` : ''}
                            
                            <div class="product-card-actions">
                                <button class="card-action-btn btn-pdf" onclick="generateSinglePdf(${product.id})">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="card-action-btn btn-delete" onclick="showDeleteConfirmationModal(${product.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Actualizar paginaci칩n
            updatePaginationUI();
            
            // Configurar event listeners para campos editables
            setupEditableFields();
            
            // Mostrar estad칤sticas en consola
            console.log('游늶 Tabla renderizada:', {
                productosTotales: TicketExcelState.filteredProducts.length,
                productosEnPagina: currentProducts.length,
                paginaActual: TicketExcelState.pagination.currentPage,
                totalPaginas: TicketExcelState.pagination.totalPages
            });
        }

        // Actualizar UI de paginaci칩n
        function updatePaginationUI() {
            const prevBtn = document.getElementById('ticketPrevPageBtn');
            const nextBtn = document.getElementById('ticketNextPageBtn');
            const info = document.getElementById('ticketPaginationInfo');
            
            if (!prevBtn || !nextBtn || !info) return;
            
            const { currentPage, totalPages, totalItems } = TicketExcelState.pagination;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            info.textContent = `P치gina ${currentPage} de ${totalPages} (${totalItems} productos)`;
        }

        // Configurar campos editables
        function setupEditableFields() {
            document.querySelectorAll('.editable-field').forEach(field => {
                field.addEventListener('blur', function(e) {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    const fieldName = this.getAttribute('data-field');
                    const newValue = this.value.trim();
                    
                    updateProductField(productId, fieldName, newValue);
                });
                
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        // Actualizar campo de producto
        function updateProductField(productId, fieldName, newValue) {
            const product = TicketExcelState.products.find(p => p.id === productId);
            if (!product) return;
            
            const oldValue = product[fieldName];
            
            if (oldValue === newValue) return;
            
            // Validar el nuevo valor
            let validation;
            if (FieldValidators[fieldName]) {
                validation = FieldValidators[fieldName].validate(newValue);
                
                if (!validation.isValid) {
                    showToast(`Error en ${fieldName}: ${validation.error}`, 'error');
                    
                    // Revertir valor si es inv치lido
                    const field = document.querySelector(`[data-product-id="${productId}"][data-field="${fieldName}"]`);
                    if (field) {
                        field.value = oldValue;
                    }
                    return;
                }
                
                // Aplicar formato si es v치lido
                newValue = FieldValidators[fieldName].format(newValue);
            }
            
            // Actualizar producto
            product[fieldName] = newValue;
            
            // Revalidar producto completo
            const productValidation = validateProduct(product);
            product.isValid = productValidation.isValid;
            product.validationErrors = productValidation.errors;
            
            // Actualizar filtros si es necesario
            if (['familia', 'acabado', 'material', 'calidad'].includes(fieldName)) {
                updateDespachoFilters();
            }
            
            // Re-renderizar la tabla para mostrar cambios de validaci칩n
            renderTicketProductsTable();
            
            showToast(`Campo ${fieldName} actualizado`, 'success');
        }

        // Aplicar filtros
        function applyTicketFilters() {
            const searchTerm = document.getElementById('ticketSearchInput').value.toLowerCase();
            const familiaFilter = document.getElementById('ticketFilterFamilia').value;
            const acabadoFilter = document.getElementById('ticketFilterAcabado').value;
            const materialFilter = document.getElementById('ticketFilterMaterial').value;
            
            // Actualizar estado de filtros
            TicketExcelState.filters.search = searchTerm;
            TicketExcelState.filters.familia = familiaFilter;
            TicketExcelState.filters.acabado = acabadoFilter;
            TicketExcelState.filters.material = materialFilter;
            
            // Filtrar productos
            let filtered = TicketExcelState.products.filter(product => {
                // Filtro de b칰squeda - EXPANDIDO CON TODOS LOS CAMPOS
                if (searchTerm) {
                    if (!advancedProductSearch(product, searchTerm)) {
                        return false;
                    }
                }
                
                // Filtros de despacho (dependientes)
                if (familiaFilter && product.familia !== familiaFilter) {
                    return false;
                }
                
                if (acabadoFilter && product.acabado !== acabadoFilter) {
                    return false;
                }
                
                if (materialFilter && product.material !== materialFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Actualizar estado con productos filtrados
            TicketExcelState.filteredProducts = filtered;
            TicketExcelState.pagination.currentPage = 1; // Resetear a primera p치gina
            
            // Renderizar tabla actualizada
            renderTicketProductsTable();
            
            // Mostrar estad칤sticas de filtrado
            const totalProducts = TicketExcelState.products.length;
            const filteredCount = filtered.length;
            
            console.log('游댌 Filtros aplicados:', {
                t칠rminoB칰squeda: searchTerm,
                familia: familiaFilter,
                acabado: acabadoFilter,
                material: materialFilter,
                productosTotales: totalProducts,
                productosFiltrados: filteredCount,
                porcentajeFiltrado: totalProducts > 0 ? Math.round((filteredCount / totalProducts) * 100) : 0
            });
            
            // Mostrar feedback al usuario si hay filtros activos
            if (searchTerm || familiaFilter || acabadoFilter || materialFilter) {
                const activeFilters = [];
                if (searchTerm) activeFilters.push(`b칰squeda: "${searchTerm}"`);
                if (familiaFilter) activeFilters.push(`familia: ${familiaFilter}`);
                if (acabadoFilter) activeFilters.push(`acabado: ${acabadoFilter}`);
                if (materialFilter) activeFilters.push(`material: ${materialFilter}`);
                
                // Actualizar contador en la interfaz si existe
                const productsCountElement = document.getElementById('productsCount');
                if (productsCountElement) {
                    productsCountElement.textContent = 
                        `${filteredCount} de ${totalProducts} productos ${activeFilters.length > 0 ? `(${activeFilters.join(', ')})` : ''}`;
                }
                
                // Mostrar toast si el filtrado resulta en pocos productos
                if (filteredCount === 0 && totalProducts > 0) {
                    showToast('No se encontraron productos con los filtros aplicados', 'warning');
                } else if (filteredCount < totalProducts && filteredCount > 0) {
                    showToast(`${filteredCount} productos encontrados con los filtros aplicados`, 'info');
                }
            } else {
                // Sin filtros activos
                const productsCountElement = document.getElementById('productsCount');
                if (productsCountElement) {
                    productsCountElement.textContent = `${totalProducts} productos cargados`;
                }
            }
        }

        // ===== SISTEMA DE SUGERENCIAS DE B칔SQUEDA =====

        function setupSearchSuggestions() {
            const searchInput = document.getElementById('ticketSearchInput');
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'search-suggestions';
            suggestionsContainer.style.display = 'none';
            
            // Insertar despu칠s del input de b칰squeda
            searchInput.parentNode.appendChild(suggestionsContainer);
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (searchTerm.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // Generar sugerencias basadas en todos los campos
                const suggestions = generateSearchSuggestions(searchTerm);
                
                if (suggestions.length > 0) {
                    showSearchSuggestions(suggestions, suggestionsContainer);
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // Ocultar sugerencias al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function generateSearchSuggestions(searchTerm) {
            const suggestions = new Set();
            
            TicketExcelState.products.forEach(product => {
                // Buscar en todos los campos
                const fields = [
                    { value: product.codigo, type: 'C칩digo' },
                    { value: product.descripcion, type: 'Descripci칩n' },
                    { value: product.familia, type: 'Familia' },
                    { value: product.acabado, type: 'Acabado' },
                    { value: product.material, type: 'Material' },
                    { value: product.borde, type: 'Borde' },
                    { value: product.calidad, type: 'Calidad' },
                    { value: product.dimension, type: 'Dimensi칩n' },
                    { value: product.unidadMedida, type: 'Unidad' }
                ];
                
                fields.forEach(field => {
                    if (field.value && field.value.toLowerCase().includes(searchTerm)) {
                        suggestions.add(`${field.value} (${field.type})`);
                    }
                });
            });
            
            return Array.from(suggestions).slice(0, 8); // M치ximo 8 sugerencias
        }

        function showSearchSuggestions(suggestions, container) {
            container.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', function() {
                    document.getElementById('ticketSearchInput').value = 
                        suggestion.split(' (')[0]; // Tomar solo el valor sin el tipo
                    container.style.display = 'none';
                    applyTicketFilters();
                });
                container.appendChild(div);
            });
            
            container.style.display = 'block';
        }

        // Actualizar filtros de despacho
        function updateDespachoFilters() {
            const familias = new Set();
            
            // Recopilar familias disponibles
            TicketExcelState.products.forEach(product => {
                if (product.familia) familias.add(product.familia);
            });
            
            // Actualizar filtro de familias
            const familiaSelect = document.getElementById('ticketFilterFamilia');
            if (familiaSelect) {
                const currentValue = familiaSelect.value;
                familiaSelect.innerHTML = '<option value="">Todas las familias</option>';
                
                Array.from(familias).sort().forEach(familia => {
                    const option = document.createElement('option');
                    option.value = familia;
                    option.textContent = familia;
                    familiaSelect.appendChild(option);
                });
                
                // Restaurar valor si existe
                if (currentValue && familias.has(currentValue)) {
                    familiaSelect.value = currentValue;
                }
                
                // Actualizar contador
                document.getElementById('familiaCount').textContent = familias.size;
            }
            
            // Actualizar filtros dependientes
            updateDependentFilters();
            
            // NUEVO: Asegurar que los filtros tengan el estado inicial correcto
            updateFiltersAvailability();
        }

        // Limpiar todos los filtros
        function clearAllFilters() {
            document.getElementById('ticketSearchInput').value = '';
            document.getElementById('ticketFilterFamilia').value = '';
            document.getElementById('ticketFilterAcabado').value = '';
            document.getElementById('ticketFilterMaterial').value = '';
            
            // Actualizar filtros dependientes despu칠s de limpiar
            updateDependentFilters();
            
            // NUEVO: Forzar actualizaci칩n de disponibilidad
            updateFiltersAvailability();
            
            applyTicketFilters();
            showToast('Filtros limpiados', 'info');
        }

        // ===== FUNCI칍N PARA DESCARGAR PLANTILLA =====
        function downloadTicketTemplate() {
            console.log('游닌 Iniciando descarga de plantilla...');
            
            // 九 PREVENIR M칔LTIPLES EJECUCIONES
            if (window.downloadInProgress) {
                console.log('游띔 Descarga ya en progreso, ignorando...');
                return;
            }
            
            window.downloadInProgress = true;
            
            try {
                // Crear datos de ejemplo SIN CAMPO MODELO
                const sampleData = [
                    ['C칍DIGO', 'DESCRIPCI칍N', 'FAMILIA', 'ACABADO', 'BORDE', 'CALIDAD', 'MATERIAL', 'DIMENSI칍N', 'UNIDAD_MEDIDA'],
                    ['BHFB1PPCA9A81', 'BALDOSAS HONED FILLED BISELADO CREMA MIX', 'BALDOSAS', 'HONED FILLED', 'BISELADO', 'PRIMERA', 'CREMA MIX', '60.96CMS x 30.48CMS x 1CMS', 'M2']
                ];
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                
                // Establecer anchos de columnas para mejor visualizaci칩n
                const colWidths = [
                    { wch: 15 }, // C칍DIGO
                    { wch: 40 }, // DESCRIPCI칍N
                    { wch: 15 }, // FAMILIA
                    { wch: 12 }, // ACABADO
                    { wch: 12 }, // BORDE
                    { wch: 12 }, // CALIDAD
                    { wch: 15 }, // MATERIAL
                    { wch: 12 }, // DIMENSI칍N
                    { wch: 12 }  // UNIDAD_MEDIDA
                ];
                ws['!cols'] = colWidths;
                
                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Plantilla Despacho');
                
                // 九 GENERAR NOMBRE DE ARCHIVO 칔NICO
                const timestamp = new Date().getTime();
                const fileName = `plantilla_despacho_gallos_marmol_${timestamp}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, fileName);
                
                showToast('Plantilla descargada correctamente', 'success');
                
                // Registrar en consola para debugging
                console.log('游닌 Plantilla descargada con columnas:', sampleData[0]);
                
            } catch (error) {
                console.error('Error descargando plantilla:', error);
                showToast('Error al descargar la plantilla: ' + error.message, 'error');
            } finally {
                // 九 LIMPIAR FLAG DESPU칄S DE UN TIEMPO
                setTimeout(() => {
                    window.downloadInProgress = false;
                    console.log('九 Flag de descarga liberado');
                }, 2000);
            }
        }

        // ===== FUNCIONES DE VALIDACI칍N MEJORADAS =====
        
        function setupRealTimeValidation() {
            // Esta funci칩n se puede expandir para validaci칩n en tiempo real
            console.log('九 Sistema de validaci칩n en tiempo real configurado');
        }

        function hasUnsavedChanges() {
            // Implementar l칩gica para detectar cambios sin guardar
            return false; // Por ahora retorna false
        }

        function showUnsavedChangesModal(callback) {
            // Implementar modal de cambios sin guardar
            if (confirm('Tienes cambios sin guardar. 쮼st치s seguro de que quieres continuar?')) {
                callback();
            }
        }

        // Reemplazar la funci칩n showValidationErrorsModal existente
        function showValidationErrorsModal(invalidProducts, isForPdf = true) {
            console.log('游뚿 Mostrando modal de errores de validaci칩n:', invalidProducts);
            
            // 九 CERRAR MODALES EXISTENTES PRIMERO
            const existingModal = document.getElementById('validationErrorsModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHtml = `
                <div class="modal" id="validationErrorsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3 style="margin: 0; color: var(--danger-color);">
                                <i class="fas fa-exclamation-triangle"></i> 
                                ${isForPdf ? 'Errores de Validaci칩n - PDF' : 'Productos con Errores'}
                            </h3>
                            <button class="close-modal" id="closeValidationModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="warning-message">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>Se encontraron ${invalidProducts.length} productos con errores</strong>
                                    <p>${isForPdf ? 'Corrige los siguientes errores antes de generar el PDF:' : 'Revisa los siguientes productos:'}</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; max-height: 400px; overflow-y: auto;">
                                <div class="products-list">
                                    ${invalidProducts.map(product => `
                                        <div class="product-card" style="border-left: 4px solid var(--danger-color);">
                                            <div class="product-header">
                                                <div class="product-info">
                                                    <h4 style="margin: 0; color: var(--danger-color);">
                                                        ${product.codigo} 
                                                        <small style="color: var(--text-muted);">(Fila ${product.rowNumber})</small>
                                                    </h4>
                                                    <p style="margin: 0.25rem 0; color: var(--text-color); font-size: 0.9rem;">
                                                        ${product.descripcion}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            ${product.errors.length > 0 ? `
                                                <div style="margin: 1rem 0;">
                                                    <strong style="color: var(--danger-color); font-size: 0.9rem;">
                                                        <i class="fas fa-times-circle"></i> Errores:
                                                    </strong>
                                                    <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--danger-color); font-size: 0.85rem;">
                                                        ${product.errors.map(error => `<li>${error}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light-color); border-radius: var(--border-radius);">
                                <strong>Sugerencias:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                    <li>Revisa los campos marcados en <span style="color: var(--danger-color);">rojo</span> en la lista</li>
                                    <li>El c칩digo es obligatorio</li>
                                    <li>La descripci칩n debe tener entre 3 y 200 caracteres</li>
                                    <li>La unidad de medida puede ser cualquier texto (m치x. 10 caracteres)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelValidationBtn">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                            ${isForPdf ? `
                                <button class="btn btn-primary" id="goToFirstErrorBtn">
                                    <i class="fas fa-arrow-right"></i> Ir al Primer Error
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // 九 INSERTAR MODAL EN EL DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 九 CONFIGURAR EVENT LISTENERS
            setupValidationModalEvents(invalidProducts, isForPdf);
        }

        function setupValidationModalEvents(invalidProducts, isForPdf) {
            const modal = document.getElementById('validationErrorsModal');
            
            // Cerrar modal
            document.getElementById('closeValidationModal').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('cancelValidationBtn').addEventListener('click', () => {
                modal.remove();
            });
            
            // Ir al primer error
            if (isForPdf) {
                document.getElementById('goToFirstErrorBtn').addEventListener('click', () => {
                    const firstInvalid = invalidProducts[0];
                    if (firstInvalid) {
                        // Encontrar y enfocar el primer producto con error
                        const productElement = document.querySelector(`[data-product-id="${firstInvalid.id}"]`);
                        if (productElement) {
                            productElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            productElement.style.animation = 'pulse 2s infinite';
                            setTimeout(() => {
                                productElement.style.animation = '';
                            }, 2000);
                        }
                        modal.remove();
                    }
                });
            }
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Cerrar con ESC
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Reemplazar la funci칩n showPdfFormatModalForAll existente
        function showPdfFormatModalForAll(source) {
            console.log('游 Abriendo modal PDF masivo - Dise침o adaptable');
            
            // 九 Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalAll').forEach(modal => modal.remove());

            // 九 CREAR MODAL CON DISE칌O SENCILLO Y ADAPTABLE
            const modalHtml = `
                <div id="pdfFormatModalAll" class="simple-pdf-modal">
                    <div class="modal-overlay" onclick="window.closeSimpleModal()"></div>
                    <div class="modal-container simple-modal">
                        <!-- Header -->
                        <div class="modal-header simple-header">
                            <div class="header-title">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <h3>Generar PDF</h3>
                                    <p>${TicketExcelState.filteredProducts.length} productos seleccionados</p>
                                </div>
                            </div>
                            <button class="close-btn" onclick="window.closeSimpleModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body simple-body">
                            <div class="format-options">
                                <div class="format-option active" data-format="ticket-small-horizontal" onclick="window.selectSimpleFormat('ticket-small-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-tag"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Peque침o</h4>
                                        <p>7.5칑5cm  Ideal para la mayor칤a de productos</p>
                                        <div class="format-meta">Recomendado</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="ticket-medium-horizontal" onclick="window.selectSimpleFormat('ticket-medium-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-expand-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Mediano</h4>
                                        <p>10칑5cm  M치s espacio para descripciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="compact-summary" onclick="window.selectSimpleFormat('compact-summary', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-list-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Resumen Compacto</h4>
                                        <p>Formato A4  M칰ltiples productos por p치gina</p>
                                        <div class="format-meta inventory">Inventario</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="summary-section">
                                <div class="summary-item">
                                    <span class="summary-label">Total de productos:</span>
                                    <span class="summary-value">${TicketExcelState.filteredProducts.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value format-selected" id="simpleFormatDisplay">Ticket Peque침o</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer simple-footer">
                            <button class="btn btn-cancel" onclick="window.closeSimpleModal()">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn btn-generate" onclick="window.generateSimplePdf('${source}')">
                                <i class="fas fa-file-pdf"></i>
                                Generar PDF
                                <span class="badge">${TicketExcelState.filteredProducts.length}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 九 INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 九 INICIALIZAR FUNCIONES GLOBALES
            window.simpleSelectedFormat = 'ticket-small-horizontal';

            window.closeSimpleModal = function() {
                const modal = document.getElementById('pdfFormatModalAll');
                if (modal) {
                    modal.classList.add('closing');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            window.selectSimpleFormat = function(format, element) {
                window.simpleSelectedFormat = format;
                
                // Remover activo de todos
                document.querySelectorAll('.format-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelector('.check-circle').classList.remove('active');
                });
                
                // Activar seleccionado
                element.classList.add('active');
                element.querySelector('.check-circle').classList.add('active');
                
                // Actualizar texto
                const formatNames = {
                    'ticket-small-horizontal': 'Ticket Peque침o',
                    'ticket-medium-horizontal': 'Ticket Mediano', 
                    'compact-summary': 'Resumen Compacto'
                };
                
                document.getElementById('simpleFormatDisplay').textContent = formatNames[format];
            };

            window.generateSimplePdf = function(source) {
                if (!window.simpleSelectedFormat) {
                    showToast('Selecciona un formato primero', 'warning');
                    return;
                }
                window.closeSimpleModal();
                setTimeout(() => generatePdfForAllProducts(window.simpleSelectedFormat, source), 100);
            };

            console.log('九 Modal simple inicializado');
        }

        // Reemplazar la funci칩n generateSinglePdf existente
        function generateSinglePdf(productId) {
            const product = TicketExcelState.products.find(p => p.id === productId);
            if (!product) {
                showToast('Producto no encontrado', 'error');
                return;
            }
            
            // Validar producto antes de mostrar modal
            const validation = validateProductForPdf(product);
            if (!validation.isValid) {
                showValidationErrorsModal([{
                    ...product,
                    rowNumber: 1,
                    errors: validation.errors
                }], true);
                return;
            }
            
            showPdfFormatModalForExcel(product);
        }

        function showPdfFormatModalForExcel(product) {
            console.log('游늯 Abriendo modal PDF individual - Estilo unificado');
            
            // 九 Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalIndividual').forEach(modal => modal.remove());

            // 九 CREAR MODAL INDIVIDUAL CON MISMO ESTILO
            const modalHtml = `
                <div id="pdfFormatModalIndividual" class="simple-pdf-modal">
                    <div class="modal-overlay" onclick="window.closeSimpleModalIndividual()"></div>
                    <div class="modal-container simple-modal">
                        <!-- Header -->
                        <div class="modal-header simple-header">
                            <div class="header-title">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <h3>Generar PDF</h3>
                                    <p>Producto: ${product.codigo}</p>
                                </div>
                            </div>
                            <button class="close-btn" onclick="window.closeSimpleModalIndividual()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body simple-body">
                            <!-- Informaci칩n del Producto -->
                            <div class="product-info-card">
                                <div class="product-header">
                                    <h4>${product.codigo}</h4>
                                    <span class="product-badge">Individual</span>
                                </div>
                                <div class="product-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Descripci칩n:</span>
                                        <span class="detail-value">${product.descripcion}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Familia:</span>
                                        <span class="detail-value">${product.familia}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Material:</span>
                                        <span class="detail-value">${product.material}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Unidad:</span>
                                        <span class="detail-value unit">${product.unidadMedida}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de Formato -->
                            <div class="format-options">
                                <div class="format-option active" data-format="ticket-small-horizontal" onclick="window.selectSimpleFormatIndividual('ticket-small-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-tag"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Peque침o</h4>
                                        <p>7.5칑5cm  Ideal para la mayor칤a de productos</p>
                                        <div class="format-meta">Recomendado</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="ticket-medium-horizontal" onclick="window.selectSimpleFormatIndividual('ticket-medium-horizontal', this)">
                                    <div class="format-icon">
                                        <i class="fas fa-expand-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Ticket Mediano</h4>
                                        <p>10칑5cm  M치s espacio para descripciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="summary-section">
                                <div class="summary-item">
                                    <span class="summary-label">Producto:</span>
                                    <span class="summary-value">${product.codigo}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value format-selected" id="simpleFormatDisplayIndividual">Ticket Peque침o</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer simple-footer">
                            <button class="btn btn-cancel" onclick="window.closeSimpleModalIndividual()">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn btn-generate" onclick="window.generateSimplePdfIndividual('${product.id}')">
                                <i class="fas fa-file-pdf"></i>
                                Generar PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 九 INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 九 GUARDAR PRODUCTO PARA USO POSTERIOR
            window.currentProductIndividual = product;

            // 九 INICIALIZAR FUNCIONES GLOBALES
            window.simpleSelectedFormatIndividual = 'ticket-small-horizontal';

            window.closeSimpleModalIndividual = function() {
                const modal = document.getElementById('pdfFormatModalIndividual');
                if (modal) {
                    modal.classList.add('closing');
                    setTimeout(() => {
                        modal.remove();
                        delete window.currentProductIndividual;
                        delete window.simpleSelectedFormatIndividual;
                        delete window.closeSimpleModalIndividual;
                        delete window.selectSimpleFormatIndividual;
                        delete window.generateSimplePdfIndividual;
                    }, 300);
                }
            };

            window.selectSimpleFormatIndividual = function(format, element) {
                window.simpleSelectedFormatIndividual = format;
                
                // Remover activo de todos
                document.querySelectorAll('#pdfFormatModalIndividual .format-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelector('.check-circle').classList.remove('active');
                });
                
                // Activar seleccionado
                element.classList.add('active');
                element.querySelector('.check-circle').classList.add('active');
                
                // Actualizar texto
                const formatNames = {
                    'ticket-small-horizontal': 'Ticket Peque침o',
                    'ticket-medium-horizontal': 'Ticket Mediano'
                };
                
                const displayElement = document.getElementById('simpleFormatDisplayIndividual');
                if (displayElement) {
                    displayElement.textContent = formatNames[format] || format;
                }
            };

            window.generateSimplePdfIndividual = function(productId) {
                const format = window.simpleSelectedFormatIndividual;
                const product = window.currentProductIndividual;
                
                console.log('游 Generando PDF individual:', {
                    product: product?.codigo,
                    format: format
                });
                
                if (!format || !product) {
                    showToast('Error al generar el PDF', 'error');
                    return;
                }

                window.closeSimpleModalIndividual();
                
                // Peque침o delay antes de generar
                setTimeout(() => {
                    generateSinglePdfFormat(product, format);
                }, 100);
            };

            console.log('九 Modal individual unificado inicializado');
        }

        // ===== FUNCIONES DE GENERACI칍N DE PDF =====

        function generatePdfForAllProducts(format, source) {
            switch (format) {
                case 'ticket-small-horizontal':
                    generateAllSmallHorizontalTicketsFromExcel();
                    break;
                case 'ticket-medium-horizontal':
                    generateAllMediumHorizontalTicketsFromExcel();
                    break;
                case 'compact-summary':
                    generateCompactSummaryPdfFromExcel();
                    break;
                default:
                    showToast('Formato de PDF no v치lido', 'error');
            }
        }

        function generateSinglePdfFormat(product, format) {
            switch (format) {
                case 'ticket-small-horizontal':
                    generateSmallHorizontalTicket(product);
                    break;
                case 'ticket-medium-horizontal':
                    generateMediumHorizontalTicket(product);
                    break;
                default:
                    showToast('Formato de PDF no v치lido', 'error');
            }
        }

        // ===== 1. FUNCI칍N PARA GENERAR TODOS LOS TICKETS PEQUE칌OS =====
        async function generateAllSmallHorizontalTicketsFromExcel() {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librer칤a PDF no disponible', 'error');
                return;
            }

            try {
                const validProducts = TicketExcelState.filteredProducts.filter(product => 
                    validateProductForPdf(product).isValid
                );

                if (validProducts.length === 0) {
                    showToast('No hay productos v치lidos para generar tickets', 'warning');
                    return;
                }

                // 九 MOSTRAR PROGRESO
                pdfProgress.show(validProducts.length, 'ticket-small-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento PDF...');

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Obtener nombre y apellido del usuario
                const userName = AppState.currentUser?.nombre || AppState.currentUser?.datosUsuario?.nombre || 'Usuario';
                const userApellido = AppState.currentUser?.apellido || AppState.currentUser?.datosUsuario?.apellido || '';
                const userDisplayName = userApellido ? `${userName} ${userApellido}` : userName;

                for (let index = 0; index < validProducts.length; index++) {
                    // 九 VERIFICAR SI SE CANCEL칍
                    if (pdfProgress.isCancelled) {
                        console.log('Generaci칩n cancelada por el usuario');
                        return;
                    }

                    const product = validProducts[index];
                    
                    if (index > 0) {
                        pdf.addPage([7.5, 5], 'landscape');
                    }

                    // 九 ACTUALIZAR PROGRESO
                    const progress = ((index + 1) / validProducts.length) * 100;
                    pdfProgress.updateProgress(progress, index + 1, validProducts.length);
                    pdfProgress.updateStatus(`Generando ticket para: ${product.codigo}`);

                    // ===== DIMENSIONES =====
                    const pageWidth = 7.5;
                    const pageHeight = 5;
                    const margin = 0.4;
                    let currentY = 0.5;

                    // ===== FONDO =====
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                    // ===== C칍DIGO DEL PRODUCTO (PRINCIPAL) =====
                    currentY += 0.1;
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.1;

                    // L칤nea separadora
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.05);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 0.4;

                    // ===== DESCRIPCI칍N =====
                    pdf.setFontSize(7);
                    pdf.setTextColor(40, 40, 40);
                    pdf.setFont('helvetica', 'normal');
                    
                    const descripcion = product.descripcion || 'Sin descripci칩n';
                    const maxWidth = pageWidth - (margin * 2);
                    const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                    
                    // Fondo para descripci칩n
                    pdf.setFillColor(255, 255, 255);
                    const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                    pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                    
                    pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.6;

                    // ===== INFORMACI칍N ADICIONAL =====
                    const details = [
                        { 
                            label: 'CALIDAD', 
                            value: product.calidad || 'N/A'
                        },
                        { 
                            label: 'DIMENSI칍N', 
                            value: product.dimension || 'N/A'
                        },
                        { 
                            label: 'UNIDAD', 
                            value: product.unidadMedida || 'N/A'
                        }
                    ];

                    details.forEach((detail, detailIndex) => {
                        if (currentY < pageHeight - 1.2) {
                            const boxWidth = (pageWidth - (margin * 2) - 0.4) / 3;
                            const boxX = margin + (detailIndex * (boxWidth + 0.2));
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                            
                            // Etiqueta
                            pdf.setFontSize(6);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(80, 80, 80);
                            pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                            
                            // Valor
                            pdf.setFontSize(7);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                        }
                    });

                    currentY += 0.7;

                    // ===== C칍DIGO QR =====
                    pdfProgress.updateStep(3, 'active');
                    pdfProgress.updateStatus(`Generando c칩digo QR para: ${product.codigo}`);
                    
                    const qrDataURL = await generateQRCodeDataURL(product.codigo);
                    
                    if (qrDataURL) {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.1, 0.1, 'F');
                        
                        pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    }

                    // ===== PIE DE P츼GINA =====
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.02);
                    pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                    pdf.setFontSize(4);
                    pdf.setTextColor(120, 120, 120);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                    pdf.text(`Por: ${userDisplayName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                    // Peque침a pausa para que se vea el progreso
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // 九 MOSTRAR 칄XITO
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Guardando archivo PDF...');

                // ===== GUARDAR PDF =====
                const fileName = `tickets_despacho_pequenos_${now.getTime()}.pdf`;
                
                // Peque침o delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));
                
                pdf.save(fileName);
                
                // 九 MOSTRAR 칄XITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar despu칠s de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`PDF con ${validProducts.length} tickets peque침os generado`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error generando tickets peque침os:', error);
                pdfProgress.showError(error);
                
                // Ocultar despu칠s de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar tickets peque침os: ' + error.message, 'error');
                }, 3000);
            }
        }

        // ===== 2. FUNCI칍N PARA GENERAR TODOS LOS TICKETS MEDIANOS =====
        async function generateAllMediumHorizontalTicketsFromExcel() {                        
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librer칤a PDF no disponible', 'error');
                return;
            }

            try {
                const validProducts = TicketExcelState.filteredProducts.filter(product => 
                    validateProductForPdf(product).isValid
                );

                if (validProducts.length === 0) {
                    showToast('No hay productos v치lidos para generar tickets', 'warning');
                    return;
                }

                // 九 MOSTRAR PROGRESO
                pdfProgress.show(validProducts.length, 'ticket-medium-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento PDF para tickets medianos...');

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [10, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Obtener nombre y apellido del usuario
                const userName = AppState.currentUser?.nombre || AppState.currentUser?.datosUsuario?.nombre || 'Usuario';
                const userApellido = AppState.currentUser?.apellido || AppState.currentUser?.datosUsuario?.apellido || '';
                const userDisplayName = userApellido ? `${userName} ${userApellido}` : userName;

                for (let index = 0; index < validProducts.length; index++) {
                    // 九 VERIFICAR SI SE CANCEL칍
                    if (pdfProgress.isCancelled) {
                        console.log('Generaci칩n de tickets medianos cancelada por el usuario');
                        return;
                    }

                    const product = validProducts[index];
                    
                    if (index > 0) {
                        pdf.addPage([10, 5], 'landscape');
                        pdfProgress.updateStatus(`Agregando p치gina ${index + 1} para: ${product.codigo}`);
                    }

                    // 九 ACTUALIZAR PROGRESO
                    const progress = ((index + 1) / validProducts.length) * 100;
                    pdfProgress.updateProgress(progress, index + 1, validProducts.length);
                    pdfProgress.updateStatus(`Generando ticket mediano para: ${product.codigo}`);

                    // ===== DIMENSIONES =====
                    const pageWidth = 10;
                    const pageHeight = 5;
                    const margin = 0.5;
                    let currentY = 0.5;

                    // ===== FONDO =====
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                    // ===== C칍DIGO DEL PRODUCTO (PRINCIPAL) =====
                    currentY += 0.1;
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.1;

                    // L칤nea separadora
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.05);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 0.4;

                    // ===== DESCRIPCI칍N =====
                    pdf.setFontSize(7);
                    pdf.setTextColor(40, 40, 40);
                    pdf.setFont('helvetica', 'normal');
                    
                    const descripcion = product.descripcion || 'Sin descripci칩n';
                    const maxWidth = pageWidth - (margin * 2);
                    const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                    
                    // Fondo para descripci칩n
                    pdf.setFillColor(255, 255, 255);
                    const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                    pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                    
                    pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.6;
                    
                    // ===== INFORMACI칍N ADICIONAL =====
                    const details = [
                        { 
                            label: 'CALIDAD', 
                            value: product.calidad || 'N/A'
                        },
                        { 
                            label: 'DIMENSI칍N', 
                            value: product.dimension || 'N/A'
                        },
                        { 
                            label: 'UNIDAD', 
                            value: product.unidadMedida || 'N/A'
                        }
                    ];

                    details.forEach((detail, detailIndex) => {
                        if (currentY < pageHeight - 1.8) {
                            const boxWidth = (pageWidth - (margin * 2) - 0.6) / 3;
                            const boxX = margin + (detailIndex * (boxWidth + 0.2));
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                            
                            // Etiqueta
                            pdf.setFontSize(6);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(80, 80, 80);
                            pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                            
                            // Valor
                            pdf.setFontSize(7);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                        }
                    });

                    currentY += 0.7;

                    // ===== C칍DIGO QR =====
                    pdfProgress.updateStep(3, 'active');
                    pdfProgress.updateStatus(`Generando c칩digo QR para: ${product.codigo}`);
                    
                    const qrDataURL = await generateQRCodeDataURL(product.codigo);
                    
                    if (qrDataURL) {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(qrX - 0.15, currentY - 0.15, qrSize + 0.3, qrSize + 0.3, 0.2, 0.2, 'F');
                        
                        pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                        
                        pdfProgress.updateStatus(`九 QR generado para: ${product.codigo}`);
                    } else {
                        const qrSize = 2;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        pdf.setDrawColor(200, 200, 200);
                        pdf.setFillColor(245, 245, 245);
                        pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.2, 0.2, 'FD');
                        
                        pdf.setFontSize(6);
                        pdf.setTextColor(150, 150, 150);
                        pdf.text('C칍DIGO', pageWidth / 2, currentY + qrSize / 2 - 0.15, { align: 'center' });
                        pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.02, { align: 'center' });
                        pdf.text('NO DISPONIBLE', pageWidth / 2, currentY + qrSize / 2 + 0.15, { align: 'center' });
                        
                        pdfProgress.updateStatus(`丘멆잺 QR no disponible para: ${product.codigo}`, 'warning');
                    }

                    // ===== PIE DE P츼GINA =====
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.02);
                    pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                    pdf.setFontSize(4);
                    pdf.setTextColor(120, 120, 120);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                    pdf.text(`Por: ${userDisplayName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                    // Peque침a pausa para que se vea el progreso
                    if (index % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // 九 MOSTRAR 칄XITO Y GUARDAR
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Finalizando documento y preparando descarga...');
                
                // Peque침o delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR PDF =====
                const fileName = `tickets_despacho_medianos_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // 九 MOSTRAR 칄XITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar despu칠s de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`PDF con ${validProducts.length} tickets medianos generado`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error generando tickets medianos:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar despu칠s de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar tickets medianos: ' + error.message, 'error');
                }, 3000);
            }
        }

        // ===== 3. FUNCI칍N PARA GENERAR RESUMEN COMPACTO =====
        async function generateCompactSummaryPdfFromExcel() {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librer칤a PDF no disponible', 'error');
                return;
            }

            try {
                // Validar que hay productos
                if (!TicketExcelState.filteredProducts || TicketExcelState.filteredProducts.length === 0) {
                    showToast('No hay productos para generar el resumen', 'warning');
                    return;
                }

                const totalProducts = TicketExcelState.filteredProducts.length;

                // 九 MOSTRAR PROGRESO
                pdfProgress.show(totalProducts, 'compact-summary');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento de resumen compacto...');

                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString();
                
                // Obtener nombre y apellido del usuario
                const userName = AppState.currentUser?.nombre || AppState.currentUser?.datosUsuario?.nombre || 'Usuario';
                const userApellido = AppState.currentUser?.apellido || AppState.currentUser?.datosUsuario?.apellido || '';
                const userDisplayName = userApellido ? `${userName} ${userApellido}` : userName;

                let currentY = 20;
                const margin = 15;
                const pageWidth = 210;
                const contentWidth = pageWidth - (margin * 2);

                // 九 ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(10);
                pdfProgress.updateStatus('Configurando encabezados y formato...');

                // Encabezado
                pdf.setFontSize(16);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GALLOS M츼RMOL - DESPACHO', margin, currentY);
                
                currentY += 8;
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Generado: ${generationDate} ${generationTime}  Por: ${userDisplayName}`, margin, currentY);
                pdf.text(`Productos: ${totalProducts}`, margin, currentY + 5);
                
                currentY += 15;

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(30);
                pdfProgress.updateStatus('Preparando tabla de productos...');

                // Tabla de productos - Ajustar anchos de columnas
                const rowHeight = 8;
                const headers = ['C칩digo', 'Descripci칩n', 'Familia', 'Material', 'Unidad'];
                const columnWidths = [20, 75, 25, 40, 15]; // Ajustado para mejor distribuci칩n
                const columnPadding = 1;
                
                // Funci칩n para dibujar texto con wrap
                const drawWrappedText = (text, x, y, width, maxHeight = rowHeight) => {
                    const lines = pdf.splitTextToSize(text || 'N/A', width - (columnPadding * 2));
                    const lineHeight = 3.5;
                    const neededHeight = lines.length * lineHeight;
                    
                    // Si el texto es demasiado alto, truncar
                    if (neededHeight > maxHeight && lines.length > 1) {
                        const maxLines = Math.floor(maxHeight / lineHeight);
                        const truncatedLines = lines.slice(0, maxLines);
                        if (truncatedLines.length > 0) {
                            // Agregar "..." al 칰ltimo elemento
                            truncatedLines[truncatedLines.length - 1] = truncatedLines[truncatedLines.length - 1].substring(0, truncatedLines[truncatedLines.length - 1].length - 3) + '...';
                        }
                        pdf.text(truncatedLines, x + columnPadding, y + 3);
                        return neededHeight;
                    }
                    
                    pdf.text(lines, x + columnPadding, y + 3);
                    return Math.max(rowHeight, neededHeight);
                };

                // Encabezados de tabla
                pdf.setFillColor(0, 0, 0);
                pdf.setTextColor(255, 255, 255);
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                
                let xPosition = margin;
                headers.forEach((header, index) => {
                    pdf.rect(xPosition, currentY, columnWidths[index], rowHeight, 'F');
                    // Centrar texto en encabezados
                    const textWidth = pdf.getTextWidth(header);
                    const centeredX = xPosition + (columnWidths[index] - textWidth) / 2;
                    pdf.text(header, centeredX, currentY + 5);
                    xPosition += columnWidths[index];
                });
                
                currentY += rowHeight;

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(50);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando contenido de la tabla...');

                // Filas de productos
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                
                TicketExcelState.filteredProducts.forEach((product, index) => {
                    // 九 ACTUALIZAR PROGRESO DURANTE LA GENERACI칍N
                    if (index % 10 === 0) {
                        const progress = 50 + (index / totalProducts) * 40;
                        pdfProgress.updateProgress(progress, index + 1, totalProducts);
                        pdfProgress.updateStatus(`Procesando producto ${index + 1} de ${totalProducts}...`);
                    }

                    // Verificar si necesita nueva p치gina
                    if (currentY > 270) {
                        pdf.addPage();
                        currentY = 20;
                        
                        // Volver a dibujar encabezados en nueva p치gina
                        pdf.setFillColor(0, 0, 0);
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFont('helvetica', 'bold');
                        
                        let xPos = margin;
                        headers.forEach((header, idx) => {
                            pdf.rect(xPos, currentY, columnWidths[idx], rowHeight, 'F');
                            const textWidth = pdf.getTextWidth(header);
                            const centeredX = xPos + (columnWidths[idx] - textWidth) / 2;
                            pdf.text(header, centeredX, currentY + 5);
                            xPos += columnWidths[idx];
                        });
                        
                        currentY += rowHeight;
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFont('helvetica', 'normal');
                    }
                    
                    // Fila con fondo alternado
                    if (index % 2 === 0) {
                        pdf.setFillColor(245, 245, 245);
                        pdf.rect(margin, currentY, contentWidth, rowHeight, 'F');
                    }
                    
                    // Contenido de la fila
                    let xPos = margin;
                    let maxRowHeight = rowHeight;
                    
                    // C칩digo
                    const codigoHeight = drawWrappedText(product.codigo, xPos, currentY, columnWidths[0]);
                    maxRowHeight = Math.max(maxRowHeight, codigoHeight);
                    xPos += columnWidths[0];
                    
                    // Descripci칩n
                    const descHeight = drawWrappedText(product.descripcion, xPos, currentY, columnWidths[1]);
                    maxRowHeight = Math.max(maxRowHeight, descHeight);
                    xPos += columnWidths[1];
                    
                    // Calidad
                    const calidadHeight = drawWrappedText(product.calidad, xPos, currentY, columnWidths[2]);
                    maxRowHeight = Math.max(maxRowHeight, calidadHeight);
                    xPos += columnWidths[2];
                    
                    // Dimensi칩n
                    const dimensionHeight = drawWrappedText(product.dimension, xPos, currentY, columnWidths[3]);
                    maxRowHeight = Math.max(maxRowHeight, dimensionHeight);
                    xPos += columnWidths[3];
                    
                    // Unidad
                    const unidadHeight = drawWrappedText(product.unidadMedida, xPos, currentY, columnWidths[4]);
                    maxRowHeight = Math.max(maxRowHeight, unidadHeight);
                    
                    currentY += maxRowHeight;
                });

                // 九 ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Preparando archivo para descarga...');

                currentY += 10;

                const fileName = `inventario_despacho_${now.getTime()}.pdf`;
                
                // Peque침o delay para que se vea el progreso final
                setTimeout(() => {
                    pdf.save(fileName);
                    
                    // 九 MOSTRAR 칄XITO
                    pdfProgress.showSuccess();
                    
                    setTimeout(() => {
                        pdfProgress.hide();
                        showToast(`Resumen con ${totalProducts} productos generado`, 'success');
                    }, 2000);
                }, 500);

            } catch (error) {
                console.error('Error generando resumen compacto:', error);
                
                pdfProgress.showError(error);
                
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el inventario: ' + error.message, 'error');
                }, 3000);
            }
        }

        // ===== 4. FUNCI칍N PARA GENERAR PDF INDIVIDUAL - TICKET PEQUE칌O =====
        async function generateSmallHorizontalTicket(product) {                       
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librer칤a PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar producto
                if (!product) {
                    showToast('Producto no v치lido para generar ticket', 'error');
                    return;
                }

                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    showToast(`Error: ${validation.error}`, 'error');
                    return;
                }

                // 九 MOSTRAR PROGRESO
                pdfProgress.show(1, 'ticket-small-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus(`Creando ticket peque침o para: ${product.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Obtener nombre y apellido del usuario
                const userName = AppState.currentUser?.nombre || AppState.currentUser?.datosUsuario?.nombre || 'Usuario';
                const userApellido = AppState.currentUser?.apellido || AppState.currentUser?.datosUsuario?.apellido || '';
                const userDisplayName = userApellido ? `${userName} ${userApellido}` : userName;

                // 九 ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(20);
                pdfProgress.updateStatus('Configurando formato del ticket...');

                // ===== DIMENSIONES =====
                const pageWidth = 7.5;
                const pageHeight = 5;
                const margin = 0.4;
                let currentY = 0.5;

                // ===== FONDO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(40);
                pdfProgress.updateStatus('Agregando informaci칩n del producto...');

                // ===== C칍DIGO DEL PRODUCTO (PRINCIPAL) =====
                currentY += 0.1;
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.1;

                // L칤nea separadora
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.05);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 0.4;

                // ===== DESCRIPCI칍N =====
                pdf.setFontSize(7);
                pdf.setTextColor(40, 40, 40);
                pdf.setFont('helvetica', 'normal');
                
                const descripcion = product.descripcion || 'Sin descripci칩n';
                const maxWidth = pageWidth - (margin * 2);
                const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                
                // Fondo para descripci칩n
                pdf.setFillColor(255, 255, 255);
                const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                
                pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.6;

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(60);
                pdfProgress.updateStatus('Agregando detalles del producto...');

                // ===== INFORMACI칍N ADICIONAL =====
                    const details = [
                        { 
                            label: 'CALIDAD', 
                            value: product.calidad || 'N/A'
                        },
                        { 
                            label: 'DIMENSI칍N', 
                            value: product.dimension || 'N/A'
                        },
                        { 
                            label: 'UNIDAD', 
                            value: product.unidadMedida || 'N/A'
                        }
                    ];

                details.forEach((detail, index) => {
                    if (currentY < pageHeight - 1.8) {
                        const boxWidth = (pageWidth - (margin * 2) - 0.4) / 3;
                        const boxX = margin + (index * (boxWidth + 0.2));
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                        
                        // Etiqueta
                        pdf.setFontSize(6);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                        
                        // Valor
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                    }
                });

                currentY += 0.7;

                // 九 ACTUALIZAR PROGRESO PARA QR
                pdfProgress.updateProgress(80);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando c칩digo QR...');

                // ===== C칍DIGO QR =====
                const qrDataURL = await generateQRCodeDataURL(product.codigo);
                
                if (qrDataURL) {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    // Fondo para QR
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.15, 0.15, 'F');
                    
                    // Agregar QR
                    pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    
                    pdfProgress.updateStatus('九 C칩digo QR generado correctamente');
                } else {
                    // Placeholder si QR no est치 disponible
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setFillColor(245, 245, 245);
                    pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.15, 0.15, 'FD');
                    
                    pdf.setFontSize(5);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.1, { align: 'center' });
                    pdf.text('NO DISP.', pageWidth / 2, currentY + qrSize / 2 + 0.1, { align: 'center' });
                    
                    pdfProgress.updateStatus('丘멆잺 C칩digo QR no disponible', 'warning');
                }

                // 九 ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Agregando informaci칩n de generaci칩n...');

                // ===== PIE DE P츼GINA =====
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.02);
                pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                pdf.setFontSize(4);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                pdf.text(`Por: ${userDisplayName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                // 九 MOSTRAR 칄XITO Y GUARDAR
                pdfProgress.updateProgress(100);
                pdfProgress.updateStatus('Preparando descarga del ticket...');
                
                // Peque침o delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR =====
                const fileName = `ticket_despacho_${product.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // 九 MOSTRAR 칄XITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar despu칠s de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    
                    if (qrDataURL) {
                        showToast(`Ticket peque침o con QR generado para ${product.codigo}`, 'success');
                    } else {
                        showToast(`Ticket peque침o generado para ${product.codigo} (sin QR)`, 'info');
                    }
                }, 2000);

            } catch (error) {
                console.error('Error generando ticket peque침o:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar despu칠s de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el ticket peque침o', 'error');
                }, 3000);
            }
        }

        // ===== 5. FUNCI칍N PARA GENERAR PDF INDIVIDUAL - TICKET MEDIANO =====
        async function generateMediumHorizontalTicket(product) {                      
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librer칤a PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar producto
                if (!product) {
                    showToast('Producto no v치lido para generar ticket', 'error');
                    return;
                }

                const validation = validateProductForPdf(product);
                if (!validation.isValid) {
                    showToast(`Error: ${validation.error}`, 'error');
                    return;
                }

                // 九 MOSTRAR PROGRESO
                pdfProgress.show(1, 'ticket-medium-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus(`Creando ticket mediano para: ${product.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [10, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Obtener nombre y apellido del usuario
                const userName = AppState.currentUser?.nombre || AppState.currentUser?.datosUsuario?.nombre || 'Usuario';
                const userApellido = AppState.currentUser?.apellido || AppState.currentUser?.datosUsuario?.apellido || '';
                const userDisplayName = userApellido ? `${userName} ${userApellido}` : userName;

                // 九 ACTUALIZAR PROGRESO INICIAL
                pdfProgress.updateProgress(20);
                pdfProgress.updateStatus('Configurando formato del ticket mediano...');

                // ===== DIMENSIONES =====
                const pageWidth = 10;
                const pageHeight = 5;
                const margin = 0.5;
                let currentY = 0.5;

                // ===== FONDO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(40);
                pdfProgress.updateStatus('Agregando informaci칩n del producto...');

                // ===== C칍DIGO DEL PRODUCTO (PRINCIPAL) =====
                currentY += 0.1;
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text(product.codigo, pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.1;

                // L칤nea separadora
                pdf.setDrawColor(0, 0, 0);
                pdf.setLineWidth(0.05);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 0.4;

                // ===== DESCRIPCI칍N =====
                pdf.setFontSize(7);
                pdf.setTextColor(40, 40, 40);
                pdf.setFont('helvetica', 'normal');
                
                const descripcion = product.descripcion || 'Sin descripci칩n';
                const maxWidth = pageWidth - (margin * 2);
                const descLines = pdf.splitTextToSize(descripcion, maxWidth);
                
                // Fondo para descripci칩n
                pdf.setFillColor(255, 255, 255);
                const descHeight = Math.min(descLines.length, 2) * 0.35 + 0.2;
                pdf.roundedRect(margin, currentY - 0.15, pageWidth - (margin * 2), descHeight, 0.1, 0.1, 'F');
                
                pdf.text(descLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.6;

                // 九 ACTUALIZAR PROGRESO
                pdfProgress.updateProgress(60);
                pdfProgress.updateStatus('Agregando detalles del producto...');

                // ===== INFORMACI칍N ADICIONAL =====
                    const details = [
                        { 
                            label: 'CALIDAD', 
                            value: product.calidad || 'N/A'
                        },
                        { 
                            label: 'DIMENSI칍N', 
                            value: product.dimension || 'N/A'
                        },
                        { 
                            label: 'UNIDAD', 
                            value: product.unidadMedida || 'N/A'
                        }
                    ];

                details.forEach((detail, index) => {
                    if (currentY < pageHeight - 1.8) {
                        const boxWidth = (pageWidth - (margin * 2) - 0.6) / 3;
                        const boxX = margin + (index * (boxWidth + 0.2));
                        
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(boxX, currentY, boxWidth, 0.5, 0.1, 0.1, 'F');
                        
                        // Etiqueta
                        pdf.setFontSize(6);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                        
                        // Valor
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(detail.value, boxX + 0.1, currentY + 0.4);
                    }
                });

                currentY += 0.7;

                // 九 ACTUALIZAR PROGRESO PARA QR
                pdfProgress.updateProgress(80);
                pdfProgress.updateStep(3, 'active');
                pdfProgress.updateStatus('Generando c칩digo QR...');

                // ===== C칍DIGO QR =====
                const qrDataURL = await generateQRCodeDataURL(product.codigo);
                
                if (qrDataURL) {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(qrX - 0.15, currentY - 0.15, qrSize + 0.3, qrSize + 0.3, 0.2, 0.2, 'F');
                    
                    pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                    
                    pdfProgress.updateStatus('九 C칩digo QR generado correctamente');
                } else {
                    const qrSize = 2;
                    const qrX = (pageWidth - qrSize) / 2;
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setFillColor(245, 245, 245);
                    pdf.roundedRect(qrX, currentY, qrSize, qrSize, 0.2, 0.2, 'FD');
                    
                    pdf.setFontSize(6);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('C칍DIGO', pageWidth / 2, currentY + qrSize / 2 - 0.15, { align: 'center' });
                    pdf.text('QR', pageWidth / 2, currentY + qrSize / 2 - 0.02, { align: 'center' });
                    pdf.text('NO DISPONIBLE', pageWidth / 2, currentY + qrSize / 2 + 0.15, { align: 'center' });
                    
                    pdfProgress.updateStatus('丘멆잺 C칩digo QR no disponible', 'warning');
                }

                // 九 ACTUALIZAR PROGRESO FINAL
                pdfProgress.updateProgress(95);
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Agregando informaci칩n de generaci칩n...');

                // ===== PIE DE P츼GINA =====
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.02);
                pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                pdf.setFontSize(4);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generado: ${generationDate} ${generationTime}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                pdf.text(`Por: ${userDisplayName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                // 九 MOSTRAR 칄XITO Y GUARDAR
                pdfProgress.updateProgress(100);
                pdfProgress.updateStatus('Preparando descarga del ticket...');
                
                // Peque침o delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));

                // ===== GUARDAR =====
                const fileName = `ticket_despacho_${product.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // 九 MOSTRAR 칄XITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar despu칠s de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    
                    if (qrDataURL) {
                        showToast('Ticket mediano con c칩digo QR generado', 'success');
                    } else {
                        showToast('Ticket mediano generado (sin QR)', 'info');
                    }
                }, 2000);

            } catch (error) {
                console.error('Error generando ticket mediano:', error);
                
                pdfProgress.showError(error);
                
                // Ocultar despu칠s de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar el ticket mediano', 'error');
                }, 3000);
            }
        }

        // Funci칩n para eliminar producto
        function deleteProduct(productId) {
            if (!confirm('쮼st치s seguro de que quieres eliminar este producto?')) {
                return;
            }
            
            TicketExcelState.products = TicketExcelState.products.filter(p => p.id !== productId);
            TicketExcelState.filteredProducts = TicketExcelState.filteredProducts.filter(p => p.id !== productId);
            
            renderTicketProductsTable();
            updateDespachoFilters();
            
            showToast('Producto eliminado', 'success');
        }

        // Funci칩n para exportar a Excel
        function exportToExcel() {
            try {
                // Verificar que hay productos para exportar
                if (!TicketExcelState.filteredProducts || TicketExcelState.filteredProducts.length === 0) {
                    showToast('No hay productos para exportar', 'warning');
                    return;
                }

                // Preparar datos - SIN CAMPO MODELO
                const data = [
                    ['C칍DIGO', 'DESCRIPCI칍N', 'FAMILIA', 'ACABADO', 'BORDE', 'CALIDAD', 'MATERIAL', 'DIMENSI칍N', 'UNIDAD_MEDIDA', 'ESTADO']
                ];
                
                // Procesar cada producto
                TicketExcelState.filteredProducts.forEach(product => {
                    data.push([
                        product.codigo || '',
                        product.descripcion || '',
                        product.familia || '',
                        product.acabado || '',
                        product.borde || '',
                        product.calidad || '',
                        product.material || '',
                        product.dimension || '',
                        product.unidadMedida || '',
                        product.isValid ? 'V츼LIDO' : 'INV츼LIDO'
                    ]);
                });
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Establecer anchos de columnas optimizados
                const colWidths = [
                    { wch: 20 }, // C칍DIGO
                    { wch: 50 }, // DESCRIPCI칍N
                    { wch: 15 }, // FAMILIA
                    { wch: 12 }, // ACABADO
                    { wch: 12 }, // BORDE
                    { wch: 12 }, // CALIDAD
                    { wch: 15 }, // MATERIAL
                    { wch: 12 }, // DIMENSI칍N
                    { wch: 12 }, // UNIDAD_MEDIDA
                    { wch: 10 }  // ESTADO
                ];
                ws['!cols'] = colWidths;
                
                // Aplicar estilos a los encabezados
                if (!ws['!merges']) ws['!merges'] = [];
                if (!ws['!rows']) ws['!rows'] = [];
                
                // Estilo para la primera fila (encabezados)
                if (ws['A1']) {
                    ws['A1'].s = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "2E86AB" } } };
                }
                
                // Aplicar estilo a todos los encabezados
                const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1', 'I1', 'J1'];
                headerCells.forEach(cell => {
                    if (ws[cell]) {
                        ws[cell].s = { 
                            font: { bold: true, color: { rgb: "FFFFFF" } }, 
                            fill: { fgColor: { rgb: "2E86AB" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                });
                
                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Productos Despacho');
                
                // Generar nombre de archivo con fecha
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const fileName = `productos_despacho_${dateString}_${timeString}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, fileName);
                
                // Mostrar estad칤sticas
                const totalProducts = TicketExcelState.filteredProducts.length;
                const validProducts = TicketExcelState.filteredProducts.filter(p => p.isValid).length;
                const invalidProducts = totalProducts - validProducts;
                
                console.log('游닋 Exportaci칩n completada:', {
                    archivo: fileName,
                    productosExportados: totalProducts,
                    productosV치lidos: validProducts,
                    productosInv치lidos: invalidProducts,
                    columnas: data[0].length
                });
                
                // Mostrar mensaje de 칠xito
                let successMessage = `Archivo exportado: ${totalProducts} productos`;
                if (invalidProducts > 0) {
                    successMessage += ` (${invalidProducts} con advertencias)`;
                }
                
                showToast(successMessage, 'success');
                
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                showToast('Error al exportar los datos: ' + error.message, 'error');
            }
        }

        // ===== MANEJO DE ERRORES =====
        window.addEventListener('error', function(e) {
            console.error('仇 Error no capturado:', e.error);
            showToast('Error inesperado en la aplicaci칩n', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('仇 Promesa rechazada no capturada:', e.reason);
            showToast('Error en operaci칩n as칤ncrona', 'error');
            e.preventDefault();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Activo - Administrador</title>
    <meta name="description" content="Sistema de gestión de activos de TI para administradores de Gallos Mármol">
    <meta name="keywords" content="gallos mármol, activos, ti, administración, gestión">
    <meta name="author" content="Gallos Mármol">
    <link rel="icon" type="image/x-icon" href="../../FOTO/ICONO/Icono_01.ico">
    
    <!-- Librerías externas -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Agregar estas librerías en el head -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>  

    <!-- INCLUIR EL AUTH-CHECK.JS -->
    <script src="../../JS/auth-check.js"></script>

    <style>
        /* ===== VARIABLES Y RESET ===== */
        :root {
            --primary-color: #CB3E2C;
            --primary-light: #3498db;
            --secondary-color: #8e44ad;
            --secondary-light: #9b59b6;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --danger-color: #e74c3c;
            --danger-light: #ec7063;
            --info-color: #17a2b8;
            --info-light: #48cae4;
            --light-color: #ecf0f1;
            --light-gray: #f8f9fa;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #fff;
            --text-muted: #6c757d;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --header-height: 70px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --primary-light: #5dade2;
            --secondary-color: #9b59b6;
            --secondary-light: #bb8fce;
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #d68910;
            --warning-light: #f8c471;
            --danger-color: #cb4335;
            --danger-light: #ec7063;
            --info-color: #17a2b8;
            --info-light: #48cae4;
            --light-color: #2c2c2c;
            --light-gray: #1e1e1e;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --text-muted: #a0a0a0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== ESTRUCTURA PRINCIPAL ===== */
        #app {
            min-height: 100vh;
            display: none;
        }

        /* ===== HEADER ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 60%;
        }

        .logo-img {
            height: 45px;
            width: auto;
            border-radius: var(--border-radius-sm);
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle, .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover, .fullscreen-btn:hover {
            background-color: var(--light-color);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-info {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.875rem;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            display: inline-block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-color);
        }

        .dropdown-item:hover {
            background-color: var(--light-color);
        }

        .dropdown-item.logout {
            color: var(--danger-color);
        }

        /* ===== ESTILOS PARA MODAL DE EXPORTACIÓN ===== */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        }

        .export-modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .export-modal-header {
            padding: 1.5rem 1.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .export-modal-body {
            padding: 1.5rem;
        }

        .export-modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
            border-top: 1px solid var(--border-color);
        }

        /* Opciones de formato */
        .format-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .format-option {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
        }

        .format-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .format-option.active {
            border-color: var(--primary-color);
            background: rgba(203, 62, 44, 0.05);
        }

        .format-icon {
            margin-right: 1rem;
            font-size: 2rem;
            color: var(--primary-color);
            width: 60px;
            text-align: center;
        }

        .format-content {
            flex: 1;
        }

        .format-content h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .format-content p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .format-check {
            margin-left: 1rem;
        }

        .check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .check-circle.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .check-circle.active i {
            color: white;
            font-size: 0.8rem;
        }

        /* Resumen de exportación */
        .export-summary {
            background: var(--light-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-item:last-child {
            margin-bottom: 0;
        }

        .summary-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .summary-value {
            color: var(--text-color);
            font-weight: 600;
        }

        /* Badge para contar activos */
        .export-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Botón de exportación en la sección de activos */
        .export-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #219653, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Progreso de exportación */
        .export-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            flex-direction: column;
            color: white;
        }

        .export-progress-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .export-progress-bar {
            background: var(--light-color);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .export-progress-fill {
            background: var(--primary-color);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .export-progress-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .export-progress-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* FEEDBACK PARA IPs DUPLICADAS */
        .quick-action-panel {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(231, 76, 60, 0.05);
            border: 1px solid var(--danger-color);
            border-radius: var(--border-radius);
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .quick-action-panel.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .quick-action-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--danger-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .quick-action-buttons {
            display: flex;
            justify-content: center; /* Centrar el único botón */
        }

        /* BOTÓN DE ETIQUETA MEJORADO */
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #219653, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4);
        }

        .btn-success:active {
            transform: translateY(0);
        }

        /* LOADING ESPECÍFICO PARA PDF */
        .pdf-generating {
            position: relative;
        }

        .pdf-generating::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        /* TOAST PERSONALIZADO */
        .custom-toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            max-width: 400px;
            z-index: 10000;
            display: flex;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
        }

        .custom-toast-icon {
            font-size: 1.25rem;
            color: var(--warning-color);
        }

        .custom-toast-content {
            flex: 1;
        }

        .custom-toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .custom-toast-message {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .custom-toast-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .toast-action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .toast-action-btn:hover {
            background: var(--primary-light);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Estilos para las cards de IP */
        .ip-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
        }

        .ip-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .ip-card.ip-inactive {
            opacity: 0.6;
            background: var(--light-color);
            border-left-color: var(--danger-color);
        }

        .ip-info {
            flex: 1;
        }

        .ip-main {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .ip-main strong {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .ip-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .ip-active .ip-status {
            background: var(--success-color);
            color: white;
        }

        .ip-inactive .ip-status {
            background: var(--danger-color);
            color: white;
        }

        .ip-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .ip-detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ip-detail-item i {
            width: 12px;
            opacity: 0.7;
        }

        .ip-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        /* Badge para contar IPs en cards de activos */
        .ip-badge {
            background: var(--info-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* ===== ESTILOS PARA AUTOGENERACIÓN DE NOMBRES ===== */
        .name-help {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--primary-color);
            animation: slideDown 0.3s ease;
        }

        .name-help .help-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .name-help .help-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .template-option {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: var(--light-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .template-option:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .template-option i {
            margin-right: 0.5rem;
            opacity: 0.7;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para el modal de plantillas */
        .template-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        }

        .template-modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .template-options {
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            padding-top: var(--header-height);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ===== NAVEGACIÓN POR PESTAÑAS ===== */
        .nav-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 0 0 auto;
            min-width: 140px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            font-size: 0.9rem;
            text-align: center;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== SECCIONES ===== */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* ===== FORMULARIOS ===== */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Estilos para campos en mayúsculas */
        .uppercase-field {
            text-transform: uppercase;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .uppercase-field::placeholder {
            text-transform: none;
            font-family: inherit;
            letter-spacing: normal;
        }

        /* Indicador visual para campos en mayúsculas */
        .uppercase-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(203, 62, 44, 0.1);
        }

        .uppercase-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ===== TABLAS ===== */
        .table-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--light-color);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background-color: var(--light-color);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Estilos para campos de solo lectura */
        .form-control[readonly] {
            background-color: var(--light-color);
            border-color: var(--border-color);
            color: var(--text-color);
            opacity: 0.8;
            cursor: not-allowed;
        }

        .form-control[readonly]:focus {
            border-color: var(--border-color);
            box-shadow: none;
            outline: none;
        }

        /* Indicador visual para campo bloqueado */
        .locked-field {
            position: relative;
        }

        .locked-field::after {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            opacity: 0.6;
        }

        /* Estilos para el modal de especificaciones */
        .btn-quick-spec {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .btn-quick-spec:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .spec-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            align-items: center;
            transition: var(--transition);
        }

        .spec-row:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .spec-row.required {
            border-left: 4px solid var(--danger-color);
        }

        .spec-clave {
            flex: 1;
        }

        .spec-valor {
            flex: 2;
        }

        .spec-actions {
            flex: 0;
            display: flex;
            gap: 0.25rem;
        }

        .quick-buttons {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .empty-state {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== LISTA DE ACTIVOS ===== */
        .assets-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            grid-column: 1 / -1;
        }

        .search-box .form-control {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.7;
        }

        .assets-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .asset-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
        }

        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .asset-info h3 {
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .asset-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .asset-code {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            background-color: var(--primary-color);
            color: white;
        }

        .asset-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-operativo {
            background-color: var(--success-color);
            color: white;
        }

        .status-en-reparacion {
            background-color: var(--warning-color);
            color: white;
        }

        .status-en-almacen {
            background-color: var(--info-color);
            color: white;
        }

        .status-dado-de-baja {
            background-color: var(--danger-color);
            color: white;
        }

        .asset-description {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .asset-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .asset-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .assigned-to {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .assigned-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ===== BOTONES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--danger-light);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-light);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-light);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-light);
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-accent:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: var(--info-light);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===== ESTILOS PARA CARDS DE MARCAS ===== */
        .brands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .brand-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .brand-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .brand-card.inactive {
            opacity: 0.7;
            border-left-color: var(--danger-color);
        }

        .brand-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .brand-info h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        .brand-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .brand-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .brand-status.active {
            background-color: var(--success-color);
            color: white;
        }

        .brand-status.inactive {
            background-color: var(--danger-color);
            color: white;
        }

        .brand-description {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 1.5rem;
            line-height: 1.5;
            min-height: 40px;
        }

        .brand-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .brand-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .brand-dates {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }

        .brand-date {
            display: block;
            margin-bottom: 0.25rem;
        }

        /* Badge para marcas inactivas */
        .brand-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }


        /* ===== PAGINACIÓN ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ===== MODALES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .modal-header {
            padding: 1.5rem 1.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-wrap: wrap;
            border-top: 1px solid var(--border-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            opacity: 0.7;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
        }

        .close-modal:hover {
            opacity: 1;
            background-color: var(--light-color);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            padding: 1rem;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .toast-info {
            background-color: var(--info-color);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            margin-left: auto;
            cursor: pointer;
            opacity: 0.8;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 1rem;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-text {
            font-size: 1.1rem;
        }

        /* ===== ESTADOS VACÍOS ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .asset-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .asset-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .asset-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para campos dependientes */
        .form-group.dependent-field {
            position: relative;
        }

        .form-group.dependent-field::before {
            content: "";
            position: absolute;
            left: -15px;
            top: 40px;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .disabled-select {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Aplicación principal -->
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <img src="../../FOTO/LOGO/Logo_01.webp" alt="Gallos Mármol" class="logo-img">
                </div>
                <div class="header-actions">
                    <button class="fullscreen-btn" id="fullscreenBtn" title="Pantalla completa" aria-label="Pantalla completa">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" title="Cambiar tema" aria-label="Cambiar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar" aria-haspopup="true" aria-expanded="false">A</div>
                        <div class="user-dropdown" id="userDropdown" role="menu">
                            <div class="user-info">
                                <div class="user-name" id="userName">Administrador</div>
                                <span class="user-role" id="userRole">Administrador</span>
                            </div>
                            <a href="#" class="dropdown-item logout" id="logoutBtn" role="menuitem">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Contenido principal -->
        <main class="main-content">
            <div class="container">
                <!-- Navegación por pestañas -->
                <div class="nav-container">
                    <div class="nav-tabs" id="navTabs" role="tablist">
                        <button class="nav-tab active" data-tab="assets" role="tab" aria-selected="true" aria-controls="assetsSection">
                            <i class="fas fa-laptop"></i> Activos
                        </button>
                        <button class="nav-tab" data-tab="categories" role="tab" aria-selected="false" aria-controls="categoriesSection">
                            <i class="fas fa-folder"></i> Categorías
                        </button>
                        <button class="nav-tab" data-tab="types" role="tab" aria-selected="false" aria-controls="typesSection">
                            <i class="fas fa-tags"></i> Tipos
                        </button>
                        <button class="nav-tab" data-tab="locations" role="tab" aria-selected="false" aria-controls="locationsSection">
                            <i class="fas fa-map-marker-alt"></i> Ubicaciones
                        </button>
                        <button class="nav-tab" data-tab="maintenance" role="tab" aria-selected="false" aria-controls="maintenanceSection">
                            <i class="fas fa-tools"></i> Mantenimientos
                        </button>
                        <button class="nav-tab" data-tab="brands" role="tab" aria-selected="false" aria-controls="brandsSection">
                            <i class="fas fa-copyright"></i> Marcas
                        </button>    
                    </div>
                </div>
                <!-- Sección: Activos -->
                <section class="section active" id="assetsSection" role="tabpanel" aria-labelledby="assets-tab">
                    <div class="section-title">
                        <h2>Gestión de Activos</h2>
                        <small>Administra todos los activos de TI</small>
                        <button class="btn btn-primary" id="addAssetBtn">
                            <i class="fas fa-plus"></i> Nuevo Activo
                        </button>
                    </div>

                    <!-- Filtros y búsqueda -->
                    <div class="assets-filters">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="assetsSearchInput" 
                                placeholder="Buscar activos por código, nombre, marca, modelo...">
                        </div>
                        
                        <div class="form-group">
                            <label for="assetsStatusFilter">Estado</label>
                            <select class="form-control" id="assetsStatusFilter">
                                <option value="">Todos los estados</option>
                                <option value="operativo">Operativo</option>
                                <option value="en reparación">En Reparación</option>
                                <option value="en almacén">En Almacén</option>
                                <option value="dado de baja">Dado de Baja</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="assetsCategoryFilter">Categoría</label>
                            <select class="form-control" id="assetsCategoryFilter">
                                <option value="">Todas las categorías</option>
                                <!-- Las categorías se cargarán dinámicamente -->
                            </select>
                        </div>

                        <div class="form-group dependent-field">
                            <label for="assetsTypeFilter">Tipo</label>
                            <select class="form-control" id="assetsTypeFilter" disabled>
                                <option value="">Primero selecciona una categoría</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lista de activos -->
                    <div class="assets-list" id="assetsListContainer">
                        <!-- Los activos se cargarán aquí dinámicamente -->
                    </div>

                    <!-- Paginación -->
                    <div class="pagination" id="assetsPaginationContainer">
                        <button class="pagination-btn" id="assetsPrevPageBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info" id="assetsPaginationInfo">Página 1 de 1</span>
                        <button class="pagination-btn" id="assetsNextPageBtn" disabled>
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </section>

                <!-- Sección: Categorías -->
                <section class="section" id="categoriesSection" role="tabpanel" aria-labelledby="categories-tab">
                    <div class="section-title">
                        <h2>Gestión de Categorías</h2>
                        <small>Administra las categorías de activos</small>
                        <button class="btn btn-primary" id="addCategoryBtn">
                            <i class="fas fa-plus"></i> Nueva Categoría
                        </button>
                    </div>

                    <!-- Tabla de categorías -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="data-table" id="categoriesTable">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Fecha Creación</th>
                                        <th>Fecha Actualización</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody">
                                    <!-- Las categorías se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección: Tipos -->
                <section class="section" id="typesSection" role="tabpanel" aria-labelledby="types-tab">
                    <div class="section-title">
                        <h2>Gestión de Tipos de Activos</h2>
                        <small>Administra los tipos de activos por categoría</small>
                        <button class="btn btn-primary" id="addTypeBtn">
                            <i class="fas fa-plus"></i> Nuevo Tipo
                        </button>
                    </div>

                    <!-- Tabla de tipos -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="data-table" id="typesTable">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Categoría</th>
                                        <th>Descripción</th>
                                        <th>Fecha Creación</th>
                                        <th>Fecha Actualización</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="typesTableBody">
                                    <!-- Los tipos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección: Ubicaciones -->
                <section class="section" id="locationsSection" role="tabpanel" aria-labelledby="locations-tab">
                    <div class="section-title">
                        <h2>Gestión de Ubicaciones</h2>
                        <small>Administra las ubicaciones de los activos</small>
                        <button class="btn btn-primary" id="addLocationBtn">
                            <i class="fas fa-plus"></i> Nueva Ubicación
                        </button>
                    </div>

                    <!-- Tabla de ubicaciones -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="data-table" id="locationsTable">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Piso</th>
                                        <th>Dirección</th>
                                        <th>Estado</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="locationsTableBody">
                                    <!-- Las ubicaciones se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección: Mantenimientos -->
                <section class="section" id="maintenanceSection" role="tabpanel" aria-labelledby="maintenance-tab">
                    <div class="section-title">
                        <h2>Gestión de Mantenimientos</h2>
                        <small>Administra los mantenimientos de activos</small>
                        <button class="btn btn-primary" id="addMaintenanceBtn">
                            <i class="fas fa-plus"></i> Nuevo Mantenimiento
                        </button>
                    </div>

                    <!-- Tabla de mantenimientos -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="data-table" id="maintenanceTable">
                                <thead>
                                    <tr>
                                        <th>Activo</th>
                                        <th>Tipo</th>
                                        <th>Descripción</th>
                                        <th>Fecha Inicio</th>
                                        <th>Fecha Fin</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceTableBody">
                                    <!-- Los mantenimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección: Marcas -->
                <section class="section" id="brandsSection" role="tabpanel" aria-labelledby="brands-tab">
                    <div class="section-title">
                        <h2>Gestión de Marcas</h2>
                        <small>Administra las marcas de los activos</small>
                        <button class="btn btn-primary" id="addBrandBtn">
                            <i class="fas fa-plus"></i> Nueva Marca
                        </button>
                    </div>

                    <!-- Filtros para marcas -->
                    <div class="assets-filters">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="brandsSearchInput" 
                                placeholder="Buscar marcas por nombre...">
                        </div>
                        
                        <div class="form-group">
                            <label for="brandsStatusFilter">Estado</label>
                            <select class="form-control" id="brandsStatusFilter">
                                <option value="">Todas las marcas</option>
                                <option value="active">Solo activas</option>
                                <option value="inactive">Solo inactivas</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cards de marcas -->
                    <div class="brands-grid" id="brandsGridContainer">
                        <!-- Las cards de marcas se cargarán aquí dinámicamente -->
                    </div>

                    <!-- Estado vacío -->
                    <div class="empty-state" id="brandsEmptyState">
                        <i class="fas fa-copyright"></i>
                        <h3>No hay marcas</h3>
                        <p>Las marcas aparecerán aquí como cards</p>
                        <button class="btn btn-primary" id="addBrandEmptyBtn" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Agregar Primera Marca
                        </button>
                    </div>
                </section>
                
            </div>
        </main>
    </div>

    <!-- Modal para agregar/editar activo -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="assetModalTitle">Nuevo Activo</h3>
                <button class="close-modal" id="closeAssetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <div class="form-row">
                        <div class="form-group locked-field">
                            <label for="assetCode">Código del Activo *</label>
                            <div style="position: relative;">
                                <input type="text" class="form-control" id="assetCode" required readonly 
                                    style="padding-right: 2.5rem;">
                                <i class="fas fa-lock" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>
                            </div>
                            <div class="error-message" id="codeError">El código es requerido</div>
                            <small style="color: var(--text-muted); font-size: 0.8rem;">
                                Código generado automáticamente - No editable
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="assetName">Nombre *</label>
                            <div style="position: relative;">
                                <input type="text" class="form-control" id="assetName" required readonly 
                                    style="padding-right: 2.5rem;">
                                <i class="fas fa-lock" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>
                            </div>
                            <div class="error-message" id="nameError">El nombre es requerido</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assetCategory">Categoría *</label>
                            <select class="form-control" id="assetCategory" required>
                                <option value="">Selecciona una categoría</option>
                            </select>
                            <div class="error-message" id="categoryError">La categoría es requerida</div>
                        </div>
                        <div class="form-group dependent-field">
                            <label for="assetType">Tipo *</label>
                            <select class="form-control" id="assetType" required disabled>
                                <option value="">Primero selecciona una categoría</option>
                            </select>
                            <div class="error-message" id="typeError">El tipo es requerido</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assetBrand">Marca</label>
                            <select class="form-control" id="assetBrand">
                                <option value="">Selecciona una marca</option>
                                <!-- Las marcas se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="form-group" style="position: relative;">
                            <label for="assetModel">Modelo</label>
                            <input type="text" class="form-control uppercase-field" id="assetModel" 
                                placeholder="Ej: PROBOOK 450 G8"
                                oninput="this.value = this.value.toUpperCase()"
                                onblur="this.value = this.value.toUpperCase()">
                            <small style="position: absolute; right: 10px; transform: translateY(50%); background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                                ABC
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="position: relative;">
                            <label for="assetSerial">Número de Serie</label>
                            <input type="text" class="form-control uppercase-field" id="assetSerial"
                                placeholder="Ej: 5CG1234567"
                                oninput="this.value = this.value.toUpperCase()"
                                onblur="this.value = this.value.toUpperCase()">
                            <small style="position: absolute; right: 10px; transform: translateY(50%); background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                                ABC
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="assetStatus">Condición *</label>
                            <select class="form-control" id="assetStatus" required>
                                <option value="">Selecciona una condición</option>
                            </select>
                            <div class="error-message" id="typeError">El tipo es requerido</div>
                            <!-- Agregar este elemento para mostrar la descripción -->
                            <div id="estadoDescription" style="margin-top: 0.5rem; padding: 0.75rem; background: var(--light-primary); border-radius: var(--border-radius-sm); border-left: 3px solid var(--primary-color); display: none;">
                                <small style="color: var(--text-muted); font-size: 0.8rem;">
                                    <strong>Descripción:</strong> <span id="estadoDescText">Selecciona una condición para ver su descripción</span>
                                </small>
                            </div>
                        </div>                    
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="assetLocation">Ubicación</label>
                            <select class="form-control" id="assetLocation">
                                <option value="">Sin ubicación</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assetUser">Usuario Asignado</label>
                            <select class="form-control" id="assetUser">
                                <option value="">Sin asignar</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">                    
                        <div class="form-group">
                            <label for="assetParent">Activo Padre</label>
                            <select class="form-control" id="assetParent">
                                <option value="">Sin padre</option>
                            </select>                         
                        </div>
                        <div class="form-group">
                            <label for="assetActive">Estado del Activo *</label>
                            <select class="form-control" id="assetActive" required>
                                <option value="true">ACTIVO</option>
                                <option value="false">INACTIVO</option>
                            </select>
                            <small style="color: var(--text-muted); font-size: 0.8rem;">
                                Selecciona el estado del activo en el sistema
                            </small>
                        </div>                        
                    </div>
                    <div class="form-group">
                        <label for="assetObservations">Observaciones <small style="color: var(--primary-color);">(MAYÚSCULAS)</small></label>
                        <textarea class="form-control uppercase-field" id="assetObservations" rows="3"
                                placeholder="TODAS LAS OBSERVACIONES SE GUARDARÁN EN MAYÚSCULAS"
                                oninput="this.value = this.value.toUpperCase()"
                                onblur="this.value = this.value.toUpperCase()"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAssetBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveAssetBtn">Guardar Activo</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar categoría -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Nueva Categoría</h3>
                <button class="close-modal" id="closeCategoryModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="categoryName">Nombre *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                        <div class="error-message" id="categoryNameError">El nombre es requerido</div>
                    </div>
                    <div class="form-group">
                        <label for="categoryDescription">Descripción</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCategoryBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveCategoryBtn">Guardar Categoría</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar tipo -->
    <div class="modal" id="typeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="typeModalTitle">Nuevo Tipo</h3>
                <button class="close-modal" id="closeTypeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="typeForm">
                    <div class="form-group">
                        <label for="typeName">Nombre *</label>
                        <input type="text" class="form-control" id="typeName" required>
                        <div class="error-message" id="typeNameError">El nombre es requerido</div>
                    </div>
                    <div class="form-group">
                        <label for="typeCategory">Categoría *</label>
                        <select class="form-control" id="typeCategory" required>
                            <option value="">Selecciona una categoría</option>
                        </select>
                        <div class="error-message" id="typeCategoryError">La categoría es requerida</div>
                    </div>
                    <div class="form-group">
                        <label for="typeDescription">Descripción</label>
                        <textarea class="form-control" id="typeDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTypeBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveTypeBtn">Guardar Tipo</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar ubicación -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="locationModalTitle">Nueva Ubicación</h3>
                <button class="close-modal" id="closeLocationModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="locationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationName">Nombre *</label>
                            <input type="text" class="form-control" id="locationName" required>
                            <div class="error-message" id="locationNameError">El nombre es requerido</div>
                        </div>
                        <div class="form-group">
                            <label for="locationType">Tipo *</label>
                            <select class="form-control" id="locationType" required>
                                <option value="">Selecciona un tipo</option>
                                <option value="EDIFICIO">EDIFICIO</option>
                                <option value="PLANTA">PLANTA</option>
                                <option value="OFICINA">OFICINA</option>
                                <option value="ALMACÉN">ALMACÉN</option>
                            </select>
                            <div class="error-message" id="locationTypeError">El tipo es requerido</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationFloor">Piso</label>
                            <input type="text" class="form-control" id="locationFloor">
                        </div>
                        <div class="form-group">
                            <label for="locationParent">Ubicación Padre</label>
                            <select class="form-control" id="locationParent">
                                <option value="">Sin padre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationAddress">Dirección</label>
                        <input type="text" class="form-control" id="locationAddress">
                    </div>
                    
                    <div class="form-group">
                        <label for="locationDescription">Descripción</label>
                        <textarea class="form-control" id="locationDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationStatus">Activo</label>
                        <select class="form-control" id="locationStatus">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLocationBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveLocationBtn">Guardar Ubicación</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar mantenimiento -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="maintenanceModalTitle">Nuevo Mantenimiento</h3>
                <button class="close-modal" id="closeMaintenanceModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceAsset">Activo *</label>
                            <select class="form-control" id="maintenanceAsset" required>
                                <option value="">Selecciona un activo</option>
                            </select>
                            <div class="error-message" id="maintenanceAssetError">El activo es requerido</div>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceType">Tipo *</label>
                            <select class="form-control" id="maintenanceType" required>
                                <option value="">Selecciona un tipo</option>
                                <option value="preventivo">Preventivo</option>
                                <option value="correctivo">Correctivo</option>
                            </select>
                            <div class="error-message" id="maintenanceTypeError">El tipo es requerido</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceDescription">Descripción *</label>
                        <textarea class="form-control" id="maintenanceDescription" required rows="3"></textarea>
                        <div class="error-message" id="maintenanceDescriptionError">La descripción es requerida</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceStartDate">Fecha de Inicio *</label>
                            <input type="date" class="form-control" id="maintenanceStartDate" required>
                            <div class="error-message" id="maintenanceStartDateError">La fecha de inicio es requerida</div>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceEndDate">Fecha de Fin</label>
                            <input type="date" class="form-control" id="maintenanceEndDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceObservations">Observaciones</label>
                        <textarea class="form-control" id="maintenanceObservations" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelMaintenanceBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveMaintenanceBtn">Guardar Mantenimiento</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles del activo -->
    <div class="modal" id="assetDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalAssetTitle">Detalles del Activo</h3>
                <button class="close-modal" id="closeAssetDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="assetDetailsContent">
                <!-- Los detalles del activo se cargarán aquí dinámicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="closeAssetDetailsBtn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar marca -->
    <div class="modal" id="brandModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="brandModalTitle">Nueva Marca</h3>
                <button class="close-modal" id="closeBrandModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="brandForm">
                    <div class="form-group">
                        <label for="brandName">Nombre *</label>
                        <input type="text" class="form-control" id="brandName" required>
                        <div class="error-message" id="brandNameError">El nombre es requerido</div>
                    </div>
                    <div class="form-group">
                        <label for="brandDescription">Descripción</label>
                        <textarea class="form-control" id="brandDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <!-- CAMBIADO: Estado → Activo como checkbox -->
                        <label for="brandActive" style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="brandActive" checked>
                            <span>Marca Activa</span>
                        </label>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            Desmarca para desactivar esta marca
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBrandBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveBrandBtn">Guardar Marca</button>
            </div>
        </div>
    </div>

    <!-- Modal para gestión de direcciones IP -->
    <div class="modal" id="ipManagementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ipModalTitle">Gestión de Direcciones IP</h3>
                <button class="close-modal" id="closeIpModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="currentIPsContainer">
                    <!-- Las IPs actuales se mostrarán aquí -->
                </div>
                
                <form id="ipForm" style="margin-top: 1.5rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipAddress">Dirección IP *</label>
                            <input type="text" class="form-control" id="ipAddress" required
                                placeholder="192.168.1.100" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$">
                            <div class="error-message" id="ipError">Formato de IP inválido</div>
                        </div>
                        <div class="form-group">
                            <label for="ipMAC">Dirección MAC</label>
                            <input type="text" class="form-control" id="ipMAC" 
                                placeholder="00:1B:44:11:3A:B7"
                                pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$|^([0-9A-Fa-f]{12})$">
                            <small style="color: var(--text-muted); font-size: 0.8rem;">
                                Formatos válidos: 00:1B:44:11:3A:B7, 00-1B-44-11-3A-B7, 001B44113AB7
                            </small>
                            <!-- AGREGAR ESTE ELEMENTO PARA ERRORES DE MAC -->
                            <div class="error-message" id="macError">Formato de MAC inválido</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipSubnet">Máscara de Subred</label>
                            <input type="text" class="form-control" id="ipSubnet" 
                                value="255.255.255.0">
                        </div>
                        <div class="form-group">
                            <label for="ipGateway">Gateway</label>
                            <input type="text" class="form-control" id="ipGateway" 
                                placeholder="192.168.1.1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipDNS1">DNS Primario</label>
                            <input type="text" class="form-control" id="ipDNS1" 
                                placeholder="8.8.8.8">
                        </div>
                        <div class="form-group">
                            <label for="ipDNS2">DNS Secundario</label>
                            <input type="text" class="form-control" id="ipDNS2" 
                                placeholder="8.8.4.4">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipType">Tipo de Conexión</label>
                            <select class="form-control" id="ipType">
                                <option value="ETHERNET">Ethernet</option>
                                <option value="WIFI">Wi-Fi</option>
                                <option value="LOOPBACK">Loopback</option>
                                <option value="VIRTUAL">Virtual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ipActive" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="ipActive" checked>
                                <span>IP Activa</span>
                            </label>
                            <small style="color: var(--text-muted); font-size: 0.8rem;">
                                Desmarca para desactivar esta IP
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ipObservations">Observaciones</label>
                        <textarea class="form-control" id="ipObservations" rows="2" 
                                placeholder="Descripción de la configuración de red..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelIpBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveIpBtn">Guardar IP</button>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Operación completada con éxito</span>
        <button class="toast-close" aria-label="Cerrar notificación">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando...</div>
    </div>

    <script>
        // ===== CONFIGURACIÓN DE SUPABASE =====
        const SUPABASE_URL = 'https://fzdwqkoporxnzvhpmlls.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6ZHdxa29wb3J4bnp2aHBtbGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDkxMDYsImV4cCI6MjA3NzM4NTEwNn0.nOS3oByMmopchYhH0Kv1I0lxi02VkqfsC-eGFTZ_ePg';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // También capturar errores de promesas
        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Promesa rechazada:', e.reason);
        });

        // ===== ESTADO DE LA APLICACIÓN =====
        const AppState = {
            isLoading: false,
            userData: null,
            currentUser: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            currentTab: 'assets',
            assets: [],
            categories: [],
            types: [],
            locations: [],
            users: [],
            maintenance: [],
            brands: [],
            currentEditingBrand: null,
            currentEditingAsset: null,
            currentEditingCategory: null,
            currentEditingType: null,
            currentEditingLocation: null,
            currentEditingMaintenance: null,
            assetsPagination: {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1,
                totalItems: 0
            },
            assetsFilters: {
                search: '',
                status: '',
                category: '',
                type: ''
            }
        };

        // ===== SISTEMA DE PROGRESO PARA EXPORTACIÓN =====
        const exportProgress = {
            elements: {},
            isCancelled: false,
            
            init: function() {
                if (!document.getElementById('exportProgressContainer')) {
                    const progressHtml = `
                        <div id="exportProgressContainer" class="export-progress" style="display: none;">
                            <div class="export-progress-content">
                                <div style="margin-bottom: 1.5rem;">
                                    <i class="fas fa-file-export" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                    <h3 style="margin: 0.5rem 0; color: var(--text-color);" id="exportProgressTitle">Exportando Activos</h3>
                                    <p style="margin: 0; color: var(--text-muted);" id="exportProgressSubtitle">Preparando documento...</p>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="color: var(--text-color); font-size: 0.9rem;" id="exportProgressText">0%</span>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;" id="exportProgressCount">0/0</span>
                                    </div>
                                    <div class="export-progress-bar">
                                        <div id="exportProgressFill" class="export-progress-fill"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <p style="margin: 0; color: var(--text-color); font-size: 0.9rem;" id="exportProgressStatus">Iniciando exportación...</p>
                                </div>
                                
                                <button class="btn btn-danger" id="exportProgressCancelBtn">
                                    <i class="fas fa-times"></i> Cancelar Exportación
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', progressHtml);
                }
                
                this.elements = {
                    container: document.getElementById('exportProgressContainer'),
                    title: document.getElementById('exportProgressTitle'),
                    subtitle: document.getElementById('exportProgressSubtitle'),
                    progressFill: document.getElementById('exportProgressFill'),
                    progressText: document.getElementById('exportProgressText'),
                    progressCount: document.getElementById('exportProgressCount'),
                    status: document.getElementById('exportProgressStatus'),
                    cancelBtn: document.getElementById('exportProgressCancelBtn')
                };
                
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.addEventListener('click', () => {
                        this.cancel();
                    });
                }
            },
            
            show: function(totalItems, formatType) {
                this.init();
                this.isCancelled = false;
                
                const formatNames = {
                    'pdf': 'PDF',
                    'excel': 'Excel'
                };
                
                if (this.elements.title) {
                    this.elements.title.textContent = `Exportando a ${formatNames[formatType]}`;
                }
                
                if (this.elements.subtitle) {
                    this.elements.subtitle.textContent = totalItems === 1 ? 
                        'Exportando 1 activo...' : 
                        `Exportando ${totalItems} activos...`;
                }
                
                this.updateProgress(0, 0, totalItems);
                this.updateStatus('Preparando datos para exportación...');
                
                if (this.elements.container) {
                    this.elements.container.style.display = 'flex';
                }
            },
            
            updateProgress: function(percentage, current, total) {
                if (this.isCancelled) return;
                
                const progress = Math.min(100, Math.max(0, percentage));
                
                if (this.elements.progressFill) {
                    this.elements.progressFill.style.width = progress + '%';
                }
                
                if (this.elements.progressText) {
                    this.elements.progressText.textContent = Math.round(progress) + '%';
                }
                
                if (this.elements.progressCount) {
                    this.elements.progressCount.textContent = `${current}/${total}`;
                }
            },
            
            updateStatus: function(message) {
                if (this.isCancelled) return;
                
                if (this.elements.status) {
                    this.elements.status.textContent = message;
                }
            },
            
            showSuccess: function() {
                if (this.isCancelled) return;
                
                this.updateProgress(100);
                this.updateStatus('✅ Exportación completada exitosamente');
                
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.innerHTML = '<i class="fas fa-check"></i> Cerrar';
                    this.elements.cancelBtn.className = 'btn btn-success';
                    this.elements.cancelBtn.onclick = () => this.hide();
                }
            },
            
            showError: function(error) {
                console.error('Error en exportación:', error);
                
                this.updateStatus(`❌ Error: ${error.message || 'Error desconocido'}`);
                
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cerrar';
                    this.elements.cancelBtn.className = 'btn btn-danger';
                    this.elements.cancelBtn.onclick = () => this.hide();
                }
            },
            
            cancel: function() {
                this.isCancelled = true;
                this.updateStatus('⏹️ Exportación cancelada por el usuario');
                
                setTimeout(() => {
                    this.hide();
                }, 2000);
            },
            
            hide: function() {
                if (this.elements.container) {
                    this.elements.container.style.display = 'none';
                }
                this.isCancelled = false;
            }
        };

        // ===== SISTEMA DE PROGRESO PARA PDF =====
        const pdfProgress = {
            // Elementos del DOM
            elements: {},
            
            // Estado
            isCancelled: false,
            
            // Inicializar elementos
            init: function() {
                // Crear contenedor de progreso si no existe
                if (!document.getElementById('pdfProgressContainer')) {
                    const progressHtml = `
                        <div id="pdfProgressContainer" class="loading-overlay" style="display: none; background: rgba(0,0,0,0.8);">
                            <div style="background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius-lg); max-width: 500px; width: 90%; text-align: center;">
                                <!-- Header -->
                                <div style="margin-bottom: 1.5rem;">
                                    <i class="fas fa-file-pdf" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                                    <h3 style="margin: 0.5rem 0; color: var(--text-color);" id="pdfProgressTitle">Generando PDF</h3>
                                    <p style="margin: 0; color: var(--text-muted);" id="pdfProgressSubtitle">Preparando documento...</p>
                                </div>
                                
                                <!-- Barra de progreso -->
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="color: var(--text-color); font-size: 0.9rem;" id="pdfProgressText">0%</span>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;" id="pdfProgressCount">0/0</span>
                                    </div>
                                    <div style="background: var(--light-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div id="pdfProgressBar" style="background: var(--primary-color); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                
                                <!-- Pasos -->
                                <div style="margin-bottom: 1.5rem;">
                                    <div class="progress-step active" style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                        <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                            <i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>
                                        </div>
                                        <span style="color: var(--text-color);">Preparando documento</span>
                                    </div>
                                    <div class="progress-step" style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                        <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                            <i class="fas fa-check" style="color: transparent; font-size: 0.8rem;"></i>
                                        </div>
                                        <span style="color: var(--text-muted);">Generando contenido</span>
                                    </div>
                                    <div class="progress-step" style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                                        <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                            <i class="fas fa-check" style="color: transparent; font-size: 0.8rem;"></i>
                                        </div>
                                        <span style="color: var(--text-muted);">Creando códigos QR</span>
                                    </div>
                                    <div class="progress-step" style="display: flex; align-items: center;">
                                        <div class="step-icon" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                            <i class="fas fa-check" style="color: transparent; font-size: 0.8rem;"></i>
                                        </div>
                                        <span style="color: var(--text-muted);">Finalizando PDF</span>
                                    </div>
                                </div>
                                
                                <!-- Estado actual -->
                                <div style="margin-bottom: 1.5rem;">
                                    <p style="margin: 0; color: var(--text-color); font-size: 0.9rem;" id="pdfProgressStatus">Iniciando generación de PDF...</p>
                                </div>
                                
                                <!-- Botón cancelar -->
                                <button class="btn btn-danger" id="pdfProgressCancelBtn" style="width: 100%;">
                                    <i class="fas fa-times"></i> Cancelar Generación
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', progressHtml);
                }
                
                // Guardar referencias a los elementos
                this.elements = {
                    container: document.getElementById('pdfProgressContainer'),
                    title: document.getElementById('pdfProgressTitle'),
                    subtitle: document.getElementById('pdfProgressSubtitle'),
                    progressBar: document.getElementById('pdfProgressBar'),
                    progressText: document.getElementById('pdfProgressText'),
                    progressCount: document.getElementById('pdfProgressCount'),
                    status: document.getElementById('pdfProgressStatus'),
                    cancelBtn: document.getElementById('pdfProgressCancelBtn'),
                    steps: document.querySelectorAll('.progress-step')
                };
                
                // Configurar evento de cancelación
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.addEventListener('click', () => {
                        this.cancel();
                    });
                }
            },
            
            // Mostrar progreso
            show: function(totalItems, formatType) {
                this.init();
                this.isCancelled = false;
                
                const formatNames = {
                    'asset-small-horizontal': 'Etiquetas Pequeñas',
                    'asset-medium-horizontal': 'Etiquetas Medianas',
                    'asset-inventory-summary': 'Inventario de Activos'
                };
                
                if (this.elements.title) {
                    this.elements.title.textContent = `Generando ${formatNames[formatType] || 'PDF'}`;
                }
                
                if (this.elements.subtitle) {
                    this.elements.subtitle.textContent = totalItems === 1 ? 
                        'Generando etiqueta individual...' : 
                        `Generando ${totalItems} etiquetas...`;
                }
                
                this.updateProgress(0, 0, totalItems);
                this.updateStatus('Iniciando generación de documento...');
                this.resetSteps();
                
                if (this.elements.container) {
                    this.elements.container.style.display = 'flex';
                }
            },
            
            // Actualizar progreso
            updateProgress: function(percentage, current, total) {
                if (this.isCancelled) return;
                
                const progress = Math.min(100, Math.max(0, percentage));
                
                if (this.elements.progressBar) {
                    this.elements.progressBar.style.width = progress + '%';
                }
                
                if (this.elements.progressText) {
                    this.elements.progressText.textContent = Math.round(progress) + '%';
                }
                
                if (this.elements.progressCount) {
                    this.elements.progressCount.textContent = `${current}/${total}`;
                }
            },
            
            // Actualizar estado
            updateStatus: function(message, type = 'info') {
                if (this.isCancelled) return;
                
                if (this.elements.status) {
                    this.elements.status.textContent = message;
                    
                    // Cambiar color según el tipo
                    const colors = {
                        info: 'var(--text-color)',
                        success: 'var(--success-color)',
                        warning: 'var(--warning-color)',
                        error: 'var(--danger-color)'
                    };
                    
                    this.elements.status.style.color = colors[type] || colors.info;
                }
            },
            
            // Actualizar pasos
            updateStep: function(stepNumber, status) {
                if (this.isCancelled) return;
                
                const steps = this.elements.steps;
                if (steps && steps[stepNumber - 1]) {
                    const step = steps[stepNumber - 1];
                    const icon = step.querySelector('.step-icon');
                    const text = step.querySelector('span');
                    
                    if (status === 'active') {
                        icon.style.background = 'var(--primary-color)';
                        icon.style.border = 'none';
                        icon.querySelector('i').style.color = 'white';
                        if (text) text.style.color = 'var(--text-color)';
                    } else if (status === 'completed') {
                        icon.style.background = 'var(--success-color)';
                        icon.style.border = 'none';
                        icon.querySelector('i').style.color = 'white';
                        if (text) text.style.color = 'var(--text-color)';
                    }
                }
            },
            
            // Resetear pasos
            resetSteps: function() {
                const steps = this.elements.steps;
                if (steps) {
                    steps.forEach((step, index) => {
                        const icon = step.querySelector('.step-icon');
                        const text = step.querySelector('span');
                        
                        if (index === 0) {
                            // Primer paso activo
                            icon.style.background = 'var(--primary-color)';
                            icon.style.border = 'none';
                            icon.querySelector('i').style.color = 'white';
                            if (text) text.style.color = 'var(--text-color)';
                        } else {
                            // Otros pasos inactivos
                            icon.style.background = 'transparent';
                            icon.style.border = '2px solid var(--border-color)';
                            icon.querySelector('i').style.color = 'transparent';
                            if (text) text.style.color = 'var(--text-muted)';
                        }
                    });
                }
            },
            
            // Mostrar éxito
            showSuccess: function() {
                if (this.isCancelled) return;
                
                this.updateProgress(100);
                this.updateStatus('✅ PDF generado exitosamente', 'success');
                
                // Marcar todos los pasos como completados
                const steps = this.elements.steps;
                if (steps) {
                    steps.forEach(step => {
                        const icon = step.querySelector('.step-icon');
                        const text = step.querySelector('span');
                        
                        icon.style.background = 'var(--success-color)';
                        icon.style.border = 'none';
                        icon.querySelector('i').style.color = 'white';
                        if (text) text.style.color = 'var(--text-color)';
                    });
                }
                
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.innerHTML = '<i class="fas fa-check"></i> Cerrar';
                    this.elements.cancelBtn.className = 'btn btn-success';
                    this.elements.cancelBtn.onclick = () => this.hide();
                }
            },
            
            // Mostrar error
            showError: function(error) {
                console.error('Error en generación de PDF:', error);
                
                this.updateStatus(`❌ Error: ${error.message || 'Error desconocido'}`, 'error');
                
                if (this.elements.cancelBtn) {
                    this.elements.cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cerrar';
                    this.elements.cancelBtn.className = 'btn btn-danger';
                    this.elements.cancelBtn.onclick = () => this.hide();
                }
            },
            
            // Cancelar
            cancel: function() {
                this.isCancelled = true;
                this.updateStatus('⏹️ Generación cancelada por el usuario', 'warning');
                
                setTimeout(() => {
                    this.hide();
                }, 2000);
            },
            
            // Ocultar
            hide: function() {
                if (this.elements.container) {
                    this.elements.container.style.display = 'none';
                }
                this.isCancelled = false;
            }
        };

        // Estado para filtros de marcas
        AppState.brandsFilters = {
            search: '',
            status: ''
        };

        function filterBrands() {
            let filtered = AppState.brands;
            
            // Filtro de búsqueda
            if (AppState.brandsFilters.search) {
                const searchTerm = AppState.brandsFilters.search.toLowerCase();
                filtered = filtered.filter(brand => 
                    brand.nombre.toLowerCase().includes(searchTerm) ||
                    (brand.descripcion && brand.descripcion.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtro de estado
            if (AppState.brandsFilters.status) {
                if (AppState.brandsFilters.status === 'active') {
                    filtered = filtered.filter(brand => brand.activo);
                } else if (AppState.brandsFilters.status === 'inactive') {
                    filtered = filtered.filter(brand => !brand.activo);
                }
            }
            
            return filtered;
        }

        // ===== INICIALIZACIÓN DE LA APLICACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando Sistema de Activos TI para Administradores...');
            
            // Verificar dependencias
            if (typeof supabase === 'undefined') {
                console.error('❌ Supabase no está cargado');
                showToast('Error: No se pudo conectar con el servidor', 'error');
                return;
            }
            
            // Verificar que AuthChecker esté disponible
            if (typeof AuthChecker === 'undefined') {
                console.error('❌ AuthChecker no está cargado');
                showToast('Error: No se pudo cargar el sistema de autenticación', 'error');
                return;
            }
            
            // Inicializar la aplicación
            initializeApp();
            
            console.log('✅ Sistema de Activos TI para Administradores inicializado correctamente');
        });

        // ===== INICIALIZAR APLICACIÓN =====
        async function initializeApp() {
            try {
                console.log('🔄 Inicializando aplicación de Activos TI para Administradores...');
                
                // ✅ USAR AUTHCHECKER PARA VERIFICAR SESIÓN
                const sesionValida = AuthChecker.verificarSesionOptimizada();
                
                if (!sesionValida) {
                    console.log('🚫 No hay sesión activa - Redirigiendo al portal');
                    showToast('No hay sesión activa. Redirigiendo al portal...', 'warning');
                    
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 2000);
                    return;
                }
                
                // ✅ OBTENER DATOS DEL USUARIO DESDE AUTHCHECKER
                const userData = AuthChecker.obtenerDatosUsuario();

                if (userData && typeof userData === 'object' && userData.userEmail) {
                    console.log('✅ Sesión AuthChecker encontrada:', userData.userEmail);
                    
                    // Configurar el estado de la aplicación
                    AppState.currentUser = {
                        userName: userData.userName || 'Administrador',
                        userEmail: userData.userEmail,
                        userRole: 'administrador',
                        userId: userData.userId || 'admin-uuid'
                    };
                    
                    console.log('🎯 Aplicación configurada para administrador');
                    
                    // Configurar event listeners
                    setupEventListeners();
                    
                    // Cargar aplicación
                    await loadApplication();
                    
                    showToast('Sistema de activos cargado correctamente', 'success');
                    
                } else {
                    throw new Error('No se pudieron obtener datos de usuario válidos de AuthChecker');
                }
                
            } catch (error) {
                console.error('❌ Error inicializando aplicación:', error);
                
                if (error.message.includes('no está autorizado')) {
                    showToast(error.message, 'error');
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 4000);
                } else {
                    showToast('Error al cargar la aplicación: ' + error.message, 'error');
                    
                    // Mostrar interfaz de error
                    const appElement = document.getElementById('app');
                    if (appElement) {
                        appElement.innerHTML = `
                            <div style="padding: 2rem; text-align: center;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
                                <h3>Error al cargar la aplicación</h3>
                                <p>${error.message}</p>
                                <button class="btn btn-primary" onclick="window.location.reload()">
                                    <i class="fas fa-redo"></i> Reintentar
                                </button>
                            </div>
                        `;
                        appElement.style.display = 'block';
                    }
                }
            }
        }

        // ===== INICIALIZACIÓN COMPLETA DEL SISTEMA DE EXPORTACIÓN =====
        function initializeExportSystem() {
            console.log('🚀 Inicializando sistema de exportación...');
            
            // Ejecutar después de que la página esté completamente cargada
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(() => {
                        forceAddExportButton();
                        ensureExportButtonExists();
                    }, 2000);
                });
            } else {
                setTimeout(() => {
                    forceAddExportButton();
                    ensureExportButtonExists();
                }, 2000);
            }
            
            // Verificación final después de 5 segundos
            setTimeout(() => {
                const finalCheck = document.getElementById('exportAssetsBtn');
                if (!finalCheck) {
                    console.warn('⚠️ Botón aún no existe después de 5 segundos, aplicando solución nuclear...');
                    nuclearExportButtonSolution();
                }
            }, 5000);
        }

        // Llamar a la inicialización cuando se carga la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM cargado, preparando sistema de exportación...');
            initializeExportSystem();
        });

        // ===== CARGA DE LA APLICACIÓN =====
        async function loadApplication() {
            try {
                // Verificar que exista el usuario
                if (!AppState.currentUser) {
                    throw new Error('No hay datos de usuario disponibles');
                }
                
                // Aplicar tema
                if (AppState.darkMode) {
                    document.body.classList.add('dark-mode');
                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Mostrar información del usuario
                updateUserInterface();
                
                // Cargar datos necesarios
                await loadCategories();
                await loadTypes();
                await loadLocations();
                await loadUsers();
                await loadBrands();
                await loadMaintenance();
                await loadStatuses(); 
                await loadCurrentUserData();
                
                // Inicializar sistema de IPs
                setupIPEventListeners();

                // Mostrar la aplicación
                document.getElementById('app').style.display = 'block';
                
                // Cargar datos iniciales
                await loadAssets();
                
                console.log('✅ Aplicación cargada completamente');
                
            } catch (error) {
                console.error('❌ Error cargando aplicación:', error);
                throw error;
            }
        }

        // Función para cargar TODAS las opciones de estado posibles
        async function loadAllStatusOptions() {
            console.log('🎯 Cargando TODAS las opciones de estado posibles...');
            
            // Lista completa de todos los estados posibles que podrían existir
            const allPossibleStatuses = [
                // Español (varias variaciones)
                'OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA',
                'EN_REPARACION', 'EN_ALMACEN', 'DADO_DE_BAJA',
                'operativo', 'en reparacion', 'en almacen', 'dado de baja',
                'en_reparacion', 'en_almacen', 'dado_de_baja',
                
                // Alternativos en español
                'ACTIVO', 'INACTIVO', 'MANTENIMIENTO', 'BAJA',
                'activo', 'inactivo', 'mantenimiento', 'baja',
                'DISPONIBLE', 'ASIGNADO', 'disponible', 'asignado',
                
                // Inglés
                'ACTIVE', 'INACTIVE', 'MAINTENANCE', 'RETIRED',
                'AVAILABLE', 'ASSIGNED', 'active', 'inactive',
                
                // Otros posibles
                'FUNCIONAL', 'NO_FUNCIONAL', 'funcional', 'no_funcional',
                'SERVICIO', 'FUERA_SERVICIO', 'servicio', 'fuera_servicio',
                'EN_USO', 'EN_STOCK', 'en_uso', 'en_stock'
            ];
            
            // Eliminar duplicados y ordenar
            const uniqueStatuses = [...new Set(allPossibleStatuses)].sort();
            
            console.log('🎯 Total de estados a mostrar:', uniqueStatuses.length);
            console.log('📋 Estados:', uniqueStatuses);
            
            updateStatusSelectOptions(uniqueStatuses);
            return uniqueStatuses;
        }

        // Función para actualizar las opciones del select de estado
        function updateStatusSelectOptions(validStatuses) {
            const statusSelect = document.getElementById('assetStatus');
            if (!statusSelect) {
                console.error('❌ No se encontró el elemento assetStatus');
                return;
            }
            
            console.log('🔄 Actualizando opciones de estado con:', validStatuses);
            
            // Limpiar opciones existentes
            statusSelect.innerHTML = '';
            
            // Si no hay estados válidos, usar una lista completa
            if (!validStatuses || validStatuses.length === 0) {
                validStatuses = [
                    'OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA',
                    'ACTIVO', 'INACTIVO', 'MANTENIMIENTO', 'BAJA'
                ];
            }
            
            // Mapeo completo de estados
            const statusTextMap = {
                // Español estándar
                'OPERATIVO': 'Operativo',
                'EN REPARACION': 'En Reparación', 
                'EN ALMACEN': 'En Almacén',
                'DADO DE BAJA': 'Dado de Baja',
                
                // Español con guiones bajos
                'EN_REPARACION': 'En Reparación',
                'EN_ALMACEN': 'En Almacén',
                'DADO_DE_BAJA': 'Dado de Baja',
                
                // Minúsculas
                'operativo': 'Operativo',
                'en reparacion': 'En Reparación',
                'en almacen': 'En Almacén', 
                'dado de baja': 'Dado de Baja',
                'en_reparacion': 'En Reparación',
                'en_almacen': 'En Almacén',
                'dado_de_baja': 'Dado de Baja',
                
                // Alternativos
                'ACTIVO': 'Activo',
                'INACTIVO': 'Inactivo',
                'MANTENIMIENTO': 'En Mantenimiento',
                'BAJA': 'Dado de Baja',
                'DISPONIBLE': 'Disponible',
                'ASIGNADO': 'Asignado',
                'disponible': 'Disponible',
                'asignado': 'Asignado',
                
                // Inglés
                'ACTIVE': 'Activo',
                'INACTIVE': 'Inactivo', 
                'MAINTENANCE': 'En Mantenimiento',
                'RETIRED': 'Dado de Baja',
                'AVAILABLE': 'Disponible',
                'ASSIGNED': 'Asignado',
                'active': 'Activo',
                'inactive': 'Inactivo',
                
                // Otros
                'FUNCIONAL': 'Funcional',
                'NO_FUNCIONAL': 'No Funcional',
                'funcional': 'Funcional',
                'no_funcional': 'No Funcional',
                'SERVICIO': 'En Servicio',
                'FUERA_SERVICIO': 'Fuera de Servicio',
                'servicio': 'En Servicio',
                'fuera_servicio': 'Fuera de Servicio',
                'EN_USO': 'En Uso',
                'EN_STOCK': 'En Stock',
                'en_uso': 'En Uso',
                'en_stock': 'En Stock'
            };
            
            // Agregar todas las opciones
            validStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = statusTextMap[status] || formatStatusText(status);
                statusSelect.appendChild(option);
            });
            
            // Establecer "Operativo" como valor por defecto
            statusSelect.value = 'OPERATIVO';
            
            console.log('✅ Opciones de estado actualizadas. Total:', statusSelect.options.length);
            
            // Mostrar en consola todas las opciones disponibles
            const optionsArray = Array.from(statusSelect.options).map(opt => ({
                value: opt.value, 
                text: opt.textContent
            }));
            console.log('📋 Todas las opciones disponibles:', optionsArray);
        }

        // Función auxiliar para formatear texto de estado
        function formatStatusText(status) {
            if (!status) return 'Desconocido';
            
            return status
                .toLowerCase()
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Función alternativa más robusta
        async function getAllValidStatusValues() {
            try {
                console.log('🔍 Obteniendo todos los estados válidos...');
                
                // Intentar diferentes métodos para obtener los estados
                
                // Método A: Consulta directa usando rpc (si está disponible)
                try {
                    const { data, error } = await supabase.rpc('get_estado_values');
                    if (!error && data) {
                        console.log('✅ Estados desde RPC:', data);
                        return data;
                    }
                } catch (rpcError) {
                    console.log('ℹ️ RPC no disponible, probando otros métodos...');
                }
                
                // Método B: Consultar pg_enum directamente (para tipos ENUM)
                try {
                    const { data, error } = await supabase
                        .from('pg_enum')
                        .select('enumlabel')
                        .in('enumtypid', 
                            supabase.from('pg_type')
                            .select('oid')
                            .ilike('typname', '%estado%')
                        );
                    
                    if (!error && data && data.length > 0) {
                        const statusValues = data.map(item => item.enumlabel);
                        console.log('✅ Estados desde pg_enum:', statusValues);
                        return statusValues;
                    }
                } catch (enumError) {
                    console.log('ℹ️ pg_enum no disponible...');
                }
                
                // Método C: Consultar information_schema para CHECK constraints
                try {
                    const query = `
                        SELECT pg_get_constraintdef(oid) as constraint_def 
                        FROM pg_constraint 
                        WHERE conrelid = 'activo'::regclass 
                        AND contype = 'c'
                        AND pg_get_constraintdef(oid) LIKE '%estado%'
                    `;
                    
                    // Para Supabase, necesitamos usar una función RPC personalizada
                    // Por ahora, usaremos valores por defecto
                    
                } catch (constraintError) {
                    console.log('ℹ️ No se pudieron obtener constraints...');
                }
                
                // Método D: Intentar insertar valores de prueba (solo para desarrollo)
                console.log('🧪 Probando valores de estado comunes...');
                
                const testStatuses = [
                    'OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA',
                    'OPERATIVO', 'EN_REPARACION', 'EN_ALMACEN', 'DADO_DE_BAJA',
                    'operativo', 'en reparacion', 'en almacen', 'dado de baja',
                    'operativo', 'en_reparacion', 'en_almacen', 'dado_de_baja',
                    'ACTIVO', 'INACTIVO', 'MANTENIMIENTO', 'BAJA',
                    'activo', 'inactivo', 'mantenimiento', 'baja',
                    'ACTIVE', 'INACTIVE', 'MAINTENANCE', 'RETIRED'
                ];
                
                // Devolver todos los posibles estados para probar
                console.log('🎯 Devolviendo todos los estados posibles para prueba:', testStatuses);
                return [...new Set(testStatuses)]; // Eliminar duplicados
                
            } catch (error) {
                console.error('Error en getAllValidStatusValues:', error);
                return ['OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA'];
            }
        }

        // Función para actualizar las opciones del select de estado
        function updateStatusSelectOptions(validStatuses) {
            const statusSelect = document.getElementById('assetStatus');
            if (!statusSelect) {
                console.error('❌ No se encontró el elemento assetStatus');
                return;
            }
            
            console.log('🔄 Actualizando opciones de estado con:', validStatuses);
            
            // Limpiar opciones existentes
            statusSelect.innerHTML = '';
            
            // Si no hay estados válidos, usar una lista completa
            if (!validStatuses || validStatuses.length === 0) {
                validStatuses = [
                    'OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA',
                    'ACTIVO', 'INACTIVO', 'MANTENIMIENTO', 'BAJA'
                ];
            }
            
            // Mapeo completo de estados
            const statusTextMap = {
                // Español estándar
                'OPERATIVO': 'Operativo',
                'EN REPARACION': 'En Reparación', 
                'EN ALMACEN': 'En Almacén',
                'DADO DE BAJA': 'Dado de Baja',
                
                // Español con guiones bajos
                'EN_REPARACION': 'En Reparación',
                'EN_ALMACEN': 'En Almacén',
                'DADO_DE_BAJA': 'Dado de Baja',
                
                // Minúsculas
                'operativo': 'Operativo',
                'en reparacion': 'En Reparación',
                'en almacen': 'En Almacén', 
                'dado de baja': 'Dado de Baja',
                'en_reparacion': 'En Reparación',
                'en_almacen': 'En Almacén',
                'dado_de_baja': 'Dado de Baja',
                
                // Alternativos
                'ACTIVO': 'Activo',
                'INACTIVO': 'Inactivo',
                'MANTENIMIENTO': 'En Mantenimiento',
                'BAJA': 'Dado de Baja',
                'DISPONIBLE': 'Disponible',
                'ASIGNADO': 'Asignado',
                
                // Inglés
                'ACTIVE': 'Activo',
                'INACTIVE': 'Inactivo', 
                'MAINTENANCE': 'En Mantenimiento',
                'RETIRED': 'Dado de Baja'
            };
            
            // Agregar todas las opciones
            validStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = statusTextMap[status] || formatStatusText(status);
                statusSelect.appendChild(option);
            });
            
            console.log('✅ Opciones de estado actualizadas. Total:', statusSelect.options.length);
            
            // Mostrar en consola todas las opciones disponibles
            const optionsArray = Array.from(statusSelect.options).map(opt => ({
                value: opt.value, 
                text: opt.textContent
            }));
            console.log('📋 Todas las opciones disponibles:', optionsArray);
        }

        // Función auxiliar para formatear texto de estado
        function formatStatusText(status) {
            if (!status) return 'Desconocido';
            
            return status
                .toLowerCase()
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        // ===== CARGA DE DATOS =====
        async function loadCategories() {
            try {
                console.log('📂 Cargando categorías desde Supabase...');
                
                const { data, error } = await supabase
                    .from('categoria_activo')
                    .select('*')
                    .order('nombre');
                
                if (error) {
                    throw new Error(`Error al cargar categorías: ${error.message}`);
                }
                
                AppState.categories = data || [];
                console.log(`✅ ${AppState.categories.length} categorías cargadas`);
                
                // Actualizar selects de categorías
                updateCategorySelects();
                
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
                showToast('Error al cargar las categorías', 'warning');
            }
        }

        async function loadTypes() {
            try {
                console.log('📂 Cargando tipos desde Supabase...');
                
                const { data, error } = await supabase
                    .from('tipo_activo')
                    .select(`
                        *,
                        categoria_activo: categoria_activo_id (id, nombre)
                    `)
                    .order('nombre');
                
                if (error) {
                    throw new Error(`Error al cargar tipos: ${error.message}`);
                }
                
                AppState.types = data || [];
                console.log(`✅ ${AppState.types.length} tipos cargados`);
                
                // Debug: mostrar estructura de los tipos cargados
                console.log('🔍 Estructura de tipos cargados:', AppState.types.map(t => ({
                    id: t.id,
                    nombre: t.nombre,
                    categoria_activo_id: t.categoria_activo_id,
                    categoria_activo: t.categoria_activo
                })));
                
                // Actualizar selects de tipos
                updateTypeSelects();
                
            } catch (error) {
                console.error('❌ Error cargando tipos:', error);
                showToast('Error al cargar los tipos', 'warning');
            }
        }

        async function loadLocations() {
            try {
                console.log('📂 Cargando ubicaciones desde Supabase...');
                
                const { data, error } = await supabase
                    .from('ubicacion')
                    .select('*')
                    .order('nombre');
                
                if (error) {
                    throw new Error(`Error al cargar ubicaciones: ${error.message}`);
                }
                
                AppState.locations = data || [];
                console.log(`✅ ${AppState.locations.length} ubicaciones cargadas`);
                
                // Actualizar selects de ubicaciones
                updateLocationSelects();
                
            } catch (error) {
                console.error('❌ Error cargando ubicaciones:', error);
                showToast('Error al cargar las ubicaciones', 'warning');
            }
        }        

        async function loadUsers() {
            try {
                console.log('📂 Cargando usuarios desde Supabase...');
                
                const { data, error } = await supabase
                    .from('usuario')
                    .select(`
                        id,
                        nombre,
                        apellido,
                        correo,
                        area_id,
                        activo,
                        fecha_creacion,
                        fecha_actualizacion
                    `)
                    .eq('activo', true)
                    .order('nombre');
                
                if (error) {
                    console.warn('⚠️ Error cargando usuarios:', error.message);
                    AppState.users = [];
                    return;
                }
                
                AppState.users = data || [];
                console.log(`✅ ${AppState.users.length} usuarios cargados`);
                
                // Actualizar selects de usuarios
                updateUserSelects();
                
            } catch (error) {
                console.error('❌ Error cargando usuarios:', error);
                AppState.users = [];
            }
        }

        async function loadMaintenance() {
            try {
                console.log('📂 Cargando mantenimientos desde Supabase...');
                
                const { data, error } = await supabase
                    .from('mantenimientos')
                    .select(`
                        *,
                        activo: activo_id (
                            codigo, 
                            nombre, 
                            marca: marca_id (nombre), 
                            modelo
                        )
                    `)
                    .order('fecha_inicio', { ascending: false });
                
                if (error) {
                    throw new Error(`Error al cargar mantenimientos: ${error.message}`);
                }
                
                AppState.maintenance = data || [];
                console.log(`✅ ${AppState.maintenance.length} mantenimientos cargados`);
                
                // Actualizar tabla de mantenimientos
                renderMaintenanceTable();
                
            } catch (error) {
                console.error('❌ Error cargando mantenimientos:', error);
                showToast('Error al cargar los mantenimientos', 'warning');
            }
        }

        async function loadAssets() {
            try {
                showLoadingOverlay(true, 'Cargando activos...');
                
                console.log('📂 Cargando activos desde Supabase...');
                
                // Primero intentar con la relación completa
                let query = supabase
                    .from('activo')
                    .select(`
                        *,
                        tipo_activo: tipo_activo_id (id, nombre, categoria_activo_id),
                        ubicacion: ubicacion_id (nombre, tipo, piso),
                        usuario: usuario_id (id, nombre, apellido, correo),
                        activo_padre: id_activo_padre (codigo, nombre),
                        marca: marca_id (nombre)
                    `);
                
                // Intentar agregar la relación con estado si existe
                try {
                    query = query.select(`
                        *,
                        tipo_activo: tipo_activo_id (id, nombre, categoria_activo_id),
                        ubicacion: ubicacion_id (nombre, tipo, piso),
                        usuario: usuario_id (id, nombre, apellido, correo),
                        activo_padre: id_activo_padre (codigo, nombre),
                        marca: marca_id (nombre),
                        estado: estado_id (id, nombre, descripcion, activo)
                    `);
                } catch (relationError) {
                    console.log('ℹ️ Relación con estado no disponible, cargando sin estado');
                    // Si falla, usar la consulta sin la relación estado
                    query = supabase
                        .from('activo')
                        .select(`
                            *,
                            tipo_activo: tipo_activo_id (id, nombre, categoria_activo_id),
                            ubicacion: ubicacion_id (nombre, tipo, piso),
                            usuario: usuario_id (id, nombre, apellido, correo),
                            activo_padre: id_activo_padre (codigo, nombre),
                            marca: marca_id (nombre)
                        `);
                }
                
                const { data, error } = await query.order('fecha_registro', { ascending: false });
                
                if (error) {
                    throw new Error(`Error al cargar activos: ${error.message}`);
                }
                
                console.log(`✅ ${data?.length || 0} activos cargados desde Supabase`);
                
                // Procesar datos
                AppState.assets = (data || []).map(asset => {
                    // Buscar el estado correspondiente si existe la relación
                    let estadoInfo = null;
                    if (asset.estado) {
                        estadoInfo = asset.estado;
                    } else if (asset.estado_id && AppState.statuses.length > 0) {
                        // Si no viene la relación, buscar en los estados cargados
                        estadoInfo = AppState.statuses.find(s => s.id === asset.estado_id);
                    }
                    
                    return {
                        id: asset.id,
                        codigo: asset.codigo,
                        nombre: asset.nombre,
                        tipo_activo_id: asset.tipo_activo_id,
                        tipo_activo: asset.tipo_activo?.nombre || 'SIN TIPO',
                        categoria_id: asset.tipo_activo?.categoria_activo_id || null,
                        marca_id: asset.marca_id,
                        marca: asset.marca?.nombre || 'SIN MARCA',
                        modelo: asset.modelo,
                        numero_serie: asset.numero_serie,
                        estado_id: asset.estado_id,
                        estado: estadoInfo?.nombre || 'SIN ESTADO',
                        estado_descripcion: estadoInfo?.descripcion || '',
                        estado_activo: estadoInfo?.activo ?? true,
                        activo: asset.activo !== undefined ? asset.activo : true, // Default true si no existe
                        ubicacion_id: asset.ubicacion_id,
                        ubicacion: asset.ubicacion?.nombre || 'SIN UBICACIÓN',
                        usuario_id: asset.usuario_id,
                        usuario: asset.usuario ? 
                            `${asset.usuario.nombre} ${asset.usuario.apellido || ''}`.trim() : 
                            'SIN ASIGNAR',
                        id_activo_padre: asset.id_activo_padre,
                        activo_padre: asset.activo_padre?.nombre || 'NINGUNO',
                        observaciones: asset.observaciones,
                        fecha_registro: asset.fecha_registro
                    };
                });
                
                // Aplicar filtros actuales
                applyAssetsFilters();
                
                // ✅ AGREGAR BOTONES DESPUÉS DE CARGAR - CON TIMEOUT PARA ASEGURAR QUE EL DOM ESTÉ LISTO
                setTimeout(() => {
                    console.log('🎯 Agregando botones a la interfaz...');
                    addMassPdfButtonToAssetsSection();
                    addExportButtonToAssetsSection();
                    
                    // Verificación adicional después de 1 segundo
                    setTimeout(() => {
                        const exportBtn = document.getElementById('exportAssetsBtn');
                        if (!exportBtn) {
                            console.warn('⚠️ Botón de exportación no se creó, aplicando solución alternativa...');
                            forceAddExportButton();
                        } else {
                            console.log('✅ Botón de exportación verificado y funcionando');
                        }
                    }, 1000);
                }, 300);
                
                showLoadingOverlay(false);
                
            } catch (error) {
                console.error('Error cargando activos:', error);
                showToast('Error al cargar activos: ' + error.message, 'error');
                showLoadingOverlay(false);
                
                // Mostrar estado vacío
                AppState.assets = [];
                renderAssetsList();
                
                // Intentar agregar botones incluso en caso de error
                setTimeout(() => {
                    addMassPdfButtonToAssetsSection();
                    addExportButtonToAssetsSection();
                    
                    // Verificar después de 1 segundo
                    setTimeout(() => {
                        if (!document.getElementById('exportAssetsBtn')) {
                            forceAddExportButton();
                        }
                    }, 1000);
                }, 300);
            }
        }

        async function loadBrands() {
            try {
                console.log('📂 Cargando marcas desde Supabase...');
                
                const { data, error } = await supabase
                    .from('marcas')
                    .select('*')
                    .order('nombre');
                
                if (error) {
                    throw new Error(`Error al cargar marcas: ${error.message}`);
                }
                
                // Asegurar que todas las marcas tengan el campo activo
                AppState.brands = (data || []).map(brand => ({
                    ...brand,
                    activo: brand.activo !== undefined ? brand.activo : true
                }));
                
                console.log(`✅ ${AppState.brands.length} marcas cargadas`);
                
                // Inicializar filtros
                AppState.brandsFilters = {
                    search: '',
                    status: ''
                };
                
                // Actualizar selects de marcas
                updateBrandSelects();
                
            } catch (error) {
                console.error('❌ Error cargando marcas:', error);
                showToast('Error al cargar las marcas', 'warning');
                AppState.brands = [];
                AppState.brandsFilters = { search: '', status: '' };
                updateBrandSelects();
            }
        }

        async function loadStatuses() {
            try {
                console.log('📂 Cargando estados desde Supabase...');
                
                const { data, error } = await supabase
                    .from('estado')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');
                
                if (error) {
                    console.error('❌ Error cargando estados:', error);
                    // Crear estados por defecto si la tabla no existe
                    await createDefaultStatuses();
                    return;
                }
                
                AppState.statuses = data || [];
                console.log(`✅ ${AppState.statuses.length} estados activos cargados:`, 
                    AppState.statuses.map(s => ({ id: s.id, nombre: s.nombre })));
                
                // Actualizar selects de estados
                updateStatusSelects();
                
            } catch (error) {
                console.error('❌ Error cargando estados:', error);
                showToast('Error al cargar los estados', 'warning');
            }
        }

        // Función para cargar datos del usuario usando el correo electrónico
        async function loadCurrentUserData() {
            try {
                if (!AppState.currentUser?.userEmail) {
                    console.log('No hay userEmail disponible');
                    return;
                }
                
                console.log('🔄 Buscando usuario con email:', AppState.currentUser.userEmail);
                
                const { data: userData, error } = await supabase
                    .from('usuario')
                    .select('id, nombre, apellido, correo, activo')
                    .eq('correo', AppState.currentUser.userEmail)
                    .single();
                    
                if (error) {
                    console.warn('❌ Error buscando usuario por email:', error);
                    return;
                }
                
                if (userData) {
                    // Guardar nombre completo en AppState
                    AppState.currentUser.userFullName = `${userData.nombre} ${userData.apellido}`.trim();
                    AppState.currentUser.userId = userData.id; // Actualizar con ID real
                    console.log('✅ Datos de usuario cargados:', AppState.currentUser.userFullName);
                } else {
                    console.warn('⚠️ Usuario no encontrado con email:', AppState.currentUser.userEmail);
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }

        function validateAssetForm() {
            let isValid = true;
            
            // Validar código
            const code = document.getElementById('assetCode').value.trim();
            const codeError = document.getElementById('codeError');
            if (!code) {
                codeError.textContent = 'El código es requerido';
                codeError.classList.add('show');
                isValid = false;
            } else if (code.length < 3) {
                codeError.textContent = 'El código debe tener al menos 3 caracteres';
                codeError.classList.add('show');
                isValid = false;
            } else {
                codeError.classList.remove('show');
            }
            
            // Validar nombre
            const name = document.getElementById('assetName').value.trim();
            const nameError = document.getElementById('nameError');
            if (!name) {
                nameError.textContent = 'El nombre es requerido';
                nameError.classList.add('show');
                isValid = false;
            } else if (name.length < 2) {
                nameError.textContent = 'El nombre debe tener al menos 2 caracteres';
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            // Validar categoría
            const category = document.getElementById('assetCategory').value;
            const categoryError = document.getElementById('categoryError');
            if (!category) {
                categoryError.textContent = 'La categoría es requerida';
                categoryError.classList.add('show');
                isValid = false;
            } else {
                categoryError.classList.remove('show');
            }
            
            // Validar tipo
            const type = document.getElementById('assetType').value;
            const typeError = document.getElementById('typeError');
            if (!type) {
                typeError.textContent = 'El tipo es requerido';
                typeError.classList.add('show');
                isValid = false;
            } else {
                typeError.classList.remove('show');
            }
            
            // Validar que el tipo seleccionado pertenezca a la categoría seleccionada
            if (category && type) {
                const selectedType = AppState.types.find(t => t.id === type);
                if (selectedType && selectedType.categoria_activo_id !== category) {
                    typeError.textContent = 'El tipo seleccionado no pertenece a la categoría elegida';
                    typeError.classList.add('show');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Función para crear estados por defecto
        async function createDefaultStatuses() {
            const defaultStatuses = [
                { nombre: 'OPERATIVO', descripcion: 'Activo en funcionamiento normal', activo: true },
                { nombre: 'EN REPARACION', descripcion: 'Activo en proceso de reparación', activo: true },
                { nombre: 'EN ALMACEN', descripcion: 'Activo almacenado y disponible', activo: true },
                { nombre: 'DADO DE BAJA', descripcion: 'Activo dado de baja permanentemente', activo: true }
            ];
            
            try {
                const { data, error } = await supabase
                    .from('estado')
                    .insert(defaultStatuses)
                    .select();
                    
                if (error) throw error;
                
                AppState.statuses = data || defaultStatuses;
                console.log('✅ Estados por defecto creados exitosamente');
                
                // Actualizar selects de estados
                updateStatusSelects();
                
            } catch (createError) {
                console.error('❌ Error creando estados por defecto:', createError);
                // Usar estados en memoria como fallback
                AppState.statuses = defaultStatuses;
                updateStatusSelects();
            }
        }

        // Función para descubrir los valores válidos del campo estado
        async function discoverValidStatusValues() {
            try {
                console.log('🔍 Descubriendo valores válidos para el campo estado...');
                
                // Primero intentar obtener valores de la base de datos
                const { data, error } = await supabase
                    .from('activo')
                    .select('estado')
                    .limit(100);
                
                let dbStatuses = [];
                
                if (!error && data && data.length > 0) {
                    dbStatuses = [...new Set(data.map(item => item.estado).filter(Boolean))];
                    console.log('✅ Valores de estado encontrados en BD:', dbStatuses);
                }
                
                // Si no encontramos datos en BD, usar valores comunes
                if (dbStatuses.length === 0) {
                    console.log('📝 Usando valores de estado por defecto');
                    
                    // Probar diferentes combinaciones comunes de estados
                    const commonStatusCombinations = [
                        // Opción 1: Mayúsculas con espacios
                        ['OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA'],
                        // Opción 2: Mayúsculas con guiones bajos  
                        ['OPERATIVO', 'EN_REPARACION', 'EN_ALMACEN', 'DADO_DE_BAJA'],
                        // Opción 3: Minúsculas con espacios
                        ['operativo', 'en reparacion', 'en almacen', 'dado de baja'],
                        // Opción 4: Minúsculas con guiones bajos
                        ['operativo', 'en_reparacion', 'en_almacen', 'dado_de_baja'],
                        // Opción 5: Estados simples
                        ['ACTIVO', 'INACTIVO', 'MANTENIMIENTO', 'BAJA'],
                        // Opción 6: Estados en inglés
                        ['ACTIVE', 'INACTIVE', 'MAINTENANCE', 'RETIRED']
                    ];
                    
                    // Intentar determinar cuál es la combinación correcta
                    // Por ahora, usaremos la más común en sistemas en español
                    return ['OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA'];
                }
                
                return dbStatuses;
                
            } catch (error) {
                console.error('Error descubriendo valores de estado:', error);
                // Valores por defecto más comunes
                return ['OPERATIVO', 'EN REPARACION', 'EN ALMACEN', 'DADO DE BAJA'];
            }
        }

        // ===== ACTUALIZACIÓN DE INTERFAZ =====
        function updateUserInterface() {
            const userNameElement = document.getElementById('userName');
            const userRoleElement = document.getElementById('userRole');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (!AppState.currentUser) {
                console.warn('❌ No hay datos de usuario disponibles');
                return;
            }
            
            if (userNameElement) {
                const userName = AppState.currentUser.userName || AppState.currentUser.userEmail || 'Administrador';
                userNameElement.textContent = userName;
            }
            
            if (userRoleElement) {
                userRoleElement.textContent = 'Administrador';
            }
            
            if (userAvatarElement) {
                let avatarText = 'A';
                
                if (AppState.currentUser.userName && typeof AppState.currentUser.userName === 'string') {
                    avatarText = AppState.currentUser.userName.charAt(0).toUpperCase();
                } else if (AppState.currentUser.userEmail && typeof AppState.currentUser.userEmail === 'string') {
                    avatarText = AppState.currentUser.userEmail.charAt(0).toUpperCase();
                }
                
                userAvatarElement.textContent = avatarText;
            }
            
            console.log('✅ Interfaz de usuario actualizada correctamente');
        }

        function updateCategorySelects() {
            const assetSelect = document.getElementById('assetCategory');
            const typeSelect = document.getElementById('typeCategory');
            const filterSelect = document.getElementById('assetsCategoryFilter');
            
            if (assetSelect) {
                assetSelect.innerHTML = '<option value="">Selecciona una categoría</option>' +
                    AppState.categories.map(cat => 
                        `<option value="${cat.id}">${cat.nombre}</option>`
                    ).join('');
            }
            
            if (typeSelect) {
                typeSelect.innerHTML = '<option value="">Selecciona una categoría</option>' +
                    AppState.categories.map(cat => 
                        `<option value="${cat.id}">${cat.nombre}</option>`
                    ).join('');
            }
            
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todas las categorías</option>' +
                    AppState.categories.map(cat => 
                        `<option value="${cat.id}">${cat.nombre}</option>`
                    ).join('');
            }
            
            // Actualizar tabla de categorías
            renderCategoriesTable();
        }

        function updateTypeSelects() {
            const assetSelect = document.getElementById('assetType');
            const filterSelect = document.getElementById('assetsTypeFilter');
            
            if (assetSelect) {
                // Inicialmente mostrar mensaje (se actualizará cuando se seleccione categoría)
                assetSelect.innerHTML = '<option value="">Primero selecciona una categoría</option>';
                assetSelect.disabled = true;
                assetSelect.classList.add('disabled-select');
            }
            
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todos los tipos</option>' +
                    AppState.types.map(type => 
                        `<option value="${type.id}">${type.nombre}</option>`
                    ).join('');
            }
            
            // Actualizar tabla de tipos
            renderTypesTable();
        }

        function updateLocationSelects() {
            const assetSelect = document.getElementById('assetLocation');
            const locationSelect = document.getElementById('locationParent');
            
            const formatLocationInfo = (location) => {
                let info = location.nombre;
                
                // Información básica
                const basicInfo = [];
                
                if (location.tipo && location.tipo !== 'N/A') {
                    basicInfo.push(location.tipo);
                }
                
                if (location.piso && location.piso !== 'N/A') {
                    basicInfo.push(`Piso ${location.piso}`);
                }
                
                if (basicInfo.length > 0) {
                    info += ` [${basicInfo.join(' - ')}]`;
                }
                
                // Agregar descripción solo si es corta y relevante
                if (location.descripcion && location.descripcion !== 'N/A') {
                    const isShortDescription = location.descripcion.length <= 50;
                    const isRelevantDescription = !location.descripcion.match(/^(sin|no|n\/a)/i);
                    
                    if (isShortDescription && isRelevantDescription) {
                        info += ` - ${location.descripcion}`;
                    }
                }
                
                return info;
            };
            
            const createDetailedTooltip = (location) => {
                const tooltipParts = [];
                
                tooltipParts.push(`Nombre: ${location.nombre}`);
                
                if (location.tipo && location.tipo !== 'N/A') {
                    tooltipParts.push(`Tipo: ${location.tipo}`);
                }
                
                if (location.piso && location.piso !== 'N/A') {
                    tooltipParts.push(`Piso: ${location.piso}`);
                }
                
                if (location.direccion && location.direccion !== 'N/A') {
                    tooltipParts.push(`Dirección: ${location.direccion}`);
                }
                
                if (location.descripcion && location.descripcion !== 'N/A') {
                    tooltipParts.push(`Descripción: ${location.descripcion}`);
                }
                
                // ✅ CAMBIO: Usar campo 'activo' en lugar de 'estado'
                if (location.activo !== undefined) {
                    tooltipParts.push(`Activo: ${location.activo ? 'Sí' : 'No'}`);
                }
                
                return tooltipParts.join('\n');
            };
            
            if (assetSelect) {
                assetSelect.innerHTML = '<option value="">Sin ubicación</option>';
                
                // ✅ CAMBIO: Filtrar solo ubicaciones activas (activo = true)
                const activeLocations = AppState.locations.filter(location => location.activo === true);
                
                activeLocations
                    .sort((a, b) => {
                        // Ordenar por tipo primero, luego por nombre
                        if (a.tipo !== b.tipo) {
                            return (a.tipo || '').localeCompare(b.tipo || '');
                        }
                        return (a.nombre || '').localeCompare(b.nombre || '');
                    })
                    .forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.id_ubicacion;
                        option.textContent = formatLocationInfo(location);
                        option.title = createDetailedTooltip(location);
                        assetSelect.appendChild(option);
                    });
                
                console.log('📍 Selector de ubicaciones actualizado:', 
                    activeLocations.length, 
                    'ubicaciones activas disponibles');
            }
            
            if (locationSelect) {
                locationSelect.innerHTML = '<option value="">Sin padre</option>';
                
                // ✅ CAMBIO: Filtrar solo ubicaciones activas (activo = true)
                const activeLocations = AppState.locations.filter(location => location.activo === true);
                
                activeLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id_ubicacion;
                    option.textContent = formatLocationInfo(location);
                    option.title = createDetailedTooltip(location);
                    locationSelect.appendChild(option);
                });
            }
            
            renderLocationsTable();
        } 

        function updateBrandSelects() {
            console.log('🔄 Actualizando selects de marcas...');
            
            const assetSelect = document.getElementById('assetBrand');
            
            if (assetSelect) {
                // Filtrar solo marcas activas
                const activeBrands = AppState.brands.filter(brand => brand.activo === true);
                
                let optionsHTML = '<option value="">Selecciona una marca</option>';
                
                if (activeBrands.length > 0) {
                    optionsHTML += activeBrands.map(brand => 
                        `<option value="${brand.id}">${brand.nombre}</option>`
                    ).join('');
                } else {
                    optionsHTML += '<option value="">No hay marcas activas</option>';
                }
                
                assetSelect.innerHTML = optionsHTML;
                console.log('✅ Select de marcas actualizado');
            }
            
            // Actualizar grid de marcas
            console.log('🔄 Llamando a renderBrandsGrid...');
            renderBrandsGrid();
        }

        function updateAssetParentSelects() {
            const assetSelect = document.getElementById('assetParent');
            
            if (assetSelect) {
                assetSelect.innerHTML = '<option value="">Sin padre</option>' +
                    AppState.assets.map(asset => 
                        `<option value="${asset.id}">${asset.codigo} - ${asset.nombre}</option>`
                    ).join('');
            }
        }

        function updateMaintenanceAssetSelects() {
            const maintenanceSelect = document.getElementById('maintenanceAsset');
            
            if (maintenanceSelect) {
                maintenanceSelect.innerHTML = '<option value="">Selecciona un activo</option>' +
                    AppState.assets.map(asset => 
                        `<option value="${asset.id}">${asset.codigo} - ${asset.nombre}</option>`
                    ).join('');
            }
        }

        function updateUserSelects() {
            const assetSelect = document.getElementById('assetUser');
            
            if (assetSelect) {
                // Filtrar solo usuarios activos
                const activeUsers = AppState.users.filter(user => user.activo !== false);
                
                let optionsHTML = '<option value="">Sin asignar</option>';
                
                if (activeUsers.length > 0) {
                    optionsHTML += activeUsers.map(user => {
                        const nombreCompleto = `${user.nombre} ${user.apellido || ''}`.trim();
                        return `<option value="${user.id}">${nombreCompleto}</option>`;
                    }).join('');
                } else {
                    optionsHTML += '<option value="">No hay usuarios disponibles</option>';
                }
                
                assetSelect.innerHTML = optionsHTML;
            }
        }        

        function updateStatusSelects() {
            const assetStatusSelect = document.getElementById('assetStatus');
            const filterStatusSelect = document.getElementById('assetsStatusFilter');
            
            if (assetStatusSelect) {
                assetStatusSelect.innerHTML = '<option value="">Selecciona una condición</option>' +
                    AppState.statuses.map(status => 
                        `<option value="${status.id}" data-description="${status.descripcion || 'Sin descripción disponible'}">${status.nombre}</option>`
                    ).join('');
                
                // Agregar event listener para mostrar descripción
                assetStatusSelect.addEventListener('change', function() {
                    showEstadoDescription(this.value, this.options[this.selectedIndex]?.getAttribute('data-description'));
                });
            }
            
            if (filterStatusSelect) {
                filterStatusSelect.innerHTML = '<option value="">Todos los estados</option>' +
                    AppState.statuses.map(status => 
                        `<option value="${status.id}">${status.nombre}</option>`
                    ).join('');
            }
            
            console.log('✅ Selects de estado actualizados');
        }

        // ===== FUNCIONES PARA ACTUALIZAR TIPOS SEGÚN CATEGORÍA =====
        function updateTypeOptionsByCategory(categoryId, targetSelectId = 'assetType') {
            const typeSelect = document.getElementById(targetSelectId);
            const typeError = document.getElementById('typeError');
            
            if (!typeSelect) {
                console.error('❌ No se encontró el elemento typeSelect');
                return;
            }
            
            console.log('🔄 Actualizando tipos para categoría:', categoryId, 'Tipo:', typeof categoryId);
            
            // Limpiar mensaje de error
            if (typeError) {
                typeError.classList.remove('show');
            }
            
            // Caso 1: No hay categoría seleccionada
            if (!categoryId) {
                typeSelect.innerHTML = '<option value="">Primero selecciona una categoría</option>';
                typeSelect.disabled = true;
                typeSelect.classList.add('disabled-select');
                return;
            }
            
            // Convertir categoryId a número para comparación (ya que en los tipos es number)
            const categoryIdNum = parseInt(categoryId);
            console.log('🔢 Category ID convertido a número:', categoryIdNum);
            
            // Habilitar el select cuando hay categoría seleccionada
            typeSelect.disabled = false;
            typeSelect.classList.remove('disabled-select');
            
            // Filtrar tipos por la categoría seleccionada - CORREGIDO: usar número para comparación
            const filteredTypes = AppState.types.filter(type => {
                // Convertir también el tipo.categoria_activo_id a número por si acaso
                const tipoCategoriaId = parseInt(type.categoria_activo_id);
                return tipoCategoriaId === categoryIdNum;
            });
            
            console.log(`✅ Tipos filtrados: ${filteredTypes.length} para categoría ${categoryIdNum}`, filteredTypes);
            
            // Caso 2: No hay tipos para la categoría seleccionada
            if (filteredTypes.length === 0) {
                typeSelect.innerHTML = '<option value="">No hay tipos disponibles para esta categoría</option>';
                
                // Mostrar mensaje informativo
                if (typeError && targetSelectId === 'assetType') {
                    typeError.textContent = 'No hay tipos configurados para esta categoría. Por favor, agrega tipos en la pestaña "Tipos".';
                    typeError.classList.add('show');
                }
                return;
            }
            
            // Caso 3: Hay tipos disponibles para la categoría
            let optionsHTML = '<option value="">Selecciona un tipo</option>';
            
            filteredTypes.forEach(type => {
                const typeName = type.nombre || 'Sin nombre';
                const typeId = type.id;
                optionsHTML += `<option value="${typeId}">${typeName}</option>`;
            });
            
            typeSelect.innerHTML = optionsHTML;
            
            // Caso 4: Si estamos editando un activo, intentar mantener el tipo seleccionado
            if (AppState.currentEditingAsset && AppState.currentEditingAsset.tipo_activo_id && targetSelectId === 'assetType') {
                const currentTypeId = AppState.currentEditingAsset.tipo_activo_id;
                const currentType = AppState.types.find(t => t.id === currentTypeId);
                
                // Verificar si el tipo actual pertenece a la nueva categoría
                if (currentType && parseInt(currentType.categoria_activo_id) === categoryIdNum) {
                    typeSelect.value = currentTypeId;
                    console.log(`✅ Tipo mantenido: ${currentType.nombre}`);
                } else {
                    // Si el tipo no pertenece a la nueva categoría, limpiar la selección
                    typeSelect.value = '';
                    console.log('⚠️ Tipo anterior no disponible para la nueva categoría');
                    
                    // Mostrar mensaje informativo si estamos en modo edición
                    if (AppState.currentEditingAsset && typeError) {
                        typeError.textContent = 'El tipo anterior no está disponible para la categoría seleccionada. Por favor, elige un nuevo tipo.';
                        typeError.classList.add('show');
                    }
                }
            }
            
            // Caso 5: Si hay solo un tipo disponible, seleccionarlo automáticamente
            if (filteredTypes.length === 1 && !AppState.currentEditingAsset && targetSelectId === 'assetType') {
                typeSelect.value = filteredTypes[0].id;
                console.log(`✅ Tipo único seleccionado automáticamente: ${filteredTypes[0].nombre}`);
            }
            
            console.log(`✅ Tipos actualizados para categoría ${categoryIdNum}: ${filteredTypes.length} tipos disponibles`);
        }

        // Función para formatear la ubicación con detalles completos
        function formatUbicacionCompleta(ubicacionId) {
            if (!ubicacionId) return 'SIN UBICACIÓN';
            
            const ubicacion = AppState.locations.find(l => l.id_ubicacion === ubicacionId);
            if (!ubicacion) return 'UBICACIÓN NO ENCONTRADA';
            
            let detalles = [];
            
            // Nombre principal
            detalles.push(ubicacion.nombre || 'SIN NOMBRE');
            
            // Tipo entre corchetes
            if (ubicacion.tipo && ubicacion.tipo !== 'N/A') {
                let tipoInfo = ubicacion.tipo;
                if (ubicacion.piso && ubicacion.piso !== 'N/A') {
                    tipoInfo += ` - PISO ${ubicacion.piso}`;
                }
                detalles.push(`[${tipoInfo}]`);
            }
            
            // Descripción (si es corta y relevante)
            if (ubicacion.descripcion && ubicacion.descripcion !== 'N/A') {
                const isShortDescription = ubicacion.descripcion.length <= 50;
                const isRelevantDescription = !ubicacion.descripcion.match(/^(sin|no|n\/a)/i);
                
                if (isShortDescription && isRelevantDescription) {
                    detalles.push(`- ${ubicacion.descripcion}`);
                }
            }
            
            return detalles.join(' ');
        }

        // Función alternativa más compacta para cards
        function formatUbicacionParaCard(ubicacionId) {
            if (!ubicacionId) return 'Sin ubicación';
            
            const ubicacion = AppState.locations.find(l => l.id_ubicacion === ubicacionId);
            if (!ubicacion) return 'Ubicación no encontrada';
            
            let partes = [];
            
            // Nombre principal (siempre)
            partes.push(ubicacion.nombre || 'Sin nombre');
            
            // Tipo y piso entre corchetes (si existen)
            let tipoPiso = [];
            if (ubicacion.tipo && ubicacion.tipo !== 'N/A') {
                tipoPiso.push(ubicacion.tipo);
            }
            if (ubicacion.piso && ubicacion.piso !== 'N/A') {
                tipoPiso.push(`PISO ${ubicacion.piso}`);
            }
            
            if (tipoPiso.length > 0) {
                partes.push(`[${tipoPiso.join(' - ')}]`);
            }
            
            return partes.join(' ');
        }

        function createAssetCard(asset) {

        // Debug temporal
       console.log('🔄 Creando card para:', asset.codigo, 'Ubicacion ID:', asset.ubicacion_id);

            const card = document.createElement('div');
            card.className = 'asset-card';
            card.setAttribute('data-asset-id', asset.id);
            
            // Header
            const header = document.createElement('div');
            header.className = 'asset-header';
            
            const assetInfo = document.createElement('div');
            assetInfo.className = 'asset-info';
            
            const title = document.createElement('h3');
            const nameText = document.createTextNode(asset.nombre || 'Sin nombre');
            title.appendChild(nameText);
            
            if (!asset.activo) {
                const inactiveBadge = document.createElement('small');
                inactiveBadge.style.color = 'var(--danger-color)';
                inactiveBadge.textContent = ' (INACTIVO)';
                title.appendChild(inactiveBadge);
            }
            
            const meta = document.createElement('div');
            meta.className = 'asset-meta';
            
            // Código
            const codeSpan = document.createElement('span');
            codeSpan.className = 'asset-code';
            codeSpan.textContent = asset.codigo;
            meta.appendChild(codeSpan);
            
            // Estado activo/inactivo
            const activeBadge = document.createElement('span');
            activeBadge.className = 'asset-status';
            activeBadge.classList.add(asset.activo ? 'status-operativo' : 'status-dado-de-baja');
            activeBadge.style.backgroundColor = asset.activo ? 'var(--success-color)' : 'var(--danger-color)';
            activeBadge.textContent = asset.activo ? 'Activo' : 'Inactivo';
            meta.appendChild(activeBadge);
            
            // Estado del activo
            const statusSpan = document.createElement('span');
            statusSpan.className = 'asset-status';
            const statusClass = `status-${(asset.estado || 'sin-estado').toLowerCase().replace(' ', '-')}`;
            statusSpan.classList.add(statusClass);
            statusSpan.textContent = asset.estado || 'Sin estado';
            meta.appendChild(statusSpan);
            
            // Tipo
            const typeSpan = document.createElement('span');
            const typeIcon = document.createElement('i');
            typeIcon.className = 'fas fa-tag';
            typeSpan.appendChild(typeIcon);
            typeSpan.appendChild(document.createTextNode(' ' + (asset.tipo_activo || 'Sin tipo')));
            meta.appendChild(typeSpan);
            
            // Ubicación
            const locationSpan = document.createElement('span');
            const locationIcon = document.createElement('i');
            locationIcon.className = 'fas fa-map-marker-alt';
            locationSpan.appendChild(locationIcon);
            const ubicacionCompleta = formatUbicacionCompleta(asset.ubicacion_id);
            locationSpan.appendChild(document.createTextNode(' ' + ubicacionCompleta));
            
            meta.appendChild(locationSpan);
    
            
            // IPs
            const mainIPs = getAssetMainIPs(asset.id);
            if (mainIPs) {
                const ipSpan = document.createElement('span');
                const ipIcon = document.createElement('i');
                ipIcon.className = 'fas fa-network-wired';
                ipSpan.appendChild(ipIcon);
                ipSpan.appendChild(document.createTextNode(' ' + mainIPs));
                meta.appendChild(ipSpan);
            }
            
            // Fecha
            const dateSpan = document.createElement('span');
            const dateIcon = document.createElement('i');
            dateIcon.className = 'fas fa-calendar';
            dateSpan.appendChild(dateIcon);
            const createdDate = new Date(asset.fecha_registro).toLocaleDateString();
            dateSpan.appendChild(document.createTextNode(' ' + createdDate));
            meta.appendChild(dateSpan);
            
            assetInfo.appendChild(title);
            assetInfo.appendChild(meta);
            header.appendChild(assetInfo);
            card.appendChild(header);
            
            // Descripción
            const description = document.createElement('div');
            description.className = 'asset-description';
            
            const descContent = [
                `Marca: ${asset.marca || 'No especificada'}`,
                `Modelo: ${asset.modelo || 'No especificado'}`,
                `Serie: ${asset.numero_serie || 'No especificado'}`
            ];
            
            if (asset.usuario && asset.usuario !== 'Sin asignar') {
                descContent.push(`Asignado a: ${asset.usuario}`);
            }
            
            description.textContent = descContent.join(' | ');
            card.appendChild(description);
            
            // Footer
            const footer = document.createElement('div');
            footer.className = 'asset-footer';
            
            const actions = document.createElement('div');
            actions.className = 'asset-actions';
            
            // Botón Ver
            const viewBtn = createActionButton('Ver', 'fa-eye', 'btn-secondary', 'view-asset-btn', asset.id);
            actions.appendChild(viewBtn);
            
            // Botón Editar
            const editBtn = createActionButton('Editar', 'fa-edit', 'btn-accent', 'edit-asset-btn', asset.id);
            actions.appendChild(editBtn);
            
            // Botón IP
            const ipBtn = createActionButton('IP', 'fa-network-wired', 'btn-info', 'manage-ip-btn', asset.id);
            actions.appendChild(ipBtn);
            
            // Botón PDF
            const pdfBtn = createActionButton('Etiqueta', 'fa-tag', 'btn-success', 'generate-pdf-btn', asset.id);
            pdfBtn.title = 'Generar etiqueta PDF para este activo';
            actions.appendChild(pdfBtn);
            
            // Botón Especificaciones
            const specsBtn = createActionButton('Especificaciones', 'fa-cogs', 'btn-warning', 'especificaciones-btn', asset.id);
            specsBtn.setAttribute('data-asset-name', asset.nombre || '');
            specsBtn.title = 'Gestionar especificaciones técnicas';
            actions.appendChild(specsBtn);
            
            footer.appendChild(actions);
            
            // Observaciones
            if (asset.observaciones) {
                const observations = document.createElement('div');
                observations.className = 'asset-observations';
                const obsText = document.createElement('small');
                obsText.innerHTML = `<strong>Observaciones:</strong> ${asset.observaciones}`;
                observations.appendChild(obsText);
                footer.appendChild(observations);
            }
            
            card.appendChild(footer);
            
            return card;
        }

        function createActionButton(text, icon, style, className, assetId) {
            const button = document.createElement('button');
            button.className = `btn ${style} btn-small ${className}`;
            button.setAttribute('data-asset-id', assetId);
            
            const iconElem = document.createElement('i');
            iconElem.className = `fas ${icon}`;
            
            button.appendChild(iconElem);
            button.appendChild(document.createTextNode(' ' + text));
            
            return button;
        }

        // Función auxiliar para obtener IPs principales de un activo
        function getAssetMainIPs(assetId) {
            // Esta función asume que tienes las IPs cargadas en algún estado
            // Puedes precargarlas o hacer una consulta específica
            const assetIPs = AppState.assetIPs?.[assetId] || [];
            if (assetIPs.length === 0) return null;
            
            // Mostrar solo las IPs activas, máximo 2
            const activeIPs = assetIPs.filter(ip => ip.activo).slice(0, 2);
            return activeIPs.map(ip => ip.direccion_ip).join(', ');
        } 

        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTableBody');
            if (!tbody) return;
            
            let html = '';
            
            if (AppState.categories.length === 0) {
                html = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem;">
                            <div class="empty-state" style="padding: 0;">
                                <i class="fas fa-folder" style="font-size: 2rem;"></i>
                                <h4>No hay categorías</h4>
                                <p>Las categorías de activos aparecerán aquí</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                AppState.categories.forEach(category => {
                    const createdDate = new Date(category.fecha_creacion).toLocaleDateString();
                    const updatedDate = category.fecha_actualizacion ? 
                        new Date(category.fecha_actualizacion).toLocaleDateString() : 'No actualizada';
                    
                    html += `
                        <tr>
                            <td>${category.nombre}</td>
                            <td>${category.descripcion || 'Sin descripción'}</td>
                            <td>${createdDate}</td>
                            <td>${updatedDate}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-accent btn-small edit-category-btn" data-category-id="${category.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small delete-category-btn" data-category-id="${category.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
            
            // Configurar event listeners
            setupCategoryButtonsListeners();
        }

        function renderTypesTable() {
            const tbody = document.getElementById('typesTableBody');
            if (!tbody) return;
            
            let html = '';
            
            if (AppState.types.length === 0) {
                html = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <div class="empty-state" style="padding: 0;">
                                <i class="fas fa-tags" style="font-size: 2rem;"></i>
                                <h4>No hay tipos</h4>
                                <p>Los tipos de activos aparecerán aquí</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                AppState.types.forEach(type => {
                    const createdDate = new Date(type.fecha_creacion).toLocaleDateString();
                    const updatedDate = type.fecha_actualizacion ? 
                        new Date(type.fecha_actualizacion).toLocaleDateString() : 'No actualizada';
                    
                    html += `
                        <tr>
                            <td>${type.nombre}</td>
                            <td>${type.categoria_activo?.nombre || 'Sin categoría'}</td>
                            <td>${type.descripcion || 'Sin descripción'}</td>
                            <td>${createdDate}</td>
                            <td>${updatedDate}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-accent btn-small edit-type-btn" data-type-id="${type.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small delete-type-btn" data-type-id="${type.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
            
            // Configurar event listeners
            setupTypeButtonsListeners();
        }

        function renderLocationsTable() {
            const tbody = document.getElementById('locationsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (AppState.locations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div class="empty-state" style="padding: 0;">
                                <i class="fas fa-map-marker-alt" style="font-size: 2rem;"></i>
                                <h4>No hay ubicaciones</h4>
                                <p>Las ubicaciones aparecerán aquí</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                AppState.locations.forEach(location => {
                    const row = document.createElement('tr');
                    
                    // Nombre
                    const nameCell = document.createElement('td');
                    nameCell.textContent = location.nombre;
                    row.appendChild(nameCell);
                    
                    // Tipo
                    const typeCell = document.createElement('td');
                    typeCell.textContent = location.tipo || 'No especificado';
                    row.appendChild(typeCell);
                    
                    // Piso
                    const floorCell = document.createElement('td');
                    floorCell.textContent = location.piso || 'No especificado';
                    row.appendChild(floorCell);
                    
                    // Dirección
                    const addressCell = document.createElement('td');
                    addressCell.textContent = location.direccion || 'No especificada';
                    row.appendChild(addressCell);
                    
                    // Activo (campo booleano)
                    const activeCell = document.createElement('td');
                    const activeBadge = document.createElement('span');
                    activeBadge.className = 'asset-status';
                    
                    if (location.activo === true) {
                        activeBadge.classList.add('status-operativo');
                        activeBadge.textContent = 'Activo';
                        activeBadge.style.backgroundColor = 'var(--success-color)';
                    } else {
                        activeBadge.classList.add('status-dado-de-baja');
                        activeBadge.textContent = 'Inactivo';
                        activeBadge.style.backgroundColor = 'var(--danger-color)';
                    }
                    
                    activeCell.appendChild(activeBadge);
                    row.appendChild(activeCell);
                    
                    // Fecha Creación - Formateada en zona horaria Perú
                    const dateCell = document.createElement('td');
                    const createdDate = formatDatePeru(location.fecha_creacion);
                    dateCell.textContent = createdDate;
                    dateCell.title = `Fecha original: ${location.fecha_creacion}`;
                    row.appendChild(dateCell);
                    
                    // Acciones
                    const actionsCell = document.createElement('td');
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'table-actions';
                    
                    // Botón Editar
                    const editButton = document.createElement('button');
                    editButton.className = 'btn btn-accent btn-small edit-location-btn';
                    editButton.setAttribute('data-location-id', location.id_ubicacion);
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.title = 'Editar ubicación';
                    
                    // Botón Eliminar
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-danger btn-small delete-location-btn';
                    deleteButton.setAttribute('data-location-id', location.id_ubicacion);
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteButton.title = 'Eliminar ubicación';
                    
                    actionsContainer.appendChild(editButton);
                    actionsContainer.appendChild(deleteButton);
                    actionsCell.appendChild(actionsContainer);
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            // Configurar event listeners para los botones
            setupLocationButtonsListeners();
            
            // Mostrar estadísticas de ubicaciones
            showLocationStats();
        }

        function renderMaintenanceTable() {
            const tbody = document.getElementById('maintenanceTableBody');
            if (!tbody) return;
            
            let html = '';
            
            if (AppState.maintenance.length === 0) {
                html = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div class="empty-state" style="padding: 0;">
                                <i class="fas fa-tools" style="font-size: 2rem;"></i>
                                <h4>No hay mantenimientos</h4>
                                <p>Los mantenimientos aparecerán aquí</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                AppState.maintenance.forEach(maintenance => {
                    const startDate = new Date(maintenance.fecha_inicio).toLocaleDateString();
                    const endDate = maintenance.fecha_fin ? 
                        new Date(maintenance.fecha_fin).toLocaleDateString() : 'En progreso';
                    const status = maintenance.fecha_fin ? 'Completado' : 'En progreso';
                    const statusClass = maintenance.fecha_fin ? 'status-operativo' : 'status-en-reparacion';
                    
                    html += `
                        <tr>
                            <td>${maintenance.activo?.codigo} - ${maintenance.activo?.nombre}</td>
                            <td>${maintenance.tipo}</td>
                            <td>${maintenance.descripcion || 'Sin descripción'}</td>
                            <td>${startDate}</td>
                            <td>${endDate}</td>
                            <td><span class="asset-status ${statusClass}">${status}</span></td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-accent btn-small edit-maintenance-btn" data-maintenance-id="${maintenance.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-small delete-maintenance-btn" data-maintenance-id="${maintenance.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
            
            // Configurar event listeners
            setupMaintenanceButtonsListeners();
        }

        function renderBrandsGrid() {
            console.log('🎨 Renderizando grid de marcas...');
            
            const container = document.getElementById('brandsGridContainer');
            const emptyState = document.getElementById('brandsEmptyState');
            
            if (!container) {
                console.error('❌ brandsGridContainer no encontrado');
                return;
            }
            
            if (!emptyState) {
                console.error('❌ brandsEmptyState no encontrado');
                return;
            }
            
            // Aplicar filtros
            const filteredBrands = filterBrands();
            console.log(`📋 Marcas filtradas: ${filteredBrands.length}`);
            
            let html = '';
            
            if (filteredBrands.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                console.log('📭 Mostrando estado vacío');
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            filteredBrands.forEach(brand => {
                console.log(`🔄 Procesando marca: ${brand.nombre}`);
                
                const createdDate = new Date(brand.fecha_creacion).toLocaleDateString();
                const updatedDate = brand.fecha_actualizacion ? 
                    new Date(brand.fecha_actualizacion).toLocaleDateString() : 'No actualizada';
                
                const isActive = brand.activo;
                const statusClass = isActive ? 'active' : 'inactive';
                const statusText = isActive ? 'Activa' : 'Inactiva';
                
                html += `
                    <div class="brand-card ${!isActive ? 'inactive' : ''}" data-brand-id="${brand.id}">
                        ${!isActive ? '<div class="brand-badge">INACTIVA</div>' : ''}
                        
                        <div class="brand-header">
                            <div class="brand-info">
                                <h3>${brand.nombre}</h3>
                                <div class="brand-meta">
                                    <span class="brand-status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="brand-description">
                            ${brand.descripcion || '<em style="color: var(--text-muted);">Sin descripción</em>'}
                        </div>
                        
                        <div class="brand-footer">
                            <div class="brand-actions">
                                <button class="btn btn-accent btn-small edit-brand-btn" data-brand-id="${brand.id}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-${isActive ? 'warning' : 'success'} btn-small toggle-brand-btn" data-brand-id="${brand.id}">
                                    <i class="fas fa-${isActive ? 'pause' : 'play'}"></i> ${isActive ? 'Desactivar' : 'Activar'}
                                </button>
                                <button class="btn btn-danger btn-small delete-brand-btn" data-brand-id="${brand.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="brand-dates">
                                <span class="brand-date">Creado: ${createdDate}</span>
                                ${updatedDate !== 'No actualizada' ? 
                                    `<span class="brand-date">Actualizado: ${updatedDate}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('✅ HTML generado para marcas');
            
            // Configurar event listeners
            setupBrandButtonsListeners();
            
            // Configurar botón de estado vacío
            const addBrandEmptyBtn = document.getElementById('addBrandEmptyBtn');
            if (addBrandEmptyBtn) {
                addBrandEmptyBtn.addEventListener('click', function() {
                    openBrandModal();
                });
            }
        }

        function formatDatePeru(dateString) {
            if (!dateString) return 'No disponible';
            
            try {
                const date = new Date(dateString);
                
                // Formatear en español de Perú
                return date.toLocaleString('es-PE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Lima'
                });
            } catch (error) {
                console.error('Error formateando fecha:', error);
                // Fallback: mostrar fecha original
                return dateString;
            }
        }

        // Función para mostrar estadísticas de ubicaciones
        function showLocationStats() {
            const totalLocations = AppState.locations.length;
            const activeLocations = AppState.locations.filter(l => l.activo === true).length;
            const inactiveLocations = AppState.locations.filter(l => l.activo === false).length;
            
            console.log('📊 Estadísticas de ubicaciones:', {
                total: totalLocations,
                activas: activeLocations,
                inactivas: inactiveLocations,
                porcentajeActivas: Math.round((activeLocations / totalLocations) * 100) + '%'
            });
            
            // Opcional: Actualizar algún elemento en la UI con estas estadísticas
            const statsElement = document.getElementById('locationsStats');
            if (statsElement) {
                statsElement.innerHTML = `
                    <small style="color: var(--text-muted);">
                        Total: ${totalLocations} | 
                        <span style="color: var(--success-color);">Activas: ${activeLocations}</span> | 
                        <span style="color: var(--danger-color);">Inactivas: ${inactiveLocations}</span>
                    </small>
                `;
            }
        }

        // Función para configurar event listeners de los botones
        function setupLocationButtonsListeners() {
            // Botones de editar ubicación
            document.querySelectorAll('.edit-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const locationId = this.getAttribute('data-location-id');
                    console.log('✏️ Editando ubicación:', locationId);
                    openLocationModal(locationId);
                });
            });
            
            // Botones de eliminar ubicación
            document.querySelectorAll('.delete-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const locationId = this.getAttribute('data-location-id');
                    console.log('🗑️ Solicitando eliminar ubicación:', locationId);
                    deleteLocation(locationId);
                });
            });
        }

        // Función para obtener fecha actual en zona horaria Perú
        function getPeruDateTime() {
            const now = new Date();
            
            // Obtener componentes de fecha local
            const localYear = now.getFullYear();
            const localMonth = now.getMonth();
            const localDate = now.getDate();
            const localHours = now.getHours();
            const localMinutes = now.getMinutes();
            const localSeconds = now.getSeconds();
            
            // Crear nueva fecha con componentes locales pero forzando zona horaria
            const peruDate = new Date(Date.UTC(
                localYear,
                localMonth,
                localDate,
                localHours,
                localMinutes,
                localSeconds
            ));
            
            return peruDate.toISOString();
        }

        // ===== CONFIGURACIÓN DE EVENT LISTENERS =====
        function setupEventListeners() {
            // 1. Toggle de tema
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // 2. Botón de pantalla completa
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }
            
            // 3. Menú de usuario
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', toggleUserDropdown);
            }
            
            // 4. Navegación por pestañas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // 5. Event listener para cuando cambia la categoría en el formulario de activos
            document.getElementById('assetCategory').addEventListener('change', function() {
                updateTypeOptionsByCategory(this.value, 'assetType');
            });

            // 6. Event listener para cuando cambia la categoría en los filtros
            document.getElementById('assetsCategoryFilter').addEventListener('change', function() {
                const categoryId = this.value;
                const typeFilter = document.getElementById('assetsTypeFilter');
                
                console.log('🔄 Cambio en filtro de categoría:', categoryId, 'Tipo:', typeof categoryId);
                
                if (categoryId) {
                    // Convertir a número para comparación
                    const categoryIdNum = parseInt(categoryId);
                    
                    // Filtrar tipos por categoría seleccionada
                    const filteredTypes = AppState.types.filter(type => {
                        return parseInt(type.categoria_activo_id) === categoryIdNum;
                    });
                    
                    console.log(`📊 Tipos filtrados para categoría ${categoryIdNum}:`, filteredTypes);
                    
                    typeFilter.innerHTML = '<option value="">Todos los tipos</option>' +
                        filteredTypes.map(type => 
                            `<option value="${type.id}">${type.nombre}</option>`
                        ).join('');
                    typeFilter.disabled = false;
                } else {
                    // Mostrar todos los tipos si no hay categoría seleccionada
                    typeFilter.innerHTML = '<option value="">Todos los tipos</option>' +
                        AppState.types.map(type => 
                            `<option value="${type.id}">${type.nombre}</option>`
                        ).join('');
                }
                
                // Aplicar filtros
                AppState.assetsFilters.category = categoryId;
                applyAssetsFilters();
            });
            
            // 7. Filtros y búsqueda de activos
            setupFiltersEventListeners();
            
            // 8. Botones de agregar
            document.getElementById('addAssetBtn').addEventListener('click', () => openAssetModal());
            document.getElementById('addCategoryBtn').addEventListener('click', () => openCategoryModal());
            document.getElementById('addTypeBtn').addEventListener('click', () => openTypeModal());
            document.getElementById('addLocationBtn').addEventListener('click', () => openLocationModal());
            document.getElementById('addMaintenanceBtn').addEventListener('click', () => openMaintenanceModal());
            document.getElementById('addBrandBtn').addEventListener('click', () => openBrandModal());
                       
            // 10. Botón de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🚪 Usuario solicitó cerrar sesión');
                    AuthChecker.cerrarSesionGlobal();
                    document.getElementById('userDropdown').classList.remove('active');
                });
            }

            // Modal de IPs
            document.getElementById('closeIpModal').addEventListener('click', closeIPModal);
            document.getElementById('cancelIpBtn').addEventListener('click', closeIPModal);
            document.getElementById('saveIpBtn').addEventListener('click', saveIP);
            
            // Validación de IP en tiempo real
            document.getElementById('ipAddress').addEventListener('input', function() {
                const ipError = document.getElementById('ipError');
                if (this.value.trim() && !isValidIP(this.value.trim())) {
                    ipError.classList.add('show');
                } else {
                    ipError.classList.remove('show');
                }
            });            
            
            // 11. Modales
            setupModalsEventListeners();
            
            // 12. Paginación
            setupPaginationEventListeners();

            // 13. Sistema de autogeneración de nombres
            setupAdvancedAutoName(); 
            
            // 14. Filtros para marcas
            setupBrandsFilters();
            
            
            console.log('✅ Event listeners configurados correctamente');
        }

        function setupFiltersEventListeners() {
            // Filtros para activos
            const assetsSearchInput = document.getElementById('assetsSearchInput');
            if (assetsSearchInput) {
                assetsSearchInput.addEventListener('input', debounce(function(e) {
                    AppState.assetsFilters.search = e.target.value;
                    applyAssetsFilters();
                }, 300));
            }
            
            const assetsStatusFilter = document.getElementById('assetsStatusFilter');
            if (assetsStatusFilter) {
                assetsStatusFilter.addEventListener('change', function(e) {
                    AppState.assetsFilters.status = e.target.value;
                    applyAssetsFilters();
                });
            }
            
            const assetsTypeFilter = document.getElementById('assetsTypeFilter');
            if (assetsTypeFilter) {
                assetsTypeFilter.addEventListener('change', function(e) {
                    AppState.assetsFilters.type = e.target.value;
                    applyAssetsFilters();
                });
            }
        }

        function setupModalsEventListeners() {
            // Modal de activo
            document.getElementById('closeAssetModal').addEventListener('click', closeAssetModal);
            document.getElementById('cancelAssetBtn').addEventListener('click', closeAssetModal);
            document.getElementById('saveAssetBtn').addEventListener('click', saveAsset);
            
            // Modal de categoría
            document.getElementById('closeCategoryModal').addEventListener('click', closeCategoryModal);
            document.getElementById('cancelCategoryBtn').addEventListener('click', closeCategoryModal);
            document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
            
            // Modal de tipo
            document.getElementById('closeTypeModal').addEventListener('click', closeTypeModal);
            document.getElementById('cancelTypeBtn').addEventListener('click', closeTypeModal);
            document.getElementById('saveTypeBtn').addEventListener('click', saveType);
            
            // Modal de ubicación
            document.getElementById('closeLocationModal').addEventListener('click', closeLocationModal);
            document.getElementById('cancelLocationBtn').addEventListener('click', closeLocationModal);
            document.getElementById('saveLocationBtn').addEventListener('click', saveLocation);

            // Modal de marca
            document.getElementById('closeBrandModal').addEventListener('click', closeBrandModal);
            document.getElementById('cancelBrandBtn').addEventListener('click', closeBrandModal);
            document.getElementById('saveBrandBtn').addEventListener('click', saveBrand);            
            
            // Modal de mantenimiento
            document.getElementById('closeMaintenanceModal').addEventListener('click', closeMaintenanceModal);
            document.getElementById('cancelMaintenanceBtn').addEventListener('click', closeMaintenanceModal);
            document.getElementById('saveMaintenanceBtn').addEventListener('click', saveMaintenance);
            
            // Modal de detalles del activo
            document.getElementById('closeAssetDetailsModal').addEventListener('click', closeAssetDetailsModal);
            document.getElementById('closeAssetDetailsBtn').addEventListener('click', closeAssetDetailsModal);
        }

        function setupPaginationEventListeners() {
            // Paginación para activos
            const assetsPrevPageBtn = document.getElementById('assetsPrevPageBtn');
            const assetsNextPageBtn = document.getElementById('assetsNextPageBtn');
            
            if (assetsPrevPageBtn) {
                assetsPrevPageBtn.addEventListener('click', function() {
                    goToAssetsPage(AppState.assetsPagination.currentPage - 1);
                });
            }
            
            if (assetsNextPageBtn) {
                assetsNextPageBtn.addEventListener('click', function() {
                    goToAssetsPage(AppState.assetsPagination.currentPage + 1);
                });
            }
        }

        function setupCategoryButtonsListeners() {
            // Botones de editar categoría
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category-id');
                    openCategoryModal(categoryId);
                });
            });
            
            // Botones de eliminar categoría
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category-id');
                    deleteCategory(categoryId);
                });
            });
        }

        function setupTypeButtonsListeners() {
            // Botones de editar tipo
            document.querySelectorAll('.edit-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const typeId = this.getAttribute('data-type-id');
                    openTypeModal(typeId);
                });
            });
            
            // Botones de eliminar tipo
            document.querySelectorAll('.delete-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const typeId = this.getAttribute('data-type-id');
                    deleteType(typeId);
                });
            });
        }

        function setupMaintenanceButtonsListeners() {
            // Botones de editar mantenimiento
            document.querySelectorAll('.edit-maintenance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const maintenanceId = this.getAttribute('data-maintenance-id');
                    openMaintenanceModal(maintenanceId);
                });
            });
            
            // Botones de eliminar mantenimiento
            document.querySelectorAll('.delete-maintenance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const maintenanceId = this.getAttribute('data-maintenance-id');
                    deleteMaintenance(maintenanceId);
                });
            });
        }

        function setupBrandButtonsListeners() {
            // Botones de editar marca
            document.querySelectorAll('.edit-brand-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const brandId = this.getAttribute('data-brand-id');
                    if (brandId) {
                        openBrandModal(brandId);
                    }
                });
            });
            
            // Botones de activar/desactivar marca
            document.querySelectorAll('.toggle-brand-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const brandId = this.getAttribute('data-brand-id');
                    if (brandId) {
                        toggleBrandStatus(brandId);
                    }
                });
            });
            
            // Botones de eliminar marca
            document.querySelectorAll('.delete-brand-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const brandId = this.getAttribute('data-brand-id');
                    if (brandId) {
                        deleteBrand(brandId);
                    }
                });
            });
            
        }

        function setupBrandsFilters() {
            // Filtro de búsqueda
            const searchInput = document.getElementById('brandsSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(function(e) {
                    AppState.brandsFilters.search = e.target.value;
                    renderBrandsGrid();
                }, 300));
            }
            
            // Filtro de estado
            const statusFilter = document.getElementById('brandsStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function(e) {
                    AppState.brandsFilters.status = e.target.value;
                    renderBrandsGrid();
                });
            }
        }
        
        function setupAssetButtonsListeners() {
            // Botones de ver detalles
            document.querySelectorAll('.view-asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    showAssetDetails(assetId);
                });
            });
            
            // Botones de editar activo
            document.querySelectorAll('.edit-asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    openAssetModal(assetId);
                });
            });
            
            // Botones de gestión de IPs
            document.querySelectorAll('.manage-ip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    console.log('🔗 Click en IP - Asset ID:', assetId);
                    
                    if (assetId) {
                        // Verificar que el activo existe
                        const asset = AppState.assets.find(a => a.id === assetId);
                        if (asset) {
                            console.log('✅ Activo encontrado:', asset.nombre);
                            openIPManagementModal(assetId);
                        } else {
                            console.error('❌ Activo no encontrado con ID:', assetId);
                            showToast('Error: Activo no encontrado', 'error');
                        }
                    } else {
                        console.error('❌ Asset ID no válido');
                    }
                });
            }); 
            
            // ✅ BOTONES DE GENERAR PDF ACTUALIZADOS
            document.querySelectorAll('.generate-pdf-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    console.log('🎯 Generando PDF individual para activo:', assetId);
                    generateSingleAssetPdf(assetId);
                });
            });

            // ✅ CORREGIDO: Botones de especificaciones con event listeners
            document.querySelectorAll('.especificaciones-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    const assetName = this.getAttribute('data-asset-name');
                    console.log('🔧 Especificaciones click:', { assetId, assetName });
                    abrirModalEspecificaciones(assetId, assetName);
                });
            });            
        }

        // FUNCIÓN PRINCIPAL PARA GENERAR ETIQUETA PDF
        async function generateAssetLabelPDF(assetId) {
            try {
                showLoadingOverlay(true, 'Preparando etiqueta...');
                
                const asset = AppState.assets.find(a => a.id === assetId);
                if (!asset) {
                    throw new Error('Activo no encontrado');
                }
                
                console.log('🎯 Generando etiqueta para:', asset.nombre);
                
                // PRE-GENERAR EL QR ANTES DE CREAR EL PDF
                console.log('🔄 Generando código QR...');
                const qrData = generateQRData(asset);
                const qrCodeDataUrl = await generateQRCodeRobust(qrData);
                console.log('✅ QR generado:', qrCodeDataUrl ? 'Éxito' : 'Falló');
                
                // CREAR PDF DESPUÉS DE TENER EL QR
                console.log('📄 Creando PDF...');
                const pdf = new jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'cm',
                    format: [10, 5],
                    compress: true
                });
                
                // Configuración
                const margin = 0.15;
                const contentWidth = 10 - (margin * 2);
                const contentHeight = 5 - (margin * 2);
                
                // DIBUJAR CONTENIDO (SÍNCRONO)
                drawPremiumBackground(pdf, margin, contentWidth, contentHeight);
                drawCorporateHeader(pdf, margin, contentWidth);
                drawQRHighlightSection(pdf, asset, qrCodeDataUrl, margin, contentWidth);
                drawAssetInfoSection(pdf, asset, margin, contentWidth);
                drawFooter(pdf, margin, contentWidth, contentHeight);
                drawElegantBorder(pdf, margin, contentWidth, contentHeight);
                
                // GENERAR Y GUARDAR
                const fileName = `ETIQUETA_${asset.codigo}.pdf`;
                pdf.save(fileName);
                
                showLoadingOverlay(false);
                showToast(`✅ Etiqueta generada: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('❌ Error generando etiqueta:', error);
                showLoadingOverlay(false);
                showToast('Error al generar la etiqueta', 'error');
            }
        }

        // FONDO PREMIUM CON GRADIENTES
        function drawPremiumBackground(pdf, margin, contentWidth, contentHeight) {
            // Fondo base blanco
            pdf.setFillColor(255, 255, 255);
            pdf.rect(margin, margin, contentWidth, contentHeight, 'F');
            
            // Gradiente sutil en header
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, margin, contentWidth, 1.0, 'F');
            
            // Línea decorativa corporativa
            pdf.setDrawColor(203, 62, 44);
            pdf.setLineWidth(0.08);
            pdf.line(margin, margin + 1.0, margin + contentWidth, margin + 1.0);
            
            // Patrón de puntos sutiles
            pdf.setFillColor(240, 240, 240);
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 3; j++) {
                    if ((i + j) % 2 === 0) {
                        pdf.circle(
                            margin + 0.3 + (i * 1.2),
                            margin + 1.5 + (j * 1.0),
                            0.03,
                            'F'
                        );
                    }
                }
            }
        }

        // HEADER CORPORATIVO ELEGANTE
        async function drawCorporateHeader(pdf, margin, contentWidth) {
            // Logo/texto corporativo
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(7);
            pdf.setTextColor(203, 62, 44);
            
            // Nombre de la empresa
            pdf.text('GALLOS MÁRMOL', margin + 0.3, margin + 0.5);
            
            // Línea decorativa
            pdf.setDrawColor(203, 62, 44);
            pdf.setLineWidth(0.05);
            pdf.line(margin + 0.3, margin + 0.6, margin + 3.0, margin + 0.6);
            
            // Texto "Sistema de Activos"
            pdf.setFontSize(5);
            pdf.setTextColor(100, 100, 100);
            pdf.text('SISTEMA DE ACTIVOS TI', margin + 0.3, margin + 0.8);
            
            // Icono de escáner
            drawScannerIcon(pdf, margin + contentWidth - 1.0, margin + 0.4);
        }

        // AGREGAR LOGO DE LA EMPRESA
        async function addCompanyLogo(pdf, margin) {
            try {
                // Logo simplificado con texto
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(6);
                pdf.setTextColor(203, 62, 44); // Color corporativo
                
                // Texto del logo
                pdf.text('GALLOS', margin + 0.3, margin + 0.4);
                pdf.text('MÁRMOL', margin + 0.3, margin + 0.6);
                
                // Línea decorativa
                pdf.setDrawColor(203, 62, 44);
                pdf.setLineWidth(0.05);
                pdf.line(margin + 0.3, margin + 0.65, margin + 1.5, margin + 0.65);
                
            } catch (error) {
                console.warn('⚠️ No se pudo cargar el logo:', error);
            }
        }

        // AGREGAR INFORMACIÓN DEL ACTIVO
        async function addAssetInfo(pdf, asset, margin, contentWidth) {
            const infoX = margin + 2.3; // Más espacio para el QR
            const lineHeight = 0.5;
            
            // Fondo de la sección de información
            pdf.setFillColor(248, 249, 250);
            pdf.rect(infoX - 0.1, margin + 0.1, contentWidth - 2.1, 4.3, 'F');
            
            // Borde de la sección
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.02);
            pdf.rect(infoX - 0.1, margin + 0.1, contentWidth - 2.1, 4.3);
            
            // Código del activo (más prominente)
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.setTextColor(203, 62, 44); // Color corporativo
            pdf.text(asset.codigo, infoX, margin + 0.8);
            
            // Línea divisoria
            pdf.setDrawColor(203, 62, 44);
            pdf.setLineWidth(0.03);
            pdf.line(infoX, margin + 0.9, infoX + 6.5, margin + 0.9);
            
            let currentY = margin + 1.4;
            
            // Nombre del activo
            pdf.setFontSize(9);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'bold');
            
            // Ajustar nombre si es muy largo
            const assetName = formatTextForPDF(asset.nombre, 30);
            const nameLines = pdf.splitTextToSize(assetName, 6.5);
            nameLines.forEach(line => {
                pdf.text(line, infoX, currentY);
                currentY += lineHeight * 0.6;
            });
            
            // Tipo
            pdf.setFontSize(7);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(60, 60, 60);
            pdf.text(`Tipo: ${asset.tipo_activo}`, infoX, currentY + 0.1);
            currentY += lineHeight;
            
            // Marca y Modelo
            if (asset.marca) {
                const marcaModelo = asset.modelo ? 
                    `${asset.marca} - ${asset.modelo}` : asset.marca;
                pdf.text(`Marca: ${marcaModelo}`, infoX, currentY + 0.1);
                currentY += lineHeight;
            }
            
            // Número de serie (si existe)
            if (asset.numero_serie) {
                pdf.setFontSize(6);
                pdf.setTextColor(100, 100, 100);
                const serie = asset.numero_serie.length > 20 ?
                    asset.numero_serie.substring(0, 20) + '...' : asset.numero_serie;
                pdf.text(`Serie: ${serie}`, infoX, currentY + 0.1);
                currentY += lineHeight * 0.8;
            }
            
            // Estado con color
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'bold');
            const statusColor = getStatusColor(asset.estado);
            pdf.setTextColor(statusColor.r, statusColor.g, statusColor.b);
            pdf.text(`● ${asset.estado.toUpperCase()}`, infoX, currentY + 0.3);
            
            // Fecha en la parte inferior
            pdf.setFontSize(5);
            pdf.setTextColor(150, 150, 150);
            pdf.setFont('helvetica', 'normal');
            const fecha = new Date(asset.fecha_registro).toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            pdf.text(`Registro: ${fecha}`, infoX, margin + 4.0);
            
            // Código de barras simbólico
            drawSimpleBarcode(pdf, asset.codigo, infoX, margin + 4.3, 6.5, 0.3);
        }

        // INFORMACIÓN DEL ACTIVO - DISEÑO PREMIUM
        function drawAssetInfoSection(pdf, asset, margin, contentWidth) {
            const infoX = margin + 3.2;
            const infoY = margin + 1.3;
            const infoWidth = contentWidth - 3.5;
            
            // Fondo de la sección de información
            pdf.setFillColor(255, 255, 255);
            pdf.roundedRect(infoX - 0.1, infoY - 0.1, infoWidth + 0.2, 3.3, 0.1, 0.1, 'F');
            
            // Borde sutil
            pdf.setDrawColor(230, 230, 230);
            pdf.setLineWidth(0.02);
            pdf.roundedRect(infoX - 0.1, infoY - 0.1, infoWidth + 0.2, 3.3, 0.1, 0.1);
            
            let currentY = infoY + 0.4;
            
            // CÓDIGO PRINCIPAL (DESTACADO)
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.setTextColor(203, 62, 44);
            pdf.text(asset.codigo, infoX + 0.1, currentY);
            currentY += 0.6;
            
            // Línea divisoria
            pdf.setDrawColor(203, 62, 44);
            pdf.setLineWidth(0.03);
            pdf.line(infoX + 0.1, currentY - 0.3, infoX + infoWidth - 0.2, currentY - 0.3);
            
            // NOMBRE DEL ACTIVO
            pdf.setFontSize(8);
            pdf.setTextColor(0, 0, 0);
            
            const assetName = formatTextForPDF(asset.nombre, 25);
            const nameLines = pdf.splitTextToSize(assetName, infoWidth - 0.4);
            nameLines.forEach(line => {
                pdf.text(line, infoX + 0.1, currentY);
                currentY += 0.4;
            });
            
            currentY += 0.1;
            
            // INFORMACIÓN DETALLADA
            pdf.setFontSize(6);
            pdf.setTextColor(80, 80, 80);
            
            // Tipo
            pdf.setFont('helvetica', 'bold');
            pdf.text('Tipo:', infoX + 0.1, currentY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(asset.tipo_activo, infoX + 1.0, currentY);
            currentY += 0.35;
            
            // Marca
            if (asset.marca) {
                pdf.setFont('helvetica', 'bold');
                pdf.text('Marca:', infoX + 0.1, currentY);
                pdf.setFont('helvetica', 'normal');
                pdf.text(asset.marca, infoX + 1.0, currentY);
                currentY += 0.35;
            }
            
            // Modelo
            if (asset.modelo) {
                pdf.setFont('helvetica', 'bold');
                pdf.text('Modelo:', infoX + 0.1, currentY);
                pdf.setFont('helvetica', 'normal');
                pdf.text(asset.modelo, infoX + 1.0, currentY);
                currentY += 0.35;
            }
            
            // ESTADO (DESTACADO)
            currentY += 0.1;
            const statusColor = getStatusColor(asset.estado);
            
            // Badge del estado
            pdf.setFillColor(statusColor.r, statusColor.g, statusColor.b);
            pdf.roundedRect(infoX + 0.1, currentY - 0.15, 1.8, 0.3, 0.15, 0.15, 'F');
            
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(5);
            pdf.setTextColor(255, 255, 255);
            pdf.text(asset.estado.toUpperCase(), infoX + 1.0, currentY, { align: 'center' });
        }

        // MEJORAR FORMATO DE TEXTO
        function formatTextForPDF(text, maxLength) {
            if (text.length <= maxLength) return text.toUpperCase();
            return text.substring(0, maxLength - 3).toUpperCase() + '...';
        }

        // FORMATEAR TEXTO PARA PDF
        function formatTextForPDF(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        // ===== MODAL PARA PDF MASIVO DE ACTIVOS =====

        function showPdfFormatModalForAllAssets(source) {
            console.log('🚀 Abriendo modal PDF masivo para activos - Diseño adaptable');
            
            // ✅ Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalAllAssets').forEach(modal => modal.remove());

            const assetCount = AppState.assets ? AppState.assets.length : 0;
            
            // ✅ CREAR MODAL CON DISEÑO ESPECÍFICO PARA ACTIVOS
            const modalHtml = `
                <div id="pdfFormatModalAllAssets" class="simple-pdf-modal" style="display: flex;">
                    <div class="modal-overlay" id="overlayPdfModalAllAssets"></div>
                    <div class="modal-container simple-modal">
                        <!-- Header -->
                        <div class="modal-header simple-header">
                            <div class="header-title">
                                <i class="fas fa-file-pdf"></i>
                                <div>
                                    <h3>Generar Etiquetas de Activos</h3>
                                    <p>${assetCount} activos seleccionados</p>
                                </div>
                            </div>
                            <button class="close-btn" id="closePdfModalAllAssetsBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body simple-body">
                            <div class="format-options">
                                <div class="format-option active" data-format="asset-small-horizontal">
                                    <div class="format-icon">
                                        <i class="fas fa-laptop"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Etiqueta Pequeña</h4>
                                        <p>7.5×5cm • Ideal para la mayoría de activos</p>
                                        <div class="format-meta">Recomendado</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="asset-medium-horizontal">
                                    <div class="format-icon">
                                        <i class="fas fa-expand-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Etiqueta Mediana</h4>
                                        <p>10×5cm • Más espacio para especificaciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-option" data-format="asset-inventory-summary">
                                    <div class="format-icon">
                                        <i class="fas fa-list-alt"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Inventario Completo</h4>
                                        <p>Formato A4 • Listado completo de activos</p>
                                        <div class="format-meta inventory">Inventario</div>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div class="summary-section">
                                <div class="summary-item">
                                    <span class="summary-label">Total de activos:</span>
                                    <span class="summary-value">${assetCount}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value format-selected" id="simpleFormatDisplayAssets">Etiqueta Pequeña</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer simple-footer">
                            <button class="btn btn-cancel" id="cancelPdfModalAllAssetsBtn">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                            <button class="btn btn-generate" id="generatePdfModalAllAssetsBtn">
                                <i class="fas fa-file-pdf"></i>
                                Generar PDF
                                <span class="badge">${assetCount}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ✅ INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ✅ CONFIGURAR EVENT LISTENERS
            setupPdfModalAllAssetsEvents(source);
        }

        function setupPdfModalAllAssetsEvents(source) {
            let selectedFormat = 'asset-small-horizontal';
            
            // Seleccionar formato
            document.querySelectorAll('#pdfFormatModalAllAssets .format-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedFormat = this.getAttribute('data-format');
                    
                    // Remover activo de todos
                    document.querySelectorAll('#pdfFormatModalAllAssets .format-option').forEach(opt => {
                        opt.classList.remove('active');
                        opt.querySelector('.check-circle').classList.remove('active');
                    });
                    
                    // Activar seleccionado
                    this.classList.add('active');
                    this.querySelector('.check-circle').classList.add('active');
                    
                    // Actualizar texto
                    const formatNames = {
                        'asset-small-horizontal': 'Etiqueta Pequeña',
                        'asset-medium-horizontal': 'Etiqueta Mediana', 
                        'asset-inventory-summary': 'Inventario Completo'
                    };
                    
                    document.getElementById('simpleFormatDisplayAssets').textContent = formatNames[selectedFormat];
                });
            });
            
            // Cerrar modal
            const closeModal = () => {
                const modal = document.getElementById('pdfFormatModalAllAssets');
                if (modal) {
                    modal.style.display = 'none';
                    setTimeout(() => modal.remove(), 300);
                }
            };
            
            document.getElementById('closePdfModalAllAssetsBtn').addEventListener('click', closeModal);
            document.getElementById('cancelPdfModalAllAssetsBtn').addEventListener('click', closeModal);
            document.getElementById('overlayPdfModalAllAssets').addEventListener('click', closeModal);
            
            // Generar PDF
            document.getElementById('generatePdfModalAllAssetsBtn').addEventListener('click', function() {
                if (!selectedFormat) {
                    showToast('Selecciona un formato primero', 'warning');
                    return;
                }
                
                closeModal();
                setTimeout(() => generatePdfForAllAssets(selectedFormat, source), 100);
            });
            
            // Cerrar con ESC
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // ===== FUNCIONES PARA PDF INDIVIDUAL DE ACTIVOS =====

        // ===== FUNCIÓN PRINCIPAL CORREGIDA =====
        function generateSingleAssetPdf(assetId) {
            console.log('🎯 Generando PDF individual para activo:', assetId);
            
            try {
                // Buscar el activo en el estado de la aplicación
                const asset = AppState.assets.find(a => a.id === assetId);
                if (!asset) {
                    showToast('Activo no encontrado', 'error');
                    return;
                }

                console.log('📄 Activo encontrado:', asset.codigo);
                
                // Mostrar el modal de selección de formato
                showPdfFormatModalForAsset(asset);
                
            } catch (error) {
                console.error('❌ Error en generateSingleAssetPdf:', error);
                showToast('Error al preparar la generación de etiqueta', 'error');
            }
        }

        function showPdfFormatModalForAsset(asset) {
            console.log('📄 Abriendo modal PDF individual para activo:', asset.codigo);
            
            // ✅ Cerrar modales existentes
            document.querySelectorAll('#pdfFormatModalAssetIndividual').forEach(modal => modal.remove());

            // ✅ CREAR MODAL INDIVIDUAL CON ESTILOS CORRECTOS
            const modalHtml = `
                <div id="pdfFormatModalAssetIndividual" class="modal" style="display: flex;">
                    <div class="modal-overlay" id="overlayPdfModalAssetIndividual"></div>
                    <div class="modal-content" style="max-width: 500px;">
                        <!-- Header -->
                        <div class="modal-header">
                            <h3>Generar Etiqueta</h3>
                            <button class="close-modal" id="closePdfModalAssetIndividualBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Body -->
                        <div class="modal-body">
                            <!-- Información del Activo -->
                            <div class="asset-info-card" style="background: var(--light-color); padding: 1rem; border-radius: var(--border-radius-sm); margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--text-color);">${asset.codigo}</h4>
                                    <span class="asset-status status-${asset.estado?.toLowerCase().replace(' ', '-') || 'sin-estado'}" 
                                        style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">
                                        ${asset.estado || 'Sin estado'}
                                    </span>
                                </div>
                                <div style="color: var(--text-color);">
                                    <div style="margin-bottom: 0.25rem;"><strong>Nombre:</strong> ${asset.nombre}</div>
                                    <div style="margin-bottom: 0.25rem;"><strong>Tipo:</strong> ${asset.tipo_activo}</div>
                                    <div style="margin-bottom: 0.25rem;"><strong>Ubicación:</strong> ${asset.ubicacion}</div>
                                    ${asset.marca ? `<div><strong>Marca:</strong> ${asset.marca}</div>` : ''}
                                </div>
                            </div>

                            <!-- Opciones de Formato -->
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="margin-bottom: 1rem; color: var(--text-color);">Selecciona el formato:</h4>
                                
                                <div class="format-options-container">
                                    <div class="format-option active" data-format="asset-small-horizontal" 
                                        style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--primary-color); border-radius: var(--border-radius); margin-bottom: 0.75rem; cursor: pointer; background: var(--card-bg);">
                                        <div style="margin-right: 1rem; color: var(--primary-color);">
                                            <i class="fas fa-tag" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                                                Etiqueta Pequeña
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                                7.5×5cm • Ideal para la mayoría de activos
                                            </div>
                                        </div>
                                        <div class="check-circle active" style="width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>
                                        </div>
                                    </div>

                                    <div class="format-option" data-format="asset-medium-horizontal" 
                                        style="display: flex; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 0.75rem; cursor: pointer; background: var(--card-bg);">
                                        <div style="margin-right: 1rem; color: var(--text-muted);">
                                            <i class="fas fa-expand-alt" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">
                                                Etiqueta Mediana
                                            </div>
                                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                                10×5cm • Más espacio para especificaciones
                                            </div>
                                        </div>
                                        <div class="check-circle" style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-check" style="color: transparent; font-size: 0.8rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen -->
                            <div style="background: var(--light-color); padding: 1rem; border-radius: var(--border-radius-sm);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="color: var(--text-color);">Activo:</span>
                                    <span style="font-weight: 600; color: var(--text-color);">${asset.codigo}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-color);">Formato seleccionado:</span>
                                    <span style="font-weight: 600; color: var(--primary-color);" id="simpleFormatDisplayAssetIndividual">Etiqueta Pequeña</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelPdfModalAssetIndividualBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" id="generatePdfModalAssetIndividualBtn">
                                <i class="fas fa-file-pdf"></i> Generar Etiqueta
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ✅ INSERTAR MODAL
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ✅ MOSTRAR MODAL INMEDIATAMENTE
            const modal = document.getElementById('pdfFormatModalAssetIndividual');
            if (modal) {
                modal.classList.add('active');
                console.log('✅ Modal mostrado correctamente');
            }
            
            // ✅ CONFIGURAR EVENT LISTENERS
            setupPdfModalAssetIndividualEvents(asset);
        }

        function setupPdfModalAssetIndividualEvents(asset) {
            let selectedFormat = 'asset-small-horizontal';
            
            // Seleccionar formato
            document.querySelectorAll('#pdfFormatModalAssetIndividual .format-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedFormat = this.getAttribute('data-format');
                    
                    console.log('🎯 Formato seleccionado:', selectedFormat);
                    
                    // Remover activo de todos
                    document.querySelectorAll('#pdfFormatModalAssetIndividual .format-option').forEach(opt => {
                        opt.style.borderColor = 'var(--border-color)';
                        opt.style.borderWidth = '1px';
                        const icon = opt.querySelector('i.fas:first-child');
                        if (icon) icon.style.color = 'var(--text-muted)';
                        
                        const checkCircle = opt.querySelector('.check-circle');
                        if (checkCircle) {
                            checkCircle.style.background = 'transparent';
                            checkCircle.style.border = '2px solid var(--border-color)';
                            const checkIcon = checkCircle.querySelector('i.fas');
                            if (checkIcon) checkIcon.style.color = 'transparent';
                        }
                    });
                    
                    // Activar seleccionado
                    this.style.borderColor = 'var(--primary-color)';
                    this.style.borderWidth = '2px';
                    const icon = this.querySelector('i.fas:first-child');
                    if (icon) icon.style.color = 'var(--primary-color)';
                    
                    const checkCircle = this.querySelector('.check-circle');
                    if (checkCircle) {
                        checkCircle.style.background = 'var(--primary-color)';
                        checkCircle.style.border = 'none';
                        const checkIcon = checkCircle.querySelector('i.fas');
                        if (checkIcon) checkIcon.style.color = 'white';
                    }
                    
                    // Actualizar texto
                    const formatNames = {
                        'asset-small-horizontal': 'Etiqueta Pequeña',
                        'asset-medium-horizontal': 'Etiqueta Mediana'
                    };
                    
                    const displayElement = document.getElementById('simpleFormatDisplayAssetIndividual');
                    if (displayElement) {
                        displayElement.textContent = formatNames[selectedFormat] || selectedFormat;
                    }
                });
            });
            
            // Cerrar modal
            const closeModal = () => {
                const modal = document.getElementById('pdfFormatModalAssetIndividual');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    }, 300);
                }
            };
            
            // Configurar eventos de cierre
            const closeBtn = document.getElementById('closePdfModalAssetIndividualBtn');
            const cancelBtn = document.getElementById('cancelPdfModalAssetIndividualBtn');
            const overlay = document.getElementById('overlayPdfModalAssetIndividual');
            
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            if (overlay) overlay.addEventListener('click', closeModal);
            
            // Generar PDF
            const generateBtn = document.getElementById('generatePdfModalAssetIndividualBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    if (!selectedFormat) {
                        showToast('Selecciona un formato primero', 'warning');
                        return;
                    }

                    console.log('🚀 Generando PDF individual para activo:', {
                        asset: asset.codigo,
                        format: selectedFormat
                    });

                    closeModal();
                    
                    // Pequeño delay antes de generar
                    setTimeout(() => {
                        generateSingleAssetPdfFormat(asset, selectedFormat);
                    }, 100);
                });
            }
            
            // Cerrar con ESC
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            console.log('✅ Event listeners del modal configurados correctamente');
        }

        // ===== FUNCIONES DE GENERACIÓN DE PDF PARA ACTIVOS =====

        function generatePdfForAllAssets(format, source) {
            console.log('🖨️ Generando PDF masivo para activos:', { 
                format, 
                source, 
                assetCount: AppState.assets.length 
            });
            
            switch (format) {
                case 'asset-small-horizontal':
                    generateAllSmallHorizontalAssetTickets();
                    break;
                case 'asset-medium-horizontal':
                    generateAllMediumHorizontalAssetTickets();
                    break;
                case 'asset-inventory-summary':
                    generateAssetInventorySummaryPdf();
                    break;
                default:
                    showToast('Formato de PDF no válido', 'error');
            }
        }

        // ===== VERIFICAR QUE LAS FUNCIONES DE GENERACIÓN ESTÉN DISPONIBLES =====
        // Asegurarse de que estas funciones existen
        if (typeof generateSmallHorizontalAssetTicket === 'undefined') {
            console.warn('⚠️ generateSmallHorizontalAssetTicket no está definida');
            // Definir una versión básica como fallback
            async function generateSmallHorizontalAssetTicket(asset) {
                showToast(`Función de generación de etiqueta pequeña para ${asset.codigo}`, 'info');
            }
        }

        if (typeof generateMediumHorizontalAssetTicket === 'undefined') {
            console.warn('⚠️ generateMediumHorizontalAssetTicket no está definida');
            // Definir una versión básica como fallback
            async function generateMediumHorizontalAssetTicket(asset) {
                showToast(`Función de generación de etiqueta mediana para ${asset.codigo}`, 'info');
            }
        }

        // ===== FUNCIÓN PRINCIPAL PARA GENERAR PDF DE ACTIVO INDIVIDUAL =====
        async function generateSingleAssetPdfFormat(asset, format) {
            console.log('🖨️ Generando PDF para activo:', asset.codigo, 'Formato:', format);
            
            try {
                // Mostrar progreso
                pdfProgress.show(1, format);
                pdfProgress.updateStatus(`Generando etiqueta para: ${asset.codigo}`);

                // Llamar directamente a las funciones de generación
                // que manejan el pdf.save() internamente
                switch (format) {
                    case 'asset-small-horizontal':
                        await generateSmallHorizontalAssetTicket(asset);
                        break;
                        
                    case 'asset-medium-horizontal':
                        await generateMediumHorizontalAssetTicket(asset);
                        break;
                        
                    default:
                        throw new Error(`Formato no soportado: ${format}`);
                }

                // Éxito
                pdfProgress.showSuccess();
                
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`✅ Etiqueta generada para ${asset.codigo}`, 'success');
                }, 1000);

            } catch (error) {
                console.error('❌ Error en generateSingleAssetPdfFormat:', error);
                pdfProgress.showError(error);
                
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar la etiqueta: ' + error.message, 'error');
                }, 2000);
            }
        }

        // ===== 1. FUNCIÓN PARA GENERAR TODAS LAS ETIQUETAS PEQUEÑAS DE ACTIVOS =====
        async function generateAllSmallHorizontalAssetTickets() {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }

            try {
                const validAssets = AppState.assets.filter(asset => 
                    asset.codigo && asset.nombre
                );

                if (validAssets.length === 0) {
                    showToast('No hay activos válidos para generar etiquetas', 'warning');
                    return;
                }

                // ✅ MOSTRAR PROGRESO
                pdfProgress.show(validAssets.length, 'asset-small-horizontal');
                pdfProgress.updateStep(2, 'active');
                pdfProgress.updateStatus('Creando documento PDF para activos...');

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString();
                const generationTime = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Obtener información del usuario
                const userName = AppState.currentUser?.userName || 'Administrador';

                for (let index = 0; index < validAssets.length; index++) {
                    // ✅ VERIFICAR SI SE CANCELÓ
                    if (pdfProgress.isCancelled) {
                        console.log('Generación cancelada por el usuario');
                        return;
                    }

                    const asset = validAssets[index];
                    
                    if (index > 0) {
                        pdf.addPage([7.5, 5], 'landscape');
                    }

                    // ✅ ACTUALIZAR PROGRESO
                    const progress = ((index + 1) / validAssets.length) * 100;
                    pdfProgress.updateProgress(progress, index + 1, validAssets.length);
                    pdfProgress.updateStatus(`Generando etiqueta para: ${asset.codigo}`);

                    // ===== DIMENSIONES =====
                    const pageWidth = 7.5;
                    const pageHeight = 5;
                    const margin = 0.4;
                    let currentY = 0.5;

                    // ===== FONDO =====
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                    // ===== LOGO/CABECERA CORPORATIVA =====
                    pdf.setFillColor(203, 62, 44); // Color corporativo Gallos Mármol
                    pdf.rect(0, 0, pageWidth, 0.6, 'F');
                    
                    pdf.setFontSize(8);
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('GALLOS MÁRMOL', pageWidth / 2, 0.35, { align: 'center' });
                    
                    currentY = 0.8;

                    // ===== CÓDIGO DEL ACTIVO (PRINCIPAL) =====
                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(asset.codigo, pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.3;

                    // Línea separadora
                    pdf.setDrawColor(203, 62, 44);
                    pdf.setLineWidth(0.03);
                    pdf.line(margin, currentY, pageWidth - margin, currentY);
                    currentY += 0.3;

                    // ===== NOMBRE DEL ACTIVO =====
                    pdf.setFontSize(7);
                    pdf.setTextColor(40, 40, 40);
                    pdf.setFont('helvetica', 'bold');
                    
                    const nombre = asset.nombre || 'Sin nombre';
                    const maxWidth = pageWidth - (margin * 2);
                    const nombreLines = pdf.splitTextToSize(nombre, maxWidth);
                    
                    pdf.text(nombreLines.slice(0, 2), pageWidth / 2, currentY, { align: 'center' });
                    currentY += 0.5;

                    // ===== INFORMACIÓN ESPECÍFICA DEL ACTIVO =====
                    const assetDetails = [];
                    
                    if (asset.tipo_activo) {
                        assetDetails.push({ label: 'TIPO', value: asset.tipo_activo });
                    }
                    
                    if (asset.marca) {
                        assetDetails.push({ label: 'MARCA', value: asset.marca });
                    }
                    
                    if (asset.ubicacion) {
                        assetDetails.push({ label: 'UBICACIÓN', value: asset.ubicacion });
                    }
                    
                    if (asset.estado) {
                        assetDetails.push({ label: 'ESTADO', value: asset.estado });
                    }

                    // Dibujar detalles en dos columnas
                    assetDetails.forEach((detail, detailIndex) => {
                        if (currentY < pageHeight - 1.5) {
                            const isLeftColumn = detailIndex % 2 === 0;
                            const boxWidth = (pageWidth - (margin * 2) - 0.2) / 2;
                            const boxX = isLeftColumn ? margin : margin + boxWidth + 0.2;
                            
                            // Fondo del detalle
                            pdf.setFillColor(248, 249, 250);
                            pdf.roundedRect(boxX, currentY, boxWidth, 0.4, 0.1, 0.1, 'F');
                            
                            // Etiqueta
                            pdf.setFontSize(5);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(100, 100, 100);
                            pdf.text(detail.label + ':', boxX + 0.1, currentY + 0.15);
                            
                            // Valor
                            pdf.setFontSize(6);
                            pdf.setFont('helvetica', 'normal');
                            pdf.setTextColor(0, 0, 0);
                            
                            const valueLines = pdf.splitTextToSize(detail.value, boxWidth - 0.2);
                            pdf.text(valueLines[0], boxX + 0.1, currentY + 0.3);
                            
                            // Nueva línea si hay más detalles
                            if (detailIndex % 2 !== 0) {
                                currentY += 0.5;
                            }
                        }
                    });

                    // Ajustar posición si no se completó la última fila
                    if (assetDetails.length % 2 !== 0) {
                        currentY += 0.5;
                    }

                    // ===== CÓDIGO QR =====
                    pdfProgress.updateStep(3, 'active');
                    pdfProgress.updateStatus(`Generando código QR para: ${asset.codigo}`);
                    
                    const qrDataURL = await generateAssetQRCodeDataURL(asset);
                    
                    if (qrDataURL && currentY < pageHeight - 2.5) {
                        const qrSize = 1.8;
                        const qrX = (pageWidth - qrSize) / 2;
                        
                        // Marco para QR
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.1, 0.1, 'F');
                        pdf.setDrawColor(200, 200, 200);
                        pdf.roundedRect(qrX - 0.1, currentY - 0.1, qrSize + 0.2, qrSize + 0.2, 0.1, 0.1);
                        
                        pdf.addImage(qrDataURL, 'PNG', qrX, currentY, qrSize, qrSize);
                        
                        // Texto bajo QR
                        pdf.setFontSize(4);
                        pdf.setTextColor(100, 100, 100);
                        pdf.text('ESCANEAR CÓDIGO', pageWidth / 2, currentY + qrSize + 0.3, { align: 'center' });
                    }

                    // ===== PIE DE PÁGINA =====
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.02);
                    pdf.line(margin, pageHeight - 0.5, pageWidth - margin, pageHeight - 0.5);

                    pdf.setFontSize(4);
                    pdf.setTextColor(120, 120, 120);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Sistema de Activos TI • ${generationDate}`, pageWidth / 2, pageHeight - 0.3, { align: 'center' });
                    pdf.text(`Generado por: ${userName}`, pageWidth / 2, pageHeight - 0.1, { align: 'center' });

                    // Pequeña pausa para que se vea el progreso
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // ✅ MOSTRAR ÉXITO
                pdfProgress.updateStep(4, 'active');
                pdfProgress.updateStatus('Guardando archivo PDF...');

                // ===== GUARDAR PDF =====
                const fileName = `etiquetas_activos_pequenas_${now.getTime()}.pdf`;
                
                // Pequeño delay para que se vea el 100%
                await new Promise(resolve => setTimeout(resolve, 500));
                
                pdf.save(fileName);
                
                // ✅ MOSTRAR ÉXITO FINAL
                pdfProgress.showSuccess();
                
                // Ocultar después de 2 segundos
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast(`PDF con ${validAssets.length} etiquetas de activos generado`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error generando etiquetas pequeñas de activos:', error);
                pdfProgress.showError(error);
                
                // Ocultar después de 3 segundos en error
                setTimeout(() => {
                    pdfProgress.hide();
                    showToast('Error al generar etiquetas de activos: ' + error.message, 'error');
                }, 3000);
            }
        }

        // ===== 1. FUNCIÓN PARA GENERAR ETIQUETA INDIVIDUAL PEQUEÑA =====
        async function generateSmallHorizontalAssetTicket(asset) {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar activo
                if (!asset) {
                    showToast('Activo no válido para generar etiqueta', 'error');
                    return;
                }

                // Mostrar progreso
                pdfProgress.show(1, 'asset-small-horizontal');
                pdfProgress.updateStatus(`Creando etiqueta para: ${asset.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [7.5, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const generationTime = now.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ===== OBTENER NOMBRE DEL USUARIO =====
                let userDisplayName = 'Administrador';
                
                if (AppState.currentUser) {
                    const user = AppState.currentUser;
                    
                    // Prioridad 1: userFullName (si se cargó de la BD)
                    if (user.userFullName) {
                        userDisplayName = user.userFullName;
                    }
                    // Prioridad 2: userName de AuthChecker
                    else if (user.userName && user.userName !== 'Administrador') {
                        userDisplayName = user.userName;
                    }
                    // Prioridad 3: Extraer nombre del correo
                    else if (user.userEmail) {
                        const emailParts = user.userEmail.split('@')[0];
                        userDisplayName = emailParts
                            .replace(/[.-]/g, ' ') // Reemplazar puntos y guiones por espacios
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                    }
                }

                console.log('👤 Usuario para etiqueta:', userDisplayName);

                // ===== DIMENSIONES =====
                const pageWidth = 7.5;
                const pageHeight = 5;
                const margin = 0.3;
                let currentY = margin;

                // ===== FONDO BLANCO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // ===== LOGO DE LA EMPRESA =====
                currentY = margin + 0.4;
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                pdf.text('GALLOS MÁRMOL', pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.6;

                // ===== CÓDIGO DEL ACTIVO (MUY DESTACADO) =====
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                pdf.text(asset.codigo, pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.8;

                // ===== INFORMACIÓN DEL ACTIVO =====
                const lineHeight = 0.45;
                const columnWidth = pageWidth - (margin * 2);
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(6);

                // Función para manejar texto largo
                const addInfoLine = (label, value, yPosition) => {
                    if (!value || value === 'Sin marca' || value === 'No especificado' || value === 'N/A') {
                        return yPosition;
                    }
                    
                    const maxLabelWidth = 2.0;
                    const maxValueWidth = columnWidth - maxLabelWidth - 0.3;
                    
                    // Etiqueta (negrita, izquierda)
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text(label + ':', margin, yPosition);
                    
                    // Valor (normal, derecha)
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    
                    // Manejar texto largo
                    const valueLines = splitTextToFit(value, maxValueWidth, pdf);
                    
                    if (valueLines.length === 1) {
                        pdf.text(valueLines[0], margin + maxLabelWidth, yPosition);
                        return yPosition + lineHeight;
                    } else {
                        pdf.text(valueLines[0], margin + maxLabelWidth, yPosition);
                        if (valueLines.length > 1) {
                            pdf.text(valueLines[1], margin + maxLabelWidth, yPosition + lineHeight * 0.7);
                        }
                        return yPosition + (lineHeight * (1 + (valueLines.length > 1 ? 0.7 : 0)));
                    }
                };

                // Función auxiliar para dividir texto
                function splitTextToFit(text, maxWidth, pdf) {
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = words[0];

                    for (let i = 1; i < words.length; i++) {
                        const word = words[i];
                        const width = pdf.getTextWidth(currentLine + ' ' + word);
                        if (width < maxWidth) {
                            currentLine += ' ' + word;
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    lines.push(currentLine);
                    
                    // Limitar a 2 líneas máximo
                    return lines.slice(0, 2).map(line => 
                        line.length > 35 ? line.substring(0, 35) + '...' : line
                    );
                }

                // Agregar información
                currentY = addInfoLine('TIPO', asset.tipo_activo || 'No especificado', currentY);
                currentY = addInfoLine('MARCA', asset.marca, currentY);
                currentY = addInfoLine('MODELO', asset.modelo, currentY);

                // ===== FOOTER CON DATOS DEL USUARIO =====
                const footerY = pageHeight - 0.7;
                
                // Información de generación
                pdf.setFontSize(5);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');
                
                // Fecha y hora (izquierda)
                const dateTimeText = `Creado: ${generationDate} ${generationTime}`;
                pdf.text(dateTimeText, margin, footerY - 0.1);
                
                // Usuario (derecha) - CON DATOS REALES
                const userText = `Creado por: ${userDisplayName}`;
                pdf.text(userText, pageWidth - margin, footerY - 0.1, { align: 'right' });

                // ===== BORDE DE SEGURIDAD =====
                pdf.setDrawColor(200, 200, 200);
                pdf.setLineWidth(0.02);
                pdf.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);

                // ===== GUARDAR PDF =====
                const fileName = `etiqueta_${asset.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // Mostrar éxito
                pdfProgress.hide();
                showToast(`Etiqueta generada para ${asset.codigo}`, 'success');

            } catch (error) {
                console.error('Error generando etiqueta:', error);
                pdfProgress.hide();
                showToast('Error al generar la etiqueta', 'error');
            }
        }

        async function generateMediumHorizontalAssetTicket(asset) {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                showToast('Error: Librería PDF no disponible', 'error');
                return;
            }
            
            try {
                // Validar activo
                if (!asset) {
                    showToast('Activo no válido para generar etiqueta', 'error');
                    return;
                }

                // Mostrar progreso
                pdfProgress.show(1, 'asset-medium-horizontal');
                pdfProgress.updateStatus(`Creando etiqueta mediana para: ${asset.codigo}`);

                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "cm",
                    format: [10, 5]
                });

                const now = new Date();
                const generationDate = now.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const generationTime = now.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ===== OBTENER NOMBRE DEL USUARIO =====
                let userDisplayName = 'Administrador';
                
                if (AppState.currentUser) {
                    const user = AppState.currentUser;
                    
                    if (user.userFullName) {
                        userDisplayName = user.userFullName;
                    }
                    else if (user.userName && user.userName !== 'Administrador') {
                        userDisplayName = user.userName;
                    }
                    else if (user.userEmail) {
                        const emailParts = user.userEmail.split('@')[0];
                        userDisplayName = emailParts
                            .replace(/[.-]/g, ' ')
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                    }
                }

                // ===== DIMENSIONES MEDIANAS =====
                const pageWidth = 10;
                const pageHeight = 5;
                const margin = 0.4;
                let currentY = margin;

                // ===== FONDO BLANCO =====
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');

                // ===== LOGO DE LA EMPRESA =====
                currentY = margin + 0.4;  // Reducido de 0.5
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text('GALLOS MÁRMOL', pageWidth / 2, currentY, { align: 'center' });
                currentY += 0.8;  // Reducido de 0.8

                // ===== CÓDIGO DEL ACTIVO =====
                pdf.setFontSize(18);
                pdf.setTextColor(0, 0, 0);
                pdf.setFont('helvetica', 'bold');
                // Dibujar el código
                pdf.text(asset.codigo, pageWidth / 2, currentY, { align: 'center' });
                const codigoTextHeight = 0.45;
                currentY += codigoTextHeight + 0.15; // Solo 0.15cm de separación

                // ===== INFORMACIÓN DEL ACTIVO =====
                const lineHeight = 0.5;
                const columnWidth = pageWidth - (margin * 2);
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);

                // Función para manejar texto largo
                const addInfoLine = (label, value, yPosition) => {
                    if (!value || value === 'Sin marca' || value === 'No especificado' || value === 'N/A') {
                        return yPosition;
                    }
                    
                    const maxLabelWidth = 2.5;
                    const maxValueWidth = columnWidth - maxLabelWidth - 0.4;
                    
                    // Etiqueta
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text(label + ':', margin, yPosition);
                    
                    // Valor
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    
                    const valueLines = splitTextToFitMedium(value, maxValueWidth, pdf);
                    
                    if (valueLines.length === 1) {
                        pdf.text(valueLines[0], margin + maxLabelWidth, yPosition);
                        return yPosition + lineHeight;
                    } else {
                        pdf.text(valueLines[0], margin + maxLabelWidth, yPosition);
                        if (valueLines.length > 1) {
                            pdf.text(valueLines[1], margin + maxLabelWidth, yPosition + lineHeight * 0.8);
                        }
                        return yPosition + (lineHeight * (1 + (valueLines.length > 1 ? 0.8 : 0)));
                    }
                };

                function splitTextToFitMedium(text, maxWidth, pdf) {
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = words[0];

                    for (let i = 1; i < words.length; i++) {
                        const word = words[i];
                        const width = pdf.getTextWidth(currentLine + ' ' + word);
                        if (width < maxWidth) {
                            currentLine += ' ' + word;
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    lines.push(currentLine);
                    
                    return lines.slice(0, 2).map(line => 
                        line.length > 45 ? line.substring(0, 45) + '...' : line
                    );
                }

                // Agregar información
                currentY = addInfoLine('Tipo', asset.tipo_activo || 'No especificado', currentY);
                currentY = addInfoLine('Marca', asset.marca, currentY);
                currentY = addInfoLine('Modelo', asset.modelo, currentY);
                currentY = addInfoLine('Serie', asset.numero_serie, currentY);

                // ===== FOOTER =====
                const footerY = pageHeight - 0.7;  // Ajustado
                
                pdf.setFontSize(6);
                pdf.setTextColor(120, 120, 120);
                pdf.setFont('helvetica', 'normal');

                // Fecha y hora (izquierda)
                const dateTimeText = `Creado: ${generationDate} ${generationTime}`;
                pdf.text(dateTimeText, margin, footerY - 0.1);
                
                // Usuario (derecha) - CON DATOS REALES
                const userText = `Creado por: ${userDisplayName}`;
                pdf.text(userText, pageWidth - margin, footerY - 0.1, { align: 'right' });                

                // ===== BORDE DE SEGURIDAD =====
                pdf.setDrawColor(180, 180, 180);
                pdf.setLineWidth(0.03);
                pdf.rect(margin / 2, margin / 2, pageWidth - margin, pageHeight - margin);

                // ===== GUARDAR PDF =====
                const fileName = `etiqueta_mediana_${asset.codigo}_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                // Mostrar éxito
                pdfProgress.hide();
                showToast(`Etiqueta mediana generada para ${asset.codigo}`, 'success');

            } catch (error) {
                console.error('Error generando etiqueta mediana:', error);
                pdfProgress.hide();
                showToast('Error al generar la etiqueta mediana', 'error');
            }
        }

        // ===== FUNCIONES PARA EL MODAL DE ESPECIFICACIONES =====

        function abrirModalEspecificaciones(activoId, activoNombre = '') {
            try {
                console.log('🔧 Debug: abrirModalEspecificaciones llamado', {
                    activoId,
                    activoNombre,
                    tipoActivoNombre: typeof activoNombre
                });
                
                // Usar nombre seguro (escapado si es necesario)
                const nombreSeguro = String(activoNombre || '');
                
                renderizarModalEspecificaciones(activoId, nombreSeguro);
            } catch (error) {
                console.error('❌ Error crítico en abrirModalEspecificaciones:', error);
                console.error('Datos problemáticos:', { activoId, activoNombre });
                showToast('Error al abrir especificaciones: ' + error.message, 'error');
            }
        }

        function renderizarModalEspecificaciones(activoId = null, activoNombre = '') {
            // Cerrar modal existente si hay uno
            cerrarModalEspecificaciones();
            
            // Crear modal manualmente
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'especificacionesModal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '800px';
            
            // Header
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            
            const title = document.createElement('h3');
            title.textContent = '🛠️ Especificaciones Técnicas';
            
            const subtitle = document.createElement('p');
            subtitle.style.margin = '0';
            subtitle.style.color = 'var(--text-muted)';
            subtitle.style.fontSize = '0.9rem';
            subtitle.textContent = activoNombre || 'Nuevo activo';
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-modal';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = cerrarModalEspecificaciones;
            
            modalHeader.appendChild(title);
            modalHeader.appendChild(subtitle);
            modalHeader.appendChild(closeBtn);
            
            // Body
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body';
            
            // Quick specs
            const quickSpecs = createQuickSpecsSection();
            modalBody.appendChild(quickSpecs);
            
            // Specs list
            const specsList = createSpecsListSection();
            modalBody.appendChild(specsList);
            
            // Custom spec
            const customSpec = createCustomSpecSection();
            modalBody.appendChild(customSpec);
            
            // Footer
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
            cancelBtn.onclick = cerrarModalEspecificaciones;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success';
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Especificaciones';
            saveBtn.onclick = function() { guardarEspecificaciones(activoId); };
            
            modalFooter.appendChild(cancelBtn);
            modalFooter.appendChild(saveBtn);
            
            // Ensamblar modal
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);
            modal.appendChild(modalContent);
            
            document.body.appendChild(modal);
            
            inicializarEventosEspecificaciones();
            cargarEspecificacionesExistentes(activoId);
        }

        function createQuickSpecsSection() {
            const container = document.createElement('div');
            container.className = 'quick-specs';
            container.style.marginBottom = '1.5rem';
            
            const title = document.createElement('h4');
            title.style.marginBottom = '0.75rem';
            title.style.color = 'var(--text-color)';
            title.innerHTML = '💡 Especificaciones Comunes';
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'quick-buttons';
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.flexWrap = 'wrap';
            buttonsContainer.style.gap = '0.5rem';
            buttonsContainer.style.alignItems = 'center';
            
            const specs = [
                { clave: 'PROCESADOR', icon: 'fas fa-microchip', text: 'PROCESADOR' },
                { clave: 'MEMORIA RAM', icon: 'fas fa-memory', text: 'MEMORIA RAM' },
                { clave: 'ALMACENAMIENTO', icon: 'fas fa-hdd', text: 'ALMACENAMIENTO' },
                { clave: 'SISTEMA OPERATIVO', icon: 'fab fa-windows', text: 'SISTEMA OPERATIVO' },
                { clave: 'COLOR', icon: 'fas fa-palette', text: 'COLOR' },
                { clave: 'CONECTIVIDAD', icon: 'fas fa-wifi', text: 'CONECTIVIDAD' },
                { clave: 'BOTELLA DE TINTA', icon: 'fas fa-fill-drip', text: 'BOTELLA DE TINTA' },
                { clave: 'TINTA', icon: 'fas fa-tint', text: 'TINTA' }
            ];
            
            specs.forEach(spec => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn-quick-spec';
                button.setAttribute('data-clave', spec.clave);
                button.setAttribute('data-valor', '');
                
                // Estilos del botón
                button.style.display = 'flex';
                button.style.alignItems = 'center';
                button.style.gap = '0.5rem';
                button.style.padding = '0.75rem 1rem';
                button.style.background = 'var(--light-color)';
                button.style.border = '1px solid var(--border-color)';
                button.style.borderRadius = 'var(--border-radius-sm)';
                button.style.cursor = 'pointer';
                button.style.transition = 'var(--transition)';
                button.style.fontSize = '0.9rem';
                button.style.color = 'var(--text-color)';
                button.style.fontFamily = 'inherit';
                
                // Efecto hover
                button.addEventListener('mouseenter', function() {
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.style.borderColor = 'var(--primary-color)';
                    this.style.transform = 'translateY(-1px)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.background = 'var(--light-color)';
                    this.style.color = 'var(--text-color)';
                    this.style.borderColor = 'var(--border-color)';
                    this.style.transform = 'translateY(0)';
                });
                
                const icon = document.createElement('i');
                icon.className = spec.icon;
                icon.style.fontSize = '1rem';
                icon.style.opacity = '0.8';
                
                const text = document.createTextNode(spec.text);
                
                button.appendChild(icon);
                button.appendChild(text);
                
                buttonsContainer.appendChild(button);
            });
            
            container.appendChild(title);
            container.appendChild(buttonsContainer);
            
            return container;
        }

        function createSpecsListSection() {
            const container = document.createElement('div');
            container.className = 'specs-list';
            
            const header = document.createElement('div');
            header.className = 'specs-header';
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '1rem';
            
            const title = document.createElement('h4');
            title.style.margin = '0';
            title.textContent = '📋 Especificaciones Agregadas';
            
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.id = 'specsCount';
            badge.textContent = '0 especificaciones';
            
            header.appendChild(title);
            header.appendChild(badge);
            
            const specsContainer = document.createElement('div');
            specsContainer.id = 'listaEspecificaciones';
            specsContainer.className = 'specs-container';
            
            const emptyState = document.createElement('div');
            emptyState.id = 'emptySpecsMessage';
            emptyState.className = 'empty-state';
            emptyState.style.textAlign = 'center';
            emptyState.style.padding = '2rem';
            
            const emptyIcon = document.createElement('i');
            emptyIcon.className = 'fas fa-clipboard-list';
            emptyIcon.style.fontSize = '3rem';
            emptyIcon.style.opacity = '0.3';
            emptyIcon.style.marginBottom = '1rem';
            
            const emptyText = document.createElement('p');
            emptyText.style.color = 'var(--text-muted)';
            emptyText.textContent = 'No hay especificaciones agregadas';
            
            const emptySubtext = document.createElement('small');
            emptySubtext.style.color = 'var(--text-muted)';
            emptySubtext.textContent = 'Usa los botones de arriba o agrega una personalizada';
            
            emptyState.appendChild(emptyIcon);
            emptyState.appendChild(emptyText);
            emptyState.appendChild(emptySubtext);
            
            container.appendChild(header);
            container.appendChild(specsContainer);
            container.appendChild(emptyState);
            
            return container;
        }

        function createCustomSpecSection() {
            const container = document.createElement('div');
            container.className = 'custom-spec';
            container.style.marginTop = '1.5rem';
            container.style.paddingTop = '1.5rem';
            container.style.borderTop = '1px solid var(--border-color)';
            
            const title = document.createElement('h5');
            title.style.marginBottom = '0.75rem';
            title.textContent = '✨ Agregar Personalizada';
            
            const formContainer = document.createElement('div');
            formContainer.style.display = 'flex';
            formContainer.style.gap = '0.5rem';
            
            const claveInput = document.createElement('input');
            claveInput.type = 'text';
            claveInput.className = 'form-control';
            claveInput.id = 'nuevaClave';
            claveInput.placeholder = '¿Qué especificación? Ej: Resolución, Peso, Garantía...';
            claveInput.style.flex = '1';
            
            const valorInput = document.createElement('input');
            valorInput.type = 'text';
            valorInput.className = 'form-control';
            valorInput.id = 'nuevoValor';
            valorInput.placeholder = 'Valor...';
            valorInput.style.flex = '1';
            
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'btn btn-primary';
            addButton.id = 'agregarCustomSpec';
            addButton.innerHTML = '<i class="fas fa-plus"></i> Agregar';
            
            formContainer.appendChild(claveInput);
            formContainer.appendChild(valorInput);
            formContainer.appendChild(addButton);
            
            container.appendChild(title);
            container.appendChild(formContainer);
            
            return container;
        }

        function inicializarEventosEspecificaciones() {
            // Botones de especificaciones rápidas
            document.querySelectorAll('.btn-quick-spec').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clave = this.getAttribute('data-clave');
                    const valor = this.getAttribute('data-valor');
                    agregarEspecificacion(clave, valor);
                });
            });

            // Agregar especificación personalizada
            document.getElementById('agregarCustomSpec').addEventListener('click', function() {
                const clave = document.getElementById('nuevaClave').value.trim();
                const valor = document.getElementById('nuevoValor').value.trim();
                
                if (clave && valor) {
                    agregarEspecificacion(clave, valor);
                    // Limpiar campos
                    document.getElementById('nuevaClave').value = '';
                    document.getElementById('nuevoValor').value = '';
                    document.getElementById('nuevaClave').focus();
                } else {
                    showToast('Completa ambos campos', 'warning');
                }
            });

            // Enter en los campos personalizados
            document.getElementById('nuevoValor').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('agregarCustomSpec').click();
                }
            });
        }

        function agregarEspecificacion(clave, valor = '') {
            const lista = document.getElementById('listaEspecificaciones');
            const emptyMessage = document.getElementById('emptySpecsMessage');
            
            // Ocultar mensaje de vacío
            emptyMessage.style.display = 'none';
            
            // Crear fila
            const id = Date.now();
            const filaHtml = `
                <div class="spec-row" data-id="${id}">
                    <div class="spec-clave">
                        <input type="text" 
                            class="form-control" 
                            value="${clave}" 
                            placeholder="Especificación..."
                            onchange="actualizarEspecificacion(${id})">
                    </div>
                    <div class="spec-valor">
                        <input type="text" 
                            class="form-control" 
                            value="${valor}" 
                            placeholder="Valor..."
                            onchange="actualizarEspecificacion(${id})"
                            onkeypress="if(event.key==='Enter') this.blur()">
                    </div>
                    <div class="spec-actions">
                        <button type="button" class="btn btn-danger btn-small" onclick="removerEspecificacion(${id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            lista.insertAdjacentHTML('beforeend', filaHtml);
            
            // Enfocar el campo de valor si está vacío
            if (!valor) {
                setTimeout(() => {
                    const fila = document.querySelector(`[data-id="${id}"]`);
                    const inputValor = fila.querySelector('.spec-valor input');
                    inputValor.focus();
                }, 100);
            }
            
            actualizarContador();
        }

        function removerEspecificacion(id) {
            const fila = document.querySelector(`[data-id="${id}"]`);
            if (fila) {
                fila.style.opacity = '0';
                fila.style.transform = 'translateX(-10px)';
                
                setTimeout(() => {
                    fila.remove();
                    actualizarContador();
                    mostrarMensajeVacioSiEsNecesario();
                }, 300);
            }
        }

        function actualizarEspecificacion(id) {
            const fila = document.querySelector(`[data-id="${id}"]`);
            const clave = fila.querySelector('.spec-clave input').value.trim();
            const valor = fila.querySelector('.spec-valor input').value.trim();
            
            if (!clave || !valor) {
                fila.classList.add('required');
            } else {
                fila.classList.remove('required');
            }
        }

        function actualizarContador() {
            const count = document.querySelectorAll('.spec-row').length;
            const counter = document.getElementById('specsCount');
            counter.textContent = `${count} especificación${count !== 1 ? 'es' : ''}`;
        }

        function mostrarMensajeVacioSiEsNecesario() {
            const lista = document.getElementById('listaEspecificaciones');
            const emptyMessage = document.getElementById('emptySpecsMessage');
            
            if (lista.children.length === 0) {
                emptyMessage.style.display = 'block';
            }
        }

        async function cargarEspecificacionesExistentes(activoId) {
            if (!activoId) return;
            
            try {
                const { data, error } = await supabase
                    .from('activo')
                    .select('especificaciones')
                    .eq('id', activoId)
                    .single();
                    
                if (error) throw error;
                
                if (data && data.especificaciones) {
                    Object.entries(data.especificaciones).forEach(([clave, valor]) => {
                        agregarEspecificacion(clave, valor);
                    });
                }
            } catch (error) {
                console.error('Error cargando especificaciones:', error);
            }
        }

        async function guardarEspecificaciones(activoId) {
            const especificaciones = {};
            let tieneErrores = false;
            
            document.querySelectorAll('.spec-row').forEach(fila => {
                const clave = fila.querySelector('.spec-clave input').value.trim();
                const valor = fila.querySelector('.spec-valor input').value.trim();
                
                if (clave && valor) {
                    especificaciones[clave] = valor;
                } else if (clave || valor) {
                    // Tiene uno de los campos pero no ambos
                    fila.classList.add('required');
                    tieneErrores = true;
                }
            });
            
            if (tieneErrores) {
                showToast('Completa todas las especificaciones', 'error');
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Guardando especificaciones...');
                
                const { error } = await supabase
                    .from('activo')
                    .update({ especificaciones })
                    .eq('id', activoId);
                    
                if (error) throw error;
                
                showLoadingOverlay(false);
                showToast('Especificaciones guardadas correctamente', 'success');
                cerrarModalEspecificaciones();
                
                // Recargar los activos para reflejar los cambios
                await loadAssets();
                
            } catch (error) {
                showLoadingOverlay(false);
                showToast('❌ Error guardando especificaciones', 'error');
                console.error('Error:', error);
            }
        }

        function cerrarModalEspecificaciones() {
            const modal = document.getElementById('especificacionesModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Función para escapar HTML y prevenir errores
        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }

        // Función para escapar strings en JavaScript
        function escapeJSString(str) {
            if (!str) return '';
            return String(str)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/`/g, '\\`')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t')
                .replace(/\f/g, '\\f')
                .replace(/\v/g, '\\v');
        }

        // ===== FUNCIÓN PARA AGREGAR BOTÓN DE PDF MASIVO =====
        function addMassPdfButtonToAssetsSection() {
            const assetsSection = document.getElementById('assetsSection');
            if (!assetsSection) {
                console.warn('❌ No se encontró la sección de activos');
                return;
            }
            
            const sectionTitle = assetsSection.querySelector('.section-title');
            if (!sectionTitle) {
                console.warn('❌ No se encontró el título de la sección de activos');
                return;
            }
            
            // Verificar si el botón ya existe
            if (sectionTitle.querySelector('#generateAllAssetsPdfBtn')) {
                console.log('ℹ️ El botón de PDF masivo ya existe');
                return;
            }
            
            // Crear botón de PDF masivo
            const massPdfButton = document.createElement('button');
            massPdfButton.className = 'btn btn-success';
            massPdfButton.id = 'generateAllAssetsPdfBtn';
            massPdfButton.innerHTML = '<i class="fas fa-tags"></i> Generar Etiquetas';
            massPdfButton.title = 'Generar etiquetas PDF para todos los activos';
            
            // Agregar evento click
            massPdfButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!AppState.assets || AppState.assets.length === 0) {
                    showToast('No hay activos para generar etiquetas', 'warning');
                    return;
                }
                
                console.log('🎯 Abriendo modal de PDF masivo para activos');
                showPdfFormatModalForAllAssets('assets-section');
            });
            
            // Insertar el botón después del botón "Nuevo Activo"
            const addAssetBtn = sectionTitle.querySelector('#addAssetBtn');
            if (addAssetBtn) {
                addAssetBtn.parentNode.insertBefore(massPdfButton, addAssetBtn.nextSibling);
            } else {
                // Si no existe el botón de nuevo activo, agregarlo al final
                sectionTitle.appendChild(massPdfButton);
            }
            
            console.log('✅ Botón de PDF masivo agregado correctamente');
        }

        // ===== FUNCIÓN CORREGIDA PARA AGREGAR BOTÓN DE EXPORTACIÓN =====
        function addExportButtonToAssetsSection() {
            console.log('🔄 Intentando agregar botón de exportación...');
            
            const assetsSection = document.getElementById('assetsSection');
            if (!assetsSection) {
                console.error('❌ No se encontró la sección de activos (assetsSection)');
                return;
            }
            
            const sectionTitle = assetsSection.querySelector('.section-title');
            if (!sectionTitle) {
                console.error('❌ No se encontró el título de la sección de activos');
                return;
            }
            
            // Verificar si el botón ya existe
            if (sectionTitle.querySelector('#exportAssetsBtn')) {
                console.log('ℹ️ El botón de exportación ya existe');
                return;
            }
            
            // Crear botón de exportación
            const exportButton = document.createElement('button');
            exportButton.type = 'button'; // Importante agregar type
            exportButton.className = 'btn btn-success';
            exportButton.id = 'exportAssetsBtn';
            exportButton.innerHTML = '<i class="fas fa-file-export"></i> Exportar Activos';
            exportButton.title = 'Exportar activos filtrados a PDF o Excel';
            
            // Agregar estilos específicos si es necesario
            exportButton.style.marginLeft = '0.5rem';
            
            // Agregar evento click
            exportButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🎯 Click en botón exportar');
                showExportModal();
            });
            
            // Estrategia de inserción más robusta
            const existingButtons = sectionTitle.querySelectorAll('button');
            const addAssetBtn = sectionTitle.querySelector('#addAssetBtn');
            const massPdfBtn = sectionTitle.querySelector('#generateAllAssetsPdfBtn');
            
            console.log('🔍 Botones encontrados:', existingButtons.length);
            
            // Intentar insertar después del botón de PDF masivo
            if (massPdfBtn) {
                console.log('✅ Insertando después del botón PDF masivo');
                massPdfBtn.parentNode.insertBefore(exportButton, massPdfBtn.nextSibling);
            } 
            // Si no existe PDF masivo, insertar después del botón "Nuevo Activo"
            else if (addAssetBtn) {
                console.log('✅ Insertando después del botón Nuevo Activo');
                addAssetBtn.parentNode.insertBefore(exportButton, addAssetBtn.nextSibling);
            }
            // Como último recurso, agregar al final
            else {
                console.log('✅ Agregando al final del contenedor');
                sectionTitle.appendChild(exportButton);
            }
            
            console.log('✅ Botón de exportación agregado correctamente');
        }

        // ===== FUNCIÓN ALTERNATIVA MÁS ROBUSTA =====
        function forceAddExportButton() {
            console.log('🔄 Forzando creación de botón de exportación...');
            
            // Intentar múltiples selectors para encontrar el contenedor
            const possibleSelectors = [
                '#assetsSection .section-title',
                '.section-title',
                '#assetsSection > .container > .section-title'
            ];
            
            let sectionTitle = null;
            
            for (const selector of possibleSelectors) {
                sectionTitle = document.querySelector(selector);
                if (sectionTitle) {
                    console.log(`✅ Encontrado con selector: ${selector}`);
                    break;
                }
            }
            
            if (!sectionTitle) {
                console.error('❌ No se pudo encontrar el contenedor del título');
                
                // Crear el contenedor si no existe
                const assetsSection = document.getElementById('assetsSection');
                if (assetsSection) {
                    const existingTitle = assetsSection.querySelector('h2');
                    if (existingTitle) {
                        sectionTitle = document.createElement('div');
                        sectionTitle.className = 'section-title';
                        sectionTitle.appendChild(existingTitle.cloneNode(true));
                        assetsSection.insertBefore(sectionTitle, assetsSection.querySelector('.assets-filters'));
                        console.log('✅ Creado contenedor section-title');
                    }
                }
                return;
            }
            
            // Eliminar botón existente si hay duplicados
            const existingExportBtn = sectionTitle.querySelector('#exportAssetsBtn');
            if (existingExportBtn) {
                existingExportBtn.remove();
                console.log('🔄 Eliminado botón de exportación duplicado');
            }
            
            // Crear botón de exportación
            const exportButton = document.createElement('button');
            exportButton.type = 'button';
            exportButton.className = 'btn btn-success';
            exportButton.id = 'exportAssetsBtn';
            exportButton.innerHTML = '<i class="fas fa-file-export"></i> Exportar Activos';
            exportButton.style.marginLeft = '0.5rem';
            exportButton.style.order = '3'; // Para controlar posición
            
            exportButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('🎯 Click en exportar activos');
                showExportModal();
            });
            
            // Estrategia de inserción inteligente
            const buttonOrder = {
                '#addAssetBtn': 1,
                '#generateAllAssetsPdfBtn': 2, 
                '#exportAssetsBtn': 3
            };
            
            // Encontrar el último botón existente
            const buttons = sectionTitle.querySelectorAll('button');
            if (buttons.length > 0) {
                const lastButton = buttons[buttons.length - 1];
                lastButton.parentNode.insertBefore(exportButton, lastButton.nextSibling);
                console.log('✅ Insertado después del último botón');
            } else {
                // Si no hay botones, agregar al final
                sectionTitle.appendChild(exportButton);
                console.log('✅ Agregado como primer botón');
            }
            
            console.log('✅ Botón de exportación forzado correctamente');
        }

        // ===== VERIFICACIÓN PERIÓDICA DEL BOTÓN =====
        function ensureExportButtonExists() {
            console.log('🔍 Iniciando verificación periódica del botón de exportación...');
            
            const checkButton = setInterval(() => {
                const exportBtn = document.getElementById('exportAssetsBtn');
                if (!exportBtn) {
                    console.log('🔍 Botón de exportación no encontrado, recreando...');
                    forceAddExportButton();
                } else {
                    console.log('✅ Botón de exportación verificado y presente');
                    clearInterval(checkButton);
                }
            }, 1000);
            
            // Detener después de 10 segundos
            setTimeout(() => {
                clearInterval(checkButton);
                console.log('⏹️ Verificación periódica finalizada');
            }, 10000);
        }

        // ===== SOLUCIÓN NUCLEAR - CREAR BOTÓN DESDE CERO =====
        function nuclearExportButtonSolution() {
            console.log('🚀 Aplicando solución nuclear para botón de exportación...');
            
            const assetsSection = document.getElementById('assetsSection');
            if (!assetsSection) {
                console.error('❌ assetsSection no encontrado');
                return;
            }
            
            // Buscar o crear el contenedor de botones
            let buttonContainer = assetsSection.querySelector('.section-title');
            
            if (!buttonContainer) {
                // Crear section-title si no existe
                buttonContainer = document.createElement('div');
                buttonContainer.className = 'section-title';
                
                // Mover el título existente al nuevo contenedor
                const existingTitle = assetsSection.querySelector('h2');
                const existingSmall = assetsSection.querySelector('small');
                
                if (existingTitle) {
                    buttonContainer.appendChild(existingTitle);
                } else {
                    const title = document.createElement('h2');
                    title.textContent = 'Gestión de Activos';
                    buttonContainer.appendChild(title);
                }
                
                if (existingSmall) {
                    buttonContainer.appendChild(existingSmall);
                }
                
                // Insertar antes de los filtros
                const filters = assetsSection.querySelector('.assets-filters');
                if (filters) {
                    assetsSection.insertBefore(buttonContainer, filters);
                } else {
                    assetsSection.prepend(buttonContainer);
                }
                
                console.log('✅ Creado contenedor section-title desde cero');
            }
            
            // Eliminar botón existente si hay duplicados
            const existingExportBtn = buttonContainer.querySelector('#exportAssetsBtn');
            if (existingExportBtn) {
                existingExportBtn.remove();
                console.log('🔄 Eliminado botón de exportación duplicado existente');
            }
            
            // Crear botón de exportación
            const exportButton = document.createElement('button');
            exportButton.type = 'button';
            exportButton.className = 'btn btn-success';
            exportButton.id = 'exportAssetsBtn';
            exportButton.innerHTML = '<i class="fas fa-file-export"></i> Exportar Activos';
            exportButton.style.marginLeft = '10px';
            exportButton.style.fontWeight = '600';
            
            exportButton.onclick = function(e) {
                e.preventDefault();
                console.log('🎯 Click en botón exportar (solución nuclear)');
                showExportModal();
            };
            
            // Agregar al contenedor
            buttonContainer.appendChild(exportButton);
            
            console.log('✅ Solución nuclear aplicada - botón debería ser visible');
            
            // Verificar que se creó correctamente
            setTimeout(() => {
                const verifyBtn = document.getElementById('exportAssetsBtn');
                if (verifyBtn) {
                    console.log('✅ Verificación exitosa - botón de exportación creado');
                } else {
                    console.error('❌ Error crítico - botón no se creó incluso con solución nuclear');
                }
            }, 500);
        }

        // ===== SISTEMA DE EXPORTACIÓN DE ACTIVOS =====

        function showExportModal() {
            // Cerrar modales existentes
            closeExportModal();
            
            // Obtener activos filtrados
            const filteredAssets = getFilteredAssets();
            const assetCount = filteredAssets.length;
            
            if (assetCount === 0) {
                showToast('No hay activos para exportar con los filtros actuales', 'warning');
                return;
            }
            
            // Crear modal de exportación
            const modalHtml = `
                <div class="export-modal active" id="exportModal">
                    <div class="export-modal-content">
                        <div class="export-modal-header">
                            <h3>Exportar Activos</h3>
                            <button class="close-modal" id="closeExportModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="export-modal-body">
                            <!-- Resumen -->
                            <div class="export-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Activos a exportar:</span>
                                    <span class="summary-value">${assetCount} activo${assetCount !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Formato seleccionado:</span>
                                    <span class="summary-value" id="selectedFormatText">PDF</span>
                                </div>
                                ${AppState.assetsFilters.search ? `
                                <div class="summary-item">
                                    <span class="summary-label">Búsqueda:</span>
                                    <span class="summary-value">"${AppState.assetsFilters.search}"</span>
                                </div>
                                ` : ''}
                                ${AppState.assetsFilters.status ? `
                                <div class="summary-item">
                                    <span class="summary-label">Estado:</span>
                                    <span class="summary-value">${getStatusFilterText()}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Opciones de formato -->
                            <div class="format-options">
                                <div class="format-option active" data-format="pdf">
                                    <div class="format-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Documento PDF</h4>
                                        <p>Formato profesional en horizontal, ideal para informes y presentaciones</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle active">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="format-option" data-format="excel">
                                    <div class="format-icon">
                                        <i class="fas fa-file-excel"></i>
                                    </div>
                                    <div class="format-content">
                                        <h4>Hoja de cálculo Excel</h4>
                                        <p>Formato tabular para análisis de datos y procesamiento</p>
                                    </div>
                                    <div class="format-check">
                                        <div class="check-circle">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información adicional -->
                            <div style="background: var(--light-color); padding: 1rem; border-radius: var(--border-radius);">
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--text-color);">
                                    <i class="fas fa-info-circle"></i> Información incluida
                                </h5>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                    Código, Tipo, Modelo, Marca, Número de Serie, Ubicación, Especificaciones, Usuario, Estado
                                </p>
                            </div>
                        </div>
                        
                        <div class="export-modal-footer">
                            <button class="btn btn-secondary" id="cancelExportBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-primary" id="confirmExportBtn">
                                <i class="fas fa-file-export"></i> Exportar 
                                <span class="export-badge">${assetCount}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            setupExportModalEvents();
        }

        function setupExportModalEvents() {
            let selectedFormat = 'pdf';
            
            // Seleccionar formato
            document.querySelectorAll('#exportModal .format-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedFormat = this.getAttribute('data-format');
                    
                    // Remover activo de todos
                    document.querySelectorAll('#exportModal .format-option').forEach(opt => {
                        opt.classList.remove('active');
                        opt.querySelector('.check-circle').classList.remove('active');
                    });
                    
                    // Activar seleccionado
                    this.classList.add('active');
                    this.querySelector('.check-circle').classList.add('active');
                    
                    // Actualizar texto
                    document.getElementById('selectedFormatText').textContent = 
                        selectedFormat === 'pdf' ? 'PDF' : 'Excel';
                });
            });
            
            // Cerrar modal
            const closeModal = () => closeExportModal();
            document.getElementById('closeExportModal').addEventListener('click', closeModal);
            document.getElementById('cancelExportBtn').addEventListener('click', closeModal);
            
            // Confirmar exportación
            document.getElementById('confirmExportBtn').addEventListener('click', function() {
                if (!selectedFormat) {
                    showToast('Selecciona un formato primero', 'warning');
                    return;
                }
                
                closeExportModal();
                setTimeout(() => {
                    exportAssets(selectedFormat);
                }, 300);
            });
            
            // Cerrar con ESC
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeExportModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.remove();
            }
        }

        function getFilteredAssets() {
            // Aplicar los mismos filtros que en la lista
            let filtered = AppState.assets;
            
            // Filtro de búsqueda
            if (AppState.assetsFilters.search) {
                const searchTerm = AppState.assetsFilters.search.toLowerCase();
                filtered = filtered.filter(asset => {
                    const searchable = [
                        asset.codigo,
                        asset.nombre,
                        asset.marca,
                        asset.modelo,
                        asset.numero_serie,
                        asset.tipo_activo,
                        asset.estado,
                        asset.ubicacion,
                        asset.usuario
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    return searchable.includes(searchTerm);
                });
            }
            
            // Filtro de estado
            if (AppState.assetsFilters.status) {
                filtered = filtered.filter(asset => 
                    Number(asset.estado_id) === Number(AppState.assetsFilters.status)
                );
            }
            
            // Filtro de categoría
            if (AppState.assetsFilters.category) {
                filtered = filtered.filter(asset => 
                    Number(asset.categoria_id) === Number(AppState.assetsFilters.category)
                );
            }
            
            // Filtro de tipo
            if (AppState.assetsFilters.type) {
                filtered = filtered.filter(asset => 
                    Number(asset.tipo_activo_id) === Number(AppState.assetsFilters.type)
                );
            }
            
            return filtered;
        }

        function getStatusFilterText() {
            const statusId = AppState.assetsFilters.status;
            if (!statusId) return '';
            
            const status = AppState.statuses.find(s => s.id == statusId);
            return status ? status.nombre : 'Estado desconocido';
        }

        // ===== EXPORTACIÓN A PDF =====
        async function exportToPDF(assets) {
            const { jsPDF } = window.jspdf;
            
            if (typeof jsPDF === 'undefined') {
                throw new Error('Librería PDF no disponible');
            }

            try {
                exportProgress.show(assets.length, 'pdf');
                exportProgress.updateStatus('Creando documento PDF...');

                // Crear PDF en orientación horizontal
                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "mm",
                    format: "a4"
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let currentY = margin;

                // Información de la exportación
                const now = new Date();
                const exportDate = now.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const exportTime = now.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // CABECERA CORPORATIVA
                pdf.setFillColor(203, 62, 44); // Color Gallos Mármol
                pdf.rect(0, 0, pageWidth, 25, 'F');
                
                // Logo/texto corporativo
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(20);
                pdf.setTextColor(255, 255, 255);
                pdf.text('GALLOS MÁRMOL', pageWidth / 2, 12, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text('SISTEMA DE GESTIÓN DE ACTIVOS TI', pageWidth / 2, 18, { align: 'center' });

                // Título del reporte
                currentY = 35;
                pdf.setFontSize(16);
                pdf.setTextColor(0, 0, 0);
                pdf.text('INVENTARIO DE ACTIVOS TI', pageWidth / 2, currentY, { align: 'center' });
                currentY += 10;

                // Información del reporte
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                
                const filtersInfo = [];
                if (AppState.assetsFilters.search) {
                    filtersInfo.push(`Búsqueda: "${AppState.assetsFilters.search}"`);
                }
                if (AppState.assetsFilters.status) {
                    filtersInfo.push(`Estado: ${getStatusFilterText()}`);
                }
                
                const filtersText = filtersInfo.length > 0 ? `Filtros aplicados: ${filtersInfo.join(', ')}` : 'Todos los activos';
                pdf.text(filtersText, margin, currentY);
                currentY += 5;
                
                pdf.text(`Generado: ${exportDate} ${exportTime} | Total de activos: ${assets.length}`, margin, currentY);
                currentY += 15;

                // Configurar tabla
                const tableHeaders = [
                    'Código', 
                    'Tipo', 
                    'Modelo', 
                    'Marca', 
                    'N° Serie', 
                    'Ubicación', 
                    'Usuario', 
                    'Estado'
                ];
                
                const columnWidths = [25, 30, 35, 25, 30, 25, 30, 20];
                const rowHeight = 10;
                
                // ENCABEZADO DE LA TABLA
                pdf.setFillColor(240, 240, 240);
                pdf.rect(margin, currentY, pageWidth - (margin * 2), rowHeight, 'F');
                
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(9);
                pdf.setTextColor(0, 0, 0);
                
                let headerX = margin;
                tableHeaders.forEach((header, index) => {
                    pdf.text(header, headerX + 2, currentY + 7);
                    headerX += columnWidths[index];
                });
                
                currentY += rowHeight + 2;

                // CONTENIDO DE LA TABLA
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                
                for (let i = 0; i < assets.length; i++) {
                    if (exportProgress.isCancelled) return;
                    
                    const asset = assets[i];
                    
                    // Verificar si necesita nueva página
                    if (currentY + rowHeight > pageHeight - margin) {
                        pdf.addPage();
                        currentY = margin;
                        
                        // Repetir encabezado en nueva página
                        pdf.setFillColor(240, 240, 240);
                        pdf.rect(margin, currentY, pageWidth - (margin * 2), rowHeight, 'F');
                        
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(9);
                        
                        let newHeaderX = margin;
                        tableHeaders.forEach((header, index) => {
                            pdf.text(header, newHeaderX + 2, currentY + 7);
                            newHeaderX += columnWidths[index];
                        });
                        
                        currentY += rowHeight + 2;
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(8);
                    }
                    
                    // Fondo alternado para filas
                    if (i % 2 === 0) {
                        pdf.setFillColor(250, 250, 250);
                        pdf.rect(margin, currentY, pageWidth - (margin * 2), rowHeight, 'F');
                    }
                    
                    // Contenido de la fila
                    let contentX = margin;
                    
                    // Código
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(asset.codigo.substring(0, 12), contentX + 2, currentY + 7);
                    contentX += columnWidths[0];
                    
                    // Tipo
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text(asset.tipo_activo.substring(0, 15), contentX + 2, currentY + 7);
                    contentX += columnWidths[1];
                    
                    // Modelo
                    pdf.text((asset.modelo || 'N/A').substring(0, 20), contentX + 2, currentY + 7);
                    contentX += columnWidths[2];
                    
                    // Marca
                    pdf.text((asset.marca || 'N/A').substring(0, 12), contentX + 2, currentY + 7);
                    contentX += columnWidths[3];
                    
                    // Número de serie
                    pdf.text((asset.numero_serie || 'N/A').substring(0, 15), contentX + 2, currentY + 7);
                    contentX += columnWidths[4];
                    
                    // Ubicación
                    pdf.text(asset.ubicacion.substring(0, 12), contentX + 2, currentY + 7);
                    contentX += columnWidths[5];
                    
                    // Usuario
                    pdf.text(asset.usuario.substring(0, 15), contentX + 2, currentY + 7);
                    contentX += columnWidths[6];
                    
                    // Estado con color
                    const statusColor = getStatusColor(asset.estado);
                    pdf.setTextColor(statusColor.r, statusColor.g, statusColor.b);
                    pdf.text(asset.estado.substring(0, 10), contentX + 2, currentY + 7);
                    
                    currentY += rowHeight;
                    
                    // Actualizar progreso
                    const progress = ((i + 1) / assets.length) * 100;
                    exportProgress.updateProgress(progress, i + 1, assets.length);
                    exportProgress.updateStatus(`Procesando activo: ${asset.codigo}`);
                    
                    // Pequeña pausa para que se vea el progreso
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // PIE DE PÁGINA
                const footerY = pageHeight - 10;
                pdf.setFontSize(8);
                pdf.setTextColor(150, 150, 150);
                pdf.text(`Sistema de Gestión de Activos TI - Gallos Mármol - Página 1 de 1`, pageWidth / 2, footerY, { align: 'center' });

                exportProgress.updateStatus('Finalizando documento PDF...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // GUARDAR PDF
                const fileName = `inventario_activos_${now.getTime()}.pdf`;
                pdf.save(fileName);
                
                exportProgress.showSuccess();
                
                setTimeout(() => {
                    exportProgress.hide();
                    showToast(`✅ Inventario exportado a PDF: ${assets.length} activos`, 'success');
                }, 1500);

            } catch (error) {
                exportProgress.showError(error);
                setTimeout(() => {
                    exportProgress.hide();
                }, 3000);
                throw error;
            }
        }

        // ===== EXPORTACIÓN A EXCEL =====
        async function exportToExcel(assets) {
            try {
                exportProgress.show(assets.length, 'excel');
                exportProgress.updateStatus('Preparando datos para Excel...');

                // Crear contenido CSV
                const headers = [
                    'Código',
                    'Nombre', 
                    'Tipo',
                    'Modelo',
                    'Marca',
                    'Número de Serie',
                    'Ubicación',
                    'Usuario Asignado',
                    'Estado',
                    'Especificaciones',
                    'Fecha Registro',
                    'Observaciones'
                ];

                let csvContent = headers.join(',') + '\n';

                for (let i = 0; i < assets.length; i++) {
                    if (exportProgress.isCancelled) return;
                    
                    const asset = assets[i];
                    
                    // Obtener especificaciones si existen
                    let especificaciones = '';
                    try {
                        const { data } = await supabase
                            .from('activo')
                            .select('especificaciones')
                            .eq('id', asset.id)
                            .single();
                            
                        if (data && data.especificaciones) {
                            especificaciones = JSON.stringify(data.especificaciones)
                                .replace(/"/g, '""')
                                .replace(/,/g, ';');
                        }
                    } catch (error) {
                        console.warn('Error obteniendo especificaciones:', error);
                    }

                    const row = [
                        `"${asset.codigo}"`,
                        `"${(asset.nombre || '').replace(/"/g, '""')}"`,
                        `"${(asset.tipo_activo || '').replace(/"/g, '""')}"`,
                        `"${(asset.modelo || '').replace(/"/g, '""')}"`,
                        `"${(asset.marca || '').replace(/"/g, '""')}"`,
                        `"${(asset.numero_serie || '').replace(/"/g, '""')}"`,
                        `"${(asset.ubicacion || '').replace(/"/g, '""')}"`,
                        `"${(asset.usuario || '').replace(/"/g, '""')}"`,
                        `"${(asset.estado || '').replace(/"/g, '""')}"`,
                        `"${especificaciones}"`,
                        `"${new Date(asset.fecha_registro).toLocaleDateString('es-ES')}"`,
                        `"${(asset.observaciones || '').replace(/"/g, '""')}"`
                    ];

                    csvContent += row.join(',') + '\n';
                    
                    // Actualizar progreso
                    const progress = ((i + 1) / assets.length) * 100;
                    exportProgress.updateProgress(progress, i + 1, assets.length);
                    exportProgress.updateStatus(`Procesando activo: ${asset.codigo}`);
                    
                    await new Promise(resolve => setTimeout(resolve, 30));
                }

                exportProgress.updateStatus('Generando archivo Excel...');

                // Crear y descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const fileName = `inventario_activos_${now.getTime()}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                exportProgress.showSuccess();
                
                setTimeout(() => {
                    exportProgress.hide();
                    showToast(`✅ Inventario exportado a Excel: ${assets.length} activos`, 'success');
                }, 1500);

            } catch (error) {
                exportProgress.showError(error);
                setTimeout(() => {
                    exportProgress.hide();
                }, 3000);
                throw error;
            }
        }

        // ===== FUNCIÓN PRINCIPAL DE EXPORTACIÓN =====
        async function exportAssets(format) {
            try {
                const filteredAssets = getFilteredAssets();
                
                if (filteredAssets.length === 0) {
                    showToast('No hay activos para exportar con los filtros actuales', 'warning');
                    return;
                }
                
                console.log(`🔄 Exportando ${filteredAssets.length} activos a ${format}`);
                
                switch (format) {
                    case 'pdf':
                        await exportToPDF(filteredAssets);
                        break;
                    case 'excel':
                        await exportToExcel(filteredAssets);
                        break;
                    default:
                        throw new Error(`Formato no soportado: ${format}`);
                }
                
            } catch (error) {
                console.error('Error en exportación:', error);
                showToast('Error al exportar los activos: ' + error.message, 'error');
            }
        }

        // ===== FUNCIÓN ACTUALIZADA PARA CONFIGURAR BOTONES DE ACTIVOS =====
        function setupAssetButtonsListeners() {
            // Botones de ver detalles
            document.querySelectorAll('.view-asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    showAssetDetails(assetId);
                });
            });
            
            // Botones de editar activo
            document.querySelectorAll('.edit-asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    openAssetModal(assetId);
                });
            });
            
            // Botones de gestión de IPs
            document.querySelectorAll('.manage-ip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    console.log('🔗 Click en IP - Asset ID:', assetId);
                    
                    if (assetId) {
                        // Verificar que el activo existe
                        const asset = AppState.assets.find(a => a.id === assetId);
                        if (asset) {
                            console.log('✅ Activo encontrado:', asset.nombre);
                            openIPManagementModal(assetId);
                        } else {
                            console.error('❌ Activo no encontrado con ID:', assetId);
                            showToast('Error: Activo no encontrado', 'error');
                        }
                    } else {
                        console.error('❌ Asset ID no válido');
                    }
                });
            }); 
            
            // ✅ BOTONES DE GENERAR PDF ACTUALIZADOS
            document.querySelectorAll('.generate-pdf-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    console.log('🎯 Generando PDF individual para activo:', assetId);
                    generateSingleAssetPdf(assetId);
                });
            });

            // Botones de especificaciones
            document.querySelectorAll('.especificaciones-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const assetId = this.getAttribute('data-asset-id');
                    const assetName = this.getAttribute('data-asset-name');
                    abrirModalEspecificaciones(assetId, assetName);
                });
            });            
        }

        // ===== FUNCIÓN PARA RENDERIZAR LISTA DE ACTIVOS (ACTUALIZADA) =====
        function renderAssetsList() {
            const container = document.getElementById('assetsListContainer');
            if (!container) return;
            
            // Calcular elementos para la página actual
            const startIndex = (AppState.assetsPagination.currentPage - 1) * AppState.assetsPagination.itemsPerPage;
            const endIndex = startIndex + AppState.assetsPagination.itemsPerPage;
            const currentAssets = AppState.assets.slice(startIndex, endIndex);
            
            let html = '';
            
            if (currentAssets.length === 0) {
                html = `
                    <div class="empty-state">
                        <i class="fas fa-laptop"></i>
                        <h3>No se encontraron activos</h3>
                        <p>${AppState.assetsFilters.search || AppState.assetsFilters.status || AppState.assetsFilters.category || AppState.assetsFilters.type ? 
                            'Intenta ajustar los filtros o la búsqueda' : 
                            'No hay activos en el sistema'}</p>
                        ${!AppState.assetsFilters.search && !AppState.assetsFilters.status && !AppState.assetsFilters.category && !AppState.assetsFilters.type ? 
                            `<button class="btn btn-primary" id="addFirstAssetBtn" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Agregar Primer Activo
                            </button>` : ''
                        }
                    </div>
                `;
            } else {
                currentAssets.forEach(asset => {
                    // Obtener IPs principales del activo
                    const mainIPs = getAssetMainIPs(asset.id);
                    const statusClass = `status-${asset.estado?.toLowerCase().replace(' ', '-') || 'sin-estado'}`;
                    const statusText = asset.estado || 'Sin estado';
                    const createdDate = new Date(asset.fecha_registro).toLocaleDateString();
                    const activeBadge = asset.activo ? 
                        '<span class="asset-status status-operativo" style="background-color: var(--success-color);">Activo</span>' : 
                        '<span class="asset-status status-dado-de-baja" style="background-color: var(--danger-color);">Inactivo</span>';
                    
                    html += `
                        <div class="asset-card" data-asset-id="${asset.id}">
                            <div class="asset-header">
                                <div class="asset-info">
                                    <h3>${asset.nombre} ${!asset.activo ? '<small style="color: var(--danger-color);">(INACTIVO)</small>' : ''}</h3>
                                    <div class="asset-meta">
                                        <span class="asset-code">${asset.codigo}</span>
                                        ${activeBadge}
                                        <span class="asset-status ${statusClass}">${statusText}</span>
                                        <span><i class="fas fa-tag"></i> ${asset.tipo_activo}</span>
                                        <span><i class="fas fa-map-marker-alt"></i> ${formatUbicacionCompleta(asset.ubicacion_id)}</span>
                                        ${mainIPs ? `<span><i class="fas fa-network-wired"></i> ${mainIPs}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="asset-description">
                                <strong>Marca:</strong> ${asset.marca || 'No especificada'} | 
                                <strong>Modelo:</strong> ${asset.modelo || 'No especificado'} |
                                <strong>Serie:</strong> ${asset.numero_serie || 'No especificado'}
                                ${asset.usuario && asset.usuario !== 'Sin asignar' ? 
                                    `| <strong>Asignado a:</strong> ${asset.usuario}` : ''
                                }
                            </div>
                            
                            <div class="asset-footer">
                                <div class="asset-actions">
                                    <!-- Botones existentes -->
                                    <button class="btn btn-secondary btn-small view-asset-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-accent btn-small edit-asset-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-info btn-small manage-ip-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-network-wired"></i> IP
                                    </button>
                                    <!-- BOTÓN PDF ACTUALIZADO -->
                                    <button class="btn btn-success btn-small generate-pdf-btn" data-asset-id="${asset.id}" 
                                        title="Generar etiqueta PDF para este activo">
                                        <i class="fas fa-tag"></i> Etiqueta
                                    </button>
                                    <!-- NUEVO BOTÓN DE ESPECIFICACIONES -->
                                    <button class="btn btn-warning btn-small especificaciones-btn" 
                                            data-asset-id="${asset.id}" 
                                            data-asset-name="${asset.nombre}"
                                            title="Gestionar especificaciones técnicas">
                                        <i class="fas fa-cogs"></i> Especificaciones
                                    </button>                                    
                                </div>
                                
                                ${asset.observaciones ? `
                                <div class="asset-observations">
                                    <small><strong>Observaciones:</strong> ${asset.observaciones}</small>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Configurar event listeners
            setupAssetButtonsListeners();
            
            // Configurar botón de "Agregar Primer Activo" si existe
            const addFirstAssetBtn = document.getElementById('addFirstAssetBtn');
            if (addFirstAssetBtn) {
                addFirstAssetBtn.addEventListener('click', function() {
                    openAssetModal();
                });
            }
            
            // Actualizar paginación
            updateAssetsPaginationUI();
        }

        // ===== FUNCIÓN AUXILIAR PARA OBTENER IPs PRINCIPALES =====
        function getAssetMainIPs(assetId) {
            // Esta función asume que tienes las IPs cargadas en algún estado
            // Puedes precargarlas o hacer una consulta específica
            const assetIPs = AppState.assetIPs?.[assetId] || [];
            if (assetIPs.length === 0) return null;
            
            // Mostrar solo las IPs activas, máximo 2
            const activeIPs = assetIPs.filter(ip => ip.activo).slice(0, 2);
            return activeIPs.map(ip => ip.direccion_ip).join(', ');
        }

        // ===== FUNCIÓN PARA ACTUALIZAR UI DE PAGINACIÓN =====
        function updateAssetsPaginationUI() {
            const prevBtn = document.getElementById('assetsPrevPageBtn');
            const nextBtn = document.getElementById('assetsNextPageBtn');
            const info = document.getElementById('assetsPaginationInfo');
            
            if (!prevBtn || !nextBtn || !info) return;
            
            const totalItems = AppState.assetsPagination.totalItems;
            const currentPage = AppState.assetsPagination.currentPage;
            const totalPages = AppState.assetsPagination.totalPages;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            info.textContent = `Página ${currentPage} de ${totalPages} (${totalItems} activos)`;
        }

        // ===== FUNCIÓN PARA MANEJAR CAMBIO DE PÁGINA =====
        function goToAssetsPage(page) {
            console.log('🔄 Intentando ir a página:', page);
            
            if (page < 1 || page > AppState.assetsPagination.totalPages) {
                console.warn('❌ Página fuera de rango:', page);
                return;
            }
            
            AppState.assetsPagination.currentPage = page;
            console.log('✅ Cambiando a página:', page);
            
            // Renderizar la lista de activos para la nueva página
            renderAssetsList();
            
            // Actualizar la UI de paginación
            updateAssetsPaginationUI();
        }

        // ===== FUNCIÓN PARA APLICAR FILTROS =====
        function applyAssetsFilters() {
            console.log('🔍 Aplicando filtros:', AppState.assetsFilters);
            
            let filtered = AppState.assets.filter(asset => {
                let passesFilter = true;

                // Filtro de búsqueda
                if (AppState.assetsFilters.search) {
                    const searchTerm = AppState.assetsFilters.search.toLowerCase();
                    const searchable = [
                        asset.codigo,
                        asset.nombre,
                        asset.marca,
                        asset.modelo,
                        asset.numero_serie,
                        asset.tipo_activo,
                        asset.estado,
                        asset.ubicacion,
                        asset.usuario
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchable.includes(searchTerm)) {
                        passesFilter = false;
                    }
                }

                // FILTRO DE ESTADO - CORREGIDO
                if (passesFilter && AppState.assetsFilters.status) {
                    const filterStatusId = AppState.assetsFilters.status;
                    
                    console.log('🎯 Comparando estado - Filtro ID:', filterStatusId, 'Tipo:', typeof filterStatusId);
                    console.log('🎯 Activo estado_id:', asset.estado_id, 'Tipo:', typeof asset.estado_id);
                    
                    // Convertir ambos a número para comparación
                    const filterIdNum = Number(filterStatusId);
                    const assetIdNum = Number(asset.estado_id);
                    
                    console.log('🎯 Después de conversión - Filtro:', filterIdNum, 'Activo:', assetIdNum);
                    
                    if (assetIdNum !== filterIdNum) {
                        console.log('❌ No coincide - filtrando fuera');
                        passesFilter = false;
                    } else {
                        console.log('✅ Coincide - manteniendo');
                    }
                }

                // Filtro de categoría
                if (passesFilter && AppState.assetsFilters.category) {
                    const filterCategoryId = AppState.assetsFilters.category;
                    const assetCategoryId = asset.categoria_id;
                    
                    // Convertir a número para comparación
                    if (Number(assetCategoryId) !== Number(filterCategoryId)) {
                        passesFilter = false;
                    }
                }

                // Filtro de tipo
                if (passesFilter && AppState.assetsFilters.type) {
                    const filterTypeId = AppState.assetsFilters.type;
                    const assetTypeId = asset.tipo_activo_id;
                    
                    // Convertir a número para comparación
                    if (Number(assetTypeId) !== Number(filterTypeId)) {
                        passesFilter = false;
                    }
                }

                console.log('🔚 Resultado filtro para', asset.codigo + ':', passesFilter);
                return passesFilter;
            });
            
            console.log(`📊 Filtros aplicados: ${filtered.length} de ${AppState.assets.length} activos`);

            // Actualizar paginación
            updateAssetsPagination(filtered);
            
            // Renderizar lista filtrada
            renderFilteredAssetsList(filtered);
        }

        // ===== FUNCIÓN PARA ACTUALIZAR PAGINACIÓN =====
        function updateAssetsPagination(filteredAssets) {
            const totalItems = filteredAssets.length;
            const totalPages = Math.ceil(totalItems / AppState.assetsPagination.itemsPerPage);
            
            // Resetear a página 1 cuando se aplican filtros
            AppState.assetsPagination.currentPage = 1;
            AppState.assetsPagination.totalItems = totalItems;
            AppState.assetsPagination.totalPages = totalPages;
            
            updateAssetsPaginationUI();
        }

        // ===== FUNCIÓN PARA RENDERIZAR ACTIVOS FILTRADOS =====
        function renderFilteredAssetsList(filteredAssets) {
            const container = document.getElementById('assetsListContainer');
            if (!container) return;
            
            // Calcular elementos para la página actual
            const startIndex = (AppState.assetsPagination.currentPage - 1) * AppState.assetsPagination.itemsPerPage;
            const endIndex = startIndex + AppState.assetsPagination.itemsPerPage;
            const currentAssets = filteredAssets.slice(startIndex, endIndex);
            
            let html = '';
            
            if (currentAssets.length === 0) {
                const hasFilters = AppState.assetsFilters.search || 
                                AppState.assetsFilters.status || 
                                AppState.assetsFilters.category || 
                                AppState.assetsFilters.type;
                
                html = `
                    <div class="empty-state">
                        <i class="fas fa-laptop"></i>
                        <h3>No se encontraron activos</h3>
                        <p>${hasFilters ? 
                            'No hay activos que coincidan con los filtros aplicados' : 
                            'No hay activos en el sistema'}</p>
                        ${!hasFilters ? 
                            `<button class="btn btn-primary" id="addFirstAssetBtn" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Agregar Primer Activo
                            </button>` : ''
                        }
                    </div>
                `;
            } else {
                currentAssets.forEach(asset => {
                    // Obtener IPs principales del activo
                    const mainIPs = getAssetMainIPs(asset.id);
                    const statusClass = `status-${asset.estado?.toLowerCase().replace(' ', '-') || 'sin-estado'}`;
                    const statusText = asset.estado || 'Sin estado';
                    const createdDate = new Date(asset.fecha_registro).toLocaleDateString();
                    const activeBadge = asset.activo ? 
                        '<span class="asset-status status-operativo" style="background-color: var(--success-color);">ACTIVO</span>' : 
                        '<span class="asset-status status-dado-de-baja" style="background-color: var(--danger-color);">INACTIVO</span>';
                    
                    html += `
                        <div class="asset-card" data-asset-id="${asset.id}">
                            <div class="asset-header">
                                <div class="asset-info">
                                    <h3>${asset.nombre} ${!asset.activo ? '<small style="color: var(--danger-color);">(INACTIVO)</small>' : ''}</h3>
                                    <div class="asset-meta">
                                        <span class="asset-code">${asset.codigo}</span>
                                        ${activeBadge}
                                        <span class="asset-status ${statusClass}">${statusText}</span>
                                        <span><i class="fas fa-tag"></i> ${asset.tipo_activo}</span>
                                        <span><i class="fas fa-map-marker-alt"></i> ${formatUbicacionCompleta(asset.ubicacion_id)}</span>                                        
                                        ${mainIPs ? `<span><i class="fas fa-network-wired"></i> ${mainIPs}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="asset-description">
                                <strong>Marca:</strong> ${asset.marca || 'No especificada'} | 
                                <strong>Modelo:</strong> ${asset.modelo || 'No especificado'} |
                                <strong>Serie:</strong> ${asset.numero_serie || 'No especificado'}
                                ${asset.usuario && asset.usuario !== 'Sin asignar' ? 
                                    `| <strong>Asignado a:</strong> ${asset.usuario}` : ''
                                }
                            </div>
                            
                            <div class="asset-footer">
                                <div class="asset-actions">
                                    <button class="btn btn-secondary btn-small view-asset-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-accent btn-small edit-asset-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-info btn-small manage-ip-btn" data-asset-id="${asset.id}">
                                        <i class="fas fa-network-wired"></i> IP
                                    </button>
                                    <button class="btn btn-success btn-small generate-pdf-btn" data-asset-id="${asset.id}" 
                                        title="Generar etiqueta PDF para este activo">
                                        <i class="fas fa-tag"></i> Etiqueta
                                    </button>
                                    <button class="btn btn-warning btn-small especificaciones-btn" 
                                            data-asset-id="${asset.id}" 
                                            data-asset-name="${asset.nombre}"
                                            title="Gestionar especificaciones técnicas">
                                        <i class="fas fa-cogs"></i> Especificaciones
                                    </button>                                    
                                </div>
                                
                                ${asset.observaciones ? `
                                <div class="asset-observations">
                                    <small><strong>Observaciones:</strong> ${asset.observaciones}</small>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Configurar event listeners
            setupAssetButtonsListeners();
            
            // Configurar botón de "Agregar Primer Activo" si existe
            const addFirstAssetBtn = document.getElementById('addFirstAssetBtn');
            if (addFirstAssetBtn) {
                addFirstAssetBtn.addEventListener('click', function() {
                    openAssetModal();
                });
            }
        }

        // ===== INICIALIZAR FILTROS AL CARGAR =====
        function setupFiltersEventListeners() {
            // Filtros para activos
            const assetsSearchInput = document.getElementById('assetsSearchInput');
            if (assetsSearchInput) {
                assetsSearchInput.addEventListener('input', debounce(function(e) {
                    AppState.assetsFilters.search = e.target.value;
                    applyAssetsFilters();
                }, 300));
            }
            
            const assetsStatusFilter = document.getElementById('assetsStatusFilter');
            if (assetsStatusFilter) {
                assetsStatusFilter.addEventListener('change', function(e) {
                    AppState.assetsFilters.status = e.target.value;
                    applyAssetsFilters();
                });
            }
            
            const assetsCategoryFilter = document.getElementById('assetsCategoryFilter');
            if (assetsCategoryFilter) {
                assetsCategoryFilter.addEventListener('change', function(e) {
                    const categoryId = this.value;
                    const typeFilter = document.getElementById('assetsTypeFilter');
                    
                    console.log('🔄 Cambio en filtro de categoría:', categoryId);
                    
                    if (categoryId) {
                        // Convertir a número para comparación
                        const categoryIdNum = parseInt(categoryId);
                        
                        // Filtrar tipos por categoría seleccionada
                        const filteredTypes = AppState.types.filter(type => {
                            return parseInt(type.categoria_activo_id) === categoryIdNum;
                        });
                        
                        console.log(`📊 Tipos filtrados para categoría ${categoryIdNum}:`, filteredTypes);
                        
                        typeFilter.innerHTML = '<option value="">Todos los tipos</option>' +
                            filteredTypes.map(type => 
                                `<option value="${type.id}">${type.nombre}</option>`
                            ).join('');
                        typeFilter.disabled = false;
                    } else {
                        // Mostrar todos los tipos si no hay categoría seleccionada
                        typeFilter.innerHTML = '<option value="">Todos los tipos</option>' +
                            AppState.types.map(type => 
                                `<option value="${type.id}">${type.nombre}</option>`
                            ).join('');
                    }
                    
                    // Aplicar filtros
                    AppState.assetsFilters.category = categoryId;
                    applyAssetsFilters();
                });
            }
            
            const assetsTypeFilter = document.getElementById('assetsTypeFilter');
            if (assetsTypeFilter) {
                assetsTypeFilter.addEventListener('change', function(e) {
                    AppState.assetsFilters.type = e.target.value;
                    applyAssetsFilters();
                });
            }
        }        

        // OBTENER COLOR SEGÚN ESTADO
        function getStatusColor(status) {
            const statusColors = {
                'operativo': { r: 39, g: 174, b: 96 },     // Verde
                'en reparación': { r: 243, g: 156, b: 18 }, // Naranja
                'en almacén': { r: 52, g: 152, b: 219 },    // Azul
                'dado de baja': { r: 231, g: 76, b: 60 }    // Rojo
            };
            
            return statusColors[status] || { r: 0, g: 0, b: 0 }; // Negro por defecto
        }

        // Función para editar IP existente
        async function editIP(ipId) {
            try {
                const { data: ip, error } = await supabase
                    .from('direccion_ip')
                    .select('*')
                    .eq('id', ipId)
                    .single();
                    
                if (error) throw error;
                
                AppState.currentEditingIP = ip;
                
                // Llenar formulario con datos existentes
                document.getElementById('ipAddress').value = ip.direccion_ip;
                document.getElementById('ipMAC').value = ip.direccion_mac || '';
                document.getElementById('ipSubnet').value = ip.mascara_subred || '255.255.255.0';
                document.getElementById('ipGateway').value = ip.gateway || '';
                document.getElementById('ipDNS1').value = ip.dns_primario || '';
                document.getElementById('ipDNS2').value = ip.dns_secundario || '';
                document.getElementById('ipType').value = ip.tipo_conexion || 'ETHERNET';
                document.getElementById('ipActive').checked = ip.activo;
                document.getElementById('ipObservations').value = ip.observaciones || '';
                
                // Bloquear la dirección IP en modo edición
                document.getElementById('ipAddress').readOnly = true;
                document.getElementById('ipAddress').style.backgroundColor = 'var(--light-color)';
                
                // ✅ OPCIONAL: Hacer scroll al formulario para que sea visible
                document.getElementById('ipForm').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error cargando IP para edición:', error);
                showToast('Error al cargar la dirección IP para edición', 'error');
            }
        }

        // ===== FUNCIONALIDADES PRINCIPALES =====
        function switchTab(tabId) {
            const validTabs = ['assets', 'categories', 'types', 'locations', 'maintenance', 'brands'];
            
            if (!validTabs.includes(tabId)) {
                console.warn('Pestaña no válida:', tabId);
                showToast(`Pestaña "${tabId}" no está disponible`, 'error');
                return;
            }
            
            AppState.currentTab = tabId;
            
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar sección activa
            const activeSection = document.getElementById(tabId + 'Section');
            if (activeSection) {
                activeSection.classList.add('active');
            }
            
            // Actualizar pestañas activas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.getAttribute('data-tab') === tabId;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
            });
            
            console.log(`✅ Cambiando a pestaña: ${tabId}`);
        }

                // ===== GESTIÓN DE ACTIVOS =====
        function openAssetModal(assetId = null) {
            const modal = document.getElementById('assetModal');
            const title = document.getElementById('assetModalTitle');
            const codeInput = document.getElementById('assetCode');
            const nameInput = document.getElementById('assetName');
            const modalFooter = document.querySelector('#assetModal .modal-footer');
            
            if (assetId) {
                // Modo edición
                const asset = AppState.assets.find(a => a.id === assetId);
                if (asset) {
                    AppState.currentEditingAsset = asset;
                    title.textContent = 'Editar Activo';
                    
                    // CÓDIGO BLOQUEADO EN EDICIÓN
                    codeInput.value = asset.codigo;
                    codeInput.readOnly = true;
                    codeInput.style.backgroundColor = 'var(--light-color)';
                    codeInput.style.cursor = 'not-allowed';
                    
                    // NOMBRE BLOQUEADO POR DEFECTO
                    nameInput.readOnly = true;
                    nameInput.style.backgroundColor = 'var(--light-color)';
                    nameInput.style.cursor = 'not-allowed';
                    
                    // Asegurar que el icono de candado esté visible
                    const lockIcon = nameInput.parentNode.querySelector('i.fas');
                    if (lockIcon) {
                        lockIcon.className = 'fas fa-lock';
                        lockIcon.style.color = 'var(--text-muted)';
                    }
                    
                    // Llenar formulario con datos existentes
                    document.getElementById('assetName').value = asset.nombre;
                    document.getElementById('assetCategory').value = asset.categoria_id;
                    document.getElementById('assetBrand').value = asset.marca_id || '';
                    document.getElementById('assetModel').value = asset.modelo || '';
                    document.getElementById('assetSerial').value = asset.numero_serie || '';
                    document.getElementById('assetStatus').value = asset.estado_id || '';
                    document.getElementById('assetActive').value = asset.activo !== false ? 'true' : 'false';
                    document.getElementById('assetLocation').value = asset.ubicacion_id || '';
                    document.getElementById('assetUser').value = asset.usuario_id || '';
                    document.getElementById('assetParent').value = asset.id_activo_padre || '';
                    document.getElementById('assetObservations').value = asset.observaciones || '';
                    
                    // Mostrar descripción del estado si existe
                    if (asset.estado_id) {
                        const estado = AppState.statuses.find(s => s.id == asset.estado_id);
                        if (estado) {
                            setTimeout(() => {
                                showEstadoDescription(asset.estado_id, estado.descripcion);
                            }, 100);
                        }
                    }
                    
                    // Actualizar tipos según categoría seleccionada
                    updateTypeOptionsByCategory(asset.categoria_id, 'assetType');
                    
                    // Establecer el tipo después de que se carguen las opciones
                    setTimeout(() => {
                        document.getElementById('assetType').value = asset.tipo_activo_id;
                        
                        // En modo edición, mostrar mensaje diferente para nombres
                        updateNameHelp('🔒 Modo automático activado. Haz clic en "Editar Manual" para modificar el nombre.');
                    }, 100);
                   
                }
            } else {
                // Modo creación
                AppState.currentEditingAsset = null;
                title.textContent = 'Nuevo Activo';
                
                // Limpiar formulario
                document.getElementById('assetForm').reset();
                
                // ✅ Asegurar que se remueve el botón de especificaciones si existe
                const existingSpecsBtn = modalFooter.querySelector('.specs-button');
                if (existingSpecsBtn) {
                    existingSpecsBtn.remove();
                }

                // CÓDIGO BLOQUEADO EN CREACIÓN (con código generado automáticamente)
                codeInput.value = generateAssetCode();
                codeInput.readOnly = true;
                codeInput.style.backgroundColor = 'var(--light-color)';
                codeInput.style.cursor = 'not-allowed';
                
                // NOMBRE BLOQUEADO POR DEFECTO
                nameInput.readOnly = true;
                nameInput.style.backgroundColor = 'var(--light-color)';
                nameInput.style.cursor = 'not-allowed';
                
                // Asegurar que el icono de candado esté visible
                const lockIcon = nameInput.parentNode.querySelector('i.fas');
                if (lockIcon) {
                    lockIcon.className = 'fas fa-lock';
                    lockIcon.style.color = 'var(--text-muted)';
                }
                
                // Ocultar descripción del estado en modo creación
                const descContainer = document.getElementById('estadoDescription');
                if (descContainer) {
                    descContainer.style.display = 'none';
                }
                
                // Establecer valores por defecto
                document.getElementById('assetActive').checked = true;
                
                // Limpiar y deshabilitar el campo tipo
                const typeSelect = document.getElementById('assetType');
                typeSelect.innerHTML = '<option value="">Primero selecciona una categoría</option>';
                typeSelect.disabled = true;
                typeSelect.classList.add('disabled-select');
                                
                // Mensaje inicial para autogeneración de nombres
                updateNameHelp('🔒 El nombre se generará automáticamente al completar categoría y tipo. Haz clic en "Editar Manual" para escribir manualmente.');
                
                // Configurar botones de edición manual/automática
                setTimeout(() => {
                    const manualBtn = document.querySelector('.btn-warning.btn-small');
                    const autoBtn = document.getElementById('autoEditBtn');
                    if (manualBtn) manualBtn.style.display = 'inline-block';
                    if (autoBtn) autoBtn.style.display = 'none';
                }, 100);
            }
            
            // Configurar campos en mayúsculas
            setupUppercaseFields();
            
            // Actualizar selects que dependen de otros datos
            updateAssetParentSelects();
            
            // Configurar event listeners para autogeneración
            setupAutoGenerationListeners();
            
            // Configurar event listener para mostrar descripción del estado
            const estadoSelect = document.getElementById('assetStatus');
            if (estadoSelect) {
                // Remover event listeners existentes para evitar duplicados
                estadoSelect.removeEventListener('change', handleEstadoChange);
                estadoSelect.addEventListener('change', handleEstadoChange);
            }
            
            // Mostrar el modal
            modal.classList.add('active');
            
            // Enfocar el primer campo editable (categoría)
            setTimeout(() => {
                const categoryInput = document.getElementById('assetCategory');
                if (categoryInput) {
                    categoryInput.focus();
                }
            }, 400);
        }

        // Función auxiliar para manejar cambios en el estado
        function handleEstadoChange() {
            const estadoId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const description = selectedOption ? selectedOption.getAttribute('data-description') : null;
            
            showEstadoDescription(estadoId, description);
        }

        // Función para mostrar la descripción del estado
        function showEstadoDescription(estadoId, description) {
            const descContainer = document.getElementById('estadoDescription');
            const descText = document.getElementById('estadoDescText');
            
            if (!estadoId || !description) {
                if (descContainer) {
                    descContainer.style.display = 'none';
                }
                return;
            }
            
            // Mostrar la descripción con animación
            if (descText) {
                descText.textContent = description || 'Sin descripción disponible';
            }
            
            if (descContainer) {
                descContainer.style.display = 'block';
                
                // Agregar clase para animación
                descContainer.classList.add('show');
                
                // Cambiar color del borde según el tipo de estado
                const estado = AppState.statuses.find(s => s.id == estadoId);
                if (estado) {
                    const estadoNombre = estado.nombre.toUpperCase();
                    let borderColor = 'var(--primary-color)';
                    let icon = '📝';
                    
                    // Asignar colores e íconos según el estado
                    if (estadoNombre.includes('OPERATIVO') || estadoNombre.includes('ACTIVO')) {
                        borderColor = 'var(--success-color)';
                        icon = '✅';
                    } else if (estadoNombre.includes('REPARACION') || estadoNombre.includes('MANTENIMIENTO')) {
                        borderColor = 'var(--warning-color)';
                        icon = '🔧';
                    } else if (estadoNombre.includes('ALMACEN') || estadoNombre.includes('DISPONIBLE')) {
                        borderColor = 'var(--info-color)';
                        icon = '📦';
                    } else if (estadoNombre.includes('BAJA') || estadoNombre.includes('INACTIVO')) {
                        borderColor = 'var(--danger-color)';
                        icon = '❌';
                    }
                    
                    descContainer.style.borderLeftColor = borderColor;
                    
                    // Actualizar ícono en el título si existe
                    const descTitle = descContainer.querySelector('.desc-title');
                    if (descTitle) {
                        descTitle.innerHTML = `${icon} Descripción del Estado`;
                    }
                }
            }
        }

        function closeAssetModal() {
            const modal = document.getElementById('assetModal');
            const codeInput = document.getElementById('assetCode');
            const nameInput = document.getElementById('assetName');
            
            // Cerrar el modal
            modal.classList.remove('active');

            // Restaurar el campo código a su estado normal
            if (codeInput) {
                codeInput.readOnly = false;
                codeInput.style.backgroundColor = '';
                codeInput.style.cursor = '';
                codeInput.style.borderColor = '';
            }
            
            // Restaurar el campo nombre a estado bloqueado
            if (nameInput) {
                nameInput.readOnly = true;
                nameInput.style.backgroundColor = 'var(--light-color)';
                nameInput.style.cursor = 'not-allowed';
                nameInput.style.borderColor = '';
                nameInput.style.boxShadow = '';
                
                // Restaurar icono de candado
                const lockIcon = nameInput.parentNode.querySelector('i.fas');
                if (lockIcon) {
                    lockIcon.className = 'fas fa-lock';
                    lockIcon.style.color = 'var(--text-muted)';
                }
                
                // Restaurar visibilidad de botones
                const manualBtn = document.querySelector('.btn-warning.btn-small');
                const autoBtn = document.getElementById('autoEditBtn');
                if (manualBtn) manualBtn.style.display = 'inline-block';
                if (autoBtn) autoBtn.style.display = 'none';
            }
            
            // Ocultar y resetear la descripción del estado
            const descContainer = document.getElementById('estadoDescription');
            if (descContainer) {
                descContainer.style.display = 'none';
                descContainer.classList.remove('show');
                descContainer.style.borderLeftColor = 'var(--primary-color)'; // Resetear color del borde
                
                // Resetear ícono del título si existe
                const descTitle = descContainer.querySelector('.desc-title');
                if (descTitle) {
                    descTitle.innerHTML = '📝 Descripción del Estado';
                }
            }
            
            const descText = document.getElementById('estadoDescText');
            if (descText) {
                descText.textContent = 'Selecciona un estado para ver su descripción';
            }
            
            // Remover event listeners específicos del estado para evitar duplicados
            const estadoSelect = document.getElementById('assetStatus');
            if (estadoSelect) {
                estadoSelect.removeEventListener('change', handleEstadoChange);
            }
            
            // Limpiar el estado de edición
            AppState.currentEditingAsset = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#assetForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
            
            // Limpiar campos de especificaciones técnicas si existen
            const specsContainer = document.getElementById('specificationsContainer');
            if (specsContainer) {
                specsContainer.innerHTML = '';
            }
            
            // Limpiar campos específicos de especificaciones
            const specFields = [
                'specProcessor', 'specRAM', 'specStorage', 'specDisplay',
                'specTechnology', 'specColor', 'specSpeed', 'specFunctions',
                'specCapacity', 'specInterface', 'specType'
            ];
            
            specFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                        field.value = '';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    }
                }
            });
            
            // Resetear el sistema de nombres automáticos
            const nameHelpText = document.getElementById('nameHelpText');
            if (nameHelpText) {
                nameHelpText.textContent = 'El nombre se generará automáticamente al completar los campos.';
                nameHelpText.style.color = 'var(--text-muted)';
            }
            
            // Resetear el formulario completamente después de un delay
            setTimeout(() => {
                resetAssetForm();
                
                // Asegurar que el campo código esté completamente limpio
                if (codeInput) {
                    codeInput.value = '';
                    codeInput.readOnly = false;
                    codeInput.style.backgroundColor = '';
                    codeInput.style.cursor = '';
                }
                
                // Asegurar que el campo nombre esté bloqueado
                if (nameInput) {
                    nameInput.readOnly = true;
                    nameInput.style.backgroundColor = 'var(--light-color)';
                    nameInput.style.cursor = 'not-allowed';
                    
                    // Restaurar icono de candado
                    const lockIcon = nameInput.parentNode.querySelector('i.fas');
                    if (lockIcon) {
                        lockIcon.className = 'fas fa-lock';
                        lockIcon.style.color = 'var(--text-muted)';
                    }
                }
                
                // Asegurar que la descripción del estado esté oculta y reseteada
                if (descContainer) {
                    descContainer.style.display = 'none';
                    descContainer.style.borderLeftColor = 'var(--primary-color)';
                }
                
                if (descText) {
                    descText.textContent = 'Selecciona un estado para ver su descripción';
                }
                
                // Restaurar botón de desbloquear código si existe
                const unlockBtn = document.getElementById('unlockCodeBtn');
                if (unlockBtn) {
                    unlockBtn.innerHTML = '<i class="fas fa-unlock"></i> Desbloquear código';
                    unlockBtn.classList.remove('btn-success');
                    unlockBtn.classList.add('btn-warning');
                }
                
            }, 300);
        }

        // Función auxiliar para resetear el formulario de activos
        function resetAssetForm() {
            const form = document.getElementById('assetForm');
            if (form) {
                form.reset();
            }
            
            // Resetear campos específicos que no se limpian con form.reset()
            const assetType = document.getElementById('assetType');
            if (assetType) {
                assetType.innerHTML = '<option value="">Primero selecciona una categoría</option>';
                assetType.disabled = true;
                assetType.classList.add('disabled-select');
            }
            
            // Resetear selector de estado
            const assetStatus = document.getElementById('assetStatus');
            if (assetStatus) {
                assetStatus.selectedIndex = 0;
            }
            
            // Generar nuevo código automático
            const codeInput = document.getElementById('assetCode');
            if (codeInput) {
                codeInput.value = generateAssetCode();
            }
            
            // Asegurar que el campo nombre esté vacío y bloqueado
            const nameInput = document.getElementById('assetName');
            if (nameInput) {
                nameInput.value = '';
                nameInput.readOnly = true;
                nameInput.style.backgroundColor = 'var(--light-color)';
                nameInput.style.cursor = 'not-allowed';
            }
            
            const activeSelect = document.getElementById('assetActive');
            if (activeSelect) {
                activeSelect.value = 'true';
            }
            
            // Limpiar cualquier estilo residual de validación
            document.querySelectorAll('#assetForm .form-control').forEach(input => {
                input.style.borderColor = '';
                input.classList.remove('error');
            });
            
            // Ocultar descripción del estado
            const descContainer = document.getElementById('estadoDescription');
            if (descContainer) {
                descContainer.style.display = 'none';
            }
        } 

        async function saveAsset() {
            try {
                // Validar formulario
                if (!validateAssetForm()) {
                    return;
                }
                
                // Validación adicional: asegurar que el tipo pertenece a la categoría
                const categoryId = document.getElementById('assetCategory').value;
                const typeId = document.getElementById('assetType').value;
                const selectedType = AppState.types.find(t => t.id === parseInt(typeId));
                
                if (selectedType && parseInt(selectedType.categoria_activo_id) !== parseInt(categoryId)) {
                    showToast('Error: El tipo seleccionado no corresponde a la categoría elegida', 'error');
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando activo...');
                
                // Obtener datos del formulario y convertir a mayúsculas
                const formData = {
                    codigo: document.getElementById('assetCode').value.trim(),
                    nombre: document.getElementById('assetName').value.trim(),
                    tipo_activo_id: document.getElementById('assetType').value,
                    marca_id: document.getElementById('assetBrand').value || null,
                    // CONVERTIR A MAYÚSCULAS
                    modelo: document.getElementById('assetModel').value.trim().toUpperCase() || null,
                    numero_serie: document.getElementById('assetSerial').value.trim().toUpperCase() || null,
                    activo: document.getElementById('assetActive').value === 'true',
                    ubicacion_id: document.getElementById('assetLocation').value || null,
                    usuario_id: document.getElementById('assetUser').value || null,
                    id_activo_padre: document.getElementById('assetParent').value || null,
                    // CONVERTIR A MAYÚSCULAS
                    observaciones: document.getElementById('assetObservations').value.trim().toUpperCase() || null
                };
                
                // Solo agregar estado_id si existe el campo en el formulario y tiene valor
                const estadoId = document.getElementById('assetStatus').value;
                if (estadoId) {
                    formData.estado_id = estadoId;
                }
                
                console.log('📤 Datos a guardar:', formData);
                
                let result;
                
                if (AppState.currentEditingAsset) {
                    // Actualizar activo existente
                    const { data, error } = await supabase
                        .from('activo')
                        .update(formData)
                        .eq('id', AppState.currentEditingAsset.id)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nuevo activo
                    const { data, error } = await supabase
                        .from('activo')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadAssets();
                
                // ✅ ANIMACIÓN DE ÉXITO ANTES DE CERRAR
                const saveBtn = document.getElementById('saveIpBtn');
                const originalText = saveBtn.innerHTML;

                saveBtn.innerHTML = '<i class="fas fa-check"></i> Guardado!';
                saveBtn.style.backgroundColor = 'var(--success-color)';
                // Limpiar formulario
                resetIPForm();

                // ✅ Cerrar modal después de animación
                setTimeout(() => {
                    closeIPModal();
                }, 800);        

                showLoadingOverlay(false);
                showToast(`Activo ${AppState.currentEditingAsset ? 'actualizado' : 'creado'} correctamente`, 'success');

                closeAssetModal();
                
            } catch (error) {
                console.error('Error guardando activo:', error);
                
                // Manejo específico de errores
                if (error.code === '23503') {
                    showToast('Error: El estado seleccionado no existe.', 'error');
                } else if (error.code === '22P02') {
                    showToast('Error: Tipo de dato incorrecto en uno de los campos.', 'error');
                } else if (error.message.includes('estado_id')) {
                    showToast('Error: Problema con el campo estado. Verifica la configuración.', 'error');
                } else {
                    showToast('Error al guardar el activo: ' + error.message, 'error');
                }
                
                showLoadingOverlay(false);
            }
        }

        // Función para configurar campos en mayúsculas
        function setupUppercaseFields() {
            const uppercaseFields = ['assetModel', 'assetSerial', 'assetObservations'];
            
            uppercaseFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Remover event listeners existentes para evitar duplicados
                    field.removeEventListener('input', handleUppercaseInput);
                    field.removeEventListener('blur', handleUppercaseBlur);
                    
                    // Agregar event listeners
                    field.addEventListener('input', handleUppercaseInput);
                    field.addEventListener('blur', handleUppercaseBlur);
                    
                    // Aplicar clase CSS
                    field.classList.add('uppercase-field');
                }
            });
        }

        // Función para manejar input en tiempo real
        function handleUppercaseInput(event) {
            const field = event.target;
            const cursorPosition = field.selectionStart;
            
            // Convertir a mayúsculas manteniendo la posición del cursor
            field.value = field.value.toUpperCase();
            field.setSelectionRange(cursorPosition, cursorPosition);
        }

        // Función para manejar blur (cuando pierde el foco)
        function handleUppercaseBlur(event) {
            const field = event.target;
            field.value = field.value.toUpperCase();
        }

        function validateAssetForm() {
            let isValid = true;
            
            // Validar código
            const code = document.getElementById('assetCode').value.trim();
            const codeError = document.getElementById('codeError');
            if (!code) {
                codeError.textContent = 'El código es requerido';
                codeError.classList.add('show');
                isValid = false;
            } else {
                codeError.classList.remove('show');
            }
            
            // Validar nombre
            const name = document.getElementById('assetName').value.trim();
            const nameError = document.getElementById('nameError');
            if (!name) {
                nameError.textContent = 'El nombre es requerido';
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            // Validar categoría
            const category = document.getElementById('assetCategory').value;
            const categoryError = document.getElementById('categoryError');
            if (!category) {
                categoryError.textContent = 'La categoría es requerida';
                categoryError.classList.add('show');
                isValid = false;
            } else {
                categoryError.classList.remove('show');
            }
            
            // Validar tipo
            const type = document.getElementById('assetType').value;
            const typeError = document.getElementById('typeError');
            if (!type) {
                typeError.textContent = 'El tipo es requerido';
                typeError.classList.add('show');
                isValid = false;
            } else {
                typeError.classList.remove('show');
            }
            
            // Validar que el tipo seleccionado pertenezca a la categoría seleccionada
            if (category && type) {
                const selectedType = AppState.types.find(t => t.id === type);
                if (selectedType && selectedType.categoria_activo_id !== category) {
                    typeError.textContent = 'El tipo seleccionado no pertenece a la categoría elegida';
                    typeError.classList.add('show');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        function generateAssetCode() {
            const now = new Date();
            
            // Parte de fecha: AAMMDD
            const datePart = now.getFullYear().toString().slice(-2) + 
                            (now.getMonth() + 1).toString().padStart(2, '0') +
                            now.getDate().toString().padStart(2, '0');
            
            // Parte de tiempo: HHMMSS (opcional, para mayor unicidad)
            const timePart = now.getHours().toString().padStart(2, '0') +
                            now.getMinutes().toString().padStart(2, '0') +
                            now.getSeconds().toString().padStart(2, '0');
            
            // Parte aleatoria para evitar colisiones
            const randomPart = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // Formato: ACT-FECHA-TIEMPO-RANDOM
            return `ACT-${datePart}-${timePart}-${randomPart}`;
        }

        // ===== FUNCIÓN PARA CONFIGURAR BOTONES DE IPs =====
        function setupIPButtonsListeners() {
            console.log('🔧 Configurando listeners de botones de IP...');
            
            // Botones de editar IP
            document.querySelectorAll('.edit-ip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ipId = this.getAttribute('data-ip-id');
                    console.log('✏️ Editando IP:', ipId);
                    if (ipId) {
                        editIP(ipId);
                        showToast('Cargando datos de la IP para edición...', 'info');
                    }
                });
            });
            
            // Botones de activar/desactivar IP
            document.querySelectorAll('.toggle-ip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ipId = this.getAttribute('data-ip-id');
                    console.log('🔄 Cambiando estado de IP:', ipId);
                    if (ipId) {
                        toggleIPStatus(ipId);
                    }
                });
            });
            
            // Botones de eliminar IP
            document.querySelectorAll('.delete-ip-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ipId = this.getAttribute('data-ip-id');
                    console.log('🗑️ Eliminando IP:', ipId);
                    if (ipId) {
                        deleteIP(ipId);
                    }
                });
            });
            
            console.log('✅ Listeners de botones de IP configurados');
        }

        // ===== SISTEMA DE AUTOGENERACIÓN DE NOMBRES =====
        function setupAdvancedAutoName() {
            const nameInput = document.getElementById('assetName');
            const nameGroup = document.getElementById('assetName').closest('.form-group');
            
            // Verificar si ya existe el contenedor de ayuda
            if (document.getElementById('nameHelpContainer')) {
                return;
            }
            
            // Crear contenedor de ayuda
            const helpContainer = document.createElement('div');
            helpContainer.className = 'name-help';
            helpContainer.id = 'nameHelpContainer';
            
            const helpText = document.createElement('div');
            helpText.className = 'help-text';
            helpText.id = 'nameHelpText';
            helpText.textContent = 'El nombre se generará automáticamente al completar los campos.';
            
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'help-actions';
            
            const templateBtn = document.createElement('button');
            templateBtn.type = 'button';
            templateBtn.className = 'btn btn-info btn-small';
            templateBtn.innerHTML = '<i class="fas fa-list"></i> Ver Plantillas';
            templateBtn.onclick = showTemplateOptions;
            
            // Botón para habilitar edición manual
            const manualEditBtn = document.createElement('button');
            manualEditBtn.type = 'button';
            manualEditBtn.className = 'btn btn-warning btn-small';
            manualEditBtn.innerHTML = '<i class="fas fa-edit"></i> Editar Manual';
            manualEditBtn.onclick = enableManualEditing;
            
            // Botón para volver a modo automático (inicialmente oculto)
            const autoEditBtn = document.createElement('button');
            autoEditBtn.type = 'button';
            autoEditBtn.className = 'btn btn-success btn-small';
            autoEditBtn.innerHTML = '<i class="fas fa-robot"></i> Modo Automático';
            autoEditBtn.onclick = enableAutoEditing;
            autoEditBtn.id = 'autoEditBtn';
            autoEditBtn.style.display = 'none';
            
            actionsContainer.appendChild(templateBtn);
            actionsContainer.appendChild(manualEditBtn);
            actionsContainer.appendChild(autoEditBtn);
            helpContainer.appendChild(helpText);
            helpContainer.appendChild(actionsContainer);
            
            // Insertar después del campo nombre
            nameGroup.appendChild(helpContainer);
            
            // Configurar event listeners para autogeneración
            setupAutoGenerationListeners();
            
            console.log('✅ Sistema de autogeneración de nombres configurado');
        }

        function setupAutoGenerationListeners() {
            const fieldsToWatch = [
                'assetCategory', 'assetType', 'assetBrand', 'assetModel'
            ];
            
            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Remover event listeners existentes para evitar duplicados
                    field.removeEventListener('change', handleAutoGeneration);
                    field.addEventListener('change', handleAutoGeneration);
                    
                    // Para el campo modelo, también escuchar input
                    if (fieldId === 'assetModel') {
                        field.removeEventListener('input', handleAutoGeneration);
                        field.addEventListener('input', debounce(handleAutoGeneration, 500));
                    }
                }
            });
        }

        function handleAutoGeneration() {
            // SIEMPRE generar nombre automático cuando cambien los campos
            generateAdvancedName();
        }

        function shouldAutoGenerateName() {
            const nameInput = document.getElementById('assetName');
            const currentName = nameInput.value;
            
            // Solo autogenerar si:
            // 1. El campo está vacío, O
            // 2. El nombre actual parece ser generado automáticamente
            return !currentName || 
                currentName.startsWith('EQUIPO-') || 
                currentName.includes('#') ||
                isGeneratedName(currentName);
        }

        function isGeneratedName(name) {
            if (!name) return false;
            
            // Patrones que indican nombre generado automáticamente
            const generatedPatterns = [
                /#\d{2,}/, // Contiene número como #001, #01
                /^(Laptop|Computadora|Monitor|Impresora|Tablet|Servidor|Switch|Router)\s+\w+/i,
                /^[A-Za-z]+\s+[A-Za-z]+\s+#\d+/ // Formato "Tipo Marca #001"
            ];
            
            return generatedPatterns.some(pattern => pattern.test(name));
        }

        function generateAdvancedName() {
            const categoryId = document.getElementById('assetCategory').value;
            const typeId = document.getElementById('assetType').value;
            const brandId = document.getElementById('assetBrand').value;
            const model = document.getElementById('assetModel').value.trim();
            
            // Validaciones básicas
            if (!categoryId || !typeId) {
                updateNameHelp('Selecciona categoría y tipo para generar nombre automático.');
                return;
            }
            
            const category = AppState.categories.find(c => c.id == categoryId);
            const type = AppState.types.find(t => t.id == typeId);
            const brand = brandId ? AppState.brands.find(b => b.id == brandId) : null;
            
            if (!type) {
                updateNameHelp('Error: Tipo no encontrado.');
                return;
            }
            
            let generatedName;
            
            // Lógica de generación basada en la información disponible
            if (type && brand && model) {
                // Máxima información: Tipo + Marca + Modelo
                generatedName = `${type.nombre} ${brand.nombre} ${model}`;
            } else if (type && brand) {
                // Sin modelo: Tipo + Marca
                generatedName = `${type.nombre} ${brand.nombre}`;
            } else if (type && model) {
                // Sin marca: Tipo + Modelo
                generatedName = `${type.nombre} ${model}`;
            } else {
                // Solo tipo
                generatedName = `${type.nombre}`;
            }
            
            // SOLO actualizar si el campo está en modo automático (readonly)
            const nameInput = document.getElementById('assetName');
            if (nameInput.readOnly) {
                nameInput.value = generatedName;
                updateNameHelp(`✅ Nombre generado automáticamente: "${generatedName}"`);
            }
        }

        function generateFullName(type, brand, model) {
            const count = AppState.assets.filter(a => 
                a.tipo_activo_id == type.id && 
                a.marca_id == brand.id &&
                a.modelo && 
                a.modelo.toLowerCase() === model.toLowerCase()
            ).length;
            
            const nextNum = count + 1;
            return `${type.nombre} ${brand.nombre} ${model} #${nextNum.toString().padStart(2, '0')}`;
        }

        function generateBrandName(type, brand) {
            const count = AppState.assets.filter(a => 
                a.tipo_activo_id == type.id && 
                a.marca_id == brand.id
            ).length;
            
            const nextNum = count + 1;
            return `${type.nombre} ${brand.nombre} #${nextNum.toString().padStart(2, '0')}`;
        }

        function generateModelName(type, model) {
            const count = AppState.assets.filter(a => 
                a.tipo_activo_id == type.id && 
                a.modelo && 
                a.modelo.toLowerCase() === model.toLowerCase()
            ).length;
            
            const nextNum = count + 1;
            return `${type.nombre} ${model} #${nextNum.toString().padStart(2, '0')}`;
        }

        function generateBasicName(type) {
            const count = AppState.assets.filter(a => a.tipo_activo_id == type.id).length;
            const nextNum = count + 1;
            return `${type.nombre} #${nextNum.toString().padStart(2, '0')}`;
        }

        // Nueva función para volver al modo automático
        function enableManualEditing() {
            const nameInput = document.getElementById('assetName');
            const lockIcon = nameInput.parentNode.querySelector('i.fas');
            const manualBtn = document.querySelector('.btn-warning.btn-small');
            const autoBtn = document.getElementById('autoEditBtn');
            
            // Desbloquear el campo
            nameInput.readOnly = false;
            nameInput.style.backgroundColor = '';
            nameInput.style.cursor = 'text';
            
            // Cambiar icono de candado a edición
            if (lockIcon) {
                lockIcon.className = 'fas fa-edit';
                lockIcon.style.color = 'var(--accent-color)';
            }
            
            // Cambiar visibilidad de botones
            if (manualBtn) manualBtn.style.display = 'none';
            if (autoBtn) autoBtn.style.display = 'inline-block';
            
            // Enfocar el campo
            nameInput.focus();
            
            updateNameHelp('✏️ Modo edición manual activado. Puedes escribir el nombre personalizado.');
            
            // Cambiar temporalmente el borde para indicar modo manual
            nameInput.style.borderColor = 'var(--accent-color)';
            nameInput.style.boxShadow = '0 0 0 3px rgba(230, 126, 34, 0.1)';
        }

        function enableAutoEditing() {
            const nameInput = document.getElementById('assetName');
            const lockIcon = nameInput.parentNode.querySelector('i.fas');
            const manualBtn = document.querySelector('.btn-warning.btn-small');
            const autoBtn = document.getElementById('autoEditBtn');
            
            // Bloquear el campo
            nameInput.readOnly = true;
            nameInput.style.backgroundColor = 'var(--light-color)';
            nameInput.style.cursor = 'not-allowed';
            
            // Cambiar icono de edición a candado
            if (lockIcon) {
                lockIcon.className = 'fas fa-lock';
                lockIcon.style.color = 'var(--text-muted)';
            }
            
            // Cambiar visibilidad de botones
            if (manualBtn) manualBtn.style.display = 'inline-block';
            if (autoBtn) autoBtn.style.display = 'none';
            
            // Restaurar estilos
            nameInput.style.borderColor = '';
            nameInput.style.boxShadow = '';
            
            // Regenerar nombre automático
            generateAdvancedName();
            
            updateNameHelp('🔒 Modo automático activado. El nombre se genera automáticamente.');
        }

        function updateNameHelp(message) {
            const helpText = document.getElementById('nameHelpText');
            if (helpText) {
                helpText.textContent = message;
                
                // Cambiar color según el tipo de mensaje
                if (message.includes('✅')) {
                    helpText.style.color = 'var(--success-color)';
                } else if (message.includes('✏️')) {
                    helpText.style.color = 'var(--accent-color)';
                } else if (message.includes('Error')) {
                    helpText.style.color = 'var(--danger-color)';
                } else {
                    helpText.style.color = 'var(--text-muted)';
                }
            }
        }

        // Función para mostrar opciones de plantilla (opcional)
        function showTemplateOptions() {
            const categoryId = document.getElementById('assetCategory').value;
            const typeId = document.getElementById('assetType').value;
            const brandId = document.getElementById('assetBrand').value;
            const model = document.getElementById('assetModel').value.trim();
            
            if (!categoryId || !typeId) {
                showToast('Selecciona categoría y tipo primero', 'warning');
                return;
            }
            
            const category = AppState.categories.find(c => c.id == categoryId);
            const type = AppState.types.find(t => t.id == typeId);
            const brand = brandId ? AppState.brands.find(b => b.id == brandId) : null;
            
            const templates = generateNameTemplates(category, type, brand, model);
            
            if (templates.length === 0) {
                showToast('No hay plantillas disponibles con la información actual', 'info');
                return;
            }
            
            // Crear modal de plantillas
            const modal = document.createElement('div');
            modal.className = 'template-modal';
            modal.innerHTML = `
                <div class="template-modal-content">
                    <h3 style="margin-bottom: 1rem;">Selecciona un formato de nombre</h3>
                    <div class="template-options">
                        ${templates.map((template, index) => `
                            <div class="template-option" onclick="selectNameTemplate('${template.replace(/'/g, "\\'")}')">
                                <i class="fas fa-check"></i>
                                ${template}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="this.closest('.template-modal').remove()">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateAdvancedName(); this.closest('.template-modal').remove()">Generar Auto</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateNameTemplates(category, type, brand, model) {
            const templates = [];
            
            if (type && brand && model) {
                templates.push(`${type.nombre} ${brand.nombre} ${model}`);
                templates.push(`${brand.nombre} ${model} - ${type.nombre}`);
                templates.push(`${category.nombre} ${type.nombre} ${brand.nombre} ${model}`);
            }
            
            if (type && brand) {
                templates.push(`${type.nombre} ${brand.nombre}`);
                templates.push(`${brand.nombre} ${type.nombre}`);
            }
            
            if (type && model) {
                templates.push(`${type.nombre} ${model}`);
                templates.push(`${model} ${type.nombre}`);
            }
            
            if (type) {
                templates.push(`${type.nombre}`);
                templates.push(`${category.nombre} ${type.nombre}`);
            }
            
            return templates;
        }

        function selectNameTemplate(template) {
            document.getElementById('assetName').value = template;
            document.querySelector('.template-modal')?.remove();
            updateNameHelp(`📋 Plantilla aplicada: "${template}"`);
        }

        function showAssetDetails(assetId) {
            const asset = AppState.assets.find(a => a.id === assetId);
            if (!asset) {
                showToast('Activo no encontrado', 'error');
                return;
            }
            
            AppState.currentEditingAsset = asset;

            const modal = document.getElementById('assetDetailsModal');
            const title = document.getElementById('modalAssetTitle');
            const content = document.getElementById('assetDetailsContent');
            
            title.textContent = `Activo: ${asset.codigo}`;
            
            // CORRECCIÓN: Buscar la descripción del estado en AppState.statuses
            let statusDescription = 'Estado no disponible.';
            let statusName = asset.estado || 'Sin estado';
            
            if (asset.estado_id && AppState.statuses.length > 0) {
                const estadoInfo = AppState.statuses.find(s => s.id === asset.estado_id);
                if (estadoInfo) {
                    statusName = estadoInfo.nombre;
                    statusDescription = estadoInfo.descripcion || 'Sin descripción disponible.';
                }
            } else if (asset.estado) {
                // Fallback: buscar por nombre si no tenemos estado_id
                const estadoInfo = AppState.statuses.find(s => 
                    s.nombre.toLowerCase() === asset.estado.toLowerCase()
                );
                if (estadoInfo) {
                    statusDescription = estadoInfo.descripcion || 'Sin descripción disponible.';
                }
            }
            
            const statusText = getStatusText(statusName);
            const createdDate = new Date(asset.fecha_registro).toLocaleString();
            const ubicacionCompleta = formatUbicacionCompleta(asset.ubicacion_id);
            
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--text-color);">${asset.nombre}</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                        <span class="asset-code">${asset.codigo}</span>
                        <span class="asset-status status-${statusName.toLowerCase().replace(' ', '-')}">${statusText}</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <h5 style="margin-bottom: 0.5rem; color: var(--text-color);">Información General</h5>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Tipo:</strong> ${asset.tipo_activo}</p>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Marca:</strong> ${asset.marca || 'No especificada'}</p>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Modelo:</strong> ${asset.modelo || 'No especificado'}</p>
                        <p style="color: var(--text-color);"><strong>Número de Serie:</strong> ${asset.numero_serie || 'No especificado'}</p>
                    </div>
                    <div>
                        <h5 style="margin-bottom: 0.5rem; color: var(--text-color);">Ubicación y Asignación</h5>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Ubicación:</strong> ${ubicacionCompleta}</p>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Usuario:</strong> ${asset.usuario}</p>
                        <p style="color: var(--text-color); margin-bottom: 0.5rem;"><strong>Activo Padre:</strong> ${asset.activo_padre}</p>
                        <p style="color: var(--text-color);"><strong>Fecha Registro:</strong> ${createdDate}</p>
                    </div>
                </div>
                
                ${asset.observaciones ? `
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--text-color);">Observaciones</h5>
                    <p style="color: var(--text-color); line-height: 1.6;">${asset.observaciones}</p>
                </div>
                ` : ''}
                
                <div style="background: var(--light-color); padding: 1rem; border-radius: var(--border-radius-sm);">
                    <h5 style="margin-bottom: 0.5rem; color: var(--text-color);">Información del Estado:</h5>
                    <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                        ${statusDescription}
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeAssetDetailsModal() {
            document.getElementById('assetDetailsModal').classList.remove('active');
            AppState.currentEditingAsset = null;
        }

        // ===== GESTIÓN DE CATEGORÍAS =====
        function openCategoryModal(categoryId = null) {
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            
            if (categoryId) {
                // Modo edición
                const category = AppState.categories.find(c => c.id === categoryId);
                if (category) {
                    AppState.currentEditingCategory = category;
                    title.textContent = 'Editar Categoría';
                    
                    // Llenar formulario
                    document.getElementById('categoryName').value = category.nombre;
                    document.getElementById('categoryDescription').value = category.descripcion || '';
                }
            } else {
                // Modo creación
                AppState.currentEditingCategory = null;
                title.textContent = 'Nueva Categoría';
                
                // Limpiar formulario
                document.getElementById('categoryForm').reset();
            }
            
            modal.classList.add('active');
        }

        async function openIPManagementModal(assetId) {
            console.log('🔗 Abriendo gestión de IPs para activo:', assetId);
            
            const asset = AppState.assets.find(a => a.id === assetId);
            if (!asset) {
                console.error('❌ Activo no encontrado:', assetId);
                showToast('Error: Activo no encontrado', 'error');
                return;
            }
            
            AppState.currentAssetForIP = asset;
            document.getElementById('ipModalTitle').textContent = `IPs - ${asset.codigo} - ${asset.nombre}`;
            
            // Limpiar formulario
            resetIPForm();
            
            // Cargar IPs existentes
            await loadAssetIPs(assetId);
            
            // Mostrar modal
            document.getElementById('ipManagementModal').classList.add('active');
        }

        async function loadAssetIPs(assetId) {
            try {
                console.log('📡 Cargando IPs para activo:', assetId);
                
                const { data, error } = await supabase
                    .from('direccion_ip')
                    .select('*')
                    .eq('activo_id', assetId)
                    .order('direccion_ip');
                
                if (error) {
                    console.error('❌ Error en consulta Supabase:', error);
                    throw error;
                }
                
                console.log('✅ IPs cargadas:', data?.length || 0);
                renderIPsList(data || []);
                
            } catch (error) {
                console.error('❌ Error cargando IPs:', error);
                showToast('Error al cargar las direcciones IP: ' + error.message, 'error');
            }
        }

        // Función para activar/desactivar IP
        async function toggleIPStatus(ipId) {
            try {
                const { data: ip, error: fetchError } = await supabase
                    .from('direccion_ip')
                    .select('activo')
                    .eq('id', ipId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const newStatus = !ip.activo;
                
                const { error } = await supabase
                    .from('direccion_ip')
                    .update({ 
                        activo: newStatus,
                        fecha_actualizacion: new Date().toISOString()
                    })
                    .eq('id', ipId);
                
                if (error) throw error;
                
                // Recargar lista de IPs
                await loadAssetIPs(AppState.currentAssetForIP.id);
                
                showToast(`IP ${newStatus ? 'activada' : 'desactivada'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error cambiando estado de IP:', error);
                showToast('Error al cambiar el estado de la IP', 'error');
            }
        }

        // Función para eliminar IP
        async function deleteIP(ipId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta dirección IP?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('direccion_ip')
                    .delete()
                    .eq('id', ipId);
                
                if (error) throw error;
                
                // Recargar lista de IPs
                await loadAssetIPs(AppState.currentAssetForIP.id);
                
                showToast('IP eliminada correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando IP:', error);
                showToast('Error al eliminar la dirección IP', 'error');
            }
        }

        // Función mejorada para validar y formatear dirección MAC
        function validateAndFormatMAC(mac) {
            if (!mac || mac.trim() === '') {
                return null;
            }
            
            console.log('🔍 Validando MAC original:', mac);
            
            let cleanedMAC = mac.trim().toUpperCase();
            
            // CORRECCIÓN: Expresión regular simplificada
            cleanedMAC = cleanedMAC.replace(/[:\.\-\s]/g, '');
            
            console.log('🔍 MAC limpia:', cleanedMAC, 'Longitud:', cleanedMAC.length);
            
            // Validar longitud (debe ser 12 caracteres hex)
            if (cleanedMAC.length !== 12) {
                console.warn('⚠️ Longitud de MAC inválida:', cleanedMAC.length, 'caracteres');
                return null;
            }
            
            // Validar que sean caracteres hexadecimales
            if (!/^[0-9A-F]{12}$/.test(cleanedMAC)) {
                console.warn('⚠️ Caracteres MAC inválidos:', cleanedMAC);
                return null;
            }
            
            // Formatear a formato estándar: XX:XX:XX:XX:XX:XX
            const formattedMAC = cleanedMAC.match(/.{1,2}/g).join(':');
            
            console.log('✅ MAC validada y formateada:', formattedMAC);
            return formattedMAC;
        }

        // Función de validación de IP mejorada
        function isValidIP(ip) {
            if (!ip || ip.trim() === '') return false;
            
            const ipRegex = /^([0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipRegex.test(ip)) return false;
            
            // Validar que cada octeto esté entre 0-255
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        function closeIPModal() {
            const modal = document.getElementById('ipManagementModal');
            if (modal) {
                modal.classList.remove('active');
            }
            resetIPForm();
            AppState.currentEditingIP = null;
            AppState.currentAssetForIP = null;
            
            console.log('✅ Modal de IPs cerrado');
        }

        function resetIPForm() {
            document.getElementById('ipForm').reset();
            document.getElementById('ipSubnet').value = '255.255.255.0';
            document.getElementById('ipType').value = 'ETHERNET';
            document.getElementById('ipActive').checked = true;
            document.getElementById('ipAddress').readOnly = false;
            document.getElementById('ipAddress').style.backgroundColor = '';
            document.getElementById('ipError').classList.remove('show');
            document.getElementById('macError').classList.remove('show');
            
            // Limpiar cualquier feedback visual de errores
            const ipInput = document.getElementById('ipAddress');
            if (ipInput) {
                ipInput.style.borderColor = '';
                ipInput.style.backgroundColor = '';
                ipInput.style.boxShadow = '';
            }
            
            // Limpiar panel de acciones rápidas
            const quickAction = document.getElementById('quickActionButton');
            if (quickAction) {
                quickAction.remove();
            }
            
            AppState.currentEditingIP = null;
            
            console.log('✅ Formulario de IPs reseteado');
        }

        function renderIPsList(ips) {
            const container = document.getElementById('currentIPsContainer');
            
            if (ips.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center;">
                        <i class="fas fa-network-wired" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="color: var(--text-muted);">No hay direcciones IP configuradas</p>
                        <small style="color: var(--text-muted);">Haz clic en "Agregar IP" para configurar la primera dirección</small>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0;">Direcciones IP Configuradas</h4>
                    <span class="badge" style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.8rem;">
                        ${ips.length} IP${ips.length !== 1 ? 's' : ''}
                    </span>
                </div>
            `;
            
            ips.forEach(ip => {
                const statusClass = ip.activo ? 'ip-active' : 'ip-inactive';
                const statusText = ip.activo ? 'Activa' : 'Inactiva';
                const statusIcon = ip.activo ? 'fa-check-circle' : 'fa-pause-circle';
                
                html += `
                    <div class="ip-card ${statusClass}" data-ip-id="${ip.id}">
                        <div class="ip-info">
                            <div class="ip-main">
                                <strong style="font-family: 'Courier New', monospace;">${ip.direccion_ip}</strong>
                                <span class="ip-status">
                                    <i class="fas ${statusIcon}"></i> ${statusText}
                                </span>
                            </div>
                            <div class="ip-details">
                                <div class="ip-detail-item">
                                    <i class="fas fa-plug"></i>
                                    <span>${ip.tipo_conexion}</span>
                                </div>
                                ${ip.direccion_mac ? `
                                <div class="ip-detail-item">
                                    <i class="fas fa-fingerprint"></i>
                                    <span>${ip.direccion_mac}</span>
                                </div>
                                ` : ''}
                                ${ip.observaciones ? `
                                <div class="ip-detail-item">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>${ip.observaciones}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="ip-actions">
                            <button class="btn btn-accent btn-small edit-ip-btn" data-ip-id="${ip.id}" title="Editar IP">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-${ip.activo ? 'warning' : 'success'} btn-small toggle-ip-btn" data-ip-id="${ip.id}" title="${ip.activo ? 'Desactivar' : 'Activar'} IP">
                                <i class="fas fa-${ip.activo ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-danger btn-small delete-ip-btn" data-ip-id="${ip.id}" title="Eliminar IP">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Configurar event listeners para los botones de IP
            setupIPButtonsListeners();
        }

        // En setupEventListeners(), agregar:
        function setupIPEventListeners() {
            // Modal de IPs
            document.getElementById('closeIpModal').addEventListener('click', closeIPModal);
            document.getElementById('cancelIpBtn').addEventListener('click', closeIPModal);
            document.getElementById('saveIpBtn').addEventListener('click', saveIP);
            
            // Validación de IP en tiempo real - CON ERRORES SEPARADOS
            document.getElementById('ipAddress').addEventListener('input', function() {
                const ipError = document.getElementById('ipError');
                const ipValue = this.value.trim();
                
                if (ipValue && !isValidIP(ipValue)) {
                    ipError.textContent = 'Formato de IP inválido. Use: 192.168.1.100';
                    ipError.classList.add('show');
                } else {
                    ipError.classList.remove('show');
                }
            });
            
            // Validación de MAC en tiempo real - CON ERRORES SEPARADOS
            document.getElementById('ipMAC').addEventListener('input', function() {
                const macError = document.getElementById('macError');
                const macValue = this.value.trim();
                
                if (macValue && !validateAndFormatMAC(macValue)) {
                    macError.textContent = 'Formato de MAC inválido. Formatos: 00:1B:44:11:3A:B7, 00-1B-44-11-3A-B7, 001B44113AB7';
                    macError.classList.add('show');
                } else {
                    macError.classList.remove('show');
                }
            });
            
            // Auto-formateo de MAC mientras escribe
            document.getElementById('ipMAC').addEventListener('blur', function() {
                const formattedMAC = validateAndFormatMAC(this.value);
                if (formattedMAC) {
                    this.value = formattedMAC;
                }
            });
        }

        // Y en la función saveIP(), actualiza las validaciones:
        async function saveIP() {
            console.log('🚀 Iniciando saveIP()...');
            
            try {
                // Obtener valores de los campos
                const ipAddress = document.getElementById('ipAddress').value.trim();
                const macAddress = document.getElementById('ipMAC').value.trim();
                const subnet = document.getElementById('ipSubnet').value.trim();
                const gateway = document.getElementById('ipGateway').value.trim();
                const dns1 = document.getElementById('ipDNS1').value.trim();
                const dns2 = document.getElementById('ipDNS2').value.trim();
                const connectionType = document.getElementById('ipType').value;
                const isActive = document.getElementById('ipActive').checked;
                const observations = document.getElementById('ipObservations').value.trim();

                console.log('📋 Datos del formulario:', {
                    ipAddress,
                    macAddress,
                    subnet,
                    gateway,
                    dns1,
                    dns2,
                    connectionType,
                    isActive,
                    observations
                });

                // Validaciones básicas
                if (!ipAddress) {
                    showToast('La dirección IP es requerida', 'error');
                    document.getElementById('ipAddress').focus();
                    return;
                }

                // Validar formato de IP
                if (!isValidIP(ipAddress)) {
                    showToast('Formato de IP inválido. Use: 192.168.1.100', 'error');
                    document.getElementById('ipAddress').focus();
                    return;
                }

                // Validar MAC si se proporcionó
                let formattedMAC = null;
                if (macAddress) {
                    formattedMAC = validateAndFormatMAC(macAddress);
                    if (!formattedMAC) {
                        showToast('Formato de MAC inválido. Use: 00:1B:44:11:3A:B7', 'error');
                        document.getElementById('ipMAC').focus();
                        return;
                    }
                }

                // Verificar que hay un activo seleccionado
                if (!AppState.currentAssetForIP) {
                    showToast('Error: No hay activo seleccionado', 'error');
                    return;
                }

                // VERIFICACIÓN AVANZADA DE IP DUPLICADA
                console.log('🔍 Verificando IP duplicada...');
                await checkForDuplicateIP(ipAddress, AppState.currentEditingIP?.id);

                console.log('✅ Validaciones pasadas, preparando datos para Supabase...');

                // Preparar datos para Supabase
                const formData = {
                    activo_id: AppState.currentAssetForIP.id,
                    direccion_ip: ipAddress,
                    direccion_mac: formattedMAC,
                    mascara_subred: subnet || '255.255.255.0',
                    gateway: gateway || null,
                    dns_primario: dns1 || null,
                    dns_secundario: dns2 || null,
                    tipo_conexion: connectionType,
                    activo: isActive,
                    observaciones: observations || null,
                    fecha_actualizacion: new Date().toISOString()
                };

                console.log('💾 Datos para guardar:', formData);

                showLoadingOverlay(true, 'Guardando dirección IP...');

                let result;
                
                if (AppState.currentEditingIP) {
                    // Modo edición
                    console.log('📝 Editando IP existente:', AppState.currentEditingIP.id);
                    
                    const { data, error } = await supabase
                        .from('direccion_ip')
                        .update(formData)
                        .eq('id', AppState.currentEditingIP.id)
                        .select();

                    if (error) {
                        console.error('❌ Error de Supabase (edición):', error);
                        throw error;
                    }
                    
                    result = data[0];
                    console.log('✅ IP actualizada:', result);
                    
                } else {
                    // Modo creación
                    console.log('🆕 Creando nueva IP...');
                    formData.fecha_asignacion = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('direccion_ip')
                        .insert([formData])
                        .select();

                    if (error) {
                        console.error('❌ Error de Supabase (creación):', error);
                        throw error;
                    }
                    
                    result = data[0];
                    console.log('✅ Nueva IP creada:', result);
                }

                // Recargar lista de IPs
                await loadAssetIPs(AppState.currentAssetForIP.id);
                
                // Limpiar formulario
                resetIPForm();
                
                showLoadingOverlay(false);
                showToast(`IP ${AppState.currentEditingIP ? 'actualizada' : 'creada'} correctamente`, 'success');
                
                // ✅ NUEVO: Cerrar modal después de guardar
                setTimeout(() => {
                    closeIPModal();
                }, 1000); // Pequeño delay para que se vea el toast

            } catch (error) {
                console.error('❌ Error en saveIP():', error);
                showLoadingOverlay(false);
                
                // MANEJO MEJORADO DE ERRORES
                handleIPError(error, ipAddress);
            }
        }

        // FUNCIÓN DE VERIFICACIÓN DE IP DUPLICADA
        async function checkForDuplicateIP(ipAddress, currentIPId = null) {
            console.log('🔍 Verificando IP duplicada:', ipAddress);
            
            try {
                let query = supabase
                    .from('direccion_ip')
                    .select('id, direccion_ip, activo:activo_id(codigo, nombre)')
                    .eq('direccion_ip', ipAddress);

                // Si estamos editando, excluir la IP actual
                if (currentIPId) {
                    query = query.neq('id', currentIPId);
                }

                const { data, error } = await query;
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const duplicate = data[0];
                    throw {
                        code: 'IP_DUPLICADA',
                        message: `La IP ${ipAddress} ya existe en el sistema`,
                        duplicateInfo: duplicate
                    };
                }
                
                console.log('✅ IP disponible');
                return true;
                
            } catch (error) {
                if (error.code === 'IP_DUPLICADA') {
                    throw error; // Relanzar error específico
                }
                console.warn('⚠️ Error en verificación de duplicados:', error);
                // No lanzar error para no bloquear guardado por fallo en verificación
            }
        }

        // MANEJO MEJORADO DE ERRORES
        function handleIPError(error, ipAddress) {
            // ELEMENTOS DE FEEDBACK VISUAL
            const ipInput = document.getElementById('ipAddress');
            const errorElement = document.getElementById('ipError');
            
            // Obtener el valor real de la IP
            const ipValue = typeof ipAddress === 'string' ? ipAddress : 
                        ipInput ? ipInput.value.trim() : 'IP desconocida';
            
            console.log('🔄 Manejo de error para IP:', ipValue, 'Tipo:', typeof ipAddress);
            
            // RESALTAR CAMPO CON ERROR
            if (ipInput) {
                ipInput.style.borderColor = 'var(--danger-color)';
                ipInput.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.1)';
            }
            
            // MENSAJES ESPECÍFICOS PARA CADA TIPO DE ERROR
            if (error.code === '23505' || error.code === 'IP_DUPLICADA') {
                showDuplicateIPFeedback(error, ipValue); // ← Pasar el valor, no el elemento
            } else if (error.code === '23503') {
                errorElement.textContent = 'Error: El activo referenciado no existe';
                errorElement.classList.add('show');
                showToast('Error de referencia - contacte al administrador', 'error');
            } else if (error.code === '22P02') {
                errorElement.textContent = 'Error: Formato de datos inválido';
                errorElement.classList.add('show');
                showToast('Error de formato en los datos ingresados', 'error');
            } else {
                errorElement.textContent = `Error: ${error.message}`;
                errorElement.classList.add('show');
                showToast('Error inesperado al guardar la IP', 'error');
            }
        }

        // FEEDBACK VISUAL PARA IPs DUPLICADAS
        function showDuplicateIPFeedback(error, ipAddress) {
            const ipInput = document.getElementById('ipAddress');
            const errorElement = document.getElementById('ipError');
            const duplicateInfo = error.duplicateInfo;
            
            // Asegurarnos de que ipAddress sea un string
            const ipValue = typeof ipAddress === 'string' ? ipAddress : 
                        ipInput ? ipInput.value.trim() : 'IP desconocida';
            
            console.log('🎯 Mostrando feedback para IP duplicada:', ipValue);
            
            // MENSAJE DETALLADO CORREGIDO
            let errorMessage = `❌ La IP <strong>${ipValue}</strong> ya existe en el sistema`;
            
            if (duplicateInfo && duplicateInfo.activo) {
                const activoNombre = duplicateInfo.activo.nombre || 'Activo sin nombre';
                const activoCodigo = duplicateInfo.activo.codigo || 'Sin código';
                errorMessage += ` asignada al activo: <strong>${activoCodigo} - ${activoNombre}</strong>`;
            }
            
            errorMessage += `<br><small style="opacity: 0.8;">Use una dirección IP diferente o edite la IP existente</small>`;
            
            errorElement.innerHTML = errorMessage;
            errorElement.classList.add('show');
            
            // FEEDBACK VISUAL MEJORADO
            ipInput.style.borderColor = 'var(--danger-color)';
            ipInput.style.backgroundColor = 'rgba(231, 76, 60, 0.05)';
            
            // BOTÓN DE ACCIÓN RÁPIDA
            showQuickActionButton(duplicateInfo, ipValue);
            
            // NOTIFICACIÓN TOAST MEJORADA
            showEnhancedToast('ip-duplicate', {
                ip: ipValue,
                duplicateInfo: duplicateInfo
            });
        }

        // BOTÓN DE ACCIÓN RÁPIDA
        function showQuickActionButton(duplicateInfo, ipValue) {
            // ELIMINAR BOTÓN ANTERIOR SI EXISTE
            const existingButton = document.getElementById('quickActionButton');
            if (existingButton) {
                existingButton.remove();
            }
            
            // CREAR BOTÓN DE ACCIÓN RÁPIDA SIMPLIFICADO
            const quickActionButton = document.createElement('div');
            quickActionButton.id = 'quickActionButton';
            quickActionButton.className = 'quick-action-panel';
            quickActionButton.innerHTML = `
                <div class="quick-action-content">
                    <div class="quick-action-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>IP Duplicada Encontrada</span>
                    </div>
                    <div class="quick-action-buttons">
                        <button class="btn btn-warning btn-small" onclick="clearIPField()">
                            <i class="fas fa-times"></i> Limpiar Campo
                        </button>
                    </div>
                </div>
            `;
            
            // INSERTAR DESPUÉS DEL CAMPO IP
            const ipFieldContainer = document.getElementById('ipAddress').closest('.form-group');
            if (ipFieldContainer) {
                ipFieldContainer.appendChild(quickActionButton);
                
                // ANIMACIÓN DE ENTRADA
                setTimeout(() => {
                    quickActionButton.classList.add('visible');
                }, 100);
            }
        }

        // SUGERIR NUEVA IP AUTOMÁTICAMENTE
        function suggestNewIP() {
            const ipInput = document.getElementById('ipAddress');
            const currentIP = ipInput.value.trim();
            
            // GENERAR SUGERENCIA BASADA EN LA IP ACTUAL
            const suggestedIP = generateSuggestedIP(currentIP);
            
            ipInput.value = suggestedIP;
            ipInput.focus();
            
            // LIMPIAR ERRORES
            clearIPErrors();
            
            showToast(`✅ IP sugerida: ${suggestedIP}`, 'success');
        }

        // GENERAR SUGERENCIA DE IP
        function generateSuggestedIP(currentIP) {
            const parts = currentIP.split('.');
            if (parts.length === 4) {
                let lastPart = parseInt(parts[3]);
                // SUGERIR SIGUIENTE IP DISPONIBLE
                const newLastPart = (lastPart + 1) % 254;
                // Asegurar que no sea 0, 1 o 255
                const safeLastPart = newLastPart < 2 ? 2 : newLastPart > 254 ? 100 : newLastPart;
                return `${parts[0]}.${parts[1]}.${parts[2]}.${safeLastPart}`;
            }
            // SI NO SE PUEDE PARSEAR, USAR UNA POR DEFECTO
            return '192.168.1.100';
        }

        // VER IP DUPLICADA
        async function viewDuplicateIP(ipId) {
            if (ipId) {
                await editIP(ipId);
                showToast('Cargando IP existente para edición...', 'info');
            } else {
                showToast('No se puede cargar la IP duplicada', 'error');
            }
        }

        // LIMPIAR CAMPO IP
        function clearIPField() {
            const ipInput = document.getElementById('ipAddress');
            ipInput.value = '';
            ipInput.focus();
            clearIPErrors();
            showToast('Campo IP limpiado', 'info');
        }

        // LIMPIAR ERRORES
        function clearIPErrors() {
            const errorElement = document.getElementById('ipError');
            const ipInput = document.getElementById('ipAddress');
            const quickAction = document.getElementById('quickActionButton');
            
            errorElement.classList.remove('show');
            ipInput.style.borderColor = '';
            ipInput.style.backgroundColor = '';
            ipInput.style.boxShadow = '';
            
            if (quickAction) {
                quickAction.remove();
            }
        }

        // TOAST NOTIFICATIONS MEJORADAS
        function showEnhancedToast(type, data) {
            const toastConfig = {
                'ip-duplicate': {
                    icon: 'fa-exclamation-triangle',
                    title: 'IP Duplicada',
                    message: `La IP ${data.ip} ya existe en el sistema`,
                    // ELIMINAMOS LAS ACCIONES DEL TOAST
                    actions: null,
                    duration: 4000
                }
            };
            
            const config = toastConfig[type];
            if (config) {
                showCustomToast(config);
            }
        }

        function showCustomToast(config) {
            // CREAR TOAST PERSONALIZADO
            const toastId = 'custom-toast-' + Date.now();
            const toastHTML = `
                <div class="custom-toast ${config.type || 'info'}" id="${toastId}">
                    <div class="custom-toast-icon">
                        <i class="fas ${config.icon}"></i>
                    </div>
                    <div class="custom-toast-content">
                        <div class="custom-toast-title">${config.title}</div>
                        <div class="custom-toast-message">${config.message}</div>
                        ${config.actions ? `
                        <div class="custom-toast-actions">
                            ${config.actions.map(action => 
                                `<button class="toast-action-btn" onclick="${action.action}">${action.text}</button>`
                            ).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // AGREGAR AL DOM
            const container = document.createElement('div');
            container.innerHTML = toastHTML;
            document.body.appendChild(container.firstElementChild);
            
            // AUTO-REMOVER DESPUÉS DE LA DURACIÓN
            setTimeout(() => {
                const toast = document.getElementById(toastId);
                if (toast) toast.remove();
            }, config.duration || 5000);
        }

        function closeIPModal() {
            document.getElementById('ipManagementModal').classList.remove('active');
            resetIPForm();
            AppState.currentEditingIP = null;
            AppState.currentAssetForIP = null;
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            AppState.currentEditingCategory = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#categoryForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        async function saveCategory() {
            try {
                // Validar formulario
                if (!validateCategoryForm()) {
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando categoría...');
                
                // Obtener datos del formulario
                const formData = {
                    nombre: document.getElementById('categoryName').value.trim(),
                    descripcion: document.getElementById('categoryDescription').value.trim() || null,
                    fecha_actualizacion: new Date().toISOString()
                };
                
                let result;
                
                if (AppState.currentEditingCategory) {
                    // Actualizar categoría existente
                    const { data, error } = await supabase
                        .from('categoria_activo')
                        .update(formData)
                        .eq('id', AppState.currentEditingCategory.id)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nueva categoría
                    formData.fecha_creacion = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('categoria_activo')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadCategories();
                
                closeCategoryModal();
                showLoadingOverlay(false);
                showToast(`Categoría ${AppState.currentEditingCategory ? 'actualizada' : 'creada'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error guardando categoría:', error);
                showToast('Error al guardar la categoría: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        function validateCategoryForm() {
            let isValid = true;
            
            // Validar nombre
            const name = document.getElementById('categoryName').value.trim();
            const nameError = document.getElementById('categoryNameError');
            if (!name) {
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            return isValid;
        }

        async function deleteCategory(categoryId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta categoría? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Eliminando categoría...');
                
                const { error } = await supabase
                    .from('categoria_activo')
                    .delete()
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadCategories();
                
                showLoadingOverlay(false);
                showToast('Categoría eliminada correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando categoría:', error);
                showToast('Error al eliminar la categoría: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // ===== GESTIÓN DE TIPOS =====
        function openTypeModal(typeId = null) {
            const modal = document.getElementById('typeModal');
            const title = document.getElementById('typeModalTitle');
            
            if (typeId) {
                // Modo edición
                const type = AppState.types.find(t => t.id === typeId);
                if (type) {
                    AppState.currentEditingType = type;
                    title.textContent = 'Editar Tipo';
                    
                    // Llenar formulario
                    document.getElementById('typeName').value = type.nombre;
                    document.getElementById('typeCategory').value = type.categoria_activo_id;
                    document.getElementById('typeDescription').value = type.descripcion || '';
                }
            } else {
                // Modo creación
                AppState.currentEditingType = null;
                title.textContent = 'Nuevo Tipo';
                
                // Limpiar formulario
                document.getElementById('typeForm').reset();
            }
            
            modal.classList.add('active');
        }

        function closeTypeModal() {
            document.getElementById('typeModal').classList.remove('active');
            AppState.currentEditingType = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#typeForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        async function saveType() {
            try {
                // Validar formulario
                if (!validateTypeForm()) {
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando tipo...');
                
                // Obtener datos del formulario
                const formData = {
                    nombre: document.getElementById('typeName').value.trim(),
                    categoria_activo_id: document.getElementById('typeCategory').value,
                    descripcion: document.getElementById('typeDescription').value.trim() || null,
                    fecha_actualizacion: new Date().toISOString()
                };
                
                let result;
                
                if (AppState.currentEditingType) {
                    // Actualizar tipo existente
                    const { data, error } = await supabase
                        .from('tipo_activo')
                        .update(formData)
                        .eq('id', AppState.currentEditingType.id)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nuevo tipo
                    formData.fecha_creacion = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('tipo_activo')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadTypes();
                
                closeTypeModal();
                showLoadingOverlay(false);
                showToast(`Tipo ${AppState.currentEditingType ? 'actualizado' : 'creado'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error guardando tipo:', error);
                showToast('Error al guardar el tipo: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        function validateTypeForm() {
            let isValid = true;
            
            // Validar nombre
            const name = document.getElementById('typeName').value.trim();
            const nameError = document.getElementById('typeNameError');
            if (!name) {
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            // Validar categoría
            const category = document.getElementById('typeCategory').value;
            const categoryError = document.getElementById('typeCategoryError');
            if (!category) {
                categoryError.classList.add('show');
                isValid = false;
            } else {
                categoryError.classList.remove('show');
            }
            
            return isValid;
        }

        async function deleteType(typeId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este tipo? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Eliminando tipo...');
                
                const { error } = await supabase
                    .from('tipo_activo')
                    .delete()
                    .eq('id', typeId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadTypes();
                
                showLoadingOverlay(false);
                showToast('Tipo eliminado correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando tipo:', error);
                showToast('Error al eliminar el tipo: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // ===== GESTIÓN DE UBICACIONES =====
        function openLocationModal(locationId = null) {
            const modal = document.getElementById('locationModal');
            const title = document.getElementById('locationModalTitle');
            
            if (locationId) {
                // Modo edición
                const location = AppState.locations.find(l => l.id_ubicacion === locationId);
                if (location) {
                    AppState.currentEditingLocation = location;
                    title.textContent = 'Editar Ubicación';
                    
                    // Llenar formulario
                    document.getElementById('locationName').value = location.nombre;
                    document.getElementById('locationType').value = location.tipo;
                    document.getElementById('locationFloor').value = location.piso || '';
                    document.getElementById('locationParent').value = location.id_ubicacion_padre || '';
                    document.getElementById('locationAddress').value = location.direccion || '';
                    document.getElementById('locationDescription').value = location.descripcion || '';
                    
                    // ✅ CAMBIO: Usar campo 'activo' en lugar de 'estado'
                    document.getElementById('locationStatus').value = location.activo ? 'true' : 'false';
                }
            } else {
                // Modo creación
                AppState.currentEditingLocation = null;
                title.textContent = 'Nueva Ubicación';
                
                // Limpiar formulario
                document.getElementById('locationForm').reset();
                
                // ✅ CAMBIO: Por defecto activo = true
                document.getElementById('locationStatus').value = 'true';
            }
            
            modal.classList.add('active');
        }

        function closeLocationModal() {
            document.getElementById('locationModal').classList.remove('active');
            AppState.currentEditingLocation = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#locationForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        // Función para obtener la fecha actual en zona horaria de Perú (UTC-5)
        function getCurrentDatePeru() {
            const now = new Date();
            
            // Perú está en UTC-5, pero durante horario de verano puede ser UTC-4
            // Usamos toLocaleString para obtener la fecha en la zona horaria local del servidor/cliente
            // Pero para consistencia, mejor usar UTC-5 específicamente
            
            // Opción 1: Ajustar manualmente a UTC-5
            const offsetPeru = -5 * 60; // UTC-5 en minutos
            const localTime = now.getTime();
            const localOffset = now.getTimezoneOffset() * 60000;
            const utcTime = localTime + localOffset;
            const peruTime = utcTime + (offsetPeru * 60000);
            
            return new Date(peruTime).toISOString();
        }

        // Función alternativa más robusta
        function getCurrentDatePeruISO() {
            const now = new Date();
            
            // Crear fecha en formato ISO para Perú (UTC-5)
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, '0');
            const day = String(now.getUTCDate()).padStart(2, '0');
            const hours = String(now.getUTCHours() - 5).padStart(2, '0'); // UTC-5
            const minutes = String(now.getUTCMinutes()).padStart(2, '0');
            const seconds = String(now.getUTCSeconds()).padStart(2, '0');
            
            // Ajustar si las horas son negativas (cambio de día)
            let adjustedHours = parseInt(hours);
            let adjustedDay = parseInt(day);
            let adjustedMonth = parseInt(month);
            let adjustedYear = year;
            
            if (adjustedHours < 0) {
                adjustedHours += 24;
                adjustedDay -= 1;
                
                if (adjustedDay < 1) {
                    adjustedMonth -= 1;
                    if (adjustedMonth < 1) {
                        adjustedMonth = 12;
                        adjustedYear -= 1;
                    }
                    // Obtener último día del mes anterior
                    adjustedDay = new Date(adjustedYear, adjustedMonth, 0).getDate();
                }
            }
            
            return `${adjustedYear}-${String(adjustedMonth).padStart(2, '0')}-${String(adjustedDay).padStart(2, '0')}T${String(adjustedHours).padStart(2, '0')}:${minutes}:${seconds}.000Z`;
        }

        // Función mejorada para obtener fecha/hora Perú
        function getPeruDateTime() {
            const now = new Date();
            
            // Obtener componentes de fecha local
            const localYear = now.getFullYear();
            const localMonth = now.getMonth();
            const localDate = now.getDate();
            const localHours = now.getHours();
            const localMinutes = now.getMinutes();
            const localSeconds = now.getSeconds();
            
            // Crear nueva fecha con componentes locales pero forzando zona horaria
            // Esto asegura que se guarde como la hora local visualizada
            const peruDate = new Date(Date.UTC(
                localYear,
                localMonth,
                localDate,
                localHours,
                localMinutes,
                localSeconds
            ));
            
            return peruDate.toISOString();
        }

        // Alternativa: Usar formato de fecha simple sin información de zona horaria
        function getPeruDateTimeSimple() {
            const now = new Date();
            
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            // Formato: YYYY-MM-DD HH:MM:SS (sin información de zona horaria)
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Para Supabase, es mejor usar ISO string pero ajustado
        function getPeruDateTimeForSupabase() {
            const now = new Date();
            
            // Crear string en formato ISO pero con offset explícito
            const timezoneOffset = -5; // Perú UTC-5
            const offsetHours = Math.abs(timezoneOffset).toString().padStart(2, '0');
            const offsetSign = timezoneOffset >= 0 ? '+' : '-';
            
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${offsetSign}${offsetHours}:00`;
        }

        async function saveLocation() {
            try {
                // Validar formulario
                if (!validateLocationForm()) {
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando ubicación...');
                
                // Obtener datos del formulario
                const formData = {
                    nombre: document.getElementById('locationName').value.trim(),
                    tipo: document.getElementById('locationType').value,
                    piso: document.getElementById('locationFloor').value.trim() || null,
                    id_ubicacion_padre: document.getElementById('locationParent').value || null,
                    direccion: document.getElementById('locationAddress').value.trim() || null,
                    descripcion: document.getElementById('locationDescription').value.trim() || null,
                    activo: document.getElementById('locationStatus').value === 'true'
                };
                
                let result;
                
                if (AppState.currentEditingLocation) {
                    // Actualizar ubicación existente
                    const { data, error } = await supabase
                        .from('ubicacion')
                        .update(formData)
                        .eq('id_ubicacion', AppState.currentEditingLocation.id_ubicacion)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nueva ubicación - ✅ CORREGIDO: Usar fecha Perú
                    formData.fecha_creacion = getPeruDateTime();
                    
                    console.log('🕐 Fecha de creación (Perú):', formData.fecha_creacion);
                    
                    const { data, error } = await supabase
                        .from('ubicacion')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadLocations();
                
                closeLocationModal();
                showLoadingOverlay(false);
                showToast(`Ubicación ${AppState.currentEditingLocation ? 'actualizada' : 'creada'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error guardando ubicación:', error);
                showToast('Error al guardar la ubicación: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        function validateLocationForm() {
            let isValid = true;
            
            // Validar nombre
            const name = document.getElementById('locationName').value.trim();
            const nameError = document.getElementById('locationNameError');
            if (!name) {
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            // Validar tipo
            const type = document.getElementById('locationType').value;
            const typeError = document.getElementById('locationTypeError');
            if (!type) {
                typeError.classList.add('show');
                isValid = false;
            } else {
                typeError.classList.remove('show');
            }
            
            return isValid;
        }

        async function deleteLocation(locationId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta ubicación? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Eliminando ubicación...');
                
                const { error } = await supabase
                    .from('ubicacion')
                    .delete()
                    .eq('id_ubicacion', locationId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadLocations();
                
                showLoadingOverlay(false);
                showToast('Ubicación eliminada correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando ubicación:', error);
                showToast('Error al eliminar la ubicación: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // ===== GESTIÓN DE MANTENIMIENTOS =====
        function openMaintenanceModal(maintenanceId = null, assetId = null) {
            const modal = document.getElementById('maintenanceModal');
            const title = document.getElementById('maintenanceModalTitle');
            
            if (maintenanceId) {
                // Modo edición
                const maintenance = AppState.maintenance.find(m => m.id === maintenanceId);
                if (maintenance) {
                    AppState.currentEditingMaintenance = maintenance;
                    title.textContent = 'Editar Mantenimiento';
                    
                    // Llenar formulario
                    document.getElementById('maintenanceAsset').value = maintenance.activo_id;
                    document.getElementById('maintenanceType').value = maintenance.tipo;
                    document.getElementById('maintenanceDescription').value = maintenance.descripcion || '';
                    document.getElementById('maintenanceStartDate').value = maintenance.fecha_inicio;
                    document.getElementById('maintenanceEndDate').value = maintenance.fecha_fin || '';
                    document.getElementById('maintenanceObservations').value = maintenance.observaciones || '';
                }
            } else {
                // Modo creación
                AppState.currentEditingMaintenance = null;
                title.textContent = 'Nuevo Mantenimiento';
                
                // Limpiar formulario
                document.getElementById('maintenanceForm').reset();
                
                // Si se especificó un assetId, establecerlo
                if (assetId) {
                    document.getElementById('maintenanceAsset').value = assetId;
                }
                
                // Establecer fecha de inicio como hoy
                document.getElementById('maintenanceStartDate').value = new Date().toISOString().split('T')[0];
            }
            
            // Actualizar selects
            updateMaintenanceAssetSelects();
            
            modal.classList.add('active');
        }

        function openMaintenanceModalForAsset(assetId) {
            openMaintenanceModal(null, assetId);
        }

        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.remove('active');
            AppState.currentEditingMaintenance = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#maintenanceForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        async function saveMaintenance() {
            try {
                // Validar formulario
                if (!validateMaintenanceForm()) {
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando mantenimiento...');
                
                // Obtener datos del formulario
                const formData = {
                    activo_id: document.getElementById('maintenanceAsset').value,
                    tipo: document.getElementById('maintenanceType').value,
                    descripcion: document.getElementById('maintenanceDescription').value.trim(),
                    fecha_inicio: document.getElementById('maintenanceStartDate').value,
                    fecha_fin: document.getElementById('maintenanceEndDate').value || null,
                    observaciones: document.getElementById('maintenanceObservations').value.trim() || null
                };
                
                let result;
                
                if (AppState.currentEditingMaintenance) {
                    // Actualizar mantenimiento existente
                    const { data, error } = await supabase
                        .from('mantenimientos')
                        .update(formData)
                        .eq('id', AppState.currentEditingMaintenance.id)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nuevo mantenimiento
                    const { data, error } = await supabase
                        .from('mantenimientos')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadMaintenance();
                
                closeMaintenanceModal();
                showLoadingOverlay(false);
                showToast(`Mantenimiento ${AppState.currentEditingMaintenance ? 'actualizado' : 'creado'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error guardando mantenimiento:', error);
                showToast('Error al guardar el mantenimiento: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        function validateMaintenanceForm() {
            let isValid = true;
            
            // Validar activo
            const asset = document.getElementById('maintenanceAsset').value;
            const assetError = document.getElementById('maintenanceAssetError');
            if (!asset) {
                assetError.classList.add('show');
                isValid = false;
            } else {
                assetError.classList.remove('show');
            }
            
            // Validar tipo
            const type = document.getElementById('maintenanceType').value;
            const typeError = document.getElementById('maintenanceTypeError');
            if (!type) {
                typeError.classList.add('show');
                isValid = false;
            } else {
                typeError.classList.remove('show');
            }
            
            // Validar descripción
            const description = document.getElementById('maintenanceDescription').value.trim();
            const descriptionError = document.getElementById('maintenanceDescriptionError');
            if (!description) {
                descriptionError.classList.add('show');
                isValid = false;
            } else {
                descriptionError.classList.remove('show');
            }
            
            // Validar fecha de inicio
            const startDate = document.getElementById('maintenanceStartDate').value;
            const startDateError = document.getElementById('maintenanceStartDateError');
            if (!startDate) {
                startDateError.classList.add('show');
                isValid = false;
            } else {
                startDateError.classList.remove('show');
            }
            
            return isValid;
        }

        async function deleteMaintenance(maintenanceId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este mantenimiento? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Eliminando mantenimiento...');
                
                const { error } = await supabase
                    .from('mantenimientos')
                    .delete()
                    .eq('id', maintenanceId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadMaintenance();
                
                showLoadingOverlay(false);
                showToast('Mantenimiento eliminado correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando mantenimiento:', error);
                showToast('Error al eliminar el mantenimiento: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // ===== GESTIÓN DE MARCAS =====
        function openBrandModal(brandId = null) {
            const modal = document.getElementById('brandModal');
            const title = document.getElementById('brandModalTitle');
            
            if (brandId) {
                // Modo edición
                const brand = AppState.brands.find(b => b.id === brandId);
                if (brand) {
                    AppState.currentEditingBrand = brand;
                    title.textContent = 'Editar Marca';
                    
                    // Llenar formulario
                    document.getElementById('brandName').value = brand.nombre;
                    document.getElementById('brandDescription').value = brand.descripcion || '';
                    // CAMBIADO: estado → activo
                    document.getElementById('brandActive').checked = brand.activo !== false; // Default true
                }
            } else {
                // Modo creación
                AppState.currentEditingBrand = null;
                title.textContent = 'Nueva Marca';
                
                // Limpiar formulario
                document.getElementById('brandForm').reset();
                // CAMBIADO: estado → activo (checked por defecto)
                document.getElementById('brandActive').checked = true;
            }
            
            modal.classList.add('active');
        }

        function closeBrandModal() {
            document.getElementById('brandModal').classList.remove('active');
            AppState.currentEditingBrand = null;
            
            // Limpiar errores de validación
            document.querySelectorAll('#brandForm .error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        async function saveBrand() {
            try {
                // Validar formulario
                if (!validateBrandForm()) {
                    return;
                }
                
                showLoadingOverlay(true, 'Guardando marca...');
                
                // Obtener datos del formulario
                const formData = {
                    nombre: document.getElementById('brandName').value.trim(),
                    descripcion: document.getElementById('brandDescription').value.trim() || null,
                    // CAMBIADO: estado → activo (booleano)
                    activo: document.getElementById('brandActive').checked,
                    fecha_actualizacion: new Date().toISOString()
                };
                
                let result;
                
                if (AppState.currentEditingBrand) {
                    // Actualizar marca existente
                    const { data, error } = await supabase
                        .from('marcas')
                        .update(formData)
                        .eq('id', AppState.currentEditingBrand.id)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                } else {
                    // Crear nueva marca
                    formData.fecha_creacion = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('marcas')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                }
                
                // Recargar datos
                await loadBrands();
                
                closeBrandModal();
                showLoadingOverlay(false);
                showToast(`Marca ${AppState.currentEditingBrand ? 'actualizada' : 'creada'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error guardando marca:', error);
                showToast('Error al guardar la marca: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        function validateBrandForm() {
            let isValid = true;
            
            // Validar nombre
            const name = document.getElementById('brandName').value.trim();
            const nameError = document.getElementById('brandNameError');
            if (!name) {
                nameError.classList.add('show');
                isValid = false;
            } else {
                nameError.classList.remove('show');
            }
            
            return isValid;
        }

        async function toggleBrandStatus(brandId) {
            const brand = AppState.brands.find(b => b.id === brandId);
            if (!brand) return;
            
            const newStatus = !brand.activo; // CAMBIADO: estado → activo
            const action = newStatus ? 'activar' : 'desactivar';
            
            if (!confirm(`¿Estás seguro de que deseas ${action} esta marca?`)) {
                return;
            }
            
            try {
                showLoadingOverlay(true, `${newStatus ? 'Activando' : 'Desactivando'} marca...`);
                
                const { error } = await supabase
                    .from('marcas')
                    .update({ 
                        // CAMBIADO: estado → activo
                        activo: newStatus,
                        fecha_actualizacion: new Date().toISOString()
                    })
                    .eq('id', brandId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadBrands();
                
                showLoadingOverlay(false);
                showToast(`Marca ${newStatus ? 'activada' : 'desactivada'} correctamente`, 'success');
                
            } catch (error) {
                console.error('Error cambiando estado de marca:', error);
                showToast('Error al cambiar el estado de la marca: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        async function deleteBrand(brandId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta marca? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoadingOverlay(true, 'Eliminando marca...');
                
                const { error } = await supabase
                    .from('marcas')
                    .delete()
                    .eq('id', brandId);
                
                if (error) throw error;
                
                // Recargar datos
                await loadBrands();
                
                showLoadingOverlay(false);
                showToast('Marca eliminada correctamente', 'success');
                
            } catch (error) {
                console.error('Error eliminando marca:', error);
                showToast('Error al eliminar la marca: ' + error.message, 'error');
                showLoadingOverlay(false);
            }
        }

        // ===== FUNCIONES DE UTILIDAD =====
        // Función para obtener el ID de un estado por su nombre
        function getStatusIdByName(statusName) {
            const status = AppState.statuses.find(s => 
                s.nombre.toLowerCase() === statusName.toLowerCase()
            );
            return status ? status.id : null;
        }

        // Función para obtener estados comunes por ID
        function getCommonStatusIds() {
            return {
                OPERATIVO: getStatusIdByName('OPERATIVO') || 1,
                EN_MANTENIMIENTO: getStatusIdByName('EN MANTENIMIENTO') || 3,
                EN_REPARACION_EXTERNA: getStatusIdByName('EN REPARACION EXTERNA') || 4,
                EN_ALMACEN: getStatusIdByName('EN ALMACEN') || 13,
                DADO_DE_BAJA: getStatusIdByName('DADO DE BAJA') || 10
            };
        } 
 
        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            showToast(`Modo ${AppState.darkMode ? 'oscuro' : 'claro'} activado`, 'success');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error al activar pantalla completa:', err);
                    showToast('No se pudo activar el modo pantalla completa', 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const isActive = dropdown.classList.toggle('active');
            document.getElementById('userAvatar').setAttribute('aria-expanded', isActive);
        }

        function getStatusText(status) {
            const statusMap = {
                'operativo': 'Operativo',
                'en reparación': 'En Reparación',
                'en almacén': 'En Almacén',
                'dado de baja': 'Dado de Baja'
            };
            return statusMap[status] || status;
        }

        function getStatusDescription(status) {
            const descriptions = {
                'operativo': 'El activo está en funcionamiento y disponible para su uso.',
                'en reparación': 'El activo está siendo reparado o en proceso de mantenimiento.',
                'en almacén': 'El activo está almacenado y disponible para futura asignación.',
                'dado de baja': 'Este activo ha sido dado de baja y ya no está en uso.'
            };
            return descriptions[status] || 'Estado no disponible.';
        }

        function showLoadingOverlay(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            const toastConfig = {
                success: { icon: 'check-circle', color: 'toast' },
                error: { icon: 'exclamation-circle', color: 'toast-error' },
                warning: { icon: 'exclamation-triangle', color: 'toast-warning' },
                info: { icon: 'info-circle', color: 'toast-info' }
            };
            
            const config = toastConfig[type] || toastConfig.success;
            toastIcon.className = `fas fa-${config.icon} toast-icon`;
            toast.classList.add(config.color);
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== MANEJO DE ERRORES =====
        window.addEventListener('error', function(e) {
            console.error('❌ Error no capturado:', e.error);
            showToast('Error inesperado en la aplicación', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Promesa rechazada no capturada:', e.reason);
            showToast('Error en operación asíncrona', 'error');
            e.preventDefault();
        });

        console.log('✅ Sistema de Activos TI para Administradores completamente inicializado');
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallos Mármol</title>
    <meta name="description" content="Sistema que organiza y gestiona solicitudes de soporte mediante tickets, facilitando el seguimiento y la atención eficiente de incidencias.">
    <meta name="keywords" content="gallos mármol, soporte, TI, soluciones, incidencias">
    <meta name="author" content="Gallos Mármol">
    <link rel="icon" href="FOTO/ICONO/Icono_01.ico">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, getDocs, Timestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAT9LPhRgnQqUTkgm6aEpwnaegy0ZMOmjc",
            authDomain: "sistema-de-tickets-a25bc.firebaseapp.com",
            projectId: "sistema-de-tickets-a25bc",
            storageBucket: "sistema-de-tickets-a25bc.firebasestorage.app",
            messagingSenderId: "1059077905328",
            appId: "1:1059077905328:web:e9680127f6516b672ed475"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // Hacer disponibles globalmente
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.provider = provider;
        window.firebaseFunctions = {
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, getDocs, Timestamp, limit,
            signInWithPopup, signOut, onAuthStateChanged
        };
    </script>
    
    <style>
        :root {
            --primary-color: #CB3E2C;
            --secondary-color: #121212;
            --light-color: #FFFFFF;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #1a1a1a;
            --text-color: #333;
            --text-light: #fff;
            --bg-color: #f8f9fa;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
            --border-radius: 10px;
            --header-height: 70px;
            --mobile-header-height: 60px;
        }

        .dark-mode {
            --primary-color: #CB3E2C;
            --secondary-color: #1a1a1a;
            --light-color: #2c2c2c;
            --success-color: #27ae60;
            --warning-color: #d68910;
            --danger-color: #cb4335;
            --dark-color: #121212;
            --text-color: #e0e0e0;
            --text-light: #f0f0f0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER - Mobile First */
        header {
            background-color: var(--secondary-color);
            color: var(--text-light);
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--mobile-header-height);
            min-height: var(--mobile-header-height);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            max-width: 60%;
        }

        .logo-img {
            height: 50px;
            width: auto;
            border-radius: 6px;
            object-fit: contain;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .user-info {
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--secondary-color);
            width: 100%;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 99;
        }

        .user-info.active {
            display: flex;
        }

        .user-role {
            background-color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            white-space: nowrap;
            font-weight: 500;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            width: 100%;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
            width: auto;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
        }

        /* VIEW CONTROLS - Primero en móvil */
        .view-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
        }

        .view-controls-top {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .view-controls-bottom {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            height: fit-content;
            border: 1px solid var(--border-color);
            order: 2;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .filters {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            order: 1;
        }

        .filters.active {
            display: flex;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-color);
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            width: 100%;
            font-size: 0.85rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(203, 62, 44, 0.1);
        }

        .board {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            order: 3;
        }

        .column {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .column-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .ticket-count {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            min-width: 25px;
            text-align: center;
            font-weight: 600;
        }

        .ticket-list {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            padding-right: 5px;
        }

        .ticket-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: var(--transition);
            cursor: grab;
            border-left: 4px solid var(--primary-color);
            position: relative;
            border: 1px solid var(--border-color);
        }

        .ticket-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .ticket-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .ticket-priority-alta {
            border-left-color: var(--danger-color);
        }

        .ticket-priority-media {
            border-left-color: var(--warning-color);
        }

        .ticket-priority-baja {
            border-left-color: var(--success-color);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 8px;
        }

        .ticket-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            word-break: break-word;
            color: var(--text-color);
            flex: 1;
        }

        .ticket-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.75rem;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Vista de tabla solo para escritorio */
        .table-container {
            display: none;
            width: 100%;
            overflow-x: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .table-view {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .table-view th, .table-view td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
        }

        .table-view th {
            background-color: var(--secondary-color);
            color: var(--text-light);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table-view tr:hover {
            background-color: rgba(203, 62, 44, 0.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 1;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-color);
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row .form-group {
            width: 100%;
        }

        .observations {
            background-color: var(--light-color);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .observation-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            position: relative;
        }

        .observation-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .observation-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            background-color: var(--success-color);
            color: white;
            border-radius: 4px;
            box-shadow: var(--shadow);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 90%;
            word-break: break-word;
            font-size: 0.9rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast-warning {
            background-color: var(--warning-color);
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 5px;
        }

        .export-options {
            display: none;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            width: 100%;
            justify-content: center;
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .confirmation-modal {
            text-align: center;
        }

        .confirmation-modal .modal-body {
            padding: 20px 15px;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 15px;
        }

        .login-card {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 350px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-card h2 {
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: 1.5rem;
        }

        .login-card p {
            margin-bottom: 20px;
            color: #666;
            font-size: 0.95rem;
        }

        .login-btn {
            background: linear-gradient(to right, var(--primary-color), #e74c3c);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(203, 62, 44, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(203, 62, 44, 0.4);
        }

        .status-select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .read-only {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .drag-over {
            background-color: rgba(203, 62, 44, 0.1);
            border: 2px dashed var(--primary-color);
        }

        .mobile-menu {
            display: block;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.4rem;
            cursor: pointer;
        }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            order: 4;
        }

        .pagination-btn {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.8rem;
            color: var(--text-color);
        }

        /* Búsqueda avanzada */
        .advanced-search {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .advanced-search.active {
            display: block;
        }

        .search-toggle {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-weight: 500;
            width: 100%;
            justify-content: center;
            padding: 8px;
        }

        /* Métricas del dashboard */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .metric-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 8px 0;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Indicadores de estado */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-pendiente { background-color: #e74c3c; }
        .status-progreso { background-color: #f39c12; }
        .status-resuelto { background-color: #2ecc71; }
        .status-archivado { background-color: #95a5a6; }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Estado de carga específico */
        .loading-section {
            position: relative;
            min-height: 100px;
        }

        .loading-section::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: var(--border-radius);
        }

        .loading-section.loading::after {
            content: "Cargando...";
            color: var(--primary-color);
            font-weight: bold;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Botón flotante para móvil */
        .floating-action-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 99;
            cursor: pointer;
            transition: var(--transition);
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
        }

        /* Filtros móviles */
        .mobile-filters-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* RESPONSIVE - Tablet */
        @media (min-width: 768px) {
            header {
                padding: 0 1.5rem;
                height: var(--header-height);
            }
            
            .logo {
                font-size: 1.3rem;
                max-width: none;
            }
                        
            .user-info {
                position: static;
                flex-direction: row;
                width: auto;
                padding: 0;
                box-shadow: none;
                display: flex;
                background: none;
            }
            
            .btn {
                width: auto;
                padding: 10px 18px;
            }
            
            .container {
                padding: 20px;
            }
            
            .view-controls {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .view-controls-top, .view-controls-bottom {
                flex: 1;
            }
            
            .view-controls-bottom {
                justify-content: flex-end;
            }
            
            .view-btn {
                min-width: 140px;
            }
            
            .dashboard {
                flex-direction: row;
            }
            
            .stats-card {
                flex: 1;
                order: 1;
            }
            
            .filters {
                display: flex;
                flex: 2;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .filter-group {
                flex: 1;
                min-width: 150px;
            }
            
            .board {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .metrics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
            }
            
            .mobile-menu {
                display: none;
            }
            
            .floating-action-btn {
                display: none;
            }
        }

        /* RESPONSIVE - Desktop */
        @media (min-width: 992px) {
            .board {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .table-container {
                display: block;
            }
            
            .dashboard {
                grid-template-columns: 3fr;
                display: grid;
            }
            
            .stats-card {
                order: 1;
            }
            
            .filters {
                order: 2;
            }
            
            .view-controls {
                order: 3;
            }
            
            .board, .table-container {
                order: 4;
            }
            
            .pagination {
                order: 5;
            }
            
            .modal-content {
                max-width: 700px;
            }
        }

        /* RESPONSIVE - Pantallas grandes */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
            }
            
            .stats-grid {
                gap: 15px;
            }
            
            .stat-item {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.75rem;
            }
        }

        /* Scroll suave para móvil */
        @media (max-width: 767px) {
            html {
                scroll-behavior: smooth;
            }
            
            .ticket-list {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <h2>Sistema de Tickets de Soporte</h2>
            <p>Inicia sesión con tu cuenta de Google autorizada por Gallos Mármol</p>
            <button class="login-btn" id="loginBtn">
                <i class="fab fa-google"></i> Iniciar sesión con Google
            </button>
            <p id="loginError" style="color: var(--danger-color); margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <!-- Aplicación principal (oculta inicialmente) -->
    <div id="app" style="display: none;">
        <header>
            <button class="mobile-menu" id="mobileMenu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <img src="FOTO/LOGO/Logo_01.webp" alt="Logo Empresa" class="logo-img">
            </div>
            <div class="user-info" id="userInfo">
                <span id="userName">Usuario</span>
                <span class="user-role" id="userRole">Usuario</span>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </header>

        <div class="container">
            <!-- View Controls - Primero en móvil -->
            <div class="view-controls">
                <div class="view-controls-top">
                    <button class="view-btn active" id="kanbanViewBtn">
                        <i class="fas fa-th-large"></i> <span class="btn-text">Kanban</span>
                    </button>
                    <button class="view-btn" id="tableViewBtn">
                        <i class="fas fa-table"></i> <span class="btn-text">Tabla</span>
                    </button>
                    <button class="btn btn-primary" id="newTicketBtn">
                        <i class="fas fa-plus"></i> <span class="btn-text">Nuevo</span>
                    </button>
                </div>
                <div class="view-controls-bottom">
                    <button class="btn btn-success" id="exportBtn">
                        <i class="fas fa-file-export"></i> <span class="btn-text">Exportar</span>
                    </button>
                    <button class="btn btn-secondary" id="fullscreenBtn">
                        <i class="fas fa-expand"></i> <span class="btn-text">Pantalla Completa</span>
                    </button>
                    <button class="mobile-filters-btn" id="mobileFiltersBtn">
                        <i class="fas fa-filter"></i> Filtros
                    </button>
                </div>
                <div class="export-options" id="exportOptions">
                    <button class="btn btn-success" id="exportPDF">
                        <i class="fas fa-file-pdf"></i> <span class="btn-text">Exportar PDF</span>
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters" id="filters">
                <div class="filter-group">
                    <label for="searchTickets">Buscar</label>
                    <input type="text" id="searchTickets" placeholder="Buscar en tickets...">
                </div>
                <div class="filter-group">
                    <label for="filterStatus">Estado</label>
                    <select id="filterStatus">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Resuelto">Resuelto</option>
                        <option value="Archivado">Archivado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterPriority">Prioridad</label>
                    <select id="filterPriority">
                        <option value="">Todas</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterCategory">Categoría</label>
                    <select id="filterCategory">
                        <option value="">Todas</option>
                        <!-- Las opciones se llenarán dinámicamente -->
                    </select>
                </div>
            </div>

            <!-- Búsqueda avanzada -->
            <div class="advanced-search" id="advancedSearch">
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchTitle">Título</label>
                        <input type="text" id="searchTitle" placeholder="Buscar por título...">
                    </div>
                    <div class="form-group">
                        <label for="searchDescription">Descripción</label>
                        <input type="text" id="searchDescription" placeholder="Buscar en descripción...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchDateFrom">Creado desde</label>
                        <input type="date" id="searchDateFrom">
                    </div>
                    <div class="form-group">
                        <label for="searchDateTo">Creado hasta</label>
                        <input type="date" id="searchDateTo">
                    </div>
                </div>
                <button class="btn btn-primary" id="applyAdvancedSearch">Aplicar Filtros</button>
            </div>
            
            <button class="search-toggle" id="toggleAdvancedSearch">
                <i class="fas fa-search-plus"></i> Búsqueda Avanzada
            </button>

            <div class="dashboard">
                <div class="stats-card">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalTickets">0</div>
                            <div>Total Tickets</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="openTickets">0</div>
                            <div>Abiertos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="resolvedTickets">0</div>
                            <div>Resueltos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="myTickets">0</div>
                            <div>Mis Tickets</div>
                        </div>
                    </div>
                    
                    <!-- Métricas adicionales -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="highPriorityTickets">0</div>
                            <div class="metric-label">Alta Prioridad</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="assignedTickets">0</div>
                            <div class="metric-label">Asignados a Mí</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgResolutionTime">0d</div>
                            <div class="metric-label">Tiempo Resolución Prom.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="ticketsThisMonth">0</div>
                            <div class="metric-label">Este Mes</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="ticketsChart"></canvas>
                    </div>
                </div>
                
                <div>
                    <!-- Vista Kanban -->
                    <div class="board" id="kanbanView">
                        <!-- Las columnas se generarán dinámicamente -->
                    </div>
                    
                    <!-- Vista Tabla (solo escritorio) -->
                    <div id="tableView" style="display: none;">
                        <div class="table-container">
                            <table class="table-view">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Estado</th>
                                        <th>Prioridad</th>
                                        <th>Categoría</th>
                                        <th>Creado por</th>
                                        <th>Asignado a</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Los datos se llenarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Paginación -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="pagination-btn" id="firstPage">Primera</button>
                        <button class="pagination-btn" id="prevPage">Anterior</button>
                        <span class="pagination-info" id="pageInfo">Página 1 de 1</span>
                        <button class="pagination-btn" id="nextPage">Siguiente</button>
                        <button class="pagination-btn" id="lastPage">Última</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón flotante para móvil -->
        <button class="floating-action-btn" id="floatingActionBtn">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modal para crear/editar tickets -->
    <div class="modal" id="ticketModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nuevo Ticket</h3>
                <button class="btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <div class="form-group">
                        <label for="ticketTitle">Título del Ticket *</label>
                        <input type="text" id="ticketTitle" placeholder="Ingrese un título descriptivo" required>
                    </div>
                    <div class="form-group">
                        <label for="ticketDescription">Descripción *</label>
                        <textarea id="ticketDescription" rows="4" placeholder="Describa el problema o solicitud en detalle" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ticketPriority">Prioridad *</label>
                            <select id="ticketPriority" required>
                                <option value="">Seleccione una prioridad</option>
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ticketCategory">Categoría *</label>
                            <select id="ticketCategory" required>
                                <option value="">Seleccione una categoría</option>
                                <!-- Las opciones se llenarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ticketAssignedTo">Asignar a *</label>
                        <select id="ticketAssignedTo" required>
                            <option value="">Seleccione un usuario</option>
                            <!-- Las opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group" id="ticketStatusGroup" style="display: none;">
                        <label for="ticketStatus">Estado del Ticket</label>
                        <select id="ticketStatus">
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Resuelto">Resuelto</option>
                            <option value="Archivado">Archivado</option>
                        </select>
                    </div>
                    
                    <!-- Sección de observaciones -->
                    <div id="observationsSection">
                        <div class="observations" id="observationsList">
                            <!-- Las observaciones se cargarán aquí -->
                        </div>
                        <!-- Campo para agregar observaciones (solo para admin/support) -->
                        <div id="addObservationSection" style="display: none;">
                            <div class="form-group">
                                <label for="ticketObservation">Agregar Observación</label>
                                <textarea id="ticketObservation" rows="3" placeholder="Describa lo que se hizo para resolver el ticket o alguna observación importante"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="ticketId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveTicketBtn">Guardar Ticket</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal confirmation-modal" id="confirmationModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-body">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 15px;"></i>
                <h3 id="confirmationTitle">Confirmar acción</h3>
                <p id="confirmationMessage">¿Está seguro de que desea realizar esta acción?</p>
                <div class="confirmation-buttons">
                    <button class="btn" id="confirmCancel">Cancelar</button>
                    <button class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operación completada con éxito</span>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script>
        // Variables globales optimizadas
        const AppState = {
            currentUser: null,
            tickets: [],
            users: [],
            categories: ['Soporte Técnico', 'Facturación', 'Ventas', 'Recursos Humanos', 'Desarrollo', 'Infraestructura'],
            darkMode: localStorage.getItem('darkMode') === 'true',
            pendingAction: null,
            currentView: 'kanban',
            userRole: 'user',
            currentUserData: null,
            editingObservationIndex: -1,
            cache: {
                tickets: null,
                users: null,
                lastUpdate: null,
                cacheDuration: 10 * 60 * 1000 // 10 minutos
            },
            // Configuración de paginación optimizada
            pagination: {
                currentPage: 1,
                itemsPerPage: 8, // Reducido para móvil
                totalItems: 0,
                totalPages: 1,
                chunkSize: 50 // Cargar tickets en chunks para mejor rendimiento
            },
            // Filtros avanzados
            advancedFilters: {
                title: '',
                description: '',
                dateFrom: '',
                dateTo: ''
            },
            // Notificaciones en tiempo real
            realtimeUpdates: {
                enabled: true,
                lastNotification: null
            }
        };

        // Clase para manejo de errores mejorado
        class ErrorHandler {
            static handleFirebaseError(error, userFriendlyMessage) {
                console.error('Firebase Error:', error);
                
                // Mapeo de errores comunes de Firebase a mensajes amigables
                const errorMap = {
                    'permission-denied': 'No tiene permisos para realizar esta acción. Contacte al administrador.',
                    'unauthenticated': 'Su sesión ha expirado. Por favor, inicie sesión nuevamente.',
                    'not-found': 'El recurso solicitado no existe o ha sido eliminado.',
                    'already-exists': 'El elemento que intenta crear ya existe.',
                    'resource-exhausted': 'Límite de uso excedido. Intente más tarde.',
                    'failed-precondition': 'No se puede completar la acción en el estado actual.',
                    'aborted': 'La operación fue cancelada.',
                    'invalid-argument': 'Datos inválidos proporcionados.',
                    'deadline-exceeded': 'La operación tardó demasiado tiempo.'
                };
                
                const friendlyMessage = errorMap[error.code] || userFriendlyMessage;
                this.showToast(friendlyMessage, 'error');
                
                // Sugerencias basadas en el error
                if (error.code === 'permission-denied') {
                    console.info('Sugerencia: Verifique que tiene los permisos adecuados para esta acción.');
                } else if (error.code === 'unauthenticated') {
                    console.info('Sugerencia: Intente cerrar sesión y volver a iniciar.');
                } else if (error.code === 'failed-precondition') {
                    console.info('Sugerencia: Es posible que necesite crear un índice en Firebase Console.');
                }
            }
            
            static showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                if (!toast || !toastMessage) return;
                
                toastMessage.textContent = message;
                toast.className = 'toast';
                
                if (type === 'error') {
                    toast.classList.add('toast-error');
                } else if (type === 'warning') {
                    toast.classList.add('toast-warning');
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }
            
            static showConfirmation(message, actionCallback) {
                AppState.pendingAction = actionCallback;
                document.getElementById('confirmationTitle').textContent = 'Confirmar acción';
                document.getElementById('confirmationMessage').textContent = message;
                document.getElementById('confirmationModal').style.display = 'flex';
            }
        }

        // Función debounce optimizada
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // Sanitización de entradas mejorada
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            
            // Eliminar etiquetas HTML y scripts
            const div = document.createElement('div');
            div.textContent = input;
            let sanitized = div.innerHTML;
            
            // Limitar longitud para prevenir ataques de DoS
            if (sanitized.length > 10000) {
                sanitized = sanitized.substring(0, 10000) + '...';
            }
            
            return sanitized;
        }

        // Validación de datos robusta
        function validateTicketData(ticketData) {
            const errors = [];
            
            // Validar título
            if (!ticketData.title || ticketData.title.trim().length < 5) {
                errors.push('El título debe tener al menos 5 caracteres');
            } else if (ticketData.title.length > 200) {
                errors.push('El título no puede exceder los 200 caracteres');
            }
            
            // Validar descripción
            if (!ticketData.description || ticketData.description.trim().length < 10) {
                errors.push('La descripción debe tener al menos 10 caracteres');
            } else if (ticketData.description.length > 5000) {
                errors.push('La descripción no puede exceder los 5000 caracteres');
            }
            
            // Validar prioridad
            if (!ticketData.priority || !['Alta', 'Media', 'Baja'].includes(ticketData.priority)) {
                errors.push('La prioridad debe ser Alta, Media o Baja');
            }
            
            // Validar categoría
            if (!ticketData.category || !AppState.categories.includes(ticketData.category)) {
                errors.push('Seleccione una categoría válida');
            }
            
            // Validar asignación
            if (!ticketData.assignedTo) {
                errors.push('Debe asignar el ticket a un usuario');
            } else if (!AppState.users.some(user => user.id === ticketData.assignedTo)) {
                errors.push('El usuario asignado no es válido');
            }
            
            return errors;
        }

        // Esperar a que Firebase se cargue
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si Firebase está disponible
            if (typeof firebaseApp === 'undefined') {
                console.error('Firebase no se ha cargado correctamente');
                ErrorHandler.showToast('Error de configuración de Firebase. Recargue la página.', 'error');
                return;
            }
            
            // Configurar autenticación
            setupAuth();
        });

        // Configuración de autenticación
        function setupAuth() {
            const { onAuthStateChanged, signInWithPopup, signOut } = window.firebaseFunctions;
            const { auth, provider } = window;
            
            // Verificar estado de autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Verificar si el usuario está registrado en la colección users
                    const isAuthorized = await checkUserAuthorization(user.email);
                    
                    if (isAuthorized) {
                        // Usuario autorizado
                        AppState.currentUser = user;
                        try {
                            await initializeApp();
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                        } catch (error) {
                            console.error('Error inicializando la aplicación:', error);
                            ErrorHandler.showToast('Error al cargar la aplicación. Por favor, recargue la página.', 'error');
                        }
                    } else {
                        // Usuario no autorizado
                        await signOut(auth);
                        document.getElementById('loginError').textContent = 'Su cuenta no está autorizada para acceder al sistema. Contacte al administrador.';
                        document.getElementById('loginError').style.display = 'block';
                    }
                } else {
                    // Usuario no ha iniciado sesión
                    AppState.currentUser = null;
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('app').style.display = 'none';
                    document.getElementById('loginError').style.display = 'none';
                }
            });
            
            // Configurar botón de login
            document.getElementById('loginBtn').addEventListener('click', async () => {
                try {
                    showLoading(true, 'Iniciando sesión...');
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Error al iniciar sesión:', error);
                    ErrorHandler.handleFirebaseError(error, 'Error al iniciar sesión');
                } finally {
                    showLoading(false);
                }
            });
            
            // Configurar botón de logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    console.log('Iniciando logout...');
                    showLoading(true, 'Cerrando sesión...');
                    
                    // Opción 1: Usar la instancia global de auth
                    const { auth } = window;
                    const { signOut } = window.firebaseFunctions;
                    
                    console.log('Auth instance:', auth);
                    console.log('Current user:', auth.currentUser);
                    
                    if (auth.currentUser) {
                        await signOut(auth);
                        console.log('Logout exitoso');
                        ErrorHandler.showToast('Sesión cerrada correctamente');
                        
                        // Recargar después de un breve delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        console.log('No hay usuario logueado, recargando...');
                        window.location.reload();
                    }
                    
                } catch (error) {
                    console.error('Error detallado en logout:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Intentar método alternativo
                    await attemptAlternativeLogout(error);
                } finally {
                    showLoading(false);
                }
            });

            // Función de fallback para logout
            async function attemptAlternativeLogout(originalError) {
                try {
                    console.log('Intentando método alternativo de logout...');
                    
                    // Método 2: Crear nueva instancia de auth
                    const { getAuth, signOut } = window.firebaseFunctions;
                    const alternativeAuth = getAuth();
                    
                    await signOut(alternativeAuth);
                    ErrorHandler.showToast('Sesión cerrada correctamente');
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch (fallbackError) {
                    console.error('Error en método alternativo:', fallbackError);
                    
                    // Método 3: Limpiar localStorage y recargar
                    localStorage.removeItem('firebase:authUser:AIzaSyAT9LPhRgnQqUTkgm6aEpwnaegy0ZMOmjc:[DEFAULT]');
                    localStorage.removeItem('darkMode');
                    sessionStorage.clear();
                    
                    ErrorHandler.showToast('Sesión cerrada. Recargando...', 'warning');
                    setTimeout(() => window.location.reload(), 1500);
                }
            }
        }

        // Verificar si el usuario está autorizado
        async function checkUserAuthorization(email) {
            const { collection, query, where, getDocs } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                const usersQuery = query(collection(db, 'users'), where('email', '==', email));
                const querySnapshot = await getDocs(usersQuery);
                
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error verificando autorización:', error);
                return false;
            }
        }

        // Inicialización de la aplicación
        async function initializeApp() {
            // Aplicar tema
            if (AppState.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Buscar usuario en la colección users
            await loadUserData();
            
            // Mostrar información del usuario
            document.getElementById('userName').textContent = AppState.currentUserData ? AppState.currentUserData.name : (AppState.currentUser.displayName || AppState.currentUser.email);
            document.getElementById('userRole').textContent = 
                AppState.userRole === 'admin' ? 'Administrador' : 
                AppState.userRole === 'support' ? 'Soporte' : 'Usuario';
            
            // Cargar datos iniciales
            await loadInitialData();
            
            // Configurar listeners
            setupEventListeners();
            
            // Configurar gráfico
            setupChart();
            
            // Cargar vista inicial según el rol
            loadInitialView();
            
            // Iniciar notificaciones en tiempo real
            setupRealtimeNotifications();
        }

        // Cargar datos del usuario desde Firestore
        async function loadUserData() {
            const { collection, query, where, getDocs } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                showLoading(true, 'Cargando datos del usuario...');
                const usersQuery = query(collection(db, 'users'), where('email', '==', AppState.currentUser.email));
                const querySnapshot = await getDocs(usersQuery);
                
                if (!querySnapshot.empty) {
                    // Usuario encontrado en la colección
                    querySnapshot.forEach((doc) => {
                        AppState.currentUserData = { id: doc.id, ...doc.data() };
                        AppState.userRole = AppState.currentUserData.role;
                    });
                } else {
                    // Usuario no encontrado (no debería pasar porque ya verificamos autorización)
                    AppState.userRole = 'user';
                    AppState.currentUserData = {
                        name: AppState.currentUser.displayName || AppState.currentUser.email.split('@')[0],
                        email: AppState.currentUser.email,
                        role: 'user'
                    };
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                // Usar valores por defecto
                AppState.userRole = 'user';
                AppState.currentUserData = {
                    name: AppState.currentUser.displayName || AppState.currentUser.email.split('@')[0],
                    email: AppState.currentUser.email,
                    role: 'user'
                };
            } finally {
                showLoading(false);
            }
        }

        // Cargar datos iniciales desde Firestore con caché optimizado
        async function loadInitialData() {
            const { collection, onSnapshot, query, orderBy, limit } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                // Usar caché si está disponible y no ha expirado
                const now = Date.now();
                if (AppState.cache.tickets && AppState.cache.users && 
                    (now - AppState.cache.lastUpdate) < AppState.cache.cacheDuration) {
                    AppState.tickets = AppState.cache.tickets;
                    AppState.users = AppState.cache.users;
                    applyFilters();
                    return;
                }
                
                showLoading(true, 'Cargando tickets...');
                
                // SOLUCIÓN: Quitar el límite temporalmente para evitar el error del índice
                // Cargar todos los tickets primero, luego implementaremos paginación
                const ticketsQuery = query(
                    collection(db, 'tickets'), 
                    orderBy('createdAt', 'desc')
                    // limit(AppState.pagination.chunkSize) // Comentado temporalmente
                );
                
                onSnapshot(ticketsQuery, (snapshot) => {
                    AppState.tickets = [];
                    snapshot.forEach((doc) => {
                        const ticketData = doc.data();
                        // Convertir Timestamp de Firebase a Date de JavaScript
                        const observations = ticketData.observations ? ticketData.observations.map(obs => ({
                            ...obs,
                            timestamp: obs.timestamp ? obs.timestamp.toDate() : new Date()
                        })) : [];
                        
                        AppState.tickets.push({ 
                            id: doc.id, 
                            ...ticketData,
                            createdAt: ticketData.createdAt ? ticketData.createdAt.toDate() : new Date(),
                            updatedAt: ticketData.updatedAt ? ticketData.updatedAt.toDate() : new Date(),
                            observations: observations
                        });
                    });
                    
                    // Actualizar caché
                    AppState.cache.tickets = AppState.tickets;
                    AppState.cache.lastUpdate = now;
                    
                    applyFilters();
                    showLoading(false);
                }, (error) => {
                    // Manejar error específico de índice faltante
                    if (error.code === 'failed-precondition') {
                        console.error('Error de índice faltante:', error);
                        ErrorHandler.showToast('Configuración de base de datos incompleta. Contacte al administrador.', 'error');
                        // Cargar datos sin filtros como fallback
                        loadDataWithoutComplexQueries();
                    } else {
                        ErrorHandler.handleFirebaseError(error, 'Error cargando tickets');
                    }
                    showLoading(false);
                });
                
                // Cargar usuarios
                const usersQuery = query(collection(db, 'users'), orderBy('name'));
                onSnapshot(usersQuery, (snapshot) => {
                    AppState.users = [];
                    snapshot.forEach((doc) => {
                        AppState.users.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Actualizar caché
                    AppState.cache.users = AppState.users;
                    
                    populateSelectors();
                });
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                ErrorHandler.handleFirebaseError(error, 'Error cargando datos');
                showLoading(false);
            }
        }

        // Función de fallback para cargar datos sin consultas complejas
        async function loadDataWithoutComplexQueries() {
            const { collection, getDocs } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                // Cargar todos los tickets sin filtros
                const ticketsSnapshot = await getDocs(collection(db, 'tickets'));
                AppState.tickets = [];
                ticketsSnapshot.forEach((doc) => {
                    const ticketData = doc.data();
                    const observations = ticketData.observations ? ticketData.observations.map(obs => ({
                        ...obs,
                        timestamp: obs.timestamp ? obs.timestamp.toDate() : new Date()
                    })) : [];
                    
                    AppState.tickets.push({ 
                        id: doc.id, 
                        ...ticketData,
                        createdAt: ticketData.createdAt ? ticketData.createdAt.toDate() : new Date(),
                        updatedAt: ticketData.updatedAt ? ticketData.updatedAt.toDate() : new Date(),
                        observations: observations
                    });
                });
                
                // Ordenar localmente por fecha de creación
                AppState.tickets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                applyFilters();
            } catch (error) {
                console.error('Error cargando datos de fallback:', error);
                ErrorHandler.showToast('Error crítico al cargar datos. Recargue la página.', 'error');
            }
        }

        // Configurar notificaciones en tiempo real (versión simplificada)
        function setupRealtimeNotifications() {
            const { collection, onSnapshot } = window.firebaseFunctions;
            const { db } = window;
            
            // Solo para admin y support
            if (AppState.userRole !== 'admin' && AppState.userRole !== 'support') return;
            
            try {
                // Escuchar cambios en tickets (versión simplificada sin consultas complejas)
                const ticketsQuery = collection(db, 'tickets');
                
                onSnapshot(ticketsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const ticket = change.doc.data();
                            // Notificar solo si el ticket está asignado al usuario actual
                            if (ticket.assignedTo === AppState.currentUserData.id && 
                                (ticket.status === 'Pendiente' || ticket.status === 'En Progreso')) {
                                
                                // Evitar notificaciones duplicadas
                                if (!AppState.realtimeUpdates.lastNotification || 
                                    Date.now() - AppState.realtimeUpdates.lastNotification > 5000) {
                                    
                                    ErrorHandler.showToast(`Nuevo ticket asignado: ${ticket.title}`, 'warning');
                                    AppState.realtimeUpdates.lastNotification = Date.now();
                                }
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error configurando notificaciones:', error);
            }
        }

        function loadInitialView() {
            // En móvil, forzar vista Kanban
            if (window.innerWidth < 992) {
                AppState.currentView = 'kanban';
                document.getElementById('tableViewBtn').style.display = 'none';
            }
            
            // Renderizar la vista inicial
            applyFilters();
        }

        function populateSelectors() {
            // Categorías
            const categorySelect = document.getElementById('ticketCategory');
            const filterCategory = document.getElementById('filterCategory');
            
            categorySelect.innerHTML = '<option value="">Seleccione una categoría</option>';
            filterCategory.innerHTML = '<option value="">Todas las categorías</option>';
            
            AppState.categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                filterCategory.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            // Usuarios para asignación (solo admin y support)
            const assignedTo = document.getElementById('ticketAssignedTo');
            assignedTo.innerHTML = '<option value="">Seleccione un usuario</option>';
            
            // Filtrar solo usuarios con rol admin o support
            const supportUsers = AppState.users.filter(user => user.role === 'admin' || user.role === 'support');
            
            supportUsers.forEach(user => {
                assignedTo.innerHTML += `<option value="${user.id}">${user.name}</option>`;
            });
        }

        function setupEventListeners() {
            // Tema oscuro/claro
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Filtros con debounce para búsqueda
            document.getElementById('searchTickets').addEventListener('input', 
                debounce(() => applyFilters(), 500)
            );
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            document.getElementById('filterPriority').addEventListener('change', applyFilters);
            document.getElementById('filterCategory').addEventListener('change', applyFilters);
            
            // Búsqueda avanzada
            document.getElementById('toggleAdvancedSearch').addEventListener('click', toggleAdvancedSearch);
            document.getElementById('applyAdvancedSearch').addEventListener('click', applyAdvancedFilters);
            
            // Vistas
            document.getElementById('kanbanViewBtn').addEventListener('click', () => switchView('kanban'));
            document.getElementById('tableViewBtn').addEventListener('click', () => switchView('table'));
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Botones
            document.getElementById('newTicketBtn').addEventListener('click', showNewTicketModal);
            document.getElementById('floatingActionBtn').addEventListener('click', showNewTicketModal);
            document.getElementById('exportBtn').addEventListener('click', toggleExportOptions);
            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            document.getElementById('mobileFiltersBtn').addEventListener('click', toggleMobileFilters);
            
            // Paginación
            document.getElementById('firstPage').addEventListener('click', () => changePage(1));
            document.getElementById('prevPage').addEventListener('click', () => changePage(AppState.pagination.currentPage - 1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(AppState.pagination.currentPage + 1));
            document.getElementById('lastPage').addEventListener('click', () => changePage(AppState.pagination.totalPages));
            
            // Modal de tickets
            document.getElementById('closeModal').addEventListener('click', hideModal);
            document.getElementById('cancelBtn').addEventListener('click', hideModal);
            document.getElementById('saveTicketBtn').addEventListener('click', saveTicket);
            
            // Modal de confirmación
            document.getElementById('confirmCancel').addEventListener('click', hideConfirmationModal);
            document.getElementById('confirmAction').addEventListener('click', executeConfirmedAction);
            
            // Menú móvil
            document.getElementById('mobileMenu').addEventListener('click', toggleMobileMenu);
            
            // Prevenir envío del formulario al hacer clic en botones de observaciones
            document.getElementById('ticketForm').addEventListener('submit', function(e) {
                e.preventDefault();
            });
            
            // Validación en tiempo real de campos obligatorios
            document.querySelectorAll('#ticketForm input, #ticketForm select, #ticketForm textarea').forEach(input => {
                input.addEventListener('blur', validateField);
                input.addEventListener('input', clearFieldError);
            });
            
            // Cerrar menús al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#userInfo') && !e.target.closest('#mobileMenu')) {
                    document.getElementById('userInfo').classList.remove('active');
                }
                
                if (!e.target.closest('#filters') && !e.target.closest('#mobileFiltersBtn')) {
                    document.getElementById('filters').classList.remove('active');
                }
            });
            
            // Ajustar paginación para móvil al cambiar tamaño de ventana
            window.addEventListener('resize', debounce(() => {
                if (window.innerWidth < 768) {
                    AppState.pagination.itemsPerPage = 6;
                } else {
                    AppState.pagination.itemsPerPage = 10;
                }
                applyFilters();
            }, 250));
        }

        function validateField(e) {
            const field = e.target;
            if (field.hasAttribute('required') && !field.value.trim()) {
                showFieldError(field, 'Este campo es obligatorio');
            } else if (field.id === 'ticketTitle' && field.value.length > 200) {
                showFieldError(field, 'El título no puede exceder 200 caracteres');
            } else if (field.id === 'ticketDescription' && field.value.length > 5000) {
                showFieldError(field, 'La descripción no puede exceder 5000 caracteres');
            } else {
                clearFieldError(field);
            }
        }

        function showFieldError(field, message) {
            field.style.borderColor = 'var(--danger-color)';
            // Crear o actualizar mensaje de error
            let errorElement = field.parentNode.querySelector('.field-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'field-error';
                errorElement.style.color = 'var(--danger-color)';
                errorElement.style.fontSize = '0.8rem';
                errorElement.style.marginTop = '5px';
                field.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = message;
        }

        function clearFieldError(e) {
            const field = e.target || e;
            field.style.borderColor = 'var(--border-color)';
            const errorElement = field.parentNode.querySelector('.field-error');
            if (errorElement) {
                errorElement.remove();
            }
        }

        function toggleTheme() {
            AppState.darkMode = !AppState.darkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', AppState.darkMode);
            
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = AppState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleMobileMenu() {
            const userInfo = document.getElementById('userInfo');
            userInfo.classList.toggle('active');
        }

        function toggleMobileFilters() {
            const filters = document.getElementById('filters');
            filters.classList.toggle('active');
        }

        function toggleAdvancedSearch() {
            const advancedSearch = document.getElementById('advancedSearch');
            const toggleBtn = document.getElementById('toggleAdvancedSearch');
            
            advancedSearch.classList.toggle('active');
            toggleBtn.innerHTML = advancedSearch.classList.contains('active') ? 
                '<i class="fas fa-search-minus"></i> Ocultar Búsqueda Avanzada' : 
                '<i class="fas fa-search-plus"></i> Búsqueda Avanzada';
        }

        function applyAdvancedFilters() {
            AppState.advancedFilters.title = document.getElementById('searchTitle').value;
            AppState.advancedFilters.description = document.getElementById('searchDescription').value;
            AppState.advancedFilters.dateFrom = document.getElementById('searchDateFrom').value;
            AppState.advancedFilters.dateTo = document.getElementById('searchDateTo').value;
            
            applyFilters();
        }

        function switchView(view) {
            // En móvil, solo permitir vista Kanban
            if (window.innerWidth < 992 && view === 'table') {
                ErrorHandler.showToast('La vista de tabla solo está disponible en escritorio', 'warning');
                return;
            }
            
            AppState.currentView = view;
            
            // Actualizar botones de vista
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${view}ViewBtn`).classList.add('active');
            
            // Mostrar la vista seleccionada
            document.getElementById('kanbanView').style.display = view === 'kanban' ? 'grid' : 'none';
            document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
            
            // Aplicar filtros a la vista actual
            applyFilters();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
                document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-compress"></i> <span class="btn-text">Salir de Pantalla Completa</span>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-expand"></i> <span class="btn-text">Pantalla Completa</span>';
                }
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchTickets').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            
            // Filtrar tickets según el rol del usuario
            let filteredTickets = AppState.tickets;
            
            if (AppState.userRole === 'user') {
                // Usuario regular: solo ve sus propios tickets
                filteredTickets = AppState.tickets.filter(ticket => 
                    ticket.createdBy === AppState.currentUserData.id
                );
            } else if (AppState.userRole === 'support') {
                // Usuario de soporte: ve sus tickets creados y los asignados a él
                filteredTickets = AppState.tickets.filter(ticket => 
                    ticket.createdBy === AppState.currentUserData.id || 
                    ticket.assignedTo === AppState.currentUserData.id
                );
            }
            // Admin ve todos los tickets (no se aplica filtro)
            
            // Aplicar filtros básicos
            filteredTickets = filteredTickets.filter(ticket => {
                // Filtro de búsqueda
                if (searchTerm && 
                    !ticket.title.toLowerCase().includes(searchTerm) && 
                    !ticket.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtro de estado
                if (statusFilter && ticket.status !== statusFilter) {
                    return false;
                }
                
                // Filtro de prioridad
                if (priorityFilter && ticket.priority !== priorityFilter) {
                    return false;
                }
                
                // Filtro de categoría
                if (categoryFilter && ticket.category !== categoryFilter) {
                    return false;
                }
                
                // Filtros avanzados
                if (AppState.advancedFilters.title && !ticket.title.toLowerCase().includes(AppState.advancedFilters.title.toLowerCase())) {
                    return false;
                }
                
                if (AppState.advancedFilters.description && !ticket.description.toLowerCase().includes(AppState.advancedFilters.description.toLowerCase())) {
                    return false;
                }
                
                if (AppState.advancedFilters.dateFrom) {
                    const ticketDate = new Date(ticket.createdAt);
                    const filterDate = new Date(AppState.advancedFilters.dateFrom);
                    if (ticketDate < filterDate) return false;
                }
                
                if (AppState.advancedFilters.dateTo) {
                    const ticketDate = new Date(ticket.createdAt);
                    const filterDate = new Date(AppState.advancedFilters.dateTo);
                    filterDate.setDate(filterDate.getDate() + 1); // Incluir el día completo
                    if (ticketDate >= filterDate) return false;
                }
                
                return true;
            });
            
            // Aplicar paginación
            applyPagination(filteredTickets);
            
            // Renderizar la vista actual con los tickets filtrados
            switch(AppState.currentView) {
                case 'kanban':
                    renderKanbanView(getPaginatedTickets(filteredTickets));
                    break;
                case 'table':
                    renderTableView(getPaginatedTickets(filteredTickets));
                    break;
            }
            
            // Actualizar dashboard
            renderDashboard(filteredTickets);
        }

        function applyPagination(filteredTickets) {
            AppState.pagination.totalItems = filteredTickets.length;
            AppState.pagination.totalPages = Math.ceil(filteredTickets.length / AppState.pagination.itemsPerPage);
            
            // Ajustar página actual si es necesario
            if (AppState.pagination.currentPage > AppState.pagination.totalPages) {
                AppState.pagination.currentPage = Math.max(1, AppState.pagination.totalPages);
            }
            
            // Mostrar u ocultar paginación
            const pagination = document.getElementById('pagination');
            if (filteredTickets.length > AppState.pagination.itemsPerPage) {
                pagination.style.display = 'flex';
                updatePaginationControls();
            } else {
                pagination.style.display = 'none';
            }
        }

        function getPaginatedTickets(tickets) {
            const startIndex = (AppState.pagination.currentPage - 1) * AppState.pagination.itemsPerPage;
            const endIndex = startIndex + AppState.pagination.itemsPerPage;
            return tickets.slice(startIndex, endIndex);
        }

        function changePage(page) {
            if (page < 1 || page > AppState.pagination.totalPages) return;
            
            AppState.pagination.currentPage = page;
            applyFilters();
            
            // Scroll suave hacia arriba en móvil
            if (window.innerWidth < 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = `Página ${AppState.pagination.currentPage} de ${AppState.pagination.totalPages}`;
            
            document.getElementById('firstPage').disabled = AppState.pagination.currentPage === 1;
            document.getElementById('prevPage').disabled = AppState.pagination.currentPage === 1;
            document.getElementById('nextPage').disabled = AppState.pagination.currentPage === AppState.pagination.totalPages;
            document.getElementById('lastPage').disabled = AppState.pagination.currentPage === AppState.pagination.totalPages;
        }

        function setupChart() {
            const ctx = document.getElementById('ticketsChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'En Progreso', 'Resuelto', 'Archivado'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12',
                            '#2ecc71',
                            '#95a5a6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            window.ticketsChart = chart;
        }

        function updateChart(filteredTickets) {
            const statusCount = {
                'Pendiente': 0,
                'En Progreso': 0,
                'Resuelto': 0,
                'Archivado': 0
            };
            
            filteredTickets.forEach(ticket => {
                statusCount[ticket.status] = (statusCount[ticket.status] || 0) + 1;
            });
            
            window.ticketsChart.data.datasets[0].data = [
                statusCount['Pendiente'],
                statusCount['En Progreso'],
                statusCount['Resuelto'],
                statusCount['Archivado']
            ];
            
            window.ticketsChart.update();
        }

        function renderDashboard(filteredTickets) {
            const total = filteredTickets.length;
            const open = filteredTickets.filter(t => t.status === 'Pendiente' || t.status === 'En Progreso').length;
            const resolved = filteredTickets.filter(t => t.status === 'Resuelto').length;
            const myTickets = filteredTickets.filter(t => t.createdBy === AppState.currentUser.uid).length;
            const highPriority = filteredTickets.filter(t => t.priority === 'Alta').length;
            const assignedToMe = filteredTickets.filter(t => t.assignedTo === AppState.currentUserData.id).length;
            
            // Calcular tiempo promedio de resolución
            const resolvedTickets = filteredTickets.filter(t => t.status === 'Resuelto' && t.createdAt && t.updatedAt);
            let avgResolutionTime = 0;
            if (resolvedTickets.length > 0) {
                const totalTime = resolvedTickets.reduce((sum, ticket) => {
                    const resolutionTime = ticket.updatedAt - ticket.createdAt;
                    return sum + resolutionTime;
                }, 0);
                avgResolutionTime = Math.round(totalTime / resolvedTickets.length / (1000 * 60 * 60 * 24)); // Convertir a días
            }
            
            // Tickets creados este mes
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const ticketsThisMonth = filteredTickets.filter(t => {
                const ticketDate = new Date(t.createdAt);
                return ticketDate.getMonth() === currentMonth && ticketDate.getFullYear() === currentYear;
            }).length;
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('openTickets').textContent = open;
            document.getElementById('resolvedTickets').textContent = resolved;
            document.getElementById('myTickets').textContent = myTickets;
            document.getElementById('highPriorityTickets').textContent = highPriority;
            document.getElementById('assignedTickets').textContent = assignedToMe;
            document.getElementById('avgResolutionTime').textContent = avgResolutionTime + 'd';
            document.getElementById('ticketsThisMonth').textContent = ticketsThisMonth;
            
            updateChart(filteredTickets);
        }

        function renderKanbanView(filteredTickets) {
            // Generar columnas
            const statuses = ['Pendiente', 'En Progreso', 'Resuelto', 'Archivado'];
            const board = document.getElementById('kanbanView');
            board.innerHTML = '';
            
            statuses.forEach(status => {
                const columnTickets = filteredTickets.filter(t => t.status === status);
                
                const column = document.createElement('div');
                column.className = 'column';
                column.innerHTML = `
                    <div class="column-header">
                        <div class="column-title">${status}</div>
                        <div class="ticket-count">${columnTickets.length}</div>
                    </div>
                    <div class="ticket-list" id="${status.replace(' ', '-')}-list">
                        ${columnTickets.map(ticket => createTicketCard(ticket)).join('')}
                    </div>
                `;
                
                board.appendChild(column);
            });
            
            // Hacer las tarjetas arrastrables
            makeTicketsDraggable();
        }

        function renderTableView(filteredTickets) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            filteredTickets.forEach(ticket => {
                const assignedUser = AppState.users.find(u => u.id === ticket.assignedTo);
                const assignedName = assignedUser ? assignedUser.name : 'Sin asignar';
                const createdByName = getCreatorName(ticket);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ticket.title}</td>
                    <td>
                        ${(AppState.userRole === 'admin' || AppState.userRole === 'support') ? 
                            `<select class="status-select" onchange="updateTicketStatus('${ticket.id}', this.value)">
                                <option value="Pendiente" ${ticket.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="En Progreso" ${ticket.status === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                                <option value="Resuelto" ${ticket.status === 'Resuelto' ? 'selected' : ''}>Resuelto</option>
                                <option value="Archivado" ${ticket.status === 'Archivado' ? 'selected' : ''}>Archivado</option>
                            </select>` :
                            `<span class="badge badge-primary">${ticket.status}</span>`
                        }
                    </td>
                    <td><span class="badge badge-${getPriorityBadgeClass(ticket.priority)}">${ticket.priority}</span></td>
                    <td>${ticket.category}</td>
                    <td>${createdByName}</td>
                    <td>${assignedName}</td>
                    <td>${formatDate(new Date(ticket.createdAt))}</td>
                    <td>
                        ${AppState.userRole === 'user' && !hasPermission('edit', ticket) ? 
                            `<button class="btn" onclick="viewTicket('${ticket.id}')"><i class="fas fa-eye"></i></button>` :
                            `<button class="btn" onclick="editTicket('${ticket.id}')"><i class="fas fa-edit"></i></button>`
                        }
                        ${AppState.userRole === 'admin' ? `<button class="btn btn-danger" onclick="confirmDeleteTicket('${ticket.id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function getCreatorName(ticket) {
            // Primero intentar encontrar el usuario en la colección de usuarios
            const user = AppState.users.find(u => u.id === ticket.createdBy);
            if (user) return user.name;
            
            // Si no se encuentra, usar el createdByName guardado en el ticket
            if (ticket.createdByName) return ticket.createdByName;
            
            // Si no hay nada, mostrar un texto genérico
            return 'Usuario desconocido';
        }

        function createTicketCard(ticket) {
            const assignedUser = AppState.users.find(u => u.id === ticket.assignedTo);
            const assignedName = assignedUser ? assignedUser.name : 'Sin asignar';
            const createdByName = getCreatorName(ticket);
            
            return `
                <div class="ticket-card ticket-priority-${ticket.priority.toLowerCase()}" data-id="${ticket.id}" draggable="true">
                    <div class="ticket-header">
                        <div class="ticket-title">${ticket.title}</div>
                        <div class="badge badge-${getPriorityBadgeClass(ticket.priority)}">${ticket.priority}</div>
                    </div>
                    <div class="ticket-meta">
                        <div class="badge badge-primary">${ticket.category}</div>
                    </div>
                    <div>${ticket.description.substring(0, 100)}${ticket.description.length > 100 ? '...' : ''}</div>
                    <div><small>Creado por: ${createdByName}</small></div>
                    <div><small>Asignado a: ${assignedName}</small></div>
                    <div><small>Creado: ${formatDate(new Date(ticket.createdAt))}</small></div>
                    ${ticket.observations && ticket.observations.length > 0 ? 
                        `<div><small><i class="fas fa-comment"></i> ${ticket.observations.length} observación(es)</small></div>` : ''}
                    <div class="actions">
                        ${AppState.userRole === 'user' && !hasPermission('edit', ticket) ? 
                            `<button class="btn" onclick="viewTicket('${ticket.id}')"><i class="fas fa-eye"></i></button>` :
                            `<button class="btn" onclick="editTicket('${ticket.id}')"><i class="fas fa-edit"></i></button>`
                        }
                        ${AppState.userRole === 'admin' ? `<button class="btn btn-danger" onclick="confirmDeleteTicket('${ticket.id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
            `;
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'Alta': return 'danger';
                case 'Media': return 'warning';
                case 'Baja': return 'success';
                default: return 'primary';
            }
        }

        function formatDate(date) {
            if (!date) return 'Fecha inválida';
            try {
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return 'Fecha inválida';
            }
        }

        function hasPermission(action, resource) {
            if (AppState.userRole === 'admin') return true;
            
            switch(action) {
                case 'delete':
                    return AppState.userRole === 'admin';
                case 'edit':
                    if (resource.createdBy === AppState.currentUser.uid && resource.status === 'Pendiente') return true;
                    return AppState.userRole === 'admin' || AppState.userRole === 'support';
                case 'view':
                    if (resource.createdBy === AppState.currentUser.uid) return true;
                    return AppState.userRole === 'admin' || AppState.userRole === 'support';
                default:
                    return false;
            }
        }

        function makeTicketsDraggable() {
            const ticketCards = document.querySelectorAll('.ticket-card');
            
            ticketCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            const columns = document.querySelectorAll('.column .ticket-list');
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const ticketId = e.dataTransfer.getData('text/plain');
            const newStatus = e.target.closest('.ticket-list').id.replace('-list', '').replace('-', ' ');
            
            await updateTicketStatus(ticketId, newStatus);
        }

        async function updateTicketStatus(ticketId, newStatus) {
            // Validar permisos
            if (AppState.userRole === 'user') {
                ErrorHandler.showToast('No tiene permisos para cambiar el estado de los tickets', 'error');
                return;
            }
            
            const { doc, updateDoc } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                showLoading(true, 'Actualizando estado...');
                const ticketRef = doc(db, 'tickets', ticketId);
                await updateDoc(ticketRef, {
                    status: newStatus,
                    updatedAt: new Date()
                });
                
                ErrorHandler.showToast('Estado del ticket actualizado correctamente');
            } catch (error) {
                console.error('Error actualizando ticket:', error);
                ErrorHandler.handleFirebaseError(error, 'Error actualizando ticket');
            } finally {
                showLoading(false);
            }
        }

        function showNewTicketModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Ticket';
            document.getElementById('ticketForm').reset();
            document.getElementById('ticketId').value = '';
            
            // Para nuevo ticket, el estado es siempre Pendiente y no se muestra el selector
            document.getElementById('ticketStatusGroup').style.display = 'none';
            
            // Mostrar selector de asignación para todos los roles
            document.getElementById('ticketAssignedTo').disabled = false;
            
            document.getElementById('observationsList').innerHTML = '<p>No hay observaciones aún.</p>';
            document.getElementById('addObservationSection').style.display = 'none';
            
            // Limpiar estilos de validación
            document.querySelectorAll('#ticketForm input, #ticketForm select, #ticketForm textarea').forEach(field => {
                clearFieldError(field);
            });
            
            document.getElementById('ticketModal').style.display = 'flex';
        }

        function viewTicket(ticketId) {
            const ticket = AppState.tickets.find(t => t.id === ticketId);
            
            if (!ticket) return;
            
            document.getElementById('modalTitle').textContent = 'Ver Ticket';
            document.getElementById('ticketId').value = ticket.id;
            document.getElementById('ticketTitle').value = ticket.title;
            document.getElementById('ticketDescription').value = ticket.description;
            document.getElementById('ticketPriority').value = ticket.priority;
            document.getElementById('ticketCategory').value = ticket.category;
            document.getElementById('ticketAssignedTo').value = ticket.assignedTo || '';
            document.getElementById('ticketStatus').value = ticket.status;
            
            // Hacer campos de solo lectura
            document.getElementById('ticketTitle').readOnly = true;
            document.getElementById('ticketDescription').readOnly = true;
            document.getElementById('ticketPriority').disabled = true;
            document.getElementById('ticketCategory').disabled = true;
            document.getElementById('ticketAssignedTo').disabled = true;
            document.getElementById('ticketStatus').disabled = true;
            
            // Ocultar selector de estado para todos los usuarios en modo vista
            document.getElementById('ticketStatusGroup').style.display = 'none';
            
            // Mostrar sección de observaciones
            document.getElementById('observationsSection').style.display = 'block';
            loadObservations(ticket);
            
            // Ocultar campo para agregar observaciones
            document.getElementById('addObservationSection').style.display = 'none';
            
            // Ocultar botón de guardar
            document.getElementById('saveTicketBtn').style.display = 'none';
            
            document.getElementById('ticketModal').style.display = 'flex';
        }

        function editTicket(ticketId) {
            const ticket = AppState.tickets.find(t => t.id === ticketId);
            
            if (!ticket) return;
            
            // Verificar permisos según el estado del ticket
            if (!hasPermission('edit', ticket)) {
                ErrorHandler.showToast('No tiene permisos para editar este ticket', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Editar Ticket';
            document.getElementById('ticketId').value = ticket.id;
            document.getElementById('ticketTitle').value = ticket.title;
            document.getElementById('ticketDescription').value = ticket.description;
            document.getElementById('ticketPriority').value = ticket.priority;
            document.getElementById('ticketCategory').value = ticket.category;
            document.getElementById('ticketAssignedTo').value = ticket.assignedTo || '';
            document.getElementById('ticketStatus').value = ticket.status;
            
            // Hacer campos editables
            document.getElementById('ticketTitle').readOnly = false;
            document.getElementById('ticketDescription').readOnly = false;
            document.getElementById('ticketPriority').disabled = false;
            document.getElementById('ticketCategory').disabled = false;
            document.getElementById('ticketAssignedTo').disabled = false;
            document.getElementById('ticketStatus').disabled = false;
            
            // Mostrar selector de estado solo para admin y support
            if (AppState.userRole === 'admin' || AppState.userRole === 'support') {
                document.getElementById('ticketStatusGroup').style.display = 'block';
            } else {
                document.getElementById('ticketStatusGroup').style.display = 'none';
            }
            
            // Mostrar sección de observaciones para todos los usuarios
            document.getElementById('observationsSection').style.display = 'block';
            loadObservations(ticket);
            
            // Mostrar campo para agregar observaciones solo para admin/support
            if (AppState.userRole === 'admin' || AppState.userRole === 'support') {
                document.getElementById('addObservationSection').style.display = 'block';
                document.getElementById('ticketObservation').value = '';
            } else {
                document.getElementById('addObservationSection').style.display = 'none';
            }
            
            // Mostrar botón de guardar
            document.getElementById('saveTicketBtn').style.display = 'block';
            
            document.getElementById('ticketModal').style.display = 'flex';
        }

        function loadObservations(ticket) {
            const observationsList = document.getElementById('observationsList');
            observationsList.innerHTML = '';
            
            if (ticket.observations && ticket.observations.length > 0) {
                // Cargar solo las primeras 5 observaciones (lazy loading)
                const observationsToShow = ticket.observations.slice(0, 5);
                
                observationsToShow.forEach((obs, index) => {
                    const observationItem = document.createElement('div');
                    observationItem.className = 'observation-item';
                    
                    let actionsHtml = '';
                    if (AppState.userRole === 'admin' || AppState.userRole === 'support') {
                        actionsHtml = `
                            <div class="observation-actions">
                                <button type="button" class="btn btn-small" onclick="editObservation(${index})"><i class="fas fa-edit"></i></button>
                                <button type="button" class="btn btn-small btn-danger" onclick="deleteObservation(${index})"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                    }
                    
                    observationItem.innerHTML = `
                        <div class="observation-header">
                            <span>${obs.userName} - ${formatDate(obs.timestamp)}</span>
                        </div>
                        <div>${obs.text}</div>
                        ${actionsHtml}
                    `;
                    observationsList.appendChild(observationItem);
                });
                
                // Mostrar botón para cargar más si hay más observaciones
                if (ticket.observations.length > 5) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = 'btn btn-small';
                    loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> Cargar más observaciones';
                    loadMoreBtn.onclick = () => loadAllObservations(ticket);
                    observationsList.appendChild(loadMoreBtn);
                }
            } else {
                observationsList.innerHTML = '<p>No hay observaciones aún.</p>';
            }
        }

        function loadAllObservations(ticket) {
            const observationsList = document.getElementById('observationsList');
            observationsList.innerHTML = '';
            
            ticket.observations.forEach((obs, index) => {
                const observationItem = document.createElement('div');
                observationItem.className = 'observation-item';
                
                let actionsHtml = '';
                if (AppState.userRole === 'admin' || AppState.userRole === 'support') {
                    actionsHtml = `
                        <div class="observation-actions">
                            <button type="button" class="btn btn-small" onclick="editObservation(${index})"><i class="fas fa-edit"></i></button>
                            <button type="button" class="btn btn-small btn-danger" onclick="deleteObservation(${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                }
                
                observationItem.innerHTML = `
                    <div class="observation-header">
                        <span>${obs.userName} - ${formatDate(obs.timestamp)}</span>
                    </div>
                    <div>${obs.text}</div>
                    ${actionsHtml}
                `;
                observationsList.appendChild(observationItem);
            });
        }

        function editObservation(index) {
            const ticketId = document.getElementById('ticketId').value;
            const ticket = AppState.tickets.find(t => t.id === ticketId);
            
            if (ticket && ticket.observations && ticket.observations[index]) {
                const observation = ticket.observations[index];
                document.getElementById('ticketObservation').value = observation.text;
                AppState.editingObservationIndex = index;
            }
        }

        function deleteObservation(index) {
            const ticketId = document.getElementById('ticketId').value;
            const ticket = AppState.tickets.find(t => t.id === ticketId);
            
            if (ticket && ticket.observations && ticket.observations[index]) {
                const observation = ticket.observations[index];
                
                AppState.pendingAction = {
                    type: 'deleteObservation',
                    ticketId: ticketId,
                    observationIndex: index
                };
                
                document.getElementById('confirmationTitle').textContent = 'Eliminar Observación';
                document.getElementById('confirmationMessage').textContent = 
                    '¿Está seguro de que desea eliminar esta observación?';
                document.getElementById('confirmationModal').style.display = 'flex';
            }
        }

        async function saveTicket() {
            const { addDoc, doc, updateDoc, collection, Timestamp } = window.firebaseFunctions;
            const { db } = window;
            
            const ticketId = document.getElementById('ticketId').value;
            const title = sanitizeInput(document.getElementById('ticketTitle').value);
            const description = sanitizeInput(document.getElementById('ticketDescription').value);
            const priority = document.getElementById('ticketPriority').value;
            const category = document.getElementById('ticketCategory').value;
            const assignedTo = document.getElementById('ticketAssignedTo').value;
            const status = document.getElementById('ticketStatus').value || 'Pendiente'; // Estado predeterminado
            const observation = sanitizeInput(document.getElementById('ticketObservation').value);
            
            // Validar campos obligatorios
            const ticketData = {
                title: title.trim(),
                description: description.trim(),
                priority,
                category,
                assignedTo,
                status
            };
            
            const validationErrors = validateTicketData(ticketData);
            if (validationErrors.length > 0) {
                ErrorHandler.showToast(validationErrors.join(', '), 'error');
                return;
            }
            
            try {
                showLoading(true, ticketId ? 'Actualizando ticket...' : 'Creando ticket...');
                if (ticketId) {
                    // Editar ticket existente
                    const ticketRef = doc(db, 'tickets', ticketId);
                    const updateData = {
                        title: ticketData.title,
                        description: ticketData.description,
                        priority: ticketData.priority,
                        category: ticketData.category,
                        assignedTo: ticketData.assignedTo,
                        updatedAt: new Date()
                    };
                    
                    // Solo permitir cambiar el estado a admin/support
                    if (AppState.userRole === 'admin' || AppState.userRole === 'support') {
                        updateData.status = ticketData.status;
                    }
                    
                    // Agregar o editar observación si existe y el usuario tiene permisos
                    if (observation && (AppState.userRole === 'admin' || AppState.userRole === 'support')) {
                        const ticket = AppState.tickets.find(t => t.id === ticketId);
                        const observations = ticket.observations || [];
                        
                        if (AppState.editingObservationIndex >= 0) {
                            // Editar observación existente
                            observations[AppState.editingObservationIndex] = {
                                text: observation,
                                userName: AppState.currentUserData.name,
                                timestamp: observations[AppState.editingObservationIndex].timestamp
                            };
                            AppState.editingObservationIndex = -1;
                        } else {
                            // Agregar nueva observación
                            observations.push({
                                text: observation,
                                userName: AppState.currentUserData.name,
                                timestamp: new Date()
                            });
                        }
                        
                        updateData.observations = observations;
                    }
                    
                    await updateDoc(ticketRef, updateData);
                } else {
                    // Crear nuevo ticket
                    let createdByName = AppState.currentUserData.name;
                    let createdByUserId = AppState.currentUserData.id;
                    
                    // Si no encontramos el usuario en nuestra colección, usar los datos de autenticación
                    if (!createdByName) {
                        createdByName = AppState.currentUser.displayName || AppState.currentUser.email.split('@')[0];
                        createdByUserId = AppState.currentUser.uid;
                    }
                    
                    // Crear nuevo ticket con la información corregida
                    await addDoc(collection(db, 'tickets'), {
                        title: ticketData.title,
                        description: ticketData.description,
                        priority: ticketData.priority,
                        category: ticketData.category,
                        status: 'Pendiente', // Estado predeterminado para nuevos tickets
                        assignedTo: ticketData.assignedTo,
                        createdBy: createdByUserId, // Guardar el ID del usuario
                        createdByName: createdByName, // Guardar el nombre para mostrar
                        createdByEmail: AppState.currentUser.email, // Guardar email para referencia
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }
                
                // Limpiar campo de observación
                document.getElementById('ticketObservation').value = '';
                
                // Cerrar modal y mostrar mensaje
                hideModal();
                ErrorHandler.showToast(ticketId ? 'Ticket actualizado correctamente' : 'Ticket creado correctamente');
                
            } catch (error) {
                console.error('Error guardando ticket:', error);
                ErrorHandler.handleFirebaseError(error, 'Error guardando ticket');
            } finally {
                showLoading(false);
            }
        }

        function confirmDeleteTicket(ticketId) {
            if (!hasPermission('delete', { id: ticketId })) {
                ErrorHandler.showToast('No tiene permisos para eliminar tickets', 'error');
                return;
            }
            
            const ticket = AppState.tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            AppState.pendingAction = {
                type: 'deleteTicket',
                ticketId: ticketId,
                ticketTitle: ticket.title
            };
            
            document.getElementById('confirmationTitle').textContent = 'Eliminar Ticket';
            document.getElementById('confirmationMessage').textContent = 
                `¿Está seguro de que desea eliminar el ticket "${ticket.title}"? Esta acción no se puede deshacer.`;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function confirmLogout() {
            AppState.pendingAction = {
                type: 'logout'
            };
            
            document.getElementById('confirmationTitle').textContent = 'Cerrar Sesión';
            document.getElementById('confirmationMessage').textContent = '¿Está seguro de que desea cerrar sesión?';
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        async function executeDeleteTicket(ticketId) {
            const { deleteDoc, doc } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                showLoading(true, 'Eliminando ticket...');
                await deleteDoc(doc(db, 'tickets', ticketId));
                ErrorHandler.showToast('Ticket eliminado correctamente');
            } catch (error) {
                console.error('Error eliminando ticket:', error);
                ErrorHandler.handleFirebaseError(error, 'Error eliminando ticket');
            } finally {
                showLoading(false);
                hideConfirmationModal();
            }
        }

        async function executeDeleteObservation(ticketId, observationIndex) {
            const { doc, updateDoc } = window.firebaseFunctions;
            const { db } = window;
            
            try {
                showLoading(true, 'Eliminando observación...');
                const ticketRef = doc(db, 'tickets', ticketId);
                const ticket = AppState.tickets.find(t => t.id === ticketId);
                
                if (ticket && ticket.observations) {
                    const observations = [...ticket.observations];
                    observations.splice(observationIndex, 1);
                    
                    await updateDoc(ticketRef, {
                        observations: observations,
                        updatedAt: new Date()
                    });
                    
                    ErrorHandler.showToast('Observación eliminada correctamente');
                }
            } catch (error) {
                console.error('Error eliminando observación:', error);
                ErrorHandler.handleFirebaseError(error, 'Error eliminando observación');
            } finally {
                showLoading(false);
                hideConfirmationModal();
            }
        }

        async function executeConfirmedAction() {
            const { deleteDoc, doc, updateDoc, signOut } = window.firebaseFunctions;
            const { auth } = window;
            
            try {
                showLoading(true);
                
                if (AppState.pendingAction.type === 'deleteTicket') {
                    await deleteDoc(doc(db, 'tickets', AppState.pendingAction.ticketId));
                    ErrorHandler.showToast('Ticket eliminado correctamente');
                    
                } else if (AppState.pendingAction.type === 'deleteObservation') {
                    const ticketRef = doc(db, 'tickets', AppState.pendingAction.ticketId);
                    const ticket = AppState.tickets.find(t => t.id === AppState.pendingAction.ticketId);
                    
                    if (ticket && ticket.observations) {
                        const observations = [...ticket.observations];
                        observations.splice(AppState.pendingAction.observationIndex, 1);
                        
                        await updateDoc(ticketRef, {
                            observations: observations,
                            updatedAt: new Date()
                        });
                        
                        ErrorHandler.showToast('Observación eliminada correctamente');
                        
                        // Recargar observaciones en el modal
                        if (document.getElementById('ticketModal').style.display === 'flex') {
                            loadObservations(ticket);
                        }
                    }
                    
                } else if (AppState.pendingAction.type === 'logout') {
                    // CORRECCIÓN: Usar las funciones de Firebase directamente
                    await signOut(auth);
                    ErrorHandler.showToast('Sesión cerrada correctamente');
                    
                    // Opcional: Redirigir o recargar después del logout
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error ejecutando acción:', error);
                ErrorHandler.handleFirebaseError(error, 'Error ejecutando acción');
                
                // En caso de error en logout, forzar el cierre de sesión
                if (AppState.pendingAction.type === 'logout') {
                    try {
                        await auth.signOut();
                    } catch (fallbackError) {
                        console.error('Error en fallback logout:', fallbackError);
                    }
                }
            } finally {
                showLoading(false);
                hideConfirmationModal();
                AppState.pendingAction = null;
            }
        }

        function hideModal() {
            document.getElementById('ticketModal').style.display = 'none';
            AppState.editingObservationIndex = -1;
        }

        function hideConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            AppState.pendingAction = null; // Limpiar la acción pendiente
        }

        function toggleExportOptions() {
            const options = document.getElementById('exportOptions');
            options.style.display = options.style.display === 'none' ? 'flex' : 'none';
        }

        function exportToPDF() {
            // Filtrar tickets según el rol del usuario
            let filteredTickets = AppState.tickets;
            
            if (AppState.userRole === 'user') {
                filteredTickets = AppState.tickets.filter(ticket => ticket.createdBy === AppState.currentUser.uid);
            } else if (AppState.userRole === 'support') {
                filteredTickets = AppState.tickets.filter(ticket => 
                    ticket.createdBy === AppState.currentUser.uid || 
                    ticket.assignedTo === AppState.currentUserData.id
                );
            }
            
            // Aplicar filtros actuales
            filteredTickets = applyCurrentFiltersToTickets(filteredTickets);
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Reporte de Tickets', 105, 15, { align: 'center' });
            
            // Fecha de generación
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 105, 22, { align: 'center' });
            doc.text(`Generado por: ${AppState.currentUserData.name}`, 105, 28, { align: 'center' });
            
            // Estadísticas
            doc.setFontSize(12);
            doc.text(`Total de tickets: ${filteredTickets.length}`, 20, 40);
            
            // Tabla de tickets
            const tableColumn = ["Título", "Descripción", "Estado", "Prioridad", "Categoría", "Creado por", "Asignado a", "Fecha Creación"];
            const tableRows = [];
            
            filteredTickets.forEach(ticket => {
                const assignedUser = AppState.users.find(u => u.id === ticket.assignedTo);
                const assignedName = assignedUser ? assignedUser.name : 'Sin asignar';
                const createdByUser = AppState.users.find(u => u.id === ticket.createdBy);
                const createdByName = createdByUser ? createdByUser.name : 'Usuario desconocido';
                const createdDate = formatDate(new Date(ticket.createdAt));
                
                const ticketData = [
                    ticket.title.substring(0, 25) + (ticket.title.length > 25 ? '...' : ''),
                    ticket.description.substring(0, 30) + (ticket.description.length > 30 ? '...' : ''),
                    ticket.status,
                    ticket.priority,
                    ticket.category,
                    createdByName,
                    assignedName,
                    createdDate
                ];
                tableRows.push(ticketData);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 50,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [203, 62, 44] }
            });
            
            // Agregar observaciones si hay tickets
            if (filteredTickets.length > 0) {
                let startY = doc.lastAutoTable.finalY + 15;
                
                // Verificar si hay espacio suficiente para agregar observaciones
                if (startY < 250) {
                    doc.setFontSize(14);
                    doc.text('Observaciones', 20, startY);
                    startY += 10;
                    
                    filteredTickets.forEach(ticket => {
                        if (ticket.observations && ticket.observations.length > 0) {
                            // Verificar si hay espacio para agregar más contenido
                            if (startY > 270) {
                                doc.addPage();
                                startY = 20;
                            }
                            
                            doc.setFontSize(10);
                            doc.text(`Ticket: ${ticket.title}`, 20, startY);
                            startY += 5;
                            
                            // Mostrar solo las primeras 3 observaciones para no saturar el PDF
                            const observationsToShow = ticket.observations.slice(0, 3);
                            
                            observationsToShow.forEach(obs => {
                                const observationText = `${obs.userName} (${formatDate(obs.timestamp)}): ${obs.text}`;
                                const lines = doc.splitTextToSize(observationText, 170);
                                
                                // Verificar si hay espacio para esta observación
                                if (startY + (lines.length * 5) > 280) {
                                    doc.addPage();
                                    startY = 20;
                                }
                                
                                doc.text(lines, 25, startY);
                                startY += lines.length * 5 + 2;
                            });
                            
                            startY += 5;
                        }
                    });
                }
            }
            
            // Guardar PDF
            doc.save('reporte_tickets.pdf');
            ErrorHandler.showToast('PDF exportado correctamente');
        }

        function applyCurrentFiltersToTickets(ticketsToFilter) {
            const searchTerm = document.getElementById('searchTickets').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            
            return ticketsToFilter.filter(ticket => {
                // Filtro de búsqueda
                if (searchTerm && 
                    !ticket.title.toLowerCase().includes(searchTerm) && 
                    !ticket.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtro de estado
                if (statusFilter && ticket.status !== statusFilter) {
                    return false;
                }
                
                // Filtro de prioridad
                if (priorityFilter && ticket.priority !== priorityFilter) {
                    return false;
                }
                
                // Filtro de categoría
                if (categoryFilter && ticket.category !== categoryFilter) {
                    return false;
                }
                
                // Filtros avanzados
                if (AppState.advancedFilters.title && !ticket.title.toLowerCase().includes(AppState.advancedFilters.title.toLowerCase())) {
                    return false;
                }
                
                if (AppState.advancedFilters.description && !ticket.description.toLowerCase().includes(AppState.advancedFilters.description.toLowerCase())) {
                    return false;
                }
                
                if (AppState.advancedFilters.dateFrom) {
                    const ticketDate = new Date(ticket.createdAt);
                    const filterDate = new Date(AppState.advancedFilters.dateFrom);
                    if (ticketDate < filterDate) return false;
                }
                
                if (AppState.advancedFilters.dateTo) {
                    const ticketDate = new Date(ticket.createdAt);
                    const filterDate = new Date(AppState.advancedFilters.dateTo);
                    filterDate.setDate(filterDate.getDate() + 1); // Incluir el día completo
                    if (ticketDate >= filterDate) return false;
                }
                
                return true;
            });
        }

        function showLoading(show, message = 'Cargando...') {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.innerHTML = `<div class="spinner"></div><p style="color: white; margin-top: 15px;">${message}</p>`;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        // Funciones globales para los event listeners en HTML
        window.viewTicket = viewTicket;
        window.editTicket = editTicket;
        window.confirmDeleteTicket = confirmDeleteTicket;
        window.updateTicketStatus = updateTicketStatus;
        window.editObservation = editObservation;
        window.deleteObservation = deleteObservation;
    </script>
</body>
</html>